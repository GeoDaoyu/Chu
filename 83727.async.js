"use strict";(self.webpackChunkscene_pro=self.webpackChunkscene_pro||[]).push([[83727,79399],{55447:function(e,t,i){i.d(t,{Z:function(){return l}});var r=i(95051),n=i(44194),s={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M724 218.3V141c0-6.7-7.7-10.4-12.9-6.3L260.3 486.8a31.86 31.86 0 000 50.3l450.8 352.1c5.3 4.1 12.9.4 12.9-6.3v-77.3c0-4.9-2.3-9.6-6.1-12.6l-360-281 360-281.1c3.8-3 6.1-7.7 6.1-12.6z"}}]},name:"left",theme:"outlined"},a=i(43638),o=function(e,t){return n.createElement(a.Z,(0,r.Z)({},e,{ref:t,icon:s}))};var l=n.forwardRef(o)},88979:function(e,t,i){i.d(t,{Z:function(){return l}});var r=i(95051),n=i(44194),s={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"defs",attrs:{},children:[{tag:"style",attrs:{}}]},{tag:"path",attrs:{d:"M521.7 82c-152.5-.4-286.7 78.5-363.4 197.7-3.4 5.3.4 12.3 6.7 12.3h70.3c4.8 0 9.3-2.1 12.3-5.8 7-8.5 14.5-16.7 22.4-24.5 32.6-32.5 70.5-58.1 112.7-75.9 43.6-18.4 90-27.8 137.9-27.8 47.9 0 94.3 9.3 137.9 27.8 42.2 17.8 80.1 43.4 112.7 75.9 32.6 32.5 58.1 70.4 76 112.5C865.7 417.8 875 464.1 875 512c0 47.9-9.4 94.2-27.8 137.8-17.8 42.1-43.4 80-76 112.5s-70.5 58.1-112.7 75.9A352.8 352.8 0 01520.6 866c-47.9 0-94.3-9.4-137.9-27.8A353.84 353.84 0 01270 762.3c-7.9-7.9-15.3-16.1-22.4-24.5-3-3.7-7.6-5.8-12.3-5.8H165c-6.3 0-10.2 7-6.7 12.3C234.9 863.2 368.5 942 520.6 942c236.2 0 428-190.1 430.4-425.6C953.4 277.1 761.3 82.6 521.7 82zM395.02 624v-76h-314c-4.4 0-8-3.6-8-8v-56c0-4.4 3.6-8 8-8h314v-76c0-6.7 7.8-10.5 13-6.3l141.9 112a8 8 0 010 12.6l-141.9 112c-5.2 4.1-13 .4-13-6.3z"}}]},name:"login",theme:"outlined"},a=i(43638),o=function(e,t){return n.createElement(a.Z,(0,r.Z)({},e,{ref:t,icon:s}))};var l=n.forwardRef(o)},18485:function(e,t,i){i.d(t,{Z:function(){return l}});var r=i(95051),n=i(44194),s={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M868 732h-70.3c-4.8 0-9.3 2.1-12.3 5.8-7 8.5-14.5 16.7-22.4 24.5a353.84 353.84 0 01-112.7 75.9A352.8 352.8 0 01512.4 866c-47.9 0-94.3-9.4-137.9-27.8a353.84 353.84 0 01-112.7-75.9 353.28 353.28 0 01-76-112.5C167.3 606.2 158 559.9 158 512s9.4-94.2 27.8-137.8c17.8-42.1 43.4-80 76-112.5s70.5-58.1 112.7-75.9c43.6-18.4 90-27.8 137.9-27.8 47.9 0 94.3 9.3 137.9 27.8 42.2 17.8 80.1 43.4 112.7 75.9 7.9 7.9 15.3 16.1 22.4 24.5 3 3.7 7.6 5.8 12.3 5.8H868c6.3 0 10.2-7 6.7-12.3C798 160.5 663.8 81.6 511.3 82 271.7 82.6 79.6 277.1 82 516.4 84.4 751.9 276.2 942 512.4 942c152.1 0 285.7-78.8 362.3-197.7 3.4-5.3-.4-12.3-6.7-12.3zm88.9-226.3L815 393.7c-5.3-4.2-13-.4-13 6.3v76H488c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h314v76c0 6.7 7.8 10.5 13 6.3l141.9-112a8 8 0 000-12.6z"}}]},name:"logout",theme:"outlined"},a=i(43638),o=function(e,t){return n.createElement(a.Z,(0,r.Z)({},e,{ref:t,icon:s}))};var l=n.forwardRef(o)},60077:function(e,t,i){var r=i(44194),n=i(75955),s=i(41766),a=i(26402);t.Z=(e,t,i,o,l)=>function(e){return t=>r.createElement(s.ZP,{theme:{token:{motion:!1,zIndexPopupBase:0}}},r.createElement(e,Object.assign({},t)))}((s=>{const{prefixCls:c,style:h}=s,u=r.useRef(null),[d,p]=r.useState(0),[m,f]=r.useState(0),[_,g]=(0,n.Z)(!1,{value:s.open}),{getPrefixCls:y}=r.useContext(a.E_),v=y(o||"select",c);r.useEffect((()=>{if(g(!0),"undefined"!=typeof ResizeObserver){const e=new ResizeObserver((e=>{const t=e[0].target;p(t.offsetHeight+8),f(t.offsetWidth)})),t=setInterval((()=>{var i;const r=l?`.${l(v)}`:`.${v}-dropdown`,n=null===(i=u.current)||void 0===i?void 0:i.querySelector(r);n&&(clearInterval(t),e.observe(n))}),10);return()=>{clearInterval(t),e.disconnect()}}}),[]);let b=Object.assign(Object.assign({},s),{style:Object.assign(Object.assign({},h),{margin:0}),open:_,visible:_,getPopupContainer:()=>u.current});i&&(b=i(b)),t&&Object.assign(b,{[t]:{overflow:{adjustX:!1,adjustY:!1}}});const w={paddingBottom:d,position:"relative",minWidth:m};return r.createElement("div",{ref:u,style:w},r.createElement(e,Object.assign({},b)))}))},13284:function(e,t,i){i.d(t,{c4:function(){return s}});var r=i(44194),n=i(87530);const s=["xxl","xl","lg","md","sm","xs"];t.ZP=()=>{const[,e]=(0,n.ZP)(),t=(e=>({xs:`(max-width: ${e.screenXSMax}px)`,sm:`(min-width: ${e.screenSM}px)`,md:`(min-width: ${e.screenMD}px)`,lg:`(min-width: ${e.screenLG}px)`,xl:`(min-width: ${e.screenXL}px)`,xxl:`(min-width: ${e.screenXXL}px)`}))((e=>{const t=e,i=[].concat(s).reverse();return i.forEach(((e,r)=>{const n=e.toUpperCase(),s=`screen${n}Min`,a=`screen${n}`;if(!(t[s]<=t[a]))throw new Error(`${s}<=${a} fails : !(${t[s]}<=${t[a]})`);if(r<i.length-1){const e=`screen${n}Max`;if(!(t[a]<=t[e]))throw new Error(`${a}<=${e} fails : !(${t[a]}<=${t[e]})`);const s=`screen${i[r+1].toUpperCase()}Min`;if(!(t[e]<=t[s]))throw new Error(`${e}<=${s} fails : !(${t[e]}<=${t[s]})`)}})),e})(e));return r.useMemo((()=>{const e=new Map;let i=-1,r={};return{responsiveMap:t,matchHandlers:{},dispatch(t){return r=t,e.forEach((e=>e(r))),e.size>=1},subscribe(t){return e.size||this.register(),i+=1,e.set(i,t),t(r),i},unsubscribe(t){e.delete(t),e.size||this.unregister()},register(){Object.keys(t).forEach((e=>{const i=t[e],n=t=>{let{matches:i}=t;this.dispatch(Object.assign(Object.assign({},r),{[e]:i}))},s=window.matchMedia(i);s.addListener(n),this.matchHandlers[i]={mql:s,listener:n},n(s)}))},unregister(){Object.keys(t).forEach((e=>{const i=t[e],r=this.matchHandlers[i];null==r||r.mql.removeListener(null==r?void 0:r.listener)})),e.clear()}}}),[e])}},84627:function(e,t,i){i.d(t,{Z:function(){return A}});var r=i(44194),n=i(51865),s=i.n(n),a=i(40187),o=i(31789),l=i(13284),c=i(26402),h=i(31699),u=i(5187),d=i(35802);var p=r.createContext({}),m=i(28546),f=i(22582),_=i(91945),g=i(36480);const y=e=>{const{antCls:t,componentCls:i,iconCls:r,avatarBg:n,avatarColor:s,containerSize:a,containerSizeLG:o,containerSizeSM:l,textFontSize:c,textFontSizeLG:h,textFontSizeSM:u,borderRadius:d,borderRadiusLG:p,borderRadiusSM:_,lineWidth:g,lineType:y}=e,v=(e,t,n)=>({width:e,height:e,borderRadius:"50%",[`&${i}-square`]:{borderRadius:n},[`&${i}-icon`]:{fontSize:t,[`> ${r}`]:{margin:0}}});return{[i]:Object.assign(Object.assign(Object.assign(Object.assign({},(0,f.Wf)(e)),{position:"relative",display:"inline-flex",justifyContent:"center",alignItems:"center",overflow:"hidden",color:s,whiteSpace:"nowrap",textAlign:"center",verticalAlign:"middle",background:n,border:`${(0,m.bf)(g)} ${y} transparent`,"&-image":{background:"transparent"},[`${t}-image-img`]:{display:"block"}}),v(a,c,d)),{"&-lg":Object.assign({},v(o,h,p)),"&-sm":Object.assign({},v(l,u,_)),"> img":{display:"block",width:"100%",height:"100%",objectFit:"cover"}})}},v=e=>{const{componentCls:t,groupBorderColor:i,groupOverlapping:r,groupSpace:n}=e;return{[`${t}-group`]:{display:"inline-flex",[t]:{borderColor:i},"> *:not(:first-child)":{marginInlineStart:r}},[`${t}-group-popover`]:{[`${t} + ${t}`]:{marginInlineStart:n}}}};var b=(0,_.I$)("Avatar",(e=>{const{colorTextLightSolid:t,colorTextPlaceholder:i}=e,r=(0,g.IX)(e,{avatarBg:i,avatarColor:t});return[y(r),v(r)]}),(e=>{const{controlHeight:t,controlHeightLG:i,controlHeightSM:r,fontSize:n,fontSizeLG:s,fontSizeXL:a,fontSizeHeading3:o,marginXS:l,marginXXS:c,colorBorderBg:h}=e;return{containerSize:t,containerSizeLG:i,containerSizeSM:r,textFontSize:Math.round((s+a)/2),textFontSizeLG:o,textFontSizeSM:n,groupSpace:c,groupOverlapping:-l,groupBorderColor:h}})),w=function(e,t){var i={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(r=Object.getOwnPropertySymbols(e);n<r.length;n++)t.indexOf(r[n])<0&&Object.prototype.propertyIsEnumerable.call(e,r[n])&&(i[r[n]]=e[r[n]])}return i};const C=r.forwardRef(((e,t)=>{const{prefixCls:i,shape:n,size:m,src:f,srcSet:_,icon:g,className:y,rootClassName:v,style:C,alt:x,draggable:T,children:S,crossOrigin:M,gap:E=4,onError:P}=e,R=w(e,["prefixCls","shape","size","src","srcSet","icon","className","rootClassName","style","alt","draggable","children","crossOrigin","gap","onError"]),[A,O]=r.useState(1),[D,I]=r.useState(!1),[L,N]=r.useState(!0),F=r.useRef(null),U=r.useRef(null),H=(0,o.sQ)(t,F),{getPrefixCls:k,avatar:V}=r.useContext(c.E_),B=r.useContext(p),z=()=>{if(!U.current||!F.current)return;const e=U.current.offsetWidth,t=F.current.offsetWidth;0!==e&&0!==t&&2*E<t&&O(t-2*E<e?(t-2*E)/e:1)};r.useEffect((()=>{I(!0)}),[]),r.useEffect((()=>{N(!0),O(1)}),[f]),r.useEffect(z,[E]);const G=()=>{!1!==(null==P?void 0:P())&&N(!1)},q=(0,u.Z)((e=>{var t,i;return null!==(i=null!==(t=null!=m?m:null==B?void 0:B.size)&&void 0!==t?t:e)&&void 0!==i?i:"default"})),Z=Object.keys("object"==typeof q&&q||{}).some((e=>["xs","sm","md","lg","xl","xxl"].includes(e))),j=(0,d.Z)(Z),W=r.useMemo((()=>{if("object"!=typeof q)return{};const e=l.c4.find((e=>j[e])),t=q[e];return t?{width:t,height:t,fontSize:t&&(g||S)?t/2:18}:{}}),[j,q]);const $=k("avatar",i),X=(0,h.Z)($),[Y,K,Q]=b($,X),J=s()({[`${$}-lg`]:"large"===q,[`${$}-sm`]:"small"===q}),ee=r.isValidElement(f),te=n||(null==B?void 0:B.shape)||"circle",ie=s()($,J,null==V?void 0:V.className,`${$}-${te}`,{[`${$}-image`]:ee||f&&L,[`${$}-icon`]:!!g},Q,X,y,v,K),re="number"==typeof q?{width:q,height:q,fontSize:g?q/2:18}:{};let ne;if("string"==typeof f&&L)ne=r.createElement("img",{src:f,draggable:T,srcSet:_,onError:G,alt:x,crossOrigin:M});else if(ee)ne=f;else if(g)ne=g;else if(D||1!==A){const e=`scale(${A})`,t={msTransform:e,WebkitTransform:e,transform:e};ne=r.createElement(a.Z,{onResize:z},r.createElement("span",{className:`${$}-string`,ref:U,style:Object.assign({},t)},S))}else ne=r.createElement("span",{className:`${$}-string`,style:{opacity:0},ref:U},S);return Y(r.createElement("span",Object.assign({},R,{style:Object.assign(Object.assign(Object.assign(Object.assign({},re),W),null==V?void 0:V.style),C),className:ie,ref:H}),ne))}));var x=C,T=i(45802),S=i(66197),M=i(80868);const E=e=>{const{size:t,shape:i}=r.useContext(p),n=r.useMemo((()=>({size:e.size||t,shape:e.shape||i})),[e.size,e.shape,t,i]);return r.createElement(p.Provider,{value:n},e.children)};var P=e=>{var t,i,n,a;const{getPrefixCls:o,direction:l}=r.useContext(c.E_),{prefixCls:u,className:d,rootClassName:p,style:m,maxCount:f,maxStyle:_,size:g,shape:y,maxPopoverPlacement:v,maxPopoverTrigger:w,children:C,max:P}=e;const R=o("avatar",u),A=`${R}-group`,O=(0,h.Z)(R),[D,I,L]=b(R,O),N=s()(A,{[`${A}-rtl`]:"rtl"===l},L,O,d,p,I),F=(0,T.Z)(C).map(((e,t)=>(0,S.Tm)(e,{key:`avatar-key-${t}`}))),U=(null==P?void 0:P.count)||f,H=F.length;if(U&&U<H){const e=F.slice(0,U),o=F.slice(U,H),l=(null==P?void 0:P.style)||_,c=(null===(t=null==P?void 0:P.popover)||void 0===t?void 0:t.trigger)||w||"hover",h=(null===(i=null==P?void 0:P.popover)||void 0===i?void 0:i.placement)||v||"top",u=Object.assign(Object.assign({content:o},null==P?void 0:P.popover),{classNames:{root:s()(`${A}-popover`,null===(a=null===(n=null==P?void 0:P.popover)||void 0===n?void 0:n.classNames)||void 0===a?void 0:a.root)},placement:h,trigger:c});return e.push(r.createElement(M.Z,Object.assign({key:"avatar-popover-key",destroyTooltipOnHide:!0},u),r.createElement(x,{style:l},"+"+(H-U)))),D(r.createElement(E,{shape:y,size:g},r.createElement("div",{className:N,style:m},e)))}return D(r.createElement(E,{shape:y,size:g},r.createElement("div",{className:N,style:m},F)))};const R=x;R.Group=P;var A=R},28833:function(e,t,i){i.d(t,{Z:function(){return _}});var r=i(81533),n=i(44194),s=i(26705),a=i(51865),o=i.n(a),l=i(13964),c=i(26402),h=i(51341),u=i(23479),d=function(e,t){var i={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(r=Object.getOwnPropertySymbols(e);n<r.length;n++)t.indexOf(r[n])<0&&Object.prototype.propertyIsEnumerable.call(e,r[n])&&(i[r[n]]=e[r[n]])}return i};const p=e=>{const{getPopupContainer:t,getPrefixCls:i,direction:a}=n.useContext(c.E_),{prefixCls:p,type:m="default",danger:f,disabled:_,loading:g,onClick:y,htmlType:v,children:b,className:w,menu:C,arrow:x,autoFocus:T,overlay:S,trigger:M,align:E,open:P,onOpenChange:R,placement:A,getPopupContainer:O,href:D,icon:I=n.createElement(s.Z,null),title:L,buttonsRender:N=(e=>e),mouseEnterDelay:F,mouseLeaveDelay:U,overlayClassName:H,overlayStyle:k,destroyPopupOnHide:V,dropdownRender:B}=e,z=d(e,["prefixCls","type","danger","disabled","loading","onClick","htmlType","children","className","menu","arrow","autoFocus","overlay","trigger","align","open","onOpenChange","placement","getPopupContainer","href","icon","title","buttonsRender","mouseEnterDelay","mouseLeaveDelay","overlayClassName","overlayStyle","destroyPopupOnHide","dropdownRender"]),G=i("dropdown",p),q=`${G}-button`,Z={menu:C,arrow:x,autoFocus:T,align:E,disabled:_,trigger:_?[]:M,onOpenChange:R,getPopupContainer:O||t,mouseEnterDelay:F,mouseLeaveDelay:U,overlayClassName:H,overlayStyle:k,destroyPopupOnHide:V,dropdownRender:B},{compactSize:j,compactItemClassnames:W}=(0,u.ri)(G,a),$=o()(q,W,w);"overlay"in e&&(Z.overlay=S),"open"in e&&(Z.open=P),Z.placement="placement"in e?A:"rtl"===a?"bottomLeft":"bottomRight";const X=n.createElement(l.ZP,{type:m,danger:f,disabled:_,loading:g,onClick:y,htmlType:v,href:D,title:L},b),Y=n.createElement(l.ZP,{type:m,danger:f,icon:I}),[K,Q]=N([X,Y]);return n.createElement(h.Z.Compact,Object.assign({className:$,size:j,block:!0},z),K,n.createElement(r.Z,Object.assign({},Z),Q))};p.__ANT_BUTTON=!0;var m=p;const f=r.Z;f.Button=m;var _=f},35802:function(e,t,i){i.d(t,{Z:function(){return o}});var r=i(44194),n=i(39721);function s(){const[,e]=r.useReducer((e=>e+1),0);return e}var a=i(13284);var o=function(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i=(0,r.useRef)(t),o=s(),l=(0,a.ZP)();return(0,n.Z)((()=>{const t=l.subscribe((t=>{i.current=t,e&&o()}));return()=>l.unsubscribe(t)}),[]),i.current}},3859:function(e,t,i){i.d(t,{Z:function(){return C}});var r=i(88153),n=i(44194),s=i(51865),a=i.n(s),o=i(54570),l=i(26402),c=i(14845),h=i(45802),u=i(35540);var d=i(10253),p=function(e,t){var i={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(r=Object.getOwnPropertySymbols(e);n<r.length;n++)t.indexOf(r[n])<0&&Object.prototype.propertyIsEnumerable.call(e,r[n])&&(i[r[n]]=e[r[n]])}return i};function m(e){let{suffixCls:t,tagName:i,displayName:r}=e;return e=>n.forwardRef(((r,s)=>n.createElement(e,Object.assign({ref:s,suffixCls:t,tagName:i},r))))}const f=n.forwardRef(((e,t)=>{const{prefixCls:i,suffixCls:r,className:s,tagName:o}=e,c=p(e,["prefixCls","suffixCls","className","tagName"]),{getPrefixCls:h}=n.useContext(l.E_),u=h("layout",i),[m,f,_]=(0,d.ZP)(u),g=r?`${u}-${r}`:u;return m(n.createElement(o,Object.assign({className:a()(i||g,s,f,_),ref:t},c)))})),_=n.forwardRef(((e,t)=>{const{direction:i}=n.useContext(l.E_),[s,m]=n.useState([]),{prefixCls:f,className:_,rootClassName:g,children:y,hasSider:v,tagName:b,style:w}=e,C=p(e,["prefixCls","className","rootClassName","children","hasSider","tagName","style"]),x=(0,o.Z)(C,["suffixCls"]),{getPrefixCls:T,className:S,style:M}=(0,l.dj)("layout"),E=T("layout",f),P=function(e,t,i){return"boolean"==typeof i?i:!!e.length||(0,h.Z)(t).some((e=>e.type===u.Z))}(s,y,v),[R,A,O]=(0,d.ZP)(E),D=a()(E,{[`${E}-has-sider`]:P,[`${E}-rtl`]:"rtl"===i},S,_,g,A,O),I=n.useMemo((()=>({siderHook:{addSider:e=>{m((t=>[].concat((0,r.Z)(t),[e])))},removeSider:e=>{m((t=>t.filter((t=>t!==e))))}}})),[]);return R(n.createElement(c.V.Provider,{value:I},n.createElement(b,Object.assign({ref:t,className:D,style:Object.assign(Object.assign({},M),w)},x),y)))})),g=m({tagName:"div",displayName:"Layout"})(_),y=m({suffixCls:"header",tagName:"header",displayName:"Header"})(f),v=m({suffixCls:"footer",tagName:"footer",displayName:"Footer"})(f),b=m({suffixCls:"content",tagName:"main",displayName:"Content"})(f);const w=g;w.Header=y,w.Footer=v,w.Content=b,w.Sider=u.Z,w._InternalSiderContext=u.D;var C=w},80868:function(e,t,i){i.d(t,{Z:function(){return A}});var r=i(44194),n=i(51865),s=i.n(n),a=i(75955),o=i(65041);const l=e=>e?"function"==typeof e?e():e:null;var c=i(21358),h=i(66197),u=i(52916),d=i(65839),p=i(26402),m=i(22582),f=i(11926),_=i(84321),g=i(99144),y=i(7022),v=i(91945),b=i(36480);const w=e=>{const{componentCls:t,popoverColor:i,titleMinWidth:r,fontWeightStrong:n,innerPadding:s,boxShadowSecondary:a,colorTextHeading:o,borderRadiusLG:l,zIndexPopup:c,titleMarginBottom:h,colorBgElevated:u,popoverBg:d,titleBorderBottom:p,innerContentPadding:f,titlePadding:g}=e;return[{[t]:Object.assign(Object.assign({},(0,m.Wf)(e)),{position:"absolute",top:0,left:{_skip_check_:!0,value:0},zIndex:c,fontWeight:"normal",whiteSpace:"normal",textAlign:"start",cursor:"auto",userSelect:"text","--valid-offset-x":"var(--arrow-offset-horizontal, var(--arrow-x))",transformOrigin:["var(--valid-offset-x, 50%)","var(--arrow-y, 50%)"].join(" "),"--antd-arrow-background-color":u,width:"max-content",maxWidth:"100vw","&-rtl":{direction:"rtl"},"&-hidden":{display:"none"},[`${t}-content`]:{position:"relative"},[`${t}-inner`]:{backgroundColor:d,backgroundClip:"padding-box",borderRadius:l,boxShadow:a,padding:s},[`${t}-title`]:{minWidth:r,marginBottom:h,color:o,fontWeight:n,borderBottom:p,padding:g},[`${t}-inner-content`]:{color:i,padding:f}})},(0,_.ZP)(e,"var(--antd-arrow-background-color)"),{[`${t}-pure`]:{position:"relative",maxWidth:"none",margin:e.sizePopupArrow,display:"inline-block",[`${t}-content`]:{display:"inline-block"}}}]},C=e=>{const{componentCls:t}=e;return{[t]:y.i.map((i=>{const r=e[`${i}6`];return{[`&${t}-${i}`]:{"--antd-arrow-background-color":r,[`${t}-inner`]:{backgroundColor:r},[`${t}-arrow`]:{background:"transparent"}}}}))}};var x=(0,v.I$)("Popover",(e=>{const{colorBgElevated:t,colorText:i}=e,r=(0,b.IX)(e,{popoverBg:t,popoverColor:i});return[w(r),C(r),(0,f._y)(r,"zoom-big")]}),(e=>{const{lineWidth:t,controlHeight:i,fontHeight:r,padding:n,wireframe:s,zIndexPopupBase:a,borderRadiusLG:o,marginXS:l,lineType:c,colorSplit:h,paddingSM:u}=e,d=i-r,p=d/2,m=d/2-t,f=n;return Object.assign(Object.assign(Object.assign({titleMinWidth:177,zIndexPopup:a+30},(0,g.w)(e)),(0,_.wZ)({contentRadius:o,limitVerticalRadius:!0})),{innerPadding:s?0:12,titleMarginBottom:s?0:l,titlePadding:s?`${p}px ${f}px ${m}px`:0,titleBorderBottom:s?`${t}px ${c} ${h}`:"none",innerContentPadding:s?`${u}px ${f}px`:0})}),{resetStyle:!1,deprecatedTokens:[["width","titleMinWidth"],["minWidth","titleMinWidth"]]}),T=function(e,t){var i={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(r=Object.getOwnPropertySymbols(e);n<r.length;n++)t.indexOf(r[n])<0&&Object.prototype.propertyIsEnumerable.call(e,r[n])&&(i[r[n]]=e[r[n]])}return i};const S=e=>{let{title:t,content:i,prefixCls:n}=e;return t||i?r.createElement(r.Fragment,null,t&&r.createElement("div",{className:`${n}-title`},t),i&&r.createElement("div",{className:`${n}-inner-content`},i)):null},M=e=>{const{hashId:t,prefixCls:i,className:n,style:a,placement:o="top",title:c,content:h,children:u}=e,p=l(c),m=l(h),f=s()(t,i,`${i}-pure`,`${i}-placement-${o}`,n);return r.createElement("div",{className:f,style:a},r.createElement("div",{className:`${i}-arrow`}),r.createElement(d.G,Object.assign({},e,{className:t,prefixCls:i}),u||r.createElement(S,{prefixCls:i,title:p,content:m})))};var E=e=>{const{prefixCls:t,className:i}=e,n=T(e,["prefixCls","className"]),{getPrefixCls:a}=r.useContext(p.E_),o=a("popover",t),[l,c,h]=x(o);return l(r.createElement(M,Object.assign({},n,{prefixCls:o,hashId:c,className:s()(i,h)})))},P=function(e,t){var i={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(r=Object.getOwnPropertySymbols(e);n<r.length;n++)t.indexOf(r[n])<0&&Object.prototype.propertyIsEnumerable.call(e,r[n])&&(i[r[n]]=e[r[n]])}return i};const R=r.forwardRef(((e,t)=>{var i,n;const{prefixCls:d,title:m,content:f,overlayClassName:_,placement:g="top",trigger:y="hover",children:v,mouseEnterDelay:b=.1,mouseLeaveDelay:w=.1,onOpenChange:C,overlayStyle:T={},styles:M,classNames:E}=e,R=P(e,["prefixCls","title","content","overlayClassName","placement","trigger","children","mouseEnterDelay","mouseLeaveDelay","onOpenChange","overlayStyle","styles","classNames"]),{getPrefixCls:A,className:O,style:D,classNames:I,styles:L}=(0,p.dj)("popover"),N=A("popover",d),[F,U,H]=x(N),k=A(),V=s()(_,U,H,O,I.root,null==E?void 0:E.root),B=s()(I.body,null==E?void 0:E.body),[z,G]=(0,a.Z)(!1,{value:null!==(i=e.open)&&void 0!==i?i:e.visible,defaultValue:null!==(n=e.defaultOpen)&&void 0!==n?n:e.defaultVisible}),q=(e,t)=>{G(e,!0),null==C||C(e,t)},Z=l(m),j=l(f);return F(r.createElement(u.Z,Object.assign({placement:g,trigger:y,mouseEnterDelay:b,mouseLeaveDelay:w},R,{prefixCls:N,classNames:{root:V,body:B},styles:{root:Object.assign(Object.assign(Object.assign(Object.assign({},L.root),D),T),null==M?void 0:M.root),body:Object.assign(Object.assign({},L.body),null==M?void 0:M.body)},ref:t,open:z,onOpenChange:e=>{q(e)},overlay:Z||j?r.createElement(S,{prefixCls:N,title:Z,content:j}):null,transitionName:(0,c.m)(k,"zoom-big",R.transitionName),"data-popover-inject":!0}),(0,h.Tm)(v,{onKeyDown:e=>{var t,i;r.isValidElement(v)&&(null===(i=null==v?void 0:(t=v.props).onKeyDown)||void 0===i||i.call(t,e)),(e=>{e.keyCode===o.Z.ESC&&q(!1,e)})(e)}})))}));R._InternalPanelDoNotUseOrYouWillBeFired=E;var A=R},76186:function(e,t,i){i.d(t,{Fm:function(){return d}});var r=i(28546),n=i(25455);const s=new r.E4("antMoveDownIn",{"0%":{transform:"translate3d(0, 100%, 0)",transformOrigin:"0 0",opacity:0},"100%":{transform:"translate3d(0, 0, 0)",transformOrigin:"0 0",opacity:1}}),a=new r.E4("antMoveDownOut",{"0%":{transform:"translate3d(0, 0, 0)",transformOrigin:"0 0",opacity:1},"100%":{transform:"translate3d(0, 100%, 0)",transformOrigin:"0 0",opacity:0}}),o=new r.E4("antMoveLeftIn",{"0%":{transform:"translate3d(-100%, 0, 0)",transformOrigin:"0 0",opacity:0},"100%":{transform:"translate3d(0, 0, 0)",transformOrigin:"0 0",opacity:1}}),l=new r.E4("antMoveLeftOut",{"0%":{transform:"translate3d(0, 0, 0)",transformOrigin:"0 0",opacity:1},"100%":{transform:"translate3d(-100%, 0, 0)",transformOrigin:"0 0",opacity:0}}),c=new r.E4("antMoveRightIn",{"0%":{transform:"translate3d(100%, 0, 0)",transformOrigin:"0 0",opacity:0},"100%":{transform:"translate3d(0, 0, 0)",transformOrigin:"0 0",opacity:1}}),h=new r.E4("antMoveRightOut",{"0%":{transform:"translate3d(0, 0, 0)",transformOrigin:"0 0",opacity:1},"100%":{transform:"translate3d(100%, 0, 0)",transformOrigin:"0 0",opacity:0}}),u={"move-up":{inKeyframes:new r.E4("antMoveUpIn",{"0%":{transform:"translate3d(0, -100%, 0)",transformOrigin:"0 0",opacity:0},"100%":{transform:"translate3d(0, 0, 0)",transformOrigin:"0 0",opacity:1}}),outKeyframes:new r.E4("antMoveUpOut",{"0%":{transform:"translate3d(0, 0, 0)",transformOrigin:"0 0",opacity:1},"100%":{transform:"translate3d(0, -100%, 0)",transformOrigin:"0 0",opacity:0}})},"move-down":{inKeyframes:s,outKeyframes:a},"move-left":{inKeyframes:o,outKeyframes:l},"move-right":{inKeyframes:c,outKeyframes:h}},d=(e,t)=>{const{antCls:i}=e,r=`${i}-${t}`,{inKeyframes:s,outKeyframes:a}=u[t];return[(0,n.R)(r,s,a,e.motionDurationMid),{[`\n        ${r}-enter,\n        ${r}-appear\n      `]:{opacity:0,animationTimingFunction:e.motionEaseOutCirc},[`${r}-leave`]:{animationTimingFunction:e.motionEaseInOutCirc}}]}},93762:function(e,t,i){i.r(t),i.d(t,{default:function(){return L}});var r=i(73440),n=i(81001),s=i(78619),a=i(43254),o=i(41145),l=i(63255),c=i(28947),h=i(97006),u=i(332),d=i(96711),p=i(61100),m=i(93568),f=i(95490),_=i(17155),g=(i(61432),i(48023)),y=i(29884),v=i(45213),b=i(77601),w=i(96193),C=i(26334),x=(i(55214),i(70880)),T=(i(83850),i(74765)),S=i(12816);let M=class extends x.Z{constructor(e){super(e),this.apiKey=null,this.id=null,this.language=null,this.places=null,this.serviceUrl="https://basemapstyles-api.arcgis.com/arcgis/rest/services/styles/v2",this.worldview=null}get languageParameter(){const e=this.language;let t="local"===e||"global"===e?e:(0,S.Su)(e??(0,T.Kd)())??"global";return t="no"===t?"nb":t,t}};(0,r._)([(0,_.Cb)()],M.prototype,"apiKey",void 0),(0,r._)([(0,_.Cb)()],M.prototype,"id",void 0),(0,r._)([(0,_.Cb)()],M.prototype,"language",void 0),(0,r._)([(0,_.Cb)()],M.prototype,"places",void 0),(0,r._)([(0,_.Cb)()],M.prototype,"serviceUrl",void 0),(0,r._)([(0,_.Cb)()],M.prototype,"worldview",void 0),M=(0,r._)([(0,g.j)("esri.support.BasemapStyle")],M);const E=M;var P,R=i(49675);let A=0,O=P=class extends(l.Z.JSONSupportMixin(h.Z)){constructor(e){super(e),this.id=null,this.portalItem=null,this.spatialReference=null,this.style=null,this.thumbnailUrl=null,this.title="Basemap",this.id=Date.now().toString(16)+"-basemap-"+A++,this.baseLayers=new a.Z,this.referenceLayers=new a.Z;const t=e=>{e.parent&&e.parent!==this&&"remove"in e.parent&&e.parent.remove(e),e.parent=this,"elevation"===e.type&&d.Z.getLogger(this).error(`Layer '${e.title}, id:${e.id}' of type '${e.type}' is not supported as a basemap layer and will therefore be ignored.`)},i=e=>{e.parent=null};this.addHandles([this.baseLayers.on("after-add",(e=>t(e.item))),this.referenceLayers.on("after-add",(e=>t(e.item))),this.baseLayers.on("after-remove",(e=>i(e.item))),this.referenceLayers.on("after-remove",(e=>i(e.item)))])}initialize(){this.when().catch((e=>{d.Z.getLogger(this).error("#load()",`Failed to load basemap (title: '${this.title}', id: '${this.id}')`,e)})),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)}destroy(){const e=this.baseLayers.toArray();for(const t of e)t.destroy();const t=this.referenceLayers.toArray();for(const e of t)e.destroy();this.baseLayers.destroy(),this.referenceLayers.destroy(),this.portalItem=(0,p.SC)(this.portalItem)}normalizeCtorArgs(e){return e&&"resourceInfo"in e&&(this._set("resourceInfo",e.resourceInfo),delete(e={...e}).resourceInfo),e}set baseLayers(e){this._set("baseLayers",(0,o.Z)(e,this._get("baseLayers")))}_writeBaseLayers(e,t,i){const r=[];e?(i={...i,layerContainerType:"basemap"},this.baseLayers.forEach((e=>{const t=(0,R.Nw)(e,i.webmap?i.webmap.getLayerJSONFromResourceInfo(e):null,i);null!=t&&r.push(t)})),this.referenceLayers.forEach((e=>{const t=(0,R.Nw)(e,i.webmap?i.webmap.getLayerJSONFromResourceInfo(e):null,i);null!=t&&("scene"!==e.type&&(t.isReference=!0),r.push(t))})),t.baseMapLayers=r):t.baseMapLayers=r}set referenceLayers(e){this._set("referenceLayers",(0,o.Z)(e,this._get("referenceLayers")))}writeTitle(e,t){t.title=e||"Basemap"}load(e){return this.addResolvingPromise(this._loadFromSource(e)),Promise.resolve(this)}loadAll(){return(0,u.G)(this,(e=>{e(this.baseLayers,this.referenceLayers)}))}clone(){const e={id:this.id,title:this.title,portalItem:this.portalItem,baseLayers:this.baseLayers.map((e=>(0,c.tZ)(e)?e.clone():e)),referenceLayers:this.referenceLayers.map((e=>(0,c.tZ)(e)?e.clone():e))};return this.loaded&&(e.loadStatus="loaded"),new P({resourceInfo:this.resourceInfo}).set(e)}read(e,t){this.resourceInfo||this._set("resourceInfo",{data:e,context:t}),super.read(e,t)}write(e,t){return e=e||{},t?.origin||(t={origin:"web-map",...t}),super.write(e,t),!this.loaded&&this.resourceInfo?.data.baseMapLayers&&(e.baseMapLayers=this.resourceInfo.data.baseMapLayers.map((e=>{const t=(0,c.d9)(e);return t.url&&(0,f.oC)(t.url)&&(t.url=`https:${t.url}`),t.templateUrl&&(0,f.oC)(t.templateUrl)&&(t.templateUrl=`https:${t.templateUrl}`),t}))),e}async _loadFromSource(e){const{resourceInfo:t,portalItem:i,style:r}=this;(0,m.k_)(e);const n=[];if(t){const i=t.context?t.context.url:null;if(n.push(this._loadLayersFromJSON(t.data,i,e)),t.data.id&&!t.data.title){const e=t.data.id;n.push((0,C.g)(e).then((e=>{e&&this.read({title:e},t.context)})))}}else i?n.push(this._loadFromItem(i,e)):r&&n.push(this._loadFromStylesService(r,e));await Promise.all(n)}async _loadLayersFromJSON(e,t,r){const n=this.resourceInfo?.context,s=this.portalItem?.portal||n?.portal||null,a=I[n?.origin||""]??"web-map",{populateOperationalLayers:o}=await i.e(13259).then(i.bind(i,13259)),l=[];if((0,m.k_)(r),e.baseMapLayers&&Array.isArray(e.baseMapLayers)){const i={context:{...n,origin:a,url:t,portal:s,layerContainerType:"basemap"},defaultLayerType:"DefaultTileLayer"},r=e=>"web-scene"===a&&"ArcGISSceneServiceLayer"===e.layerType||e.isReference,c=o(this.baseLayers,e.baseMapLayers.filter((e=>!r(e))),i);l.push(c);const h=o(this.referenceLayers,e.baseMapLayers.filter(r),i);l.push(h)}await Promise.allSettled(l)}async _loadFromItem(e,t){const i=await e.load(t),r=await i.fetchData("json",t),n=(0,f.mN)(e.itemUrl??"");return this._set("resourceInfo",{data:r.baseMap??{},context:{origin:D[e.type||""]??"web-map",portal:e.portal||b.Z.getDefault(),url:n}}),this.read(this.resourceInfo.data,this.resourceInfo.context),this.read({spatialReference:r.spatialReference},this.resourceInfo.context),this.read({title:e.title,thumbnailUrl:e.thumbnailUrl},{origin:"portal-item",portal:e.portal||b.Z.getDefault(),url:n}),this._loadLayersFromJSON(this.resourceInfo.data,n,t)}async _loadFromStylesService(e,t){const i=e.serviceUrl.endsWith("/webmaps")?e.serviceUrl.slice(0,-8):e.serviceUrl,r=`${i}/styles/${e.id}/self`,a=`${i}/webmaps/${e.id}`,o=e.apiKey??n.default.apiKeys.basemapStyles,[l,c]=await Promise.all([(await(0,s.Z)(r,{query:{token:o},signal:t?.signal})).data,(await(0,s.Z)(a,{query:{language:e.languageParameter,places:e.places,worldview:e.worldview,token:o},signal:t?.signal})).data]);this.thumbnailUrl??=l.thumbnailUrl;const h=(0,f.mN)(a);if(this._set("resourceInfo",{data:c.baseMap??{},context:{origin:"web-map",url:h}}),this.read(this.resourceInfo.data,this.resourceInfo.context),this.read({spatialReference:c.spatialReference},this.resourceInfo.context),await this._loadLayersFromJSON(this.resourceInfo.data,h,t),o)for(const e of[...this.baseLayers,...this.referenceLayers])"apiKey"in e&&(e.apiKey=o)}static fromId(e){const t=C.s[e];return t?t.itemId?new P({portalItem:{id:t.itemId,portal:{url:"https://www.arcgis.com"}}}):P.fromJSON(t,t.is3d?{origin:"web-scene",portal:new b.Z({url:"https://www.arcgis.com"})}:{origin:"web-map"}):null}};(0,r._)([(0,_.Cb)({json:{write:{ignoreOrigin:!0,target:"baseMapLayers",writer(e,t,i,r){this._writeBaseLayers(e,t,r)}},origins:{"web-scene":{write:{ignoreOrigin:!0,target:{baseMapLayers:{type:a.Z}},writer(e,t,i,r){this._writeBaseLayers(e,t,r)}}}}}})],O.prototype,"baseLayers",null),(0,r._)([(0,_.Cb)({type:String,json:{origins:{"web-scene":{write:!0}}}})],O.prototype,"id",void 0),(0,r._)([(0,_.Cb)({type:w.default})],O.prototype,"portalItem",void 0),(0,r._)([(0,_.Cb)()],O.prototype,"referenceLayers",null),(0,r._)([(0,_.Cb)({readOnly:!0})],O.prototype,"resourceInfo",void 0),(0,r._)([(0,_.Cb)({type:v.Z})],O.prototype,"spatialReference",void 0),(0,r._)([(0,_.Cb)({type:E})],O.prototype,"style",void 0),(0,r._)([(0,_.Cb)()],O.prototype,"thumbnailUrl",void 0),(0,r._)([(0,_.Cb)({type:String,json:{origins:{"web-scene":{write:{isRequired:!0}}}}})],O.prototype,"title",void 0),(0,r._)([(0,y.c)("title")],O.prototype,"writeTitle",null),O=P=(0,r._)([(0,g.j)("esri.Basemap")],O);const D={"Web Scene":"web-scene","Web Map":"web-map","Link Chart":"link-chart"},I={"web-scene":"web-scene","web-map":"web-map","link-chart":"link-chart"},L=O},41309:function(e,t,i){i.d(t,{Z:function(){return y}});var r=i(73440),n=i(89314),s=i(17155),a=(i(61432),i(96711),i(83850),i(48023));let o=class extends n.Z{constructor(e){super(e),this.row=0,this.column=0,this.rows=1,this.columns=1}equals(e){return null!=e&&this.row===e.row&&this.rows===e.rows&&this.column===e.column&&this.columns===e.columns}};(0,r._)([(0,s.Cb)({type:Number,nonNullable:!0,json:{read:!1,write:!1}})],o.prototype,"row",void 0),(0,r._)([(0,s.Cb)({type:Number,nonNullable:!0,json:{read:!1,write:!1}})],o.prototype,"column",void 0),(0,r._)([(0,s.Cb)({type:Number,nonNullable:!0,json:{read:!1,write:!1}})],o.prototype,"rows",void 0),(0,r._)([(0,s.Cb)({type:Number,nonNullable:!0,json:{read:!1,write:!1}})],o.prototype,"columns",void 0),o=(0,r._)([(0,a.j)("esri.CameraLayout")],o);const l=o;var c=i(95437),h=i(63255),u=i(99574),d=i(90775),p=i(1194),m=i(29884),f=i(95226),_=i(60508);let g=class extends(n.Z.ClonableMixin(h.Z)){constructor(...e){super(...e),this.position=new _.Z([0,0,0]),this.heading=0,this.tilt=0,this.fov=55,this.layout=new l}normalizeCtorArgs(e,t,i,r){if(e&&"object"==typeof e&&("x"in e||Array.isArray(e))){const n={position:e};return null!=t&&(n.heading=t),null!=i&&(n.tilt=i),null!=r&&(n.fov=r),n}return e}writePosition(e,t,i,r){const n=e.clone();n.x=(0,f.q9)(e.x||0),n.y=(0,f.q9)(e.y||0),n.z=e.hasZ?(0,f.q9)(e.z||0):e.z,t[i]=n.write({},r)}readPosition(e,t){const i=new _.Z;return i.read(e,t),i.x=(0,f.q9)(i.x||0),i.y=(0,f.q9)(i.y||0),i.z=i.hasZ?(0,f.q9)(i.z||0):i.z,i}equals(e){return null!=e&&this.tilt===e.tilt&&this.heading===e.heading&&this.fov===e.fov&&this.position.equals(e.position)&&this.layout.equals(e.layout)}};(0,r._)([(0,s.Cb)({type:_.Z,json:{write:{isRequired:!0}}})],g.prototype,"position",void 0),(0,r._)([(0,m.c)("position")],g.prototype,"writePosition",null),(0,r._)([(0,p.r)("position")],g.prototype,"readPosition",null),(0,r._)([(0,s.Cb)({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),(0,d.p)((e=>c.BV.normalize((0,f.q9)(e))))],g.prototype,"heading",void 0),(0,r._)([(0,s.Cb)({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),(0,d.p)((e=>(0,u.uZ)((0,f.q9)(e),-180,180)))],g.prototype,"tilt",void 0),(0,r._)([(0,s.Cb)({type:Number,nonNullable:!0,json:{default:55,write:!0}}),(0,d.p)((e=>(0,u.uZ)((0,f.q9)(e,55),1,170)))],g.prototype,"fov",void 0),(0,r._)([(0,s.Cb)({type:l,nonNullable:!0,json:{read:!1,write:!1}})],g.prototype,"layout",void 0),g=(0,r._)([(0,a.j)("esri.Camera")],g);const y=g},82439:function(e,t,i){i.d(t,{Z:function(){return re}});var r,n=i(73440),s=i(93762),a=i(53147),o=i(43254),l=i(41145),c=i(79487),h=i(88194),u=i(63255),d=i(28947),p=i(97006),m=i(332),f=i(96711),_=i(61100),g=i(93568),y=i(17155),v=i(95226),b=i(48023),w=i(29884),C=(i(61432),i(83850),i(79775));let x=r=class extends u.Z{constructor(e){super(e),this.type="none"}clone(){return new r({type:this.type})}};(0,n._)([(0,C.J)({none:"none",stayAbove:"stay-above"}),(0,y.Cb)({json:{write:{isRequired:!0}}})],x.prototype,"type",void 0),x=r=(0,n._)([(0,b.j)("esri.ground.NavigationConstraint")],x);var T,S,M=i(3048),E=i(20712);let P=S=class extends(u.Z.JSONSupportMixin(p.Z)){static{T=M._}constructor(e){super(e),this[T]=!0,this.opacity=1,this.surfaceColor=null,this.navigationConstraint=null,this.layers=new o.Z;const t=e=>{e.parent&&e.parent!==this&&"remove"in e.parent&&e.parent.remove(e),e.parent=this,"elevation"!==e.type&&"base-elevation"!==e.type&&f.Z.getLogger(this).error(`Layer '${e.title}, id:${e.id}' of type '${e.type}' is not supported as a ground layer and will therefore be ignored. Only layers of type 'elevation' are supported.`)};this.addHandles([this.layers.on("after-add",(e=>t(e.item))),this.layers.on("after-remove",(e=>(e=>{e.parent=null})(e.item)))])}initialize(){this.when().catch((e=>{(0,g.D_)(e)||f.Z.getLogger(this).error("#load()","Failed to load ground",e)})),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)}destroy(){const e=this.layers.removeAll();for(const t of e)(0,_.SC)(t);this.layers.destroy()}normalizeCtorArgs(e){return e&&"resourceInfo"in e&&(this._set("resourceInfo",e.resourceInfo),delete(e={...e}).resourceInfo),e}get layers(){return this._get("layers")}set layers(e){this._set("layers",(0,l.Z)(e,this._get("layers")))}writeLayers(e,t,i,r){const n=[];e?(r={...r,layerContainerType:"ground"},e.forEach((e=>{if("write"in e){const t={};(0,c.sM)(e)().write(t,r)&&n.push(t)}else r?.messages&&r.messages.push(new h.Z("layer:unsupported",`Layers (${e.title}, ${e.id}) of type '${e.declaredClass}' cannot be persisted in the ground`,{layer:e}))})),t.layers=n):t.layers=n}load(e){return this.addResolvingPromise(this._loadFromSource(e)),Promise.resolve(this)}loadAll(){return(0,m.G)(this,(e=>{e(this.layers)}))}async queryElevation(e,t){await this.load({signal:t?.signal});const{ElevationQuery:r}=await i.e(38308).then(i.bind(i,58086));(0,g.k_)(t);const n=new r,s=this.layers.filter(R).toArray();return n.queryAll(s,e,t)}async createElevationSampler(e,t){await this.load({signal:t?.signal});const{ElevationQuery:r}=await i.e(38308).then(i.bind(i,58086));(0,g.k_)(t);const n=new r,s=this.layers.filter(R).toArray();return n.createSamplerAll(s,e,t)}clone(){const e={opacity:this.opacity,surfaceColor:(0,d.d9)(this.surfaceColor),navigationConstraint:(0,d.d9)(this.navigationConstraint),layers:this.layers.slice()};return this.loaded&&(e.loadStatus="loaded"),new S({resourceInfo:this.resourceInfo}).set(e)}read(e,t){this.resourceInfo||this._set("resourceInfo",{data:e,context:t}),super.read(e,t)}_loadFromSource(e){const t=this.resourceInfo;return t?this._loadLayersFromJSON(t.data,t.context,e):Promise.resolve()}async _loadLayersFromJSON(e,t,r){const n=t?.origin||"web-scene",s=t?.portal||null,a=t?.url||null,{populateOperationalLayers:o}=await i.e(13259).then(i.bind(i,13259));(0,g.k_)(r);const l=[];if(e.layers&&Array.isArray(e.layers)){const t={context:{origin:n,url:a,portal:s,layerContainerType:"ground"},defaultLayerType:"ArcGISTiledElevationServiceLayer"};l.push(o(this.layers,e.layers,t))}await Promise.allSettled(l)}};function R(e){return"elevation"===e.type||function(e){return e&&"createElevationSampler"in e}(e)}(0,n._)([(0,y.Cb)({json:{read:!1,write:{isRequired:!0}}})],P.prototype,"layers",null),(0,n._)([(0,w.c)("layers")],P.prototype,"writeLayers",null),(0,n._)([(0,y.Cb)({readOnly:!0})],P.prototype,"resourceInfo",void 0),(0,n._)([(0,y.Cb)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{type:v.z8,read:{reader:E.b,source:"transparency"},write:{writer:(e,t)=>{t.transparency=(0,E.a)(e)},target:"transparency"}}})],P.prototype,"opacity",void 0),(0,n._)([(0,y.Cb)({type:a.Z,json:{type:[v.z8],write:(e,t)=>{t.surfaceColor=e.toJSON().slice(0,3)}}})],P.prototype,"surfaceColor",void 0),(0,n._)([(0,y.Cb)({type:x,json:{write:!0}})],P.prototype,"navigationConstraint",void 0),P=S=(0,n._)([(0,b.j)("esri.Ground")],P);const A=P;var O=i(70880),D=i(63727),I=i(87833),L=i(90775),N=i(89314),F=i(78619),U=i(18764),H=i(1194),k=i(75432);let V=class extends(N.Z.ClonableMixin(u.Z)){constructor(e){super(e),this.color=null}};(0,n._)([(0,y.Cb)({type:a.Z,json:{type:[v.z8],write:!0}})],V.prototype,"color",void 0),V=(0,n._)([(0,b.j)("esri.effects.FocusAreaOutline")],V);const B=V;var z=i(35857),G=i(28938);let q=class extends(u.Z.JSONSupportMixin(N.Z)){constructor(e){super(e),this.id=`focusarea-${(0,U.DO)()}`,this.title=null,this.enabled=!0,this.outline=null,this.geometries=new z.Z}readGeometries(e,t,i){Array.isArray(e)?this.geometries=z.Z.fromJSON(e,i):i.hooks?.onAfterLoad?.((()=>this._loadGeometries((0,G.f)(e,i),i)))}async _loadGeometries(e,t){const i=await(0,F.Z)(e,{responseType:"json"});this.geometries=z.Z.fromJSON(i.data,t)}};(0,n._)([(0,y.Cb)({type:String,nonNullable:!0,json:{write:!0,origins:{"web-scene":{write:{isRequired:!0}}}}}),(0,y.Cb)()],q.prototype,"id",void 0),(0,n._)([(0,y.Cb)({type:String,json:{write:!0}})],q.prototype,"title",void 0),(0,n._)([(0,y.Cb)({type:Boolean,nonNullable:!0,json:{write:!0,origins:{"web-scene":{write:{isRequired:!0}}}}})],q.prototype,"enabled",void 0),(0,n._)([(0,y.Cb)({type:B,json:{write:!0}})],q.prototype,"outline",void 0),(0,n._)([(0,y.Cb)({type:z.Z,nonNullable:!0,json:{write:!0,origins:{"web-scene":{write:{isRequired:!0}}}},clonable:e=>new z.Z(e.items.map((e=>e.clone())))}),(0,k.B)({origins:["web-scene","portal-item"],type:"resource",prefix:"geometries",contentAddressed:!0})],q.prototype,"geometries",void 0),(0,n._)([(0,H.r)(["web-scene","portal-item"],"geometries")],q.prototype,"readGeometries",null),q=(0,n._)([(0,b.j)("esri.effects.FocusArea")],q);const Z=q;let j=class extends(u.Z.JSONSupportMixin(N.Z)){constructor(e){super(e),this.areas=new o.Z,this.style="bright"}};(0,n._)([(0,y.Cb)({type:o.Z.ofType(Z),nonNullable:!0,json:{write:!0,origins:{"web-scene":{write:{isRequired:!0}}}},clonable:e=>new o.Z(e.items.map((e=>e.clone())))})],j.prototype,"areas",void 0),(0,n._)([(0,y.Cb)({type:["bright","dark"],nonNullable:!0,json:{write:!0}})],j.prototype,"style",void 0),j=(0,n._)([(0,b.j)("esri.effects.FocusAreas")],j);const W=j;var $=i(82114),X=i(75428);function Y(e){return!(!function(e){return"object"==typeof e&&null!=e&&"loaded"in e&&!0===e.loaded&&"type"in e}(e)||!(0,X.S1)(e)?.operations?.supportsEditing||"editingEnabled"in e&&!(0,X.ln)(e)||(0,$.xu)(e))}var K=i(13141),Q=i(76277);const J={"world-elevation":{id:"worldElevation",url:"//elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/Terrain3D/ImageServer",layerType:"ArcGISTiledElevationServiceLayer"},"world-topobathymetry":{id:"worldTopoBathymetry",url:"//elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/TopoBathy3D/ImageServer",layerType:"ArcGISTiledElevationServiceLayer"}};var ee=i(83322),te=i(33800);let ie=class extends((0,te.Q)((0,ee.K)(I.Z.EventedMixin(O.Z)))){constructor(e){super(e),this.allLayers=new D.Z({getCollections:()=>[this.basemap?.baseLayers,this.ground?.layers,this.layers,this.basemap?.referenceLayers],getChildrenFunction:e=>"layers"in e?e.layers:null}),this.focusAreas=new W,this.allTables=(0,Q.a)(this),this.basemap=null,this.editableLayers=new D.Z({getCollections:()=>[this.allLayers],itemFilterFunction:Y}),this.ground=new A,this._basemapCache=(0,K.Df)()}destroy(){(0,K.Bf)(this._basemapCache),this._basemapCache=null,this.focusAreas.destroy(),this.allLayers.destroy(),this.allTables.destroy(),this.editableLayers.destroy(),this.basemap=(0,_.SC)(this.basemap),(0,_.SC)(this.ground),this._set("ground",null)}castBasemap(e){return(0,K.fF)(e,this._basemapCache)}castGround(e){const t=function(e){let t=null;"string"==typeof e?e in J?t=new A({resourceInfo:{data:{layers:[J[e]]}}}):f.Z.getLogger("esri.support.groundUtils").warn(`Unable to find ground definition for: ${e}. Try "world-elevation"`):t=(0,v.se)(A,e);return t}(e);return t??this._get("ground")}findLayerById(e){return this.allLayers.find((t=>t.id===e))}findTableById(e){return this.allTables.find((t=>t.id===e))}};(0,n._)([(0,y.Cb)({readOnly:!0,dependsOn:[]})],ie.prototype,"allLayers",void 0),(0,n._)([(0,y.Cb)({type:W,nonNullable:!0,json:{write:{overridePolicy:e=>({enabled:e.areas.length>0,ignoreOrigin:!0})}}})],ie.prototype,"focusAreas",void 0),(0,n._)([(0,y.Cb)({readOnly:!0})],ie.prototype,"allTables",void 0),(0,n._)([(0,y.Cb)({type:s.default,json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],ie.prototype,"basemap",void 0),(0,n._)([(0,L.p)("basemap")],ie.prototype,"castBasemap",null),(0,n._)([(0,y.Cb)({readOnly:!0})],ie.prototype,"editableLayers",void 0),(0,n._)([(0,y.Cb)({type:A,nonNullable:!0})],ie.prototype,"ground",void 0),(0,n._)([(0,L.p)("ground")],ie.prototype,"castGround",null),(0,n._)([(0,y.Cb)()],ie.prototype,"undoRedo",void 0),ie=(0,n._)([(0,b.j)("esri.Map")],ie);const re=ie},27172:function(e,t,i){i.d(t,{Z:function(){return p}});var r,n=i(73440),s=i(41309),a=i(63255),o=i(17155),l=i(90775),c=(i(61432),i(83850),i(48023)),h=i(90756),u=i(98842);let d=r=class extends a.Z{constructor(e){super(e),this.rotation=0,this.scale=0,this.targetGeometry=null,this.camera=null}castRotation(e){return(e%=360)<0&&(e+=360),e}clone(){return new r({rotation:this.rotation,scale:this.scale,targetGeometry:null!=this.targetGeometry?this.targetGeometry.clone():null,camera:null!=this.camera?this.camera.clone():null})}};(0,n._)([(0,o.Cb)({type:Number,json:{write:!0,origins:{"web-map":{default:0,write:!0},"web-scene":{write:{overridePolicy:m}}}}})],d.prototype,"rotation",void 0),(0,n._)([(0,l.p)("rotation")],d.prototype,"castRotation",null),(0,n._)([(0,o.Cb)({type:Number,json:{write:!0,origins:{"web-map":{default:0,write:!0},"web-scene":{write:{overridePolicy:m}}}}})],d.prototype,"scale",void 0),(0,n._)([(0,o.Cb)({types:u.qM,json:{read:h.im,write:!0,origins:{"web-scene":{read:h.im,write:{overridePolicy:m}}}}})],d.prototype,"targetGeometry",void 0),(0,n._)([(0,o.Cb)({type:s.Z,json:{write:!0,origins:{"web-scene":{write:{isRequired:!0}}}}})],d.prototype,"camera",void 0),d=r=(0,n._)([(0,c.j)("esri.Viewpoint")],d);const p=d;function m(){return{enabled:!this.camera}}},7332:function(e,t,i){i.d(t,{A:function(){return c},a:function(){return u},b:function(){return h}});var r=i(17904),n=i(48857),s=i(71063),a=i(34709),o=i(74826),l=i(15150);class c extends o.K{}function h(){const e=new l.kG;return e.include(r.k),e.fragment.uniforms.add(new a.A("colorTexture",(e=>e.color)),new s.e("depthTexture",(e=>e.mainDepth))),e.fragment.main.add(n.H`float depthSample = texture(depthTexture, uv).r;
if (depthSample != 1.0 ) {
fragColor = vec4(0);
return;
}
fragColor = texture(colorTexture, uv);`),e}const u=Object.freeze(Object.defineProperty({__proto__:null,AtmosphereCompositingPassParameters:c,build:h},Symbol.toStringTag,{value:"Module"}))},91102:function(e,t,i){i.d(t,{B:function(){return m},a:function(){return r},b:function(){return p}});var r,n=i(56791),s=i(82214),a=i(99563),o=i(58226),l=i(9535),c=i(85119),h=i(48857),u=i(34709),d=i(15150);function p(e){const t=new d.kG,i=t.fragment;if(t.include(o.T),e.background===r.Only){const r=e.output===s.l.ColorComposite;return r?i.uniforms.add(new l.J("backgroundColor",(e=>e.backgroundColor))):i.include(n.H),i.main.add(h.H`fragColor = vec4(${r?h.H`backgroundColor`:h.H`gridColor(uv)`}, 1.0);`),t}return t.include(a.J,e),i.uniforms.add(new u.A("tex",(e=>e.texture)),new c.p("opacity",(e=>e.opacity))),i.main.add(h.H`fragColor = blendLayers(uv, texture(tex, uv), opacity);`),t}!function(e){e[e.BelowLayer=0]="BelowLayer",e[e.Only=1]="Only",e[e.COUNT=2]="COUNT"}(r||(r={}));const m=Object.freeze(Object.defineProperty({__proto__:null,get BackgroundMode(){return r},build:p},Symbol.toStringTag,{value:"Module"}))},5918:function(e,t,i){i.d(t,{B:function(){return l},b:function(){return o}});var r=i(17904),n=i(48857),s=i(34709),a=i(15150);function o(){const e=new a.kG;e.include(r.k),e.fragment.uniforms.add(new s.A("edgesTexture",(e=>e.inputTexture)),new s.A("areaTexture",(e=>e.areaTexture)),new s.A("searchTexture",(e=>e.searchTexture))),e.fragment.constants.add("smaaAreaTexPixelSize","vec2",[1/160,1/560]);return e.fragment.code.add(n.H`
    vec4 sampleLevelZeroOffset(vec2 coord, vec2 offset, vec2 resolution) {
      return texture(edgesTexture, coord + offset.x * resolution);
    }

    float searchLength(vec2 e, float bias, float scale) {
      e.r = bias + e.r * scale;
      return 255.0 * texture(searchTexture, e).r;
    }

    float searchLeft(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(0.0, 1.0);
      for (int i = 0; i < ${n.H.int(8)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord -= vec2(2.0, 0.0) * resolution;
        if (! (texcoord.x > end && e.g > 0.8281 && e.r == 0.0)) break;
      }
      texcoord.x += 0.25 * resolution.x;
      texcoord.x += resolution.x;
      texcoord.x += 2.0 * resolution.x;
      texcoord.x -= resolution.x * searchLength(e, 0.0, 0.5);
      return texcoord.x;
    }

    float searchRight(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(0.0, 1.0);
      for (int i = 0; i < ${n.H.int(8)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord += vec2(2.0, 0.0) * resolution;
        if (! (texcoord.x < end && e.g > 0.8281 && e.r == 0.0)) break;
      }
      texcoord.x -= 0.25 * resolution.x;
      texcoord.x -= resolution.x;
      texcoord.x -= 2.0 * resolution.x;
      texcoord.x += resolution.x * searchLength(e, 0.5, 0.5);
      return texcoord.x;
    }

    float searchUp(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(1.0, 0.0);
      for (int i = 0; i < ${n.H.int(8)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord += vec2(0.0, 2.0) * resolution;
        if (! (texcoord.y > end && e.r > 0.8281 && e.g == 0.0)) break;
      }
      texcoord.y -= 0.25 * resolution.y;
      texcoord.y -= resolution.y;
      texcoord.y -= 2.0 * resolution.y;
      texcoord.y += resolution.y * searchLength(e.gr, 0.0, 0.5);
      return texcoord.y;
    }

    float searchDown(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(1.0, 0.0);
      for (int i = 0; i < ${n.H.int(8)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord -= vec2(0.0, 2.0) * resolution;
        if (! (texcoord.y < end && e.r > 0.8281 && e.g == 0.0)) break;
      }
      texcoord.y += 0.25 * resolution.y;
      texcoord.y += resolution.y;
      texcoord.y += 2.0 * resolution.y;
      texcoord.y -= resolution.y * searchLength(e.gr, 0.5, 0.5);
      return texcoord.y;
    }

    vec2 getArea(sampler2D areaTex, vec2 dist, float e1, float e2, float offset) {
      vec2 texcoord = float(${n.H.int(16)}) * round(4.0 * vec2(e1, e2)) + dist;
      texcoord = smaaAreaTexPixelSize * texcoord + (0.5 * smaaAreaTexPixelSize);
      texcoord.y += ${n.H.float(1/7)} * offset;
      return texture(areaTex, texcoord).rg;
    }`),e.fragment.main.add(n.H`
    vec2 size = vec2(textureSize(edgesTexture, 0));
    vec2 resolution = 1.0 / size;
    vec2 pixelCoord = uv * size;
    vec4 offsets[2];
    offsets[0] = uv.xyxy + resolution.xyxy * vec4(-0.25, 0.125, 1.25, 0.125);
    offsets[1] = uv.xyxy + resolution.xyxy * vec4(-0.125, 0.25, -0.125, -1.25);
    vec4 maxOffset = vec4(offsets[0].xz, offsets[1].yw) + vec4(-2.0, 2.0, -2.0, 2.0) * resolution.xxyy * float(${n.H.int(8)});
    ivec4 subsampleIndices = ivec4(0.0);
    vec4 weights = vec4(0.0);
    vec2 e = texture(edgesTexture, uv).rg;
    if (e.r > 0.0) {
      vec2 d;
      vec2 coords;
      coords.y = searchUp(offsets[1].xy, maxOffset.z, resolution);
      coords.x = offsets[0].x;
      d.x = coords.y;
      float e1 = texture(edgesTexture, coords).g;
      coords.y = searchDown(offsets[1].zw, maxOffset.w, resolution);
      d.y = coords.y;
      d = d * size.y - pixelCoord.y;
      vec2 sqrt_d = sqrt(abs(d));
      coords.y -= 1.0 * resolution.y;
      float e2 = sampleLevelZeroOffset(coords, vec2(0.0, 1.0), resolution).g;
      weights.ba = getArea(areaTexture, sqrt_d, e1, e2, float(subsampleIndices.x));
      // for some reason the following lines are necessary to prevent
      // texture lookup precision issues on some Intel integrated graphics chips
      vec4 dbg = (offsets[0] + offsets[1] + maxOffset + coords.xyyx);
      weights.r += 0.00000001 * dot(vec4(0, 1, 0, 1), dbg);
    }
    if (e.g > 0.0) {
      vec2 d;
      vec2 coords;
      coords.x = searchLeft(offsets[0].xy, maxOffset.x, resolution);
      coords.y = offsets[1].y;
      d.x = coords.x;
      float e1 = texture(edgesTexture, coords).r;
      coords.x = searchRight(offsets[0].zw, maxOffset.y, resolution);
      d.y = coords.x;
      d = d * size.x - pixelCoord.x;
      vec2 sqrt_d = sqrt(abs(d));
      coords.y -= 1.0 * resolution.y;
      float e2 = sampleLevelZeroOffset(coords, vec2(1.0, 0.0), resolution).r;
      weights.rg = getArea(areaTexture, sqrt_d, e1, e2, float(subsampleIndices.y));
    }
    fragColor = weights;
  `),e}const l=Object.freeze(Object.defineProperty({__proto__:null,build:o},Symbol.toStringTag,{value:"Module"}))},666:function(e,t,i){i.d(t,{B:function(){return p},a:function(){return r},b:function(){return f},c:function(){return m}});var r,n=i(99574),s=i(17904),a=i(40212),o=i(85119),l=i(48857),c=i(34709),h=i(40673),u=i(74826),d=i(15150);!function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.COUNT=2]="COUNT"}(r||(r={}));class p extends u.K{constructor(){super(...arguments),this.blurRadius=h.L9.sunny}}function m(e){const t=new d.kG,i=t.fragment;t.include(s.k),i.include(a.D),i.uniforms.add(new c.A("colorTexture",(e=>e.color)),new o.p("blurRadius",(e=>e.blurRadius)));let h="";const u=15;for(let e=0;e<u;e++)h+=`locations1D[${e}] = ${(e/14*2-1).toFixed(3).toString()};`;let p="";for(let e=0;e<u;e++)p+=`locations1DWeights[${e}] = ${(0,n.j3)(e-Math.floor(7.5),2).toFixed(7).toString()};`;const m=e.bloomStage===r.Horizontal;return i.code.add(l.H`
    float locations1D[${l.H.int(u)}];
    float locations1DWeights[${l.H.int(u)}];

    vec4 blurUniformSamples(sampler2D toBlur) {
      vec4 res = vec4(0.0);
      vec2 size = vec2(textureSize(toBlur, 0));
      vec2 aspectCorrection = vec2(1.0, size.x / size.y);
      vec2 uvInPixel = uv * size;

      ${h}
      ${p}
      vec2 pixelCenterShift = 0.5 / size;

      for(int i=0;i < ${l.H.int(u)}; i++) {
        float uv1D = locations1D[i] + ${m?"pixelCenterShift.x":"pixelCenterShift.y"};
        vec2 uvOffset = ${m?"vec2(uv1D, 0.0)":"vec2(0.0, uv1D)"};

        vec2 uvDistorted = uv + uvOffset * blurRadius * aspectCorrection;
        vec4 sampleColor = texture(toBlur, uvDistorted);
        res += vec4(linearizeGamma(sampleColor.rgb), sampleColor.a)  * locations1DWeights[i];
      }
      res.a = clamp(res.a, 0.0, 1.0);
      return delinearizeGamma(res);
    }
  `).main.add(l.H`fragColor = blurUniformSamples(colorTexture);`),t}const f=Object.freeze(Object.defineProperty({__proto__:null,BloomBlurPassParameters:p,get BlurDirection(){return r},build:m},Symbol.toStringTag,{value:"Module"}))},60700:function(e,t,i){i.d(t,{B:function(){return g},a:function(){return v},b:function(){return y},d:function(){return _}});var r=i(17904),n=i(20638),s=i(40212),a=i(85119),o=i(39163),l=i(48857),c=i(20431),h=i(34709),u=i(40673),d=i(85797),p=i(74826),m=i(15150);class f extends p.K{constructor(e=u.S7,t=u.Ml.sunny.far,i=u.Ml.sunny.near){super(),this.exposure=e,this.lodFactors=t,this.lodFactorsFront=i}}const _=new f;class g extends f{constructor(){super(...arguments),this.bloomLod=-1}}function y(){const e=new m.kG,t=e.fragment;return e.include(r.k),t.include(s.D),t.include(n.K),t.include(d.l),t.uniforms.add(new h.A("colorTexture",(e=>e.color)),new h.A("emissionTexture",(e=>e.emission)),new h.A("bloomTexture0",(e=>e.bloomTexture0)),new h.A("bloomTexture1",(e=>e.bloomTexture1)),new h.A("bloomTexture2",(e=>e.bloomTexture2)),new h.A("bloomTexture3",(e=>e.bloomTexture3)),new h.A("bloomTexture4",(e=>e.bloomTexture4)),new a.p("exposure",(e=>e.exposure)),new c._("bloomLod",(e=>e.bloomLod)),new o.O("lodFactors",(e=>e.lodFactors),5),new o.O("lodFactorsFront",(e=>e.lodFactorsFront),5)).main.add(l.H`vec4 color = texture(colorTexture, uv);
color = vec4(linearizeGamma(color.rgb), color.a);
vec4 lod0 = texture(bloomTexture0, uv);
lod0 = vec4(linearizeGamma(lod0.rgb), lod0.a);
vec4 lod1 = texture(bloomTexture1, uv);
lod1 = vec4(linearizeGamma(lod1.rgb), lod1.a);
vec4 lod2 = texture(bloomTexture2, uv);
lod2 = vec4(linearizeGamma(lod2.rgb), lod2.a);
vec4 lod3 = texture(bloomTexture3, uv);
lod3 = vec4(linearizeGamma(lod3.rgb), lod3.a);
vec4 lod4 = texture(bloomTexture4, uv);
lod4 = vec4(linearizeGamma(lod4.rgb), lod4.a);
vec4 blur = lodFactors[0] * lod0;
blur += lodFactors[1] * lod1;
blur += lodFactors[2] * lod2;
blur += lodFactors[3] * lod3;
blur += lodFactors[4] * lod4;
blur = bloomLod == 0 ? lodFactors[0] * lod0 : bloomLod == 1 ? lodFactors[1] * lod1 : bloomLod == 2 ? lodFactors[2] * lod2 : bloomLod == 3 ? lodFactors[3] * lod3 : bloomLod == 4 ? lodFactors[4] * lod4 : blur;
vec4 emission = texture(emissionTexture, uv);
emission = vec4(linearizeGamma(emission.rgb), emission.a);
emission += blur;
emission = vec4(tonemapACES(emission.rgb), emission.a);
fragColor = emission + color;
fragColor = delinearizeGamma(fragColor);`),e}const v=Object.freeze(Object.defineProperty({__proto__:null,BloomCompositionPassParameters:g,build:y,defaultCompositionParameters:_},Symbol.toStringTag,{value:"Module"}))},57088:function(e,t,i){i.d(t,{B:function(){return l},b:function(){return o}});var r=i(17904),n=i(48857),s=i(34709),a=i(15150);function o(){const e=new a.kG;return e.include(r.k),e.fragment.uniforms.add(new s.A("blendWeightsTexture",(e=>e.inputTexture)),new s.A("colorTexture",(e=>e.color))),e.fragment.main.add(n.H`vec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));
vec4 offsets = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);
vec4 a;
a.rb = texture(blendWeightsTexture, uv).rb;
a.g = texture(blendWeightsTexture, offsets.zw).g;
a.a = texture(blendWeightsTexture, offsets.xy).a;
if ( dot(a, vec4(1.0)) < 1e-5 ) {
fragColor = texture( colorTexture, uv, 0.0 );
} else {
vec2 offset;
offset.x = a.a > a.b ? a.a : -a.b;
offset.y = a.g > a.r ? -a.g : a.r;
if ( abs( offset.x ) > abs( offset.y )) {
offset.y = 0.0;
} else {
offset.x = 0.0;
}
vec4 C = texture( colorTexture, uv, 0.0 );
vec4 Cop = texture( colorTexture, uv + sign( offset ) * resolution.xy, 0.0 );
float s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );
fragColor = mix(C, Cop, s);
}`),e}const l=Object.freeze(Object.defineProperty({__proto__:null,build:o},Symbol.toStringTag,{value:"Module"}))},32667:function(e,t,i){i.d(t,{C:function(){return f},b:function(){return m}});var r=i(1824),n=i(40212),s=i(32179),a=i(9535),o=i(85119),l=i(48857),c=i(71063),h=i(4075),u=i(47975),d=i(85797),p=i(15150);function m(e){const t=new p.kG;t.include(h.X);const{reduced:i}=e,{fragment:m}=t;return(0,s.Pe)(m),m.include(n.D),m.include(u.l),m.include(d.l),m.include(r.t,!1),m.uniforms.add(new a.J("backgroundColor",(e=>e.backgroundColor)),new o.p("innerFadeDistance",(e=>e.innerFadeDistance)),new o.p("altitudeFade",(e=>e.altitudeFade)),new c.e("depthTexture",(e=>e.mainDepth))).code.add(l.H`vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {
float rayPlanetDistance = heightParameters[1] - radii[0] * radii[0];
vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, rayPlanetDistance);
if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {
return fragColor;
}
float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));
vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);
float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;
if (relDist > 1.0) {
return surfaceColor;
}
return mix(fragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));
}
float getGlow(float dist, float radius, float intensity) {
return pow(radius / max(dist, 1e-6), intensity);
}
vec3 getSun(vec3 cameraPos, vec3 rayDir, vec3 lightDir){
float scaleFract = (length(cameraPos) - radii[0]) / scaleHeight;
float sunOpticalDepth = getOpticalDepth(cameraPos, rayDir, max(scaleFract, 0.0));
vec3 sunTransmittance = exp(-(mix(betaCombined, betaRayleigh, 0.5)) * max(0.0, sunOpticalDepth));
float mu = clamp(dot(rayDir, lightDir), 0.0, 1.0);
float sunDisc = 256.0 * smoothstep(0.0, 128.0, clamp(getGlow(1.0 - mu, 3e-5, 3.0), 0.0, 128.0));
return normalize(sunTransmittance) * sunDisc;
}`).main.add(l.H`
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;
      ${(0,l.If)(!i,l.H`float depthSample = texture(depthTexture, uv).r;
             if (depthSample != 1.0) {
                fragColor = vec4(0);
                return;
             }`)}

      vec3 col = linearizeGamma(backgroundColor);
      col += raymarchAtmosphere(cameraPosition, rayDir, mainLightDirection, terrainDepth);
      col += getSun(cameraPosition, rayDir, mainLightDirection);
      float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));

      col = tonemapACES(col);
      fragColor = delinearizeGamma(vec4(col, alpha));
      fragColor = applyUndergroundAtmosphere(rayDir, mainLightDirection, fragColor);
  `),t}const f=Object.freeze(Object.defineProperty({__proto__:null,build:m},Symbol.toStringTag,{value:"Module"}))},55868:function(e,t,i){i.d(t,{C:function(){return b},a:function(){return T},b:function(){return C},c:function(){return w}});var r=i(61432),n=i(99574),s=i(30748),a=i(26821),o=i(41788),l=i(85382),c=i(23625),h=i(17904),u=i(54231),d=i(19155),p=i(85119),m=i(48857),f=i(57798),_=i(34709),g=i(47975),y=i(74826),v=i(15150);class b extends y.K{constructor(){super(...arguments),this.cloudRadius=0,this.cloudSize=0,this.detailSize=0,this.absorption=0,this.density=0,this.smoothness=0,this.cloudHeight=0,this.coverage=0,this.lastSlice=!1,this.viewMatrix=(0,s.Ue)()}}const w=(0,r.Z)("esri-mobile")?1024:2048;function C(e){const t=new v.kG;t.include(h.k,!1);const i=t.fragment;return i.include(g.l),i.uniforms.add(new p.p("cloudRadius",(e=>e.cloudRadius)),new p.p("power",(e=>(0,n.t7)(35,120,e.absorption))),new p.p("sigmaE",(e=>1+e.absorption)),new p.p("density",(e=>(0,n.t7)(0,.3,e.density))),new p.p("cloudSize",(e=>(0,n.t7)(0,.02,Math.max(.01,1-e.cloudSize)))),new p.p("detailSize",(e=>(0,n.t7)(0,.2,Math.max(.01,1-e.detailSize)))),new p.p("smoothness",(e=>(0,n.t7)(0,.5,1-e.smoothness))),new p.p("cloudHeight",(e=>(0,n.t7)(0,1500,e.cloudHeight))),new p.p("coverage",(e=>e.coverage)),new f.c("view",(e=>e.viewMatrix)),new _.A("cloudShapeTexture",(e=>null!=e.noiseTexture?e.noiseTexture.textureAtlas:null)),new d.A("cloudVariables",(e=>(0,a.t8)(x,e.coverage,e.absorption))),new u.U("lastSlice",(e=>e.lastSlice))),i.constants.add("halfCubeMapSize","float",.5*w),i.code.add(m.H`
    const int STEPS = ${e.steps===l.p.SIXTEEN?m.H`16`:e.steps===l.p.HUNDRED?m.H`100`:m.H`200`};
    const int STEPS_LIGHT = 6;
    const float stepL = 300.0 / float(STEPS_LIGHT);
    const float cloudStart = 1500.0;

    vec3 rayDirection(vec2 fragCoord) {
      vec2 xy = fragCoord;
      xy.x -= halfCubeMapSize;
      xy.y = lastSlice ? fragCoord.y - halfCubeMapSize : fragCoord.y;

      return normalize(vec3(-xy, -halfCubeMapSize));
    }

    float remap(float x, float low1, float high1, float low2, float high2) {
      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
    }

    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }`),i.code.add(m.H`
    float getCloudShape(vec3 pos, float pOffset) {
      const float textureWidth = ${m.H.float(c.a5)};
      const float dataWidth = ${m.H.float(c.a5)};
      const float tileRows = ${m.H.float(c.CB)};
      const vec3 atlasDimensions = vec3(${m.H.float(c.i9)}, ${m.H.float(c.i9)}, tileRows * tileRows);

      //Change from Y being height to Z being height
      vec3 p = float(${m.H.float(c.Mw)}) * pos.xzy;

      //Pixel coordinates of point in the 3D data
      vec3 coord = vec3(mod(p - pOffset * atlasDimensions, atlasDimensions));
      float f = fract(coord.z);
      float level = floor(coord.z);
      float tileY = floor(level / tileRows);
      float tileX = level - tileY * tileRows;

      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column
      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;
      vec2 pixel = coord.xy + offset;
      vec2 data = texture(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;

      return 1.0 - mix(data.x, data.y, f);
    }

    float getCloudMap(vec2 p){
      // Shift the texture center to origin to avoid seam artifacts
      vec2 uv = (${m.H.float(c.H6)} * p) / ${m.H.float(c.a5)} + 0.5;

      return texture(cloudShapeTexture, uv).a;
    }
    `),i.code.add(m.H`float clouds(vec3 p) {
float cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));
if (cloud <= 0.0) {
return 0.0;
}
float cloudMap = getCloudMap(cloudSize * p.xy);
cloud = mix(cloud, min(2.0 * (coverage), 1.0) * cloudMap, min(2.0 * (1.0 - coverage), 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float shape = getCloudShape(8.0 * cloudSize * p, 0.0);
cloud = saturate(remap(cloud, smoothness * shape, 1.0, 0.0, 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);
cloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * smoothstep(1.0, 0.25, heightFraction);
if (cloud <= 0.0) {
return 0.0;
}
return density * saturate(remap(cloud, 0.35 * smoothness * getCloudShape(detailSize * p, 0.0), 1.0, 0.0, 1.0));
}`),i.code.add(m.H`float HenyeyGreenstein(float g, float costh) {
return (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));
}
float multipleOctaves(float extinction, float mu, float stepL) {
float attenuation = 1.0;
float contribution = 1.0;
float phaseAttenuation = 1.0;
float luminance = 0.0;
for (int i = 0; i < 4; i++) {
float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);
luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);
attenuation *= 0.2;
contribution *= 0.6;
phaseAttenuation *= 0.5;
}
return luminance;
}`),i.code.add(m.H`float lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {
float lightRayDensity = clouds(p);
lightRayDensity += clouds(p + sunDirection * 1.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 2.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 3.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 4.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 5.0 * stepL);
float beersLaw = multipleOctaves(lightRayDensity, mu, stepL);
return mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);
}`),i.code.add(m.H`float mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {
if (dir.z < 0.0) {
return 0.0;
}
totalTransmittance = 1.0;
float stepS = totalDistance / float(STEPS);
float cameraHeight = length(org);
float mu = 0.5 + 0.5 * dot(sunDirection, dir);
float phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);
vec3 p = org + distToStart  * dir;
float dist = distToStart;
float shading = 0.0;
for (int i = 0; i < STEPS; i++) {
float sampleDensity = clouds(p);
float sampleSigmaE = sampleDensity * sigmaE;
if (sampleDensity > 0.0 ) {
float ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));
float luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));
float transmittance = exp(-sampleSigmaE * stepS);
shading += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;
totalTransmittance *= transmittance;
if (totalTransmittance <= 0.001) {
totalTransmittance = 0.0;
break;
}
}
dist += stepS;
p = org + dir * dist;
}
return shading;
}`),i.main.add(m.H`if (coverage ==  0.0) {
fragColor = vec4(0.0, 1.0, 0.0, 1.0);
return;
}
vec3 rayDir = rayDirection(gl_FragCoord.xy);
rayDir = normalize(view * rayDir);
vec3 viewPos = vec3(0, 0, cloudRadius + 1.0);
float hazeFactor = smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(dot(rayDir, vec3(0, 0, 1))));
float totalTransmittance = 1.0;
float shading = 0.0;
float cloudDistance = cloudRadius + cloudStart;
float rayStartDistance = dot(viewPos, viewPos) - (cloudDistance * cloudDistance);
vec2 rayStartIntersect = sphereIntersect(viewPos, rayDir, rayStartDistance);
float rayEndDistance = dot(viewPos, viewPos) - ((cloudDistance + cloudHeight) * (cloudDistance + cloudHeight));
vec2 rayEndIntersect = sphereIntersect(viewPos, rayDir, rayEndDistance);
float distToStart = rayStartIntersect.y;
float totalDistance = rayEndIntersect.y - distToStart;
vec3 sunDirection = normalize(vec3(0, 0, 1));
shading = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance);
shading = mix(clamp(1.0 - cloudVariables.y, 0.6, 1.0), shading, hazeFactor);
totalTransmittance = mix(0.0, totalTransmittance, hazeFactor);
fragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);`),t}const x=(0,o.Ue)(),T=Object.freeze(Object.defineProperty({__proto__:null,CloudsPassParameters:b,build:C,cubeMapSize:w},Symbol.toStringTag,{value:"Module"}))},30418:function(e,t,i){i.d(t,{C:function(){return _},b:function(){return f}});var r=i(72882),n=i(40212),s=i(42510),a=i(28262),o=i(29736),l=i(13743),c=i(45701),h=i(87688),u=i(13663),d=i(48857),p=i(4075),m=i(15150);function f(){const e=new m.kG,{fragment:t}=e;return e.include(p.X,{needUVs:!1,needEyeDirection:!1}),t.include(l.Y),t.include(c.n),e.include(r._,{pbrMode:s.f7.Disabled,lightingSphericalHarmonicsOrder:2}),t.include(a.e),t.include(n.D),e.include(o.j),t.uniforms.add(new h.d("cameraPosition",(e=>e.camera.eye)),new u.z("cloudsOpacity",(e=>e.clouds.opacity))).main.add(d.H`vec4 cloudsColor = renderClouds(normalize(worldRay), cameraPosition);
fragColor = vec4(cloudsOpacity * cloudsColor.rgb, cloudsColor.a);`),e}const _=Object.freeze(Object.defineProperty({__proto__:null,build:f},Symbol.toStringTag,{value:"Module"}))},58498:function(e,t,i){i.d(t,{C:function(){return U},b:function(){return F}});var r=i(21414),n=i(61796),s=i(54998),a=i(92473),o=i(70662),l=i(41044),c=i(27349),h=i(31839),u=i(56335),d=i(48737),p=i(92684),m=i(37452),f=i(40122),_=i(24807),g=i(67669),y=i(46722),v=i(51647),b=i(19065),w=i(32179),C=i(42510),x=i(4162),T=i(36351),S=i(7086),M=i(76144),E=i(95030),P=i(93270),R=i(48857),A=i(71063),O=i(34709),D=i(60037),I=i(75047),L=i(15150),N=i(64801);function F(e){const t=new L.kG,{vertex:i,fragment:F}=t;t.include(p.up,e),t.include(d.Bb,e),t.include(u.c,e),t.include(h.D,e),t.include(o.qj,e),t.include(s.AD,e),t.include(E.o,e),F.include(c.P_,e),t.include(x.s,e),t.include(S.H,e);const{output:U,pbrMode:H,hasNormalTexture:k,snowCover:V,receiveShadows:B,shadeNormals:z,spherical:G,ellipsoidMode:q,overlayEnabled:Z,componentData:j,vertexDiscardMode:W,hasBloom:$,renderOccluded:X}=e,Y=H===C.f7.Normal||H===C.f7.Schematic;Y&&(t.include(C.jV,e),k&&t.include(v.Q,e));const K=U===l.H_.Shadow||U===l.H_.ShadowHighlight||U===l.H_.ShadowExcludeHighlight,Q=K&&j===s._N.Varying;if(Z){t.include(b.XP,e),t.include(M.WB,e);const n=q===P.U.Earth,s=q===P.U.Earth,a=n?r.sv.radius:s?r.yr.radius:r.Z1.radius;i.code.add(`\n      ${(0,R.If)(G,`const float invRadius = ${R.H.float(1/a)};`)}\n      vec2 projectOverlay(vec3 pos) { return pos.xy ${(0,R.If)(G,"/ (1.0 + invRadius * pos.z);")}; }`)}const J=Z&&(0,l.c1)(U)&&H===C.f7.WaterOnIntegratedMesh;J&&(t.varyings.add("tbnTangent","vec3"),t.varyings.add("tbnBiTangent","vec3"),t.varyings.add("groundNormal","vec3"));const ee=W===a.a.None,te=W===a.a.Opaque;if(i.main.add(R.H`
    bool castShadows;
    vec4 externalColor = forwardExternalColor(castShadows);
    ${(0,R.If)(Q,"if(!castShadows) { gl_Position = vec4(vec3(1e38), 1.0); return; }")}

    ${(0,R.If)(!ee,`{ if (externalColor.a ${te?">":"<="} ${R.H.float(1-1/255)}) { gl_Position = vec4(vec3(1e38), 1.0); return; } }`)}

    ${(0,R.If)(U===l.H_.ObjectAndLayerIdColor,"externalColor.a = 1.0;")}

    forwardPosition(readElevationOffset());
    forwardViewPosDepth(vPosition_view);
    forwardNormal();
    forwardTextureCoordinates();
    forwardVertexColor();
    forwardLinearDepth();
    forwardObjectAndLayerIdColor();
    ${(0,R.If)(J,G?R.H`
            groundNormal = normalize(positionWorld());
            tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));
            tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`:R.H`
            groundNormal = vec3(0.0, 0.0, 1.0);
            tbnTangent = vec3(1.0, 0.0, 0.0);
            tbnBiTangent = vec3(0.0, 1.0, 0.0);`)}
    ${(0,R.If)(Z,"setOverlayVTC(projectOverlay(position));")}

    if (externalColor.a < ${R.H.float(N.e)}) {
      // Discard this vertex
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    }
  `),(0,l.c1)(U))return t.include(y.P,e),t.include(g.K,e),t.include(b.XP,e),t.include(I.j,e),F.include(D.R,e),B&&t.include(T.hb,e),F.code.add(R.H`
      float evaluateShadow() {
        return ${B?"readShadowMap(vPositionWorldCameraRelative, linearDepth)":"0.0"};
      }`),Z&&F.uniforms.add(new O.A("ovColorTex",((e,t)=>(0,M.WE)(e,t)))),F.main.add(R.H`
      discardBySlice(vPositionWorldCameraRelative);
      discardByTerrainDepth();

      vec4 textureColor = readBaseColorTexture();
      discardOrAdjustAlpha(textureColor);

      /* When rendering the occluded overlay, we still need to read the base color texture
       * because we need to use the same discard logic. However after that to render only the
       * draped overlay, we simply set the base texture color to zero. */
      ${(0,R.If)(X,R.H`textureColor = vec4(0);`)}

      ${(0,R.If)(Z,R.H`vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);`)}

      /* Early discard to only emit when we have overlay */
      ${(0,R.If)(Z&&X,R.H`if (overlayColor.a < ${R.H.float(N.e)}) { discard; }`)}

      vec4 externalColor;
      int externalColorMixMode;
      readExternalColor(externalColor, externalColorMixMode);

      vec4 materialColor = computeMaterialColor(textureColor, externalColor, externalColorMixMode);
    `),Y?((0,w.F1)(F),G&&(0,b.sC)(F),F.main.add(R.H`
        applyPBRFactors();
        ${(0,R.If)(H===C.f7.Normal,R.H`if (externalColorMixMode == 3) {
              mrr = vec3(0.0, 0.6, 0.2);
            }`)}
        float additionalIrradiance = 0.02 * mainLightIntensity[2];
        ${(0,R.If)(k,"mat3 tangentSpace = computeTangentSpace(fragmentFaceNormal, vPositionWorldCameraRelative, vuv0);")}
        vec3 shadingNormal = ${k?"computeTextureNormal(tangentSpace, vuv0)":"fragmentShadingNormal"};
        vec3 groundNormal = ${G?R.H`normalize(positionWorld())`:R.H`vec3(0.0, 0.0, 1.0)`};

        vec3 viewDir = normalize(vPositionWorldCameraRelative);
        float ssao = 1.0 - occlusion * evaluateAmbientOcclusionInverse();
        ${(0,R.If)(V,R.H`float snow = getSnow(fragmentFaceNormal, normalize(positionWorld()));
                 materialColor.rgb = mix(materialColor.rgb, vec3(1.1), snow);
                 ssao = mix(ssao, 0.5 * ssao, snow);
                 shadingNormal = mix(shadingNormal, fragmentFaceNormal, snow);`)}
        ${(0,R.If)(Z,"materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;")}

        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());
        vec4 emission = ${$?"vec4(0.0)":"getEmissions(materialColor.rgb)"};
        ${(0,R.If)(G,"float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());")}
        ${G?R.H`float shadow = max(lightingGlobalFactor * (1.0 - additionalAmbientScale), evaluateShadow());`:"float shadow = evaluateShadow();"}
        vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, shadow, ssao, additionalLight, viewDir, groundNormal, mrr, emission, additionalIrradiance), materialColor.a);
        `)):((0,w.Pe)(F),G&&(0,b.sC)(F),J&&F.uniforms.add(new A.e("ovNormalTex",(e=>e.overlay?.getTexture(n.D.WaterNormal)))),F.main.add(R.H`
        ${(0,R.If)(G,"float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());")}
        float shadow = ${B?G?"max(lightingGlobalFactor * (1.0 - additionalAmbientScale), evaluateShadow())":"evaluateShadow()":G?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0"};

        ${(0,R.If)(B&&!z,R.H`
            float dotFL = dot(fragmentFaceNormal, mainLightDirection);
            if( dotFL <= 0.0) shadow = 1.0;
        `)}
        ${(0,R.If)(V,R.H`float snow = getSnow(fragmentFaceNormal, normalize(positionWorld()));
               materialColor.rgb = mix(materialColor.rgb, vec3(1), snow);`)}

        // At global scale we create some additional ambient light based on the main light to simulate global illumination
        float ssao = evaluateAmbientOcclusion();
        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());

        ${(0,R.If)(Z,"materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;")}

        vec4 shadedColor = vec4(evaluateSceneLighting(fragmentShadingNormal, materialColor.rgb, shadow, ssao, additionalLight), materialColor.a);
        ${(0,R.If)(J,R.H`vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);
                 float waterNormalLength = length(overlayWaterMask);
                 if (waterNormalLength > 0.95) {
                   mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);
                   vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, overlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, vPosition_view, positionWorld());
                   vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                   // un-gamma the ground color to mix in linear space
                   shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);
                 }`)}
      `)),F.main.add(`outputColorHighlightOID(shadedColor, vPositionWorldCameraRelative, materialColor.rgb ${(0,R.If)(V,", snow")});`),t;const ie=U===l.H_.Normal,re=U===l.H_.ObjectAndLayerIdColor,ne=U===l.H_.Highlight,se=K||U===l.H_.ViewshedShadow;return se&&t.include(m.F,e),ie&&t.include(g.K,e),Z&&t.include(_._,e),t.include(f.b,e),F.main.add(R.H`
    discardBySlice(vPositionWorldCameraRelative);

    vec4 textureColor = readBaseColorTexture();
    discardOrAdjustAlpha(textureColor);

    ${(0,R.If)(se,"outputDepth(linearDepth);")}
    ${(0,R.If)(ie,R.H`fragColor = vec4(vec3(0.5) + 0.5 * fragmentFaceNormalView, 1.0);`)}
    ${(0,R.If)(re,Z?"fragColor = getOverlayColorTexel();":"outputObjectAndLayerIdColor();")}
    ${(0,R.If)(ne,(0,R.If)(Z,R.H`calculateOcclusionAndOutputHighlight(getAllOverlayHighlightValuesEncoded());`,R.H`calculateOcclusionAndOutputHighlight();`))}`),t}const U=Object.freeze(Object.defineProperty({__proto__:null,build:F},Symbol.toStringTag,{value:"Module"}))},65562:function(e,t,i){i.d(t,{C:function(){return p},a:function(){return f},b:function(){return m}});var r=i(17904),n=i(20638),s=i(45701),a=i(37124),o=i(85119),l=i(48857),c=i(34709),h=i(38419),u=i(74826),d=i(15150);class p extends u.K{constructor(){super(...arguments),this.opacity=1}}function m(e){const t=new d.kG;t.include(r.k),t.fragment.uniforms.add(new c.A("tex",(e=>e.texture))),e.hasOpacityFactor&&t.fragment.uniforms.add(new o.p("opacity",(e=>e.opacity)));const i=e.blitMode===h.J.Depth;return i&&(t.fragment.uniforms.add(new a.$("nearFar",(e=>e.camera.nearFar))),t.fragment.include(n.K),t.fragment.include(s.n)),t.fragment.main.add(l.H`
    ${i?l.H`
          float normalizedLinearDepth = (-linearDepthFromTexture(tex, uv) - nearFar[0]) / (nearFar[1] - nearFar[0]);
          fragColor = float2rgba(normalizedLinearDepth);`:l.H`
          fragColor = texture(tex, uv) ${e.hasOpacityFactor?"* opacity":""};`}`),t}const f=Object.freeze(Object.defineProperty({__proto__:null,CompositingPassParameters:p,build:m},Symbol.toStringTag,{value:"Module"}))},47935:function(e,t,i){i.d(t,{E:function(){return l},b:function(){return o}});var r=i(17904),n=i(48857),s=i(34709),a=i(15150);function o(){const e=new a.kG;return e.include(r.k),e.outputs.add("fragEdges","vec2"),e.fragment.code.add(n.H`float absMax3(vec3 v) {
vec3 t = abs(v);
return max(max(t.r, t.g), t.b);
}`),e.fragment.uniforms.add(new s.A("colorTexture",(e=>e.color))).main.add(n.H`
    vec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));
    vec4 offsets[3];
    offsets[0] = vec4(uv.x - resolution.x, uv.y, uv.x, uv.y + resolution.y);
    offsets[1] = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);
    offsets[2] = vec4(uv.x - 2.0 * resolution.x, uv.y, uv.x, uv.y + 2.0 * resolution.y);

    // Calculate color deltas:
    vec3 C = texture(colorTexture, uv).rgb;
    vec3 Cleft = texture(colorTexture, offsets[0].xy).rgb;
    vec3 Ctop = texture(colorTexture, offsets[0].zw).rgb;
    vec2 delta = vec2(absMax3(C - Cleft), absMax3(C - Ctop));
    vec2 edges = step(vec2(${n.H.float(.05)}), delta);

    // discard if there is no edge:
    if (dot(edges, vec2(1.0)) == 0.0) {
      fragEdges = vec2(0.0);
    }
    else {
      // Calculate right and bottom deltas:
      vec3 Cright = texture(colorTexture, offsets[1].xy).rgb;
      float horizontal = absMax3(C - Cright);

      vec3 Cbottom  = texture(colorTexture, offsets[1].zw).rgb;
      float vertical = absMax3(C - Cbottom);

      // Calculate the maximum delta in the direct neighborhood:
      float maxDelta = max(max(max(delta.x, delta.y), horizontal), vertical);

      // Calculate left-left and top-top deltas:
      vec3 Cleftleft  = texture(colorTexture, offsets[2].xy).rgb;
      horizontal = absMax3(C - Cleftleft);

      vec3 Ctoptop = texture(colorTexture, offsets[2].zw).rgb;
      vertical = absMax3(C - Ctoptop);

      // Calculate the final maximum delta:
      maxDelta = max(max(maxDelta, horizontal), vertical);

      // Local contrast adaptation in action:
      fragEdges = edges * step(maxDelta, float(${n.H.float(2)}) * delta);
    }
  `),e}const l=Object.freeze(Object.defineProperty({__proto__:null,build:o},Symbol.toStringTag,{value:"Module"}))},16926:function(e,t,i){i.d(t,{F:function(){return _},a:function(){return y},b:function(){return g}});var r=i(82846),n=i(20638),s=i(40212),a=i(87688),o=i(9535),l=i(85119),c=i(48857),h=i(71063),u=i(4075),d=i(47975),p=i(85797),m=i(74826),f=i(15150);class _ extends m.K{constructor(){super(...arguments),this.color=(0,r.Ue)(),this.strength=4e-6,this.atmosphereC=1,this.amount=0}}function g(){const e=new f.kG;e.include(u.X,{needUVs:!0,needEyeDirection:!0});const t=e.fragment;return t.uniforms.add(new l.p("atmosphereC",(e=>e.atmosphereC)),new a.d("cameraPosition",(e=>e.camera.eye)),new h.e("depthTexture",(e=>e.mainDepth)),new l.p("fogStrength",(e=>e.strength)),new l.p("fogAmount",(e=>e.amount)),new o.J("fogColor",(e=>e.color))),t.include(s.D),t.include(d.l),t.include(p.l),t.include(n.K),t.code.add(c.H`float getFogAmount(float dist, vec3 rayDir) {
if(dist == -1.0){
dist = 0.055 * sphereIntersect(cameraPosition, rayDir, atmosphereC).y;
}
return fogAmount * (1.0 - exp(-dist * fogStrength));
}`),t.main.add(c.H`vec3 rayDir = normalize(worldRay);
float terrainDepth = -1.0;
float depthSample = depthFromTexture(depthTexture, uv);
if(depthSample < 1.0 && depthSample > 0.0){
vec3 cameraSpaceRay = normalize(eyeDir);
cameraSpaceRay /= cameraSpaceRay.z;
cameraSpaceRay *= linearizeDepth(depthSample);;
terrainDepth = max(0.0, length(cameraSpaceRay));
}
float fogAmount = getFogAmount(terrainDepth, rayDir);
vec4 fog = vec4(fogColor, 1.0) * fogAmount;
fragColor = delinearizeGamma(vec4(tonemapACES(fog.rgb), fog.a));`),e}const y=Object.freeze(Object.defineProperty({__proto__:null,FogPassParameters:_,build:g},Symbol.toStringTag,{value:"Module"}))},93223:function(e,t,i){i.d(t,{H:function(){return l},a:function(){return h},b:function(){return c}});var r=i(17904),n=i(48857),s=i(34709),a=i(74826),o=i(15150);class l extends a.K{}function c(){const e=new o.kG;return e.include(r.k),e.fragment.uniforms.add(new s.A("tex",(e=>e.texture))),e.fragment.main.add(n.H`fragColor = vec4(1.0 - texture(tex, uv).a);`),e}const h=Object.freeze(Object.defineProperty({__proto__:null,HUDCompositingPassParameters:l,build:c},Symbol.toStringTag,{value:"Module"}))},79626:function(e,t,i){i.d(t,{H:function(){return f},b:function(){return m}});var r=i(1824),n=i(20638),s=i(40212),a=i(32179),o=i(85119),l=i(48857),c=i(71063),h=i(4075),u=i(47975),d=i(85797),p=i(15150);function m(e){const t=new p.kG,{fragment:i}=t;t.include(h.X),(0,a.Pe)(i),i.include(s.D),i.include(n.K),i.include(u.l),i.include(d.l),i.include(r.t,!0),i.uniforms.add(new c.e("depthTexture",(e=>e.mainDepth)),new o.p("hazeStrength",(e=>e.hazeStrength)));const{reduced:m}=e;return m&&i.code.add(l.H`float getDepth(vec2 uv){
return linearDepthFromTexture(depthTexture, uv);
}
float textureBilinear(vec2 uv) {
vec2 depthTextureSize = vec2(textureSize(depthTexture, 0));
vec2 texelSize = 1.0 / depthTextureSize;
vec2 depthUV = (uv * depthTextureSize) - vec2(0.5);
vec2 f = fract(depthUV);
vec2 snapUV = (floor(depthUV) + vec2(0.5)) / depthTextureSize;
float d0 = getDepth(snapUV);
float d1 = getDepth(snapUV + vec2(texelSize.x, 0.0));
float d2 = getDepth(snapUV + vec2(0.0, texelSize.y));
float d3 = getDepth(snapUV + texelSize);
return mix(mix(d0, d1, f.x), mix(d2, d3, f.x), f.y);
}`),i.main.add(l.H`
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;

      float depthSample = texture(depthTexture, uv).r;
      if (depthSample != 1.0) {
        vec3 cameraSpaceRay = normalize(eyeDir);
        cameraSpaceRay /= cameraSpaceRay.z;

        cameraSpaceRay *= ${(0,l.If)(m,"-textureBilinear(uv)","-linearDepthFromTexture(depthTexture, uv)")};
        terrainDepth = max(0.0, length(cameraSpaceRay));
      } else {
        discard;
      }

      // Alpha is ignored for haze blending
      vec3 col = vec3(0);
      float fadeOut = smoothstep(-10000.0, -15000.0, heightParameters[0] - radii[0]);
      if(depthSample != 1.0){
        col = (1.0 - fadeOut) * hazeStrength * raymarchAtmosphere(cameraPosition, rayDir, mainLightDirection, terrainDepth);
      }
      float alpha = 1.0;

      col = tonemapACES(col);
      fragColor = delinearizeGamma(vec4(col, alpha));
  `),t}const f=Object.freeze(Object.defineProperty({__proto__:null,build:m},Symbol.toStringTag,{value:"Module"}))},41811:function(e,t,i){i.d(t,{H:function(){return c},a:function(){return u},b:function(){return h}});var r=i(17904),n=i(48857),s=i(71063),a=i(34709),o=i(74826),l=i(15150);class c extends o.K{}function h(){const e=new l.kG;return e.include(r.k),e.fragment.uniforms.add(new a.A("colorTexture",(e=>e.color)),new s.e("depthTexture",(e=>e.mainDepth))),e.fragment.main.add(n.H`float depthSample = texture(depthTexture, uv).r;
if (depthSample == 1.0 ) {
fragColor = vec4(0);
return;
}
fragColor = texture(colorTexture, uv);`),e}const u=Object.freeze(Object.defineProperty({__proto__:null,HazeCompositingPassParameters:c,build:h},Symbol.toStringTag,{value:"Module"}))},87619:function(e,t,i){i.d(t,{M:function(){return p},a:function(){return y},b:function(){return m}});var r=i(96094),n=i(73749),s=i(27583),a=i(54231),o=i(2013),l=i(48857),c=i(34709),h=i(52061),u=i(74826),d=i(15150);class p extends u.K{constructor(){super(...arguments),this.mask=null,this.overlay=null,this.input=null,this.size=0}}function m(){const e=new d.kG;return e.attributes.add(h.T.POSITION,"vec2"),e.vertex.uniforms.add(new o.N("drawPosition",((e,t)=>function(e,t){const i=t.camera.pixelRatio,s=e.magnifier.offset.x*i,a=e.magnifier.offset.y*i;(0,r.md)(e.magnifier.position,f);const o=t.camera.screenToRender(f,_),l=Math.ceil(i*e.magnifier.size),{fullWidth:c,fullHeight:h}=t.camera;return(0,n.s)(g,(o[0]+s)/c*2-1,(o[1]-a)/h*2-1,l/c*2,l/h*2)}(e,t)))),e.varyings.add("vUV","vec2"),e.vertex.main.add(l.H`vUV = position;
gl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);`),e.fragment.uniforms.add(new c.A("textureInput",(e=>e.input))),e.fragment.uniforms.add(new c.A("textureMask",(e=>e.mask))),e.fragment.uniforms.add(new c.A("textureOverlay",(e=>e.overlay))),e.fragment.uniforms.add(new a.U("maskEnabled",(e=>e.magnifier.maskEnabled))),e.fragment.uniforms.add(new a.U("overlayEnabled",(e=>e.magnifier.overlayEnabled))),e.fragment.code.add(l.H`const float barrelFactor = 1.1;
vec2 barrel(vec2 uv) {
vec2 uvn = uv * 2.0 - 1.0;
if (uvn.x == 0.0 && uvn.y == 0.0) {
return vec2(0.5, 0.5);
}
float theta = atan(uvn.y, uvn.x);
float r = pow(length(uvn), barrelFactor);
return r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;
}`),e.fragment.main.add(l.H`float mask = maskEnabled ? texture(textureMask, vUV).a : 1.0;
vec4 inputColor = texture(textureInput, barrel(vUV)) * mask;
vec4 overlayColor = overlayEnabled ? texture(textureOverlay, vUV) : vec4(0);
fragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;`),e}const f=(0,r.s1)(),_=(0,r.gX)(),g=(0,s.Ue)(),y=Object.freeze(Object.defineProperty({__proto__:null,MagnifierPassParameters:p,build:m},Symbol.toStringTag,{value:"Module"}))},26605:function(e,t,i){i.d(t,{N:function(){return u},a:function(){return p},b:function(){return d}});var r=i(41788),n=i(80461),s=i(23625),a=i(17904),o=i(19155),l=i(48857),c=i(74826),h=i(15150);class u extends c.K{constructor(){super(...arguments),this.weatherTile=(0,r.al)(0,0)}}function d(e){const t=new h.kG;if(t.include(a.k,!1),t.fragment.code.add(l.H`float remap(float x, float low1, float high1, float low2, float high2) {
return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
}`),e.mode===n.u.Full){const e=2,i=8;t.fragment.code.add(l.H`float saturate(float x) {
return clamp(x, 0.0, 1.0);
}`),t.fragment.code.add(l.H`vec3 modulo(vec3 m, float n) {
return mod(mod(m, n) + n, n);
}
vec3 hash(vec3 p3, float frequency) {
p3 = modulo(p3, frequency);
p3 = fract(p3 * vec3(0.1031, 0.1030, 0.0973));
p3 += dot(p3, p3.yxz + 33.33);
return -1.0 + 2.0 * fract((p3.xxy + p3.yxx) * p3.zyx);
}`),t.fragment.code.add(l.H`vec3 fade(vec3 t) {
return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
}`),t.fragment.code.add(l.H`
    float gradientNoise(vec3 p, float frequency) {
      vec3 i = floor(p);
      vec3 f = fract(p);
      vec3 u = fade(f);
      return mix( mix( mix( dot( hash( i + vec3(0.0,0.0,0.0), frequency), f - vec3(0.0,0.0,0.0) ),
                            dot( hash( i + vec3(1.0,0.0,0.0), frequency), f - vec3(1.0,0.0,0.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,0.0), frequency), f - vec3(0.0,1.0,0.0) ),
                            dot( hash( i + vec3(1.0,1.0,0.0), frequency), f - vec3(1.0,1.0,0.0) ), u.x), u.y),
                  mix( mix( dot( hash( i + vec3(0.0,0.0,1.0), frequency), f - vec3(0.0,0.0,1.0) ),
                            dot( hash( i + vec3(1.0,0.0,1.0), frequency), f - vec3(1.0,0.0,1.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,1.0), frequency), f - vec3(0.0,1.0,1.0) ),
                            dot( hash( i + vec3(1.0,1.0,1.0), frequency), f - vec3(1.0,1.0,1.0) ), u.x), u.y), u.z );
    }

    float getPerlinNoise(vec3 pos, float frequency) {
      float octaveFrequency = 2.0;
      float sum = 0.0;
      float weightSum = 0.0;
      float weight = 1.0;

      for (int oct = 0; oct < 3; oct++) {
        vec3 p = pos * frequency;
        float val = 0.5 + 0.5 * gradientNoise(p, frequency);
        sum += val * weight;
        weightSum += weight;
        weight *= 0.5;
        frequency *= octaveFrequency;
      }

      float noise = (sum / weightSum);
      noise = saturate(noise);
      return noise;
    }

    float worley(vec3 pos, float numCells) {
      vec3 p = pos * numCells;
      float d = 1.0e10;

      for (int x = -1; x <= 1; x++) {
        for (int y = -1; y <= 1; y++) {
          for (int z = -1; z <= 1; z++) {
            vec3 tp = floor(p) + vec3(x, y, z);
            tp = p - tp - (hash(tp, numCells) * 0.5 + 0.5);
            d = min(d, dot(tp, tp));
          }
        }
      }

      return 1.0 - clamp(d, 0.0, 1.0);
    }

    vec3 get3Dfrom2D(vec2 uv) {
      vec2 tile = floor(uv);
      float z = floor(${l.H.float(s.CB)} * tile.y + tile.x);
      return vec3(fract(uv), z);
    }

    float getTextureForPointPerlinWorley(vec3 p) {
      float perlinNoise = getPerlinNoise(p, ${l.H.float(i)});

      float worley0 = worley(p, ${l.H.float(e)} * 2.0);
      float worley1 = worley(p, ${l.H.float(e)} * 8.0);
      float worley2 = worley(p, ${l.H.float(e)} * 14.0);

      float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);
    }

    float getTextureForPointWorley(vec3 p) {
      float worley0 = worley(p, ${l.H.float(e)});
      float worley1 = worley(p, ${l.H.float(e)} * 2.0);
      float worley2 = worley(p, ${l.H.float(e)} * 4.0);
      float worley3 = worley(p, ${l.H.float(e)} * 8.0);

      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;
      float FBM2 = worley2 * 0.75 + worley3 * 0.25;

      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;
    }
  `)}return t.fragment.uniforms.add(new o.A("weatherTile",(e=>e.weatherTile))).code.add(l.H`
    vec2 modulo(vec2 m, float n){
      return mod(mod(m, n) + n, n);
    }

    vec2 hash(vec2 p){
      // Get position of p in weather tile
      p = modulo(p, ${l.H.float(s.JK)});

      // Get global coordinates of p
      p += weatherTile * ${l.H.float(s.JK)};

      // Limit position to avoid numerical instability
      p = modulo(p, ${l.H.float(s.r7)});

      vec3 p3 = fract(vec3(p.xyx) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return 2.0 * fract((p3.xx + p3.yz) * p3.zy) - 1.0;
    }

    vec2 fade(vec2 t){
      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
    }

    float gradientNoise(vec2 p){
      vec2 i = floor( p );
      vec2 f = fract( p );

      vec2 u = fade(f);

      // Bilinear interpolation of gradients at cell vertices around point
      return  mix(
                mix(dot( hash( i + vec2(0.0,0.0) ), f - vec2(0.0,0.0) ),
                    dot( hash( i + vec2(1.0,0.0) ), f - vec2(1.0,0.0) ), u.x),
                mix(dot( hash( i + vec2(0.0,1.0) ), f - vec2(0.0,1.0) ),
                    dot( hash( i + vec2(1.0,1.0) ), f - vec2(1.0,1.0) ), u.x),
                u.y);
    }

    float worley(vec2 p){
      float d = 1.0e10;
      for (int x = -1; x <= 1; x++){
        for (int y = -1; y <= 1; y++){
                vec2 tp = floor(p) + vec2(x, y);
                tp = p - tp - (0.5 + 0.5 * hash(tp));
                d = min(d, dot(tp, tp));
            }
        }
      return 1.0 - clamp(d, 0.0, 1.0);
    }
  `),e.mode===n.u.Full?t.fragment.main.add(l.H`
      float padWidth = 1.0;
      float paddedSize = ${l.H.float(s.i9)} + 2.0 * padWidth;
      float tileCount = ${l.H.float(s.CB)} * ${l.H.float(s.CB)};
      vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);

      bool padCell = false;
      if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {
        padCell = true;
      }

      if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {
        padCell = true;
      }

      bool startPadX = false;
      bool startPadY = false;
      bool endPadX = false;
      bool endPadY = false;

      if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {
        startPadX = true;
      }

      if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {
        startPadY = true;
      }

      if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {
        endPadX = true;
      }

      if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {
        endPadY = true;
      }

      vec2 padding = vec2(2.0 * padWidth) * tile;
      vec2 uv;

      if (padCell) {
        vec2 pixel = gl_FragCoord.xy - padWidth - padding;

        if (startPadX) {
          pixel.x += ${l.H.float(s.i9)};
        }

        if (startPadY) {
          pixel.y += ${l.H.float(s.i9)};
        }

        if (endPadX) {
          pixel.x -= ${l.H.float(s.i9)};
        }

        if (endPadY) {
          pixel.y -= ${l.H.float(s.i9)};
        }

        uv = vec2(pixel.xy / ${l.H.float(s.i9)});
      } else {
        vec2 pixel = gl_FragCoord.xy - padWidth - padding;
        uv = vec2(pixel.xy / ${l.H.float(s.i9)});
      }

      vec3 p_ = get3Dfrom2D(uv);
      vec3 p = p_;
      p.z /= (${l.H.float(s.CB)} * ${l.H.float(s.CB)});

      float worleyPerlinNoise = getTextureForPointPerlinWorley(p);
      float worleyNoise = getTextureForPointWorley(p);

      fragColor.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

      p_ = mod(p_ + 1.0, ${l.H.float(s.CB)} * ${l.H.float(s.CB)});
      p = p_;
      p.z /= (${l.H.float(s.CB)} * ${l.H.float(s.CB)});

      worleyPerlinNoise = getTextureForPointPerlinWorley(p);
      worleyNoise = getTextureForPointWorley(p);

      fragColor.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

      vec2 mapUV = ${l.H.float(s.JK)} * (gl_FragCoord.xy / ${l.H.float(s.a5)});
      float map = abs(gradientNoise(mapUV));
      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);
      fragColor.ba = vec2(0.0, map);
      `):t.fragment.main.add(l.H`
      vec2 mapUV = ${l.H.float(s.JK)} * (gl_FragCoord.xy / ${l.H.float(s.a5)});
      float map = abs(gradientNoise(mapUV));
      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);
      fragColor = vec4(map);
    `),t}const p=Object.freeze(Object.defineProperty({__proto__:null,NoiseTextureAtlasPassParameters:u,build:d},Symbol.toStringTag,{value:"Module"}))},3931:function(e,t,i){i.d(t,{O:function(){return l},a:function(){return h},b:function(){return c}});var r=i(17904),n=i(48857),s=i(34709),a=i(74826),o=i(15150);class l extends a.K{}function c(e){const t=new o.kG;t.include(r.k);const i=e.hasEmission,a=t.fragment;return a.uniforms.add(new s.A("colorTexture",(e=>e.colorTexture)),new s.A("alphaTexture",(e=>e.alphaTexture)),new s.A("frontFaceTexture",(e=>e.frontFaceTexture))),t.outputs.add("fragColor","vec4",0),i&&(t.outputs.add("fragEmission","vec4",1),a.uniforms.add(new s.A("emissionTexture",(e=>e.emissionTexture))),a.uniforms.add(new s.A("emissionFrontFaceTexture",(e=>e.emissionFrontFaceTexture)))),a.main.add(n.H`
      float srcAlpha = texture(alphaTexture, uv).r;
      if(srcAlpha == 0.0){
        fragColor = vec4(0.0);
        ${(0,n.If)(i,"fragEmission = vec4(0.0);")}
        return;
      }

      vec4 srcColor = texture(colorTexture, uv);
      vec4 frontFace = texture(frontFaceTexture, uv);

      vec4 transparentColor = vec4(mix(srcColor.rgb / srcAlpha, frontFace.rgb, frontFace.a), 1.0 - srcColor.a);
      fragColor = transparentColor;

      ${(0,n.If)(i,"vec4 emission = texture(emissionTexture, uv);\n         vec4 emissionFrontFace = texture(emissionFrontFaceTexture, uv);\n        fragEmission = vec4(mix(emission.rgb / srcAlpha, emissionFrontFace.rgb, emissionFrontFace.a), emissionFrontFace.a);")}
    `),t}const h=Object.freeze(Object.defineProperty({__proto__:null,OITBlendPassParameters:l,build:c},Symbol.toStringTag,{value:"Module"}))},40854:function(e,t,i){i.d(t,{P:function(){return v},b:function(){return p}});var r=i(24910),n=i(82846),s=i(22567),a=i(87688),o=i(9535),l=i(85119),c=i(48857),h=i(18489),u=i(52061),d=i(15150);function p(e){const t=new d.kG;return t.attributes.add(u.T.POSITION,"vec3"),t.attributes.add(u.T.INSTANCEFEATUREATTRIBUTE,"float"),t.vertex.uniforms.add(new a.d("cameraPosition",(e=>e.camera.eye)),new o.J("offset",((e,t)=>function(e,t){const i=t.camera.eye,n=.5*e.width,s=1/e.width,a=(0,r.J)(m,(0,r.i)(m,(i[0]+n)*s,(i[1]+n)*s,(i[2]+n)*s));return(0,r.a)(a,i,(0,r.g)(a,a,e.width))}(e,t))),new l.p("width",(e=>e.width)),new l.p("time",(e=>e.time)),new h.C("proj",(e=>e.camera.projectionMatrix)),new h.C("view",(e=>e.camera.viewMatrix))),t.varyings.add("vUv","vec2"),t.vertex.code.add(c.H`vec3 hash31(float p){
vec3 p3 = fract(vec3(p) * vec3(0.1031, 0.1030, 0.0973));
p3 += dot(p3, p3.yzx + 33.33);
return fract((p3.xxy + p3.yzz) * p3.zyx);
}
float hash11(float p){
p = fract(p * 0.1031);
p *= p + 33.33;
p *= p + p;
return fract(p);
}
vec3 rotateVectorByQuaternion(vec3 v, vec4 q){
return 2.0 * cross(q.xyz, v * q.w + cross(q.xyz, v)) + v;
}`),t.vertex.main.add(c.H`
      vUv = position.xz;
      vec3 rand = hash31(instanceFeatureAttribute);

      // Set random position for all particles
      // The hash function space is not high resolution so offset particles by an additional random value
      // This creates grids of 1000 particles which are shifted by random hundredths of the tile width
      // overlaying multiple identical but offset grids
      vec3 randomPosition = 2.0 * (rand + (0.01 + 0.01 * rand) * floor(0.001 * instanceFeatureAttribute)) - 1.0;

      // Random orientation of rain drops
      float angle = 3.1415 * hash11(instanceFeatureAttribute);

      vec3 up = vec3(0, 0, 1);

      // Gravity and wind direction
      vec3 direction = normalize(cameraPosition);

      vec3 tangent = normalize(cross(direction, up));

      // Gravity
      vec3 animatedPos = randomPosition + direction * -time;

      // Rain particles fall straight down and are randomly oriented
      // Snow particles have random sinusoid trajectories and are rotated to face the camera
      ${e.type===s.H.Rain?c.H`
            // Random rotation for particle
            vec3 rotationAxis = up;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));
            vec3 transformedPos = rotateVectorByQuaternion(vec3(0.2, 0.2, 4.0) * (position - vec3(0.5, 0.0, 0.5)), quat);

            // Rotate particle to planetary position
            rotationAxis = tangent;
            angle = 0.5 * -acos(dot(direction, up));
            quat = vec4(rotationAxis * sin(angle), cos(angle));
            transformedPos = rotateVectorByQuaternion(transformedPos, quat);

            vec4 pos = mat4(mat3(view)) * vec4(transformedPos + (mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * pos;
      `:c.H`
            vec3 rotationAxis = direction;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));

            tangent = rotateVectorByQuaternion(tangent, quat);
            // Random sinusoid from friction
            animatedPos += tangent * 0.25 * sin(dot(animatedPos, direction));
            vec4 pos = mat4(mat3(view)) * vec4((mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * (0.5 * vec4(position.xzy, 0.0) + pos);
      `}
  `),t.fragment.uniforms.add(new l.p("opacity",(e=>e.opacity)),new a.d("particleColor",(t=>function(e,t){const i=t.type===s.H.Rain?g:_,n=(0,r.g)(m,i,y),a=e.camera.eye;(0,r.n)(f,a);const o=Math.max(0,(0,r.e)(f,e.lighting.mainLight.direction));return(0,r.m)(n,n,i,o)}(t,e)))),t.fragment.main.add(c.H`
    float d = length(vUv - vec2(0.5));

    ${e.type===s.H.Rain?c.H`d = 0.35 * smoothstep(0.5, 0.0, d);`:c.H`d = smoothstep(0.5, 0.1, d);`}
    fragColor = opacity * vec4(particleColor * d, d);
  `),t}const m=(0,n.Ue)(),f=(0,n.Ue)(),_=(0,n.al)(1,1,1),g=(0,n.al)(.85,.85,.85),y=.7,v=Object.freeze(Object.defineProperty({__proto__:null,build:p},Symbol.toStringTag,{value:"Module"}))},86295:function(e,t,i){i.d(t,{C:function(){return y},R:function(){return C},a:function(){return v},b:function(){return b},c:function(){return w}});var r=i(82846),n=i(20350),s=i(94129),a=i(13887),o=i(99563),l=i(58226),c=i(13743),h=i(54231),u=i(19155),d=i(85119),p=i(39163),m=i(48857),f=i(20431),_=i(34709),g=i(15150);class y extends a.J{constructor(e,t,i,n,s,a){super(e,n,s),this.colormap=t,this.symbolizer=i,this.u_colormap=a,this.backgroundColor=r.AG,this.fboTexture=null,this.baseOpacity=1}}class v extends y{}class b extends y{}function w(e){const t=new g.kG;return t.include(l.T),t.include(a.G,e),t.include(s.i,e),t.include(o.J,e),t.fragment.code.add(m.H`vec4 applyBackgroundBlend(vec4 layerColor) {
return blendLayers(vuv, layerColor, u_opacity);
}`),e.colorizerType===n.U.Stretch?function(e,t){e.fragment.uniforms.add(new f._("u_bandCount",(e=>e.symbolizer.u_bandCount)),new p.O("u_minCutOff",(e=>e.symbolizer.u_minCutOff),3),new p.O("u_maxCutOff",(e=>e.symbolizer.u_maxCutOff),3),new p.O("u_factor",(e=>e.symbolizer.u_factor),3),new d.p("u_minOutput",(e=>e.symbolizer.u_minOutput)),new d.p("u_maxOutput",(e=>e.symbolizer.u_maxOutput)),new h.U("u_useGamma",(e=>e.symbolizer.u_useGamma)),new p.O("u_gamma",(e=>e.symbolizer.u_gamma),3),new p.O("u_gammaCorrection",(e=>e.symbolizer.u_gammaCorrection),3),new d.p("u_opacity",(e=>e.common.u_opacity))),e.fragment.code.add(m.H`float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {
if (val >= maxCutOff) {
return maxOutput;
} else if (val <= minCutOff) {
return minOutput;
}
float stretchedVal;
if (useGamma) {
float tempf = 1.0;
float outRange = maxOutput - minOutput;
float relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);
if (gamma > 1.0) {
tempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);
}
stretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;
} else {
stretchedVal = minOutput + (val - minCutOff) * factor;
}
return stretchedVal;
}`);const i=t.applyColormap?m.H`fragColor = applyBackgroundBlend(colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma));`:m.H`fragColor = applyBackgroundBlend(vec4(grayVal, grayVal, grayVal, currentPixel.a));`;e.fragment.main.add(m.H`
    vec2 pixelLocation = getPixelLocation(uv);
    if (isOutside(pixelLocation)) {
      fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
      return;
    }

    vec4 currentPixel = getPixel(pixelLocation);
    ${t.stretchType===n.H.Noop?m.H`fragColor = applyBackgroundBlend(currentPixel);`:m.H`
    if (currentPixel.a == 0.0) {
      fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
      return;
    }
    if (u_bandCount == 1) {
      float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
      ${i}
    } else {
      float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
      float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);
      float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);
      fragColor = applyBackgroundBlend(vec4(redVal, greenVal, blueVal, currentPixel.a));
    }`}`)}(t,e):e.colorizerType===n.U.Lut?function(e){e.fragment.main.add(m.H`vec2 pixelLocation = getPixelLocation(uv);
if (isOutside(pixelLocation)) {
fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
return;
}
vec4 currentPixel = getPixel(pixelLocation);
fragColor = applyBackgroundBlend(colormap(currentPixel, true));`)}(t):e.colorizerType===n.U.Hillshade&&function(e,t){const i=e.fragment;i.uniforms.add(new _.A("u_image",(e=>e.u_image)),new f._("u_hillshadeType",(e=>e.symbolizer.u_hillshadeType)),new p.O("u_sinZcosAs",(e=>e.symbolizer.u_sinZcosAs),6),new p.O("u_sinZsinAs",(e=>e.symbolizer.u_sinZsinAs),6),new p.O("u_cosZs",(e=>e.symbolizer.u_cosZs),6),new p.O("u_weights",(e=>e.symbolizer.u_weights),6),new u.A("u_factor",(e=>e.symbolizer.u_factor)),new d.p("u_minValue",(e=>e.symbolizer.u_minValue)),new d.p("u_maxValue",(e=>e.symbolizer.u_maxValue)),new u.A("u_srcImageSize",(e=>e.common.u_srcImageSize))),i.include(c.Y),i.code.add(m.H`vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {
val = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);
vec4 color = colormap(vec4(val, val, val, 1.0), false);
vec3 hsv = rgb2hsv(color.rgb);
hsv.z = hillshade;
return vec4(hsv2rgb(hsv), 1.0) * alpha * color.a;
}`),i.code.add(m.H`float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){
if (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {
return 0.0;
}  else {
return e;
}
}`);const r=t.applyColormap?m.H`fragColor = applyBackgroundBlend(overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha));`:m.H`hillshade *= alpha;
fragColor = applyBackgroundBlend(vec4(hillshade, hillshade, hillshade, alpha));`;i.main.add(m.H`
      vec2 pixelLocation = getPixelLocation(uv);
      if (isOutside(pixelLocation)) {
        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      vec4 currentPixel = getPixel(pixelLocation);
      if (currentPixel.a == 0.0) {
        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      //mirror edge pixels
      vec2 axy = vec2(-1.0, -1.0);
      vec2 bxy = vec2(0.0, -1.0);
      vec2 cxy = vec2(1.0, -1.0);
      vec2 dxy = vec2(-1.0, 0.0);
      vec2 fxy = vec2(1.0, 0.0);
      vec2 gxy = vec2(-1.0, 1.0);
      vec2 hxy = vec2(0.0, 1.0);
      vec2 ixy = vec2(1.0, 1.0);
      vec2 onePixel = 1.0 / u_srcImageSize;
      if (pixelLocation.s < onePixel.s) {
        axy[0] = 1.0;
        dxy[0] = 1.0;
        gxy[0] = 1.0;
      }
      if (pixelLocation.t < onePixel.t) {
        axy[1] = 1.0;
        bxy[1] = 1.0;
        cxy[1] = 1.0;
      }
      if (pixelLocation.s > 1.0 - onePixel.s) {
        cxy[0] = -1.0;
        fxy[0] = -1.0;
        ixy[0] = -1.0;
      }
      if (pixelLocation.t > 1.0 - onePixel.t) {
        gxy[1] = -1.0;
        hxy[1] = -1.0;
        ixy[1] = -1.0;
      }

      // calculate hillshade
      vec4 va = texture(u_image, pixelLocation + onePixel * axy);
      vec4 vb = texture(u_image, pixelLocation + onePixel * bxy);
      vec4 vc = texture(u_image, pixelLocation + onePixel * cxy);
      vec4 vd = texture(u_image, pixelLocation + onePixel * dxy);
      vec4 ve = texture(u_image, pixelLocation);
      vec4 vf = texture(u_image, pixelLocation + onePixel * fxy);
      vec4 vg = texture(u_image, pixelLocation + onePixel * gxy);
      vec4 vh = texture(u_image, pixelLocation + onePixel * hxy);
      vec4 vi = texture(u_image, pixelLocation + onePixel * ixy);

      // calculate the rate of z change along the x, y, and diagonal direction
      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;
      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;
      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);
      float hillshade = 0.0;

      // traditional single light source
      if (u_hillshadeType == 0){
        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;
        float z = (u_cosZs[0] + cosDelta) / dzd;
        if (z < 0.0)  z = 0.0;
        hillshade = z;
      } else {
        // multi-directional with 6 light sources
        for (int k = 0; k < 6; k++) {
        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;
        float z = (u_cosZs[k] + cosDelta) / dzd;
        if (z < 0.0) z = 0.0;
        hillshade = hillshade + z * u_weights[k];
        if (k == 5) break;
        }
      }

      // set color
      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);
      alpha *= u_opacity;
      ${r}`)}(t,e),t}const C=Object.freeze(Object.defineProperty({__proto__:null,ColorizerHillshadeUniforms:b,ColorizerStretchUniforms:v,ColorizerUniforms:y,build:w},Symbol.toStringTag,{value:"Module"}))},55244:function(e,t,i){i.d(t,{S:function(){return d},a:function(){return _},b:function(){return m}});var r=i(17904),n=i(5411),s=i(36351),a=i(48857),o=i(71063),l=i(11089),c=i(8069),h=i(80518),u=i(15150);const d=255,p=1/d;function m(e){const t=new u.kG,{fragment:i}=t;t.include(r.k),t.include(n.V),t.include(s.hb,f),i.uniforms.add(new l.j("shadowMap",(e=>e.shadowMap.depthTexture)),new o.e("depthMap",(e=>e.depth?.attachment))),i.constants.add("sampleValue","float",p);const c=e.index===h.j.CONTEXT?"vec2":"float";return t.outputs.add("sampleCount",c),i.main.add(a.H`
    sampleCount = ${c}(0.0);

    vec3 uvzShadow = calculateUVZShadowFromDepth(uv, textureSize(shadowMap,0), depthMap);
    if (uvzShadow.z < 0.0) {
      return;
    }

    // The shadow map sampler returns a value between 0 and 1, we take the midpoint as we count discrete samples
    bool shadow = readShadowMapUVZ(uvzShadow, shadowMap) > 0.5;

    if (shadow) {
      sampleCount = ${c}(sampleValue); // Add 1 to the sample count
    }
  `),t}const f=new c.T,_=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastMaxSamples:d,build:m},Symbol.toStringTag,{value:"Module"}))},33011:function(e,t,i){i.d(t,{S:function(){return l},b:function(){return o}});var r=i(17904),n=i(48857),s=i(80518),a=i(15150);function o(e){const t=new a.kG,{fragment:i}=t;t.include(r.k);const o=e.index===s.j.CONTEXT?"vec2":"float",l="value";return t.outputs.add(l,o),i.main.add(n.H`${l} = ${o}(0.0);`),t}const l=Object.freeze(Object.defineProperty({__proto__:null,build:o},Symbol.toStringTag,{value:"Module"}))},89145:function(e,t,i){i.d(t,{S:function(){return g},a:function(){return T},b:function(){return C}});var r=i(41788),n=i(27583),s=i(17904),a=i(34630),o=i(77983),l=i(19155),c=i(2013),h=i(85119),u=i(48857),d=i(34709),p=i(55244),m=i(65718),f=i(74826),_=i(15150);class g extends f.K{constructor(e){super(),this._data=e,this.sampleScale=(0,r.Ue)(),this.opacityFromElevation=1,this.gradientColor=(0,n.d9)(v),this.thresholdColor=(0,n.d9)(b),this.bandedGradientColor=(0,n.d9)(w),this.bandSize=.1,this.threshold=.5}get shadowCastMap(){return this._data.shadowCastTexture}}const y=50/255,v=(0,n.al)(0,0,1,.7),b=(0,n.al)(1,0,0,.7),w=(0,n.al)(y,y,y,.7);function C(e){const t=new _.kG,i=t.fragment;t.include(o.GZ),t.include(s.k);const{visualization:r}=e;i.constants.add("inverseSampleValue","float",p.S),i.uniforms.add(new d.A("shadowCastMap",(e=>e.shadowCastMap)),new l.A("sampleScale",(e=>e.sampleScale)),new h.p("opacityFromElevation",(e=>e.opacityFromElevation)));const n=r===m.w.Threshold,f=r===m.w.ThresholdAndGradient,g=r===m.w.BandedGradient;switch(f&&i.include(a.m),r){case m.w.Gradient:i.uniforms.add(new c.N("uColor",(e=>(0,a.p)(x,e.gradientColor))));break;case m.w.BandedGradient:i.uniforms.add(new c.N("uColor",(e=>(0,a.p)(x,e.bandedGradientColor))),new h.p("bandSize",(e=>e.bandSize)));break;case m.w.ThresholdAndGradient:i.uniforms.add(new c.N("uColor",(e=>(0,a.p)(x,e.thresholdColor))),new c.N("gradientColor",(e=>(0,a.p)(x,e.gradientColor))),new h.p("threshold",(e=>e.threshold)));break;case m.w.Threshold:i.uniforms.add(new c.N("uColor",(e=>(0,a.p)(x,e.thresholdColor))),new h.p("threshold",(e=>e.threshold)))}const{type:y,selector:v,thresholdStrengthSelector:b}=f?{type:"vec2",selector:"rg",thresholdStrengthSelector:"strength.x"}:{type:"float",selector:"r",thresholdStrengthSelector:"strength"};return i.main.add(u.H`
    ${y} numSamples = texture(shadowCastMap, uv).${v} * inverseSampleValue;

    fragColor = vec4(0.0);

    // early out if we do not have any samples in one or more channels
    if (dot(numSamples, ${y}(1)) < 1.0) {
      return;
    }

    // sampleScale is the number of total samples taken, so this brings strength to a 0-1 range.
    // note that sampleScale is always a vec2 even if we have only the primary channel.
    ${y} strength = numSamples * sampleScale.${v};

    // in threshold mode, step the strength to 0 if we are at or below the threshold, 1 otherwise.
    ${(0,u.If)(n||f,u.H`
      ${b} = 1.0 - step(${b}, threshold);
    `)}

    // bail out if we are below the threshold
    ${(0,u.If)(n,u.H`if (${b} == 0.0) { return; }`)}

    ${(0,u.If)(g,u.H`strength = ceil(strength / bandSize) * bandSize;`)}

    ${y} attenuation = opacityFromElevation * strength;

    // in ThresholdAndGradient mode we blend the threshold color on top of the gradient color
    fragColor = ${(0,u.If)(f,u.H`blendColorsPremultiplied(uColor * attenuation.r, gradientColor * attenuation.g)`,u.H`uColor * attenuation`)};
  `),t}const x=(0,n.Ue)(),T=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastVisualizePassParameters:g,build:C},Symbol.toStringTag,{value:"Module"}))},49790:function(e,t,i){i.d(t,{S:function(){return w},b:function(){return v}});var r=i(24910),n=i(82846),s=i(68593),a=i(17904),o=i(5411),l=i(73263),c=i(45701),h=i(87688),u=i(2013),d=i(85119),p=i(48857),m=i(71063),f=i(11089),_=i(29234),g=i(79262),y=i(15150);function v(){const e=new y.kG;e.include(o.V),e.include(l.v),e.include(a.k),e.include(s.R);const t=e.fragment;return t.include(c.n),t.uniforms.add(new f.j("shadowMapExcludingHighlight",(e=>e.shadowMap.getSnapshot(g.i.ExcludeHighlight))),new f.j("shadowMapHighlight",(e=>e.shadowMap.getSnapshot(g.i.Highlight))),new m.e("depthMap",(e=>e.depth?.attachment)),new _.T("highlightTexture",(e=>e.highlightTexture)),new u.N("uColor",(e=>e.shadowColor)),new d.p("opacity",(e=>e.shadowOpacity)),new d.p("occludedOpacity",(e=>e.occludedShadowOpacity)),new d.p("terminationFactor",(e=>e.opacityElevation*e.dayNightTerminator)),new h.d("lightingMainDirectionView",(({lighting:e,camera:t})=>(0,r.n)(b,(0,r.t)(b,e.mainLight.direction,t.viewInverseTransposeMatrix))))),t.main.add(p.H`
    ivec2 highlightTextureSize = textureSize(highlightTexture, 0);
    ivec2 highlightIUV = ivec2(uv * vec2(highlightTextureSize));
    uvec2 highlightInfo = texelFetch(highlightTexture, highlightIUV, 0).rg;

    fragColor = vec4(0.0);

    // Calculate bit mask to check if pixel is highlit unoccluded at any level
    uint ored = (highlightInfo.r << 0) | (highlightInfo.g << 8);

    bool visiblyHighlighted = ((ored & ~(ored >> 1)) & (1u+4u+16u+64u)) != 0u;
    if (visiblyHighlighted) {
      return;
    }

    vec4 currentPixelPos;
    vec3 uvzShadow = calculateUVZShadowAndPixelPosFromDepth(uv, textureSize(shadowMapHighlight,0), depthMap, currentPixelPos);
    if (uvzShadow.z < 0.0) {
      return;
    }

    float shadowHighlightFactor = readShadowMapUVZ(uvzShadow, shadowMapHighlight);
    if (shadowHighlightFactor == 0.0) {
      return;
    }

    float shadowExcludingHighlightFactor = readShadowMapUVZ(uvzShadow, shadowMapExcludingHighlight);

    vec3 normal = normalFromDepth(depthMap, currentPixelPos.xyz, gl_FragCoord.xy, uv);
    bool shaded = dot(normal, lightingMainDirectionView) < ${p.H.float(.025)};

    float occludedFactor = max(shadowExcludingHighlightFactor, shaded ? 1.0 : 0.0);
    float fragOpacity = mix(opacity, occludedOpacity, occludedFactor);
    fragColor = vec4(uColor.rgb, uColor.a * fragOpacity * terminationFactor);
  `),e}const b=(0,n.Ue)(),w=Object.freeze(Object.defineProperty({__proto__:null,build:v},Symbol.toStringTag,{value:"Module"}))},66696:function(e,t,i){i.d(t,{S:function(){return y},a:function(){return w},b:function(){return v},c:function(){return b}});var r=i(41788),n=i(82846),s=i(35286),a=i(2679),o=i(32179),l=i(19155),c=i(87688),h=i(9535),u=i(85119),d=i(48857),p=i(18489),m=i(34709),f=i(52061),_=i(74826),g=i(15150);class y extends _.K{constructor(){super(...arguments),this.texV=(0,r.Ue)(),this.altitudeFade=0,this.innerScale=0,this.undergroundFadeAlpha=0,this.silhouette=new v}}class v{constructor(){this.center=(0,n.Ue)(),this.v1=(0,n.Ue)(),this.v2=(0,n.Ue)()}}function b(e){const t=new g.kG,{vertex:i,fragment:r}=t;if((0,o.Pe)(i),e.geometry===s.n.Underground)t.attributes.add(f.T.POSITION,"vec2"),t.varyings.add("color","vec4"),i.uniforms.add(new c.d("cameraPosition",(e=>e.camera.eye)),new u.p("undergroundFadeAlpha",(e=>e.undergroundFadeAlpha))),i.main.add(d.H`float ndotl = dot(normalize(cameraPosition), mainLightDirection);
float lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));
color = vec4(vec3(lighting), undergroundFadeAlpha);
gl_Position = vec4(position.xy, 1.0, 1.0);`),r.main.add(d.H`fragColor = color;`);else{t.include(a.w,e),t.attributes.add(f.T.POSITION,"vec3"),t.varyings.add("vtc","vec2"),t.varyings.add("falloff","float");const n=e.geometry===s.n.Cylinder;i.uniforms.add(new p.C("proj",(e=>e.camera.projectionMatrix)),new p.C("view",(e=>e.camera.viewMatrix))),n||(t.varyings.add("innerFactor","float"),i.uniforms.add(new h.J("silCircleCenter",(e=>e.silhouette.center))),i.uniforms.add(new h.J("silCircleV1",(e=>e.silhouette.v1))),i.uniforms.add(new h.J("silCircleV2",(e=>e.silhouette.v2))),i.uniforms.add(new l.A("texV",(e=>e.texV))),i.uniforms.add(new u.p("innerScale",(e=>e.innerScale))));const o=6.2831853,c=1/128;i.main.add(d.H`
      ${n?d.H`
      vec3 pos = position;
      float ndotl = mainLightDirection.z;
      vtc = vec2(0.0, position.z + 0.05);`:d.H`
      innerFactor = clamp(-position.z, 0.0, 1.0);
      float scale = position.y * (1.0 + innerFactor * innerScale);
      float phi = position.x * ${d.H.float(o*c)} + 1.0;
      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;
      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), mainLightDirection);
      vtc.x = position.x  * ${d.H.float(c)};
      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;
      `}
      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

		  gl_Position = transformPosition(proj, view, pos);
		  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane
	  `),r.uniforms.add(new m.A("tex",(e=>e.texture))),n||r.uniforms.add(new u.p("altitudeFade",(e=>e.altitudeFade))),r.main.add(d.H`
			vec4 atmosphereColor = texture(tex, vtc) * falloff;
      ${n?d.H`fragColor = atmosphereColor;`:d.H`
			vec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);
			fragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));`}`)}return t}const w=Object.freeze(Object.defineProperty({__proto__:null,SilhouetteCircle:v,SimpleAtmospherePassParameters:y,build:b},Symbol.toStringTag,{value:"Module"}))},92515:function(e,t,i){i.d(t,{S:function(){return p},b:function(){return u}});var r=i(31865),n=i(10934),s=i(23027),a=i(13663),o=i(48857),l=i(95334),c=i(52061),h=i(15150);function u(){const e=new h.kG;return e.attributes.add(c.T.POSITION,"vec3"),e.attributes.add(c.T.COLOR,"vec4"),e.attributes.add(c.T.SIZE,"float"),e.varyings.add("vcolor","vec4"),e.varyings.add("vsize","float"),e.vertex.uniforms.add(new l.g("transform",((e,t)=>function(e,t){const i=24e-8;return(0,r.JG)(d,t.camera.projectionMatrix),d[10]=i-1,d[11]=-1,d[14]=(i-2)*t.camera.near,(0,r.Jp)(d,d,t.camera.viewMatrix),(0,r.Jp)(d,d,e.modelMatrix)}(e,t))),new s.$("viewport",(e=>e.camera.fullViewport)),new a.z("pixelRatio",(e=>e.camera.pixelRatio))),e.vertex.main.add(o.H`gl_Position = transform * vec4(position, 0);
vcolor = color / 1.2;
vsize = size * 5.0 * pixelRatio;
gl_PointSize = vsize;`),e.fragment.main.add(o.H`float cap = 0.7;
float scale = 1.0 / cap;
float helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);
float alpha = clamp((cap - helper) * scale, 0.0, 1.0);
float intensity = alpha * alpha * alpha;
if (vsize < 3.0) {
intensity *= 0.5;
}
fragColor = vec4(vcolor.xyz, intensity);`),e}const d=(0,n.Ue)(),p=Object.freeze(Object.defineProperty({__proto__:null,build:u},Symbol.toStringTag,{value:"Module"}))},69069:function(e,t,i){i.d(t,{S:function(){return E}});var r=Math.PI,n=Math.sin,s=Math.cos,a=Math.tan,o=Math.asin,l=Math.atan2,c=Math.acos,h=r/180,u=864e5,d=2440588,p=2451545,m={dec:0,ra:0};function f(e){return new Date((e+.5-d)*u)}function _(e){return function(e){return e.valueOf()/u-.5+d}(e)-p}var g=23.4397*h;function y(e,t){return l(n(e)*s(g)-a(t)*n(g),s(e))}function v(e,t){return o(n(t)*s(g)+s(t)*n(g)*n(e))}function b(e,t,i){return l(n(e),s(e)*n(t)-a(i)*s(t))}function w(e,t,i){return o(n(t)*n(i)+s(t)*s(i)*s(e))}function C(e,t){return h*(280.16+360.9856235*e)-t}function x(e){return h*(357.5291+.98560028*e)}function T(e){return h*(1.9148*n(e)+.02*n(2*e)+3e-4*n(3*e))}function S(e,t){return e+t+102.9372*h+r}function M(e,t){var i=x(e),r=S(i,T(i));return t||(t={dec:0,ra:0}),t.dec=v(r,0),t.ra=y(r,0),t}var E={PolarException:{NORMAL:0,MIDNIGHT_SUN:1,POLAR_NIGHT:2},getPosition:function(e,t,i,r){var n=h*-i,s=h*t,a=_(e),o=M(a,m),l=C(a,n)-o.ra;return r||(r={azimuth:0,altitude:0}),r.azimuth=b(l,s,o.dec),r.altitude=w(l,s,o.dec),r}},P=[[-.83,"sunrise","sunset"]];E.addTime=function(e,t,i){P.push([e,t,i])};var R=9e-4;function A(e,t){return Math.round(e-R-t/(2*r))}function O(e,t,i){return R+(e+t)/(2*r)+i}function D(e,t,i){return p+e+.0053*n(t)-.0069*n(2*i)}function I(e,t,i){return c((n(e)-n(t)*n(i))/(s(t)*s(i)))}function L(e){var t=h*(134.963+13.064993*e),i=h*(93.272+13.22935*e),r=h*(218.316+13.176396*e)+6.289*h*n(t),a=5.128*h*n(i),o=385001-20905*s(t);return{ra:y(r,a),dec:v(r,a),dist:o}}E.getTimes=function(e,t,i){var r=h*-i,a=h*t,o=A(_(e),r),l=O(0,r,o),c=x(l),u=T(c),d=S(c,u),p=v(d,0),m=D(l,c,d);function g(e){return D(O(I(e,a,p),r,o),c,d)}var y,b,w,C,M,R={solarNoon:f(m),nadir:f(m-.5),polarException:E.PolarException.NORMAL};for(y=0,b=P.length;y<b;y+=1)M=m-((C=g((w=P[y])[0]*h))-m),R[w[1]]=f(M),R[w[2]]=f(C);return R.polarException=function(e){var t=(n(e)-n(a)*n(p))/(s(a)*s(p));return t<-1?E.PolarException.MIDNIGHT_SUN:t>1?E.PolarException.POLAR_NIGHT:E.PolarException.NORMAL}(P[0][0]*h),R},E.getMoonPosition=function(e,t,i){var r=h*-i,n=h*t,s=_(e),o=L(s),l=C(s,r)-o.ra,c=w(l,n,o.dec);return c+=.017*h/a(c+10.26*h/(c+5.1*h)),{azimuth:b(l,n,o.dec),altitude:c,distance:o.dist}},E.getMoonFraction=function(e){var t=_(e),i=M(t),r=L(t),a=149598e3,o=c(n(i.dec)*n(r.dec)+s(i.dec)*s(r.dec)*s(i.ra-r.ra)),h=l(a*n(o),r.dist-a*s(o));return(1+s(h))/2}},91708:function(e,t,i){i.d(t,{T:function(){return N},a:function(){return k},b:function(){return F}});var r=i(31865),n=i(10934),s=i(24910),a=i(82846),o=i(61796),l=i(9779),c=i(70662),h=i(41044),u=i(27349),d=i(2679),p=i(57716),m=i(31839),f=i(82630),_=i(37452),g=i(40122),y=i(24807),v=i(11713),b=i(19065),w=i(32179),C=i(13212),x=i(42510),T=i(36351),S=i(76144),M=i(6397),E=i(96541),P=i(87688),R=i(48857),A=i(10146),O=i(71063),D=i(52061),I=i(15150),L=i(64801);class N extends M.uS{}function F(e){const t=new I.kG,{attributes:i,vertex:n,fragment:a,varyings:N}=t;i.add(D.T.POSITION,"vec3"),t.include(p.O,e),t.include(m.D,e);const F=()=>{t.include(C.n,e),n.code.add(R.H`vec3 getNormal() {
float z = 1.0 - abs(normalCompressed.x) - abs(normalCompressed.y);
vec3 n = vec3(normalCompressed + vec2(normalCompressed.x >= 0.0 ? 1.0 : -1.0,
normalCompressed.y >= 0.0 ? 1.0 : -1.0) * min(z, 0.0), z);
return normalize(n);
}`)};(0,E.Sv)(n,e),t.include(d.w,e);const{output:k,pbrMode:V,overlayMode:B,tileBorders:z,spherical:G,transparencyMode:q,screenSizePerspective:Z,overlayEnabled:j}=e,W=q===l.w.InvisibleWithDraped||q===l.w.Invisible,$=j&&W;switch(k){case h.H_.ColorEmission:case h.H_.Color:{t.include(M.EK,e),t.include(b.XP,e),j&&(e.pbrMode=V===x.f7.Simplified?x.f7.TerrainWithWater:x.f7.Water,t.include(S.yl,e),e.pbrMode=V);const i=B===S.gT.EnabledWithWater;i&&t.include(f.M,e),N.add("vnormal","vec3"),N.add("vpos","vec3",{invariant:!0}),N.add("vup","vec3"),F(),Z&&(0,E._8)(n);const l=e.receiveShadows&&!e.renderOccluded;l&&t.include(c.qj,e),Z&&(N.add("screenSizeDistanceToCamera","float"),N.add("screenSizeCosAngle","float")),n.main.add(R.H`
          vpos = position;
          vec3 positionWorld = position + localOrigin;
          gl_Position = transformPosition(proj, view, vpos);
          vnormal = getNormal();
          vup = getLocalUp(position, localOrigin);
          ${(0,R.If)(i,R.H`forwardVertexTangent(vnormal);`)}

          forwardTextureCoordinatesWithTransform(uv0);
          ${(0,R.If)(j,"setOverlayVTC(uv0);")}
          ${(0,R.If)(z,"forwardTextureCoordinates();")}
          ${(0,R.If)(Z,R.H`vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;
                 screenSizeDistanceToCamera = length(viewPos);
                 vec3 viewSpaceNormal = (viewNormal * vec4(normalize(positionWorld), 1.0)).xyz;
                 screenSizeCosAngle = abs(viewSpaceNormal.z);`)}
          ${(0,R.If)(l,"forwardLinearDepth();")}`),a.include(u.f5,e),t.include(b.XP,e),a.include(v.K,e),t.include(T.XE,e),(0,E.hY)(a,e),(0,b.PN)(a),(0,b.sC)(a),a.uniforms.add(n.uniforms.get("localOrigin"),new P.d("viewDirection",(({camera:e})=>(0,s.n)(H,(0,s.i)(H,e.viewMatrix[12],e.viewMatrix[13],e.viewMatrix[14]))))),i&&a.uniforms.add(new O.e("ovWaterTex",(e=>e.overlay?.getTexture(o.D.WaterNormal))),new A.K("view",(({origin:e},{camera:t})=>(0,r.Iu)(U,t.viewMatrix,e))));const h=.2;a.code.add(R.H`float lum(vec3 c) {
return (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;
}`),(0,w.Pe)(a),(0,w.F1)(a),a.main.add(R.H`
          vec3 normal = normalize(vnormal);
          float vndl = dot(normal, mainLightDirection);

          float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl*2.5, 0.0, 1.0));
          float shadow = ${l?"max(lightingGlobalFactor * (1.0 - additionalAmbientScale), readShadowMap(vpos, linearDepth))":G?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0"};

          float ssao = evaluateAmbientOcclusionInverse();
          vec4 tileColor = getTileColor();

          ${(0,R.If)(j,R.H`vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
                   vec4 overlayColor = overlayOpacity * overlayColorOpaque;
                   ${(0,R.If)(W,`if (overlayColor.a < ${R.H.float(L.e)}) { discard; }`)}
                   vec4 groundColor = tileColor;
                   tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;`)}

          // If combined alpha is 0 we can discard pixel. The performance impact by having a discard here
          // is neglectable because terrain typically renders first into the framebuffer.
          if(tileColor.a < ${R.H.float(L.e)}) {
            discard;
          }

          bool sliced = rejectBySlice(vpos);
          if (sliced) {
            tileColor *= ${R.H.float(h)};
          }

          vec3 albedo = tileColor.rgb;

          // heuristic shading function used in the old terrain, now used to add ambient lighting

          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

          ${V===x.f7.Simplified||V===x.f7.TerrainWithWater?R.H`fragColor = vec4(evaluatePBRSimplifiedLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight, normalize(vpos - cameraPosition), vup), tileColor.a);`:R.H`fragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);`}
          ${(0,R.If)(i,R.H`vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);
                   float waterNormalLength = length(overlayWaterMask);
                   if (waterNormalLength > 0.95) {
                     mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);
                     vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);
                     vec4 viewPosition = view*vec4(vpos, 1.0);
                     vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - cameraPosition), shadow, vnormal, tbnMatrix, viewPosition.xyz,  vpos + localOrigin);
                     vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                     float opacity = sliced ? ${R.H.float(h)} : 1.0;
                     // un-gamma the ground color to mix in linear space
                     fragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w) * opacity;
                   }`)}
          ${(0,R.If)(Z,R.H`float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, vec4(0.0));
                   if (perspectiveScale <= 0.25) {
                     fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);
                   } else if (perspectiveScale <= 0.5) {
                     fragColor = mix(fragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);
                   } else if (perspectiveScale >= 0.99) {
                     fragColor = mix(fragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);
                   } else {
                     fragColor = mix(fragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);
                   }`)}
          ${(0,R.If)(e.visualizeNormals,G?R.H`
                  vec3 localUp = normalize(vpos + localOrigin);
                  vec3 right = normalize(cross(vec3(0.0, 0.0, 1.0), localUp));
                  vec3 forward = normalize(cross(localUp, right));
                  mat3 tbn = mat3(right, forward, localUp);
                  vec3 tNormal = normalize(normal * tbn);
                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);`:R.H`
                  vec3 tNormal = normalize(normal);
                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);`)}
          ${(0,R.If)(z,R.H`vec2 dVuv = fwidth(vuv0);
                 vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv0, 1.0 - vuv0));
                 float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);
                 fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);`)}
          fragColor = applySlice(fragColor, vpos);`)}break;case h.H_.Depth:$&&t.include(S.yl,e),n.main.add(R.H`
        ${(0,R.If)($,"setOverlayVTC(uv0);")}
        gl_Position = transformPosition(proj, view, position);`),a.main.add(`${(0,R.If)($,`if (getCombinedOverlayColor().a < ${R.H.float(L.e)}) discard;`)}`);break;case h.H_.Shadow:case h.H_.ShadowHighlight:case h.H_.ShadowExcludeHighlight:case h.H_.ViewshedShadow:t.include(_.F,e),(0,c.Lm)(t),(0,c.Zu)(t),n.main.add(R.H`gl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);`),a.main.add(R.H`outputDepth(linearDepth);`);break;case h.H_.Normal:$&&t.include(S.yl,e),N.add("vnormal","vec3"),(0,E._8)(n),F(),n.main.add(R.H`
        ${(0,R.If)($,"setOverlayVTC(uv0);")}
        gl_Position = transformPosition(proj, view, position);
        vnormal = normalize((viewNormal * vec4(getNormal(), 1.0)).xyz);`),a.main.add(R.H`
        ${(0,R.If)($,`if (getCombinedOverlayColor().a < ${R.H.float(L.e)}) discard;`)}
        vec3 normal = normalize(vnormal);
        if (gl_FrontFacing == false) {
          normal = -normal;
        }
        fragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);`);break;case h.H_.Highlight:j&&(t.include(S.yl,e),t.include(y._,e)),n.main.add(R.H`
        ${(0,R.If)(j,"setOverlayVTC(uv0);")}
        gl_Position = transformPosition(proj, view, position);`),t.include(g.b,e),a.main.add(R.H`
        ${(0,R.If)(j,R.H`
           calculateOcclusionAndOutputHighlight(getAllOverlayHighlightValuesEncoded());`,"calculateOcclusionAndOutputHighlight();")}
      `)}if(k===h.H_.ObjectAndLayerIdColor)if(j)e.pbrMode=x.f7.Disabled,t.include(S.yl,e),e.pbrMode=V,n.main.add(R.H`gl_Position = transformPosition(proj, view, position);
setOverlayVTC(uv0);`),a.main.add(R.H`fragColor = getOverlayColorTexel();`);else{const e=q===l.w.Opaque;n.main.add(R.H`${(0,R.If)(e,"gl_Position = transformPosition(proj, view, position);")}`),a.main.add(R.H`fragColor = vec4(0.0);`)}return t}const U=(0,n.Ue)(),H=(0,a.Ue)(),k=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:N,build:F},Symbol.toStringTag,{value:"Module"}))},32222:function(e,t,i){function r(e,t,i=3,r=i){const n=t.length/r;let s=0,a=0;for(let o=0;o<n;++o)e[s]=t[a],e[s+1]=t[a+1],e[s+2]=t[a+2],s+=i,a+=r}function n(e,t,i,r,n){const s=e.typedBuffer,a=e.typedBufferStride,o=n?.count??e.count;let l=(n?.dstIndex??0)*a;for(let e=0;e<o;++e)s[l]=t,s[l+1]=i,s[l+2]=r,l+=a}i.d(t,{c:function(){return r},f:function(){return n}});Object.freeze(Object.defineProperty({__proto__:null,copy:r,copyView:function(e,t){r(e.typedBuffer,t.typedBuffer,e.typedBufferStride,t.typedBufferStride)},fill:n},Symbol.toStringTag,{value:"Module"}))},46965:function(e,t,i){var r;i.d(t,{Y:function(){return r}}),function(e){e[e.KILOBYTES=1024]="KILOBYTES",e[e.MEGABYTES=1048576]="MEGABYTES",e[e.GIGABYTES=1073741824]="GIGABYTES"}(r||(r={}))},63727:function(e,t,i){i.d(t,{Z:function(){return c}});var r=i(73440),n=i(43254),s=i(90403),a=i(17155),o=i(48023),l=i(21260);let c=class extends n.Z{constructor(e){super(e),this.getCollections=null}initialize(){this.addHandles((0,l.EH)((()=>this._refresh()),s.Z_))}destroy(){this.getCollections=null}_refresh(){const e=null!=this.getCollections?this.getCollections():null;if(null==e)return void this.removeAll();let t=0;for(const i of e)null!=i&&(t=this._processCollection(t,i));this.splice(t)}_createNewInstance(e){return new n.Z(e)}_processCollection(e,t){if(!t)return e;const i=this.itemFilterFunction??(e=>!!e);for(const r of t)if(r){if(i(r)){const t=this.indexOf(r,e);t>=0?t!==e&&this.reorder(r,e):this.add(r,e),++e}if(this.getChildrenFunction){const t=this.getChildrenFunction(r);if(Array.isArray(t))for(const i of t)e=this._processCollection(e,i);else e=this._processCollection(e,t)}}return e}};(0,r._)([(0,a.Cb)()],c.prototype,"getCollections",void 0),(0,r._)([(0,a.Cb)()],c.prototype,"getChildrenFunction",void 0),(0,r._)([(0,a.Cb)()],c.prototype,"itemFilterFunction",void 0),c=(0,r._)([(0,o.j)("esri.core.CollectionFlattener")],c)},95437:function(e,t,i){i.d(t,{BV:function(){return c},Q4:function(){return l},c5:function(){return o},pE:function(){return n}});var r=i(99574);class n{constructor(e,t){this.min=e,this.max=t,this.range=t-e}normalize(e,t=0,i=!1){return s(this.range,this.min,this.max,e,t,i)}clamp(e,t=0){return(0,r.uZ)(e-t,this.min,this.max)+t}monotonic(e,t,i){return e<t?t:t+a(this.range,e-t,i)}minimalMonotonic(e,t,i){return s(this.range,e,e+this.range,t,i)}center(e,t,i){return t=this.monotonic(e,t,i),this.normalize((e+t)/2,i)}diff(e,t,i){return this.monotonic(e,t,i)-e}shortestSignedDiff(e,t){e=this.normalize(e);const i=(t=this.normalize(t))-e,r=t<e?this.minimalMonotonic(e,t)-e:t-this.minimalMonotonic(t,e);return Math.abs(i)<Math.abs(r)?i:r}contains(e,t,i){return t=this.minimalMonotonic(e,t),(i=this.minimalMonotonic(e,i))>e&&i<t}}function s(e,t,i,r,n=0,s=!1){return(r-=n)<t?r+=a(e,t-r):r>i&&(r-=a(e,r-i)),s&&r===i&&(r=t),r+n}function a(e,t,i=0){return Math.ceil((t-i)/e)*e+i}const o=new n(0,2*Math.PI),l=new n(-Math.PI,Math.PI),c=new n(0,360)},87422:function(e,t,i){i.d(t,{Z:function(){return s}});var r=i(53227),n=i(18002);class s{constructor(e){this._observable=new n.s,this._map=new Map(e)}get size(){return(0,r.it)(this._observable),this._map.size}clear(){this._map.size>0&&(this._map.clear(),this._observable.notify())}delete(e){const t=this._map.delete(e);return t&&this._observable.notify(),t}entries(){return(0,r.it)(this._observable),this._map.entries()}forEach(e,t){(0,r.it)(this._observable),this._map.forEach(((i,r)=>e.call(t,i,r,this)),t)}get(e){return(0,r.it)(this._observable),this._map.get(e)}has(e){return(0,r.it)(this._observable),this._map.has(e)}keys(){return(0,r.it)(this._observable),this._map.keys()}set(e,t){return this._map.set(e,t),this._observable.notify(),this}values(){return(0,r.it)(this._observable),this._map.values()}[Symbol.iterator](){return(0,r.it)(this._observable),this._map[Symbol.iterator]()}[Symbol.dispose](){this._observable.destroy()}get[Symbol.toStringTag](){return this._map[Symbol.toStringTag]}}},12019:function(e,t,i){i.d(t,{n:function(){return n}});var r=i(81001);const n=()=>r.default.respectPrefersReducedMotion&&window.matchMedia("(prefers-reduced-motion: reduce)").matches},75432:function(e,t,i){i.d(t,{B:function(){return p}});var r=i(88194),n=i(29328),s=i(9713),a=i(95490),o=i(18764),l=i(15853),c=i(66951),h=i(17155),u=i(84753),d=i(28938);function p(e){const t=e?.origins??[void 0];return(i,r)=>{const n=function(e,t,i){if("resource"===e?.type)return function(e,t,i){const r=(0,l.Oe)(t,i);return{type:String,read:(e,t,i)=>{const n=(0,d.r)(e,t,i);return r.type===String?n:"function"==typeof r.type?new r.type({url:n}):void 0},write:{isRequired:r.json?.write?.isRequired,writer(t,n,o,l){if(!l?.resources)return"string"==typeof t?void(n[o]=(0,d.t)(t,l)):void(n[o]=t.write({},l));const h=function(e){return null==e?null:"string"==typeof e?e:e.url}(t),p=(0,d.t)(h,{...l,verifyItemRelativeUrls:l?.verifyItemRelativeUrls?{writtenUrls:l.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},d.M.NO),g=r.type!==String&&(!(0,s.l)(this)||l?.origin&&this.originIdOf(i)>(0,c.M9)(l.origin)),y={object:this,propertyName:i,value:t,targetUrl:p,dest:n,targetPropertyName:o,context:l,params:e};l?.portalItem&&p&&!(0,a.YP)(p)?g&&e?.contentAddressed?m(y):g?function(e){const{context:t,targetUrl:i,params:r,value:n,dest:s,targetPropertyName:o}=e;if(!t.portalItem)return;const l=t.portalItem.resourceFromPath(i),c=_(n,i,t),h=(0,u.B)(c),d=(0,a.Ml)(l.path),p=r?.compress??!1;h===d?(t.resources&&f({...e,resource:l,content:c,compress:p,updates:t.resources.toUpdate}),s[o]=i):m(e)}(y):function({context:e,targetUrl:t,dest:i,targetPropertyName:r}){e.portalItem&&e.resources&&(e.resources.toKeep.push({resource:e.portalItem.resourceFromPath(t),compress:!1}),i[r]=t)}(y):l?.portalItem&&(null==p||null!=(0,d.i)(p)||(0,a.jc)(p)||g)?m(y):n[o]=p}}}}(e,t,i);switch(e?.type??"other"){case"other":return{read:!0,write:!0};case"url":{const{read:e,write:t}=d.b;return{read:e,write:t}}}}(e,i,r);for(const e of t){const t=(0,h.CJ)(i,e,r);for(const e in n)t[e]=n[e]}}}function m(e){const{targetUrl:t,params:i,value:s,context:l,dest:c,targetPropertyName:h}=e;if(!l.portalItem)return;const p=(0,d.p)(t),m=_(s,t,l);if(i?.contentAddressed&&"json"!==m.type)return void l.messages?.push(new r.Z("persistable:contentAddressingUnsupported",`Property "${h}" is trying to serializing a resource with content of type ${m.type} with content addressing. Content addressing is only supported for json resources.`,{content:m}));const g=i?.contentAddressed&&"json"===m.type?(0,n.F)(m.jsonString):p?.filename??(0,o.DO)(),y=(0,a.v_)(i?.prefix??p?.prefix,g),v=`${y}.${(0,u.B)(m)}`;if(i?.contentAddressed&&l.resources&&"json"===m.type){const e=l.resources.toKeep.find((({resource:e})=>e.path===v))??l.resources.toAdd.find((({resource:e})=>e.path===v));if(e)return void(c[h]=e.resource.itemRelativeUrl)}const b=l.portalItem.resourceFromPath(v);(0,a.jc)(t)&&l.resources&&l.resources.pendingOperations.push((0,a.gi)(t).then((e=>{b.path=`${y}.${(0,u.B)({type:"blob",blob:e})}`,c[h]=b.itemRelativeUrl})).catch((()=>{})));const w=i?.compress??!1;l.resources&&f({...e,resource:b,content:m,compress:w,updates:l.resources.toAdd}),c[h]=b.itemRelativeUrl}function f({object:e,propertyName:t,updates:i,resource:r,content:n,compress:s}){i.push({resource:r,content:n,compress:s,finish:i=>{!function(e,t,i){"string"==typeof e[t]?e[t]=i.url:e[t].url=i.url}(e,t,i)}})}function _(e,t,i){return"string"==typeof e?{type:"url",url:t}:{type:"json",jsonString:JSON.stringify(e.toJSON(i))}}},92643:function(e,t,i){i.d(t,{Ch:function(){return k},EX:function(){return E},G:function(){return O},H0:function(){return V},Ht:function(){return N},K6:function(){return P},O:function(){return I},WC:function(){return L},Y3:function(){return T},_Y:function(){return x},_j:function(){return A},c9:function(){return U},gp:function(){return F},jQ:function(){return c},mj:function(){return R},nR:function(){return H},sJ:function(){return S},vG:function(){return D},xr:function(){return C}});var r=i(53147),n=i(3480),s=i(28947),a=i(99574),o=i(73749),l=i(27583);function c(e){return"r"in e&&"g"in e&&"b"in e}function h(e){return"h"in e&&"s"in e&&"v"in e}function u(e){return"l"in e&&"a"in e&&"b"in e}function d(e){return"l"in e&&"c"in e&&"h"in e}const p=[[.4124,.3576,.1805],[.2126,.7152,.0722],[.0193,.1192,.9505]],m=[[3.2406,-1.5372,-.4986],[-.9689,1.8758,.0415],[.0557,-.204,1.057]];function f(e,t){const i=[];let r,n;if(e[0].length!==t.length)throw new Error("dimensions do not match");const s=e.length,a=e[0].length;let o=0;for(r=0;r<s;r++){for(o=0,n=0;n<a;n++)o+=e[r][n]*t[n];i.push(o)}return i}function _(e){const t=[e.r/255,e.g/255,e.b/255].map((e=>e<=.04045?e/12.92:((e+.055)/1.055)**2.4)),i=f(p,t);return{x:100*i[0],y:100*i[1],z:100*i[2]}}function g(e){const t=f(m,[e.x/100,e.y/100,e.z/100]).map((e=>{const t=e<=.0031308?12.92*e:1.055*e**(1/2.4)-.055;return Math.min(1,Math.max(t,0))}));return{r:Math.round(255*t[0]),g:Math.round(255*t[1]),b:Math.round(255*t[2])}}function y(e){const t=[e.x/95.047,e.y/100,e.z/108.883].map((e=>e>(6/29)**3?e**(1/3):1/3*(29/6)**2*e+4/29));return{l:116*t[1]-16,a:500*(t[0]-t[1]),b:200*(t[1]-t[2])}}function v(e){const t=e.l,i=[(t+16)/116+e.a/500,(t+16)/116,(t+16)/116-e.b/200].map((e=>e>6/29?e**3:3*(6/29)**2*(e-4/29)));return{x:95.047*i[0],y:100*i[1],z:108.883*i[2]}}function b(e){return function(e){const t=e.l,i=e.a,r=e.b,n=Math.sqrt(i*i+r*r);let s=Math.atan2(r,i);return s=s>0?s:s+2*Math.PI,{l:t,c:n,h:s}}(y(_(e)))}function w(e){return g(v(function(e){const t=e.l,i=e.c,r=e.h;return{l:t,a:i*Math.cos(r),b:i*Math.sin(r)}}(e)))}function C(e){return c(e)?e:d(e)?w(e):u(e)?function(e){return g(v(e))}(e):function(e){return"x"in e&&"y"in e&&"z"in e}(e)?g(e):h(e)?function(e){const t=(e.h+360)%360/60,i=e.s/100,r=e.v/100*255,n=r*i,s=n*(1-Math.abs(t%2-1));let a;switch(Math.floor(t)){case 0:a={r:n,g:s,b:0};break;case 1:a={r:s,g:n,b:0};break;case 2:a={r:0,g:n,b:s};break;case 3:a={r:0,g:s,b:n};break;case 4:a={r:s,g:0,b:n};break;case 5:case 6:a={r:n,g:0,b:s};break;default:a={r:0,g:0,b:0}}return a.r=Math.round(a.r+r-n),a.g=Math.round(a.g+r-n),a.b=Math.round(a.b+r-n),a}(e):e}function x(e){return h(e)?e:function(e){const t=e.r,i=e.g,r=e.b,n=Math.max(t,i,r),s=n-Math.min(t,i,r);let a=n,o=0===s?0:n===t?(i-r)/s%6:n===i?(r-t)/s+2:(t-i)/s+4,l=0===s?0:s/a;return o<0&&(o+=6),o*=60,l*=100,a*=100/255,{h:o,s:l,v:a}}(C(e))}function T(e){return u(e)?e:function(e){return y(_(e))}(C(e))}function S(e){return d(e)?e:b(C(e))}function M(e){let{r:t,g:i,b:n,a:s}=e;return s<1&&(t=Math.round(s*t+255*(1-s)),i=Math.round(s*i+255*(1-s)),n=Math.round(s*n+255*(1-s))),new r.Z({r:t,g:i,b:n})}function E(e,t){const{r:i,g:r,b:n}=t?.ignoreAlpha?e:M(e);return.2126*i+.7152*r+.0722*n}var P;function R(e,t=P.High){return E(e,{ignoreAlpha:!0})>t?new r.Z([0,0,0,e.a]):new r.Z([255,255,255,e.a])}function A(e,t){const i=T(e);i.l*=1-t;const r=C(i),n=e.clone();return n.setColor(r),n.a=e.a,n}function O(e,t){const i=e.clone();return i.a*=t,i}function D(e,t){const i=x(e);i.s*=t;const r=C(i),n=e.clone();return n.setColor(r),n.a=e.a,n}function I(e){return r.Z.toUnitRGBA(e)}function L(e,t){return e===t||null!=e&&e.equals(t)}function N(e,t){return e===t||null!=e&&null!=t&&(0,o.e)(e,t)}function F(e){return(0,l.al)(e[0],e[1],e[2],e.length>3?e[3]:1)}function U(e){return e[0]??=0,e[1]??=0,e[2]??=0,e}function H(e){return e.length=4,U(e),e[3]??=1,(0,a.uZ)(e[3],0,1),e}function k(e,t){const i=r.Z.toUnitRGBA(e);return i[3]*=t,i}function V(e,t,i={}){if(0===e.length||t<=0)return[];if(1===(e=e.map((e=>"string"==typeof e?new r.Z(e):e))).length||1===t){const i=[],r=e[0];for(let e=0;e<t;e++)i.push(r.clone());return i}if(i.shuffle&&(e=(0,n.TV)((0,s.d9)(e),i.seed)),e.length>=t){const i=[],r=(e.length-1)/(t-1);for(let n=0;n<t;n++){const t=Math.round(n*r);i.push(e[t].clone())}return i}return function(e,t,i={}){const r=[],s=e.length-1,a=Math.ceil((t-e.length)/s);e:for(let n=0;n<s;n++){const s=e[n],o=e[n+1];for(let n=1;n<=a;n++){const l=n/(a+1);if(r.push(z(s,o,l,i)),r.length+e.length===t)break e}}return[...e.map((e=>e.clone())),...(0,n.TV)(r,i.seed??1)]}(e,t,i)}!function(e){e[e.Low=160]="Low",e[e.High=225]="High"}(P||(P={}));const B=(e,t)=>{const i=Math.floor(10*t())-5;return Math.min(255,Math.max(0,e+i))};function z(e,t,i,s={}){const a=e.r,o=e.g,l=e.b,c=t.r,h=t.g,u=t.b,d=Math.round(a+(c-a)*i),p=Math.round(o+(h-o)*i),m=Math.round(l+(u-l)*i);if(!s.offset)return new r.Z([d,p,m]);const f=(0,n.FS)(s.seed);return new r.Z([B(d,f),B(p,f),B(m,f)])}},11034:function(e,t,i){function r(){const e=new Float32Array(9);return e[0]=1,e[4]=1,e[8]=1,e}function n(e){const t=new Float32Array(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}function s(e,t,i,r,n,s,a,o,l){const c=new Float32Array(9);return c[0]=e,c[1]=t,c[2]=i,c[3]=r,c[4]=n,c[5]=s,c[6]=a,c[7]=o,c[8]=l,c}i.d(t,{Ue:function(){return r},al:function(){return s},d9:function(){return n}});Object.freeze(Object.defineProperty({__proto__:null,clone:n,create:r,fromValues:s},Symbol.toStringTag,{value:"Module"}))},43280:function(e,t,i){function r(){return new Float32Array(4)}function n(e){const t=new Float32Array(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function s(e,t,i,r){const n=new Float32Array(4);return n[0]=e,n[1]=t,n[2]=i,n[3]=r,n}function a(){return r()}function o(){return s(1,1,1,1)}function l(){return s(1,0,0,0)}function c(){return s(0,1,0,0)}function h(){return s(0,0,1,0)}function u(){return s(0,0,0,1)}i.d(t,{AG:function(){return d},al:function(){return s},d9:function(){return n}});const d=a(),p=o(),m=l(),f=c(),_=h(),g=u();Object.freeze(Object.defineProperty({__proto__:null,ONES:p,UNIT_W:g,UNIT_X:m,UNIT_Y:f,UNIT_Z:_,ZEROS:d,clone:n,create:r,fromValues:s,ones:o,unitW:u,unitX:l,unitY:c,unitZ:h,zeros:a},Symbol.toStringTag,{value:"Module"}))},332:function(e,t,i){i.d(t,{G:function(){return a},w:function(){return o}});var r=i(29292),n=i(43254),s=i(97006);async function a(e,t){return await e.load(),o(e,t)}async function o(e,t){const i=[],a=(...e)=>{for(const t of e)null!=t&&(Array.isArray(t)?a(...t):n.Z.isCollection(t)?t.forEach((e=>a(e))):s.Z.isLoadable(t)&&i.push(t))};t(a);let o=null;if(await(0,r.UI)(i,(async e=>{const t=await(0,r.q6)(function(e){return"loadAll"in e&&"function"==typeof e.loadAll}(e)?e.loadAll():e.load());!1!==t.ok||o||(o=t)})),o)throw o.error;return e}},83986:function(e,t,i){i.d(t,{T:function(){return d},w:function(){return l}});var r=i(29292),n=i(43254),s=i(50702),a=i(93568),o=i(90403);function l(e,t,i){const r=i?.createCollection?.()??new n.Z,s=i?.recycleItems?new c:null,a=(e,t=0)=>{if(!e?.length)return;const i=r.splice(t,e.length);s?s.processRemoved(e):i.forEach(u)},l=(e,i=0)=>{if(!e?.length)return;const n=[];for(const i of e){const e=s?.use(i);if(e)n.push(e);else{const e=t(i);s?.register(i,e),n.push(e)}}r.addMany(n,i)},h=(0,o.on)(e,"after-splice",(({added:e,start:t,removed:i})=>{a(i,t),l(e,t)}),{sync:!0,onListenerRemove:e=>a(e.items),onListenerAdd:e=>l(e.items)});return r.addHandles(h),r}class c{constructor(){this._originalToMapped=new Map,this._removedItemCandidates=new Set,this._garbageCollectionQueued=!1}processRemoved(e){if(!e?.length)return;const{_removedItemCandidates:t}=this;for(const i of e)this._getItem(i)?.markRemoved()&&(t.add(i),this._queueGarbageCollection())}use(e){const t=this._getItem(e);return t&&(t.removed=!1),t?.item}register(e,t){this._originalToMapped.set(e,new h(t))}_getItem(e){return this._originalToMapped.get(e)}_queueGarbageCollection(){this._garbageCollectionQueued||(this._garbageCollectionQueued=!0,queueMicrotask((()=>this._garbageCollectCandidates())))}_garbageCollectCandidates(){this._garbageCollectionQueued=!1;const{_removedItemCandidates:e}=this,t=Array.from(e);e.clear(),t.forEach((e=>this._garbageCollectIfRemoved(e)))}_garbageCollectIfRemoved(e){const{_originalToMapped:t}=this,i=this._getItem(e);i?.removed&&(u(i.item),t.delete(e))}}class h{constructor(e){this.item=e,this.removed=!1}markRemoved(){return this.removed=!0,!0}}function u(e){"object"==typeof e&&e&&("destroy"in e&&"function"==typeof e.destroy?e.destroy():(0,s.C7)(e))}function d(e,t,i){const o=new n.Z,c=l(e,(e=>(0,r.vr)((async i=>{const r=await t(e,i);if((0,a.Hc)(i))throw u(r),(0,a.zE)();return r}))),i),h=()=>null,d=async e=>{const t=await e.promise,i=c.indexOf(e);i<0||o.splice(i,1,t)};o.addMany(c.items.map(h));for(const e of c)(0,a.R8)(d(e));const p=c.on("after-splice",(({added:e,start:t,deleteCount:i})=>{const r=o.splice(t,i);for(const e of r)u(e);if(e?.length){o.addMany(e.map(h),t);for(const t of e)(0,a.R8)(d(t))}}));return o.addHandles([(0,s.ed)(c),p]),o}},9713:function(e,t,i){function r(e){return e&&"getAtOrigin"in e&&"originOf"in e}i.d(t,{l:function(){return r}})},1925:function(e,t,i){i.d(t,{Fp:function(){return h},GJ:function(){return o},M1:function(){return n},MQ:function(){return m},Ww:function(){return f},bA:function(){return u},hw:function(){return d},mE:function(){return c},ne:function(){return a},nn:function(){return l},qF:function(){return _},yG:function(){return s},yP:function(){return p}});var r=i(26636);function n(e){return{value:e}}function s(e,t){return{type:(0,r.UF)(t),value:e,unit:t}}function a(e,t){return{type:(0,r.UF)(t),value:e,unit:t}}function o(e,t,i="arithmetic"){return{type:(0,r.UF)(t),value:e,unit:t,rotationType:i}}function l(e,t){const i=c(e,t);return"angle"===e.type?o(i,t,e.rotationType):function(e,t){return{type:(0,r.UF)(t),value:e,unit:t}}(i,t)}function c(e,t){return(0,r.En)(e.value,e.unit,t)}function h(e,t){return null==e?t:null==t||e.value>(0,r.En)(t.value,t.unit,e.unit)?e:t}function u(e,t){return null==e?null:{...e,value:e.value*t}}function d(e,t,i){if(t===i)return e;switch(i){case"arithmetic":case"geographic":return 90-e}}const p=s(0,"meters"),m=a(0,"square-meters"),f=(o(0,"radians"),o(0,"degrees")),_=o(0,"degrees","geographic")},60147:function(e,t,i){i.d(t,{R:function(){return h}});var r=i(73440),n=i(70880),s=i(50702),a=i(90403),o=i(99153),l=i(17155),c=i(48023);let h=class extends n.Z{constructor(){super(...arguments),this.updating=!1,this._handleId=0,this._scheduleHandleId=0,this._pendingPromises=new Set}destroy(){this.removeAll()}add(e,t,i={}){return this._installWatch(e,t,i,a.YP)}addWhen(e,t,i={}){return this._installWatch(e,t,i,a.gx)}addOnCollectionChange(e,t,{initial:i=!1,final:r=!1}={}){const n=++this._handleId;return this.addHandles([(0,a.on)(e,"after-changes",this._createSyncUpdatingCallback(),a.Z_),(0,a.on)(e,"change",t,{onListenerAdd:i?e=>t({added:e.toArray(),removed:[]}):void 0,onListenerRemove:r?e=>t({added:[],removed:e.toArray()}):void 0})],n),(0,s.kB)((()=>this.removeHandles(n)))}addPromise(e){if(null==e)return e;const t=++this._handleId;this.addHandles((0,s.kB)((()=>{this._pendingPromises.delete(e)&&(0!==this._pendingPromises.size||this.hasHandles(u)||this._set("updating",!1))})),t),this._pendingPromises.add(e),this._set("updating",!0);const i=()=>this.removeHandles(t);return e.then(i,i),e}removeAll(){this._pendingPromises.clear(),this.removeAllHandles(),this._set("updating",!1)}_installWatch(e,t,i={},r){const n=++this._handleId;i.sync||this._installSyncUpdatingWatch(e,n);const a=r(e,t,i);return this.addHandles(a,n),(0,s.kB)((()=>this.removeHandles(n)))}_installSyncUpdatingWatch(e,t){const i=this._createSyncUpdatingCallback(),r=(0,a.YP)(e,i,{sync:!0,equals:()=>!1});return this.addHandles(r,t),r}_createSyncUpdatingCallback(){return()=>{this.removeHandles(u),++this._scheduleHandleId;const e=this._scheduleHandleId;this._get("updating")||this._set("updating",!0),this.addHandles((0,o.Os)((()=>{e===this._scheduleHandleId&&(this._set("updating",this._pendingPromises.size>0),this.removeHandles(u))})),u)}}};(0,r._)([(0,l.Cb)({readOnly:!0})],h.prototype,"updating",void 0),h=(0,r._)([(0,c.j)("esri.core.support.UpdatingHandles")],h);const u=-42},51067:function(e,t,i){i.d(t,{L4:function(){return x},LO:function(){return d},Qv:function(){return h},Rd:function(){return p},Ud:function(){return g},VG:function(){return u},Wv:function(){return f},Zv:function(){return v},aC:function(){return b},h9:function(){return _},ld:function(){return w},mg:function(){return m},q6:function(){return y},sS:function(){return E},yc:function(){return C}});var r=i(46965),n=i(95437),s=i(99574),a=i(1925),o=i(29138),l=i(26636),c=i(40030);function h(e,t,i){return e.units[t][i]}function u(e,t,i,r=2,n="abbr"){return`${(0,c.uf)(t,{minimumFractionDigits:r,maximumFractionDigits:r,signDisplay:t>0?"never":"exceptZero"})} ${h(e,i,n)}`}function d(e,t,i,r=2,n="abbr"){return`${(0,c.uf)(t,{minimumFractionDigits:r,maximumFractionDigits:r,signDisplay:"exceptZero"})} ${h(e,i,n)}`}function p(e,t,i,r=2,n="abbr"){const s=(0,l.Y8)(t,i);return u(e,(0,l.En)(t,i,s),s,r,n)}function m(e,t,i,r=2,n="abbr"){const s=(0,l.Y8)(t,i);return d(e,(0,l.En)(t,i,s),s,r,n)}function f(e,t,i,r=2,n="abbr"){const s=(0,l.Dw)(t,i);return u(e,(0,l.En)(t,i,s),s,r,n)}function _(e,t,i,r=2,n="abbr"){const s=(0,l.Dw)(t,i);return d(e,(0,l.En)(t,i,s),s,r,n)}function g(e,t,i,r=2,n="abbr"){const s=(0,l.Q7)(t,i);return u(e,(0,l.En)(t,i,s),s,r,n)}function y(e,t,i,r=2,n="abbr"){const s=(0,l.Q7)(t,i);return d(e,(0,l.En)(t,i,s),s,r,n)}function v(e,t,i,r=2,n="abbr"){const s=(0,l.jl)(t,i);return u(e,(0,l.En)(t,i,s),s,r,n)}function b(e,t,i,r=2,n="abbr"){const s=(0,l.jl)(t,i);return d(e,(0,l.En)(t,i,s),s,r,n)}function w(e,t,i,r=2,n="abbr"){const s=(0,l.ZI)(t,i);return u(e,(0,l.En)(t,i,s),s,r,n)}function C(e,t,i,r=2,n="abbr"){const s=(0,l.LV)(t,i);return u(e,(0,l.En)(t,i,s),s,r,n)}function x(e,t,i,r,s,o=n.BV,h=!0){let u=o.normalize((0,a.hw)((0,l.En)(e,t,"degrees"),i,r),0,h);const d=((e,t)=>({style:"unit",unitDisplay:"narrow",unit:"degree",maximumFractionDigits:t,minimumFractionDigits:t,signDisplay:e>0?"never":"exceptZero"}))(u,s??2);return u=S(u,d),(0,c.uf)(u,d)}const T=new Map;function S(e,t){const i=JSON.stringify(t);let r=T.get(i);return r||(r=new Intl.NumberFormat("en-US",t),T.set(i,r)),/^[-+]?360\.?0*°?$/.test(r.format(e))?0:e}const M=["B","kB","MB","GB","TB"];function E(e,t){let i=0===(t=Math.round(t))?0:Math.floor(Math.log(t)/Math.log(r.Y.KILOBYTES));i=(0,s.uZ)(i,0,M.length-1);const n=(0,c.uf)(t/r.Y.KILOBYTES**i,{maximumFractionDigits:2});return(0,o.gx)(e.units.bytes[M[i]],{fileSize:n})}},37580:function(e,t,i){i.d(t,{q:function(){return l}});var r=i(3480),n=i(50702),s=i(96711),a=i(93568),o=i(82592);class l{constructor(e,t,i,r,n={}){this._mainMethod=t,this._transferLists=i,this._listeners=[],this._promise=(0,o.bA)(e,{...n,schedule:r}).then((e=>{if(void 0===this._thread){this._thread=e,this._promise=null,n.hasInitialize&&this.broadcast({},"initialize");for(const e of this._listeners)this._connectListener(e)}else e.close()})),this._promise.catch((t=>s.Z.getLogger("esri.core.workers.WorkerHandle").error(`Failed to initialize ${e} worker: ${t}`)))}on(e,t){const i={removed:!1,eventName:e,callback:t,threadHandle:null};return this._listeners.push(i),this._connectListener(i),(0,n.kB)((()=>{i.removed=!0,(0,r.Od)(this._listeners,i),this._thread&&null!=i.threadHandle&&i.threadHandle.remove()}))}destroy(){this._thread&&(this._thread.close(),this._thread=null),this._promise=null,this._listeners.length=0,this._transferLists={}}invoke(e,t,i){return this.invokeMethod(this._mainMethod,e,t,i)}invokeMethod(e,t,i,r){if(this._thread){const n=this._transferLists[e],s=n?n(t):[];return this._thread.invoke(e,t,{transferList:s,signal:i,priority:r})}return this._promise?this._promise.then((()=>((0,a.k_)(i),this.invokeMethod(e,t,i)))):Promise.reject(null)}broadcast(e,t){return this._thread?Promise.all(this._thread.broadcast(t,e)).then((()=>{})):this._promise?this._promise.then((()=>this.broadcast(e,t))):Promise.reject()}get promise(){return this._promise}_connectListener(e){this._thread&&this._thread.on(e.eventName,e.callback).then((t=>{e.removed||(e.threadHandle=t)}))}}},5226:function(e,t,i){i.d(t,{BR:function(){return w},E2:function(){return A},Is:function(){return T},Kf:function(){return b},NE:function(){return M},P0:function(){return v},Tz:function(){return R},Ue:function(){return d},bk:function(){return m},ej:function(){return C},id:function(){return x},pb:function(){return y},pt:function(){return _},qf:function(){return p},rF:function(){return S},yS:function(){return P}});var r=i(31865),n=i(24910),s=i(82846),a=i(47925),o=i(45213),l=i(70331),c=i(93070),h=i(89420),u=i(69055);function d(e){const{value:t,operations:i}=e;return{operations:i,value:i.create(t)}}function p(e,t,i){return e.operations.setExtent(e.value,t,i.value),i}function m(e,t){return e.operations.getExtent(e.value,t),t}function f(e,t,i=function(e){return{operations:e,value:e.create()}}(e)){return i.operations=e,e.copy(t,i.value),i}function _(e){return f(u.s,(0,u.f)(0,0,0,(0,a.Iu)(e).radius))}const g=2**50;function y(){return f(h.b,(0,h.f)([0,0,0],[g,0,0],[0,g,0]))}function v(e,t,i){return e.operations.axisAt(e.value,t,c.R.Z,i)}function b(e,t,i,r){return e.operations.axisAt(e.value,t,i,r)}function w(e,t,i){return e.operations.intersectRay(e.value,t,i)}function C(e,t,i){return e.operations.intersectRayClosestSilhouette(e.value,t,i)}function x(e,t){return e.operations.altitudeAt(e.value,t)}function T(e,t,i,r){return e.operations.setAltitudeAt(e.value,t,i,r)}function S(e,t,i,s){return t!==s&&(0,r.JG)(s,t),(0,n.i)(E,s[12],s[13],s[14]),T(e,E,i,E),s[12]=E[0],s[13]=E[1],s[14]=E[2],s}function M(e,t,i){return e.operations.elevate(e.value,t,i.value)}const E=(0,s.Ue)();function P(e,t,i,r,s){return s[0]=(0,n.e)(e,t),s[1]=(0,n.e)(e,i),s[2]=(0,n.e)(e,r),s}function R(e,t,i,r,s){(0,n.c)(i,e),(0,n.c)(O,t),(0,n.n)(O,O),(0,n.h)(r,O,i),(0,n.h)(s,r,i)}function A(e,t){return e?(0,l.rS)(t):t.isGeographic?o.Z.PlateCarree:t}const O=(0,s.Ue)()},88970:function(e,t,i){i.d(t,{AR:function(){return y},Gr:function(){return g},JG:function(){return h},Jk:function(){return p},KU:function(){return f},Ue:function(){return l},al:function(){return u},ct:function(){return _},nF:function(){return m},re:function(){return c},zk:function(){return d}});var r=i(99574),n=i(38949),s=i(24910),a=i(82846),o=i(69811);function l(e){return e?{origin:(0,a.d9)(e.origin),vector:(0,a.d9)(e.vector)}:{origin:(0,a.Ue)(),vector:(0,a.Ue)()}}function c(e,t){const i=w.get();return i.origin=e,i.vector=t,i}function h(e,t=l()){return u(e.origin,e.vector,t)}function u(e,t,i=l()){return(0,s.c)(i.origin,e),(0,s.c)(i.vector,t),i}function d(e,t,i=l()){return(0,s.c)(i.origin,e),(0,s.d)(i.vector,t,e),i}function p(e,t){const i=(0,s.d)(o.WM.get(),t,e.origin),n=(0,s.e)(e.vector,i),a=(0,s.e)(e.vector,e.vector),l=(0,r.uZ)(n/a,0,1),c=(0,s.d)(o.WM.get(),(0,s.g)(o.WM.get(),e.vector,l),i);return(0,s.e)(c,c)}function m(e,t,i){return _(e,t,0,1,i)}function f(e,t,i){return(0,s.f)(i,e.origin,(0,s.g)(i,e.vector,t))}function _(e,t,i,n,a){const{vector:l,origin:c}=e,h=(0,s.d)(o.WM.get(),t,c),u=(0,s.e)(l,h)/(0,s.k)(l);return(0,s.g)(a,l,(0,r.uZ)(u,i,n)),(0,s.f)(a,a,e.origin)}function g(e,t){if(v(e,c(t.origin,t.direction),!1,b)){const{tA:t,pB:i,distance2:r}=b;if(t>=0&&t<=1)return r;if(t<0)return(0,s.s)(e.origin,i);if(t>1)return(0,s.s)((0,s.f)(o.WM.get(),e.origin,e.vector),i)}return null}function y(e,t,i){return!!v(e,t,!0,b)&&((0,s.c)(i,b.pA),!0)}function v(e,t,i,n){const a=1e-6,l=e.origin,c=(0,s.f)(o.WM.get(),l,e.vector),h=t.origin,u=(0,s.f)(o.WM.get(),h,t.vector),d=o.WM.get(),p=o.WM.get();if(d[0]=l[0]-h[0],d[1]=l[1]-h[1],d[2]=l[2]-h[2],p[0]=u[0]-h[0],p[1]=u[1]-h[1],p[2]=u[2]-h[2],Math.abs(p[0])<a&&Math.abs(p[1])<a&&Math.abs(p[2])<a)return!1;const m=o.WM.get();if(m[0]=c[0]-l[0],m[1]=c[1]-l[1],m[2]=c[2]-l[2],Math.abs(m[0])<a&&Math.abs(m[1])<a&&Math.abs(m[2])<a)return!1;const f=d[0]*p[0]+d[1]*p[1]+d[2]*p[2],_=p[0]*m[0]+p[1]*m[1]+p[2]*m[2],g=d[0]*m[0]+d[1]*m[1]+d[2]*m[2],y=p[0]*p[0]+p[1]*p[1]+p[2]*p[2],v=(m[0]*m[0]+m[1]*m[1]+m[2]*m[2])*y-_*_;if(Math.abs(v)<a)return!1;let b=(f*_-g*y)/v,w=(f+_*b)/y;i&&(b=(0,r.uZ)(b,0,1),w=(0,r.uZ)(w,0,1));const C=o.WM.get(),x=o.WM.get();return C[0]=l[0]+b*m[0],C[1]=l[1]+b*m[1],C[2]=l[2]+b*m[2],x[0]=h[0]+w*p[0],x[1]=h[1]+w*p[1],x[2]=h[2]+w*p[2],n.tA=b,n.tB=w,n.pA=C,n.pB=x,n.distance2=(0,s.s)(C,x),!0}const b={tA:0,tB:0,pA:(0,a.Ue)(),pB:(0,a.Ue)(),distance2:0},w=new n.x((()=>l()))},79012:function(e,t,i){i.d(t,{bE:function(){return c},wu:function(){return l}});var r=i(38949),n=i(24910),s=i(82846),a=i(88970);i(69811);function o(e){return e?{p0:(0,s.d9)(e.p0),p1:(0,s.d9)(e.p1),p2:(0,s.d9)(e.p2)}:{p0:(0,s.Ue)(),p1:(0,s.Ue)(),p2:(0,s.Ue)()}}function l(e,t,i){const r=t[0]-e[0],n=t[1]-e[1],s=i[0]-e[0],a=i[1]-e[1];return.5*Math.abs(r*a-n*s)}function c(e,t,i){return(0,n.d)(h,t,e),(0,n.d)(u,i,e),.5*(0,n.l)((0,n.h)(h,h,u))}new r.x(a.Ue),new r.x((()=>o()));const h=(0,s.Ue)(),u=(0,s.Ue)()},38700:function(e,t,i){var r,n,s,a,o,l,c,h,u,d,p,m,f,_,g;i.d(t,{$1:function(){return c},AQ:function(){return l},Em:function(){return v},Lz:function(){return s},MB:function(){return r},Nl:function(){return g},Q3:function(){return y},Qd:function(){return m},aw:function(){return _},jE:function(){return f},l7:function(){return n},xL:function(){return a}}),function(e){e.U8="U8",e.I8="I8",e.U16="U16",e.I16="I16",e.U32="U32",e.I32="I32",e.F32="F32",e.F64="F64",e.Utf8String="Utf8String",e.NotSet="NotSet"}(r||(r={})),function(e){e.Png="Png",e.Jpeg="Jpeg",e.Dds="Dds",e.Raw="Raw",e.Dxt1="Dxt1",e.Dxt5="Dxt5",e.Bc7="Bc7",e.Basis="Basis",e.Etc1="Etc1",e.Etc2="Etc2",e.Astc="Astc",e.Pvrtc="Pvrtc",e.NotSet="NotSet"}(n||(n={})),function(e){e.Position="Position",e.Normal="Normal",e.TexCoord="TexCoord",e.Color="Color",e.Tangent="Tangent",e.FeatureIndex="FeatureIndex",e.UvRegion="UvRegion",e.FeatureVariable="FeatureVariable",e.NotSet="NotSet"}(s||(s={})),function(e){e.Opaque="Opaque",e.Mask="Mask",e.Blend="Blend"}(a||(a={})),function(e){e.None="None",e.Mask="Mask",e.Alpha="Alpha",e.PreMultAlpha="PreMultAlpha",e.NotSet="NotSet"}(o||(o={})),function(e){e.Points="Points",e.Lines="Lines",e.LineStrip="LineStrip",e.Triangles="Triangles",e.TriangleStrip="TriangleStrip",e.NotSet="NotSet"}(l||(l={})),function(e){e.None="None",e.WrapXBit="WrapXBit",e.WrapYBit="WrapYBit",e.WrapXy="WrapXy",e.NotSet="NotSet"}(c||(c={})),function(e){e.Linear="Linear",e.Nearest="Nearest",e.NotSet="NotSet"}(h||(h={})),function(e){e.Linear="Linear",e.Nearest="Nearest",e.NearestMipmapNearest="NearestMipmapNearest",e.LinearMipmapNearest="LinearMipmapNearest",e.NearestMipmapLinear="NearestMipmapLinear",e.LinearMipmapLinear="LinearMipmapLinear",e.NotSet="NotSet"}(u||(u={})),function(e){e.FeatureId="FeatureId",e.GlobalUid="GlobalUid",e.UnspecifiedDateTime="UnspecifiedDateTime",e.EcmaIso8601DateTime="EcmaIso8601DateTime",e.EcmaIso8601DateOnly="EcmaIso8601DateOnly",e.TimeOnly="TimeOnly",e.TimeStamp="TimeStamp",e.ColorRgb="ColorRgb",e.ColorRgba="ColorRgba",e.Unrecognized="Unrecognized",e.NotSet="NotSet"}(d||(d={})),function(e){e.Texture="Texture",e.VertexAtrb="VertexAtrb",e.Implicit="Implicit",e.NotSet="NotSet"}(p||(p={})),function(e){e.Front="Front",e.Back="Back",e.None="None",e.NotSet="NotSet"}(m||(m={})),function(e){e.Pbr="Pbr",e.Unlit="Unlit"}(f||(f={})),function(e){e.Rgb8="Rgb8",e.Rgba8="Rgba8",e.R8="R8",e.Bgr8="Bgr8",e.Bgra8="Bgra8",e.Rg8="Rg8",e.Ga8="Ga8",e.Etc1="Etc1",e.Etc2="Etc2",e.Dxt1="Dxt1",e.Dxt5="Dxt5",e.Bc7="Bc7",e.NotSet="NotSet"}(_||(_={})),function(e){e[e.Succeeded=0]="Succeeded",e[e.Failed=1]="Failed",e[e.MissingInputs=2]="MissingInputs"}(g||(g={}));const y=-1,v=-2},78646:function(e,t,i){i.d(t,{d:function(){return r}});const r="OBJECTID"},42810:function(e,t,i){i.d(t,{b:function(){return r}});class r{constructor(e){this._store=e}destroy(){this._store.destroy()}get(e){return this._store.get(e)}put(e,t){this._store.put(e,t)}}},62535:function(e,t,i){i.d(t,{G$:function(){return p},Tl:function(){return d}});i(61432);var r=i(50702),n=i(96711),s=i(26636),a=i(60508),o=i(47566),l=i(97290);const c=()=>n.Z.getLogger("esri.layers.support.ElevationSampler");class h{queryElevation(e){return p(e.clone(),this)}on(){return(0,r.kB)()}projectIfRequired(e,t){return m(e,t)}}class u extends h{get spatialReference(){return this.extent.spatialReference}constructor(e,t,i){super(),this.tile=e,this.noDataValue=i;const r=e.tile.extent;this.extent=(0,o.HH)(r,t.spatialReference),this.extent.zmin=e.zmin,this.extent.zmax=e.zmax,this._aaExtent=r;const n=(0,s.c9)(t.spatialReference),a=t.lodAt(e.tile.level).resolution*n;this.demResolution={min:a,max:a}}contains(e){const t=this.projectIfRequired(e,this.spatialReference);return null!=t&&this.containsAt(t.x,t.y)}containsAt(e,t){return(0,o.jE)(this._aaExtent,e,t)}elevationAt(e,t){if(!this.containsAt(e,t)){const i=this.extent,r=`${i.xmin}, ${i.ymin}, ${i.xmax}, ${i.ymax}`;return c().warn("#elevationAt()",`Point used to sample elevation (${e}, ${t}) is outside of the sampler extent (${r})`),this.noDataValue}return this.tile.sample(e,t)??this.noDataValue}}class d extends h{get spatialReference(){return this.extent.spatialReference}constructor(e,t,i){let r;super(),"number"==typeof t?(this.noDataValue=t,r=null):(r=t,this.noDataValue=i),this.samplers=r?e.map((e=>new u(e,r,this.noDataValue))):e;const n=this.samplers[0];if(n){this.extent=n.extent.clone();const{min:e,max:t}=n.demResolution;this.demResolution={min:e,max:t};for(let e=1;e<this.samplers.length;e++){const t=this.samplers[e];this.extent.union(t.extent),this.demResolution.min=Math.min(this.demResolution.min,t.demResolution.min),this.demResolution.max=Math.max(this.demResolution.max,t.demResolution.max)}}else this.extent=(0,o.HH)((0,o.Ue)(),r.spatialReference),this.demResolution={min:0,max:0}}elevationAt(e,t){let i,r=!1;for(const n of this.samplers)if(n.containsAt(e,t)&&(r=!0,i=n.elevationAt(e,t),i!==n.noDataValue))return i;return null!=i?i:(r||c().warn("#elevationAt()",`Point used to sample elevation (${e}, ${t}) is outside of the sampler`),this.noDataValue)}}function p(e,t){const i=m(e,t.spatialReference);if(!i)return null;switch(e.type){case"point":!function(e,t,i){e.z=i.elevationAt(t.x,t.y)}(e,i,t);break;case"polyline":!function(e,t,i){f.spatialReference=t.spatialReference;const r=e.hasM&&!e.hasZ;for(let n=0;n<e.paths.length;n++){const s=e.paths[n],a=t.paths[n];for(let e=0;e<s.length;e++){const t=s[e],n=a[e];f.x=n[0],f.y=n[1],r&&(t[3]=t[2]),t[2]=i.elevationAt(f.x,f.y)}}e.hasZ=!0}(e,i,t);break;case"multipoint":!function(e,t,i){f.spatialReference=t.spatialReference;const r=e.hasM&&!e.hasZ;for(let n=0;n<e.points.length;n++){const s=e.points[n],a=t.points[n];f.x=a[0],f.y=a[1],r&&(s[3]=s[2]),s[2]=i.elevationAt(f.x,f.y)}e.hasZ=!0}(e,i,t)}return e}function m(e,t){if(null==e)return null;const i=e.spatialReference;if(i.equals(t))return e;const r=(0,l.iV)(e,t);return r||c().error(`Cannot project geometry spatial reference (wkid:${i.wkid}) to elevation sampler spatial reference (wkid:${t.wkid})`),r}const f=new a.Z},5135:function(e,t,i){i.d(t,{K:function(){return r}});class r{constructor(e,t){this.data=e,this.safeWidth=.99999999*(e.width-1),this.dx=(e.width-1)/(t[2]-t[0]),this.dy=(e.width-1)/(t[3]-t[1]),this.x0=t[0],this.y1=t[3]}}},45107:function(e,t,i){i.d(t,{Z:function(){return c}});var r,n=i(73440),s=i(63255),a=i(17155),o=i(95226),l=(i(61432),i(83850),i(48023));let c=class extends s.Z{static{r=this}constructor(e){super(e),this.cols=null,this.level=0,this.levelValue=null,this.origin=null,this.resolution=0,this.rows=null,this.scale=0}clone(){return new r({cols:this.cols,level:this.level,levelValue:this.levelValue,resolution:this.resolution,rows:this.rows,scale:this.scale})}};(0,n._)([(0,a.Cb)({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],c.prototype,"cols",void 0),(0,n._)([(0,a.Cb)({type:o.z8,json:{write:!0}})],c.prototype,"level",void 0),(0,n._)([(0,a.Cb)({type:String,json:{write:!0}})],c.prototype,"levelValue",void 0),(0,n._)([(0,a.Cb)({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],c.prototype,"origin",void 0),(0,n._)([(0,a.Cb)({type:Number,json:{write:!0}})],c.prototype,"resolution",void 0),(0,n._)([(0,a.Cb)({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],c.prototype,"rows",void 0),(0,n._)([(0,a.Cb)({type:Number,json:{write:!0}})],c.prototype,"scale",void 0),c=r=(0,n._)([(0,l.j)("esri.layers.support.LOD")],c)},35857:function(e,t,i){i.d(t,{Z:function(){return d}});var r,n=i(73440),s=i(43254),a=i(63255),o=i(8914),l=(i(96711),i(61432),i(83850),i(88194),i(48023)),c=i(67764),h=i(13132);let u=r=class extends(a.Z.JSONSupportMixin(s.Z.ofType(c.Z))){constructor(e){super(e)}clone(){return new r(this.items.map((e=>e.clone())))}write(e,t){return this.toJSON(t)}toJSON(e){const t=e?.layer?.spatialReference;return t?this.toArray().map((i=>{if(!t.equals(i.spatialReference)){if(!(0,h.canProjectWithoutEngine)(i.spatialReference,t))return e?.messages?.push(new o.Z("scenefilter:unsupported","Scene filters with incompatible spatial references are not supported",{modification:this,spatialReference:e.layer.spatialReference,context:e})),null;const r=new c.Z;(0,h.projectPolygon)(i,r,t),i=r}const r=i.toJSON(e);return delete r.spatialReference,r})).filter((e=>null!=e)):this.toArray().map((t=>t.toJSON(e)))}static fromJSON(e,t){const i=new r;return e.forEach((e=>i.add(c.Z.fromJSON(e,t)))),i}};u=r=(0,n._)([(0,l.j)("esri.layers.support.PolygonCollection")],u);const d=u},97550:function(e,t,i){i.d(t,{Z:function(){return w}});var r,n=i(73440),s=i(41773),a=i(63255),o=i(26636),l=i(17155),c=i(95226),h=(i(61432),i(83850),i(1194)),u=i(48023),d=i(29884),p=i(60508),m=i(45213),f=i(47566),_=i(8554),g=i(97290),y=i(45107),v=i(31743);const b=new s.X({PNG:"png",PNG8:"png8",PNG24:"png24",PNG32:"png32",JPEG:"jpg",JPG:"jpg",DIB:"dib",TIFF:"tiff",EMF:"emf",PS:"ps",PDF:"pdf",GIF:"gif",SVG:"svg",SVGZ:"svgz",Mixed:"mixed",MIXED:"mixed",LERC:"lerc",LERC2D:"lerc2d",RAW:"raw",pbf:"pbf"});let w=class extends a.Z{static{r=this}static create(e={}){const{resolutionFactor:t=1,scales:i,size:n=256,spatialReference:s=m.Z.WebMercator,numLODs:a=24}=e;if(!(0,_.JY)(s)){const e=[];if(i)for(let t=0;t<i.length;t++){const r=i[t];e.push(new y.Z({level:t,scale:r,resolution:r}))}else{let t=5e-4;for(let i=a-1;i>=0;i--)e.unshift(new y.Z({level:i,scale:t,resolution:t})),t*=2}return new r({dpi:96,lods:e,origin:new p.Z(0,0,s),size:[n,n],spatialReference:s})}const l=(0,_.C5)(s),c=e.origin?new p.Z({x:e.origin.x,y:e.origin.y,spatialReference:s}):new p.Z(l?{x:l.origin[0],y:l.origin[1],spatialReference:s}:{x:0,y:0,spatialReference:s}),h=1/(39.37*(0,o.c9)(s)*96),u=[];if(i)for(let e=0;e<i.length;e++){const t=i[e],r=t*h;u.push(new y.Z({level:e,scale:t,resolution:r}))}else{let e=(0,_.sT)(s)?512/n*591657527.5917094:256/n*591657527.591555;const i=Math.ceil(a/t);u.push(new y.Z({level:0,scale:e,resolution:e*h}));for(let r=1;r<i;r++){const i=e/2**t,n=i*h;u.push(new y.Z({level:r,scale:i,resolution:n})),e=i}}return new r({dpi:96,lods:u,origin:c,size:[n,n],spatialReference:s})}constructor(e){super(e),this.dpi=96,this.format=null,this.origin=null,this.size=null,this.spatialReference=null}get isWrappable(){const{spatialReference:e,origin:t}=this;if(e&&t){const i=(0,_.C5)(e);return e.isWrappable&&!!i&&Math.abs(i.origin[0]-t.x)<=i.dx}return!1}readOrigin(e,t){return p.Z.fromJSON({spatialReference:t.spatialReference,...e})}set lods(e){let t=0,i=0;const r=[],n=this._levelToLOD={};e&&(t=-1/0,i=1/0,e.forEach((e=>{r.push(e.scale),t=e.scale>t?e.scale:t,i=e.scale<i?e.scale:i,n[e.level]=e}))),this._set("scales",r),this._set("lods",e),this._initializeUpsampleLevels()}readSize(e,t){return[t.cols,t.rows]}writeSize(e,t){t.cols=e[0],t.rows=e[1]}zoomToScale(e){const t=this.scales;if(e<=0)return t[0];if(e>=t.length-1)return t[t.length-1];const i=Math.floor(e),r=i+1;return t[i]/(t[i]/t[r])**(e-i)}scaleToZoom(e){const t=this.scales,i=t.length-1;let r=0;for(;r<i;r++){const i=t[r],n=t[r+1];if(i<=e)return r;if(n===e)return r+1;if(i>e&&n<e)return r+Math.log(i/e)/Math.log(i/n)}return r}tileAt(e,t,i,r){const n=this.lodAt(e);if(!n)return null;let s,a;if("number"==typeof t)s=t,a=i;else if((0,_.fS)(t.spatialReference,this.spatialReference))s=t.x,a=t.y,r=i;else{const e=(0,g.iV)(t,this.spatialReference);if(null==e)return null;s=e.x,a=e.y,r=i}const o=n.resolution*this.size[0],l=n.resolution*this.size[1];return r||(r=new v.f(null,0,0,0,(0,f.Ue)())),r.level=e,r.row=Math.floor((this.origin.y-a)/l+.001),r.col=Math.floor((s-this.origin.x)/o+.001),this.updateTileInfo(r),r}updateTileInfo(e,t=r.ExtrapolateOptions.NONE){let i=this.lodAt(e.level);if(!i&&t===r.ExtrapolateOptions.POWER_OF_TWO){const t=this.lods[this.lods.length-1];t.level<e.level&&(i=t)}if(!i)return;const n=e.level-i.level,s=i.resolution*this.size[0]/2**n,a=i.resolution*this.size[1]/2**n;e.id=`${e.level}/${e.row}/${e.col}`,e.extent||(e.extent=(0,f.Ue)()),e.extent[0]=this.origin.x+e.col*s,e.extent[1]=this.origin.y-(e.row+1)*a,e.extent[2]=e.extent[0]+s,e.extent[3]=e.extent[1]+a}upsampleTile(e){const t=this._upsampleLevels[e.level];return!(!t||-1===t.parentLevel||(e.level=t.parentLevel,e.row=Math.floor(e.row/t.factor+.001),e.col=Math.floor(e.col/t.factor+.001),this.updateTileInfo(e),0))}getTileBounds(e,t){const i=this.lodAt(t.level);if(null==i)return null;const{resolution:r}=i,n=r*this.size[0],s=r*this.size[1];return e[0]=this.origin.x+t.col*n,e[1]=this.origin.y-(t.row+1)*s,e[2]=e[0]+n,e[3]=e[1]+s,e}lodAt(e){return this._levelToLOD?.[e]??null}clone(){return r.fromJSON(this.write({}))}getCompatibleForVTL(e){if(this.size[0]!==this.size[1]||256===this.size[0]&&512===e)return null;const t=(512===this.size[0]&&256===e?-1:0)+(this.spatialReference.isGeographic?1:0);if(this.size[0]===e&&0===t)return this;const i=[],n=this.lods.length-t;for(let e=0;e<n;e++){const r=e+t,{scale:n,resolution:s}=r>=0?this.lods[r]:{scale:2*this.lods[0].scale,resolution:2*this.lods[0].resolution};i.push(new y.Z({level:e,scale:n,resolution:s}))}return new r({size:[e,e],dpi:this.dpi,format:this.format,compressionQuality:this.compressionQuality,origin:this.origin,spatialReference:this.spatialReference,lods:i})}_initializeUpsampleLevels(){const e=this.lods;this._upsampleLevels=[];let t=null;for(let i=0;i<e.length;i++){const r=e[i];this._upsampleLevels[r.level]={parentLevel:t?t.level:-1,factor:t?t.resolution/r.resolution:0},t=r}}};(0,n._)([(0,l.Cb)({type:Number,json:{write:!0}})],w.prototype,"compressionQuality",void 0),(0,n._)([(0,l.Cb)({type:Number,json:{write:!0}})],w.prototype,"dpi",void 0),(0,n._)([(0,l.Cb)({type:String,json:{read:b.read,write:b.write,origins:{"web-scene":{read:!1,write:!1}}}})],w.prototype,"format",void 0),(0,n._)([(0,l.Cb)({readOnly:!0})],w.prototype,"isWrappable",null),(0,n._)([(0,l.Cb)({type:p.Z,json:{write:!0}})],w.prototype,"origin",void 0),(0,n._)([(0,h.r)("origin")],w.prototype,"readOrigin",null),(0,n._)([(0,l.Cb)({type:[y.Z],value:null,json:{write:!0}})],w.prototype,"lods",null),(0,n._)([(0,l.Cb)({readOnly:!0})],w.prototype,"scales",void 0),(0,n._)([(0,l.Cb)({cast:e=>Array.isArray(e)?e:"number"==typeof e?[e,e]:[256,256]})],w.prototype,"size",void 0),(0,n._)([(0,h.r)("size",["rows","cols"])],w.prototype,"readSize",null),(0,n._)([(0,d.c)("size",{cols:{type:c.z8},rows:{type:c.z8}})],w.prototype,"writeSize",null),(0,n._)([(0,l.Cb)({type:m.Z,json:{write:!0}})],w.prototype,"spatialReference",void 0),w=r=(0,n._)([(0,u.j)("esri.layers.support.TileInfo")],w),function(e){var t;(t=e.ExtrapolateOptions||(e.ExtrapolateOptions={}))[t.NONE=0]="NONE",t[t.POWER_OF_TWO=1]="POWER_OF_TWO"}(w||(w={}))},31743:function(e,t,i){i.d(t,{f:function(){return r}});class r{constructor(e,t,i,r,n){this.id=e,this.level=t,this.row=i,this.col=r,this.extent=n}}},10813:function(e,t,i){i.d(t,{B:function(){return g},J:function(){return _}});var r=i(88194),n=i(96711),s=i(48797),a=i(60646),o=i(40030),l=i(56575),c=i(76554),h=i(48837),u=i(15065),d=i(82377);const p=()=>n.Z.getLogger("esri.layers.support.labelFormatUtils"),m={type:"simple",evaluate:()=>null},f={getAttribute:(e,t)=>e.field(t)};async function _(e,t,i){if(!e||!e.symbol||!t)return m;const n=e.where,a=(0,h.hV)(e);let o;if("arcade"===a.type){const e=(0,d.b)(a.expression),n=t.get(e);if(n&&((0,c.Vo)(n)||(0,c.H7)(n)||(0,c.qN)(n)))o={type:"simple",evaluate(e){const t="attributes"in e?e.attributes?.[n.name]:e.field(n.name);return null==t?"":t.toString()}};else{const e=await(0,u.WW)(a.expression,i);if(null==e)return m;o={type:"arcade",evaluate(i,n){try{const r="attributes"in i?e.repurposeFeature(i,t):i;r.contextTimeZone=n??null;const s=e.evaluate(r,{$view:{timeZone:n}});if(null!=s)return s.toString()}catch(e){p().error(new r.Z("arcade-expression-error","Encountered an error when evaluating label expression for feature",{error:e,feature:i,expression:a}))}return null},needsHydrationToEvaluate:()=>null==(0,h.el)(a.expression)}}}else o={type:"simple",evaluate:e=>a.expression.replaceAll(/{[^}]*}/g,(i=>{const r=i.slice(1,-1),n=t.get(r);if(!n)return i;let s=null;return s="attributes"in e?e?.attributes?.[n.name]:e.field(n.name),null==s?"":g(s,n)}))};if(n){let e;try{e=await(0,s.EP)(n,t)}catch(e){return p().error(new r.Z("bad-where-clause","Encountered an error when evaluating where clause, ignoring",{where:n,error:e})),m}const i=o.evaluate;o.evaluate=(t,s)=>{const a="attributes"in t?void 0:f;try{if(e.testFeature(t,a))return i(t,s)}catch(e){p().error(new r.Z("bad-where-clause","Encountered an error when evaluating where clause for feature",{where:n,feature:t,error:e}))}return null}}return o}function g(e,t){if(null==e)return"";const i=t.domain;if(i)if("codedValue"===i.type||"coded-value"===i.type){const t=e;for(const e of i.codedValues)if(e.code===t)return e.name}else if("range"===i.type){const{max:r,min:n}=(0,l.D3)(t),s=+e;if(null!=n&&null!=r&&n<=s&&s<=r)return i.name}let r=e;return(0,c.y2)(t)?r=(0,a.p6)(r,(0,a.Ze)("short-date")):(0,c.H7)(t)&&(r=(0,o.uf)(+r)),r||""}},84753:function(e,t,i){i.d(t,{B:function(){return n}});var r=i(95490);function n(e){return s[function(e){return"json"===e.type?"application/json":"blob"===e.type?e.blob.type:function(e){const t=(0,r.Ml)(e);return l[t]||a}(e.url)}(e)]||o}const s={},a="text/plain",o=s[a],l={png:"image/png",jpeg:"image/jpeg",jpg:"image/jpg",bmp:"image/bmp",gif:"image/gif",json:"application/json",txt:"text/plain",xml:"application/xml",svg:"image/svg+xml",zip:"application/zip",pbf:"application/vnd.mapbox-vector-tile",gz:"application/gzip","bin.gz":"application/octet-stream"};for(const e in l)s[l[e]]=e},83322:function(e,t,i){i.d(t,{K:function(){return d}});var r=i(73440),n=i(43254),s=i(41145),a=i(96711),o=i(93568),l=i(17155),c=(i(61432),i(83850),i(48023)),h=i(38209);function u(e,t,i){let r,n;if(e)for(let s=0,a=e.length;s<a;s++){if(r=e.at(s),r?.[t]===i)return r;if("group"===r?.type&&(n=u(r.layers,t,i),n))return n}}const d=e=>{let t=class extends e{constructor(...e){super(...e),this.layers=new n.Z;const t=e=>{e.parent=this,this.layerAdded(e),"elevation"!==e.type&&"base-elevation"!==e.type||a.Z.getLogger(this).error(`Layer 'title:${e.title}, id:${e.id}' of type '${e.type}' is not supported as an operational layer and will therefore be ignored.`)},i=e=>{e.parent=null,this.layerRemoved(e)};this.addHandles([this.layers.on("before-add",(e=>{if(e.item===this)return e.preventDefault(),void a.Z.getLogger(this).error("#add()","Cannot add layer to itself.");(e=>{e.parent&&"remove"in e.parent&&e.parent.remove(e)})(e.item)})),this.layers.on("after-add",(e=>t(e.item))),this.layers.on("after-remove",(e=>i(e.item)))])}destroy(){const e=this.layers.toArray();for(const t of e)t.destroy();this.layers.destroy()}set layers(e){this._set("layers",(0,s.Z)(e,this._get("layers")))}add(e,t){const i=this.layers;if(t=i.getNextIndex(t),e instanceof h.Z){const r=e;r.parent===this?this.reorder(r,t):i.add(r,t)}else(0,o.y8)(e)?e.then((e=>{this.destroyed||this.add(e,t)})):a.Z.getLogger(this).error("#add()","The item being added is not a Layer or a Promise that resolves to a Layer.")}addMany(e,t){const i=this.layers;let r=i.getNextIndex(t);e.slice().forEach((e=>{e.parent!==this?(i.add(e,r),r+=1):this.reorder(e,r)}))}findLayerById(e){return u(this.layers,"id",e)}findLayerByUid(e){return u(this.layers,"uid",e)}remove(e){return this.layers.remove(e)}removeMany(e){return this.layers.removeMany(e)}removeAll(){return this.layers.removeAll()}reorder(e,t){return this.layers.reorder(e,t)}layerAdded(e){}layerRemoved(e){}};return(0,r._)([(0,l.Cb)()],t.prototype,"layers",null),t=(0,r._)([(0,c.j)("esri.support.LayersMixin")],t),t}},33800:function(e,t,i){i.d(t,{Q:function(){return u}});var r=i(73440),n=i(43254),s=i(41145),a=i(96711),o=i(17155),l=(i(61432),i(83850),i(48023));const c=new Set(["feature","subtype-group"]);function h(e,t,i){if(e)for(let r=0,n=e.length;r<n;r++){const n=e.at(r);if(n[t]===i)return n;if("group"===n?.type){const e=h(n.tables,t,i);if(e)return e}}}const u=e=>{let t=class extends e{constructor(...e){super(...e),this.tables=new n.Z,this.addHandles([this.tables.on("after-add",(e=>{const t=e.item;t.parent&&t.parent!==this&&"tables"in t.parent&&t.parent.tables.remove(t),t.parent=this,c.has(t.type)||a.Z.getLogger(this).error(`Layer 'title:${t.title}, id:${t.id}' of type '${t.type}' is not supported as a table and will therefore be ignored.`)})),this.tables.on("after-remove",(e=>{e.item.parent=null}))])}destroy(){const e=this.tables.toArray();for(const t of e)t.destroy();this.tables.destroy()}set tables(e){this._set("tables",(0,s.Z)(e,this._get("tables")))}findTableById(e){return h(this.tables,"id",e)}findTableByUid(e){return h(this.tables,"uid",e)}};return(0,r._)([(0,o.Cb)()],t.prototype,"tables",null),t=(0,r._)([(0,l.j)("esri.support.TablesMixin")],t),t}},13141:function(e,t,i){i.d(t,{Bf:function(){return u},Df:function(){return h},fF:function(){return d}});var r=i(93762),n=(i(43254),i(96711)),s=i(61100),a=i(95226),o=i(82674),l=i(26334);i(18177);const c=()=>n.Z.getLogger("esri.support.basemapUtils");function h(){return{}}function u(e){for(const t in e){const i=e[t];(0,s.SC)(i),delete e[t]}}function d(e,t){let i;if("string"==typeof e){const n=e in l.s,s=!n&&e.includes("/");if(!n&&!s){if((0,o.iU)())c().warn(`Unable to find basemap definition for: ${e}. See available styles at https://developers.arcgis.com/rest/basemap-styles/`);else{const t=Object.entries(l.s).filter((([e,t])=>t.classic||t.is3d)).map((([e])=>`"${e}"`)).sort().join(", ");c().warn(`Unable to find basemap definition for: ${e}. Try one of these: ${t}`)}return null}t&&(i=t[e]),i||(i=n?r.default.fromId(e):new r.default({style:{id:e}}),t&&(t[e]=i))}else i=(0,a.se)(r.default,e);return i?.destroyed&&(c().warn("The provided basemap is already destroyed",{basemap:i}),i=null),i}},76277:function(e,t,i){i.d(t,{O:function(){return s},a:function(){return n}});var r=i(63727);function n(e){return new r.Z({getCollections:()=>[e.tables,e.layers],getChildrenFunction:e=>{const t=[];return"tables"in e&&t.push(e.tables),"layers"in e&&t.push(e.layers),t},itemFilterFunction:e=>{const t=e.parent;return!!t&&"tables"in t&&t.tables.includes(e)}})}function s(e){for(const t of e.values())t?.destroy();e.clear()}},3048:function(e,t,i){i.d(t,{K:function(){return n},_:function(){return r}});const r=Symbol("GroundInstance");function n(e){return null!=e&&"object"==typeof e&&r in e}},48207:function(e,t,i){i.d(t,{LO:function(){return c},Nc:function(){return l},Yc:function(){return o}});const r="calcite-mode-",n="dark",s=/\W/g;function a(){return getComputedStyle(document.body).getPropertyValue("--esri-calcite-mode-name").replaceAll(s,"").toLowerCase()}function o(){return a()===n}function l(){const e=a();switch(e){case n:case"light":return`${r}${e}`;default:return null}}function c(e){const t=l();t&&(h(e),e.classList.add(t))}function h(e){Array.from(e.classList).forEach((t=>{t.startsWith(r)&&e.classList.remove(t)}))}},72728:function(e,t,i){i.d(t,{x:function(){return r}});const r=Symbol("WebScene")},20350:function(e,t,i){var r,n;i.d(t,{H:function(){return n},U:function(){return r}}),function(e){e[e.Stretch=0]="Stretch",e[e.Lut=1]="Lut",e[e.Hillshade=2]="Hillshade",e[e.COUNT=3]="COUNT"}(r||(r={})),function(e){e[e.Noop=0]="Noop",e[e.PerBand=1]="PerBand",e[e.COUNT=2]="COUNT"}(n||(n={}))},25330:function(e,t,i){i.d(t,{i:function(){return w}});i(61432);var r=i(96373),n=i(11034),s=i(5379),a=i(99028),o=i(61100),l=i(85881),c=(i(71090),i(64544)),h=(i(85600),i(13772),i(92937)),u=i(92761),d=i(65650),p=i(57945);class m{constructor(e,t){this.layerUIDs=[],this.isDestroyed=!1,this._data=e;let i=1;const r=new Uint32Array(e);this.layerUIDs=[];const n=r[i++];for(let e=0;e<n;e++)this.layerUIDs[e]=r[i++];this.bufferDataOffset=i,t&&(this.layer=t.getStyleLayerByUID(this.layerUIDs[0]))}get isPreparedForRendering(){return null==this._data}get offset(){return this.bufferDataOffset}get data(){return this._data}destroy(){this.isDestroyed||(this.doDestroy(),this._data=null,this.isDestroyed=!0)}prepareForRendering(e){null!=this._data&&(this.doPrepareForRendering(e,this._data,this.bufferDataOffset),this._data=null)}}class f extends m{constructor(e,t){super(e,t),this.type=a.al.LINE,this.lineIndexStart=0,this.lineIndexCount=0;const i=new Uint32Array(e);let r=this.bufferDataOffset;this.lineIndexStart=i[r++],this.lineIndexCount=i[r++];const n=i[r++];if(n>0){this.patternMap=new Map;for(let e=0;e<n;e++){const e=i[r++],t=i[r++],n=i[r++];this.patternMap.set(e,[t,n])}}this.bufferDataOffset=r}get usedMemory(){return(this.data?.byteLength??0)+(this.vao?.cachedMemory??0)}hasData(){return this.lineIndexCount>0}triangleCount(){return this.lineIndexCount/3}doDestroy(){this.vao=(0,o.M2)(this.vao)}doPrepareForRendering(e,t,i){const r=new Uint32Array(t),n=new Int32Array(r.buffer),s=r[i++],a=u.f.createVertex(e,d.l1.STATIC_DRAW,new Int32Array(n.buffer,4*i,s));i+=s;const o=r[i++],l=u.f.createIndex(e,d.l1.STATIC_DRAW,new Uint32Array(r.buffer,4*i,o));i+=o;const c=this.layer.lineMaterial;this.vao=new p.U(e,c.getAttributeLocations(),c.getLayoutInfo(),new Map([["geometry",a]]),l)}}class _ extends m{constructor(e,t){super(e,t),this.type=a.al.FILL,this.fillIndexStart=0,this.fillIndexCount=0,this.outlineIndexStart=0,this.outlineIndexCount=0;const i=new Uint32Array(e);let r=this.bufferDataOffset;this.fillIndexStart=i[r++],this.fillIndexCount=i[r++],this.outlineIndexStart=i[r++],this.outlineIndexCount=i[r++];const n=i[r++];if(n>0){this.patternMap=new Map;for(let e=0;e<n;e++){const e=i[r++],t=i[r++],n=i[r++];this.patternMap.set(e,[t,n])}}this.bufferDataOffset=r}get usedMemory(){return(this.data?.byteLength??0)+(this.fillVAO?.cachedMemory??0)+(this.outlineVAO?.cachedMemory??0)}hasData(){return this.fillIndexCount>0||this.outlineIndexCount>0}triangleCount(){return(this.fillIndexCount+this.outlineIndexCount)/3}doDestroy(){this.fillVAO=(0,o.M2)(this.fillVAO),this.outlineVAO=(0,o.M2)(this.outlineVAO)}doPrepareForRendering(e,t,i){const r=new Uint32Array(t),n=new Int32Array(r.buffer),s=r[i++],a=u.f.createVertex(e,d.l1.STATIC_DRAW,new Int32Array(n.buffer,4*i,s));i+=s;const o=r[i++],l=u.f.createIndex(e,d.l1.STATIC_DRAW,new Uint32Array(r.buffer,4*i,o));i+=o;const c=r[i++],h=u.f.createVertex(e,d.l1.STATIC_DRAW,new Int32Array(n.buffer,4*i,c));i+=c;const m=r[i++],f=u.f.createIndex(e,d.l1.STATIC_DRAW,new Uint32Array(r.buffer,4*i,m));i+=m;const _=this.layer,g=_.fillMaterial,y=_.outlineMaterial;this.fillVAO=new p.U(e,g.getAttributeLocations(),g.getLayoutInfo(),new Map([["geometry",a]]),l),this.outlineVAO=new p.U(e,y.getAttributeLocations(),y.getLayoutInfo(),new Map([["geometry",h]]),f)}}class g extends m{constructor(e,t,i){super(e,t),this.type=a.al.SYMBOL,this.iconPerPageElementsMap=new Map,this.glyphPerPageElementsMap=new Map,this.symbolInstances=[],this.isIconSDF=!1,this.opacityChanged=!1,this.lastOpacityUpdate=0,this.symbols=[];const r=new Uint32Array(e),n=new Int32Array(e),s=new Float32Array(e);let o=this.bufferDataOffset;this.isIconSDF=!!r[o++];const l=r[o++],u=r[o++],d=r[o++],p=new c.Z(l,u,d,0),m=r[o++];for(let e=0;e<m;e++){const e=r[o++],t=r[o++],i=r[o++];this.iconPerPageElementsMap.set(e,[t,i])}const f=r[o++];for(let e=0;e<f;e++){const e=r[o++],t=r[o++],i=r[o++];this.glyphPerPageElementsMap.set(e,[t,i])}const _=r[o++],g=r[o++];this.iconOpacity=new Int32Array(_),this.textOpacity=new Int32Array(g),o=(0,h.wB)(r,n,s,o,this.symbols,i,p),this.bufferDataOffset=o}get usedMemory(){return(this.data?.byteLength??0)+(this.iconVAO?.cachedMemory??0)+(this.textVAO?.cachedMemory??0)+(0,l.G7)(this.iconOpacity)+(0,l.G7)(this.textOpacity)}hasData(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}triangleCount(){let e=0;for(const t of this.iconPerPageElementsMap.values())e+=t[1];for(const t of this.glyphPerPageElementsMap.values())e+=t[1];return e/3}doDestroy(){this.iconVAO=(0,o.M2)(this.iconVAO),this.textVAO=(0,o.M2)(this.textVAO)}updateOpacityInfo(){if(!this.opacityChanged)return;this.opacityChanged=!1;const e=this.iconOpacity,t=this.iconVAO.vertexBuffers.get("opacity");e.length>0&&e.byteLength===t.usedMemory&&t.setSubData(e,0,0,e.length);const i=this.textOpacity,r=this.textVAO.vertexBuffers.get("opacity");i.length>0&&i.byteLength===r.usedMemory&&r.setSubData(i,0,0,i.length)}doPrepareForRendering(e,t,i){const r=new Uint32Array(t),n=new Int32Array(r.buffer),s=r[i++],a=u.f.createVertex(e,d.l1.STATIC_DRAW,new Int32Array(n.buffer,4*i,s));i+=s;const o=r[i++],l=u.f.createIndex(e,d.l1.STATIC_DRAW,new Uint32Array(r.buffer,4*i,o));i+=o;const c=r[i++],h=u.f.createVertex(e,d.l1.STATIC_DRAW,new Int32Array(n.buffer,4*i,c));i+=c;const m=r[i++],f=u.f.createIndex(e,d.l1.STATIC_DRAW,new Uint32Array(r.buffer,4*i,m));i+=m;const _=u.f.createVertex(e,d.l1.STATIC_DRAW,this.iconOpacity.buffer),g=u.f.createVertex(e,d.l1.STATIC_DRAW,this.textOpacity.buffer),y=this.layer,v=y.iconMaterial,b=y.textMaterial;this.iconVAO=new p.U(e,v.getAttributeLocations(),v.getLayoutInfo(),new Map([["geometry",a],["opacity",_]]),l),this.textVAO=new p.U(e,b.getAttributeLocations(),b.getLayoutInfo(),new Map([["geometry",h],["opacity",g]]),f)}}class y extends m{constructor(e,t){super(e,t),this.type=a.al.CIRCLE,this.circleIndexStart=0,this.circleIndexCount=0;const i=new Uint32Array(e);let r=this.bufferDataOffset;this.circleIndexStart=i[r++],this.circleIndexCount=i[r++],this.bufferDataOffset=r}get usedMemory(){return(this.data?.byteLength??0)+(this.vao?.cachedMemory??0)}hasData(){return this.circleIndexCount>0}triangleCount(){return this.circleIndexCount/3}doDestroy(){this.vao=(0,o.M2)(this.vao)}doPrepareForRendering(e,t,i){const r=new Uint32Array(t),n=new Int32Array(r.buffer),s=r[i++],a=u.f.createVertex(e,d.l1.STATIC_DRAW,new Int32Array(n.buffer,4*i,s));i+=s;const o=r[i++],l=u.f.createIndex(e,d.l1.STATIC_DRAW,new Uint32Array(r.buffer,4*i,o));i+=o;const c=this.layer.circleMaterial;this.vao=new p.U(e,c.getAttributeLocations(),c.getLayoutInfo(),new Map([["geometry",a]]),l)}}var v=i(76496),b=i(58783);class w extends b.I{constructor(e,t,i,r,n,a,o,l=null){super(e,t,i,r,n,a,s.V2,s.V2),this.styleRepository=o,this._memCache=l,this.type="vector-tile",this._referenced=1,this._hasSymbolBuckets=!1,this._usedMemory=256,this.layerData=new Map,this.status="loading",this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.parentTile=null,this.childrenTiles=new Set,this.featureIndex=null,this.triangleCount=0,this._processed=!1,this.id=e.id}get styleLayerUIDs(){return Array.from(this.layerData.keys())}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<v.v7}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<v.v7)}get wasRequested(){return"errored"===this.status||"loaded"===this.status||"reloading"===this.status}setData(e){this.changeDataImpl(e),this.requestRender(),this.ready(),this._processed=!0}deleteLayerData(e){let t=!1;for(const i of e){const e=this.layerData.get(i);e&&(this._usedMemory-=e.usedMemory,e.type===a.al.SYMBOL&&this.symbols.delete(i)&&(t=!0),e.destroy(),this.layerData.delete(i))}this._memCache?.updateSize(this.key.id,this),t&&(this.featureIndex?.clear(),this.emit("symbols-changed")),this.requestRender()}processed(){return this._processed}hasData(){return this.layerData.size>0}hasFeatures(){const e=this.layerData.values();for(const t of e)if(t.hasData())return!0;return!1}dispose(){"unloaded"!==this.status&&(w._destroyRenderBuckets(this.layerData),this.layerData.clear(),this.featureIndex=null,this._usedMemory=0,this.destroy(),this.status="unloaded")}release(){0==--this._referenced&&(this.dispose(),this.stage=null)}retain(){++this._referenced}get cachedMemory(){return this._usedMemory}get usedMemory(){return this._usedMemory}get usedMemoryPerReference(){return this._usedMemory/(this._referenced||1)}changeDataImpl(e){this.featureIndex?.clear();let t=!1;if(e){const{bucketsWithData:i,emptyBuckets:r}=e,n=this._createRenderBuckets(i);if(r&&r.byteLength>0){const e=new Uint32Array(r);for(const t of e)this._deleteLayerData(t)}for(const[e,i]of n)this._deleteLayerData(e),i.type===a.al.SYMBOL&&(this.symbols.set(e,i.symbols),t=!0),this._usedMemory+=i.usedMemory,this.layerData.set(e,i);this._memCache?.updateSize(this.key.id,this)}this._hasSymbolBuckets=!1;for(const e of this.layerData.values())e.type===a.al.SYMBOL&&(this._hasSymbolBuckets=!0);t&&this.emit("symbols-changed")}attachWithContext(e){this.stage={context:e,trashDisplayObject(e){e.processDetach()},untrashDisplayObject:()=>!1}}setTransform(e){super.setTransform(e);const t=this.resolution/(e.resolution*e.pixelRatio),i=this.width/this.rangeX*t,n=this.height/this.rangeY*t,s=[0,0];e.toScreen(s,[this.x,this.y]);const a=this.transforms.tileUnitsToPixels;(0,r.yR)(a),(0,r.Iu)(a,a,s),(0,r.U1)(a,a,Math.PI*e.rotation/180),(0,r.bA)(a,a,[i,n,1])}_createTransforms(){return{displayViewScreenMat3:(0,n.Ue)(),tileMat3:(0,n.Ue)(),tileUnitsToPixels:(0,n.Ue)()}}static _destroyRenderBuckets(e){if(!e)return;const t=new Set;for(const i of e.values())t.has(i)||(i.destroy(),t.add(i));e.clear()}_createRenderBuckets(e){const t=new Map,i=new Map;for(const r of e){const e=this._deserializeBucket(r,i);for(const i of e.layerUIDs)t.set(i,e)}return t}_deserializeBucket(e,t){let i=t.get(e);if(i)return i;switch(new Uint32Array(e)[0]){case a.al.FILL:i=new _(e,this.styleRepository);break;case a.al.LINE:i=new f(e,this.styleRepository);break;case a.al.SYMBOL:i=new g(e,this.styleRepository,this);break;case a.al.CIRCLE:i=new y(e,this.styleRepository)}return t.set(e,i),i}_deleteLayerData(e){if(!this.layerData.has(e))return;const t=this.layerData.get(e);this._usedMemory-=t.usedMemory,t.destroy(),this.layerData.delete(e)}}},5379:function(e,t,i){i.d(t,{V2:function(){return n},dp:function(){return a},er:function(){return r},w8:function(){return s}});const r=512,n=4096,s=8,a=.125},76496:function(e,t,i){i.d(t,{R8:function(){return r},cn:function(){return n},v7:function(){return s}});const r=!0,n=32,s=200},64274:function(e,t,i){i.d(t,{V:function(){return n},a:function(){return r}});class r{constructor(e,t){this.sourceTile=t,this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.featureIndex=0,this.uniqueSymbol=null,this._colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=e}colliders(){return this._colliders}}class n{constructor(e){this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1,this.lastShow=!1,this.tileSymbols=[e],this.id=e.id}}},92937:function(e,t,i){i.d(t,{C$:function(){return u},Fe:function(){return p},HX:function(){return c},Yc:function(){return o},rX:function(){return a},wB:function(){return h}});var r=i(99028),n=i(99719),s=i(64274);function a(e,t,i,r){return l(e,t,i.level,i.col,r.key.level,r.key.col)}function o(e,t,i,r){return l(e,t,i.level,i.row,r.level,r.row)}function l(e,t,i,r,n,s){const a=i-n;if(a>=0)return(t>>a)+(r-(s<<a))*(e>>a);const o=-a;return t-(s-(r<<o))*(e>>o)<<o}class c{constructor(e,t,i){this._rows=Math.ceil(t/i),this._columns=Math.ceil(e/i),this._cellSize=i,this.cells=new Array(this._rows);for(let e=0;e<this._rows;e++){this.cells[e]=new Array(this._columns);for(let t=0;t<this._columns;t++)this.cells[e][t]=[]}}getCell(e,t){const i=Math.min(Math.max(Math.floor(t/this._cellSize),0),this._rows-1),r=Math.min(Math.max(Math.floor(e/this._cellSize),0),this._columns-1);return this.cells[i]&&this.cells[i][r]||null}getCellSpan(e,t,i,r){return[Math.min(Math.max(Math.floor(e/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(t/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(i/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(r/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}}function h(e,t,i,r,n,a,o){const l=t[r++];for(let c=0;c<l;c++){const l=new s.a(a,o);l.xTile=t[r++],l.yTile=t[r++],l.hash=t[r++],l.priority=t[r++],l.featureIndex=t[r++];const c=t[r++],h=l.colliders();for(let e=0;e<c;e++){const e=t[r++],n=t[r++],s=t[r++],a=t[r++],o=!!t[r++],l=t[r++],c=i[r++],u=i[r++],d=t[r++],p=t[r++];h.push({xTile:e,yTile:n,dxPixels:s,dyPixels:a,hard:o,partIndex:l,width:d,height:p,minLod:c,maxLod:u})}const u=e[r++];for(let t=0;t<u;t++)l.textVertexRanges.push([e[r++],e[r++]]);const d=e[r++];for(let t=0;t<d;t++)l.iconVertexRanges.push([e[r++],e[r++]]);n.push(l)}return r}function u(e,t,i){for(const[r,n]of e.symbols)d(e,t,i,n,r)}function d(e,t,i,n,s){const a=e.layerData.get(s);if(a.type===r.al.SYMBOL){for(const t of n){const r=t.uniqueSymbol;let n;if(t.selectedForRendering){const t=r.parts[0],s=t.startOpacity,a=t.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&0===a;const o=i?Math.floor(127*s)|a<<7:a?255:0;n=o<<24|o<<16|o<<8|o}else n=0;for(const[e,i]of t.iconVertexRanges)for(let t=e;t<e+i;t+=4)a.iconOpacity[t/4]=n;if(t.selectedForRendering){const t=r.parts[1],s=t.startOpacity,a=t.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&0===a;const o=i?Math.floor(127*s)|a<<7:a?255:0;n=o<<24|o<<16|o<<8|o}else n=0;for(const[e,i]of t.textVertexRanges)for(let t=e;t<e+i;t+=4)a.textOpacity[t/4]=n}a.lastOpacityUpdate=t,a.opacityChanged=!0}}function p(e,t,i,r){const s=e.colliders();let a,o,l,c;for(const h of s)if(e.uniqueSymbol?.show&&e.uniqueSymbol.parts[h.partIndex].show&&(a=h.xScreen-r[0]+h.dxScreen,o=h.yScreen-r[1]+h.dyScreen,l=a+h.width,c=o+h.height,(0,n.Px)(i,t.x,t.y,a,o,l,c)))return!0;return!1}},99028:function(e,t,i){var r,n,s;i.d(t,{Fr:function(){return s},_K:function(){return n},al:function(){return r}}),function(e){e[e.FILL=1]="FILL",e[e.LINE=2]="LINE",e[e.SYMBOL=3]="SYMBOL",e[e.CIRCLE=4]="CIRCLE"}(r||(r={})),function(e){e[e.BACKGROUND=0]="BACKGROUND",e[e.FILL=1]="FILL",e[e.OUTLINE=2]="OUTLINE",e[e.LINE=3]="LINE",e[e.ICON=4]="ICON",e[e.CIRCLE=5]="CIRCLE",e[e.TEXT=6]="TEXT",e[e.TILEINFO=7]="TILEINFO"}(n||(n={})),function(e){e[e.PAINTER_CHANGED=0]="PAINTER_CHANGED",e[e.LAYOUT_CHANGED=1]="LAYOUT_CHANGED",e[e.LAYER_CHANGED=2]="LAYER_CHANGED",e[e.LAYER_REMOVED=3]="LAYER_REMOVED",e[e.SPRITES_CHANGED=4]="SPRITES_CHANGED"}(s||(s={}))},8267:function(e,t,i){i.d(t,{EE:function(){return n},R:function(){return s},_5:function(){return c},aF:function(){return a},f2:function(){return p},fD:function(){return h},fR:function(){return r},nR:function(){return l},r1:function(){return u},vL:function(){return o}});var r,n,s,a,o,l,c,h,u,d=i(44252);!function(e){e[e.BACKGROUND=0]="BACKGROUND",e[e.FILL=1]="FILL",e[e.LINE=2]="LINE",e[e.SYMBOL=3]="SYMBOL",e[e.CIRCLE=4]="CIRCLE"}(r||(r={})),function(e){e[e.VISIBLE=0]="VISIBLE",e[e.NONE=1]="NONE"}(n||(n={})),function(e){e[e.POINT=0]="POINT",e[e.LINE=1]="LINE",e[e.LINE_CENTER=2]="LINE_CENTER"}(s||(s={})),function(e){e[e.MAP=0]="MAP",e[e.VIEWPORT=1]="VIEWPORT",e[e.AUTO=2]="AUTO"}(a||(a={})),function(e){e[e.AUTO=0]="AUTO",e[e.LEFT=1]="LEFT",e[e.CENTER=2]="CENTER",e[e.RIGHT=3]="RIGHT"}(o||(o={})),function(e){e[e.CENTER=0]="CENTER",e[e.LEFT=1]="LEFT",e[e.RIGHT=2]="RIGHT",e[e.TOP=3]="TOP",e[e.BOTTOM=4]="BOTTOM",e[e.TOP_LEFT=5]="TOP_LEFT",e[e.TOP_RIGHT=6]="TOP_RIGHT",e[e.BOTTOM_LEFT=7]="BOTTOM_LEFT",e[e.BOTTOM_RIGHT=8]="BOTTOM_RIGHT"}(l||(l={})),function(e){e[e.NONE=0]="NONE",e[e.UPPERCASE=1]="UPPERCASE",e[e.LOWERCASE=2]="LOWERCASE"}(c||(c={})),function(e){e[e.MAP=0]="MAP",e[e.VIEWPORT=1]="VIEWPORT"}(h||(h={})),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(u||(u={}));class p{static{this.backgroundLayoutDefinition={visibility:{type:"enum",values:["visible","none"],default:n.VISIBLE}}}static{this.fillLayoutDefinition={visibility:{type:"enum",values:["visible","none"],default:n.VISIBLE}}}static{this.lineLayoutDefinition={visibility:{type:"enum",values:["visible","none"],default:n.VISIBLE},"line-cap":{type:"enum",values:["butt","round","square"],default:d.RL.BUTT},"line-join":{type:"enum",values:["bevel","round","miter"],default:d.AH.MITER},"line-miter-limit":{type:"number",default:2},"line-round-limit":{type:"number",default:1.05}}}static{this.symbolLayoutDefinition={visibility:{type:"enum",values:["visible","none"],default:n.VISIBLE},"symbol-avoid-edges":{type:"boolean",default:!1},"symbol-placement":{type:"enum",values:["point","line","line-center"],default:s.POINT},"symbol-sort-key":{type:"number",default:-1},"symbol-spacing":{type:"number",minimum:1,default:250},"icon-allow-overlap":{type:"boolean",default:!1},"icon-anchor":{type:"enum",values:["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"],default:l.CENTER},"icon-ignore-placement":{type:"boolean",default:!1},"icon-image":{type:"string"},"icon-keep-upright":{type:"boolean",default:!1},"icon-offset":{type:"array",value:"number",length:2,default:[0,0]},"icon-optional":{type:"boolean",default:!1},"icon-padding":{type:"number",minimum:0,default:2},"icon-rotate":{type:"number",default:0},"icon-rotation-alignment":{type:"enum",values:["map","viewport","auto"],default:a.AUTO},"icon-size":{type:"number",minimum:0,default:1},"text-allow-overlap":{type:"boolean",default:!1},"text-anchor":{type:"enum",values:["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"],default:l.CENTER},"text-field":{type:"string"},"text-font":{type:"array",value:"string",default:["Open Sans Regular","Arial Unicode MS Regular"]},"text-ignore-placement":{type:"boolean",default:!1},"text-justify":{type:"enum",values:["auto","left","center","right"],default:o.CENTER},"text-keep-upright":{type:"boolean",default:!0},"text-letter-spacing":{type:"number",default:0},"text-line-height":{type:"number",default:1.2},"text-max-angle":{type:"number",minimum:0,default:45},"text-max-width":{type:"number",minimum:0,default:10},"text-offset":{type:"array",value:"number",length:2,default:[0,0]},"text-optional":{type:"boolean",default:!1},"text-padding":{type:"number",minimum:0,default:2},"text-rotate":{type:"number",default:0},"text-rotation-alignment":{type:"enum",values:["map","viewport","auto"],default:a.AUTO},"text-size":{type:"number",minimum:0,default:16},"text-transform":{type:"enum",values:["none","uppercase","lowercase"],default:c.NONE},"text-writing-mode":{type:"array",value:"enum",values:["horizontal","vertical"],default:[u.HORIZONTAL]}}}static{this.circleLayoutDefinition={visibility:{type:"enum",values:["visible","none"],default:n.VISIBLE}}}static{this.backgroundPaintDefinition={"background-color":{type:"color",default:[0,0,0,1]},"background-opacity":{type:"number",minimum:0,maximum:1,default:1},"background-pattern":{type:"string"}}}static{this.fillPaintDefinition={"fill-antialias":{type:"boolean",default:!0},"fill-color":{type:"color",default:[0,0,0,1]},"fill-opacity":{type:"number",minimum:0,maximum:1,default:1},"fill-outline-color":{type:"color",default:[0,0,0,0]},"fill-pattern":{type:"string"},"fill-translate":{type:"array",value:"number",length:2,default:[0,0]},"fill-translate-anchor":{type:"enum",values:["map","viewport"],default:h.MAP}}}static{this.linePaintDefinition={"line-blur":{type:"number",minimum:0,default:0},"line-color":{type:"color",default:[0,0,0,1]},"line-dasharray":{type:"array",value:"number",default:[]},"line-gap-width":{type:"number",minimum:0,default:0},"line-offset":{type:"number",default:0},"line-opacity":{type:"number",minimum:0,maximum:1,default:1},"line-pattern":{type:"string"},"line-translate":{type:"array",value:"number",length:2,default:[0,0]},"line-translate-anchor":{type:"enum",values:["map","viewport"],default:h.MAP},"line-width":{type:"number",minimum:0,default:1}}}static{this.symbolPaintDefinition={"icon-color":{type:"color",default:[0,0,0,1]},"icon-halo-blur":{type:"number",minimum:0,default:0},"icon-halo-color":{type:"color",default:[0,0,0,0]},"icon-halo-width":{type:"number",minimum:0,default:0},"icon-opacity":{type:"number",minimum:0,maximum:1,default:1},"icon-translate":{type:"array",value:"number",length:2,default:[0,0]},"icon-translate-anchor":{type:"enum",values:["map","viewport"],default:h.MAP},"text-color":{type:"color",default:[0,0,0,1]},"text-halo-blur":{type:"number",minimum:0,default:0},"text-halo-color":{type:"color",default:[0,0,0,0]},"text-halo-width":{type:"number",minimum:0,default:0},"text-opacity":{type:"number",minimum:0,maximum:1,default:1},"text-translate":{type:"array",value:"number",length:2,default:[0,0]},"text-translate-anchor":{type:"enum",values:["map","viewport"],default:h.MAP}}}static{this.rasterPaintDefinition={"raster-opacity":{type:"number",minimum:0,maximum:1,default:1},"raster-hue-rotate":{type:"number",default:0},"raster-brightness-min":{type:"number",minimum:0,maximum:1,default:0},"raster-brightness-max":{type:"number",minimum:0,maximum:1,default:1},"raster-saturation":{type:"number",minimum:-1,maximum:1,default:0},"raster-contrast":{type:"number",minimum:-1,maximum:1,default:0},"raster-fade-duration":{type:"number",minimum:0,default:300}}}static{this.circlePaintDefinition={"circle-blur":{type:"number",minimum:0,default:0},"circle-color":{type:"color",default:[0,0,0,1]},"circle-opacity":{type:"number",minimum:0,maximum:1,default:1},"circle-radius":{type:"number",minimum:0,default:5},"circle-stroke-color":{type:"color",default:[0,0,0,1]},"circle-stroke-opacity":{type:"number",minimum:0,maximum:1,default:1},"circle-stroke-width":{type:"number",minimum:0,default:0},"circle-translate":{type:"array",value:"number",length:2,default:[0,0]},"circle-translate-anchor":{type:"enum",values:["map","viewport"],default:h.MAP}}}}},58783:function(e,t,i){i.d(t,{I:function(){return f}});var r=i(96373),n=i(3480),s=i(87833),a=i(73440),o=i(70880),l=i(61432),c=i(93568),h=i(17155),u=(i(96711),i(83850),i(48023));let d=class extends o.Z{constructor(e){super(e),this.computedOpacity=1,this.computedVisible=!0,this.opacity=1,this.visible=!0,this._fadeOutResolver=null,this._fadeInResolver=null}get transitioning(){return(this._fadeOutResolver||!this.visible?0:this.opacity)!==this.computedOpacity}endTransition(){this._fadeInResolver?.(),this._fadeOutResolver?.(),this._fadeInResolver=this._fadeOutResolver=null,this.computedOpacity=this.visible?this.opacity:0}fadeIn(){return this._fadeInResolver||(this.opacity=1,this.computedOpacity=0,this._fadeOutResolver?.(),this._fadeOutResolver=null,this._fadeInResolver=(0,c.hh)()),this._fadeInResolver.promise}fadeOut(){return this._fadeOutResolver||(this.opacity=0,this._fadeInResolver?.(),this._fadeInResolver=null,this._fadeOutResolver=(0,c.hh)()),this._fadeOutResolver.promise}transitionStep(e,t){const i=(0,l.Z)("mapview-transitions-duration"),r=i?1/i:0;if(0===r)this.computedOpacity=this.opacity,this.computedVisible=this.visible;else{const t=this._fadeOutResolver||!this.visible?0:this.opacity,i=this.computedOpacity;if(i===t)this.computedVisible=this.visible;else{const n=e*r;this.computedOpacity=i>t?Math.max(t,i-n):Math.min(t,i+n),this.computedVisible=this.computedOpacity>0}}this.transitioning||(this._fadeInResolver?.(),this._fadeOutResolver?.(),this._fadeOutResolver=this._fadeInResolver=null)}};(0,a._)([(0,h.Cb)()],d.prototype,"computedOpacity",void 0),(0,a._)([(0,h.Cb)()],d.prototype,"computedVisible",void 0),(0,a._)([(0,h.Cb)()],d.prototype,"opacity",void 0),(0,a._)([(0,h.Cb)()],d.prototype,"visible",void 0),(0,a._)([(0,h.Cb)()],d.prototype,"transitioning",null),(0,a._)([(0,h.Cb)()],d.prototype,"_fadeOutResolver",void 0),(0,a._)([(0,h.Cb)()],d.prototype,"_fadeInResolver",void 0),d=(0,a._)([(0,u.j)("esri.views.2d.engine.transitions.FadeTransition")],d);class p extends s.Z{constructor(){super(...arguments),this._transitionables=null,this._clips=null,this._fadeTransition=null,this._isReady=!1,this._opacity=1,this.parent=null,this._stage=null,this._visible=!0}get computedOpacity(){return this._fadeTransition?.computedOpacity??this.opacity}get clips(){return this._clips}set clips(e){this._clips=e,this.requestRender()}get fadeTransitionEnabled(){return null!==this._fadeTransition}set fadeTransitionEnabled(e){!this._fadeTransition&&e?(this._fadeTransition=new d({opacity:this.opacity,visible:this.visible}),this.addTransitionable(this._fadeTransition)):this._fadeTransition&&!e&&(this.removeTransitionable(this._fadeTransition),this._fadeTransition=null)}get inFadeTransition(){return this._fadeTransition?.transitioning??!1}get isReady(){return this._isReady}get opacity(){return this._opacity}set opacity(e){this._opacity!==e&&(this._opacity=Math.min(1,Math.max(e,0)),this._fadeTransition&&(this._fadeTransition.opacity=this._opacity),this.requestRender())}get stage(){return this._stage}set stage(e){if(this._stage===e)return;const t=this._stage;this._stage=e,e?this._stage?.untrashDisplayObject(this)||(this.onAttach(),this.emit("attach")):t?.trashDisplayObject(this)}get transforms(){return null==this._transforms&&(this._transforms=this._createTransforms()),this._transforms}get transitioning(){return this.isTransitioning()}get visible(){return this._visible}set visible(e){this._visible!==e&&(this._visible=e,this._fadeTransition&&(this._fadeTransition.visible=this._visible),this.requestRender())}get hasLabels(){return!1}get hasHighlight(){return!1}get hasBlending(){return!1}addTransitionable(e){this._transitionables??=[],this._transitionables.push(e),this.requestRender()}removeTransitionable(e){e.endTransition(),this._transitionables&&(0,n.Od)(this._transitionables,e),this.requestRender()}fadeIn(){this.fadeTransitionEnabled=!0;const e=this._fadeTransition.fadeIn();return this.opacity=1,this.requestRender(),e}fadeOut(){this.fadeTransitionEnabled=!0;const e=this._fadeTransition.fadeOut();return this.opacity=0,this.requestRender(),e}endTransitions(){if(this._transitionables){for(const e of this._transitionables)e.endTransition();this.requestRender()}}beforeRender(e){this.transitionStep(e.deltaTime,e.state.scale),this.setTransform(e.state)}afterRender(e){this.transitioning&&this.requestRender()}remove(){this.parent?.removeChild(this)}setTransform(e){}processRender(e){this.stage&&(this._fadeTransition?.computedVisible??this.visible)&&this.doRender(e)}requestRender(){this.stage&&this.stage.requestRender()}processDetach(){this.endTransitions(),this.onDetach(),this.emit("detach")}isTransitioning(){return this._transitionables?.some((e=>e.transitioning))??!1}transitionStep(e,t){if(this._transitionables)for(const i of this._transitionables)i.transitionStep(e,t)}onAttach(){}onDetach(){}doRender(e){}ready(){this._isReady||(this._isReady=!0,this.emit("isReady"),this.requestRender())}}var m=i(64544);class f extends p{constructor(e,t,i,r,n,s,a=n,o=s){super(),this.tileDebugInfoTexture=null,this.debugInfo={display:{length:0,minOrderedLength:0,minUnorderedLength:0,triangleCount:0},memory:{bytesUsed:0,bytesReserved:0}},this._destroyed=!1,this.key=new m.Z(e),this.resolution=t,this.x=i,this.y=r,this.width=n,this.height=s,this.rangeX=a,this.rangeY=o}destroy(){this.tileDebugInfoTexture&&(this.tileDebugInfoTexture.dispose(),this.tileDebugInfoTexture=null),this._destroyed=!0}get debugSlot(){let e=this;for(;e.parent!==this._stage;){if(!e.parent)return 0;e=e.parent}return this._stage.children.indexOf(e)}setTransform(e){const t=this.resolution/(e.resolution*e.pixelRatio),i=this.transforms.tileMat3,[n,s]=e.toScreenNoRotation([0,0],[this.x,this.y]),a=this.width/this.rangeX*t,o=this.height/this.rangeY*t;(0,r.t8)(i,a,0,0,0,o,0,n,s,1),(0,r.Jp)(this.transforms.displayViewScreenMat3,e.displayViewMat3,i)}get destroyed(){return this._destroyed}}},65244:function(e,t,i){i.d(t,{Z:function(){return s}});var r=i(77450),n=i(64544);class s{constructor(){this.spans=[]}static{this.pool=new r.Z(s)}acquire(e){this.lodInfo=e}release(){this.lodInfo=null,this.spans.length=0}*keys(){const e=this.lodInfo;for(const{row:t,colFrom:i,colTo:r}of this.spans)for(let s=i;s<=r;s++){const i=e.getWorldForColumn(s);yield new n.Z(e.level,t,e.normalizeCol(s),i)}}forEach(e,t){const{spans:i,lodInfo:r}=this,{level:n}=r;if(0!==i.length)for(const{row:s,colFrom:a,colTo:o}of i)for(let i=a;i<=o;i++)e.call(t,n,s,r.normalizeCol(i),r.getWorldForColumn(i))}}},71090:function(e,t,i){i.d(t,{Z:function(){return m}});var r=i(8554),n=i(64544);function s(e,t){return[e,t]}function a(e,t,i){return e[0]=t,e[1]=i,e}const o=new n.Z("0/0/0/0");class l{static create(e,t,i=null){const n=(0,r.C5)(e.spatialReference),o=t.origin||s(e.origin.x,e.origin.y),c=s(e.size[0]*t.resolution,e.size[1]*t.resolution),h=s(-1/0,-1/0),u=s(1/0,1/0),d=s(1/0,1/0);null!=i&&(a(h,Math.max(0,Math.floor((i.xmin-o[0])/c[0])),Math.max(0,Math.floor((o[1]-i.ymax)/c[1]))),a(u,Math.max(0,Math.floor((i.xmax-o[0])/c[0])),Math.max(0,Math.floor((o[1]-i.ymin)/c[1]))),a(d,u[0]-h[0]+1,u[1]-h[1]+1));const{cols:p,rows:m}=t;let f,_,g,y;return!i&&p&&m&&(a(h,p[0],m[0]),a(u,p[1],m[1]),a(d,p[1]-p[0]+1,m[1]-m[0]+1)),e.isWrappable?(f=s(Math.ceil(Math.round((n.valid[1]-n.valid[0])/t.resolution)/e.size[0]),d[1]),_=!0,g=n.origin,y=n.valid):(f=d,_=!1),new l(t.level,t.resolution,t.scale,o,h,u,d,c,f,_,g,y)}constructor(e,t,i,r,n,s,a,o,l,c,h,u){this.level=e,this.resolution=t,this.scale=i,this.origin=r,this.first=n,this.last=s,this.size=a,this.norm=o,this.worldSize=l,this.wrap=c,this._spatialReferenceOrigin=h,this._spatialReferenceValid=u}normalizeCol(e){if(!this.wrap)return e;const t=this.worldSize[0];return e<0?t-1-Math.abs((e+1)%t):e%t}normalizeKey(e){if(!this.wrap)return;const t=this.worldSize[0],i=e.col;i<0?(e.col=i+t,e.world-=1):i>=t&&(e.col=i-t,e.world+=1)}denormalizeCol(e,t){return this.wrap?this.worldSize[0]*t+e:e}getWorldForColumn(e){return this.wrap?Math.floor(e/this.worldSize[0]):0}getFirstColumnForWorld(e){return e*this.worldSize[0]+this.first[0]}getLastColumnForWorld(e){return e*this.worldSize[0]+this.first[0]+this.size[0]-1}getColumnForX(e){return(e-this.origin[0])/this.norm[0]}getXForColumn(e){const t=this.origin[0]+e*this.norm[0],i=this._spatialReferenceOrigin,r=this._spatialReferenceValid;return this.wrap&&i&&r?t===i[0]?r[0]:this.origin[0]===i[0]&&e===this.worldSize[0]?r[1]:t:t}getRowForY(e){return(this.origin[1]-e)/this.norm[1]}getYForRow(e){return this.origin[1]-e*this.norm[1]}getTileBounds(e,t,i=!1){o.set(t);const r=i?o.col:this.denormalizeCol(o.col,o.world),n=o.row;return function(e,t,i,r,n){e[0]=t,e[1]=i,e[2]=r,e[3]=n}(e,this.getXForColumn(r),this.getYForRow(n+1),this.getXForColumn(r+1),this.getYForRow(n)),e}getTileCoords(e,t,i=!1){o.set(t);const r=i?o.col:this.denormalizeCol(o.col,o.world);return Array.isArray(e)?a(e,this.getXForColumn(r),this.getYForRow(o.row)):(e.x=this.getXForColumn(r),e.y=this.getYForRow(o.row)),e}}var c=i(65244);class h{constructor(e,t,i){this.row=e,this.colFrom=t,this.colTo=i}}const u=new n.Z("0/0/0/0");class d{static create(e,t){e[1]>t[1]&&([e,t]=[t,e]);const[i,r]=e,[n,s]=t,a=n-i,o=s-r,l=0!==o?a/o:0,c=(Math.ceil(r)-r)*l,h=(Math.floor(r)-r)*l;return new d(i,Math.floor(r),Math.ceil(s),l,a<0?c:h,a<0?h:c,a<0?n:i,a<0?i:n)}constructor(e,t,i,r,n,s,a,o){this.x=e,this.ymin=t,this.ymax=i,this.invM=r,this.leftAdjust=n,this.rightAdjust=s,this.leftBound=a,this.rightBound=o}incrRow(){this.x+=this.invM}getLeftCol(){return Math.max(this.x+this.leftAdjust,this.leftBound)}getRightCol(){return Math.min(this.x+this.rightAdjust,this.rightBound)}}const p=[[0,0],[0,0],[0,0],[0,0]];class m{constructor(e,t=null,i=e.lods[0].level,r=e.lods[e.lods.length-1].level){this.tileInfo=e,this.fullExtent=t,this.scales=[],this._infoByScale={},this._infoByLevel={};const n=e.lods.filter((e=>e.level>=i&&e.level<=r));this.minScale=n[0].scale,this.maxScale=n[n.length-1].scale;const s=this._lodInfos=n.map((i=>l.create(e,i,t)));n.forEach(((e,t)=>{this._infoByLevel[e.level]=s[t],this._infoByScale[e.scale]=s[t],this.scales[t]=e.scale}),this),this._wrap=e.isWrappable}get spatialReference(){return this.tileInfo.spatialReference}getLODInfoAt(e){return this._infoByLevel["number"==typeof e?e:e.level]}getTileBounds(e,t,i=!1){u.set(t);const r=this._infoByLevel[u.level];return r?r.getTileBounds(e,u,i):e}getTileCoords(e,t,i=!1){u.set(t);const r=this._infoByLevel[u.level];return r?r.getTileCoords(e,u,i):e}getTileCoverage(e,t=192,i=!0,r="closest"){if(!i&&(e.scale>this.minScale||e.scale<this.maxScale))return null;const n="closest"===r?this.getClosestInfoForScale(e.scale):this.getSmallestInfoForScale(e.scale),s=c.Z.pool.acquire(n),a=this._wrap;let o,l,u,m=1/0,f=-1/0;const _=s.spans;p[0][0]=p[0][1]=p[1][1]=p[3][0]=-t,p[1][0]=p[2][0]=e.size[0]+t,p[2][1]=p[3][1]=e.size[1]+t;for(const t of p)e.toMap(t,t),t[0]=n.getColumnForX(t[0]),t[1]=n.getRowForY(t[1]);const g=[];let y=3;for(let e=0;e<4;e++){if(p[e][1]===p[y][1]){y=e;continue}const t=d.create(p[e],p[y]);m=Math.min(t.ymin,m),f=Math.max(t.ymax,f),void 0===g[t.ymin]&&(g[t.ymin]=[]),g[t.ymin].push(t),y=e}if(null==m||null==f||f-m>100)return null;let v=[];for(o=m;o<f;){null!=g[o]&&(v=v.concat(g[o])),l=1/0,u=-1/0;for(let e=v.length-1;e>=0;e--){const t=v[e];l=Math.min(l,t.getLeftCol()),u=Math.max(u,t.getRightCol())}if(l=Math.floor(l),u=Math.floor(u),o>=n.first[1]&&o<=n.last[1])if(a)if(n.size[0]<n.worldSize[0]){const e=Math.floor(u/n.worldSize[0]);for(let t=Math.floor(l/n.worldSize[0]);t<=e;t++)_.push(new h(o,Math.max(n.getFirstColumnForWorld(t),l),Math.min(n.getLastColumnForWorld(t),u)))}else _.push(new h(o,l,u));else l>n.last[0]||u<n.first[0]||(l=Math.max(l,n.first[0]),u=Math.min(u,n.last[0]),_.push(new h(o,l,u)));o+=1;for(let e=v.length-1;e>=0;e--){const t=v[e];t.ymax>=o?t.incrRow():v.splice(e,1)}}return s}getTileParentId(e){u.set(e);const t=this._infoByLevel[u.level],i=this._lodInfos.indexOf(t)-1;return i<0?null:(this._getTileIdAtLOD(u,this._lodInfos[i],u),u.id)}getTileResolution(e){const t=this._infoByLevel["object"==typeof e?e.level:e];return t?t.resolution:-1}getTileScale(e){const t=this._infoByLevel[e.level];return t?t.scale:-1}intersects(e,t){u.set(t);const i=this._infoByLevel[u.level],r=e.lodInfo;if(r.resolution>i.resolution){this._getTileIdAtLOD(u,r,u);const t=r.denormalizeCol(u.col,u.world);for(const i of e.spans)if(i.row===u.row&&i.colFrom<=t&&i.colTo>=t)return!0}if(r.resolution<i.resolution){const[t,n,s,a]=e.spans.reduce(((e,t)=>(e[0]=Math.min(e[0],t.row),e[1]=Math.max(e[1],t.row),e[2]=Math.min(e[2],t.colFrom),e[3]=Math.max(e[3],t.colTo),e)),[1/0,-1/0,1/0,-1/0]),o=i.denormalizeCol(u.col,u.world),l=r.getColumnForX(i.getXForColumn(o)),c=r.getRowForY(i.getYForRow(u.row)),h=r.getColumnForX(i.getXForColumn(o+1))-1,d=r.getRowForY(i.getYForRow(u.row+1))-1;return!(l>a||h<s||c>n||d<t)}const n=r.denormalizeCol(u.col,u.world);return e.spans.some((e=>e.row===u.row&&e.colFrom<=n&&e.colTo>=n))}normalizeBounds(e,t,i){if(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],this._wrap){const t=(0,r.C5)(this.tileInfo.spatialReference),n=-i*(t.valid[1]-t.valid[0]);e[0]+=n,e[2]+=n}return e}getSmallestInfoForScale(e){const t=this.scales;if(this._infoByScale[e])return this._infoByScale[e];if(e>t[0])return this._infoByScale[t[0]];for(let i=1;i<t.length-1;i++)if(e>t[i]+1e-6)return this._infoByScale[t[i-1]];return this._infoByScale[t[t.length-1]]}getClosestInfoForScale(e){const t=this.scales;return this._infoByScale[e]||(e=t.reduce(((t,i)=>Math.abs(i-e)<Math.abs(t-e)?i:t),t[0])),this._infoByScale[e]}scaleToLevel(e){const t=this.scales;if(this._infoByScale[e])return this._infoByScale[e].level;for(let i=t.length-1;i>=0;i--)if(e<t[i])return i===t.length-1?this._infoByScale[t[t.length-1]].level:this._infoByScale[t[i]].level+(t[i]-e)/(t[i]-t[i+1]);return this._infoByScale[t[0]].level}scaleToZoom(e){return this.tileInfo.scaleToZoom(e)}zoomToScale(e){return this.tileInfo.zoomToScale(e)}_getTileIdAtLOD(e,t,i){const r=this._infoByLevel[i.level];return e.set(i),t.resolution<r.resolution?null:(t.resolution===r.resolution||(e.level=t.level,e.col=Math.floor(i.col*r.resolution/t.resolution+.01),e.row=Math.floor(i.row*r.resolution/t.resolution+.01)),e)}}},64544:function(e,t,i){i.d(t,{Z:function(){return n}});var r=i(77450);class n{static{this.pool=new r.Z(n,null,null,25,50)}static getId(e,t,i,r){return"object"==typeof e?`${e.level}/${e.row}/${e.col}/${e.world}`:`${e}/${t}/${i}/${r}`}constructor(e,t,i,r){this.set(e,t,i,r)}get key(){return this}get id(){return this.toString()}get normalizedId(){return`${this.level}/${this.row}/${this.col}`}set id(e){this.set(e)}get hash(){const e=4095&this.row,t=4095&this.col,i=63&this.level;return(3&this.world)<<30|t<<22|e<<8|i}acquire(e,t,i,r){this.set(e,t,i,r)}contains(e){const t=e.level-this.level;return t>=0&&this.row===e.row>>t&&this.col===e.col>>t&&this.world===e.world}containsChild(e){const t=e.level-this.level;return t>0&&this.row===e.row>>t&&this.col===e.col>>t&&this.world===e.world}equals(e){return this.level===e.level&&this.row===e.row&&this.col===e.col&&this.world===e.world}clone(){return new n(this)}release(){this.level=0,this.row=0,this.col=0,this.world=0}set(e,t,i,r){if(null==e)this.level=0,this.row=0,this.col=0,this.world=0;else if("object"==typeof e)this.level=e.level||0,this.row=e.row||0,this.col=e.col||0,this.world=e.world||0;else if("string"==typeof e){const[t,i,r,n]=e.split("/");this.level=parseFloat(t),this.row=parseFloat(i),this.col=parseFloat(r),this.world=parseFloat(n)}else this.level=+e,this.row=+t,this.col=+i,this.world=+r||0;return this}toString(){return`${this.level}/${this.row}/${this.col}/${this.world}`}getParentKey(){return this.level<=0?null:new n(this.level-1,this.row>>1,this.col>>1,this.world)}getNormalizedNeighbor(e,t,i){const r=this.clone();return r.col+=e,r.row+=t,i.normalizeKey(r),r}getChildKeys(){const e=this.level+1,t=this.row<<1,i=this.col<<1,r=this.world;return[new n(e,t,i,r),new n(e,t,i+1,r),new n(e,t+1,i,r),new n(e,t+1,i+1,r)]}compareRowMajor(e){return this.row<e.row?-1:this.row>e.row?1:this.col<e.col?-1:this.col>e.col?1:0}}},85600:function(e,t,i){var r=i(73440),n=i(70880),s=i(79577),a=i(61100),o=i(74355),l=i(17155),c=(i(61432),i(96711),i(83850),i(48023)),h=i(26821),u=i(75015);const d=[0,0];let p=class extends n.Z{constructor(e){super(e),this._keyToItem=new Map,this._tilesByScale=new Map,this.concurrency=6}initialize(){const{concurrency:e,process:t,scheduler:i,priority:r}=this;this._queue=new u.c({concurrency:e,scheduler:i,priority:r,process:(e,i)=>{const r=this._keyToItem.get(e);return t(r,{signal:i})},peeker:e=>this._peek(e)})}destroy(){this.clear(),this._queue=(0,a.SC)(this._queue)}get length(){return this._queue?this._queue.length:0}abort(e){const t="string"==typeof e?e:e.id;this._queue.abort(t)}clear(){this._queue.clear(),this._keyToItem.clear(),this._tilesByScale.clear()}has(e){return"string"==typeof e?this._keyToItem.has(e):this._keyToItem.has(e.id)}pause(){this._queue.pause()}push(e){const t=e.key.id;if(this._queue.has(t))return this._queue.get(t);const i=this._queue.push(t),r=this.tileInfoView.getTileScale(e.key),n=(0,s.s1)(this._tilesByScale,r,(()=>new Set)),a=()=>{n.delete(e.key),0===n.size&&this._tilesByScale.delete(r),this._keyToItem.delete(t)};return n.add(e.key),this._keyToItem.set(t,e),i.then(a,a),i}reset(){this._queue.reset()}resume(){this._queue.resume()}_peek(e){if(!this.state)return e.values().next().value;const t=new Set;for(const i of e)t.add(this._keyToItem.get(i).key);const i=this.state.scale;let r,n=Number.POSITIVE_INFINITY;for(const[e,s]of this._tilesByScale)if((0,o.fn)(s,(e=>t.has(e)))){const t=Math.abs(e-i);t<n&&(r=s,n=t)}return this._getClosestTileKey(r,e).id}_getClosestTileKey(e,t){const i=this.tileInfoView,r=this.state.center;let n,s=Number.POSITIVE_INFINITY;for(const a of e)if(t.has(a.id)){i.getTileCoords(d,a);const e=(0,h.TE)(d,r);e<s&&(s=e,n=a)}return n}};(0,r._)([(0,l.Cb)({constructOnly:!0})],p.prototype,"concurrency",void 0),(0,r._)([(0,l.Cb)({constructOnly:!0})],p.prototype,"priority",void 0),(0,r._)([(0,l.Cb)({constructOnly:!0})],p.prototype,"process",void 0),(0,r._)([(0,l.Cb)({constructOnly:!0})],p.prototype,"scheduler",void 0),(0,r._)([(0,l.Cb)()],p.prototype,"state",void 0),(0,r._)([(0,l.Cb)({constructOnly:!0})],p.prototype,"tileInfoView",void 0),p=(0,r._)([(0,c.j)("esri.views.2d.tiling.TileQueue")],p)},13772:function(e,t,i){i(47566),i(26821);i(65244);new(i(64544).Z)(0,0,0,0),new Map},87224:function(e,t,i){function r(e,t,i,r){const n=3*e,s=3*(i-e)-n,a=1-n-s,o=3*t,l=3*(r-t)-o,c=1-o-l;function h(e){return((a*e+s)*e+n)*e}function u(e){return(3*a*e+2*s)*e+n}return function(e,t=1e-6){return function(e){return((c*e+l)*e+o)*e}(function(e,t){let i,r,n,s,a,o;for(n=e,o=0;o<8;o++){if(s=h(n)-e,Math.abs(s)<t)return n;if(a=u(n),Math.abs(a)<1e-6)break;n-=s/a}if(i=0,r=1,n=e,n<i)return i;if(n>r)return r;for(;i<r;){if(s=h(n),Math.abs(s-e)<t)return n;e>s?i=n:r=n,n=.5*(r-i)+i}return n}(e,t))}}i.d(t,{LI:function(){return n},n_:function(){return r}});const n={};n.ease=r(.25,.1,.25,1),n.linear=r(0,0,1,1),n.easeIn=n["ease-in"]=r(.42,0,1,1),n.easeOut=n["ease-out"]=r(0,0,.58,1),n.easeInOut=n["ease-in-out"]=r(.42,0,.58,1)},97750:function(e,t,i){i.d(t,{dP:function(){return d},lM:function(){return h},wH:function(){return u}});var r=i(24910),n=i(82846),s=i(47925),a=i(47566),o=i(48636),l=i(65001),c=i(92490);function h(e,t,i,r){return null!=e.renderCoordsHelper.fromRenderCoords(t.eye,f,r)&&(0,a.BD)(i,f)}function u(e,t){return e.elevationProvider?e.elevationProvider.getElevation(t[0],t[1],t[2],e.renderCoordsHelper.spatialReference,"ground")??0:0}function d(e,t,i,n){const a=e.state.camera.clone();t&&i&&n&&(a.eye=t,a.center=i,a.up=n),function(e,t,i){let n=m[e.viewingMode];n||(n=new c.r(e.state.viewingMode),n.options.backfacesTerrain=!e.state.isGlobal,n.options.invisibleTerrain=!0,m[e.viewingMode]=n);const{isGlobal:a}=e.state;return!(!e.sceneIntersectionHelper.intersectRay(t,n,i)||p(e,t.origin,i))||!(!e.renderCoordsHelper.intersectManifold(t,0,i)||p(e,t.origin,i))||!!a&&function(e,t,i){const n=(0,r.e)(e.origin,e.origin)-i*i,s=n>0?Math.sqrt(n)/3:1;return(0,r.g)(t,e.direction,s/(0,r.l)(e.direction)),(0,r.f)(t,t,e.origin),!0}(t,i,(0,s.Iu)(e.spatialReference).radius)}(e,a.ray,_)||(0,r.c)(_,a.center);const o=e.state.constraints,l=o.minimumPoiDistance;if((0,r.s)(a.eye,_)<l){const t=o.collision.enabled;(0,r.c)(g,a.viewForward),(0,r.g)(g,g,l),t?a.eye=(0,r.d)(f,_,g):(0,r.f)(_,a.eye,g);const i=e.renderCoordsHelper,n=i.getAltitude(a.eye),s=o.collision.elevationMargin;t&&n<s&&((0,r.d)(g,_,a.eye),a.eye=i.setAltitude(f,s,a.eye),(0,r.f)(_,a.eye,g))}return a.center=_,a}function p(e,t,i){if(!e.state.isGlobal||!e.stateManager.constraintsManager)return!1;const n=u(e,t),s=e.stateManager.constraintsManager.nearFarHeuristic;let a=y.get(e);void 0===a&&(a=new o.Z,y.set(e,a)),a.eye=t,a.center=i;const{far:c}=s.compute(a,e.renderDataExtent,l.P.infinite,n),h=c*c;return(0,r.s)(t,i)>h}const m={},f=(0,n.Ue)(),_=(0,n.Ue)(),g=(0,n.Ue)(),y=new WeakMap},37132:function(e,t,i){i.d(t,{G:function(){return u},o:function(){return h}});var r=i(41788),n=i(27583),s=i(21414),a=i(19155),o=i(2013),l=i(48857),c=i(74826);class h extends c.K{constructor(){super(...arguments),this.radii=(0,r.Ue)(),this.heightParameters=(0,n.Ue)()}}function u(e){e.uniforms.add(new a.A("radii",(e=>e.radii)),new o.N("heightParameters",(e=>e.heightParameters))),e.constants.add("scaleHeight","float",s.sv.scaleHeight*s.sv.atmosphereHeight),e.code.add(l.H`float chapmanApproximation(float thickness, float height, float cosZenith) {
float c = sqrt(thickness + height);
float cExpH = c * exp(-height);
if (cosZenith >= 0.0) {
return cExpH / (c * cosZenith + 1.0);
} else {
float x0 = sqrt(1.0 - cosZenith * cosZenith) * (thickness + height);
float c0 = sqrt(x0);
return 2.0 * c0 * exp(thickness - x0) - cExpH / (1.0 - c * cosZenith);
}
}`),e.code.add(l.H`float getOpticalDepth(vec3 position, vec3 dir, float h) {
return scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h, dot(normalize(position), dir));
}`),e.code.add(l.H`vec4 planetIntersect(vec3 cameraPos, vec3 rayDir) {
float reducedPlanetRadius = radii[0] - 20000.0;
float rayPlanetDistance = heightParameters[1] - reducedPlanetRadius * reducedPlanetRadius;
vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, rayPlanetDistance);
vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, heightParameters[2]);
bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;
bool insideAtmosphere = heightParameters[0] < radii[1];
if (!(hitsAtmosphere || insideAtmosphere)) {
return vec4(1.0, 0.0, 0.0, 0.0);
}
bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;
float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;
if (heightParameters[0] < reducedPlanetRadius) {
if (dot(rayDir, normalize(cameraPos)) < -0.025) {
return vec4(1.0, 0.0, 0.0, 0.0);
}
start = rayPlanetIntersect.y;
}
float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;
return vec4(0.0, hitsPlanet ? 1.0 : 0.0, start, end);
}`)}},1824:function(e,t,i){i.d(t,{t:function(){return o}});var r=i(78037),n=i(37132),s=i(87688),a=i(48857);function o(e,t){e.include(n.G);e.uniforms.add(new s.d("cameraPosition",(e=>e.camera.eye))),e.constants.add("betaRayleigh","vec3",r.aM),e.constants.add("betaCombined","vec3",r.nB),e.constants.add("betaMie","float",r.th),e.code.add(a.H`
    vec3 raymarchAtmosphere(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {
      vec4 ray = planetIntersect(cameraPos, rayDir);
      if(ray.x == 1.0) {
        return vec3(0);
      }
      ${(0,a.If)(t,"if (terrainDepth != -1.0) { ray.w = terrainDepth; }")}

      vec3 samplePoint = cameraPos + rayDir * ray.w;
      float multiplier = ray.y == 1.0 ? -1.0 : 1.0;

      vec3 scattering = vec3(0);
      float scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
      float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir, scaleFract);
      float stepSize = (ray.w - ray.z) / ${a.H.float(6)};

      for (int i = 0; i < ${a.H.int(6)}; i++) {
        samplePoint -= stepSize * rayDir;
        scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
        float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier, scaleFract);

        if (i > 0) {
          scattering *= exp(-(mix(betaCombined, betaRayleigh, 0.5) + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));
          ${(0,a.If)(!t,"scattering *= mix(2.5, 1.0, clamp((length(cameraPos) - radii[0]) / 50e3, 0.0, 1.0))")};
        }

        if (dot(normalize(samplePoint), lightDir) > -0.3) {
          float scale = exp(-scaleFract);
          float lightDepth = getOpticalDepth(samplePoint, lightDir, scaleFract);
          scattering += scale * exp(-(betaCombined + betaMie) * lightDepth);
          ${(0,a.If)(!t,"scattering += scale * exp(-(0.25 * betaCombined ) * lightDepth);")}
        }
        lastOpticalDepth = opticalDepth;
      }

      float mu = dot(rayDir, lightDir);
      float mumu = 1.0 + mu * mu;

      float phaseRayleigh = 0.0596831 * mumu;
      ${t?"return 3.0 * scattering * stepSize * phaseRayleigh * betaRayleigh;":a.H`const float g = 0.8;
             const float gg = g * g;
             float phaseMie = 0.1193662 * ((1.0 - gg) * mumu) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg));
             phaseMie = clamp(phaseMie, 0.0, 128.0);
             return 3.0 * scattering * stepSize * (phaseRayleigh * betaRayleigh + 0.025 * phaseMie * betaMie);`}
    }`)}},85382:function(e,t,i){i.d(t,{p:function(){return r},t:function(){return o}});var r,n=i(73440),s=i(41629),a=i(83046);!function(e){e[e.SIXTEEN=0]="SIXTEEN",e[e.HUNDRED=1]="HUNDRED",e[e.TWOHUNDRED=2]="TWOHUNDRED",e[e.COUNT=3]="COUNT"}(r||(r={}));class o extends a.m{constructor(){super(...arguments),this.steps=r.SIXTEEN,this.writeTextureChannels=s.uz.RG}}(0,n._)([(0,a.o)({count:r.COUNT})],o.prototype,"steps",void 0),(0,n._)([(0,a.o)({count:s.uz.COUNT})],o.prototype,"writeTextureChannels",void 0)},80461:function(e,t,i){i.d(t,{i:function(){return a},u:function(){return r}});var r,n=i(73440),s=i(83046);!function(e){e[e.Full=0]="Full",e[e.WeatherMap=1]="WeatherMap",e[e.COUNT=2]="COUNT"}(r||(r={}));class a extends s.m{constructor(){super(...arguments),this.mode=r.Full}}(0,n._)([(0,s.o)({count:r.COUNT})],a.prototype,"mode",void 0)},23625:function(e,t,i){i.d(t,{CB:function(){return s},H6:function(){return c},JK:function(){return l},Mw:function(){return n},a5:function(){return a},i9:function(){return r},r7:function(){return o}});const r=(0,i(61432).Z)("esri-mobile")?64:128,n=r/128,s=Math.ceil(Math.sqrt(r)),a=(r+2)*s,o=1e5,l=128,c=a/1560},22567:function(e,t,i){i.d(t,{H:function(){return r},Y:function(){return a}});var r,n=i(73440),s=i(83046);!function(e){e[e.Rain=0]="Rain",e[e.Snow=1]="Snow",e[e.COUNT=2]="COUNT"}(r||(r={}));class a extends s.m{constructor(){super(...arguments),this.type=r.Rain}}(0,n._)([(0,s.o)({count:r.COUNT})],a.prototype,"type",void 0)},35286:function(e,t,i){i.d(t,{f:function(){return o},n:function(){return r}});var r,n=i(73440),s=i(83046),a=i(91041);!function(e){e[e.Cone=0]="Cone",e[e.Cylinder=1]="Cylinder",e[e.Underground=2]="Underground",e[e.COUNT=3]="COUNT"}(r||(r={}));class o extends a.W{constructor(){super(...arguments),this.geometry=r.Cone}}(0,n._)([(0,s.o)({count:r.COUNT})],o.prototype,"geometry",void 0)},74558:function(e,t,i){i.d(t,{Z:function(){return u}});var r,n=i(73440),s=i(87833),a=i(17155),o=(i(61432),i(96711),i(83850),i(48023)),l=i(17733);let c=r=class extends(s.Z.EventedMixin(l.Z)){constructor(e){super(e),this.cameraTrackingEnabled=!0,this.positionTimezoneInfo={hours:0,minutes:0,seconds:0,autoUpdated:!0};const t=(new Date).getFullYear(),i=new Date("March 15, "+t+" 12:00:00 UTC");this._set("defaultDate",i),this._set("date",i)}get defaultDate(){return new Date(this._get("defaultDate").getTime())}static fromWebsceneLighting(e){return new r(e.cloneConstructProperties())}set defaultDate(e){const t=this._get("date")===this._get("defaultDate");e=new Date(e.getTime()),this._set("defaultDate",e),t&&this._set("date",e)}set date(e){null!=e&&(this.positionTimezoneInfo.autoUpdated=!1,this._set("date",new Date(e.getTime())))}autoUpdate(e,t){const i=r.calculateTimezoneOffset(this.positionTimezoneInfo);this.positionTimezoneInfo.hours=t.hours,this.positionTimezoneInfo.minutes=t.minutes,this.positionTimezoneInfo.seconds=t.seconds;let n=null;null!=e&&(this.positionTimezoneInfo.autoUpdated=!0,isNaN(e.getTime())?(n=this.defaultDate.getTime(),this._set("date",this.defaultDate)):(n=this.date&&this.date.getTime(),this._set("date",new Date(e.getTime()))));const s=r.calculateTimezoneOffset(this.positionTimezoneInfo);if(i!==s&&(h.target=this,h.timezoneOffset=s,this.emit("timezone-will-change",h),h.target=null),null!=e)return isNaN(e.getTime())||n!==e.getTime()}clone(){const e=this._get("date")===this._get("defaultDate"),t=new r({...this.cloneConstructProperties(),defaultDate:this.defaultDate,cameraTrackingEnabled:this.cameraTrackingEnabled});return e&&t._set("date",t._get("defaultDate")),t.positionTimezoneInfo.autoUpdated=this.positionTimezoneInfo.autoUpdated,t.positionTimezoneInfo.hours=this.positionTimezoneInfo.hours,t.positionTimezoneInfo.minutes=this.positionTimezoneInfo.minutes,t.positionTimezoneInfo.seconds=this.positionTimezoneInfo.seconds,t}cloneWithWebsceneLighting(e){const t=this.clone();return null!=e.date&&(t.date=e.date),t.directShadowsEnabled=e.directShadowsEnabled,t.displayUTCOffset=e.displayUTCOffset,t}cloneNonPersistentConstructProperties(){return{cameraTrackingEnabled:this.cameraTrackingEnabled}}};(0,n._)([(0,a.Cb)({type:Boolean})],c.prototype,"cameraTrackingEnabled",void 0),(0,n._)([(0,a.Cb)({type:Date})],c.prototype,"defaultDate",null),(0,n._)([(0,a.Cb)({type:Date})],c.prototype,"date",null),c=r=(0,n._)([(0,o.j)("esri.views.3d.environment.SunLighting")],c),function(e){e.calculateTimezoneOffset=function({hours:e,minutes:t,seconds:i}){return Math.round(e+t/60+i/3600)}}(c||(c={}));const h={target:null,timezoneOffset:0},u=c},24127:function(e,t,i){i.d(t,{Z:function(){return h}});var r,n=i(73440),s=i(87833),a=i(17155),o=(i(61432),i(96711),i(83850),i(48023)),l=i(83946);let c=r=class extends(s.Z.EventedMixin(l.Z)){constructor(e){super(e),this.cameraTrackingEnabled=!0}clone(){return new r({...this.cloneConstructProperties(),cameraTrackingEnabled:this.cameraTrackingEnabled})}static fromWebsceneLighting(e){return new r(e.cloneConstructProperties())}cloneWithWebsceneLighting(e){const t=this.clone();return t.directShadowsEnabled=e.directShadowsEnabled,t}cloneNonPersistentConstructProperties(){return{cameraTrackingEnabled:this.cameraTrackingEnabled}}};(0,n._)([(0,a.Cb)({type:Boolean})],c.prototype,"cameraTrackingEnabled",void 0),c=r=(0,n._)([(0,o.j)("esri.views.3d.environment.VirtualLighting")],c);const h=c},78037:function(e,t,i){i.d(t,{Tk:function(){return l},aM:function(){return c},mP:function(){return a},nB:function(){return d},th:function(){return u},yx:function(){return s}});var r=i(99574),n=i(82846);function s(e){return(0,r.uZ)((e-a)/(o-a),0,1)}const a=1e5,o=1e6,l=1e4,c=(0,n.al)(parseFloat(Number(5802e-9).toFixed(6)),parseFloat(Number(13558e-9).toFixed(6)),parseFloat(Number(331e-7).toFixed(6))),h=(0,n.al)(3*parseFloat(Number(65e-8).toFixed(6)),3*parseFloat(Number(1881e-9).toFixed(6)),3*parseFloat(Number(85e-9).toFixed(6))),u=3996e-9,d=(0,n.al)(parseFloat(Number(c[0]+h[0]).toFixed(6)),parseFloat(Number(c[1]+h[1]).toFixed(6)),parseFloat(Number(c[2]+h[2]).toFixed(6)))},23195:function(e,t,i){i.d(t,{JF:function(){return l},WM:function(){return c},mq:function(){return h}});var r=i(88194),n=i(38700);let s,a=null;const o=new Map;async function l(e){null==a&&(null==s&&(s=i.e(26809).then(i.bind(i,26809))),a=await s);const t=e.view;let l=o.get(t);l||(l=new a.default({view:t}),o.set(t,l));const c=!!t.stage.renderView.renderingContext.capabilities.compressedTextureS3TC,h=!!t.stage.renderView.renderingContext.capabilities.compressedTextureETC;await l.initializeWasm(c,h);const u=l.add3DTilesLayerView(e);if(u.wasmLayerId<0)throw l.getValidLayerViewCount()<1&&(o.delete(t),0===o.size&&(s=null,a=null)),u.wasmLayerId===n.Em?new r.Z("tiles3d:addLayer-failure","The 3d tiles layer web assembly module failed to download.",{}):new r.Z("tiles3d:addLayer-failure",u.check?.errorDescription??"The 3d tiles layer description was invalid.",{});return u.wasmLayerId}function c(e){return o.get(e)}function h(e){const t=e.view,i=o.get(t);i&&i.remove3DTilesLayerView(e)<1&&(o.delete(t),0===o.size&&(s=null,a=null))}},23555:function(e,t,i){i.d(t,{$L:function(){return o},JF:function(){return a},mq:function(){return l}});let r,n=null;const s=new Map;async function a(e){null==n&&(null==r&&(r=i.e(70558).then(i.bind(i,70558))),n=await r);const t=e.view;let a=s.get(t);return a||(a=new n.default({view:t}),s.set(t,a)),a.addVoxelLayer(e)}function o(e){return s.get(e)}function l(e){const t=e.view,i=s.get(t);i&&i.removeVoxelLayer(e)<1&&(s.delete(t),0===s.size&&(r=null,n=null))}},62640:function(e,t,i){i.d(t,{S:function(){return X},C:function(){return te}});var r=i(73440),n=i(70880),s=i(29292),a=(i(61432),i(96711)),o=i(61100),l=i(93568),c=i(90403),h=i(17155),u=(i(83850),i(48023)),d=i(41788),p=i(74774),m=i(10813),f=i(75970),_=i(10841),g=i(80139),y=i(25136),v=i(19269),b=i(26834);function w(e){return e instanceof b.l?e.graphics3DSymbol:e instanceof v.q?e:null}var C=i(24910),x=i(82846),T=i(16447),S=i(47451),M=i(91896),E=i(84262),P=i(3970);const R=()=>a.Z.getLogger("esri.views.3d.layers.graphics.labelPlacement");class A{constructor(e,t,i,r=null){this._graphic=e,this._symbol=t,this._class=i,this._disablePlacement=r}get placement(){const e=this._verticalOffsetPlacement;if(null==e)return null;const t=this._getPlacementInfo(e);if(null==t)return null;const i=t.anchor,r=!!e.hasLabelVerticalOffset,n=e.verticalOffset,s=new M.a(n,i,r);return this._calculatePlacementOffsets(s,t)}get _verticalOffsetPlacement(){const e=this._class.labelPlacement,{_symbol:t,_graphic:i}=this,r=w(i.graphics3DSymbol),n="point-3d"===r?.symbol.type?r.symbol:null,s=I[e]||this._defaultPlacementInfo;return n?.supportsCallout()&&n.hasVisibleVerticalOffset()&&!i.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:n.verticalOffset.clone(),anchor:null,normalizedOffset:null}:!t?.hasVisibleVerticalOffset()||null!=n&&n.supportsCallout()&&n.verticalOffset&&!i.isDraped?{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}:s&&function(e){return"above-center"===e}(s.placement)?{placement:"above-center",verticalOffset:t.verticalOffset.clone(),anchor:"bottom",normalizedOffset:[0,s.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(R().errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+e+" placement)"),null)}_getPlacementInfo(e){if(e.anchor)return e;const t=this._class.labelPlacement,i=I[t],r=i||this._defaultPlacementInfo;return t&&!i&&R().warnOnce(`the requested label placement '${t}' is currently unsupported in SceneView.`),this._validatePlacementInfo(r)}_calculatePlacementOffsets(e,t){const i=this._graphic.graphic.geometry;if(null==i)return null;switch(i.type){case"point":this._setPointSpecificPlacement(e,t);break;case"mesh":this._setMeshSpecificPlacement(e,t);break;case"polygon":this._setPolygonSpecificPlacement(e,t)}const r=S.aT-E.Wg;return e.screenOffset[0]+=r*t.normalizedOffset[0],e.screenOffset[1]+=r*t.normalizedOffset[1],e}get _defaultPlacementInfo(){const e=this._graphic.graphic.geometry;if(null==e)return null;switch(e.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:x.AG,anchor:"center"};case"polygon":return"extrude"===this._firstSymbolLayer?.type?I["above-center"]:{placement:"center-center",normalizedOffset:x.AG,anchor:"center"};case"point":case"mesh":return I["above-center"];default:return}}_validatePlacementInfo(e){const t=this._graphic.graphic.geometry;if(null==t)return null;if(null!=this._disablePlacement){const t=this._class.labelPlacement;return t?(R().warnOncePerTick(O(t,this._disablePlacement.logEntityDescription)),this._defaultPlacementInfo):e}const i=t.type;switch(i){case"polyline":case"polygon":case"extent":case"multipoint":{const e=this._class.labelPlacement;if(e)return I[e]&&R().warnOnce(O(e,`'${i}' geometries`)),this._defaultPlacementInfo;break}case"point":case"mesh":return e}return e}_setPointSpecificPlacement(e,t){const i=this._firstSymbolLayer;if(null==i)return;const r=this._graphic.layers[0];switch(null!=r?r.getCenterObjectSpace(e.translation):(0,C.i)(e.translation,0,0,0),i.type){case"icon":case"text":this._setHUDSpecificPlacement(e,t,r);break;case"object":D(e,t,r)}}_setMeshSpecificPlacement(e,t){const i=this._firstSymbolLayer;null!=i&&"fill"===i.type&&D(e,t,this._graphic.layers[0])}_setPolygonSpecificPlacement(e,t){const i=this._firstSymbolLayer;if(null!=i)switch(i.type){case"extrude":{const i=this._graphic.layers[0];null!=i?(i.getBoundingBoxObjectSpace(F),(0,T.be)(F,e.translation),e.translation[2]=(0,T.Cb)(F)/2):(0,C.i)(e.translation,0,0,0),D(e,t,i);break}}}_setHUDSpecificPlacement(e,t,i){const{_graphic:r}=this,n=null!=i?i.getScreenSize():null;if(r.isDraped||null==n)e.hasLabelVerticalOffset||"center"===e.anchor||(I[this._class.labelPlacement]&&R().warnOncePerTick(`the requested placement '${t.placement}' is currently unsupported for draped graphics`),e.anchor="center");else{const i=this._normalizedSymbolAnchorPos;e.screenOffset[0]=n[0]/2*(t.normalizedOffset[0]-i[0]);const r=n[1]/2*(t.normalizedOffset[1]-i[1]);e.hasLabelVerticalOffset?(e.centerOffset[1]=r,e.centerOffsetUnits="screen"):e.screenOffset[1]=r}}get _firstSymbolLayer(){const e=w(this._graphic.graphics3DSymbol);return null!=e?e.symbol.symbolLayers.at(0):null}get _normalizedSymbolAnchorPos(){const e=this._graphic.layers[0]?.stageObject.geometries[0].material??null;if(e&&e instanceof P.A){const t=e.parameters.anchorPosition;N[0]=2*(t[0]-.5),N[1]=2*(t[1]-.5)}else N[0]=0,N[1]=0;return N}}function O(e,t){return`the requested label placement '${e}' is currently unsupported for ${t} in SceneView.`}function D(e,t,i){const r=null!=i?i.getBoundingBoxObjectSpace(F):F,n=(0,x.al)(r[3]-r[0],r[4]-r[1],r[5]-r[2]),s=Math.sqrt(n[0]*n[0]+n[1]*n[1]);e.centerOffset[0]=s/2*t.normalizedOffset[0];const a=e.translation[2],o=n[2]/2*t.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=a+o;const l=(0,C.l)(n);e.centerOffset[2]=l/2*t.normalizedOffset[2]}const I={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},L={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const e in L){const t=L[e],i=I[e];t.forEach((e=>{I[e]=i}))}Object.freeze&&(Object.freeze(I),Object.keys(I).forEach((e=>{Object.freeze(I[e]),Object.freeze(I[e]?.normalizedOffset)})));const N=[0,0],F=(0,T.Ue)();var U=i(29989),H=i(29819),k=i(53412),V=i(4664),B=i(52061),z=i(65759),G=i(27546),q=i(50399),Z=i(78891);class j{constructor(e,t){this.labelingContext=e,this.graphics3DGraphic=t,this.hasGraphics3DResources=!1,this.visible=!1,this.textureAtlasHandles=[],this.textInitialized=!1,this.textRenderers=new Array,this.textLabelPlacements=new Array}}class W{constructor(e,t,i,r,n){this.labelClass=e,this.graphics3DSymbol=t,this.graphics3DCalloutSymbolLayer=i,this.textRenderParameters=r,this.labelFunction=n,this.calloutSymbolLayerIndex=0,this.graphics=new Map,this.scaleVisibility=null}}class ${constructor(e,t,i,r,n,s,a,o){this.layer=t,this.graphics3DCore=i,this.scaleVisibility=r,this.emptySymbolLabelSupported=n,this.elevationInfoOverride=s,this.disablePlacement=a,this.active=o,this.labelClassAbortController=new AbortController,this.labelClassContexts=new Array,this.graphics=new Map,this.labelsToInitialize=new Map,this.stageLayer=new z.F(e,{pickable:!0},i.owner.layerViewUid)}destroy(){this.stageLayer.destroy()}}let X=class extends n.Z{constructor(e){super(e),this._hudMaterials=new Map,this._calloutMaterials=new Map,this._dirty=!1,this._labels=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this.addHandles([(0,c.YP)((()=>this.view.state?.camera),(()=>this.setDirty())),(0,c.YP)((()=>this.view.state?.rasterPixelRatio),(()=>this._resetAllLabels())),(0,c.YP)((()=>this.view.focusAreasView?.polygons),(()=>this._updateFocus())),this.view.resourceController.scheduler.registerTask(q.T8.LABELER,this)]),(0,G.Dc)()&&this.addHandles((0,c.YP)((()=>this.view.scale),(()=>this._updateScaleVisibility()))),this._textTextureAtlas=new V.U({view:this.view})}dispose(){this.removeAllHandles(),this._textTextureAtlas=(0,o.M2)(this._textTextureAtlas),this._hudMaterials.clear(),this._calloutMaterials.clear(),this._labelingContexts.length=0,this._labels.clear()}destroy(){this.dispose(),ie.graphic=null,ie.renderingInfo=null,ie.layer=null}_updateFocus(){this._labelingContexts.forEach((e=>{e.graphics.forEach((t=>{if(0===t.labelLayers.length)return;const i=(0,H.S_)(t.graphic.geometry);if(null==i)return;const r=this.view.focusAreasView?.containsGeometry(i)??!0;t.labelLayers.forEach((i=>{i.stageObject.geometries.some((e=>e.material.parameters.isFocused!==r))&&(this._removeGraphic(e,t),this._addGraphic(e,t),this.setDirty())}))}))}))}_activateLabelingContext(e){e.graphics.forEach(((t,i)=>{const r=new j(e,t);this._labels.set(i,r),e.labelsToInitialize.set(i,r),t.setVisibilityFlag(_.E.LABEL,_.P.USER,!0)})),e.active=!0}_deactivateLabelingContext(e){e.graphics.forEach(((e,t)=>{e.setVisibilityFlag(_.E.LABEL,_.P.USER,!1),this.setLabelGraphicVisibility(e,!1),e.clearLabelGraphics(),this._labels.delete(t)})),e.active=!1}_addLabelTextureToAtlas(e){for(const t of e.graphics3DGraphic.labelLayers){if(!t.labelClass)continue;const i=e.textRenderers[t.labelClassContextIndex];i&&(e.textureAtlasHandles.push(this._textTextureAtlas.addText(i,(e=>K(t.stageObject,e)))),Y(t.stageObject,i))}}_removeLabelTextureFromAtlas(e){e.textureAtlasHandles.forEach((e=>e.remove())),e.textureAtlasHandles.length=0}get running(){return this.view.ready&&(this._dirty||this.deconflictor.running)}runTask(e){return this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e),Z.J}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(t.active)if(Q(t))this._dirty=!0;else if(J(t.labelClassContexts)){if(null===t.labelClassContexts){this._deactivateLabelingContext(t);continue}this._createLabelClassContext(t),this._dirty=!0}else for(const[i,r]of t.labelsToInitialize)if(this._ensureGraphics3DResources(r)&&(this._labels.set(i,r),this.deconflictor.setDirty(),e.madeProgress()),(r.visible&&r.textInitialized||!r.visible&&r.hasGraphics3DResources)&&(t.labelsToInitialize.delete(i),e.madeProgress()),e.done){this._dirty=!0;break}this._dirty||this.notifyChange("updating")}}async _createLabelClassContextAsync(e){const t=e.labelClassAbortController?.signal;e.layer.when&&await e.layer.when(),(0,l.k_)(t),e.scaleVisibility?.updateScaleRangeActive();const i=e.graphics3DCore,r=i.layer.labelingInfo?.filter((e=>!!e.symbol));if(!r||0===r.length)return;let n=!1;await(0,s.Ed)(r,(async(r,o)=>{const c=r.symbol,h=w(i.getOrCreateGraphics3DSymbol(c));if(null==h)return void a.Z.getLogger(this).error("Failed to create Graphics3DSymbol for label");await h.load(),(0,l.k_)(t);let u=null;(0,f.Pd)(c)&&c.hasVisibleCallout()&&(u=(0,g.S)(c,i.symbolCreationContext),await u.load(),(0,l.k_)(t));const d=await(0,s.q6)((0,m.J)(r,e.layer.fieldsIndex,this.view.spatialReference));if((0,l.k_)(t),!0===d.ok){const i=await this._createTextRenderParameters(h.symbol);(0,l.k_)(t);const n=new W(r,h,u,i,d.value);this._updateLabelClassContextVisibility(n),e.labelClassContexts[o]=n}else a.Z.getLogger(this).error(`Label expression failed to evaluate: ${d.error}`),n=!0})),(0,l.k_)(t)}async _createLabelClassContext(e){return null==e.labelClassPromise&&(e.labelClassPromise=this._createLabelClassContextAsync(e).catch((t=>{if((0,l.D_)(t))throw t;e.labelClassContexts.length=0})).then((()=>{e.labelClassAbortController=null,this.notifyChange("updating")})).catch((()=>{})),this.notifyChange("updating")),e.labelClassPromise}async _createTextRenderParameters(e){const t=e.symbolLayers.at(0);return"text"!==t?.type?null:k.V.fromSymbol(t,this.view.state.rasterPixelRatio)}_destroyLabelClassContext(e){for(const t of e.labelClassContexts)--t.graphics3DSymbol.referenced;const t=e.labelClassAbortController;e.labelClassAbortController=new AbortController,(0,o.IM)(t),e.labelClassContexts.length=0,e.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(e,t,i,r,n,s){const a=new M.U(i,(0,U.zi)(i.anchor),(0,U.EP)(i.anchor),e.text,(0,d.al)(e.displayWidth,e.displayHeight));return ie.graphic=t,ie.layer=r,ie.renderingInfo=null,n.createLabel(ie,a,this._hudMaterials,this._textTextureAtlas,(()=>s.placement?.elevationOffset??null))}_createLineCalloutGraphic(e,t,i,r,n){ie.graphic=e,ie.layer=n;const s=r.screenOffset[0];return ie.renderingInfo=new y.Ly(null,t,r.translation,r.centerOffset,s,r.centerOffsetUnits,r.elevationOffset),i.createGraphics3DGraphic(ie,this._calloutMaterials)}_ensureGraphics3DResources(e){if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);const i=e.labelingContext,r=i.labelClassContexts;if(J(r)||!i.emptySymbolLabelSupported&&0===t.layers.length)return!1;let n=!1;const s=t.graphic,a=i.layer,o=te(i.layer);for(let l=0;l<r.length;l++){const c=e.textRenderers[l],h=e.textLabelPlacements[l];if(null==c||null==h)continue;const u=r[l],d=u.graphics3DSymbol,p=ee(d),m=d.symbolLayers[0];if(!m)continue;m.setElevationInfoOverride(i.elevationInfoOverride);const f=new A(t,p,u.labelClass),g=this._createTextSymbolGraphic(c,s,h,a,m,f);if(null==g)return!1;g.labelClass=u.labelClass,g.labelClassContextIndex=l,t.addLabelGraphic(g,i.stageLayer),this.deconflictor.setPriority(t,u.textRenderParameters?.definition.size??0),t.setVisibilityFlag(_.E.LABEL,_.P.USER,o),t.setVisibilityFlag(_.E.LABEL,_.P.SCALE_RANGE,u.scaleVisibility??!0),t.setVisibilityFlag(_.E.LABEL,_.P.DECONFLICTION,!1),(0,G.Dc)()&&u.graphics.set(s.uid,t),n=!0;const y=u.graphics3DCalloutSymbolLayer;if(y&&h.hasLabelVerticalOffset){y.setElevationInfoOverride(i.elevationInfoOverride);const e=this._createLineCalloutGraphic(s,p,y,h,a);null!=e&&(u.calloutSymbolLayerIndex=t.labelLayers.length,t.addLabelGraphic(e,i.stageLayer))}break}return n&&i.scaleVisibility?.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const i of e.graphics3DGraphic.labelLayers){if(null==i.labelClass)continue;t[i.labelClassContextIndex].graphics3DSymbol.symbolLayers[0]?.onRemoveGraphic(i)}e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}_ensureTextTextureResources(e){if(e.textInitialized)return;const t=e.labelingContext,i=t.labelClassContexts;if(J(i))return;const r=e.graphics3DGraphic.graphic;for(let n=0;n<i.length;n++){const s=i[n];if(e.textRenderers[n]=null,e.textLabelPlacements[n]=null,null==s?.textRenderParameters)continue;const a=s.labelFunction;let o;if("arcade"===a.type)try{const e=a.needsHydrationToEvaluate()?(0,p.mW)(r,t.layer):r;o=a.evaluate(e)}catch(e){o=null}else o=a.evaluate(r);if(null==o||""===o||/^\s+$/.test(o))continue;const l=s.graphics3DSymbol;if(!l.symbolLayers[0])continue;const c=e.graphics3DGraphic,h="label-3d"===l.symbol?.type?l.symbol:null,u=s.labelClass,d=t.disablePlacement,m=new A(c,h,u,d).placement;if(null==m)continue;const f=(0,U.zi)(m.anchor),_=(0,U.mq)(f);e.textRenderers[n]=new E.tV(o,_,s.textRenderParameters,V.U.maxSize),e.textLabelPlacements[n]=m}e.textInitialized=!0}_destroyTextTextureResources(e){e.textInitialized=!1,e.textRenderers.length=0,e.textLabelPlacements.length=0}_addGraphic(e,t){const i=t.graphic.uid;if(e.graphics.set(i,t),e.active){const r=new j(e,t);this._labels.set(i,r),e.labelsToInitialize.set(i,r)}this.setDirty(),this.deconflictor.setDirty()}_updateGraphicGeometry(e,t){const i=t.graphic.uid,r=this._labels.get(i);if(!r)return!0;for(const i of r.graphics3DGraphic.labelLayers)if(null!=i.labelClass&&!e.labelClassContexts[i.labelClassContextIndex].graphics3DSymbol.symbolLayers[0].updateGeometry(i,t.graphic.geometry))return!1;return this.setDirty(),this.deconflictor.setDirty(),!0}_removeGraphic(e,t){const i=t.graphic.uid,r=this._labels.get(i);e.graphics.delete(i),r&&(this._destroyGraphic(r,i),e.labelsToInitialize.delete(i),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(e,t){this._labels.delete(t),e.textureAtlasHandles.length&&this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}async _labelingInfoChange(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const i of t){const t=e.graphics.get(i);t&&(this._removeGraphic(e,t),this._addGraphic(e,t))}}_globalPropertyChanged(e,t){for(const i of t.labelClassContexts){const r=new Map;t.graphics.forEach((e=>r.set(e.graphic.uid,e)));const n=e=>e.labelLayers[0];if(i.graphics3DSymbol.symbolLayers[0].globalPropertyChanged(e,r,n),i.graphics3DCalloutSymbolLayer){const t=e=>e.labelLayers[i.calloutSymbolLayerIndex];i.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,r,t)}}}_visibilityInfoChange(e){const t=te(e.layer);t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e)}_resetLabels(e){e.graphics.forEach(((t,i)=>{const r=this._labels.get(i);r&&(this._destroyGraphic(r,i),r.visible=!1,e.labelsToInitialize.set(i,r))})),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,i){const r=i?.emptySymbolLabelSupported||!1,n=i?.elevationInfoOverride||null,s=i?.disablePlacement||null;if(this._findLabelingContext(e))return;const a=e.layer,o=new $(this.view.stage,a,e,t,r,n,s,te(a));return this._labelingContexts.push(o),this.setDirty(),{addGraphic:e=>this._addGraphic(o,e),removeGraphic:e=>this._removeGraphic(o,e),updateGraphicGeometry:e=>this._updateGraphicGeometry(o,e),layerLabelsEnabled:()=>te(o.layer),labelingInfoChange:e=>this._labelingInfoChange(o,e),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",o),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",o),visibilityInfoChange:()=>this._visibilityInfoChange(o),reset:()=>this._resetLabels(o),remove:()=>this._removeGraphicsOwner(e),setDirty:()=>this.setDirty()}}_removeGraphicsOwner(e){const t=this._findLabelingContext(e);if(!t)return;const i=this._labelingContexts.indexOf(t);this._labelingContexts.splice(i,1),t.graphics.forEach((e=>this._removeGraphic(t,e))),t.destroy(),this.setDirty()}_updateScaleVisibility(){for(const e of this._labelingContexts)if(e.active&&!Q(e))for(const t of e.labelClassContexts)this._updateLabelClassContextVisibility(t)}_updateLabelClassContextVisibility(e){if(!(0,G.Dc)())return;const{labelClass:t,graphics:i}=e,r={minScale:t.minScale,maxScale:t.maxScale},n=(0,G.GB)(r,this.view.scale),s=null==e.scaleVisibility||e.scaleVisibility!==n;e.scaleVisibility=n,s&&i.size&&(i.forEach((e=>e.setVisibilityFlag(_.E.LABEL,_.P.SCALE_RANGE,n))),this.deconflictor.setDirty(),this.setDirty())}setLabelGraphicVisibility(e,t){const i=e.graphic.uid,r=this._labels.get(i);r&&r.visible!==t&&(t&&!r.textureAtlasHandles.length?(this._addLabelTextureToAtlas(r),r.textInitialized||r.labelingContext.labelsToInitialize.set(i,r)):!t&&r.textureAtlasHandles.length&&this._removeLabelTextureFromAtlas(r),r.visible=t,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._dirty||this._textTextureAtlas?.updating||this.deconflictor.updating||this._labelingContexts.some((e=>Q(e)))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce(((e,t)=>e+(Q(t)?0:1)),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get test(){}};function Y(e,t){e.geometries[0].setAttributeData(B.T.SIZE,[t.displayWidth,t.displayHeight]),e.geometryVertexAttributeUpdated(e.geometries[0],B.T.SIZE)}function K(e,t){e.geometries[0].setAttributeData(B.T.UVI,t),e.geometryVertexAttributeUpdated(e.geometries[0],B.T.UVI,!0)}function Q(e){return!!e.labelClassPromise&&!!e.labelClassAbortController}function J(e){return!e||0===e.length}function ee(e){return"label-3d"===e.symbol?.type?e.symbol:null}function te(e){return!!e.labelsVisible&&!!e.labelingInfo?.some((e=>!!e.symbol))}(0,r._)([(0,h.Cb)({constructOnly:!0})],X.prototype,"view",void 0),(0,r._)([(0,h.Cb)({constructOnly:!0})],X.prototype,"deconflictor",void 0),(0,r._)([(0,h.Cb)()],X.prototype,"_textTextureAtlas",void 0),(0,r._)([(0,h.Cb)({type:Boolean,readOnly:!0})],X.prototype,"updating",null),X=(0,r._)([(0,u.j)("esri.views.3d.layers.graphics.Labeler")],X);const ie=new y._D(null,null,null)},94744:function(e,t,i){i.d(t,{A8:function(){return d},AK:function(){return a},BF:function(){return p},DI:function(){return c},GS:function(){return u},a8:function(){return o},f9:function(){return l},lt:function(){return h}});var r=i(32033),n=i(31856),s=i(19821);class a extends n.D{constructor(e,t,i,r){super(t,i),this.point=e,this.createGraphic=r}}function o(e){return(0,r.n)(e)&&e.intersector===s.q.PCL&&!!e.target}class l extends n.Z{constructor(e,t,i,r,n){super(e),this.layerViewUid=e,this.sublayerId=t,this.nodeIndex=i,this.componentIndex=r,this.triangleNr=n}}class c extends n.D{constructor(e,t,i){super(t,null),this.point=e,this.createVoxelGraphic=i}}class h extends n.D{constructor(e,t){super(e,null),this.createTiles3DGraphic=t}}function u(e){return(0,r.n)(e)&&e.intersector===s.q.I3S&&!!e.target}function d(e){return(0,r.n)(e)&&e.intersector===s.q.VOXEL&&!!e.target}function p(e){return(0,r.n)(e)&&e.intersector===s.q.TILES3D&&!!e.target}},91383:function(e,t,i){i.d(t,{J:function(){return o},Q:function(){return s}});var r=i(47925),n=i(47566);class s{constructor(e,t,i,r,s=o(e,t,i)){this._tilingScheme=r,this.id=s,this.lij=[0,0,0],this.extent=(0,n.Ue)(),this.measures=new a,this.loadPriority=0,this.used=!1,this.lij[0]=this.measures.lodLevel=e,this.lij[1]=t,this.lij[2]=i,r.getExtent(e,t,i,this.extent)}get planetRadius(){return(0,r.Iu)(this.spatialReference).radius}get spatialReference(){return this._tilingScheme.spatialReference}get resolution(){return this._tilingScheme.resolutionAtLevel(this.measures.lodLevel)}get level(){return this.lij[0]}get lodLevelDelta(){return this.measures.lodLevel-this.level}createChildren(){const e=this.lij[0]+1,t=2*this.lij[1],i=2*this.lij[2];return[new s(e,t,i,this._tilingScheme),new s(e,t+1,i,this._tilingScheme),new s(e,t,i+1,this._tilingScheme),new s(e,t+1,i+1,this._tilingScheme)]}}class a{constructor(){this.visible=!0,this.distance=0,this.lodLevel=0,this.splitPriority=0,this.mergeable=!0}}function o(e,t,i){return`${e}/${t}/${i}`}},63510:function(e,t,i){function r(e){return t=>{if(e.immediate)return e.immediate.schedule(t);const i="No immediate scheduler";throw console.error(i),new Error(i)}}i.d(t,{H:function(){return r}})},59505:function(e,t,i){i.d(t,{i:function(){return o},p:function(){return r}});var r,n=i(24910),s=i(82846),a=i(33869);class o{get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}get origin(){return this._origin}constructor(e){this.renderCoordsHelper=e,this.frustum=(0,a.Ue)(),this._points=(0,a.Hf)(),this.lines=new Array(12),this._origin=(0,s.Ue)(),this._direction=(0,s.Ue)(),this._altitude=null;for(let e=0;e<12;e++)this.lines[e]={origin:null,direction:(0,s.Ue)(),endpoint:null}}update(e){(0,a.q_)(e.viewMatrix,e.projectionMatrix,this.frustum,this._points),(0,n.c)(this._origin,e.eye),(0,n.c)(this._direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this._updateLines()}updatePoints(e){for(let t=0;t<this._points.length;t++)(0,n.c)(this._points[t],e[t]);(0,a.Jp)(this.frustum,this._points),this._updateLines()}get altitude(){return this._altitude}intersectsSphere(e){return(0,a.hr)(this.frustum,e)}intersectsRay(e){return(0,a.Zr)(this.frustum,e)}intersectsLineSegment(e,t){return(0,a.rN)(this.frustum,e,t)}intersectsPoint(e){return(0,a.g8)(this.frustum,e)}_updateLines(){const e=this._points;for(let t=0;t<4;t++){const i=t+4;l(this.lines[t],e[t],e[i]),l(this.lines[t+4],e[t],3===t?e[0]:e[t+1]),l(this.lines[t+8],e[i],3===t?e[4]:e[i+1])}}static{this.planePointIndices=a.xu}static{this.nearFarLineIndices=[[a.NQ.NEAR_BOTTOM_LEFT,a.NQ.FAR_BOTTOM_LEFT],[a.NQ.NEAR_BOTTOM_RIGHT,a.NQ.FAR_BOTTOM_RIGHT],[a.NQ.NEAR_TOP_RIGHT,a.NQ.FAR_TOP_RIGHT],[a.NQ.NEAR_TOP_LEFT,a.NQ.FAR_TOP_LEFT]]}}function l(e,t,i){e.origin=t,e.endpoint=i,(0,n.E)(e.direction,t,i)}!function(e){e[e.NEAR_FAR_BOTTOM_LEFT=0]="NEAR_FAR_BOTTOM_LEFT",e[e.NEAR_FAR_BOTTOM_RIGHT=1]="NEAR_FAR_BOTTOM_RIGHT",e[e.NEAR_FAR_TOP_RIGHT=2]="NEAR_FAR_TOP_RIGHT",e[e.NEAR_FAR_TOP_LEFT=3]="NEAR_FAR_TOP_LEFT",e[e.NEAR_BOTTOM=4]="NEAR_BOTTOM",e[e.NEAR_RIGHT=5]="NEAR_RIGHT",e[e.NEAR_TOP=6]="NEAR_TOP",e[e.NEAR_LEFT=7]="NEAR_LEFT",e[e.FAR_BOTTOM=8]="FAR_BOTTOM",e[e.FAR_RIGHT=9]="FAR_RIGHT",e[e.FAR_TOP=10]="FAR_TOP",e[e.FAR_LEFT=11]="FAR_LEFT"}(r||(r={}))},60321:function(e,t,i){i.d(t,{Z:function(){return C},l:function(){return m}});var r=i(99574),n=i(26636),s=i(24910),a=i(82846),o=i(47925),l=i(71354),c=i(12659),h=i(69055),u=i(56172),d=i(78037),p=i(65001);function m(e,t,i){return e===u.JY.Global?new _(t,i):new f(t,i)}class f{constructor(e,t){this._elevationProvider=e,this._referenceEllipsoid=(0,o.Iu)(t),this._unitInMeters=(0,n.c9)(t,this._referenceEllipsoid.metersPerDegree)}compute(e,t,i,n){const{eye:a,center:o}=e;let c=a[2]*this._unitInMeters;const h=c,u=c-n,d=this._elevationProvider?.visibleElevationBounds;d&&(c=u>=0?h-this._unitInMeters*d.min:this._unitInMeters*d.max-h),t??=new l.Z({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0});const p={x:t.xmax-t.xmin,y:t.ymax-t.ymin,z:4*Math.max(t.xmax-t.xmin,t.ymax-t.ymin)},m=Math.max(p.x,p.y,p.z);(0,s.d)(M,o,a),S[0]=M[0]>0?t.xmax:t.xmin,S[1]=M[1]>0?t.ymax:t.ymin,S[2]=M[2]>0?m/2:-m/2,(0,s.d)(S,S,a),(0,s.n)(M,M);const f=1.1*(0,s.e)(S,M)*this._unitInMeters,_=Math.sqrt(c*(c+2*this._referenceEllipsoid.radius)),y=Math.max(t.xmax-t.xmin,t.ymax-t.ymin),v=y*x*this._unitInMeters,w=y*T*this._unitInMeters,C=(0,r.uZ)((c-w)/(v-w),0,1)**3,P=Math.min((0,r.t7)(_,f,C),_)*Math.max(Math.log(Math.abs(u)),1);return g(Math.min(P,Math.max(34064e4,m))/this._unitInMeters,b,this._unitInMeters,E)}}class _{constructor(e,t){this._elevationProvider=e,this._referenceEllipsoid=(0,o.Iu)(t)}compute(e,t,i,n){const{eye:a}=e,o=(0,s.l)(a),l=o-this._referenceEllipsoid.radius,u=this._referenceEllipsoid.radius+Math.min(0,n),m=Math.abs(l-n),f=Math.max(m,Math.abs(l)),_=this._elevationProvider?.visibleElevationBounds.max??0,x=(0,d.yx)(f),T=Math.sqrt(f*(f+2*u)),A=o+this._referenceEllipsoid.radius,O=1.2*(0,r.t7)(T,A,x),D=(Math.log(f)-y)/(v-y);g(O,(0,r.uZ)(b-D*(b-w),w,b),1,E);const I=this._referenceEllipsoid.radius+_,L=this._referenceEllipsoid.radius+this._referenceEllipsoid.atmosphereHeight,N=Math.max(I,L),F=o-N;if(x>0&&F>C){const t=(0,s.n)(S,(0,s.g)(S,e.eye,-1)),n=(0,s.n)(M,e.viewForward),a=(0,r.ZF)((0,s.e)(t,n)),o=.5*e.fovY,l=Math.cos(o);let u=p.P.infinite.near;if(a<=o)u=F*l;else{const t=(0,s.n)(S,e.viewUp),i=Math.tan(o),r=(0,s.g)(S,t,i),a=(0,s.n)(S,(0,s.d)(S,n,r)),d=(0,c.al)(e.eye,a,R),p=(0,h.b)(P,N);if((0,h.i)(p,d,S)){const t=(0,s.d)(S,S,e.eye);u=(0,s.l)(t)*l}}const d=.99*Math.min(i.near,u);if(d<p.P.infinite.near&&d>E.near){const e=(0,r.t7)(E.near,d,x);E.near=e}}return E}}function g(e,t,i,r){const n=C/i,s=e/t;return s>n?(r.far=e,r.near=s):(r.near=n,r.far=r.near*t),r}const y=7.983,v=16.994,b=2e4,w=100,C=2,x=.001,T=1e-4,S=(0,a.Ue)(),M=(0,a.Ue)(),E={near:0,far:0},P=(0,h.c)(),R=(0,c.Ue)()},13340:function(e,t,i){i.d(t,{L:function(){return a}});var r=i(99574),n=i(24910),s=i(82846);function a(e,t,i){e.worldUpAtPosition(t,o),(0,n.d)(l,i,t);const s=(0,n.l)(l);return 0===s?0:(0,r.ZF)((0,n.e)(l,o)/s)}const o=(0,s.Ue)(),l=(0,s.Ue)()},71298:function(e,t,i){i.d(t,{r:function(){return r}});class r{constructor(e=1/0,t=-1/0){this.elevationRangeMin=e,this.elevationRangeMax=t}get elevationRangeValid(){return!Number.isNaN(this.elevationRangeMin)}invalidateElevationRange(){this.elevationRangeMin=NaN}expandElevationRangeValues(e,t){this.elevationRangeMin=Math.min(this.elevationRangeMin,e),this.elevationRangeMax=Math.max(this.elevationRangeMax,t)}expandElevationRange(e){this.elevationRangeMin=Math.min(this.elevationRangeMin,e.elevationRangeMin),this.elevationRangeMax=Math.max(this.elevationRangeMax,e.elevationRangeMax)}setElevationRange(e){this.elevationRangeMin=e.elevationRangeMin,this.elevationRangeMax=e.elevationRangeMax}}},48621:function(e,t,i){i.d(t,{d:function(){return p},c:function(){return d}});var r=i(73440),n=i(70880),s=(i(61432),i(96711)),a=i(69071),o=i(99153),l=i(32555),c=i(17155),h=(i(83850),i(48023));var u=i(50399);function d(e){return new m({view:e})}const p=.1;let m=class extends n.Z{constructor(e){super(e),this._quality=1,this._usedMemory=0,this._updating=!1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._predictedMemory=0,this._cacheStorage=new a.WJ,this._warnMemoryUsage=null,this._numQualityChanges=0,this._maxMemory=750,this._additionalCacheMemory=0,this.addHandles((0,o.A)({prepare:()=>this._updateMemory()}))}destroy(){this._cacheStorage.destroy()}get maxMemory(){return this._maxMemory}set maxMemory(e){null==e||e<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(1),this._maxMemory=e)}get additionalCacheMemory(){return this._additionalCacheMemory}set additionalCacheMemory(e){null!=e&&(this._additionalCacheMemory=e)}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._usedMemory}get usedCacheMemory(){return this._cacheStorage.size}newCache(e,t,i){return new a.Xq(e,this._cacheStorage,t,i)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(this._predictedMemory<=0&&!this._updating)return;let e=this._layersUpdating();if(this._predictedMemory<.6&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(1);else if(e){if(this._predictedMemory>1.1||this._usedMemory>1)if(this._stableQuality>0)this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality);else if(this._quality>p&&this._downscaleMemoryUsed<this._usedMemory){if(this._compactAndUpdate())return;this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._usedMemory,this._canFastRecover=!1}}else if(this._downscaleMemoryUsed=0,this._usedMemory>1){if(this._compactAndUpdate())return;this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._predictedMemory}else if(this._stableQuality!==this._quality)if(this._usedMemory<.75&&this._quality<1){this._stableQuality=this._quality;const t=.05;e=this._updateQuality(this._quality+t)}else this._quality<1&&(this._canFastRecover=!0);this._updating=e}_compactAndUpdate(){const e=(0,u.S0)((0,l.HA)(100)),t=this.view.stage.compact(e);return this.view.basemapTerrain.overlayManager.renderer.compact(e)||t}_updateQuality(e){return(e=Math.min(Math.max(e,p),1))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)}_layersUpdating(){return this.view.allLayerViews.some((e=>!!e.updating))}_updateMemory(){if(!this.view)return;this.view.stage?.renderer?.tick();const e=this.view.stage?.renderer?.usedMemory;let t=(this.view.basemapTerrain?.usedMemory??0)+(e?e.fbos+e.edges+e.plugins:0),i=0;this.view.allLayerViews&&this.view.allLayerViews.forEach((e=>{if(function(e){return"usedMemory"in e&&"unloadedMemory"in e&&"ignoresMemoryFactor"in e}(e)){const r=e.ignoresMemoryFactor?this._quality:1;t+=e.usedMemory*r,i+=e.unloadedMemory*r}}));const r=null==this._warnMemoryUsage||Math.round(10*t)!==Math.round(10*this._warnMemoryUsage),n=1048576*this.maxMemory;if(t>n&&r){this._warnMemoryUsage=t;const e=e=>(e/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",r=Math.round(100*this._quality);s.Z.getLogger(this).warn(`Memory Limit exceeded! Limit: ${e(n)} Current: ${e(t)} Projected: ${e(t+i)} Quality: ${r}%`)}this._usedMemory=t/n,this._predictedMemory=(t+i)/n;const a=n-t;this._cacheStorage.maxSize=Math.max(0,a+1048576*this.additionalCacheMemory)}get test(){}};(0,r._)([(0,c.Cb)({constructOnly:!0})],m.prototype,"view",void 0),(0,r._)([(0,c.Cb)()],m.prototype,"maxMemory",null),(0,r._)([(0,c.Cb)()],m.prototype,"additionalCacheMemory",null),(0,r._)([(0,c.Cb)({readOnly:!0})],m.prototype,"memoryFactor",null),(0,r._)([(0,c.Cb)({readOnly:!0})],m.prototype,"updating",null),(0,r._)([(0,c.Cb)({readOnly:!0})],m.prototype,"usedMemory",null),(0,r._)([(0,c.Cb)({readOnly:!0})],m.prototype,"usedCacheMemory",null),(0,r._)([(0,c.Cb)()],m.prototype,"_quality",void 0),(0,r._)([(0,c.Cb)()],m.prototype,"_usedMemory",void 0),(0,r._)([(0,c.Cb)()],m.prototype,"_updating",void 0),(0,r._)([(0,c.Cb)()],m.prototype,"_stableQuality",void 0),(0,r._)([(0,c.Cb)()],m.prototype,"_maxMemory",void 0),(0,r._)([(0,c.Cb)()],m.prototype,"_additionalCacheMemory",void 0),m=(0,r._)([(0,h.j)("esri.views.3d.support.MemoryController")],m)},32243:function(e,t,i){i.d(t,{Z:function(){return b}});var r=i(99574),n=i(26636),s=i(31865),a=i(24910),o=i(47925),l=i(70331),c=i(6961),h=i(96937),u=i(2051),d=i(47566),p=i(93070),m=i(5226),f=i(77773),_=i(63271),g=i(69811),y=i(27936),v=i(56172);class b{constructor(e,t,i,r){this.viewingMode=e,this.spatialReference=t,this.unitInMeters=i,this._coordinateSystem=r,this._tmpCoordinateSystem=(0,m.Ue)(r),this.referenceEllipsoid=(0,o.Iu)(t),this.sphericalPCPF=(0,l.rS)(t)}set extent(e){e&&(0,m.qf)(this._coordinateSystem,e,this._coordinateSystem)}get extent(){return(0,m.bk)(this._coordinateSystem,(0,d.Ue)())}getAltitude(e){return(0,m.id)(this._coordinateSystem,e)}setAltitude(e,t,i=e){return(0,m.Is)(this._coordinateSystem,i,t,e)}setAltitudeOfTransformation(e,t){(0,m.rF)(this._coordinateSystem,t,e,t)}worldUpAtPosition(e,t){return(0,m.P0)(this._coordinateSystem,e,t)}worldBasisAtPosition(e,t,i){return(0,m.Kf)(this._coordinateSystem,e,t,i)}basisMatrixAtPosition(e,t){const i=this.worldBasisAtPosition(e,p.R.X,g.WM.get()),r=this.worldBasisAtPosition(e,p.R.Y,g.WM.get()),n=this.worldBasisAtPosition(e,p.R.Z,g.WM.get());return(0,s.t8)(t,i[0],i[1],i[2],0,r[0],r[1],r[2],0,n[0],n[1],n[2],0,0,0,0,1),t}headingAtPosition(e,t){const i=this.worldUpAtPosition(e,g.WM.get()),n=this.worldBasisAtPosition(e,p.R.Y,g.WM.get()),s=(0,_.cp)(t,n,i);return(0,r.BV)(s)}intersectManifoldClosestSilhouette(e,t,i){return(0,m.NE)(this._coordinateSystem,t,this._tmpCoordinateSystem),(0,m.ej)(this._tmpCoordinateSystem,e,i),i}intersectManifold(e,t,i){(0,m.NE)(this._coordinateSystem,t,this._tmpCoordinateSystem);const r=g.WM.get();return(0,m.BR)(this._tmpCoordinateSystem,e,r)?(0,a.c)(i,r):null}intersectInfiniteManifold(e,t,i){if(this.viewingMode===v.JY.Global)return this.intersectManifold(e,t,i);(0,m.NE)(this._coordinateSystem,t,this._tmpCoordinateSystem);const r=this._tmpCoordinateSystem.value,n=g.WM.get();return(0,f.BR)(r.plane,e,n)?(0,a.c)(i,n):null}toRenderCoords(e,t,i){return(0,y.f)(e)?(0,c.K)(e,t,this.spatialReference):(0,u.S)(e,t,i,this.spatialReference)}fromRenderCoords(e,t,i=null){return(0,y.f)(t)?(null!=i&&(t.spatialReference=i),(0,h.f)(e,this.spatialReference,t)?t:null):(0,u.S)(e,this.spatialReference,t,i)?t:null}static create(e,t){switch(e){case v.JY.Local:return new b(v.JY.Local,t,(0,n.c9)(t),(0,m.pb)());case v.JY.Global:return new b(v.JY.Global,t,1,(0,m.pt)(t))}}static renderUnitScaleFactor(e,t){return(0,n.r6)(e)/(0,n.r6)(t)}}},69892:function(e,t,i){i.d(t,{Q8:function(){return De},Br:function(){return Be},t_:function(){return Xe},Xt:function(){return Ve},n3:function(){return Fe},gL:function(){return $e},Hm:function(){return We},UI:function(){return je},Ic:function(){return ot},S9:function(){return lt},P$:function(){return Ke},h5:function(){return Ie},kE:function(){return Ne},l0:function(){return He},_U:function(){return ke},sO:function(){return _t},ao:function(){return ht},HH:function(){return ct},cb:function(){return Ze},EO:function(){return gt}});var r,n,s,a=i(41309),o=i(95437),l=i(96711),c=i(99574),h=i(93568),u=i(24910),d=i(82846),p=i(47925),m=i(60508),f=i(13132),_=i(45213),g=i(6961),y=i(96937),v=i(2051),b=i(56172),w=i(97750),C=i(31865),x=i(10934),T=i(41788),S=i(71354),M=i(67764),E=i(28931),P=i(33869),R=i(26821);function A(e,t){const i=[],r=[];return O(i,e,t,s.LEFT),O(r,i,t,s.BOTTOM),O(i,r,t,s.RIGHT),O(r,i,t,s.TOP),r}function O(e,t,i,r){const s=I(i,r);if(e.length=0,t.length){s(L,t[0],t[0])===n.INSIDE&&D(e,t[0]);for(let i=0;i<t.length;i++){const r=t[i===t.length-1?0:i+1];switch(s(L,t[i],r)){case n.INSIDE:D(e,r);break;case n.INSIDE_OUT:D(e,(0,T.d9)(L));break;case n.OUTSIDE_IN:D(e,(0,T.d9)(L)),D(e,r);case n.OUTSIDE:}}}}function D(e,t){0!==e.length&&(0,R.fS)(e.at(-1),t)||e.push(t)}function I(e,t){const i=t===s.LEFT||t===s.RIGHT?0:1,a=e[t],o=t===s.LEFT||t===s.BOTTOM?r.MIN:r.MAX,l=0===i?1:0;return(e,t,s)=>{if(t[i]<a&&s[i]<a)return o===r.MIN?n.OUTSIDE:n.INSIDE;if(t[i]>a&&s[i]>a)return o===r.MIN?n.INSIDE:n.OUTSIDE;const c=(s[l]-t[l])/(s[i]-t[i]),h=t[l]+c*(a-t[i]);return e[i]=a,e[l]=h,(t[i]<a?1:-1)*o>0?n.OUTSIDE_IN:n.INSIDE_OUT}}!function(e){e[e.MIN=1]="MIN",e[e.MAX=-1]="MAX"}(r||(r={})),function(e){e[e.OUTSIDE=0]="OUTSIDE",e[e.INSIDE=1]="INSIDE",e[e.OUTSIDE_IN=2]="OUTSIDE_IN",e[e.INSIDE_OUT=3]="INSIDE_OUT"}(n||(n={})),function(e){e[e.LEFT=0]="LEFT",e[e.BOTTOM=1]="BOTTOM",e[e.RIGHT=2]="RIGHT",e[e.TOP=3]="TOP"}(s||(s={}));const L=(0,T.Ue)();var N=i(12659),F=i(59505),U=i(59758);const H=(0,d.al)(0,1,0),k=(0,d.al)(0,0,1),V=(0,x.Ue)(),B=(0,d.Ue)(),z=(0,d.Ue)();function G(e,t,i,r=(0,U.dp)()){const{direction:n,up:s}=r;return(0,C.QO)(V,-(0,c.Vl)(t)),(0,C.lM)(V,V,(0,c.Vl)(i)),(0,u.t)(n,k,V),(0,u.g)(n,n,-1),(0,u.t)(s,H,V),r}function q(e,t,i,r,n){const s=t.lines[F.p.FAR_LEFT].direction,a=(n-i.getAltitude(r))/s[2];(0,u.b)(e,r,s,a)}const Z=(0,d.Ue)(),j=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:function(e,t,i,r){return(0,U.t_)(t,i,r,k,H)},eyeForCenterWithHeadingTilt:function(e,t,i,r){const n=G(0,i,r),s=(0,d.Ue)();return(0,u.g)(s,n.direction,-t),(0,u.f)(s,s,e),{up:n.up,eye:s,heading:i,tilt:r}},eyeTiltToLookAtTilt:function(e){return(0,c.Vl)(e)},headingTiltToDirectionUp:G,lookAtTiltToEyeTilt:function(e){return(0,c.BV)(e)},toArea:function(e,t){const i=e.frustum,{renderCoordsHelper:r}=e,n=r.getAltitude(t),s=e.spatialReference,a=e.state.camera.eye,o=[],l=i.planes[P.Nu.FAR];for(let e=0;e<4;e++){const t=i.lines[e];r.intersectInfiniteManifold((0,N.re)(t.origin,t.direction),n,Z)||q(Z,i,r,t.endpoint,n),(0,U.H2)(Z,a,Z,l),o.push((0,T.al)(Z[0],Z[1]))}return function(e,t,i){const r=e.map((e=>((0,u.i)(Z,e[0],e[1],0),t.fromRenderCoords(Z,Z,i),[Z[0],Z[1]])));return r.length<=2?new M.Z({spatialReference:i}):(r.push(r[0].slice()),(0,E.bu)(r)||r.reverse(),new M.Z({rings:[r],spatialReference:i}))}(A(o,r.extent),r,s)},toExtent:function(e,t,i,r,n){const s=e.renderSpatialReference,a=e.spatialReference??t.spatialReference;return(0,g.K)(t,B,s),(0,g.K)(t,z,s),B[0]-=i/2,z[0]+=i/2,B[1]-=r/2,z[1]+=r/2,(0,v.S)(B,s,B,a),(0,v.S)(z,s,z,a),n?(n.xmin=B[0],n.ymin=B[1],n.xmax=z[0],n.ymax=z[1],n.spatialReference=a):n=new S.Z(B[0],B[1],z[0],z[1],a),n}},Symbol.toStringTag,{value:"Module"}));var W=i(73749),$=i(27583),X=i(66130),Y=i(88970),K=i(77773),Q=i(69055),J=i(97290),ee=i(60321),te=i(13340),ie=i(32185),re=i(22365);const ne=(0,d.al)(0,0,1),se=(0,u.n)((0,d.Ue)(),(0,d.al)(1,1,1)),ae=new o.pE(-180,180),oe=(0,x.Ue)(),le=(0,d.Ue)(),ce=(0,d.Ue)();function he(e,t,i,r=(0,U.dp)()){(0,u.h)(le,e,ne),0===(0,u.e)(le,le)&&(0,u.h)(le,e,se),(0,C.Us)(oe,-(0,c.Vl)(t),e),(0,C.U1)(oe,oe,-(0,c.Vl)(i),le);const{up:n,direction:s}=r;return(0,u.h)(n,le,e),(0,u.n)(n,n),(0,u.t)(n,n,oe),(0,u.n)(s,e),(0,u.u)(s,s),(0,u.t)(s,s,oe),r}function ue(e){const t=e[1];e[1]=-e[2],e[2]=t}function de(e,t){const i=he(t,e.heading,e.tilt);return e.up=i.up,e}function pe(e,t){const i=[],r=[],n=(0,X.bn)();for(let s=0;s<e.length;s++){const a=e[s],o=s===e.length-1?e[0]:e[s+1],l=(0,Y.zk)(a,o,we),c=(0,K.Qi)(t,l.origin,l.vector,K.oy.NONE,ve);switch(c){case K.Kt.INSIDE:i.push(a);break;case K.Kt.OUTSIDE:r.push(a);break;case K.Kt.INTERSECTS_INSIDE_OUT:case K.Kt.INTERSECTS_OUTSIDE_IN:{const[e,s,o]=c===K.Kt.INTERSECTS_INSIDE_OUT?[1,i,r]:[-1,r,i],l=(0,K.st)(t),h=(0,u.b)((0,d.Ue)(),ve,l,e*n),p=(0,u.b)((0,d.Ue)(),ve,l,e*-n);s.push(a),s.push(h),o.push(p)}}}const s=[];return i.length&&s.push(i),r.length&&s.push(r),s}const me={minCurvature:(0,c.Vl)(5),maxCurvature:(0,c.Vl)(50),minSamples:1,maxSamples:6},fe=(0,d.al)(1,0,0),_e=(0,d.al)(0,1,0),ge=(0,d.Ue)(),ye=(0,d.Ue)(),ve=(0,d.Ue)(),be=(0,Q.c)(),we=(0,Y.Ue)(),Ce=(0,$.Ue)(),xe=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:function(e,t,i,r){const n=le,s=ce;return(0,u.n)(n,e),(0,u.h)(ce,n,ne),0===(0,u.e)(ce,ce)&&(0,u.h)(ce,n,se),(0,u.h)(s,ce,n),(0,U.t_)(t,i,r,n,s)},eyeForCenterWithHeadingTilt:function(e,t,i,r){const n={eye:(0,d.Ue)(),up:null,tilt:r,heading:i},s=le;s[0]=e[0],s[1]=e[2],s[2]=-e[1];const a=t,o=(0,c.Vl)(i),l=(0,c.Vl)(r),h=Math.sin(o),p=Math.cos(o),m=Math.sin(l),f=Math.cos(l),_=(0,u.l)(s);let g;if(Math.abs(l)<1e-8)g=a+_;else{const e=_/m,t=(0,c.Kt)(a/e),i=Math.PI-l-t;g=e*Math.sin(i)}const y=f*a,v=a*a*(m*m),b=p*p*v,w=g-y,C=w*w,x=b*(b+C-s[1]*s[1]);if(x<0)return(0,u.g)(n.eye,s,g/_),n.tilt=0,de(n,e);const T=Math.sqrt(x),S=s[1]*w,M=b+C;let E;if(E=p>0?-T+S:T+S,Math.abs(M)<1e-8)return _<1e-8?(n.eye[0]=0,n.eye[1]=0,n.eye[2]=a):(0,u.g)(n.eye,s,g/_),n.tilt=0,ue(n.eye),de(n,e);n.eye[1]=E/M;const P=h*h*v,R=m*a,A=p*R*n.eye[1],O=n.eye[1]*n.eye[1],D=1-O,I=Math.sqrt(D),L=b*O+P-2*A*I*w+D*C;return Math.abs(L)<1e-8?((0,u.g)(n.eye,s,g/_),n.tilt=0,ue(n.eye),de(n,e)):(n.eye[0]=(D*(g*s[0]-y*s[0])-R*I*(s[0]*n.eye[1]*p+s[2]*h))/L,n.eye[2]=(D*(g*s[2]-y*s[2])-R*I*(s[2]*n.eye[1]*p-s[0]*h))/L,(0,u.g)(n.eye,n.eye,g),ue(n.eye),de(n,e))},eyeTiltToLookAtTilt:function(e,t,i){const r=(0,c.Vl)(e),n=(0,u.l)(t);return(0,c.Kt)(i/(n/Math.sin(r)))+r},headingTiltToDirectionUp:he,lookAtTiltToEyeTilt:function(e,t,i){const r=(0,u.l)(t),n=Math.sqrt(i*i+r*r-2*i*r*Math.cos(Math.PI-e)),s=(0,c.Kt)(i/(n/Math.sin(e)));return(0,c.BV)(e-s)},toArea:function(e,t){const{renderCoordsHelper:i}=e,r=e.state.camera.clone(),n=new F.i(i);r.near=ee.Z,n.update(r);const s=i.getAltitude(t),a=e.spatialReference,o=i.referenceEllipsoid.radius,l=r.eye,h=1+(0,u.j)(l,t)/(o+s),p=Math.sqrt(h*h-1),{minCurvature:m,maxCurvature:f,minSamples:_,maxSamples:g}=me,y=function(e){const{renderCoordsHelper:t,state:{camera:i}}=e,{center:r,eye:n}=i,s=Math.abs(t.getAltitude(r)),a=Math.abs(Math.PI/2-(0,te.L)(t,r,n));return(0,Q.b)(be,t.referenceEllipsoid.radius+s),(0,Q.d)(be,a,i.distance,i.fovY)}(e),v=(0,c.uZ)((p-m)/(f-m),0,1),b=Math.round((0,c.t7)(_,g,v)),w=r.aboveGround,C=n.planes[P.Nu.FAR],x=[],T=(0,K.Yq)(d.AG,fe,(0,K.Ue)()),S=(0,K.Yq)(d.AG,_e,(0,K.Ue)());(0,W.s)(Ce,0,0,0,0);for(let e=0;e<4;e++){const t=e===F.p.NEAR_FAR_BOTTOM_RIGHT&&!w||e===F.p.NEAR_FAR_TOP_LEFT&&w?1-y:0,r=e===F.p.NEAR_FAR_BOTTOM_RIGHT&&w||e===F.p.NEAR_FAR_TOP_LEFT&&!w?y:1,a=n.lines[e],o=n.lines[3===e?0:e+1];for(let n=0;n<b;n++){const h=n/b,p=e===F.p.NEAR_FAR_BOTTOM_RIGHT?1-(1-h)**2:e===F.p.NEAR_FAR_TOP_LEFT?h**2:h,m=0===n?0:(0,c.t7)(t,r,p),f=(0,u.m)(ye,a.origin,o.origin,m),_=(0,re.ZA)(a.direction,o.direction,m,ge);i.intersectManifoldClosestSilhouette((0,N.re)(f,_),s,ve),(0,U.H2)(ve,l,ve,C),x.push((0,d.d9)(ve)),0!==x.length&&(0,u.x)(x.at(-1),ve);const g=((0,K.Ac)(T,ve)?1:0)|((0,K.Ac)(S,ve)?2:0);Ce[g]=1}}x.length>2&&(0,u.x)(x[0],x.at(-1));const R=function(e,t,i){const r=2*(0,X.bn)();return e.map((e=>{const n=[];let s=!1;for(const a of e)t.fromRenderCoords(a,ve,i),Math.abs(a[0])<r&&Math.abs(a[1])<r?(n.push([null,ve[1]]),n.push([null,ve[1]]),s=!0):n.push([ve[0],ve[1]]);if(s)for(let e=0;e<n.length;e++){const t=n[e];if(null!=t[0])continue;const i=n[e+1],r=n.at(0===e?-1:e-1);t[0]=r[0],e++;const s=n.at(e===n.length-1?0:e+1);i[0]=s[0]}return n.push(n[0]),(0,E.bu)(n)||n.reverse(),n}))}((0,W.b)(Ce)>1?function(e,t){const i=[];for(const r of e)i.push(...pe(r,t));return i}(pe(x,T),S):[x],i,a);return new M.Z({rings:R,spatialReference:a})},toExtent:function(e,t,i,r,n){let s,a,l,h;const u=t.latitude,d=(0,p.Iu)(e.spatialReference).radius,m=t.longitude,f=(0,ie.Be)(u,i,d)/2;s=m-f,a=m+f;const g=(0,c.Vl)(u),y=(1+Math.sin(g))/(1-Math.sin(g)),v=(y+1)*Math.tan(r/d/2),b=v*v;function w(e){const t=Math.PI/2;return(e=o.c5.normalize(e,-t))>t&&(e=Math.PI-e),e}if(l=1.5*Math.PI-2*Math.atan(.5*(v+Math.sqrt(4*y+b))),h=l+r/d,l=w(l),h=w(h),h<l){const e=h;h=l,l=e}if(l=Math.max((0,c.BV)(l),-90),h=Math.min((0,c.BV)(h),90),a=ae.monotonic(s,a),a-s>180){const e=(a-s-180)/2;s+=e,a-=e}const C=e.spatialReference&&e.spatialReference.isGeographic?e.spatialReference:_.Z.WGS84;return n?(n.xmin=s,n.ymin=l,n.xmax=a,n.ymax=h,n.spatialReference=C):n=new S.Z(s,l,a,h,C),e.spatialReference&&e.spatialReference.isWebMercator&&(0,J.$)(n,!1,n),n}},Symbol.toStringTag,{value:"Module"}));var Te=i(90494),Se=i(45391);const Me=()=>l.Z.getLogger("esri.views.3d.support.cameraUtils"),Ee=96*39.37,Pe={heading:0,tilt:0},Re=(0,d.Ue)(),Ae=new o.pE(-20037508.342788905,20037508.342788905),Oe=new o.pE(-180,180);var De;function Ie(e){return e.spatialReference??_.Z.WGS84}function Le({state:e}){return e.isGlobal?xe:j}function Ne(e,t,i,r,n){return Le(e).headingTiltToDirectionUp(t,i,r,n)}function Fe(e,t){if(null==t)return null;const i=e.renderSpatialReference,r=Le(e).headingTiltToDirectionUp,n=(0,d.Ue)();if(!(0,g.K)(t.position,n,i))return null;const s=r(n,t.heading,t.tilt);(0,u.g)(s.direction,s.direction,e.state.camera.distance),(0,u.f)(s.direction,s.direction,n);const a=(0,w.dP)(e,n,s.direction,s.up);return a.fov=(0,c.Vl)(t.fov),a.row=t.layout.row,a.rows=t.layout.rows,a.column=t.layout.column,a.columns=t.layout.columns,a}!function(e){e[e.LOCKED=0]="LOCKED",e[e.ADJUST=1]="ADJUST"}(De||(De={}));const Ue=(0,d.Ue)();function He(e,t,i){const r=e.renderSpatialReference,n=Xe(e,t.eye,t.viewForward,t.up,Pe);let s=Ie(e);return(0,v.S)(t.eye,r,Ue,s)||(s=_.Z.WGS84,(0,v.S)(t.eye,r,Ue,s)),null==i?i=new a.Z(new m.Z(Ue,s),n.heading,n.tilt,(0,c.BV)(t.fov)):(i.position.x=Ue[0],i.position.y=Ue[1],i.position.z=Ue[2],i.position.spatialReference=s,i.heading=n.heading,i.tilt=n.tilt,i.fov=(0,c.BV)(t.fov)),i.layout.row=t.row,i.layout.rows=t.rows,i.layout.column=t.column,i.layout.columns=t.columns,i}function ke(e,t){const{camera:i}=e.state,{unitInMeters:r}=e.renderCoordsHelper;return t/=r,i.width/2/i.pixelRatio/(Ee/t)/Math.tan(i.fovX/2)}function Ve(e,t){const{camera:i}=e.state,{unitInMeters:r}=e.renderCoordsHelper,n=t*Math.tan(i.fovX/2),s=i.width/2/i.pixelRatio;return Ee/(s/n)*r}function Be(e,t,i,r){const n=r.levelAtScale(t),s=Ge(Xe(e,i.eye,i.viewForward,i.up).tilt),a=Math.max(n-s,0);return r.scaleAtLevel(a)}function ze(e,t,i){const r=i.levelAtScale(e),n=Ge(t);return i.scaleAtLevel(r+n)}function Ge(e){return 2*((e>90?180-e:e)/90)**2}function qe(e,t,i=0){const r=Fe(e,t);return r?function(e,t,i=0){const r=e.basemapTerrain?.tilingScheme;if(!r)return 0;const n=(0,p.Iu)(e.spatialReference).radius,s=e.state.viewingMode===b.JY.Local?t.eye[2]:(0,u.l)(t.eye)-n;return Be(e,Ve(e,Math.abs(s-i)),t,r)}(e,r,i):0}function Ze(e,t,i,r,n){if(0===t)return 0;const s=(0,u.j)(i.eye,r),a=e.basemapTerrain?.tilingScheme;if(!a)return Me().error("#scaleToTargetDistance()","Cannot compute distance from scale without a tiling scheme"),s;let o=s;const l=Xe(e,i.eye,i.viewForward,i.up),h=l.tilt>90;if(e.state.isLocal){const r=(ke(e,ze(t,l.tilt,a))-Math.abs(i.eye[2]-n[2]))/Math.cos((0,c.Vl)(l.tilt));return o=h?o-r:o+r,o}let d=1/0,m=0,f=Ke(e,l.heading,l.tilt,r,s,De.ADJUST);if(!f)return o;const _=(0,u.l)(n);for(;d>1&&m<100;){const n=(0,u.l)(f.eye),s=h?180-f.tilt:f.tilt,g=(0,c.Vl)(s),y=Math.sin(g)*n,v=Math.cos(g)*n,b=ke(e,ze(t,f.tilt,a)),w=h?_-b:_+b,C=(0,c.Kt)(y/w),x=Math.cos(C)*w-v,T=(0,u.j)(f.eye,r);o=h?T-x:T+x,f=Ke(e,l.heading,l.tilt,r,o,De.ADJUST);const S=mt(e,f,(0,c.BV)(i.fov));if(!f||!S)return o;const M=qe(e,S,_-(0,p.Iu)(e.spatialReference).radius);d=Math.abs(t-M),++m}return o}async function je(e,t,i,r,n,s){return $e(e,t,ke(e,i),r,n,s)}function We(e,t,i,r,n,s){return mt(e,Ke(e,r.heading,r.tilt,t,i,n),r.fov,s)}async function $e(e,t,i,r,n,s){const a=await Qe(e,r.heading,r.tilt,t,i,n,s);return(0,h.k_)(s),ft(e,a,r.fov,s)}function Xe(e,t,i,r,n){return Le(e).directionToHeadingTilt(t,i,r,n)}function Ye(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,Re,e.spatialReference)&&e.elevationProvider&&((0,Te.KO)(e.elevationProvider,Re)??0)>Re[2]-1)}function Ke(e,t,i,r,n,s){return Je(e,t,i,r instanceof m.Z?r:null,function(e,t){const i=(0,d.Ue)();if(null==t)return(0,u.c)(i,e.state.camera.center);if(t instanceof m.Z){if(!(0,g.K)(t,i,e.renderSpatialReference))return null;const{basemapTerrain:r,elevationProvider:n}=e;if(null==t.z&&null!=r&&null!=n){const r=(0,Te.KO)(n,t);null!=r&&e.renderCoordsHelper.setAltitude(i,r)}return i}return(0,u.c)(i,t)}(e,r),n,s)}async function Qe(e,t,i,r,n,s,a){const o=r instanceof m.Z?r:null,l=await async function(e,t,i){const r=(0,d.Ue)();if(null==t)return(0,u.c)(r,e.state.camera.center);if(t instanceof m.Z){const{renderSpatialReference:n,basemapTerrain:s,elevationProvider:a}=e,o=t.spatialReference;if(await(0,g.U)(t,r,n,0,{signal:i}),(0,h.k_)(i),null==t.z&&null!=s&&null!=a){const n=await a.queryElevation(t.x,t.y,t.z??0,o,"ground",i);(0,h.k_)(i),null!=n&&e.renderCoordsHelper.setAltitude(r,n)}return r}return(0,u.c)(r,t)}(e,r,a);return(0,h.k_)(a),et(e,t,i,o,l,n,s,a)}function Je(e,t,i,r,n,s,a){if(null==n)return null;if(!r&&(r=new m.Z({spatialReference:Ie(e)}),!(0,y.f)(n,e.renderSpatialReference,r)))return null;const o=tt(e,t,i,n,s,a);if(it(e,i,a)&&Ye(e,o.eye)){const{tilt:a,mode:o}=rt(e,i,n,s);return Je(e,t,a,r,n,s,o)}return nt(o,n)}async function et(e,t,i,r,n,s,a,o){r||(r=new m.Z({spatialReference:Ie(e)}),await(0,y.A)(n,e.renderSpatialReference,r,{signal:o})||(r=null)),(0,h.k_)(o);const l=tt(e,t,i,n,s,a);if(it(e,i,a)&&await async function(e,t,i){if(Ye(e,t))return!0;const{elevationProvider:r,spatialReference:n,renderCoordsHelper:s}=e;if(null==r||!s.fromRenderCoords(t,Re,n))return!1;const[a,o,l]=Re,c=await r.queryElevation(a,o,l,n,"ground",i)??0;return(0,h.k_)(i),c>l-1}(e,l.eye,o)){(0,h.k_)(o);const{tilt:a,mode:l}=rt(e,i,n,s);return et(e,t,a,r,n,s,l,o)}return nt(l,n)}function tt(e,t,i,r,n,s){const a=function(e,t,i,r,n,s){let a=0;return s===De.ADJUST&&function(e,t,i){const r=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(i/r)/Math.LN2>8)return!0;const n=t,s=e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation;return(0,u.j)(n,s)/(Math.tan(.5*e.state.camera.fov)*r)>5}(e,r,n)?(t=0,a=function(e,t,i,r){const n=pt(e,r,t,i);if(!e.state.constraints.tilt)return n;const s=e.state.constraints.tilt(t);s.max=Math.min(s.max,.5*Math.PI);const a=s.min*(1-ut)+s.max*ut;return Math.min(n,a)}(e,n,i,r)):a=pt(e,r,n,i),a=e.state.constraints.clampTilt(n,a),{heading:t,tilt:i=dt(e,r,n,a)}}(e,t,i,r,n=Math.max(n,e.state.constraints.minimumPoiDistance),s);return(0,Le(e).eyeForCenterWithHeadingTilt)(r,n,a.heading,a.tilt)}function it(e,t,i){const r=e.map.ground.navigationConstraint;return i===De.ADJUST&&e.state.isGlobal&&t>0&&(null==r||"stay-above"===r.type)}function rt(e,t,i,r){const n=dt(e,i,r,function(e,t,i,r){let n=pt(e,r,t,i);if(!e.state.constraints.tilt)return n;const s=e.state.constraints.tilt(t);return n=Math.min(n,.5*Math.PI),s.min*(1-ut)+n*ut}(e,r,t,i));return{tilt:n,mode:t-n<1?De.LOCKED:De.ADJUST}}function nt(e,t){return{...e,center:(0,d.d9)(t)}}function st(e,t){const{state:i,spatialReference:r}=e,n=t.spatialReference;return i.isGlobal&&(0,Se.D)(n,b.JY.Global)||i.isLocal&&r.equals(n)}function at(e,t){let i,r,n;if(e.state.isGlobal){const e=new m.Z(t.xmin,t.ymin,t.spatialReference),s=new m.Z(t.xmax,t.ymax,t.spatialReference),a=t.spatialReference.isGeographic?Oe:Ae;i=new m.Z({x:a.center(e.x,s.x),y:(s.y+e.y)/2,z:null!=t.zmax&&null!=t.zmin?(t.zmax+t.zmin)/2:void 0,spatialReference:t.spatialReference});const o=(0,p.Iu)(t.spatialReference),l=(0,ie.Nf)(i,e,s);r=l.lon,n=l.lat,a.diff(e.x,s.x)>a.range/2&&(r+=o.halfCircumference),r=Math.min(r,o.halfCircumference),n=Math.min(n,o.halfCircumference)}else{const s=e.renderSpatialReference??t.spatialReference;s.equals(t.spatialReference)||(t=(0,f.project)(t,s)),r=t.xmax-t.xmin,n=t.ymax-t.ymin;const a=null!=t.zmax&&null!=t.zmin?(t.zmax+t.zmin)/2:void 0;i=new m.Z({x:t.xmin+.5*r,y:t.ymin+.5*n,z:a,spatialReference:s})}const s=null!=t.zmax&&null!=t.zmin?t.zmax-t.zmin:0,a=e.state.camera,o=1/Math.tan(a.fovX/2),l=1/Math.tan(a.fovY/2),c=1/Math.tan(a.fov/2);return{center:i,distance:Math.max(.5*r*o,.5*n*l,.5*s*c)/1}}async function ot(e,t,i,r,n,s){const a=st(e,t)?t:await(0,f.projectWithZConversion)(t,e.spatialReference,{signal:s});(0,h.k_)(s);const{center:o,distance:l}=at(e,a),c=await Qe(e,i,r,o,l,n,s);return(0,h.k_)(s),ft(e,c,e.camera.fov,s)}function lt(e,t,i,r,n,s){let a;try{a=st(e,t)?t:(0,f.project)(t,e.spatialReference)}catch(e){return null}const{center:o,distance:l}=at(e,a),c=Ke(e,i,r,o,l,n);return null==c?null:mt(e,c,e.camera.fov,s)}function ct(e,t,i){const r=e.renderSpatialReference,n=new m.Z({spatialReference:Ie(e)});if(!(0,y.f)(i,r,n))return null;const s=Math.tan(t.fovX/2),a=Math.tan(t.fovY/2),o=(0,u.F)(t.eye,i),l=2*o*s*1,c=2*o*a*1;return Le(e).toExtent(e,n,l,c)}function ht(e,t){return Le(e).toArea(e,t)}const ut=.7;function dt(e,t,i,r){return Le(e).lookAtTiltToEyeTilt(r,t,i)}function pt(e,t,i,r){return Le(e).eyeTiltToLookAtTilt(r,t,i)}function mt(e,t,i,r){if(null==t)return null;const n=e.renderSpatialReference,s=new m.Z({spatialReference:Ie(e)});return(0,y.f)(t.eye,n,s)?(r??=new a.Z,r.position=s,r.heading=t.heading,r.tilt=t.tilt,r.fov=i,r):null}async function ft(e,t,i,r){const n=e.renderSpatialReference,s=new m.Z({spatialReference:Ie(e)});return await(0,y.A)(t.eye,n,s,{signal:r}),(0,h.k_)(r),new a.Z(s,t.heading,t.tilt,i)}function _t(e,t){const i=e.basemapTerrain?.tilingScheme;if(i)return i.levelAtScale(t);Me().error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function gt(e,t){const i=e.basemapTerrain?.tilingScheme;if(i)return i.scaleAtLevel(t);Me().error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}},59758:function(e,t,i){i.d(t,{H2:function(){return d},dp:function(){return h},t_:function(){return u}});var r=i(99574),n=i(24910),s=i(82846),a=i(88970),o=i(77773);const l=(0,s.Ue)(),c=(0,s.Ue)();function h(){return{direction:(0,s.Ue)(),up:(0,s.Ue)()}}function u(e,t,i,s,a){let o=(0,n.n)(l,e),h=(0,n.e)(o,s);const u=h>0;h=Math.abs(h),h>.99&&(h=Math.abs((0,n.e)(t,s)),h<.99?((0,n.c)(o,t),u&&(0,n.g)(o,o,-1)):o=null);let d=0;if(o){(0,n.g)(c,s,(0,n.e)(s,o)),(0,n.d)(o,o,c);const e=(0,n.e)(o,a)/((0,n.l)(o)*(0,n.l)(a));(0,n.h)(c,o,a),d=((0,n.e)(c,s)>0?1:-1)*(0,r.BV)((0,r.ZF)(e))}const p=(0,r.BV)((0,r.ZF)(-(0,n.e)(s,e)/(0,n.l)(e)));return i?(i.heading=d,i.tilt=p,i):{heading:d,tilt:p}}function d(e,t,i,r){(0,n.d)(p,i,t),(0,o.rx)(r,(0,a.re)(t,p),e)||e===i||(0,n.c)(e,i)}const p=(0,s.Ue)()},32185:function(e,t,i){i.d(t,{Be:function(){return l},Nf:function(){return o},dF:function(){return c}});var r=i(99574),n=i(47925),s=i(60508);function a(e,t,i){if(null==t.longitude||null==t.latitude||null==i.longitude||null==i.latitude)throw new Error("Invalid points: no lon/lat");return function(e,t,i,n,s){const a=(0,r.Vl)(i),o=(0,r.Vl)(s),l=a-o,c=(0,r.Vl)(t)-(0,r.Vl)(n),h=Math.sin(l/2),u=Math.sin(c/2),d=2*(0,r.Kt)(Math.sqrt(h*h+Math.cos(a)*Math.cos(o)*u*u))*e;return Math.round(1e4*d)/1e4}(e,t.longitude,t.latitude,i.longitude,i.latitude)}function o(e,t,i){const r=t.spatialReference,o=(0,n.Iu)(r),l=new s.Z(t.x,e.y,r),c=new s.Z(i.x,e.y,r),h=new s.Z(e.x,t.y,r),u=new s.Z(e.x,i.y,r);return{lon:a(o.radius,l,c),lat:a(o.radius,h,u)}}function l(e,t,i){const n=t/i,s=(0,r.Vl)(e),a=Math.sin(n/2),o=Math.cos(s),l=2*(0,r.Kt)(Math.sqrt(a*a/(o*o)));return(0,r.BV)(l)}function c(e,t){const i=e?.[0];if(null==i)return null;t||(t={hours:0,minutes:0,seconds:0}),t.hours=function(e,t){let i=e/15;return t||(i=Math.round(i)),i}(i,!0);const r=t.hours%1;t.hours-=r,t.minutes=60*r;const n=t.minutes%1;return t.minutes-=n,t.seconds=Math.round(60*n),t}},13445:function(e,t,i){i.d(t,{Bh:function(){return h},eW:function(){return d},iE:function(){return u},j$:function(){return l},u4:function(){return c}});var r=i(96094),n=i(26821),s=i(24910),a=i(12659),o=i(69811);function l(e,t,i=(0,a.Ue)()){return c(e,(0,r.md)(t),i),(0,s.n)(i.direction,i.direction),i}function c(e,t,i){return h(e,e.screenToRender(t,(0,r.Wv)(o.WM.get())),i)}function h(e,t,i){const a=(0,r.Wv)((0,n.JG)(o.WM.get(),t));if(a[2]=0,!e.unprojectFromRenderScreen(a,i.origin))return null;const l=(0,r.Wv)((0,n.JG)(o.WM.get(),t));l[2]=1;const c=e.unprojectFromRenderScreen(l,o.WM.get());return null==c?null:((0,s.d)(i.direction,c,i.origin),i)}function u(e,t,i){return d(e,e.screenToRender(t,(0,r.Wv)(o.WM.get())),i)}function d(e,t,i){(0,s.c)(i.origin,e.eye);const r=(0,s.i)(o.WM.get(),t[0],t[1],1),n=e.unprojectFromRenderScreen(r,o.WM.get());return null==n?null:((0,s.d)(i.direction,n,i.origin),i)}},43759:function(e,t,i){i.d(t,{K0:function(){return M},qL:function(){return w},us:function(){return E},wX:function(){return b}});var r=i(46451),n=i(96302),s=i(96094),a=i(82846),o=i(60508),l=i(45213),c=i(2051),h=i(78646),u=i(75428),d=i(27762),p=i(90494),m=i(92490),f=i(61442),_=i(32033),g=i(19821),y=i(90189),v=i(43925);async function b(e,t,i,r){const n=i?E(e,i):r,a=(0,s.s1)(t.x,t.y);n.requiresGroundFeedback=!0,n.enableDraped=!0;const o=new m.r(e.state.viewingMode);o.options.selectionMode=!0,o.options.store=f.e.ALL,e.sceneIntersectionHelper.intersectIntersectorScreen(a,o,n);const l=await async function(e,t,i){const r=new Array;let n,s=null;const a={defer(e){n=e()}};for(let o=0;o<t.length;o++){const l=t[o],c=(0,y.J4)(l,e);if(null!=c&&(c===e.map.ground||"type"in c&&(0,u.nx)(c.type)))break;const h=(0,y.bK)(l,e,a)??await n;if(n=null,null==h)continue;if("graphic"===h.type){if(null==s&&o!==t.length-1&&(s=new Set),null!=s){const e=x(h.graphic);if(s.has(e))continue;s.add(e)}if(!T(i,h.graphic))continue}const d=C(e,l),p=l.distanceInRenderSpace;if("media"===h.type){const e=h.element.toSource(d);r.push({...h,mapPoint:d,distance:p,sourcePoint:e})}else r.push({...h,mapPoint:d,distance:p})}return r}(e,o.results.all,n.graphics),c=o.results.ground,h=(0,y.J4)(c,e),p=null!=h&&"type"in h&&(0,u.nx)(h.type)?h:null,g={screenPoint:t,results:l,ground:{mapPoint:C(e,c),distance:(0,_.n)(c)?c.distanceInRenderSpace:0,layer:p}};return d.h.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(g.intersector=o),g}function w(e,t,i,r){const n=i?E(e,i):r,a=!(!n.graphics?.include&&!n.graphics?.exclude),o=!(!n.mediaElements?.include&&!n.mediaElements?.exclude),l=(0,s.md)(t);n.enableDraped=n.include&&!n.include.has(v.xX)||n.exclude?.has(v.xX);const c=e.sceneIntersectionHelper,h=new m.r(e.state.viewingMode);if(h.options.selectionMode=!0,h.options.store=a||o?f.e.ALL:f.e.MIN,h.options.excludeLabels=i?.excludeLabels??!1,c.intersectIntersectorScreen(l,h,n),a||o){for(const t of h.results.all){const i=(0,y.bK)(t,e);if(null==i)return C(e,t);if(a&&("graphic"!==i.type||T(n.graphics,i.graphic)))return C(e,t);if(o&&("media"!==i.type||S(n.mediaElements,i.element)))return C(e,t)}return null}return C(e,h.results.min)}function C(e,t,i){return t.getIntersectionPoint(O)?(i=M(e,O,i),t.intersector===g.q.TERRAIN&&e.basemapTerrain&&(i.z=(0,p.KO)(e.basemapTerrain,i)??0),i):null}function x(e){const t=e.sourceLayer,i=e.layer,r=t&&"objectIdField"in t?t:i&&"objectIdField"in i?i:t;if(r){const t=r.objectIdField??h.d,i=e.attributes?.[t];if(i)return`o-${r.id}-${i}`}return`u-${e.uid}`}function T(e,t){return S(e,x(t))}function S(e,t){return null==e||(null==e.include||e.include.has(t))&&(null==e.exclude||!e.exclude.has(t))}function M(e,t,i){let r=e.spatialReference||l.Z.WGS84;return(0,c.S)(t,e.renderSpatialReference,O,r)?t=O:(r=l.Z.WGS84,(0,c.S)(t,e.renderSpatialReference,O,r)&&(t=O)),i?(i.x=t[0],i.y=t[1],i.z=t[2],i.spatialReference=r):i=new o.Z(t,r),i}function E(e,t){const i=P(e,t.include,D.INCLUDE),r=P(e,t.exclude,D.EXCLUDE);return{include:i.layerViewUids,exclude:r.layerViewUids,graphics:{include:i.graphicUids,exclude:r.graphicUids},mediaElements:{include:i.mediaElements,exclude:r.mediaElements}}}function P(e,t,i,s={layerViewUids:void 0,graphicUids:void 0,mediaElements:void 0}){if(!t)return s;if(t instanceof r.Z)(function(e,t){e.graphicUids||(e.graphicUids=new Set),e.graphicUids.add(t)})(s,x(t)),i===D.INCLUDE&&(null!=e.graphicsView&&t.layer===e?A(s,e.graphicsView.uid):t.layer&&R(s,e,t.layer.uid));else if("layer"in t&&"element"in t)(function(e,t){e.mediaElements||(e.mediaElements=new Set),e.mediaElements.add(t)})(s,t.element),i===D.INCLUDE&&R(s,e,t.layer.uid);else if((0,n.TW)(t))for(const r of t)r===e.graphics&&null!=e.graphicsView?A(s,e.graphicsView.uid):r===e.map.ground?A(s,v.xX):P(e,r,i,s);else"uid"in t&&R(s,e,t.uid);return s}function R(e,t,i){const r=t.allLayerViews.find((e=>e.layer.uid===i));r&&A(e,r.uid)}function A(e,t){e.layerViewUids||(e.layerViewUids=new Set),e.layerViewUids.add(t)}const O=(0,a.Ue)();var D;!function(e){e[e.INCLUDE=0]="INCLUDE",e[e.EXCLUDE=1]="EXCLUDE"}(D||(D={}))},88270:function(e,t,i){var r;i.d(t,{Bh:function(){return r},NT:function(){return s},Ty:function(){return n}}),function(e){e[e.ELEVATION=0]="ELEVATION",e[e.BASEMAP=1]="BASEMAP",e[e.I3S_INDEX=2]="I3S_INDEX",e[e.I3S_DATA=3]="I3S_DATA",e[e.SYMBOLOGY=4]="SYMBOLOGY"}(r||(r={}));const n=(()=>{const e=new Array;return e[r.ELEVATION]=10,e[r.BASEMAP]=10,e[r.I3S_INDEX]=10,e[r.I3S_DATA]=10,e[r.SYMBOLOGY]=5,e})(),s=30},39717:function(e,t,i){i.d(t,{M:function(){return n},O:function(){return s}});var r=i(8554);function n(e){return s(e)||(0,r.BZ)(e)||(0,r.V2)(e)}function s(e){return(0,r.oR)(e)||(0,r.yW)(e)}},81808:function(e,t,i){i.d(t,{V:function(){return r},q:function(){return n}});const r={value:.5,readOnly:!0},n={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}}},38142:function(e,t,i){i.d(t,{T6:function(){return o},TX:function(){return a},j9:function(){return l}});var r=i(32033),n=i(31856),s=i(19821);function a(e){return(0,r.n)(e)&&e.intersector===s.q.TERRAIN&&!!e.target}class o extends n.D{constructor(e,t,i){super(e,t),this.triangleNr=i}}function l(e){return(0,r.n)(e)&&e.intersector===s.q.OVERLAY&&!!e.target}},29499:function(e,t,i){var r;i.d(t,{X:function(){return r}}),function(e){e[e.NORTH=0]="NORTH",e[e.NORTH_EAST=1]="NORTH_EAST",e[e.EAST=2]="EAST",e[e.SOUTH_EAST=3]="SOUTH_EAST",e[e.SOUTH=4]="SOUTH",e[e.SOUTH_WEST=5]="SOUTH_WEST",e[e.WEST=6]="WEST",e[e.NORTH_WEST=7]="NORTH_WEST"}(r||(r={}))},74446:function(e,t,i){var r;i.d(t,{z:function(){return r}}),function(e){e[e.BACK_TO_FRONT=-1]="BACK_TO_FRONT",e[e.NONE=0]="NONE",e[e.FRONT_TO_BACK=1]="FRONT_TO_BACK"}(r||(r={}))},61554:function(e,t,i){i.d(t,{$X:function(){return a},C5:function(){return p},Cf:function(){return o},GZ:function(){return h},JR:function(){return d},if:function(){return l},p1:function(){return m},qC:function(){return f},uU:function(){return u},zl:function(){return c}});var r=i(99574),n=i(47566),s=i(76060);const a=64,o=512,l=2.5,c=(0,r.oK)(r.F3/10),h=2,u=(0,n.Ue)();s.t.WebMercatorAuxiliarySphere.getExtent(0,0,0,u);const d=(0,n.Ue)([-180,-90,180,90]),p="Cannot extend surface to encompass all layers because it would result in too many root tiles.",m="Surface extent is too large for tile resolution at level 0.",f=4},74796:function(e,t,i){function r(e){return null!=e&&"type"in e&&"vector-tile"===e.type}function n(e){return null!=e&&"type"in e&&"raster-tile"===e.type}function s(e){return null!=e&&"type"in e&&"tile-texture"===e.type}function a(e){return null!=e&&"type"in e&&"image+type"===e.type}i.d(t,{AK:function(){return r},Cm:function(){return a},Q_:function(){return s},yd:function(){return n}})},76060:function(e,t,i){i.d(t,{_:function(){return f},t:function(){return m}});var r=i(88194),n=(i(61432),i(99574)),s=i(26636),a=i(71354),o=i(60508),l=i(45213),c=i(47566),h=i(8554),u=i(97290),d=i(45107),p=i(97550);class m{constructor(e){const t=m.checkUnsupported(e);if(null!=t)throw t;const i=e;this.spatialReference=i.spatialReference,this._isWebMercator=this.spatialReference.isWebMercator,this._isGCS=(0,h.sT)(this.spatialReference),this.origin=[i.origin.x,i.origin.y],this.pixelSize=i.size[0],this.dpi=i.dpi;const r=i.lods.reduce(((e,t)=>(t.level<e.minLod.level&&(e.minLod=t),e.max=Math.max(e.max,t.level),e)),{minLod:i.lods[0],max:-1/0}),n=r.minLod,s=2**n.level;let a=n.resolution*s,o=n.scale*s;this.levels=new Array(r.max+1);for(let e=0;e<this.levels.length;e++)this.levels[e]={resolution:a,scale:o,tileSize:[a*i.size[0],a*i.size[1]]},a/=2,o/=2}clone(){return new m(this.toTileInfo())}toTileInfo(){return new p.Z({dpi:this.dpi,origin:new o.Z({x:this.origin[0],y:this.origin[1],spatialReference:this.spatialReference}),size:[this.pixelSize,this.pixelSize],spatialReference:this.spatialReference,lods:this.levels.map(((e,t)=>new d.Z({level:t,scale:e.scale,resolution:e.resolution})))})}getExtent(e,t,i,r){const n=this.levels[e],s=n.tileSize[0],a=n.tileSize[1];r[0]=this.origin[0]+i*s,r[2]=this.origin[0]+(i+1)*s,r[3]=this.origin[1]-t*a,r[1]=this.origin[1]-(t+1)*a}convertExtentToRadians(e,t){this._isWebMercator?(t[0]=(0,u.tp)(e[0]),t[1]=(0,u.mZ)(e[1]),t[2]=(0,u.tp)(e[2]),t[3]=(0,u.mZ)(e[3])):this._isGCS&&(t[0]=(0,n.Vl)(e[0]),t[1]=(0,n.Vl)(e[1]),t[2]=(0,n.Vl)(e[2]),t[3]=(0,n.Vl)(e[3]))}getExtentGeometry(e,t,i,r=new a.Z){return this.getExtent(e,t,i,_),r.spatialReference=this.spatialReference,r.xmin=_[0],r.ymin=_[1],r.xmax=_[2],r.ymax=_[3],r.zmin=void 0,r.zmax=void 0,r}ensureMaxLod(e){if(null==e)return!1;let t=!1;for(;this.levels.length<=e;){const{resolution:e,scale:i}=this.levels[this.levels.length-1],r=e/2*this.pixelSize;this.levels.push({resolution:e/2,scale:i/2,tileSize:[r,r]}),t=!0}return t}capMaxLod(e){this.levels.length>e+1&&(this.levels.length=e+1)}getMaxLod(){return this.levels.length-1}scaleAtLevel(e){return this.levels[0].scale/2**e}levelAtScale(e){const t=this.levels[0].scale;return e>=t?0:Math.log(t/e)*Math.LOG2E}resolutionAtLevel(e){return this.levels[0].resolution/2**e}compatibleWith(e,t=1/0){if(m.checkUnsupported(e))return!1;const i=new m(e);if(!i.spatialReference.equals(this.spatialReference))return!1;if(i.pixelSize!==this.pixelSize)return!1;const r=Math.min(this.levels.length-1,i.levels.length-1,t),s=this.levels[r].resolution;let a=.5*s;return!(!(0,n.W8)(i.origin[0],this.origin[0],a)||!(0,n.W8)(i.origin[1],this.origin[1],a))&&(a=.5*s/2**r/this.pixelSize*12,(0,n.W8)(s,i.levels[r].resolution,a))}rootTilesInExtent(e,t=null,i=1/0){const r=new Array,n=this.levels[0].tileSize;if(null==e||0===n[0]||0===n[1])return r;m.computeRowColExtent(e,n,this.origin,_);let s=_[1],a=_[3],o=_[0],l=_[2];const c=l-o,h=a-s;if(c*h>i){const e=Math.floor(Math.sqrt(i));h>e&&(s=s+Math.floor(.5*h)-Math.floor(.5*e),a=s+e),c>e&&(o=o+Math.floor(.5*c)-Math.floor(.5*e),l=o+e)}for(let e=s;e<a;e++)for(let t=o;t<l;t++)r.push([0,e,t]);return null!=t&&(t[0]=this.origin[0]+o*n[0],t[1]=this.origin[1]-a*n[1],t[2]=this.origin[0]+l*n[0],t[3]=this.origin[1]-s*n[1]),r}static computeRowColExtent(e,t,i,r){const n=.001*(e[2]-e[0]+(e[3]-e[1]));r[0]=Math.max(0,Math.floor((e[0]+n-i[0])/t[0])),r[2]=Math.max(0,Math.ceil((e[2]-n-i[0])/t[0])),r[1]=Math.max(0,Math.floor((i[1]-e[3]+n)/t[1])),r[3]=Math.max(0,Math.ceil((i[1]-e[1]-n)/t[1]))}static isPowerOfTwo(e){const t=e.lods,i=t[0].resolution*2**t[0].level;return!t.some((e=>!(0,n.Y8)(e.resolution,i/2**e.level)))}static hasGapInLevels(e){const t=e.lods.map((e=>e.level));t.sort(((e,t)=>e-t));for(let e=1;e<t.length;e++)if(t[e]!==t[0]+e)return!0;return!1}static tileSizeSupported(e){const t=e.size[1];return t===e.size[0]&&!(t&t-1)&&t>=128&&t<=512}static hasOriginPerLODs(e){const t=e.origin;return e.lods.some((e=>null!=e.origin&&(e.origin[0]!==t.x||e.origin[1]!==t.y)))}static getMissingTileInfoError(){return new r.Z("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}static checkUnsupported(e){return null==e?f():e.lods.length<1?new r.Z("tilingscheme:generic","Tiling scheme must have at least one level"):m.isPowerOfTwo(e)?m.hasGapInLevels(e)?new r.Z("tilingscheme:gaps","Tiling scheme levels must not have gaps between min and max level"):m.tileSizeSupported(e)?m.hasOriginPerLODs(e)?new r.Z("tilingscheme:multiple-origin","Tiling scheme levels must not have their own origin"):null:new r.Z("tilingscheme:tile-size","Tiles must be square and size must be one of [128, 256, 512]"):new r.Z("tilingscheme:power-of-two","Tiling scheme must be power of two")}static fromExtent(e,t){const i=e[2]-e[0],r=e[3]-e[1],n=(0,s.c9)(t),a=1.2*Math.max(i,r),l=a/256,c=l*n*(96/.0254),h=new m(new p.Z({size:[256,256],origin:new o.Z({x:e[0]-.5*(a-i),y:e[3]+.5*(a-r)}),lods:[new d.Z({level:0,resolution:l,scale:c})],spatialReference:t}));return h.ensureMaxLod(20),h}static makeWebMercatorAuxiliarySphere(e){const t=new m(m.WebMercatorAuxiliarySphereTileInfo);return t.ensureMaxLod(e),t}static makeGCSWithTileSize(e,t=256,i=16){const r=256/t,n=new m(new p.Z({size:[t,t],origin:new o.Z({x:-180,y:90,spatialReference:e}),spatialReference:e,lods:[new d.Z({level:0,resolution:.703125*r,scale:295497598.570834*r})]}));return n.ensureMaxLod(i),n}static{this.WebMercatorAuxiliarySphereTileInfo=new p.Z({size:[256,256],origin:new o.Z({x:-20037508.342787,y:20037508.342787,spatialReference:l.Z.WebMercator}),spatialReference:l.Z.WebMercator,lods:[new d.Z({level:0,resolution:156543.03392800014,scale:591657527.591555})]})}static{this.WebMercatorAuxiliarySphere=m.makeWebMercatorAuxiliarySphere(19)}get test(){}}function f(){return new r.Z("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}const _=(0,c.Ue)()},9779:function(e,t,i){var r;i.d(t,{w:function(){return r}}),function(e){e[e.Opaque=0]="Opaque",e[e.Transparent=1]="Transparent",e[e.InvisibleWithDraped=2]="InvisibleWithDraped",e[e.Invisible=3]="Invisible",e[e.COUNT=4]="COUNT"}(r||(r={}))},6883:function(e,t,i){i.d(t,{Wq:function(){return j},er:function(){return V},qA:function(){return w},T9:function(){return y},HK:function(){return b},V0:function(){return v},E_:function(){return B},Fp:function(){return C},TK:function(){return A},Eu:function(){return Q},_1:function(){return P},a_:function(){return R},S3:function(){return F},sR:function(){return T},Ay:function(){return I},GL:function(){return O},Mw:function(){return ee},wt:function(){return Y},x4:function(){return x},uv:function(){return J},wP:function(){return D},z7:function(){return N},Q:function(){return M},B9:function(){return U},Ke:function(){return L},OD:function(){return K},_0:function(){return X},sP:function(){return q},cA:function(){return ie},OC:function(){return te},$v:function(){return W},_F:function(){return $},ep:function(){return H},Bu:function(){return G},FZ:function(){return k},zT:function(){return Z},jO:function(){return z},wu:function(){return g}});var r=i(43254),n=i(8554),s=i(75428),a=i(56172),o=i(29499),l=i(74796),c=i(88194),h=i(47566),u=i(39717),d=i(61554),p=i(76060);const m=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:function(e,t,i,r){if(null==e)return(0,p._)();const n=e.spatialReference;if(n.isGeographic&&!(0,u.O)(n))return new c.Z("tilingscheme:local-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in local scenes");const s=p.t.checkUnsupported(e);if(null!=s)return s;if(null==i)return new c.Z("tilingscheme:extent-not-exist","The layer does not provide a layer extent.");const a=function(e,t){const i=e.lods,r=i[0].resolution*2**i[0].level,n=[r*e.size[0],r*e.size[1]],s=[e.origin.x,e.origin.y],a=(0,h.oJ)(t),o=(0,h.Ue)();p.t.computeRowColExtent(a,n,s,o);const l=(o[2]-o[0])*(o[3]-o[1]);if(l>d.$X){const t=i[0].scale*2**i[0].level;let n=Math.max((a[3]-a[1])/e.size[1],(a[2]-a[0])/e.size[0])*t/r;const s=Math.floor(Math.log(n)/Math.log(10));return n=Math.ceil(n/10**s)*10**s,new c.Z("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(t).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+n.toLocaleString()+".",{level0Scale:t,suggestedLevel0Scale:n,requiredNumRootTiles:l,allowedNumRootTiles:d.$X})}return null}(e,i);return a||(null==t||n.equals(t)||t.isWGS84&&n.isWebMercator?null:new c.Z("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene"))}},Symbol.toStringTag,{value:"Module"}));const f=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:function(e,t,i,r){if(null==e)return(0,p._)();const n=e?.lods.length-1,s=e.spatialReference;if(s.isWebMercator){if(!p.t.makeWebMercatorAuxiliarySphere(n).compatibleWith(e,r))return new c.Z("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!(0,u.M)(s))return new c.Z("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!p.t.makeGCSWithTileSize(e.spatialReference,e.size[0],n).compatibleWith(e,r))return e.spatialReference.isWGS84?new c.Z("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new c.Z("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}return null==t||e.spatialReference.equals(t)?null:new c.Z("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene")}},Symbol.toStringTag,{value:"Module"})),_={[a.JY.Global]:f,[a.JY.Local]:m};function g(e,t){e||console.warn("Terrain: "+t)}let y=!1,v=!1;function b(e){v=e,y=y||e}function w(e){y=e}function C(e,t){if(y&&!e){const e=(new Error).stack?.slice(5);throw console.warn("Terrain internal: "+(t??"")+" at "+e),new Error("Assertion failed"+(t?": "+t:""))}}function x(e){return"imagery-tile"===e?.type||"wcs"===e?.type}function T(e){return"imagery-tile-3d"===e?.type}function S(e){return"tile-3d"===e?.type}function M(e){return"vector-tile-3d"===e?.type}function E(e){return"wmts-3d"===e?.type}function P(e){return"elevation-3d"===e?.type}function R(e){return"group"===e?.type}function A(e){return e&&(S(e)||E(e)||T(e)||M(e))}function O(e){return e&&(S(e)||T(e)||M(e)||E(e))}function D(e){return O(e)||P(e)}function I(e){return(0,l.yd)(e?.sourceLayerInfo?.data)}function L(e){return U(e?.sourceLayerInfo)||!!e?.isVTLBackground}function N(e){return(0,l.Q_)(e?.sourceLayerInfo?.data)}function F(e){const t=e?.sourceLayerInfo?.data;return(0,l.Cm)(t)||t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof ImageData}function U(e){return(0,l.AK)(e?.data)}function H(e){return null!=e&&"release"in e&&e.release(),null}function k(e){return e.fetchTile&&!1!==e.hasOverriddenFetchTile}function V(e,t,i,r,n){return _[r].checkIfTileInfoSupportedForViewSR(e,i,t,n)}function B(e,t,i){let n=null,o=null;if("wmts"===e?.type){const a=function(e,t,i){const n=(0,s.mt)(e);if(null!=n){if(!r.Z.isCollection(n))return{tileInfo:n.tileInfo,fullExtent:n.fullExtent};{const e=n.find((e=>null==V(e.tileInfo,e.fullExtent,t,i)));if(e)return{tileInfo:e.tileInfo,fullExtent:e.fullExtent}}}return{tileInfo:null,fullExtent:null}}(e,t,i);n=a.tileInfo,o=a.fullExtent}else{o=x(e)?e.getCompatibleFullExtent(t):e.fullExtent;const r=i===a.JY.Local;n=x(e)?e.getCompatibleTileInfo(t,o,r):"vector-tile"===e?.type?r&&!z(t)||G.force512VTL?e.tileInfo:e.tileInfo.getCompatibleForVTL(256):e.tileInfo}const l="tilemapCache"in e?e.tilemapCache?.effectiveMaxLOD:void 0;return null!=n&&null!=o&&null==V(n,o,t,i,l)?{tileInfo:n,fullExtent:o}:null}function z(e){return e.isWGS84||e.isWebMercator||(0,n.yW)(e)||!(0,n.N$)(e)}const G={force512VTL:!1};function q(e){return"["+e[0]+","+e[1]+","+e[2]+"]"}function Z(e){return"("+e[0]+","+e[1]+","+e[2]+")"}function j(e,t,i=re){return Math.abs(e-t)<i}function W(e){return e===o.X.NORTH_EAST?o.X.SOUTH_WEST:e===o.X.NORTH_WEST?o.X.SOUTH_EAST:e===o.X.SOUTH_WEST?o.X.NORTH_EAST:o.X.NORTH_WEST}function $(e){return e===o.X.NORTH?o.X.SOUTH:e===o.X.EAST?o.X.WEST:e===o.X.SOUTH?o.X.NORTH:o.X.EAST}function X(e){return e===o.X.NORTH_WEST||e===o.X.SOUTH_WEST}function Y(e){return e===o.X.NORTH_WEST||e===o.X.NORTH_EAST}function K(e){return e===o.X.NORTH_WEST||e===o.X.WEST||e===o.X.SOUTH_WEST}function Q(e){return e===o.X.NORTH_EAST||e===o.X.EAST||e===o.X.SOUTH_EAST}function J(e){return e===o.X.SOUTH_EAST||e===o.X.SOUTH||e===o.X.SOUTH_WEST}function ee(e){return e===o.X.NORTH_EAST||e===o.X.NORTH||e===o.X.NORTH_WEST}const te=[o.X.NORTH,o.X.EAST,o.X.SOUTH,o.X.WEST],ie=[o.X.NORTH_EAST,o.X.SOUTH_EAST,o.X.SOUTH_WEST,o.X.NORTH_WEST],re=1e-5},25907:function(e,t,i){i.d(t,{AA:function(){return a},Ay:function(){return c},E9:function(){return b},QT:function(){return y},W4:function(){return l},b:function(){return g},dF:function(){return m},gl:function(){return h},rv:function(){return o},t8:function(){return v},zW:function(){return u}});var r=i(63974),n=i(74446),s=i(6883);class a{constructor(){this._queue=new r.Z,this.remove=()=>{}}get done(){return 0===this._queue.length&&(!this._last||this._last.leaf)}resetOne(e){this._queue.clear(),this._queue.push(e),this._last=void 0}reset(e=null){this._queue.clear(),null!=e&&this._queue.pushArray(e),this._last=void 0}skipSubtree(){this._last=void 0}next(){const e=this._last?.children;return e?.[0]&&this._queue.pushArray(e),this._last=this._queue.pop(),this._last}}class o{constructor(){this._q=new r.Z}get done(){return 0===this._q.length}reset(e){if(this._q.clear(),null!=e){this._q.pushArray(e);for(let e=0;e<this._q.length;++e){const t=this._q.data[e];t.leaf||this._q.pushArray(t.children)}}}next(){return this._q.pop()}}function l(e,t){if(null==t)return!1;const i=function(e){return(0,s.sR)(e)?{fullExtent:e.fullExtent,minScale:e.layer.minScale,maxScale:e.layer.maxScale}:e.layer}(t);if(null==i?.fullExtent)return!1;const r=i.fullExtent,n=e.extent;if(r.xmin>n[2]||r.ymin>n[3]||r.xmax<n[0]||r.ymax<n[1])return!1;const a=e.surface.tilingScheme.levels[e.level].scale,o=i.minScale;if(o>0&&a>1.00000001*o)return!1;const l=i.maxScale;return!(l>0&&a<.99999999*l)}function c(e){return!(0,s.sR)(e)&&e.layer&&"tilemapCache"in e.layer?e.layer.tilemapCache:null}function h(e,t){const i=e.lij,r=t.lij;return i[0]-r[0]||i[1]-r[1]||i[2]-r[2]}function u(e,t,i=null){null==i||0===i.length?e===n.z.BACK_TO_FRONT?t.sort(d):t.sort(p):t.sort(((t,r)=>function(e,t,i,r){return f(e,r)===f(t,r)?m(e,t,i):e?i:-i}(t,r,e,i)))}function d(e,t){const i=t.screenDepth-e.screenDepth;if(0!==i)return i;const r=e.lij,n=t.lij;return r[0]-n[0]||r[1]-n[1]||r[2]-n[2]}function p(e,t){const i=e.screenDepth-t.screenDepth;if(0!==i)return i;const r=e.lij,n=t.lij;return r[0]-n[0]||r[1]-n[1]||r[2]-n[2]}function m(e,t,i){const r=e.screenDepth,n=t.screenDepth;return r<n?-i:r>n?i:h(e,t)}function f(e,t){for(const i of t)if(e.intersectsExtent(i))return!0;return!1}function _(e,t){const i=e.distanceToPOI-t.distanceToPOI;if(0!==i)return i;const r=e.lij,n=t.lij;return r[0]-n[0]||r[1]-n[1]||r[2]-n[2]}function g(e,t){const i=e.length;for(let r=0;r<i;++r)e.at(r).updateDistanceToPOI(t);e.sort(_)}function y(e,t,i){let r=1,n=0,s=0;for(;e!==t;)if(r*=.5,n*=.5,s*=.5,1&e.lij[2]&&(n+=.5),1&e.lij[1]||(s+=.5),null==(e=e.parent))throw new Error("tile was not a descendant of upsampleTile");i.init(t,n,s,r)}function v(e){for(let t=0;t<e.length;t++){const i=e[t],r=i.parent;if(r)for(let e=0;e<4;e++){const t=r.children[e];if(t&&t!==i)return!0}}return!1}function b(e,t){if(!e||!t||e[0]===t[0])return!1;const i=e[0]<t[0],r=i?e:t,n=i?t:e,s=1<<n[0]-r[0];return Math.floor(n[1]/s)===r[1]&&Math.floor(n[2]/s)===r[2]}},44417:function(e,t,i){i.d(t,{Un:function(){return H},ws:function(){return x},zO:function(){return V},Qu:function(){return B}});var r=i(73440),n=i(96373),s=i(30748),a=i(24910),o=i(82846),l=i(73749),c=i(27583),h=i(88331),u=i(72432),d=i(61796),p=i(21184),m=i(29041),f=i(54998),_=i(92473),g=i(74826);class y extends g.K{constructor(){super(...arguments),this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,null!=this._parameterBlocks)for(const e of this._parameterBlocks)this[e]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(null==this._parameterBlocks)return!1;for(const e of this._parameterBlocks)if(this[e].dirty)return!0;return!1}}class v{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}}function b(e={}){return(t,i)=>{const r=t._parameterCount??0;if(t._parameterCount=r+1,e.vectorOps){const n=e.vectorOps;Object.defineProperty(t,i,{get(){return this[r]},set(e){const t=this[r];if(null==t)this[r]=[...e];else{if(n.equals(t,e))return;n.copy(t,e)}this._setDirty()}})}else Object.defineProperty(t,i,{get(){return this[r]},set(t){this[r]!==t&&(e.dispose&&this[r]&&this[r].dispose(),this[r]=t,this._setDirty())}})}}function w(){return(e,t)=>{const i=e._parameterCount??0;e._parameterCount=i+1,e._parameterBlocks=e._parameterBlocks||[],e._parameterBlocks.push(i),Object.defineProperty(e,t,{get(){return this[i]},set(e){this[i]!==e&&(this[i]=e,this._setDirty())}})}}var C,x,T=i(74222),S=i(41044),M=i(57716),E=i(34479),P=i(83346),R=i(42510),A=i(93270),O=i(20022),D=i(32420),I=i(33610),L=i(948),N=i(18836),F=i(43295),U=i(64801);class H extends y{constructor(e,t){super(),this.toMapSpace=t,this.baseColor=(0,c.vV)(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=N.xq,this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.normalTexture=null,this.occlusionTexture=null,this.emissionTexture=null,this.emissiveBaseColor=(0,o.vV)(0,0,0),this.emissiveStrength=1,this.emissiveSource=h.V6.Emissive,this.commonMaterialParameters=new k,this.componentParameters=new V,this.objectOpacity=1,this.textureAlphaCutoff=U.e,this.alphaDiscardMode=D.JJ.Opaque,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=A.U.Earth,this.hasOccludees=!1;const i=new O.I(e.position),r=(0,s.d9)(e.rotationScale);(0,n.U_)(r,r),(0,n.p4)(r,r),this.transformNormalGlobalFromModel=r,this.transformWorldFromModelTL=i.low,this.transformWorldFromModelTH=i.high,this.transformWorldFromModelRS=e.rotationScale}dispose(){this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}get hasEmissions(){return null!=this.emissionTexture||!(0,a.q)(this.emissiveBaseColor,o.AG)}get texture(){return this.baseColorTexture?.glTexture}get textureMetallicRoughness(){return this.metallicRoughnessTexture?.glTexture}get textureEmissive(){return this.emissionTexture?.glTexture}get textureOcclusion(){return this.occlusionTexture?.glTexture}get textureNormal(){return this.normalTexture?.glTexture}acquireTechnique(e,t,i,r){const n=new m._(e.context.spherical);n.renderOccluded=i.slot===L.r.OCCLUDED_GROUND,n.hasVertexColors=r.colors,n.hasNormals=r.hasNormals,n.textureCoordinateType=r.textureCoordinates,n.hasMetallicRoughnessTexture=null!=this.metallicRoughnessTexture,n.hasOcclusionTexture=null!=this.occlusionTexture,n.hasNormalTexture=null!=this.normalTexture,n.oitPass=t.identifier===T.o.Material&&null!=i.oitPass?i.oitPass:I.M.NONE,n.terrainDepthTest=t.identifier===T.o.Material&&i.terrainDepthTest,n.cullAboveTerrain=t.identifier===T.o.Material&&i.cullAboveTerrain,n.ellipsoidMode=this.ellipsoidMode,n.componentData=this.componentParameters.type,n.cullFace=this.commonMaterialParameters.cullFace,n.doubleSidedMode=this.commonMaterialParameters.doubleSided?P.q.View:P.q.None,n.hasColorTexture=null!=this.baseColorTexture;const s=this._computeWhichMaterialPass();if(n.blendingEnabled=s===C.Transparent||s===C.OpaqueAndTransparent,n.alphaDiscardMode=this.alphaDiscardMode,n.integratedMeshMode=this.isIntegratedMesh?function(e){return null!=e.overlay?.getTexture(d.D.ColorNoRasterImage)}(i)?function(e){return null!=e.overlay?.getTexture(d.D.WaterNormal)}(i)?m.O.ColorOverlayWithWater:m.O.ColorOverlay:m.O.NoOverlay:m.O.None,n.hasPolygonOffset=this.polygonOffsetEnabled,n.pbrMode=n.integratedMeshMode===m.O.ColorOverlayWithWater?R.f7.WaterOnIntegratedMesh:this.usePBR?this.hasParametersFromSource?r.shadeNormals&&this.isIntegratedMesh?R.f7.Disabled:R.f7.Schematic:R.f7.Normal:R.f7.Disabled,n.emissionSource=this.hasEmissions?null!=this.emissionTexture?E.jo.Texture:n.pbrMode===R.f7.Normal?E.jo.SymbolColor:E.jo.None:E.jo.None,n.shadeNormals=r.shadeNormals,n.normalType=n.hasNormals?M.r.Compressed:M.r.ScreenDerivative,n.hasSlicePlane=null!=i.slicePlane&&this.commonMaterialParameters.hasSlicePlane,n.receiveAmbientOcclusion=n.hasOccludees=n.receiveShadows=n.screenSpaceReflections=n.cloudReflections=n.hasHighlightMixTexture=!1,t.identifier===T.o.ShadowMap)n.output=S.H_.Shadow,n.vertexDiscardMode=_.a.None;else if(t.identifier===T.o.ViewshedShadowMap)n.output=S.H_.ViewshedShadow,n.vertexDiscardMode=_.a.None;else if(t.identifier===T.o.Highlight)n.output=S.H_.Highlight,n.vertexDiscardMode=_.a.None,n.hasHighlightMixTexture=null!=i.highlightMixTexture;else{switch(s===C.OpaqueAndTransparent?n.vertexDiscardMode=t.transparent?_.a.Opaque:_.a.Transparent:n.vertexDiscardMode=_.a.None,n.hasBloom=(0,S.qC)(t.output),n.output=t.output,t.output){case S.H_.Color:case S.H_.ColorEmission:n.receiveAmbientOcclusion=r.applySSAO&&null!=i.ssao?.getTexture(),n.hasOccludees=i.hasOccludees,n.receiveShadows=i.shadowMap.ready,n.screenSpaceReflections=null!=i.ssr.lastFrameColor,n.cloudReflections=null!=i.clouds.data?.cubeMap?.colorTexture;break;case S.H_.ObjectAndLayerIdColor:n.objectAndLayerIdColor=!0}n.snowCover=i.snowCover}const a=e.get(p.h,n);return this._setClean(),a}submit(e,t,i){if(this.objectOpacity<=0)return;const{componentData:r,renderable:n}=i,{geometry:s}=n,a=n.meta.cameraDepthSquared;r.updateHighlights(t.highlights);const{geometryRanges:o,highlightRangesMap:l,shadowmapRanges:c}=r;switch(this._computeWhichMaterialPass()){case C.Opaque:e.opaque.submitDraw(this,s,o,a);break;case C.Transparent:e.transparent.submitDraw(this,s,o,a);break;case C.OpaqueAndTransparent:e.opaque.submitDraw(this,s,o,a),e.transparent.submitDraw(this,s,o,a);break;case C.IntegratedMesh:e.integratedMesh.submitDraw(this,s,o,a),function(e){return null!=e.overlay?.getTexture(d.D.Occluded)}(t)&&e.occludedGround.submitDraw(this,s,o,a),function(e){return null!=e.overlay?.getTexture(d.D.Highlight)}(t)&&e.highlightIntegratedMesh.submitDraw(this,s,o,a)}if(this.componentParameters.castShadows!==x.None){if(null!=l)for(const t of l)t[0]===F.b&&e.highlightShadowMap.submitDraw(this,s,t[1],a,t[0]);null!=c&&e.defaultShadowMap.submitDraw(this,s,c,a),e.shadowMap.submitDraw(this,s,o,a)}if(null!=l)for(const t of l)e.highlight.submitDraw(this,s,t[1],a,t[0]);t.viewshedEnabled&&e.viewshedShadowMap.submitDraw(this,s,o,a)}_computeWhichMaterialPass(){if(this.isIntegratedMesh)return C.IntegratedMesh;if(this.objectOpacity<1)return C.Transparent;if(this.componentParameters.opaqueOverride===x.All)return C.Opaque;if(this.baseColor[3]<1||this.alphaDiscardMode===D.JJ.Blend||this.alphaDiscardMode===D.JJ.MaskBlend)return C.Transparent;switch(this.componentParameters.transparent){case x.None:return C.Opaque;case x.All:return C.Transparent;case x.Some:return C.OpaqueAndTransparent}}}(0,r._)([b({vectorOps:l.v})],H.prototype,"baseColor",void 0),(0,r._)([b()],H.prototype,"usePBR",void 0),(0,r._)([b()],H.prototype,"hasParametersFromSource",void 0),(0,r._)([b({vectorOps:a.I})],H.prototype,"mrrFactors",void 0),(0,r._)([b({dispose:!0})],H.prototype,"baseColorTexture",void 0),(0,r._)([b({dispose:!0})],H.prototype,"metallicRoughnessTexture",void 0),(0,r._)([b({dispose:!0})],H.prototype,"normalTexture",void 0),(0,r._)([b({dispose:!0})],H.prototype,"occlusionTexture",void 0),(0,r._)([b({dispose:!0})],H.prototype,"emissionTexture",void 0),(0,r._)([b({vectorOps:a.I})],H.prototype,"emissiveBaseColor",void 0),(0,r._)([b()],H.prototype,"emissiveStrength",void 0),(0,r._)([b()],H.prototype,"emissiveSource",void 0),(0,r._)([w()],H.prototype,"commonMaterialParameters",void 0),(0,r._)([w()],H.prototype,"componentParameters",void 0),(0,r._)([b()],H.prototype,"objectOpacity",void 0),(0,r._)([b()],H.prototype,"textureAlphaCutoff",void 0),(0,r._)([b()],H.prototype,"alphaDiscardMode",void 0),(0,r._)([b()],H.prototype,"isIntegratedMesh",void 0),(0,r._)([b()],H.prototype,"polygonOffsetEnabled",void 0),(0,r._)([b()],H.prototype,"ellipsoidMode",void 0),(0,r._)([b()],H.prototype,"hasOccludees",void 0),function(e){e[e.Opaque=0]="Opaque",e[e.Transparent=1]="Transparent",e[e.OpaqueAndTransparent=2]="OpaqueAndTransparent",e[e.IntegratedMesh=3]="IntegratedMesh"}(C||(C={}));class k extends v{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=D.Vr.Back,this.hasSlicePlane=!0}}(0,r._)([b()],k.prototype,"doubleSided",void 0),(0,r._)([b()],k.prototype,"cullFace",void 0),(0,r._)([b()],k.prototype,"hasSlicePlane",void 0);class V extends v{constructor(){super(...arguments),this.externalColor=(0,c.al)(1,1,1,1),this.externalColorMixMode=u.a9.Multiply,this.castShadows=x.All}get transparent(){return this.externalColor[3]<1?x.All:x.None}get opaqueOverride(){return this.externalColorMixMode===u.a9.Replace&&1===this.externalColor[3]?x.All:x.None}get visible(){return this.externalColor[3]>0?x.All:x.None}get type(){return f._N.Uniform}}(0,r._)([b({vectorOps:l.v})],V.prototype,"externalColor",void 0),(0,r._)([b()],V.prototype,"externalColorMixMode",void 0),(0,r._)([b()],V.prototype,"castShadows",void 0),function(e){e[e.All=0]="All",e[e.Some=1]="Some",e[e.None=2]="None"}(x||(x={}));class B extends v{constructor(){super(...arguments),this.texture=null,this.transparent=x.None,this.opaqueOverride=x.None,this.castShadows=x.None}get type(){return f._N.Varying}}(0,r._)([b()],B.prototype,"texture",void 0),(0,r._)([b()],B.prototype,"transparent",void 0),(0,r._)([b()],B.prototype,"opaqueOverride",void 0),(0,r._)([b()],B.prototype,"castShadows",void 0)},21184:function(e,t,i){i.d(t,{h:function(){return m},k:function(){return f}});var r=i(29041),n=i(58498),s=i(41044),a=i(58257),o=i(29107),l=i(32420),c=i(33610),h=i(61536),u=i(26041),d=i(52061),p=i(51135);class m extends o.A{constructor(e,t){super(e,t,new a.J(n.C,(()=>i.e(97979).then(i.bind(i,97979)))),f)}initializePipeline(e){const{integratedMeshMode:t,output:i,blendingEnabled:n,cullFace:a,hasOccludees:d,hasPolygonOffset:m,oitPass:f,renderOccluded:_}=e,g=t!==r.O.None,y=f===c.M.NONE,v=f===c.M.FrontFace;return(0,p.sm)({blending:_?p.Zo:(0,s.c1)(i)&&n?(0,h.Wo)(f):null,culling:(0,p.zp)(a),depthTest:_?null:{func:(0,h.Bh)(f)},depthWrite:_||!y&&!v?null:p.ck,drawBuffers:(0,o.E)(i,(0,h.u_)(f,i)),colorWrite:p.gf,stencilWrite:!_&&g||d?u.s3:null,stencilTest:g?(0,u.ec)(l.hU.IntegratedMeshMaskExcluded):d?u.RY:null,polygonOffset:y||v?m?{factor:2,units:2}:null:h.E0})}}const f=new Map([[d.T.POSITION,0],[d.T.NORMAL,1],[d.T.NORMALCOMPRESSED,1],[d.T.COLOR,2],[d.T.UV0,3],[d.T.UVREGION,4],[d.T.COMPONENTINDEX,5]])},29041:function(e,t,i){i.d(t,{O:function(){return r},_:function(){return y}});var r,n=i(73440),s=i(54998),a=i(92473),o=i(41044),l=i(57716),c=i(31839),h=i(34479),u=i(83346),d=i(42510),p=i(93270),m=i(83046),f=i(32420),_=i(33610),g=i(5998);!function(e){e[e.None=0]="None",e[e.NoOverlay=1]="NoOverlay",e[e.ColorOverlay=2]="ColorOverlay",e[e.ColorOverlayWithWater=3]="ColorOverlayWithWater",e[e.COUNT=4]="COUNT"}(r||(r={}));class y extends m.m{constructor(e){super(),this.spherical=e,this.output=o.H_.Color,this.textureCoordinateType=c.I.None,this.componentData=s._N.Uniform,this.cullFace=f.Vr.Back,this.vertexDiscardMode=a.a.None,this.doubleSidedMode=u.q.WindingOrder,this.alphaDiscardMode=f.JJ.Opaque,this.integratedMeshMode=r.None,this.oitPass=_.M.NONE,this.ellipsoidMode=p.U.Earth,this.pbrMode=d.f7.Disabled,this.normalType=l.r.Attribute,this.emissionSource=h.jo.None,this.hasVertexColors=!1,this.hasNormals=!1,this.shadeNormals=!0,this.hasSlicePlane=!1,this.hasColorTexture=!1,this.hasHighlightMixTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.blendingEnabled=!0,this.screenSpaceReflections=!1,this.hasPolygonOffset=!1,this.hasMetallicRoughnessTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.hasNormalTextureTransform=!1,this.cloudReflections=!0,this.snowCover=!1,this.objectAndLayerIdColor=!1,this.hasBloom=!1,this.renderOccluded=!1,this.discardInvisibleFragments=!1,this.occlusionPass=!1,this.bindType=g.P.Draw,this.useCustomDTRExponentForWater=!1,this.hasVertexTangents=!1,this.highStepCount=!1,this.instancedDoublePrecision=!1,this.hasModelTransformation=!1,this.useFillLights=!0,this.objectAndLayerIdColorInstanced=!1,this.draped=!1}get overlayEnabled(){return(this.integratedMeshMode===r.ColorOverlay||this.integratedMeshMode===r.ColorOverlayWithWater)&&(0,o.Qo)(this.output)}}(0,n._)([(0,m.o)({count:o.H_.COUNT})],y.prototype,"output",void 0),(0,n._)([(0,m.o)({count:c.I.COUNT})],y.prototype,"textureCoordinateType",void 0),(0,n._)([(0,m.o)({count:s._N.COUNT})],y.prototype,"componentData",void 0),(0,n._)([(0,m.o)({count:f.Vr.COUNT})],y.prototype,"cullFace",void 0),(0,n._)([(0,m.o)({count:a.a.COUNT})],y.prototype,"vertexDiscardMode",void 0),(0,n._)([(0,m.o)({count:u.q.COUNT})],y.prototype,"doubleSidedMode",void 0),(0,n._)([(0,m.o)({count:f.JJ.COUNT})],y.prototype,"alphaDiscardMode",void 0),(0,n._)([(0,m.o)({count:r.COUNT})],y.prototype,"integratedMeshMode",void 0),(0,n._)([(0,m.o)({count:_.M.COUNT})],y.prototype,"oitPass",void 0),(0,n._)([(0,m.o)({count:p.U.COUNT})],y.prototype,"ellipsoidMode",void 0),(0,n._)([(0,m.o)({count:d.f7.COUNT})],y.prototype,"pbrMode",void 0),(0,n._)([(0,m.o)({count:l.r.COUNT})],y.prototype,"normalType",void 0),(0,n._)([(0,m.o)({count:h.jo.COUNT})],y.prototype,"emissionSource",void 0),(0,n._)([(0,m.o)()],y.prototype,"hasVertexColors",void 0),(0,n._)([(0,m.o)()],y.prototype,"hasNormals",void 0),(0,n._)([(0,m.o)()],y.prototype,"shadeNormals",void 0),(0,n._)([(0,m.o)()],y.prototype,"hasSlicePlane",void 0),(0,n._)([(0,m.o)()],y.prototype,"hasColorTexture",void 0),(0,n._)([(0,m.o)()],y.prototype,"hasHighlightMixTexture",void 0),(0,n._)([(0,m.o)()],y.prototype,"receiveAmbientOcclusion",void 0),(0,n._)([(0,m.o)()],y.prototype,"receiveShadows",void 0),(0,n._)([(0,m.o)()],y.prototype,"blendingEnabled",void 0),(0,n._)([(0,m.o)()],y.prototype,"screenSpaceReflections",void 0),(0,n._)([(0,m.o)()],y.prototype,"hasPolygonOffset",void 0),(0,n._)([(0,m.o)()],y.prototype,"hasMetallicRoughnessTexture",void 0),(0,n._)([(0,m.o)()],y.prototype,"hasOcclusionTexture",void 0),(0,n._)([(0,m.o)()],y.prototype,"hasNormalTexture",void 0),(0,n._)([(0,m.o)()],y.prototype,"hasOccludees",void 0),(0,n._)([(0,m.o)()],y.prototype,"terrainDepthTest",void 0),(0,n._)([(0,m.o)()],y.prototype,"cullAboveTerrain",void 0),(0,n._)([(0,m.o)()],y.prototype,"hasNormalTextureTransform",void 0),(0,n._)([(0,m.o)()],y.prototype,"cloudReflections",void 0),(0,n._)([(0,m.o)()],y.prototype,"snowCover",void 0),(0,n._)([(0,m.o)()],y.prototype,"objectAndLayerIdColor",void 0),(0,n._)([(0,m.o)()],y.prototype,"hasBloom",void 0),(0,n._)([(0,m.o)()],y.prototype,"renderOccluded",void 0)},92473:function(e,t,i){var r;i.d(t,{a:function(){return r}}),function(e){e[e.None=0]="None",e[e.Transparent=1]="Transparent",e[e.Opaque=2]="Opaque",e[e.COUNT=3]="COUNT"}(r||(r={}))},91129:function(e,t,i){i.d(t,{N:function(){return l},h:function(){return o}});var r=i(52890),n=i(31839),s=i(52061),a=i(74826);class o extends a.K{constructor(e,t,i,r,n){super(),this.colors=e,this.textureCoordinates=t,this.hasNormals=i,this.shadeNormals=r,this.applySSAO=n}}function l({hasNormals:e,textureCoordinates:t,colors:i}){const a=(0,r.U$)().vec3f(s.T.POSITION);return e&&a.vec2i16(s.T.NORMALCOMPRESSED,{glNormalized:!0}),t===n.I.Default?a.vec2f(s.T.UV0):t===n.I.Atlas&&(a.vec2f(s.T.UV0),a.vec4u16(s.T.UVREGION,{glNormalized:!0})),i&&a.vec4u8(s.T.COLOR,{glNormalized:!0}),a.freeze()}},68593:function(e,t,i){i.d(t,{R:function(){return a}});var r=i(20638),n=i(77983),s=i(48857);function a(e){const t=e.fragment;e.include(n.GZ),t.include(r.K),t.code.add(s.H`vec3 normalFromDepth(sampler2D depthMap, vec3 pixelPos, vec2 fragCoord, vec2 uv) {
ivec2 iuv = ivec2(uv * vec2(textureSize(depthMap, 0)));
float leftPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(-1, 0), 0).r);
float rightPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(1, 0), 0).r);
float bottomPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(0, -1), 0).r);
float topPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(0, 1), 0).r);
bool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);
bool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);
vec3 fragCoordHorizontal = pickLeft
? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)
: vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);
vec3 fragCoordVertical = pickBottom
? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)
: vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);
vec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);
vec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);
vec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));
return pickLeft == pickBottom ? normal : -normal;
}`)}},82630:function(e,t,i){i.d(t,{M:function(){return n}});var r=i(48857);function n(e,t){e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),t.spherical?e.vertex.code.add(r.H`void forwardVertexTangent(vec3 n) {
tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));
tbnBiTangent = normalize(cross(n, tbnTangent));
}`):e.vertex.code.add(r.H`void forwardVertexTangent(vec3 n) {
tbnTangent = vec3(1.0, 0.0, 0.0);
tbnBiTangent = normalize(cross(n, tbnTangent));
}`),e.fragment.code.add(r.H`mat3 getTBNMatrix(vec3 n) {
return mat3(tbnTangent, tbnBiTangent, n);
}`)}},17993:function(e,t,i){var r;i.d(t,{MV:function(){return s},iM:function(){return r},pU:function(){return n}}),function(e){e[e.Normal=0]="Normal",e[e.Average=1]="Average",e[e.Lighten=2]="Lighten",e[e.Lighter=3]="Lighter",e[e.Plus=4]="Plus",e[e.Screen=5]="Screen",e[e.ColorDodge=6]="ColorDodge",e[e.Darken=7]="Darken",e[e.Multiply=8]="Multiply",e[e.ColorBurn=9]="ColorBurn",e[e.Overlay=10]="Overlay",e[e.SoftLight=11]="SoftLight",e[e.HardLight=12]="HardLight",e[e.VividLight=13]="VividLight",e[e.Hue=14]="Hue",e[e.Saturation=15]="Saturation",e[e.Luminosity=16]="Luminosity",e[e.Color=17]="Color",e[e.DestinationOver=18]="DestinationOver",e[e.DestinationAtop=19]="DestinationAtop",e[e.DestinationIn=20]="DestinationIn",e[e.DestinationOut=21]="DestinationOut",e[e.SourceAtop=22]="SourceAtop",e[e.SourceIn=23]="SourceIn",e[e.SourceOut=24]="SourceOut",e[e.Xor=25]="Xor",e[e.Difference=26]="Difference",e[e.Exclusion=27]="Exclusion",e[e.Minus=28]="Minus",e[e.Invert=29]="Invert",e[e.Reflect=30]="Reflect",e[e.COUNT=31]="COUNT"}(r||(r={}));const n={normal:r.Normal,average:r.Average,lighten:r.Lighten,lighter:r.Lighter,screen:r.Screen,plus:r.Plus,"color-dodge":r.ColorDodge,darken:r.Darken,multiply:r.Multiply,"color-burn":r.ColorBurn,overlay:r.Overlay,"soft-light":r.SoftLight,"hard-light":r.HardLight,"vivid-light":r.VividLight,hue:r.Hue,saturation:r.Saturation,luminosity:r.Luminosity,color:r.Color,difference:r.Difference,exclusion:r.Exclusion,minus:r.Minus,invert:r.Invert,reflect:r.Reflect,"destination-over":r.DestinationOver,"destination-atop":r.DestinationAtop,"destination-in":r.DestinationIn,"destination-out":r.DestinationOut,"source-atop":r.SourceAtop,"source-in":r.SourceIn,"source-out":r.SourceOut,xor:r.Xor};function s(e){return e===r.DestinationOver||e===r.DestinationAtop||e===r.DestinationIn||e===r.DestinationOut||e===r.SourceAtop||e===r.SourceIn||e===r.SourceOut||e===r.Xor}},24807:function(e,t,i){i.d(t,{_:function(){return a}});var r=i(41044),n=i(40122),s=i(48857);function a(e,t){t.output===r.H_.Highlight&&(e.include(n.b,t),e.fragment.code.add(s.H`
    void calculateOcclusionAndOutputHighlight(uvec2 highlightToAdd) {
      uint levelBits = readLevelBits(highlightToAdd, highlightLevel);
      if ((levelBits & 1u) == 0u) discard;
      outputHighlight(isHighlightOccluded());
    }
  `))}},94129:function(e,t,i){i.d(t,{i:function(){return a}});var r=i(85119),n=i(48857),s=i(34709);function a(e){e.fragment.uniforms.add(new s.A("u_colormap",(e=>e.u_colormap)),new r.p("u_colormapOffset",(e=>e.colormap.u_colormapOffset)),new r.p("u_colormapMaxIndex",(e=>e.colormap.u_colormapMaxIndex)),new r.p("u_opacity",(e=>e.common.u_opacity))),e.fragment.code.add(n.H`vec4 colormap(vec4 currentPixel, bool isFloat) {
float colorIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;
vec4 result;
if (currentPixel.a == 0.0 || colorIndex > u_colormapMaxIndex) {
result = vec4(0.0, 0.0, 0.0, 0.0);
} else {
vec2 texelCoordinates = vec2((colorIndex + 0.5), 0.5);
result = texelFetch(u_colormap, ivec2(texelCoordinates), 0);
}
return result;
}`)}},13887:function(e,t,i){i.d(t,{G:function(){return h},J:function(){return c}});var r=i(19155),n=i(48857),s=i(34709);function a(e){e.fragment.uniforms.add(new s.A("u_transformGrid",(e=>e.u_transformGrid)),new r.A("u_transformSpacing",(e=>e.common.u_transformSpacing)),new r.A("u_targetImageSize",(e=>e.common.u_targetImageSize))),e.fragment.code.add(n.H`vec2 projectPixelLocation(vec2 coords) {
vec2 index_image = floor(coords * u_targetImageSize);
vec2 oneTransformPixel = vec2(4.0, 1.0);
vec2 index_transform = floor(index_image / u_transformSpacing) * oneTransformPixel;
vec2 pos = fract((index_image + 0.5) / u_transformSpacing);
vec2 transform_location = index_transform + 0.5;
vec2 srcLocation;
if (pos.s <= pos.t) {
vec3 ll_abc = texelFetch(u_transformGrid, ivec2(transform_location), 0).rgb;
vec3 ll_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 1.0, transform_location.t), 0).rgb;
srcLocation.s = dot(ll_abc, vec3(pos, 1.0));
srcLocation.t = dot(ll_def, vec3(pos, 1.0));
} else {
vec3 ur_abc = texelFetch(u_transformGrid, ivec2(transform_location.s + 2.0, transform_location.t), 0).rgb;
vec3 ur_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 3.0, transform_location.t), 0).rgb;
srcLocation.s = dot(ur_abc, vec3(pos, 1.0));
srcLocation.t = dot(ur_def, vec3(pos, 1.0));
}
return srcLocation;
}`)}var o=i(58226),l=i(54231);class c extends o.R{constructor(e,t,i){super(),this.common=e,this.u_image=t,this.u_transformGrid=i}}function h(e,t){e.include(a),e.fragment.uniforms.add(new s.A("u_image",(e=>e.u_image)),new l.U("u_flipY",(e=>e.common.u_flipY)),new l.U("u_applyTransform",(e=>e.common.u_applyTransform)));const{requireBilinearWithNN:i}=t;i&&e.fragment.uniforms.add(new r.A("u_srcImageSize",(e=>e.common.u_srcImageSize))),e.fragment.code.add(n.H`vec2 getPixelLocation(vec2 coords) {
vec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;
if (!u_applyTransform) {
return targetLocation;
}
return projectPixelLocation(targetLocation);
}
bool isOutside(vec2 coords){
if (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {
return true;
} else {
return false;
}
}`),i?e.fragment.code.add(n.H`vec4 sampleBilinear(sampler2D sampler, vec2 coords, vec2 texSize) {
vec2 texelStart = floor(coords * texSize);
vec2 coord0 = texelStart / texSize;
vec2 coord1 = (texelStart +  vec2(1.0, 0.0)) / texSize;
vec2 coord2 = (texelStart +  vec2(0.0, 1.0)) / texSize;
vec2 coord3 = (texelStart +  vec2(1.0, 1.0)) / texSize;
vec4 color0 = texture(sampler, coord0);
vec4 color1 = texture(sampler, coord1);
vec4 color2 = texture(sampler, coord2);
vec4 color3 = texture(sampler, coord3);
vec2 blend = fract(coords * texSize);
vec4 color01 = mix(color0, color1, blend.x);
vec4 color23 = mix(color2, color3, blend.x);
vec4 color = mix(color01, color23, blend.y);
float alpha = floor(color0.a * color1.a * color2.a * color3.a + 0.5);
color = color * alpha + (1.0 - alpha) * texture(sampler, coords);
return color;
}
vec4 getPixel(vec2 pixelLocation) {
return sampleBilinear(u_image, pixelLocation, u_srcImageSize);
}`):e.fragment.code.add(n.H`vec4 getPixel(vec2 pixelLocation) {
return texture(u_image, pixelLocation);
}`)}},67669:function(e,t,i){i.d(t,{K:function(){return c}});var r=i(79487),n=i(57716),s=i(48737),a=i(92684),o=i(83346),l=i(48857);function c(e,t){const i=e.fragment;switch(t.doubleSidedMode){case o.q.None:i.code.add(l.H`vec3 _adjustDoublesided(vec3 normal) {
return normal;
}`);break;case o.q.View:e.include(a.up,t),i.code.add(l.H`vec3 _adjustDoublesided(vec3 normal) {
return dot(normal, vPositionWorldCameraRelative) > 0.0 ? -normal : normal;
}`);break;case o.q.WindingOrder:i.code.add(l.H`vec3 _adjustDoublesided(vec3 normal) {
return gl_FrontFacing ? normal : -normal;
}`);break;default:(0,r.Bg)(t.doubleSidedMode);case o.q.COUNT:}switch(t.normalType){case n.r.Attribute:case n.r.Compressed:e.include(s.Bb,t),i.main.add(l.H`vec3 fragmentFaceNormal = _adjustDoublesided(normalize(vNormalWorld));
vec3 fragmentFaceNormalView = gl_FrontFacing ? normalize(vNormalView) : -normalize(vNormalView);`);break;case n.r.ScreenDerivative:e.include(a.up,t),i.main.add(l.H`vec3 fragmentFaceNormal = normalize(cross(dFdx(vPositionWorldCameraRelative), dFdy(vPositionWorldCameraRelative)));
vec3 fragmentFaceNormalView = normalize(cross(dFdx(vPosition_view), dFdy(vPosition_view)));`);default:case n.r.COUNT:}t.shadeNormals?i.main.add(l.H`vec3 fragmentShadingNormal = fragmentFaceNormal;`):t.spherical?(e.include(a.up,t),i.main.add(l.H`vec3 fragmentShadingNormal = normalize(positionWorld());`)):i.main.add(l.H`vec3 fragmentShadingNormal = vec3(0.0, 0.0, 1.0);`)}},46722:function(e,t,i){i.d(t,{P:function(){return l}});var r=i(56335),n=i(5763),s=i(90285),a=i(30881),o=i(48857);function l(e,t){e.include(r.c,t),e.fragment.include(n.y);const i=e.fragment;i.uniforms.add(new s.$("baseColor",(e=>e.baseColor))),i.uniforms.add(new a.p("objectOpacity",(e=>e.objectOpacity))),t.hasVertexColors?i.code.add(o.H`vec3 _baseColor() {
return baseColor.rgb * vColor.rgb;
}
float _baseOpacity() {
return baseColor.a * vColor.a;
}`):i.code.add(o.H`vec3 _baseColor() {
return baseColor.rgb;
}
float _baseOpacity() {
return baseColor.a;
}`),i.code.add(o.H`vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {
vec3 baseColor = _baseColor();
float baseOpacity = _baseOpacity();
vec3 color = mixExternalColor(
baseColor,
textureColor.rgb,
externalColor.rgb,
externalColorMixMode
);
float opacity = objectOpacity * mixExternalOpacity(
baseOpacity,
textureColor.a,
externalColor.a,
externalColorMixMode
);
return vec4(color, opacity);
}`)}},4162:function(e,t,i){i.d(t,{s:function(){return l}});var r=i(41044),n=i(79786),s=i(48857),a=i(29193),o=i(32420);function l(e,t){const i=t.hasColorTexture&&((0,r.c1)(t.output)||t.alphaDiscardMode!==o.JJ.Opaque);i&&(e.include(n.i,t),e.fragment.uniforms.add(new a.R("baseColorTexture",(e=>e.texture)))),e.fragment.code.add(s.H`
    vec4 readBaseColorTexture() {
      return ${i?"textureLookup(baseColorTexture, vuv0)":"vec4(1.0)"};
    }
  `)}},5411:function(e,t,i){i.d(t,{V:function(){return h}});var r=i(31865),n=i(10934),s=i(20638),a=i(56819),o=i(77983),l=i(48857),c=i(18489);function h(e){e.include(a.dK),u(e)}function u(e){e.fragment.include(s.K),e.include(o.GZ),e.fragment.uniforms.add(new c.C("inverseViewMatrix",(({camera:e})=>(0,r.U_)(d,(0,r.Iu)(d,e.viewMatrix,e.center))))).code.add(l.H`vec3 calculateUVZShadowAndPixelPosFromDepth(
in vec2 _uv,
ivec2 shadowMapSize,
in sampler2D _depthMap,
out vec4 currentPixelPos
) {
float depth = depthFromTexture(_depthMap, _uv);
if (depth >= 1.0 || depth <= 0.0) {
return invalidShadowmapUVZ;
}
float currentPixelDepth = linearizeDepth(depth);
currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;
float linearDepth = -currentPixelDepth;
return calculateUVZShadow(worldSpacePos.xyz, linearDepth, shadowMapSize);
}
vec3 calculateUVZShadowFromDepth(
in vec2 _uv,
ivec2 shadowMapSize,
in sampler2D _depthMap
) {
vec4 currentPixelPos;
return calculateUVZShadowAndPixelPosFromDepth(_uv, shadowMapSize, _depthMap, currentPixelPos);
}`)}const d=(0,n.Ue)()},56791:function(e,t,i){i.d(t,{H:function(){return n}});var r=i(48857);function n(e){e.code.add(r.H`
    float lineFactorAtPosition(float value) {
      float pos = value * ${r.H.float(257)};
      if(pos < 0.5 || pos > ${r.H.float(256.5)}) {
        return 1.0;
      }

      pos = pos + 0.5;
      float modulo = mod(pos, 16.0);
      return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;
    }

    float lineFactorAtUV(vec2 uv) {
      return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));
    }

    float lineFactor(vec2 uv) {
      vec2 offset = fwidth(uv) * 0.25;
      return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;
    }

    vec3 gridColor(vec2 uv) {
      float line = lineFactor(uv) * 0.1 + 0.9;
      return vec3(1.0, 0.972, 0.918) * line;
    }`)}},93288:function(e,t,i){var r;i.d(t,{I:function(){return r}}),function(e){e[e.NotRequired=0]="NotRequired",e[e.Required=1]="Required",e[e.COUNT=2]="COUNT"}(r||(r={}))},82214:function(e,t,i){var r;i.d(t,{l:function(){return r}}),function(e){e[e.Draw=0]="Draw",e[e.Composite=1]="Composite",e[e.ColorComposite=2]="ColorComposite",e[e.GridComposite=3]="GridComposite",e[e.GroupBackgroundComposite=4]="GroupBackgroundComposite",e[e.COUNT=5]="COUNT"}(r||(r={}))},12024:function(e,t,i){var r;i.d(t,{m:function(){return r}}),function(e){e[e.Off=0]="Off",e[e.On=1]="On",e[e.COUNT=2]="COUNT"}(r||(r={}))},6397:function(e,t,i){i.d(t,{EK:function(){return c},uS:function(){return l}});var r=i(36351),n=i(56791),s=i(47744),a=i(48857),o=i(92217);class l extends r.nj{constructor(){super(...arguments),this.overlayOpacity=1}}function c(e,t){const{vertex:i,fragment:r,varyings:o}=e;o.add("vtc","vec2"),i.uniforms.add(new d("texOffsetAndScale")),r.uniforms.add(new p("tex")),r.uniforms.add(new u("textureOpacities"));const l=t.textureFadingEnabled&&!t.renderOccluded;l&&(i.uniforms.add(new d("nextTexOffsetAndScale")),o.add("nvtc","vec2"),r.uniforms.add(new p("texNext")),r.uniforms.add(new u("nextTexOpacities")),r.uniforms.add(new h("fadeFactor")));const c=t.tileBlendInput===s.R.ColorComposite,m=t.tileBlendInput===s.R.GridComposite;m&&r.include(n.H),c&&r.uniforms.add(new u("backgroundColor")),i.code.add(a.H`
  void forwardTextureCoordinatesWithTransform(in vec2 uv) {
    vtc = texOffsetAndScale.xy + uv * texOffsetAndScale.zw;
    ${(0,a.If)(l,"nvtc = nextTexOffsetAndScale.xy + uv * nextTexOffsetAndScale.zw;")}
  }`),r.code.add(a.H`
    vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
      ${(0,a.If)(m||c,a.H`if (opacities.y <= 0.0) {
           return color * opacities.z * opacities.x;
         }
         vec4 bg = vec4(${c?a.H`backgroundColor`:a.H`gridColor(uv)`} * opacities.y, opacities.y);
         vec4 layer = color * opacities.z;
         return (bg * (1.0 - layer.a) + layer) * opacities.x;`,"return color;")}
    }`),l?r.code.add(a.H`vec4 getTileColor() {
vec4 color = getColor(texture(tex, vtc), vtc, textureOpacities);
if (fadeFactor >= 1.0) {
return color;
}
vec4 nextColor = getColor(texture(texNext, nvtc), nvtc, nextTexOpacities);
return mix(nextColor, color, fadeFactor);
}`):r.code.add(a.H`vec4 getTileColor() {
return getColor(texture(tex, vtc), vtc, textureOpacities);
}`)}class h extends o.x{constructor(e){super(e,"float")}}class u extends o.x{constructor(e){super(e,"vec3")}}class d extends o.x{constructor(e){super(e,"vec4")}}class p extends o.x{constructor(e){super(e,"sampler2D")}}},99563:function(e,t,i){i.d(t,{J:function(){return p}});i(61432),i(82846);var r=i(17993),n=i(56791),s=i(93288),a=i(82214),o=i(12024),l=i(48857);function c(e,t){const i=t.blendMode;i!==r.iM.Normal&&(i===r.iM.Reflect&&e.code.add(l.H`float reflectBlend(in float cb, in float cl) {
return (cl == 1.0) ? cl : min(cb * cb / (1.0 - cl), 1.0);
}`),i!==r.iM.ColorDodge&&i!==r.iM.VividLight||e.code.add(l.H`float colorDodge(in float cb, in float cl) {
return (cb == 0.0) ? 0.0 : (cl == 1.0) ? 1.0 : min(1.0, cb / (1.0 - cl));
}`),i!==r.iM.ColorBurn&&i!==r.iM.VividLight||e.code.add(l.H`float colorBurn(in float cb, in float cl) {
return (cb == 1.0) ? 1.0 : (cl == 0.0) ? 0.0 : 1.0 - min(1.0, (1.0 - cb) / cl);
}`),i===r.iM.Overlay&&e.code.add(l.H`float overlay(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (1.0 - 2.0 * (1.0 - cl ) * (1.0 - cb)) + step(0.5, cl) * (2.0 * cl * cb);
}`),i===r.iM.HardLight&&e.code.add(l.H`float hardLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (2.0 * cl * cb) + step(0.5, cl) * (1.0 - 2.0 * (1.0 - cl) * (1.0 - cb));
}`),i===r.iM.SoftLight&&e.code.add(l.H`float softLight(in float cb, in float cl) {
if (cl <= 0.5) {
return cb - (1.0 - 2.0 * cl) * cb * (1.0 - cb);
}
if (cb <= 0.25) {
return cb + (2.0 * cl - 1.0) * cb * ((16.0 * cb - 12.0) * cb + 3.0);
}
return cb + (2.0 * cl - 1.0) * (sqrt(cb) - cb);
}`),i===r.iM.VividLight&&e.code.add(l.H`float vividLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * colorBurn(cb, 2.0 * cl) + step(0.5, cl) * colorDodge(cb, (2.0 * (cl - 0.5)));
}`),i!==r.iM.Hue&&i!==r.iM.Saturation&&i!==r.iM.Color&&i!==r.iM.Luminosity||(e.code.add(l.H`float minv3(in vec3 c) {
return min(min(c.r, c.g), c.b);
}
float maxv3(in vec3 c) {
return max(max(c.r, c.g), c.b);
}
float lumv3(in vec3 c) {
return dot(c, vec3(0.3, 0.59, 0.11));
}
vec3 clipColor(vec3 color) {
float lum = lumv3(color);
float mincol = minv3(color);
float maxcol = maxv3(color);
if (mincol < 0.0) {
color = lum + ((color - lum) * lum) / (lum - mincol);
}
if (maxcol > 1.0) {
color = lum + ((color - lum) * (1.0 - lum)) / (maxcol - lum);
}
return color;
}
vec3 setLum(vec3 cbase, vec3 clum) {
return clipColor(cbase + vec3(lumv3(clum) - lumv3(cbase)));
}`),i!==r.iM.Hue&&i!==r.iM.Saturation||e.code.add(l.H`float satv3(vec3 c) {
return maxv3(c) - minv3(c);
}
vec3 setLumSat(vec3 cbase, vec3 csat, vec3 clum)
{
float minbase = minv3(cbase);
float sbase = satv3(cbase);
float ssat = satv3(csat);
return setLum(sbase > 0.0 ? (cbase - minbase) * ssat / sbase : vec3(0.0), clum);
}`)),e.code.add(l.H`
    vec4 applyBlendMode(vec3 cl, float ol, vec3 cb, float ob) {
      ${i===r.iM.Multiply?l.H`return vec4(cl * ol * cb * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.Average?l.H`return vec4((cb + cl) * 0.5 * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.Lighten?l.H`return vec4(max(cb, cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.Darken?l.H`return vec4(min(cl, cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.Lighter?l.H`return vec4(cl * ol + cb * ob, ol + ob);`:i===r.iM.Plus?l.H`return clamp(vec4(cl.rgb + cb.rgb, ol + ob), 0.0, 1.0);`:i===r.iM.Minus?l.H`return vec4(clamp(vec3(cb.rgb - cl.rgb), 0.0, 1.0), ob * ol);`:i===r.iM.Screen?l.H`return vec4((cl + cb - cl * cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.Difference?l.H`return vec4(abs(cb - cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.Invert?l.H`return vec4((1.0 - cb) * ol * ob + cb * ob * (1.0 - ol), ob);`:i===r.iM.DestinationOver?l.H`return vec4(cl * ol * (1.0 - ob) + cb * ob, ol + ob - ol * ob);`:i===r.iM.DestinationAtop?l.H`return vec4(cl * ol * (1.0 - ob) + cb * ob * ol, ol);`:i===r.iM.DestinationOut?l.H`return vec4(cb * ob * (1.0 - ol), ob * (1.0 - ol));`:i===r.iM.SourceAtop?l.H`return vec4(cl * ol * ob + cb * ob * (1.0 - ol), ob);`:i===r.iM.SourceOut?l.H`return vec4(cl * ol * (1.0 - ob), ol * (1.0 - ob));`:i===r.iM.Xor?l.H`return vec4(cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), ol * (1.0 - ob) + ob * (1.0 - ol));`:i===r.iM.DestinationIn?l.H`return vec4(cb * ob * ol, ol * ob);`:i===r.iM.SourceIn?l.H`return vec4(cl * ol * ob, ol * ob);`:i===r.iM.Hue?l.H`
          vec3 f = setLumSat(cl, cb, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.Saturation?l.H`
          vec3 f = setLumSat(cb, cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.Color?l.H`
          vec3 f = setLum(cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.Luminosity?l.H`
          vec3 f = setLum(cb, cl);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.Exclusion?l.H`
          vec3 f = cl + cb - 2.0 * cl * cb;
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.Reflect?l.H`
          vec3 f = vec3(reflectBlend(cb.r, cl.r), reflectBlend(cb.g, cl.g), reflectBlend(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.ColorDodge?l.H`
          vec3 f = vec3(colorDodge(cb.r, cl.r), colorDodge(cb.g, cl.g), colorDodge(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.ColorBurn?l.H`
          vec3 f = vec3(colorBurn(cb.r, cl.r), colorBurn(cb.g, cl.g), colorBurn(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.Overlay?l.H`
          vec3 f = vec3(overlay(cb.r, cl.r), overlay(cb.g, cl.g), overlay(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.SoftLight?l.H`
          vec3 f = vec3(softLight(cb.r, cl.r), softLight(cb.g, cl.g), softLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.HardLight?l.H`
          vec3 f = vec3(hardLight(cb.r, cl.r), hardLight(cb.g, cl.g), hardLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.VividLight?l.H`
          vec3 f = vec3(vividLight(cb.r, cl.r), vividLight(cb.g, cl.g), vividLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:l.H``}
    }
  `))}var h=i(9535),u=i(85119),d=i(34709);i(74826);function p(e,t){const{output:i,blendMode:p,baseOpacityMode:m,premultipliedSource:f}=t,_=e.fragment,g=m===s.I.Required;g&&_.uniforms.add(new u.p("baseOpacity",(e=>e.baseOpacity)));const y=p!==r.iM.Normal,v=f===o.m.On,b=i===a.l.Composite,w=i===a.l.GroupBackgroundComposite,C=!y&&!v&&(b&&!g||w);_.include(c,t);let x="";switch(i){case a.l.GroupBackgroundComposite:case a.l.Draw:x=l.H`vec4(0.0)`;break;case a.l.ColorComposite:_.uniforms.add(new h.J("backgroundColor",(e=>e.backgroundColor))),x=l.H`vec4(backgroundColor, 1.0)`;break;case a.l.GridComposite:_.include(n.H),x=l.H`vec4(gridColor(uv), 1.0)`;break;case a.l.Composite:_.uniforms.add(new d.A("fboColor",(e=>e.fboTexture))),x=l.H`texelFetch(fboColor, ivec2(gl_FragCoord.xy), 0)`;case a.l.COUNT:}_.code.add(l.H`
    vec4 getBackground(vec2 uv) {
      return ${(0,l.If)(g,l.H`baseOpacity *`)} ${x};
    }

    vec4 blendLayers(vec2 bgUV, vec4 colorLayer, float opacity) {
      ${y?l.H`
          vec3 cl = colorLayer.a == 0.0 ? colorLayer.rgb : colorLayer.rgb / colorLayer.a;
          vec4 bgColor = getBackground(bgUV);
          vec3 cb = bgColor.a == 0.0 ? bgColor.rgb : bgColor.rgb / bgColor.a;
          return applyBlendMode(clamp(cl, vec3(0.0), vec3(1.0)), colorLayer.a * opacity, cb, bgColor.a);`:l.H`
          float composeAlpha = colorLayer.a * opacity;
          ${C?l.H`return colorLayer * opacity;`:l.H`
            vec4 bgColor = getBackground(bgUV);
            return bgColor * (1.0 - composeAlpha) + colorLayer * opacity;`}`}
    }`)}},47744:function(e,t,i){var r;i.d(t,{R:function(){return r}}),function(e){e[e.LayerOnly=0]="LayerOnly",e[e.ColorComposite=1]="ColorComposite",e[e.GridComposite=2]="GridComposite",e[e.COUNT=3]="COUNT"}(r||(r={}))},58226:function(e,t,i){i.d(t,{R:function(){return c},T:function(){return h}});var r=i(41788),n=i(19155),s=i(85119),a=i(48857),o=i(52061),l=i(74826);class c extends l.K{constructor(){super(...arguments),this.scale=1,this.offset=r.AG}}function h(e){e.attributes.add(o.T.POSITION,"vec2"),e.attributes.add(o.T.UV0,"vec2"),e.varyings.add("uv","vec2"),e.varyings.add("vuv","vec2"),e.vertex.uniforms.add(new s.p("scale",(e=>e.scale)),new n.A("offset",(e=>e.offset))).main.add(a.H`gl_Position = vec4(position, 0.0, 1.0);
uv = uv0 * scale + offset;
vuv = uv0;`)}},34630:function(e,t,i){function r(e){e.code.add("\n  vec4 blendColorsPremultiplied(vec4 source, vec4 dest) {\n    float oneMinusSourceAlpha = 1.0 - source.a;\n    return source + dest * oneMinusSourceAlpha;\n  }\n  ")}function n(e,t){return e[0]=t[0]*t[3],e[1]=t[1]*t[3],e[2]=t[2]*t[3],e[3]=t[3],e}i.d(t,{m:function(){return r},p:function(){return n}})},93270:function(e,t,i){i.d(t,{U:function(){return r},j:function(){return s}});var r,n=i(8554);function s(e){return e&&(0,n.BZ)(e)?r.Mars:e&&(0,n.V2)(e)?r.Moon:r.Earth}!function(e){e[e.Earth=1]="Earth",e[e.Mars=2]="Mars",e[e.Moon=3]="Moon",e[e.COUNT=4]="COUNT"}(r||(r={}))},54231:function(e,t,i){i.d(t,{U:function(){return s}});var r=i(5998),n=i(92217);class s extends n.x{constructor(e,t){super(e,"bool",r.P.Pass,((i,r,n)=>i.setUniform1b(e,t(r,n))))}}},20022:function(e,t,i){i.d(t,{I:function(){return a}});var r=i(24910),n=i(86875),s=i(82846);class a{constructor(e){this._low=(0,s.Ue)(),this._high=(0,s.Ue)(),e&&this.set(e)}get low(){return this._low}get high(){return this._high}set(e){(0,r.c)(this._low,(0,r.c)(o,e));const t=(0,r.a)(o,e,this._low);(0,r.c)(this._high,t)}get(e){return(0,r.f)(e,this._low,this._high)}getLowScaled(e){return(0,r.g)(e,this._low,1)}}const o=(0,n.Ue)()},25631:function(e,t,i){i.d(t,{N:function(){return o}});var r=i(65562),n=i(25906),s=i(38419),a=i(65650);class o{constructor(e,t=s.J.None){this._techniques=e,this._parameters=new r.C,this._configuration=new s.Z,this._configuration.blitMode=t,e.precompile(n.l,this._configuration)}blit(e,t,i,r){e.bindFramebuffer(i.fbo),e.setClearColor(0,0,0,1),e.clear(a.Hf.COLOR),this._parameters.texture=t.getTexture();const s=this._techniques.get(n.l,this._configuration);e.bindTechnique(s,r,this._parameters),e.screen.draw()}blend(e,t,i,r,s=1){this._configuration.hasOpacityFactor=s<1;const a=this._techniques.get(n.l,this._configuration);return!!a.compiled&&(e.bindFramebuffer(i.fbo),this._parameters.texture=t.getTexture(),this._parameters.opacity=s,e.bindTechnique(a,r,this._parameters),e.screen.draw(),!0)}}},40673:function(e,t,i){i.d(t,{L9:function(){return n},Ml:function(){return a},S7:function(){return r},Su:function(){return o}});const r=2.6,n={sunny:.0022,cloudy:.0022,rainy:.0022,snowy:.0022,foggy:.0022};class s{constructor(e,t){this.near=e,this.far=t,this.near=o(e),this.far=o(t)}}const a={sunny:new s([.15,.05,.01,0,0],[1,.8,.6,.4,.2]),cloudy:new s([.15,.05,.01,0,0],[1,.8,.6,.4,.2]),rainy:new s([.15,.05,.01,0,0],[1,.8,.6,.4,.2]),snowy:new s([.15,.05,.01,0,0],[1,.8,.6,.4,.2]),foggy:new s([.15,.05,.01,0,0],[1,.8,.6,.4,.2])};function o(e,t=1){const i=e[0]+e[1]+e[2]+e[3]+e[4];return i<t?e:[e[0]/i,e[1]/i,e[2]/i,e[3]/i,e[4]/i]}},71356:function(e,t,i){function r(e){return!!e.update}i.d(t,{f:function(){return r}})},4486:function(e,t,i){i.d(t,{Y:function(){return r},n:function(){return o}});var r,n=i(61432),s=i(61544),a=i(99734);function o(e=!(0,n.Z)("disable-feature:high-quality-idle"),t=null){const i=new s.r;return e?(i.set(a.n.IDLE,r.Antialiasing,"low"!==t),i.set(a.n.IDLE,r.HighResolutionAtmosphere,"low"!==t),i.set(a.n.IDLE,r.HighQualityTransparency,!0),i.set(a.n.IDLE,r.SSAO,!0),i.set(a.n.IDLE,r.WaterReflection,!0),i.set(a.n.IDLE,r.PhysicalPixelRendering,!0)):(i.set(a.n.ANIMATING,r.HighResolutionShadows,!0),i.set(a.n.ANIMATING,r.HighResolutionViewshed,!0),i.set(a.n.INTERACTING,r.HighResolutionShadows,!0),i.set(a.n.INTERACTING,r.HighResolutionViewshed,!0)),i.set(a.n.IDLE,r.HighResolutionShadows,!0),i.set(a.n.IDLE,r.HighResolutionViewshed,!0),i.set(a.n.IDLE,r.HighResolutionVoxel,!0),i}!function(e){e[e.Antialiasing=0]="Antialiasing",e[e.HighQualityTransparency=1]="HighQualityTransparency",e[e.HighResolutionVoxel=2]="HighResolutionVoxel",e[e.HighResolutionAtmosphere=3]="HighResolutionAtmosphere",e[e.SSAO=4]="SSAO",e[e.WaterReflection=5]="WaterReflection",e[e.HighResolutionShadows=6]="HighResolutionShadows",e[e.HighResolutionViewshed=7]="HighResolutionViewshed",e[e.PhysicalPixelRendering=8]="PhysicalPixelRendering"}(r||(r={}))},47718:function(e,t,i){i.d(t,{F:function(){return h}});var r=i(73440),n=i(70880),s=i(90403),a=i(17155),o=(i(61432),i(96711),i(83850),i(48023)),l=i(10517),c=i(27076);let h=class extends n.Z{constructor(e){super(e),this._renderers=new Map}destroy(){this._renderers.forEach((e=>e.destroy())),this._renderers.clear()}initialize(){this.addHandles((0,s.YP)((()=>this.stage.view.state.highlights),(()=>this.updateHighlights())))}getMaterialRenderer(e){return this._renderers.get(e)}updateHighlights(){this._renderers.forEach((e=>e.updateHighlights(this.stage.view.state.highlightOrderMap)))}commit(e,t,i){const{adds:r,removes:n,updates:s}=e;if(0===r.length&&0===n.length&&0===s.length)return!1;(0,l.q9)(e).forEach(((e,r)=>{if(t.done)return;let n=this._renderers.get(r);null==n&&e.adds.length>0&&(n=new c.A({material:r,highlightOrderMap:this.stage.view.state.highlightOrderMap}),n.initializeRenderContext(i),this.rendererAdded(n),this._renderers.set(r,n)),n?(n.modify(e,t),n.updateHighlights(this.stage.view.state.highlightOrderMap),0===n.numGeometries&&(this._renderers.delete(n.material),this.rendererRemoved(n),n.destroy())):(e.clear(),t.madeProgress())}));let a=0;for(const e of this._renderers.values())e.drapedPriority=a++;return!0}get canCompact(){for(const e of this._renderers.values())if(e.canCompact)return!0;return!1}compact(e){let t=!1;for(const i of this._renderers.values()){if(e.done)return t;t=i.compact(e)||t}return t}get renderers(){return this._renderers}};(0,r._)([(0,a.Cb)({constructOnly:!0})],h.prototype,"stage",void 0),h=(0,r._)([(0,o.j)("esri.views.3d.webgl-engine.lib.RendererBase")],h)},62935:function(e,t,i){i.d(t,{S:function(){return w}});var r=i(73440),n=(i(61432),i(79577)),s=i(63974),a=i(17155),o=(i(96711),i(83850),i(48023)),l=i(41788),c=i(69055),h=i(38142),u=i(41044),d=i(82915),p=i(61442),m=i(32033),f=i(19821),_=i(19596),g=i(89341),y=i(47718),v=i(948),b=i(50399);let w=class extends y.F{constructor(e){super(e),this._pending=new C,this._changes=new d.as,this._sortedRenderers=new s.Z,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._sortedRenderers.clear(),this._geometries.clear(),this._pending.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}hasHighlight(e){return(0,n.oE)(this.renderers,(t=>t.hasHighlight(e)))}get hasWater(){return this._hasWater}get rendersOccludedDraped(){for(const e of this.renderers.values())if(0!==e.numGeometries&&e.renderOccludedFlags&~_.yD.Occlude)return!0;return!1}get isEmpty(){return!this.updating&&0===this.renderers.size&&0===this._geometries.size}get sortedRenderers(){return this._sortedRenderers}commitChanges(){return!!this.updating&&(this._processAddsRemoves(),this.commit(this._changes,b.G5,this.rendererContext.pluginContext)&&(this._updateSortedMaterialRenderers(),this._hasHighlights=(0,n.oE)(this.renderers,(e=>{const t=e.produces.get(v.r.DRAPED_MATERIAL);return!!t&&t(u.H_.Highlight)})),this._hasWater=(0,n.oE)(this.renderers,(e=>{const t=e.produces.get(v.r.DRAPED_WATER);return!!t&&t(u.H_.Normal)}))),this.notifyChange("updating"),!0)}rendererAdded(){this._sortedRenderers.clear()}rendererRemoved(){this._sortedRenderers.clear()}addGeometries(e,t){if(0===e.length)return;const i=this._validateRenderGeometries(e);for(const e of i)this._geometries.set(e.id,e);const r=this._pending.empty;for(const e of i)this._pending.adds.add(e);r&&this.notifyChange("updating"),t===g.T.UPDATE&&this._notifyGraphicGeometryChanged(e)}removeGeometries(e,t){const i=this._pending.empty,r=this._pending.adds;for(const t of e)r.has(t)?(this._pending.removed.add(t),r.delete(t)):this._pending.removed.has(t)||this._pending.removes.add(t),this._geometries.delete(t.id);i&&!this._pending.empty&&this.notifyChange("updating"),t===g.T.UPDATE&&this._notifyGraphicGeometryChanged(e)}modifyGeometries(e,t){const i=0===this._changes.updates.length;for(const i of e){const e=this._changes.updates.pushNew();e.renderGeometry=this._ensureValidRenderGeometry(i),e.updateType=t}switch(i&&this._changes.updates.length>0&&this.notifyChange("updating"),t){case g.$.TRANSFORMATION:case g.$.GEOMETRY:return this._notifyGraphicGeometryChanged(e);case g.$.VISIBILITY:return this._notifyGraphicVisibilityChanged(e)}}updateAnimation(e){let t=!1;return this._sortedRenderers.forAll((i=>t=!!i.updateAnimation&&i.updateAnimation(e)||t)),t}precompile(e){return this._sortedRenderers.reduce(((t,i)=>i.precompile(e)||t),!1)}render(e){this._sortedRenderers.forAll((t=>{const i=t.acquireTechniques(e);i&&t.render(e,i)}))}intersect(e,t,i,r,n){for(const s of this._geometries.values()){if(!r(s))continue;this._intersectRenderGeometry(s,i,t,0,e,n);const a=this.rendererContext.longitudeCyclical;a&&(s.boundingSphere[0]-s.boundingSphere[3]<a.min&&this._intersectRenderGeometry(s,i,t,a.range,e,n),s.boundingSphere[0]+s.boundingSphere[3]>a.max&&this._intersectRenderGeometry(s,i,t,-a.range,e,n)),n++}return n}_updateSortedMaterialRenderers(){if(!(this._sortedRenderers.length>0)){for(const e of this.renderers.values())this._sortedRenderers.push(e);this._sortedRenderers.sort(((e,t)=>t.material?.renderPriority===e.material?.renderPriority?e.drapedPriority-t.drapedPriority:(t.material?.renderPriority||0)-(e.material?.renderPriority||0)))}}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes)),this._changes.updates.filterInPlace((({renderGeometry:e})=>!this._pending.has(e))),this._pending.clear()}_intersectRenderGeometry(e,t,i,r,n,s){if(!e.visible||!e.material.visible||!e.material.intersectDraped)return;let a=0;r+=e.transformation[12],a=e.transformation[13],x[0]=i[0]-r,x[1]=i[1]-a,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersectDraped(e,n,x,((i,r,a)=>{!function(e,t,i,r,n,s,a){const o=new h.T6(s,a,t),l=t=>{t.set(f.q.OVERLAY,o,e.distance,e.normal,e.transformation,i,r)};if((null==n.results.min.drapedLayerOrder||i>=n.results.min.drapedLayerOrder)&&(null==n.results.min.distance||n.results.ground.distance<=n.results.min.distance)&&l(n.results.min),n.options.store!==p.e.MIN&&(null==n.results.max.drapedLayerOrder||i<n.results.max.drapedLayerOrder)&&(null==n.results.max.distance||n.results.ground.distance>n.results.max.distance)&&l(n.results.max),n.options.store===p.e.ALL){const e=new m.x(n.ray);l(e),n.results.all.push(e)}}(t,a,s,e.material.renderPriority,n,e.layerViewUid,e.graphicUid)}),t)}_notifyGraphicGeometryChanged(e){if(null==this.drapeSource.notifyGraphicGeometryChanged)return;let t;for(const{graphicUid:i}of e)null!=i&&i!==t&&(this.drapeSource.notifyGraphicGeometryChanged(i),t=i)}_notifyGraphicVisibilityChanged(e){if(null==this.drapeSource.notifyGraphicVisibilityChanged)return;let t;for(const{graphicUid:i}of e)null!=i&&i!==t&&(this.drapeSource.notifyGraphicVisibilityChanged(i),t=i)}_validateRenderGeometries(e){for(const t of e)this._ensureValidRenderGeometry(t);return e}_ensureValidRenderGeometry(e){return null==e.localOrigin&&(e.localOrigin=this._localOriginFactory.getOrigin((0,c.a)(e.boundingSphere))),e}get test(){}};(0,r._)([(0,a.Cb)({constructOnly:!0})],w.prototype,"drapeSource",void 0),(0,r._)([(0,a.Cb)({constructOnly:!0})],w.prototype,"rendererContext",void 0),(0,r._)([(0,a.Cb)()],w.prototype,"updating",null),(0,r._)([(0,a.Cb)()],w.prototype,"rctx",null),(0,r._)([(0,a.Cb)()],w.prototype,"_localOriginFactory",null),(0,r._)([(0,a.Cb)({readOnly:!0})],w.prototype,"isEmpty",null),(0,r._)([(0,a.Cb)()],w.prototype,"_geometries",void 0),w=(0,r._)([(0,o.j)("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],w);class C{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}const x=(0,l.Ue)()},13580:function(e,t,i){i.d(t,{g:function(){return h}});class r{constructor(e){this._maxCount=e,this._nextIndex=0,this._recycledIndices=[]}get activeCount(){return this._nextIndex-this._recycledIndices.length}get availableCount(){return this._recycledIndices.length+this._maxCount-this._nextIndex}acquire(){return this._recycledIndices.length>0?this._recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(e){this._recycledIndices.push(e)}}var n=i(81342),s=i(65650),a=i(8158),o=i(35928);class l{constructor(e,t=1){this._rctx=e,this._fieldCount=t,this.textureWidth=4096,this._dirty=!0;const i=new o.X(this.textureWidth,1);i.samplingMode=s.cw.NEAREST,i.wrapMode=s.e8.CLAMP_TO_EDGE,this._texture=new a.x(this._rctx,i),this._data=new n.mc(new ArrayBuffer(4*this.textureWidth))}dispose(){this._texture.dispose(),this._texture=void 0,this._data=void 0}setData(e,t,i,r,n,s){const a=e*this._fieldCount+t;this._dirty=!0,this._data.set(a,0,i),this._data.set(a,1,r),this._data.set(a,2,n),this._data.set(a,3,s)}setDataElement(e,t,i,r){const n=e*this._fieldCount+t;this._dirty=!0,this._data.set(n,i,r)}getDataElement(e,t,i){const r=e*this._fieldCount+t;return this._dirty=!0,this._data.get(r,i)}resizeToFit(e){const t=(e+1)*this._fieldCount;if(t>this._data.count){const e=Math.ceil(t/this.textureWidth)*this.textureWidth,i=new n.mc(new ArrayBuffer(4*e));i.typedBuffer.set(this._data.typedBuffer),this._data=i}}updateTexture(){if(!this._dirty)return;const e=this._texture.descriptor.width,t=this._texture.descriptor.height;this._data.count>e*t&&this._texture.resize(e,this._data.count/e),this._texture.setData(this._data.typedBuffer),this._dirty=!1}get texture(){return this._texture}}class c{constructor(e,t=1){this.textureBuffer=new l(e,t),this._indexManager=new r(65536)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this._indexManager.availableCount}get activeCount(){return this._indexManager.activeCount}acquireIndex(){const e=this._indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}releaseIndex(e){this._indexManager.release(e)}}class h{constructor(e,t=1){this._rctx=e,this._fieldCount=t,this._buffers=[]}garbageCollect(){this._buffers=this._buffers.filter((e=>0!==e.activeCount||(e.dispose(),!1)))}destroy(){this._buffers.forEach((e=>e.dispose())),this._buffers=[]}getBuffer(e){for(const t of this._buffers)if(t.availableCount>=e)return t;if(e>65536)return null;const t=new c(this._rctx,this._fieldCount);return this._buffers.push(t),t}updateTextures(){for(const e of this._buffers)e.textureBuffer.updateTexture()}}},54753:function(e,t,i){i.d(t,{Ar:function(){return p},l_:function(){return d},ow:function(){return u}});var r=i(57192),n=i(75025),s=i(31214),a=i(32335),o=i(92761),l=i(65650),c=i(8158),h=i(35928);function u(e,t=p.Pos2,i=n.i,c=-1,h=1){const u=t===p.Pos2Tex,d=u?r.LL?new Float32Array([c,c,0,h,c,0,c,h,0,h,h,0]):new Float32Array([c,c,0,0,h,c,1,0,c,h,0,1,h,h,1,1]):new Float32Array([c,c,h,c,c,h,h,h]);if(u&&r.LL){const e=(0,r.TQ)(d.buffer);e[10]=e[17]=e[22]=e[23]=1}return new a.U(e,i,new Map([["geometry",u?r.LL?s.W:s.GN:s.QI]]),new Map([["geometry",o.f.createVertex(e,l.l1.STATIC_DRAW,d)]]))}function d(e){const t=new h.X(4);return t.samplingMode=l.cw.NEAREST,new c.x(e,t)}var p;!function(e){e[e.Pos2=0]="Pos2",e[e.Pos2Tex=1]="Pos2Tex"}(p||(p={}))},90189:function(e,t,i){i.d(t,{VB:function(){return b},_s:function(){return w},tB:function(){return f},bK:function(){return _},J4:function(){return m}});var r=i(31865),n=i(82846),s=i(16447),a=i(69055),o=i(94744),l=i(38142),c=i(92181),h=i(32033),u=i(19821);function d(e){return(0,h.n)(e)&&e.intersector===u.q.OBJECT&&!!e.target}var p=i(32176);function m(e,t){return d(e)||(0,c.Wd)(e)?v(e.target?.object,t):(0,l.TX)(e)?t.map?.ground:(0,o.a8)(e)||(0,o.GS)(e)||(0,l.j9)(e)||(0,o.A8)(e)?v(e.target,t):null}function f(e,t){const i=_(e,t);return"graphic"===i?.type?i.graphic:null}function _(e,t,i={}){if(null==e)return null;if(d(e)||(0,c.Wd)(e))return g(e.target?.object,t,i);if((0,o.a8)(e)){const t=e.target.createGraphic();return{type:"graphic",graphic:t,layer:t.layer}}if((0,o.A8)(e)){const t=e.target.createVoxelGraphic();return{type:"graphic",graphic:t,layer:t.layer}}if((0,o.BF)(e)){const t=e.target.createTiles3DGraphic();return{type:"graphic",graphic:t,layer:t.layer}}return(0,l.j9)(e)||(0,p.w)(e)?g(e.target,t,i):(0,o.GS)(e)?function(e,t,i){const r=v(e,t);if(null==r)return null;const n=t.allLayerViews.find((e=>e.layer===r));if(!n||n.suspended||!("getGraphicFromIntersectorTarget"in n))return null;const s=i.defer;return y(n.getGraphicFromIntersectorTarget(e,{defer:s?async e=>s((async()=>y(await e()))):void 0}))}(e.target,t,i):null}function g(e,t,i){if(null==e?.graphicUid)return null;const r=v(e,t);if(null==r)return null;if(r===t.graphics)return null==t.graphicsView||"number"!=typeof e.graphicUid?null:t.graphicsView.getHit(e.graphicUid,i);const n=t.allLayerViews.find((e=>e.layer===r));return!n||n.suspended||null==e.graphicUid?null:"getHit"in n?n.getHit(e.graphicUid,i):null}function y(e){return null!=e?{type:"graphic",graphic:e,layer:e.layer}:null}function v(e,t){return null==e?.layerViewUid?null:null!=t.graphicsView&&e.layerViewUid===t.graphicsView.uid?t.graphics:t.allLayerViews.find((t=>t.uid===e.layerViewUid))?.layer}function b(e,t){if(d(e)||(0,c.Wd)(e))return(0,a.g)(e.target.object.boundingVolumeWorldSpace.bounds);if((0,p.w)(e)){(0,r.yZ)(C,e.transformation);const t=Math.max(C[0],C[1],C[2]);return e.target.baseBoundingSphere.radius*t}if((0,o.GS)(e)){const i=function(e,t){const i=v(e,t);if(null==i)return null;const r=t.allLayerViews.find((e=>e.layer===i));return r&&!r.suspended&&"getAABBFromIntersectorTarget"in r?r.getAABBFromIntersectorTarget(e):null}(e.target,t);return i?.5*(0,s.wz)(i):null}return null}function w(e){return!d(e)&&!(0,c.Wd)(e)&&((0,p.w)(e)?e.target.numLodLevels>1:!!(0,o.GS)(e))}const C=(0,n.Ue)()},13896:function(e,t,i){i.d(t,{w:function(){return s}});var r=i(82846),n=i(48737);class s extends n.Pf{constructor(e=(0,r.Ue)()){super(),this.origin=e}get slicePlaneLocalOrigin(){return this.origin}}},27076:function(e,t,i){i.d(t,{A:function(){return D}});var r=i(73440),n=i(3480),s=(i(61432),i(99574)),a=i(61100),o=i(61544),l=i(63974),c=i(74355),h=i(17155),u=(i(96711),i(48023)),d=i(31865),p=i(10934),m=i(72894),f=i(41044),_=i(20472),g=i(55003),y=i(89341),v=i(948),b=i(61719),w=i(13896);class C{constructor(e=0,t=0){this.from=e,this.to=t}get numElements(){return this.to-this.from}}function x(e){if(e.length<2)return;const t=new Map;e.forAll((e=>t.set(e.from,e)));let i=!0;for(;i;){i=!1;for(let r=0;r<e.length;++r){const n=e.data[r],s=t.get(n.to);s&&(n.to=s.to,t.delete(s.from),e.removeUnordered(s),i=!0)}}}class T extends C{constructor(e,t,i,r){super(t,i),this.geometry=e,this._highlightName=null,this.updateHighlightOptions(r)}updateHighlightOptions(e){const{geometry:t}=this;if(!t.hasHighlights)return void(this._highlightName=null);let i=-1,r=null;t.foreachHighlightOptions((t=>{const n=e.get(t)??-1;n>i&&(i=n,r=t)})),this._highlightName=r}get highlightName(){return this._highlightName}get isVisible(){return this.geometry.visible}get hasHighlights(){return this.isVisible&&this.geometry.hasHighlights}get hasOccludees(){return null!=this.geometry.occludees}}var S=i(79577);class M{constructor(){this.first=0,this.count=0}}var E=i(43295);class P{constructor(){this._numElements=0,this._instances=new Map,this.holes=new l.Z({allocator:e=>e||new C,deallocator:null}),this.hasHiddenInstances=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.highlightNames=new Set,this.drawCommandsDefault=R(),this.drawCommandsHighlights=new Map,this.drawCommandsOccludees=R(),this.drawCommandsShadowHighlightRest=R()}get numElements(){return this._numElements}get instances(){return this._instances}get hasHighlights(){return this.highlightNames.size>0}resetInstanceSummary(){this.hasHiddenInstances=!1,this.hasOccludees=!1,this.highlightNames.clear()}updateIfDrawCommandsDirty(e,t){if(this.drawCommandsDirty){this.resetInstanceSummary();for(const e of this.instances.values())this.updateDrawState(e);this.updateDrawCommands(e,t)}}addInstance(e,t){this.deleteInstance(e),this._instances.set(e,t),this._numElements+=t.numElements}deleteInstance(e){const t=this._instances.get(e);t&&(this._numElements-=t.numElements,this._instances.delete(e))}updateInstance(e,t,i){const r=this._instances.get(e);r&&(this._numElements-=r.numElements,r.from=t,r.to=i,this._numElements+=r.numElements)}updateDrawState(e){if(e.isVisible){const{highlightName:t}=e;t&&this.highlightNames.add(t),e.hasOccludees&&(this.hasOccludees=!0)}else this.hasHiddenInstances=!0}updateDrawCommands(e,t){if(this.drawCommandsDefault.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsDirty=!1,0===this._instances.size)return;const{sortedInstances:i}=this;if(this._updateHighlightDrawCommands(e,i),!this.needsMultipleCommands()){const e=this.drawCommandsDefault.pushNew(),i=this.holes.front();return this.vao&&1===this.holes.length&&i.to===Math.floor(this.vao.getByteLength("geometry")/t)?(e.first=0,void(e.count=i.from)):(e.first=1/0,e.count=0,this._instances.forEach((t=>{e.first=Math.min(e.first,t.from),e.count=Math.max(e.count,t.to)})),void(e.count-=e.first))}for(const e of i)e.isVisible&&A(e.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,e)}get sortedInstances(){return Array.from(this._instances.values()).sort(((e,t)=>e.from===t.from?e.to-t.to:e.from-t.from))}updateHighlights(e){this.highlightNames.clear();const t=this.sortedInstances;for(const i of t)i.updateHighlightOptions(e),i.isVisible&&i.highlightName&&this.highlightNames.add(i.highlightName);this._updateHighlightDrawCommands(e)}_updateHighlightDrawCommands(e,t=this.sortedInstances){const{drawCommandsHighlights:i,drawCommandsShadowHighlightRest:r}=this;i.clear(),r.clear();for(const n of t){if(n.updateHighlightOptions(e),!n.isVisible)continue;const{highlightName:t}=n;t&&(this.highlightNames.add(t),A((0,S.s1)(i,t,R),n)),t&&t===E.b||A(r,n)}}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}}function R(){return new l.Z({allocator:e=>e||new M,deallocator:e=>e})}function A(e,t){const i=e.back();if(null==i){const i=e.pushNew();return i.first=t.from,void(i.count=t.numElements)}if(function(e,t){return e.first+e.count>=t.from}(i,t)){const e=t.from-i.first+t.numElements;i.count=e}else{const i=e.pushNew();i.first=t.from,i.count=t.numElements}}class O{constructor(e){this.origin=e,this.buffers=new Array}dispose(){this.buffers.forEach((e=>e.vao.dispose())),this.buffers.length=0}findBuffer(e){return this.buffers.find((t=>t.instances.has(e)))}}let D=class extends _.tY{get _hasHighlights(){return this._highlightNames.size>0}hasHighlight(e){return this._highlightNames.has(e)}constructor(e){super(e),this._dataByOrigin=new Map,this._drawParameters=new w.w,this._highlightNames=new Set,this.drapedPriority=0,this._produces=new Map,this._hasOccludees=!1}destroy(){this._glMaterials=(0,a.M2)(this._glMaterials),this._dataByOrigin.forEach((e=>e.dispose())),this._dataByOrigin.clear(),this._vaoCache=null}initialize(){this._updateProduces()}_updateProduces(){this.material.produces.forEach(((e,t)=>{this._produces.set(t,(t=>!(0===this._dataByOrigin.size||!(t!==f.H_.Highlight&&t!==f.H_.ShadowHighlight||this._hasHighlights))&&e(t)))}))}initializeRenderContext(e){j??=e.renderContext.rctx.isAssumedMetalDriver,this._glMaterials=new g.p(this.material,e.materials),this._bufferWriter=this.material.createBufferWriter(),this._vaoCache=e.renderContext.rctx.getVaoCache(this.material.vertexAttributeLocations,(0,m.K)(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}get produces(){return this._produces}get hasOccludees(){return this._hasOccludees}get hasEmissions(){return this.material.hasEmissions}get isDecoration(){return this.material.parameters.isDecoration}get renderOccludedFlags(){return this.material.renderOccludedFlags}get numGeometries(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.instances.size),0))),e}get usedMemory(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.vao.cachedMemory),0))),e}forEachGeometry(e){this._dataByOrigin.forEach((t=>t.buffers.forEach((t=>t.instances.forEach((({geometry:t})=>e(t)))))))}modify(e,t){this._applyUpdates(e,t),this._applyAddsAndRemoves(e),this._updateDrawCommands()}get canCompact(){for(const e of this._dataByOrigin.values())if(e.buffers.some((e=>e.holes.length>1)))return!0;return!1}compact(e){if(!this.canCompact)return!1;let t=!1;for(const i of this._dataByOrigin.values()){const r=new Array;for(let t=0;t<i.buffers.length&&!e.done;){const n=i.buffers[t];n.holes.length<=1?++t:(n.instances.forEach((({geometry:e})=>r.push(e))),this._vaoCache.deleteVao(n.vao),i.buffers[t]=i.buffers[i.buffers.length-1],--i.buffers.length,e.madeProgress())}if(r.length>0){for(i.buffers.forEach((e=>this._applyAdds(e,r)));r.length>0;)i.buffers.push(this._applyAndRebuild(new P,r,null));t=!0}}return t}updateHighlights(e){this.highlightOrderMap=e,this._highlightNames.clear(),this._dataByOrigin.forEach((t=>{t.buffers.forEach((t=>{t.updateHighlights(e),t.highlightNames.forEach((e=>this._highlightNames.add(e)))}))})),this._updateProduces()}_applyUpdates(e,t){const i=this._bufferWriter;if(null==i)return void e.clearUpdates();const r=i.vertexBufferLayout.stride/4;for(const n of e.updates){if(t.done)return;const{renderGeometry:s,updateType:a}=n;e.pending.updates.removeUnordered(n),t.madeProgress();const o=this._dataByOrigin.get(s.localOrigin.id)?.findBuffer(s.id);if(null==o)return;const l=o.instances.get(s.id);if(a&(y.$.GEOMETRY|y.$.TRANSFORMATION)){const e=G(i.elementCount(l.geometry.geometry.attributes)*r),t=i.vertexBufferLayout.createView(e.buffer);this._writeGeometry(s,t,0),o.vao.vertexBuffers.get("geometry").setSubData(e,l.from*r,0,l.numElements*r)}a&(y.$.HIGHLIGHT|y.$.OCCLUDEE|y.$.VISIBILITY)&&(o.drawCommandsDirty=!0)}}_computeDeltas(e,t){const i=new o.r;for(const t of e){const e=t.localOrigin;if(null==e)continue;let r=i.get(e.id,null);null==r&&(r=new I(e.vec3),i.set(e.id,null,r)),r.changes.push(t)}for(const e of t){const t=e.localOrigin;if(null==t)continue;const r=this._dataByOrigin.get(t.id)?.findBuffer(e.id);if(null==r)continue;let n=i.get(t.id,r);null==n&&(n=new I(t.vec3),i.set(t.id,r,n)),n.changes.push(e)}return i}_applyAddsAndRemoves(e){const{_bufferWriter:t,_dataByOrigin:i,_vaoCache:r}=this;if(null==t||null==r)return void e.clearAddsAndRemoves();const s=t.vertexBufferLayout.stride/4,a=this._computeDeltas(e.adds,e.removes);a.forEach(((e,o)=>{const l=e.get(null),c=l?.changes??[];a.delete(o,null);let h=i.get(o);if(e.forEach(((e,l)=>{if(a.delete(o,l),null==l&&(0,b.hu)(!1,"No VAO for removed geometries"),l.instances.size===e.changes.length)return r.deleteVao(l.vao),(0,n.e$)(h.buffers,l),void(0===h.buffers.length&&0===c.length&&i.delete(o));const u=l.numElements,d=l.vao.getByteLength("geometry")/4,p=c.reduce(((e,i)=>e+t.elementCount(i.geometry.attributes)),0),m=e.changes.reduce(((e,i)=>e+t.elementCount(i.geometry.attributes)),0),f=Math.min((u+p-m)*s,B),_=f>d;f>H&&f<d/2?(e.changes.forEach((({id:e})=>l.deleteInstance(e))),l.instances.forEach((({geometry:e})=>c.push(e))),this._vaoCache.deleteVao(l.vao),(0,n.e$)(h.buffers,l)):_?this._applyAndRebuild(l,c,e):this._applyRemoves(l,e)})),c.length>0)for(null==h&&(h=new O(l.origin),i.set(o,h)),h.buffers.forEach((e=>this._applyAdds(e,c)));c.length>0;)h.buffers.push(this._applyAndRebuild(new P,c,null))})),e.clearAddsAndRemoves()}_updateDrawCommands(){this._highlightNames.clear(),this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.buffers.forEach((e=>{e.updateIfDrawCommandsDirty(this.highlightOrderMap,this._bufferWriter.vertexBufferLayout.stride),e.hasHighlights&&(0,c.w6)(this._highlightNames,e.highlightNames),this._hasOccludees=this._hasOccludees||e.hasOccludees}))}))}_applyAndRebuild(e,t,i){if(i)for(const t of i.changes)e.deleteInstance(t.id);const r=this._bufferWriter,n=r.vertexBufferLayout.stride,s=n/4,a=Math.floor(B/s);let o=e.numElements;for(;t.length>0;){const i=t.pop(),n=r.elementCount(i.geometry.attributes);if(o+n>a&&o>0){t.push(i);break}o+=n;const s=new T(i,0,0,this.highlightOrderMap);(0,b.hu)(null==e.instances.get(i.id)),e.addInstance(i.id,s)}const l=o*s,c=G(l),h=r.vertexBufferLayout.createView(c.buffer);let u=0;e.resetInstanceSummary(),e.instances.forEach(((t,i)=>{this._writeGeometry(t.geometry,h,u);const n=u;u+=r.elementCount(t.geometry.geometry.attributes),e.updateInstance(i,n,u),e.updateDrawState(t)})),this._vaoCache.deleteVao(e.vao),e.vao=this._vaoCache.newVao(q(l)),e.vao.vertexBuffers.get("geometry").setSubData(c,0,0,u*s),e.holes.clear();const d=e.holes.pushNew();return d.from=u,d.to=Math.floor(e.vao.getByteLength("geometry")/n),e.updateDrawCommands(this.highlightOrderMap,n),e}_applyRemoves(e,t){if(0===t.changes.length||null==this._bufferWriter)return;let i=1/0,r=-1/0;for(const n of t.changes){const t=n.id,s=e.instances.get(t);if(!s)continue;e.deleteInstance(t),j&&(i=Math.min(i,s.from),r=Math.max(r,s.to));const a=U.back();if(a){if(a.to===s.from){a.to=s.to;continue}if(a.from===s.to){a.from=s.from;continue}}const o=U.pushNew();o.from=s.from,o.to=s.to}x(U);const n=this._bufferWriter.vertexBufferLayout.stride/4,s=e.vao.vertexBuffers.get("geometry");if(j){const t=(r-i)*n,a=G(t),o=this._bufferWriter.vertexBufferLayout.createView(a.buffer);a.fill(0,0,t),e.instances.forEach((e=>{if(!(e.from>=i&&e.to<=r))return;const t=e.from-i;this._writeGeometry(e.geometry,o,t)})),s.setSubData(a,i*n,0,t)}else{const e=U.reduce(((e,t)=>Math.max(e,t.numElements)),0)*n,t=G(e);t.fill(0,0,e),U.forAll((e=>s.setSubData(t,e.from*n,0,e.numElements*n)))}e.holes.pushArray(U.data,U.length),U.forAll(((e,t)=>U.data[t]=null)),U.clear(),e.drawCommandsDirty=!0}_applyAdds(e,t){if(0===t.length||null==this._bufferWriter)return;if(!function(e){return null!=e.vao}(e))return void this._applyAndRebuild(e,t,null);const i=this._bufferWriter,r=i.vertexBufferLayout.stride/4,s=e.numElements,a=t.reduce(((e,t)=>e+i.elementCount(t.geometry.attributes)),0),o=Math.min((s+a)*r,B),l=4*o;if(e.vao.getByteLength("geometry")<q(B-H)&&l>e.vao.getByteLength("geometry"))return void this._applyAndRebuild(e,t,null);x(e.holes);const c=new Array;let h=1/0,u=-1/0;for(const r of t){const t=i.elementCount(r.geometry.attributes),n=L(e.holes,t);c.push(n),j&&null!=n&&(h=Math.min(n,h),u=Math.max(n+t,u))}const d=e.vao.vertexBuffers.get("geometry");let p=0,m=0,f=0;const _=G(j?(u-h)*r:o),g=i.vertexBufferLayout.createView(_.buffer);if(t.forEach(((t,n)=>{const s=c[n];if(null==s)return;const a=i.elementCount(t.geometry.attributes);if(!j){if(f!==s){const e=f-m;e>0&&d.setSubData(_,m*r,0,e*r),m=s,p=0}this._writeGeometry(t,g,p),p+=a,f=s+a}const o=new T(t,s,s+a,this.highlightOrderMap);(0,b.hu)(null==e.instances.get(t.id)),e.addInstance(t.id,o),e.drawCommandsDirty=!0})),j){const t=(u-h)*r;_.fill(0,0,t),e.instances.forEach((e=>{if(!(e.from>=h&&e.to<=u))return;const t=e.from-h;this._writeGeometry(e.geometry,g,t)})),m=h,f=u}const y=f-m;y>0&&d.setSubData(_,m*r,0,y*r),(0,n.hv)(t,((e,t)=>null==c[t]))}_writeGeometry(e,t,i){null!=this._bufferWriter&&((0,d.JG)(N,e.transformation),N[12]-=e.localOrigin.vec3[0],N[13]-=e.localOrigin.vec3[1],N[14]-=e.localOrigin.vec3[2],(0,d.U_)(F,N),(0,d.p4)(F,F),this._bufferWriter.write(N,F,e.geometry.attributes,e.geometry.objectAndLayerIdColor,t,i))}updateAnimation(e){return this.material.update(e)}acquireTechniques(e){if(!this.material.shouldRender(e))return null;const{output:t,bind:i}=e;if(!this.material.produces.get(i.slot)?.(t))return null;const{highlight:r,slot:n}=i,s=t===f.H_.ShadowHighlight,a=t===f.H_.Highlight,o=a||s,l=r?.name;if(o&&(0===this._highlightNames.size||a&&l&&!this._highlightNames.has(l)))return null;const c=e=>a&&!!l&&!e.has(l),h=t===f.H_.ShadowExcludeHighlight,u=!(o||h);for(const{buffers:r}of this._dataByOrigin.values())for(const a of r){if(c(a.highlightNames))continue;const r=s?a.drawCommandsHighlights.get(E.b):o?l?a.drawCommandsHighlights.get(l):a.drawCommandsHighlights.size>0:((h&&a.needsMultipleCommands()?a.drawCommandsShadowHighlightRest:a.drawCommandsDefault)||null)?.length??!1,d=u&&a.drawCommandsOccludees||null;if(r||d?.length){const r=this._glMaterials.load(e.rctx,n,t)?.beginSlot(i);if(r)return r}}return null}render(e,t){const{output:i,bind:r}=e,{slot:n,highlight:s}=r,a=i===f.H_.Highlight,o=s?.name??"";if(a&&!s)return;const c=i===f.H_.ShadowHighlight,h=a||c,u=i===f.H_.ShadowExcludeHighlight,d=!(h||u),p=n===v.r.OCCLUDER_MATERIAL||n===v.r.TRANSPARENT_OCCLUDER_MATERIAL?n:null,{rctx:m}=e;m.runAppleAmdDriverHelper();const _=m.bindTechnique(t,r,this.material.parameters);for(const e of this._dataByOrigin.values())for(const i of e.buffers){if(a&&(!i.hasHighlights||!i.drawCommandsHighlights.has(o)))continue;if(c&&(!i.hasHighlights||!i.drawCommandsHighlights.has(E.b)))continue;const n=()=>{const e=[],t=i.drawCommandsHighlights.get(E.b)??new l.Z;return t&&e.push(t),e},s=h&&!c?i.drawCommandsHighlights.get(o)??null:null,f=c?n():h?s?[s]:Z:u&&i.needsMultipleCommands()?[i.drawCommandsShadowHighlightRest]:[i.drawCommandsDefault],g=f.some((e=>e.length>0)),y=d&&i.drawCommandsOccludees||null;if(g||y?.length){if(this._drawParameters.origin=e.origin,_.bindDraw(r,this.material.parameters,this._drawParameters),t.ensureAttributeLocations(i.vao),m.bindVAO(i.vao),g)for(const e of f)m.setPipelineState(t.getPipeline(!1,p)),e.forAll((e=>m.drawArrays(t.primitiveType,e.first,e.count)));y?.length&&(m.setPipelineState(t.getPipeline(!0,p)),y.forAll((e=>m.drawArrays(t.primitiveType,e.first,e.count))))}}}static prune(){z=new Float32Array(H)}get test(){}};(0,r._)([(0,h.Cb)({constructOnly:!0})],D.prototype,"material",void 0),(0,r._)([(0,h.Cb)({})],D.prototype,"highlightOrderMap",void 0),D=(0,r._)([(0,u.j)("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],D);class I{constructor(e){this.origin=e,this.changes=new Array}}function L(e,t){const i=e.find((e=>e.numElements>=t));if(null==i)return null;const r=i.from;return i.from+=t,i.from>=i.to&&e.removeUnordered(i),r}const N=(0,p.Ue)(),F=(0,p.Ue)(),U=new l.Z({allocator:e=>e||new C,deallocator:null}),H=65536,k=4*H,V=16777216,B=V/4;let z=new Float32Array(H);function G(e){return z.length<e&&(z=new Float32Array(e)),z}function q(e){const t=4*e;return t<=1024?1024:t<k?(0,s.Sf)(t):Math.max(Math.min(Math.ceil(1.5*t/k)*k,V),t)}const Z=[];let j},25906:function(e,t,i){i.d(t,{l:function(){return c}});var r=i(79487),n=i(58257),s=i(29107),a=i(65562),o=i(38419),l=i(51135);class c extends s.A{constructor(e,t){super(e,t,new n.J(a.a,(()=>i.e(39568).then(i.bind(i,39568)))))}initializePipeline(e){switch(e.blitMode){case o.J.None:case o.J.Depth:return(0,l.sm)({colorWrite:l.gf});case o.J.Alpha:return(0,l.sm)({blending:l.vf,colorWrite:l.gf});default:(0,r.Bg)(e.blitMode);case o.J.PremultipliedAlpha:case o.J.COUNT:return(0,l.sm)({blending:l.Zo,colorWrite:l.gf})}}}},38419:function(e,t,i){i.d(t,{J:function(){return r},Z:function(){return a}});var r,n=i(73440),s=i(83046);!function(e){e[e.None=0]="None",e[e.Alpha=1]="Alpha",e[e.PremultipliedAlpha=2]="PremultipliedAlpha",e[e.Depth=3]="Depth",e[e.COUNT=4]="COUNT"}(r||(r={}));class a extends s.m{constructor(){super(...arguments),this.blitMode=r.None,this.hasOpacityFactor=!1}}(0,n._)([(0,s.o)({count:r.COUNT})],a.prototype,"blitMode",void 0),(0,n._)([(0,s.o)()],a.prototype,"hasOpacityFactor",void 0)},8069:function(e,t,i){i.d(t,{T:function(){return s}});var r=i(73440),n=i(83046);class s extends n.m{constructor(){super(...arguments),this.receiveShadows=!0}}(0,r._)([(0,n.o)()],s.prototype,"receiveShadows",void 0)},4075:function(e,t,i){i.d(t,{X:function(){return l}});var r=i(31865),n=i(10934),s=i(48857),a=i(18489),o=i(52061);function l(e,t={needUVs:!0,needEyeDirection:!0}){e.attributes.add(o.T.POSITION,"vec2"),e.varyings.add("worldRay","vec3");const{needUVs:i,needEyeDirection:n}=t;i&&e.varyings.add("uv","vec2"),n&&e.varyings.add("eyeDir","vec3"),e.vertex.uniforms.add(new a.C("inverseProjectionMatrix",(e=>e.camera.inverseProjectionMatrix)),new a.C("inverseViewMatrix",(e=>(0,r.iS)(c,e.camera.viewMatrix)))),e.vertex.main.add(s.H`
    vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;
    ${(0,s.If)(n,"eyeDir = posViewNear;")}
    worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
    ${(0,s.If)(i,"uv = position * 0.5 + vec2(0.5);")}
    gl_Position = vec4(position, 1, 1);
  `)}const c=(0,n.Ue)()},80518:function(e,t,i){i.d(t,{i:function(){return a},j:function(){return r}});var r,n=i(73440),s=i(83046);!function(e){e[e.PRIMARY=0]="PRIMARY",e[e.CONTEXT=1]="CONTEXT",e[e.COUNT=2]="COUNT"}(r||(r={}));class a extends s.m{constructor(e){super(),this.index=r.PRIMARY,this.index=e}}(0,n._)([(0,s.o)({count:r.COUNT})],a.prototype,"index",void 0)},65718:function(e,t,i){i.d(t,{l:function(){return a},w:function(){return r}});var r,n=i(73440),s=i(83046);!function(e){e[e.Gradient=0]="Gradient",e[e.BandedGradient=1]="BandedGradient",e[e.Threshold=2]="Threshold",e[e.ThresholdAndGradient=3]="ThresholdAndGradient",e[e.COUNT=4]="COUNT"}(r||(r={}));class a extends s.m{constructor(){super(...arguments),this.visualization=r.Gradient}}(0,n._)([(0,s.o)({count:r.COUNT})],a.prototype,"visualization",void 0)},47975:function(e,t,i){i.d(t,{l:function(){return n}});var r=i(48857);function n(e){e.code.add(r.H`vec2 sphereIntersect(vec3 start, vec3 dir, float distance) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float d = (b * b) - 4.0 * a * distance;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`)}},30631:function(e,t,i){i.d(t,{Z:function(){return PR}});var r=i(73440),n=i(41309),s=i(27172),a=i(43254),o=i(87286),l=i(88194),c=i(10729),h=i(50702),u=i(61432),d=i(96711),p=i(61100),m=i(93399),f=i(93568),_=i(90403),g=i(99153),y=i(96094),v=i(26636),b=i(82592),w=i(17155),C=i(90775),x=(i(83850),i(48023)),T=i(95226),S=i(70880),M=i(66951),E=i(22018);function P(e,t){const i=(0,E.vw)(e),r=(0,E.vw)(t),n=i.store,s=r.store,a=r.metadata;for(const t in a){const i=a[t],r=n.originOf(t),o=s.originOf(t);if(!i.readOnly&&o!==M.s3.DEFAULTS)if(r===M.s3.DEFAULTS)e.set(t,s.get(t));else{const e=n.get(t),i=s.get(t);e&&i&&i instanceof S.Z&&e instanceof S.Z&&e instanceof i.constructor&&P(e,i)}}}var R=i(82846),A=i(34415),O=i(71354),D=i(86640),I=i(60508),L=i(13132),N=i(45213),F=i(774),U=i(6961),H=i(47566),k=i(5226),V=i(4469),B=i(75428);let z=class extends A.a{constructor(e){super(e),this.addHandles(this.on("before-add",(e=>{null!=e.item&&e.item.parent===this.owner&&(d.Z.getLogger(this).warn("Analysis inside the collection must be unique. Not adding this element again."),e.preventDefault())})))}_own(e){e.parent=this.owner}_release(e){e.parent=null}};z=(0,r._)([(0,x.j)("esri.support.AnalysesCollection")],z);var G=i(72728),q=i(82703);const Z={widthBreakpoint:{getValue(e){const t=e.viewSize[0],i=e.breakpoints,r=this.values;return t<=i.xsmall?r.xsmall:t<=i.small?r.small:t<=i.medium?r.medium:t<=i.large?r.large:r.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-width-xsmall esri-view-width-less-than-small esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",small:"esri-view-width-small esri-view-width-greater-than-xsmall esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",medium:"esri-view-width-medium esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-less-than-large esri-view-width-less-than-xlarge",large:"esri-view-width-large esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-less-than-xlarge",xlarge:"esri-view-width-xlarge esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-greater-than-large"}},heightBreakpoint:{getValue(e){const t=e.viewSize[1],i=e.breakpoints,r=this.values;return t<=i.xsmall?r.xsmall:t<=i.small?r.small:t<=i.medium?r.medium:t<=i.large?r.large:r.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-height-xsmall esri-view-height-less-than-small esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",small:"esri-view-height-small esri-view-height-greater-than-xsmall esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",medium:"esri-view-height-medium esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-less-than-large esri-view-height-less-than-xlarge",large:"esri-view-height-large esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-less-than-xlarge",xlarge:"esri-view-height-xlarge esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-greater-than-large"}},orientation:{getValue(e){const t=e.viewSize,i=t[0],r=t[1],n=this.values;return r>=i?n.portrait:n.landscape},values:{portrait:"portrait",landscape:"landscape"},valueToClassName:{portrait:"esri-view-orientation-portrait",landscape:"esri-view-orientation-landscape"}}},j={xsmall:544,small:768,medium:992,large:1200};function W(e,t){return t?Z[e].valueToClassName[t].split(" "):[]}const $=e=>{let t=class extends e{constructor(...e){super(...e),this.orientation=null,this.widthBreakpoint=null,this.heightBreakpoint=null,this.breakpoints=j}initialize(){this.addHandles((0,_.YP)((()=>[this.breakpoints,this.size]),(()=>this._updateClassNames()),_.nn))}destroy(){this.destroyed||this._removeActiveClassNames()}set breakpoints(e){if(e!==this._get("breakpoints")){if(!function(e){const t=e;return t&&t.xsmall<t.small&&t.small<t.medium&&t.medium<t.large}(e)){const t=JSON.stringify(j,null,2);console.warn("provided breakpoints are not valid, using defaults:"+t),e=j}this._set("breakpoints",{...e})}}_updateClassNames(){if(!this.container)return;const e=q.Z.acquire(),t=q.Z.acquire();let i,r=!1;for(i in Z){const n=this[i],s=Z[i].getValue({viewSize:this.size,breakpoints:this.breakpoints});n!==s&&(r=!0,this[i]=s,W(i,n).forEach((e=>t.push(e))),W(i,s).forEach((t=>e.push(t))))}r&&(this._applyClassNameChanges(e,t),q.Z.release(e),q.Z.release(t))}_applyClassNameChanges(e,t){const i=this.container;i&&(t.forEach((e=>i.classList.remove(e))),e.forEach((e=>i.classList.add(e))))}_removeActiveClassNames(){const e=this.container;if(!e)return;let t;for(t in Z)W(t,this[t]).forEach((t=>e.classList.remove(t)))}};return(0,r._)([(0,w.Cb)()],t.prototype,"breakpoints",null),(0,r._)([(0,w.Cb)()],t.prototype,"orientation",void 0),(0,r._)([(0,w.Cb)()],t.prototype,"widthBreakpoint",void 0),(0,r._)([(0,w.Cb)()],t.prototype,"heightBreakpoint",void 0),t=(0,r._)([(0,x.j)("esri.views.BreakpointsOwner")],t),t};var X=i(60147),Y=(i(45357),i(59143));let K=class extends S.Z{constructor(){super(...arguments),this.items=new a.Z,this._watchUpdatingTracking=new X.R,this._callbacks=new Map,this._projector=(0,Y.E)(),this._hiddenProjector=(0,Y.E)()}get needsRender(){return this.items.length>0}get updating(){return this._watchUpdatingTracking?.updating??!1}initialize(){const e=document.createElement("div");e.className="esri-overlay-surface",this._set("surface",e),this._hiddenSurface=document.createElement("div"),this._hiddenSurface.setAttribute("style","visibility: hidden;"),e.appendChild(this._hiddenSurface),this._watchUpdatingTracking.addOnCollectionChange((()=>this.items),(e=>{for(const t of e.added){const e=()=>t.render();this._callbacks.set(t,e),this._projector.append(this.surface,e)}for(const t of e.removed){const e=this._projector.detach(this._callbacks.get(t));this.surface.removeChild(e.domNode),this._callbacks.delete(t)}}))}addItem(e){this.items.add(e)}removeItem(e){this.items.remove(e)}destroy(){this.items.removeAll(),this._callbacks.forEach((e=>this._projector.detach(e))),this._callbacks=null,this._projector=null,this._watchUpdatingTracking.destroy()}render(){this._projector.renderNow()}computeBoundingRect(e){const t=this._hiddenSurface,i=this._hiddenProjector;let r;const n=()=>(r=e.render(),r);i.append(t,n),i.renderNow();const s={left:0,top:0,right:0,bottom:0};if(r?.domNode){const e=r.domNode.getBoundingClientRect();s.left=e.left,s.top=e.top,s.right=e.right,s.bottom=e.bottom}for(i.detach(n);t.firstChild;)t.removeChild(t.firstChild);return s}overlaps(e,t){const i=this.computeBoundingRect(e),r=this.computeBoundingRect(t);return Math.max(i.left,r.left)<=Math.min(i.right,r.right)&&Math.max(i.top,r.top)<=Math.min(i.bottom,r.bottom)}get hasVisibleItems(){return this.items.some((e=>e.visible))}async prepare(){await document.fonts.load(this._fontString()).catch((()=>{}))}renderCanvas(e,t){const i=!!t?.disableDecorations;if(!this.items.some((e=>e.visible&&!(i&&e.isDecoration))))return;const r=e.getContext("2d");r.save(),r.font=this._fontString(),this.items.forEach((e=>{i&&e.isDecoration||(r.save(),e.renderCanvas(r),r.restore())})),r.restore()}_fontString(){return`10px ${getComputedStyle(this.surface).fontFamily}`}};(0,r._)([(0,w.Cb)({readOnly:!0})],K.prototype,"surface",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],K.prototype,"items",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],K.prototype,"needsRender",null),(0,r._)([(0,w.Cb)({readOnly:!0})],K.prototype,"_watchUpdatingTracking",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],K.prototype,"updating",null),K=(0,r._)([(0,x.j)("esri.views.overlay.ViewOverlay")],K);const Q=K,J=[0,0];function ee(e){const t=(e.ownerDocument||window.document).defaultView,i=e.getBoundingClientRect();return J[0]=i.left+(t?.pageXOffset??0),J[1]=i.top+(t?.pageYOffset??0),J}function te(e){e&&(e.textContent="",e.parentNode&&e.parentNode.removeChild(e))}const ie=16,re=750,ne=e=>{let t=class extends e{constructor(...e){super(...e),this._freqInfo={freq:ie,time:re},this._overlayRenderTaskHandle=null,this.height=0,this.messagesCommon=null,this.overlay=null,this.position=null,this.resizing=!1,this.root=null,this.surface=null,this.suspended=!0,this.userContent=null,this.width=0,this.widthBreakpoint=null,this.addHandles([(0,_.YP)((()=>this.cursor),(e=>{const{surface:t}=this;t&&t.setAttribute("data-cursor",e)})),(0,_.YP)((()=>this.navigating),(e=>{const{surface:t}=this;t&&t.setAttribute("data-navigating",e.toString())}))])}initialize(){this.addHandles([(0,_.YP)((()=>this.ui),((e,t)=>this._handleUIChange(e,t)),_.nn),this.on("focus",(()=>this.notifyChange("focused"))),this.on("blur",(()=>this.notifyChange("focused")))])}destroy(){this.destroyed||(this.ui?.destroy(),this.container=null)}get container(){return this._get("container")??null}set container(e){const t=this._get("container"),i=(0,o.L)(e);if(i||"string"!=typeof e||d.Z.getLogger(this).error("#container",`element with id '${e}' not found`),t===i)return;if(this._stopMeasuring(),t&&(t.classList.remove("esri-view"),this._overlayRenderTaskHandle&&(this._overlayRenderTaskHandle.remove(),this._overlayRenderTaskHandle=null),this.overlay&&(this.overlay.destroy(),this._set("overlay",null)),this.root&&(te(this.root),this._set("root",null)),this.userContent&&((0,o.Y)(this.userContent,t),te(this.userContent),this._set("userContent",null))),!i)return this._set("width",0),this._set("height",0),this._set("position",null),this._set("suspended",!0),this._set("surface",null),void this._set("container",null);i.classList.add("esri-view");const r=document.createElement("div");r.className="esri-view-user-storage",(0,o.Y)(i,r),i.appendChild(r),this._set("userContent",r);const n=document.createElement("div");n.className="esri-view-root",i.insertBefore(n,i.firstChild),this._set("root",n);const s=document.createElement("div");s.className="esri-view-surface",s.setAttribute("role","application"),s.tabIndex=0,n.appendChild(s),this._set("surface",s);const a=new Q;n.appendChild(a.surface),this._set("overlay",a),this.addHandles((0,_.YP)((()=>a.needsRender),(e=>{e&&!this._overlayRenderTaskHandle?this._overlayRenderTaskHandle=(0,g.A)({render:()=>this.overlay?.render()}):this._overlayRenderTaskHandle=(0,p.hw)(this._overlayRenderTaskHandle)}))),this.forceDOMReadyCycle(),this._set("container",i),this._startMeasuring()}get focused(){const e=document.activeElement===this.surface;return document.hasFocus()&&e}get size(){return[this.width,this.height]}set ui(e){const t=this._get("ui");t!==e&&t?.destroy(),this._set("ui",e)}blur(){this.surface?.blur()}focus(){this.surface?.focus()}pageToContainer(e,t,i){const r=this.position;return e-=r?r[0]:0,t-=r?r[1]:0,i?(i[0]=e,i[1]=t):i=[e,t],i}containerToPage(e,t,i){const r=this.position;return e+=r?r[0]:0,t+=r?r[1]:0,i?(i[0]=e,i[1]=t):i=[e,t],i}_handleUIChange(e,t){this.removeHandles("ui"),t&&t!==e&&t.destroy(),e&&(e.view=this,this.addHandles((0,_.YP)((()=>this.root),(t=>{e.container=t?function(e){const t=document.createElement("div");return e.appendChild(t),t}(t):null}),_.nn),"ui")),this._set("ui",e)}_stopMeasuring(){this.removeHandles("measuring"),this._get("resizing")&&this._set("resizing",!1)}_startMeasuring(){const e=this._freqInfo;e.freq=ie,e.time=re;const t=(0,g.A)({prepare:e=>{const i=this._measure(),r=this._freqInfo;if(r.time+=e.deltaTime,i&&(r.freq=ie,this._get("resizing")||this._set("resizing",!0)),r.time<r.freq)return;r.time=0;const n=this._position();r.freq=n||i?ie:Math.min(re,2*r.freq),!i&&r.freq>=512&&(t.pause(),this._get("resizing")&&this._set("resizing",!1))}}),i=new ResizeObserver((i=>{e.freq=ie,e.time=re,t.resume()}));null!=this.container&&i.observe(this.container);const r=(0,h.kB)((()=>i.disconnect()));this.addHandles([(0,c.on)(window,"resize",(()=>{e.freq=ie,e.time=re,t.resume()})),r,t],"measuring"),this._measure(),this._position()}_measure(){const e=this.container,t=e?e.clientWidth:0,i=e?e.clientHeight:0;if(0===t||0===i)return this.suspended||this._set("suspended",!0),!1;const r=this.width,n=this.height;return t===r&&i===n?(this.suspended&&this._set("suspended",!1),!1):(this._set("width",t),this._set("height",i),this.suspended&&this._set("suspended",!1),this.emit("resize",{oldWidth:r,oldHeight:n,width:t,height:i}),!0)}_position(){const e=this.container,t=this.position,i=e&&ee(e);return!(!i||t&&i[0]===t[0]&&i[1]===t[1]||(this._set("position",[i[0],i[1]]),0))}forceDOMReadyCycle(){}};return(0,r._)([(0,w.Cb)()],t.prototype,"container",null),(0,r._)([(0,w.Cb)({readOnly:!0})],t.prototype,"focused",null),(0,r._)([(0,w.Cb)({readOnly:!0})],t.prototype,"height",void 0),(0,r._)([(0,w.Cb)()],t.prototype,"messagesCommon",void 0),(0,r._)([(0,w.Cb)({type:Q})],t.prototype,"overlay",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],t.prototype,"position",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],t.prototype,"resizing",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],t.prototype,"root",void 0),(0,r._)([(0,w.Cb)({value:null,readOnly:!0})],t.prototype,"size",null),(0,r._)([(0,w.Cb)({readOnly:!0})],t.prototype,"surface",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],t.prototype,"suspended",void 0),(0,r._)([(0,w.Cb)({nonNullable:!0})],t.prototype,"ui",null),(0,r._)([(0,w.Cb)({readOnly:!0})],t.prototype,"userContent",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],t.prototype,"width",void 0),(0,r._)([(0,w.Cb)()],t.prototype,"widthBreakpoint",void 0),t=(0,r._)([(0,x.j)("esri.views.DOMContainer")],t),t};var se=i(69892),ae=i(87833),oe=i(72347),le=i(62535),ce=i(61554);let he=class extends ae.Z.EventedAccessor{constructor(e){super(e),this.noDataValue=ce.zl}initialize(){this.view.basemapTerrain.on("elevation-change",(()=>this.emit("changed",{})))}get demResolution(){return this.view.basemapTerrain.demResolution}get extent(){const e=this.view.basemapTerrain;if(null==e?.extent||null==e.spatialReference)return null;const t=(0,H.HH)(e.extent,e.spatialReference);return t.zmin=e.visibleElevationBounds.min,t.zmax=e.visibleElevationBounds.max,t}get spatialReference(){return this.view.basemapTerrain?.spatialReference??N.Z.WGS84}elevationAt(e,t){if(null==this.extent||!(0,oe.Kv)(this.extent,e,t)){const i=null!=this.extent?`${this.extent.xmin}, ${this.extent.ymin}, ${this.extent.xmax}, ${this.extent.ymax}`:null;return d.Z.getLogger(this).warn("#elevationAt()",`Point used to sample elevation (${e}, ${t}) is outside of the sampler extent (${i})`),this.noDataValue}return this.view.elevationProvider?.getElevation(e,t,0,this.spatialReference,"ground")??this.noDataValue}queryElevation(e){return(0,le.G$)(e.clone(),this)}};(0,r._)([(0,w.Cb)({readOnly:!0})],he.prototype,"demResolution",null),(0,r._)([(0,w.Cb)({readOnly:!0})],he.prototype,"extent",null),(0,r._)([(0,w.Cb)({readOnly:!0})],he.prototype,"noDataValue",void 0),(0,r._)([(0,w.Cb)()],he.prototype,"spatialReference",null),(0,r._)([(0,w.Cb)({constructOnly:!0})],he.prototype,"view",void 0),he=(0,r._)([(0,x.j)("esri.views.support.GroundViewElevationSampler")],he);const ue=he;let de=class extends S.Z{constructor(e){super(e),this.view=null,this.layerViews=new a.Z}initialize(){this.addHandles((0,_.gx)((()=>this.view?.map?.ground),(e=>e.load())))}destroy(){this._set("view",null);for(const e of this.layerViews)e.destroy();this.layerViews.length=0}get elevationSampler(){return"2d"!==this.view?.type&&this.view?.ready&&this.view?.basemapTerrain?.ready?new ue({view:this.view}):null}get extent(){const e=this.view;return e&&"2d"!==e.type&&e.ready?(0,se.HH)(e,e.state.camera,e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation):null}get updating(){return!this.suspended&&this.layerViews.some((e=>e.updating))}get suspended(){return this.view?.suspended??!0}};(0,r._)([(0,w.Cb)({readOnly:!0})],de.prototype,"elevationSampler",null),(0,r._)([(0,w.Cb)({readOnly:!0})],de.prototype,"extent",null),(0,r._)([(0,w.Cb)({type:Boolean,readOnly:!0})],de.prototype,"updating",null),(0,r._)([(0,w.Cb)({constructOnly:!0})],de.prototype,"view",void 0),(0,r._)([(0,w.Cb)({type:a.Z,readOnly:!0})],de.prototype,"layerViews",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],de.prototype,"suspended",null),de=(0,r._)([(0,x.j)("esri.views.GroundView")],de);const pe=de;var me=i(29292),fe=i(96620);function _e(e){return null!=e&&"open"in e&&"declaredClass"in e}function ge(e){return null!=e&&"declaredClass"in e&&"dockOptions"in e}const ye=e=>{let t=class extends e{constructor(){super(...arguments),this._popupSetupTask=null,this.popup={},this.popupEnabled=!0}initialize(){this.addHandles([(0,_.YP)((()=>[this.ui,this.popup]),(([e,t],i)=>{const r="popup";if(i){const[e,n]=i;e&&_e(n)&&(n.view=null,ge(n)&&(e.remove(n,r),n!==t&&t&&n.destroy()))}e&&_e(t)&&(t.view=this,ge(t)&&e.add(t,{key:r,position:"manual",internal:!0}))}),_.tX),this.on("click",(e=>{this.popup&&this.popupEnabled&&("mouse"!==e.pointerType||0===e.button)&&(_e(this.popup)?this.popup.viewModel.handleViewClick(e):e.defer((async()=>{await this.setupPopup(),_e(this.popup)&&!this.destroyed&&this.ready&&this.popupEnabled&&this.popup.viewModel.handleViewClick(e)})))}),fe.f.WIDGET)]),(0,_.N1)((()=>this.ready&&this.popupEnabled&&!this.updating)).then((()=>{Promise.all([i.e(38586),i.e(55105),i.e(88792),i.e(60541),i.e(98733),i.e(96526),i.e(40993),i.e(49405),i.e(59876),i.e(86035),i.e(81880),i.e(87114)]).then(i.bind(i,42150))}))}destroy(){this.destroyed||this.closePopup()}async openPopup(e){if(_e(this.popup))return this.popup.open(e);try{if(await this.setupPopup(),!this.popup)return void d.Z.getLogger(this).error(new l.Z("view:null-popup","Popup is null and can't be opened"));this.popup.open(e)}catch{}}closePopup(){this._popupSetupTask?.abort(),_e(this.popup)&&this.popup.close()}async fetchPopupFeatures(e,t){return await this.when(),this._popupHitsToFeatures(await this._getPopupHits(e,t),t)}async setupPopup(){if(this._popupSetupTask?.abort(),this.popup&&!_e(this.popup))return this._popupSetupTask=(0,me.vr)((async e=>{const{default:t}=await Promise.all([i.e(38586),i.e(55105),i.e(88792),i.e(60541),i.e(98733),i.e(96526),i.e(40993),i.e(49405),i.e(59876),i.e(86035),i.e(81880),i.e(87114)]).then(i.bind(i,42150));if((0,f.k_)(e),!this.popup||_e(this.popup))return;const r=this.popup;delete r.open,delete r.close,this.popup=new t(r)})),this._popupSetupTask.promise}async _popupHitsToFeatures({location:e,hits:t},i){const r=[],n=[];let s=!1;const a=(0,f.CH)(i,(0,u.Z)("popup-view-fetch-timeout")??be),o=e=>{const t=n.at(-1);return t&&t.layerView===e&&!s?t:(e=>{const t=new ve(e);return n.push(t),r.push(t.promise),t})(e)};for(const e of t)"graphic"in e?(o(e.layerView).graphics.push(e.graphic),s=!1):(r.push(e.layerView.fetchPopupFeaturesAtLocation(e.mapPoint,a)),s=!0);n.map((e=>e.resolve(a)));const l=(0,f.OT)(r).then((e=>e.filter((e=>!!e)).flat()));return{pendingFeatures:r,allGraphicsPromise:l,location:e}}async _getPopupHits(e,t){const{hits:i,location:r}=await this.popupHitTest(e);(0,f.k_)(t);const n=[];for(const e of i)if("graphic"in e){if(this._isValidPopupGraphic(e.graphic,t)){const t=this._isValidPopupGraphicsLayerView(e.layerView)?e.layerView:void 0;n.push({graphic:e.graphic,layerView:t})}}else this._isValidPopupLocationLayerView(e.layerView)&&n.push({mapPoint:e.mapPoint,layerView:e.layerView});return{hits:n,location:r}}_isValidPopupGraphic(e,t){return e&&!!e.getEffectivePopupTemplate(t?.defaultPopupTemplateEnabled)}_isValidPopupGraphicsLayerView(e){return!e||(!("layer"in e)||!e.suspended)&&"fetchPopupFeaturesFromGraphics"in e}_isValidPopupLocationLayerView(e){return(!("layer"in e)||!e.suspended)&&"fetchPopupFeaturesAtLocation"in e}};return(0,r._)([(0,w.Cb)()],t.prototype,"popup",void 0),(0,r._)([(0,w.Cb)()],t.prototype,"popupEnabled",void 0),t=(0,r._)([(0,x.j)("esri.views.PopupView")],t),t};class ve{constructor(e){this.layerView=e,this._resolver=(0,f.hh)(),this.graphics=[]}get promise(){return this._resolver.promise}resolve(e){const{layerView:t,graphics:i,_resolver:r}=this;if(!t)return r.resolve(i),r.promise;let n;return t.fetchPopupFeaturesFromGraphics(i,e).catch((e=>(n=e,null))).then((e=>{e?r.resolve(e):r.reject(n)})),r.promise}}const be=5e3;var we=i(82439),Ce=i(63727),xe=i(41145),Te=i(12818),Se=i(97006),Me=i(76329),Ee=i(8554),Pe=i(53866),Re=i(41801),Ae=i(85913),Oe=i(88097);let De=class extends S.Z{constructor(e){super(e),this.view=null,this.baseLayerViews=new a.Z,this.referenceLayerViews=new a.Z,this._loadingHandle=(0,_.YP)((()=>this.view?.map?.basemap),(e=>{e&&e.load().catch((()=>{}))}),_.nn)}destroy(){this._set("view",null),this._loadingHandle&&(this._loadingHandle.remove(),this._loadingHandle=null);for(const e of this.baseLayerViews)e.destroy();this.baseLayerViews.length=0;for(const e of this.referenceLayerViews)e.destroy();this.referenceLayerViews.length=0}get suspended(){return this.view?.suspended??!0}get updating(){if(this.view?.suspended)return!1;const e=this.view?.map?.basemap;return!!e?.loaded&&(this.baseLayerViews.some((e=>e.updating))||this.referenceLayerViews.some((e=>e.updating)))}};(0,r._)([(0,w.Cb)({constructOnly:!0})],De.prototype,"view",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],De.prototype,"baseLayerViews",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],De.prototype,"referenceLayerViews",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],De.prototype,"suspended",null),(0,r._)([(0,w.Cb)({type:Boolean,readOnly:!0})],De.prototype,"updating",null),De=(0,r._)([(0,x.j)("esri.views.BasemapView")],De);const Ie=De;let Le=class extends S.Z{constructor(e){super(e),this.factor=1.5,this.offset=(0,y.vW)(0,0),this.position=null,this.size=120,this.maskUrl=null,this.maskEnabled=!0,this.overlayUrl=null,this.overlayEnabled=!0,this.visible=!0}get version(){return this.commitProperty("factor"),this.commitProperty("offset"),this.commitProperty("position"),this.commitProperty("visible"),this.commitProperty("size"),this.commitProperty("maskUrl"),this.commitProperty("maskEnabled"),this.commitProperty("overlayUrl"),this.commitProperty("overlayEnabled"),(this._get("version")||0)+1}};(0,r._)([(0,w.Cb)({type:Number})],Le.prototype,"factor",void 0),(0,r._)([(0,w.Cb)({nonNullable:!0})],Le.prototype,"offset",void 0),(0,r._)([(0,w.Cb)()],Le.prototype,"position",void 0),(0,r._)([(0,w.Cb)({type:Number,range:{min:0}})],Le.prototype,"size",void 0),(0,r._)([(0,w.Cb)()],Le.prototype,"maskUrl",void 0),(0,r._)([(0,w.Cb)()],Le.prototype,"maskEnabled",void 0),(0,r._)([(0,w.Cb)()],Le.prototype,"overlayUrl",void 0),(0,r._)([(0,w.Cb)()],Le.prototype,"overlayEnabled",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],Le.prototype,"version",null),(0,r._)([(0,w.Cb)({type:Boolean})],Le.prototype,"visible",void 0),Le=(0,r._)([(0,x.j)("esri.views.Magnifier")],Le);const Ne=Le;var Fe=i(3480),Ue=i(79577),He=i(87422),ke=i(74355),Ve=i(29191);function Be(e){return!(null==e||"object"!=typeof e||!("createQuery"in e)||!e.createQuery)}let ze=class extends ae.Z.EventedAccessor{constructor(e){super(e),this._selectionMap=new He.Z,this._sources=new a.Z,this._trashCan=[],this._layerEditHandles=new a.Z,this._vizTaskId=0,this.view=null,this.showHighlight=!0,this.highlightName="default"}initialize(){this.addHandles([(0,_.YP)((()=>[this.view,this.showHighlight]),(()=>this._refreshVisualization())),(0,_.YP)((()=>this.view),(e=>{e?.when().then((()=>this.syncSources()))}),_.nn),(0,_.on)((()=>this.sources),"change",(e=>{const t=this._selectionMap,i=[];for(const r of e.removed){const e=t.get(r);e&&(t.delete(r),e.highlightHandle?.remove(),i.push({layer:r,selection:[],added:[],removed:[...e.selection]}))}this._refreshListeners(),i.length&&this._onSelectionChange(i)}),{onListenerAdd:()=>this._refreshListeners()})])}destroy(){this.clear(),this._layerEditHandles.drain(p.hw)}get selections(){return Array.from(this._selectionMap.entries()).map((e=>{const[t,i]=e;return{layer:t,selection:[...i.selection]}}))}get count(){let e=0;for(const t of this._selectionMap.values())e+=t.selection.length;return e}get hasSelection(){return this.count>0}get sources(){return this._sources}set sources(e){(0,xe.Z)(e,this._sources)}syncSources(){const e=new Set,t=this.view?.map;if(!t)return;const i=t=>{(0,B.Q2)(t)?(t.layers?.forEach(i),t.tables?.forEach(i)):(0,B.rC)(t)?(t.sublayers?.forEach(i),t.subtables?.forEach(i)):(0,B.e9)(t)?t.sublayers?.forEach(i):Be(t)&&e.add(t)};t.allLayers.forEach(i),t.allTables.forEach(i),this.sources=[...e]}async getSelectedFeatures(e,t={},i="layerView"){const{view:r,selections:n}=this;if(!r&&"layerView"===i)return d.Z.getLogger(this).warn("Cannot query layer views without a view."),[];const s=e?.length?n.filter((t=>e.includes(t.layer))):n,a=[];return s.forEach((async e=>{const{layer:n,selection:s}=e;if(!s.length)return;const o=(0,B.Hd)(n)?n.parent:n;if(null==o)return;if("layer"===i)return void a.push(je(o,s,t));if(Ge(o)||!r||!qe(o))return;const l=await r.whenLayerView(o).catch((()=>null));l&&a.push(je(l,s,t))})),(await Promise.all(a)).filter((e=>null!=e))}updateSelection(e){const t=new Map;for(const[e,i]of this._selectionMap)t.set(e,[...i.selection]);let i=!1;const r=e.current.concat(e.added);for(const e of r){const r=e.sourceLayer,n=e.getObjectId();if(this.sources.includes(r)&&(Be(r)||(0,B.Hd)(r))&&null!==n){const e=(0,Ue.s1)(t,r,(()=>[]));e.includes(n)||(e.push(n),i=!0)}}for(const r of e.removed){const e=r.sourceLayer,n=r.getObjectId();if(this.sources.includes(e)&&(Be(e)||(0,B.Hd)(e))&&null!==n){const r=t.get(e),s=r?.indexOf(n);void 0!==s&&s>=0&&(r?.splice(s,1),i=!0)}}if(i){const{_selectionMap:e,_trashCan:i}=this,r=[];for(const[n,s]of t){const t=e.get(n);void 0!==t&&i.push(t),e.set(n,{selection:s}),r.push({layer:n,selection:s,...(0,Fe.e5)(void 0!==t?t.selection:[],s)})}this._onSelectionChange(r)}}setSelection(e,t){this._setSelection(e,t)}getSelection(e){return this._selectionMap.get(e)?.selection}appendToSelection(e,t){const i=this._selectionMap.get(e),r=void 0!==i?[...i.selection]:[];for(const e of t)r.includes(e)||r.push(e);this._setSelection(e,r)}removeFromSelection(e,t){const i=this._selectionMap.get(e);if(!i)return;const r=[];for(const e of i.selection)t.includes(e)||r.push(e);this._setSelection(e,r)}toggleInSelection(e,t){const i=this._selectionMap.get(e);if(!i||0===i.selection.length)return void this._setSelection(e,t);const r=new Set(i.selection),n=new Set(t),s=(0,ke.Sp)(r,n);this._setSelection(e,Array.from(s))}clear(){const e=this._selectionMap.values();this._trashCan.push(...e);const t=[];for(const[e,i]of this._selectionMap.entries())t.push({layer:e,added:[],removed:[...i.selection],selection:[]});this._selectionMap.clear(),this._onSelectionChange(t)}_onSelectionChange(e){this._refreshVisualization(),this.emit("selection-change",{view:this.view,changes:e})}_refreshVisualization(){for(this._vizTaskId++;this._trashCan.length>0;){this._trashCan.pop()?.highlightHandle?.remove()}if(null==this.view)return;const{sources:e,view:t,_selectionMap:i,showHighlight:r}=this,n=this._vizTaskId;for(const s of e){const e=i.get(s),a=(0,B.Hd)(s)?s.parent:s;if(null!=a&&qe(a)){if(Ge(a))continue;t.whenLayerView(a).then((t=>{e?.highlightHandle?.remove(),null!=e&&r&&n===this._vizTaskId&&"highlight"in t&&"function"==typeof t.highlight&&e.selection.length>0&&(e.highlightHandle=t.highlight(e.selection,this.highlightName))})).catch((()=>{e?.highlightHandle?.remove()}))}}}_refreshListeners(){this._layerEditHandles.drain(p.hw);const e=new Set(this.sources.map((e=>(0,B.Hd)(e)?e.parent:e)));for(const t of e)Be(t)&&"on"in t&&t.on&&this._layerEditHandles.push(t.on("edits",(e=>this._onLayerEdit(e,t))))}_onLayerEdit(e,t){if((0,B.e9)(t))this._onParentLayerEdit(e,t);else if(e.deletedFeatures.length&&this._selectionMap.has(t)){const i=[];e.deletedFeatures.forEach((({error:e,objectId:t})=>{null!=t&&null==e&&i.push(t)})),this.removeFromSelection(t,i)}}_onParentLayerEdit(e,t){const{deletedFeatures:i,edits:r,updatedFeatures:n}=e;if(r?.updateFeatures?.forEach((e=>{const i=e.getObjectId()??e.attributes[t.objectIdField];if(null==i)return;if(n.find((e=>e.objectId===i))?.error)return;const r=t.findSublayerForFeature(e);if(!Be(r))return;const s=t.sublayers.find((e=>!(!Be(e)||!this.getSelection(e)?.includes(i))));Be(s)&&s!==r&&(this.removeFromSelection(s,[i]),this.appendToSelection(r,[i]))})),i.length){const e=[];i.forEach((({error:t,objectId:i})=>{null!=i&&null==t&&e.push(i)})),t.sublayers.forEach((t=>{Be(t)&&this._selectionMap.has(t)&&this.removeFromSelection(t,e)}))}}_setSelection(e,t){if(!this.sources.includes(e))throw new Error(`Cannot set selection on layer ${e.title} because it is not in 'sources'`);const i=this._selectionMap.get(e);if(void 0===i||!Ze(i,{selection:t})){void 0!==i&&this._trashCan.push(i),this._selectionMap.set(e,{selection:[...t]});const r={layer:e,selection:[...t],...(0,Fe.e5)(void 0!==i?i.selection:[],t)};this._onSelectionChange([r])}}};(0,r._)([(0,w.Cb)()],ze.prototype,"_selectionMap",void 0),(0,r._)([(0,w.Cb)()],ze.prototype,"_sources",void 0),(0,r._)([(0,w.Cb)({readOnly:!0,nonNullable:!0})],ze.prototype,"selections",null),(0,r._)([(0,w.Cb)({readOnly:!0,nonNullable:!0})],ze.prototype,"count",null),(0,r._)([(0,w.Cb)()],ze.prototype,"view",void 0),(0,r._)([(0,w.Cb)({readOnly:!0,nonNullable:!0})],ze.prototype,"hasSelection",null),(0,r._)([(0,w.Cb)()],ze.prototype,"showHighlight",void 0),(0,r._)([(0,w.Cb)()],ze.prototype,"sources",null),(0,r._)([(0,w.Cb)()],ze.prototype,"highlightName",void 0),ze=(0,r._)([(0,x.j)("esri.views.SelectionManager")],ze);const Ge=e=>(0,B.Hd)(e)?!0===e.parent?.isTable:e.isTable,qe=e=>void 0!==e?.when,Ze=(e,t)=>{if(null==e&&null==t)return!0;if(null!=e&&null==t||null==e&&null!=t)return!1;if(null!=e&&null!=t&&null!=e.selection&&null!=t.selection){const i=[...e.selection],r=[...t.selection];if(i.length!==r.length)return!1;i.sort(),r.sort();for(let e=0;e<i.length;e++)if(i[e]!==r[e])return!1}return!0},je=async(e,t,i={})=>{let r;if((e=>void 0!==e.layer)(e)){const n=e;r=void 0===n?null:await n.queryFeatures(new Ve.Z({...i,objectIds:t})).then((t=>({data:t,layer:e.layer})))}else{const n=e;r=void 0===n?null:await n.queryFeatures(new Ve.Z({...i,objectIds:t})).then((e=>({data:e,layer:n})))}return r},We=ze;var $e=i(53147),Xe=i(89314);let Ye=class extends(Xe.Z.ClonableMixin(S.Z)){constructor(e){super(e),this.accentColor=new $e.Z([255,127,0]),this.textColor=new $e.Z([255,255,255])}};(0,r._)([(0,w.Cb)({type:$e.Z,nonNullable:!0})],Ye.prototype,"accentColor",void 0),(0,r._)([(0,w.Cb)({type:$e.Z,nonNullable:!0})],Ye.prototype,"textColor",void 0),Ye=(0,r._)([(0,x.j)("esri.views.Theme")],Ye);const Ke=Ye;var Qe=i(26411),Je=i(26124),et=i(55541),tt=i(18753);function it(e){return[e.on("before-add",(t=>{const i=t.item;if(null==i||e.includes(i))return d.Z.getLogger("esri.views.interactive.interactiveToolUtils").warn("Tool is either already in the list of tools or tool is `null`. Not adding tool."),void t.preventDefault();i.onAdd()})),e.on("after-remove",(e=>{const t=e.item;t.active&&(t.view.activeTool=null),t.destroy()}))]}function rt(e){return e.visible&&null!=e.getEditableFlag&&e.getEditableFlag(et.bH.USER)&&e.getEditableFlag(et.bH.MANAGER)}var nt=i(96302),st=i(99574),at=i(70134);class ot{constructor(){this._pointerLocations=new Map,this._hoveredManipulators=new Map,this._grabbedManipulators=new Map,this._draggedManipulators=new Map,this._stopDrag=!1,this._externallyDragging=!1,this._revertToNullActiveTool=!1,this._cursor=null}get cursor(){return this._cursor}hasFocusedManipulators(){return this._grabbedManipulators.size>0||this._draggedManipulators.size>0}handleInputEvent(e,t){const i=()=>e.stopPropagation();switch(e.type){case"pointer-move":ht(e.pointerType)&&this._pointerLocations.set(e.pointerId,{x:e.x,y:e.y,pointerType:e.pointerType});break;case"drag":this._grabbedManipulators.size>0?this._stopDrag=!0:"start"===e.action?this._externallyDragging=!0:"end"===e.action&&(this._externallyDragging=!1),this._stopDrag&&(i(),"end"===e.action&&(this._stopDrag=!1));break;case"pointer-down":{if(!ut(e))break;const r=(0,at.vT)(e),n=ct(r,e.pointerType,t.forEachTool);if(null==n)break;const s=n.manipulator,a=n.tool;null==s||null==a||!s.interactive||s.grabbable&&s.grabbableForEvent(e)||!s.grabbing||s.dragging||this._releaseManipulatorBeforeDragging(s,e,t),null!=s&&null!=a&&s.interactive&&s.grabbable&&s.grabbableForEvent(e)&&!s.grabbing&&(this._grabbedManipulators.set(e.pointerId,{manipulator:s,tool:a,start:r,pointerType:e.pointerType}),1===this._grabbedManipulators.size&&null==t.activeTool&&(this._revertToNullActiveTool=!0,t.setActiveTool(n.tool)),s.grabbing=!0,s.events.emit("grab-changed",{action:"start",pointerType:e.pointerType,screenPoint:r}),i());break}case"pointer-up":this._draggedManipulators.has(e.pointerId)||this._handlePointerEnd(e,t);break;case"pointer-drag":{if(!ut(e))break;const r=this._grabbedManipulators.get(e.pointerId),n=r?.manipulator,s=r?.tool;if(null==n||null==s)break;const a=(0,at.vT)(e);a.x=(0,st.uZ)(a.x,0,t.view.width),a.y=(0,st.uZ)(a.y,0,t.view.height);const o=r.start,l=this._draggedManipulators.get(e.pointerId);switch(e.action){case"start":case"update":"update"!==e.action&&1!==this._grabbedManipulators.size||(n.dragging=!0,l?n.events.emit("drag",{action:"update",start:o,screenPoint:a}):n.events.emit("drag",{action:"start",start:o,screenPoint:a,pointerType:e.pointerType}),this._draggedManipulators.set(e.pointerId,{tool:s,manipulator:n,start:o}));break;case"end":n.dragging=!1,l&&n.events.emit("drag",{action:"end",start:o,screenPoint:a}),this._draggedManipulators.delete(e.pointerId),this._handlePointerEnd(e,t)}i();break}case"immediate-click":{const r=(0,at.vT)(e),n=ct(r,e.pointerType,t.forEachTool);if(function(e){return!!e.native.shiftKey}(e)||t.forEachTool((e=>{if((null==n||n.tool!==e||e.automaticManipulatorSelection)&&e.manipulators){let t=!1;e.manipulators.forEach((({manipulator:e})=>{e.selected&&(e.selected=!1,t=!0)})),t&&e.onManipulatorSelectionChanged&&e.onManipulatorSelectionChanged()}})),null==n)break;const{manipulator:s,tool:a}=n;if(!s.interactive)break;s.selectable&&a.automaticManipulatorSelection&&(s.selected=!s.selected,a.onManipulatorSelectionChanged&&a.onManipulatorSelectionChanged());const o=e.native.shiftKey;s.events.emit("immediate-click",{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:o,stopPropagation:i}),dt(s,i);break}case"click":{const r=(0,at.vT)(e),n=ct(r,e.pointerType,t.forEachTool)?.manipulator;if(null==n||!n.interactive)break;const s=e.native.shiftKey;n.events.emit(e.type,{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:s}),i();break}case"double-click":{const r=(0,at.vT)(e),n=ct(r,e.pointerType,t.forEachTool),s=null!=n?n.manipulator:null;if(null==s||!s.interactive)break;const a=e.native.shiftKey;s.events.emit("double-click",{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:a,stopPropagation:i}),dt(s,i);break}case"immediate-double-click":{const r=(0,at.vT)(e),n=ct(r,e.pointerType,t.forEachTool),s=null!=n?n.manipulator:null;if(null==s||!s.interactive)break;const a=e.native.shiftKey;s.events.emit("immediate-double-click",{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:a,stopPropagation:i}),"mouse"===e.pointerType&&dt(s,i);break}}this._onFocusChange(t.forEachTool)}_releaseManipulatorBeforeDragging(e,t,i){e.grabbing=!1,e.events.emit("grab-changed",{action:"end",pointerType:t.pointerType,screenPoint:(0,at.vT)(t)}),this._grabbedManipulators.forEach((({manipulator:t},i)=>{t===e&&this._grabbedManipulators.delete(i)})),this._afterManipulatorRelease(i.setActiveTool)}_handlePointerEnd(e,t){const i=this._grabbedManipulators.get(e.pointerId)?.manipulator;null!=i&&i.grabbing&&(i.grabbing=!1,i.events.emit("grab-changed",{action:"end",pointerType:e.pointerType,screenPoint:(0,at.vT)(e)}),this._grabbedManipulators.delete(e.pointerId),this._afterManipulatorRelease(t.setActiveTool))}_onFocusChange(e){this._updateCursor(),this._updateFocusedManipulatorTools(e)}_updateCursor(){this._grabbedManipulators.size>0?this._cursor=lt(this._grabbedManipulators)||"grabbing":this._hoveredManipulators.size>0?this._cursor=lt(this._hoveredManipulators)||"pointer":this._cursor=null}_updateFocusedManipulatorTools(e){const t=new Set,i=new Set;this._grabbedManipulators.forEach((({tool:e})=>{t.add(e)})),this._hoveredManipulators.forEach((({tool:e})=>{i.add(e)})),e((e=>{e.hasGrabbedManipulators=t.has(e),e.hasHoveredManipulators=i.has(e);const r=this._grabbedManipulators.values(),n=(0,nt.sE)(r,(({tool:t})=>t===e));e.firstGrabbedManipulator=null!=n?n.manipulator:null}))}clearPointers(e,{forEachTool:t,setActiveTool:i},r=!0,n){const s=(t,i)=>t===e&&(null==n||n===i);this._grabbedManipulators.forEach((({tool:e,manipulator:t,pointerType:i},r)=>{s(e,t)&&(this._grabbedManipulators.delete(r),t.grabbing=!1,t.events.emit("grab-changed",{action:"end",screenPoint:null,pointerType:i}))})),this._draggedManipulators.forEach((({tool:e,manipulator:t},i)=>{s(e,t)&&(this._draggedManipulators.delete(i),t.dragging=!1,t.events.emit("drag",{action:"cancel"}))})),r&&this._hoveredManipulators.forEach((({tool:e,manipulator:t},i)=>{s(e,t)&&(this._hoveredManipulators.delete(i),t.hovering=!1)})),this._afterManipulatorRelease(i),this._onFocusChange(t)}updateHoveredStateFromKnownPointers(e){this._pointerLocations.forEach(((t,i)=>{this._updateHoveredStateForPointerAtScreenPosition((0,y.vW)(t.x,t.y),i,t.pointerType,e)}))}handleHoverEvent(e,t){const i=e.type;"pointer-up"!==i&&"immediate-click"!==i&&"pointer-move"!==i||!ht(e.pointerType)||("pointer-up"!==i&&this._externallyDragging?this._clearHoveredManipulatorStates(e.pointerId):this._updateHoveredStateForPointerAtScreenPosition((0,at.vT)(e),e.pointerId,e.pointerType,t))}_updateHoveredStateForPointerAtScreenPosition(e,t,i,r){let n=ct(e,i,r);const s=this._hoveredManipulators.get(t)?.manipulator;null==n||n.manipulator.interactive||(n=null),null!=n&&s===n.manipulator||(null!=s&&(s.hovering=!1),null!=n?(n.manipulator.hovering=!0,this._hoveredManipulators.set(t,n)):this._hoveredManipulators.delete(t),this._onFocusChange(r))}_afterManipulatorRelease(e){0===this._grabbedManipulators.size&&this._revertToNullActiveTool&&(e(null),this._revertToNullActiveTool=!1)}_clearHoveredManipulatorStates(e){this._hoveredManipulators.forEach((({manipulator:t},i)=>{e===i&&(this._hoveredManipulators.delete(e),t.hovering=!1)}))}}function lt(e){for(const{manipulator:t}of e.values())if(null!=t&&t.interactive){if(t.grabbing&&t.grabCursor)return t.grabCursor;if(t.cursor)return t.cursor}return null}function ct(e,t,i){let r=null;return i((i=>{if(null==i.manipulators||!rt(i))return!1;const n=i.manipulators.intersect(e,t);return null!=n&&(r={tool:i,manipulator:n},!0)})),r}function ht(e){return"mouse"===e}function ut(e){return"mouse"!==e.pointerType||0===e.button}function dt(e,t){e?.consumesClicks&&t()}const pt="attached",mt="tools";let ft=class extends S.Z{constructor(e){super(e),this._updatingHandles=new X.R,this._clock=Qe.m,this._manipulatorState=new ot,this.tools=new a.Z,this.cursor=null,this._interacting=!1,this._interactingTimeout=1e3,this._interactingTimeoutHandle=null,this._forEachTool=e=>{for(const t of this.tools.items)if(e(t))return}}initialize(){this.addHandles([this.view.on(Je.uS,(e=>{this._handleInputEvent(e)}),fe.f.TOOL),...it(this.tools),this.tools.on("before-add",(({item:e})=>{this._updateToolEditableFlag(e)})),this.tools.on("before-remove",(({item:e})=>{this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs),this._updateCursor()})),this.tools.on("change",(()=>{this._refreshToolWatchers()}))])}destroy(){this.activeTool=null,this.tools.drain((e=>e.destroy())),this._clearInteractingTimeout(),this._interacting=!1,this._updatingHandles.destroy()}get _manipulatorStateEventArgs(){return{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:e=>{this.activeTool=e},view:this.view}}set activeTool(e){if(null!=e&&!this.view.ready)return void d.Z.getLogger(this).error("Cannot set active tool while view is not ready.");if(e===this.activeTool)return;const t=this.activeTool;this._set("activeTool",e),null!=t&&t.deactivate(),null!=e&&e.activate(),this._removeIncompleteTools(e);for(const e of this.tools){this._updateToolEditableFlag(e);const t=rt(e);null!=this.activeTool&&t||this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs,!t)}this._updateCursor()}get updating(){return this._updatingHandles.updating||this.tools.some((e=>e.updating))}get interacting(){return this._interacting}_clearInteractingTimeout(){this._interactingTimeoutHandle=(0,p.hw)(this._interactingTimeoutHandle)}_startInteractingTimeout(){this._clearInteractingTimeout(),this._interactingTimeoutHandle=this._clock.setTimeout((()=>this._interacting=!1),this._interactingTimeout)}attach(){"3d"===this.view.type?this.addHandles([(0,_.YP)((()=>{const{state:e}=this.view;return"camera"in e&&e.camera}),(()=>this._forEachManipulator((e=>e.onViewChange())))),this.view.elevationProvider?.on("elevation-change",(e=>this._forEachManipulator((t=>t.onElevationChange(e)))))],pt):this.addHandles((0,_.YP)((()=>this.view.extent),(()=>this._forEachManipulator((e=>e.onViewChange())))))}detach(){this.activeTool=null,this.tools.removeAll(),this.removeHandles(pt),this._clearInteractingTimeout(),this._interacting=!1}_forEachManipulator(e){this._forEachTool((t=>{t.manipulators&&t.manipulators.forEach((({manipulator:i})=>e(i,t)))}))}_handleInputEvent(e){let t=!1;const i={...e,stopPropagation:()=>{t=!0,e.stopPropagation()}};null!=this.activeTool?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(i):this._forEachTool((e=>{!t&&e.visible&&e.handleInputEvent(i)})),!t&&function(e){return"key-down"===e.type&&e.key===tt.NG.cancel}(e)&&this.activeTool&&(e.stopPropagation(),e.preventDefault(),this.activeTool.cancel(),this.activeTool=null),this._manipulatorState.handleInputEvent(i,this._manipulatorStateEventArgs),t||null==this.activeTool||this.activeTool.handleInputEventAfter(i),this._manipulatorState.handleHoverEvent(i,this._forEachTool),this._updateCursor(),"pointer-move"===e.type&&(this._manipulatorState.hasFocusedManipulators()||this.activeTool)&&(this._interacting=!0,this._startInteractingTimeout())}_refreshToolWatchers(){this.removeHandles(mt),this._forEachTool((e=>{if(e instanceof S.Z){const t=(0,_.YP)((()=>[e.cursor,e.visible,e.editable]),(()=>{rt(e)||this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs),this._updateCursor()}));this.addHandles(t,mt)}e.manipulators&&this.addHandles([e.manipulators.on("after-remove",(t=>{this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs,!0,t.item.manipulator)})),e.manipulators.on("change",(()=>{this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}))],mt)})),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}_updateToolEditableFlag(e){e.setEditableFlag?.(et.bH.MANAGER,null==this.activeTool||e===this.activeTool)}_updateCursor(){let e=this._manipulatorState.cursor;null==e&&this._forEachTool((t=>!(null==t.cursor||!t.visible||(e=t.cursor,0)))),this._get("cursor")!==e&&this._set("cursor",e)}_removeIncompleteTools(e){this.tools.filter((t=>(null==e||t!==e)&&!t.created&&t.removeIncompleteOnCancel)).forEach((e=>{this.tools.remove(e)}))}get test(){}};(0,r._)([(0,w.Cb)({constructOnly:!0,nonNullable:!0})],ft.prototype,"view",void 0),(0,r._)([(0,w.Cb)({value:null})],ft.prototype,"activeTool",null),(0,r._)([(0,w.Cb)({readOnly:!0,type:a.Z})],ft.prototype,"tools",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],ft.prototype,"cursor",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],ft.prototype,"updating",null),(0,r._)([(0,w.Cb)()],ft.prototype,"_interacting",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],ft.prototype,"interacting",null),ft=(0,r._)([(0,x.j)("esri.views.ToolViewManager")],ft);var _t,gt=i(43295);let yt=_t=class extends S.Z{constructor(e){super(e),this.name=gt.b,this.color=gt.SQ.clone(),this.haloColor=null,this.haloOpacity=gt.j2,this.fillOpacity=gt.Ac,this.shadowColor=gt.NU.clone(),this.shadowOpacity=gt.CN,this.shadowDifference=gt.oH,this.haloWidth=2.1,this.haloBlur=.8/this.haloWidth}equals(e){return this.color.equals(e.color)&&(this.haloColor||this.color).equals(e.haloColor||e.color)&&this.haloOpacity===e.haloOpacity&&this.fillOpacity===e.fillOpacity&&this.haloWidth===e.haloWidth&&this.haloBlur===e.haloBlur&&this.shadowColor.equals(e.shadowColor)&&this.shadowOpacity===e.shadowOpacity&&this.shadowDifference===e.shadowDifference}clone(){return new _t({...this,color:this.color.clone(),haloColor:this.haloColor?.clone(),shadowColor:this.shadowColor?.clone()})}assignFrom(e){this.color=e.color.clone(),this.haloColor=e.haloColor?.clone(),this.haloOpacity=e.haloOpacity,this.fillOpacity=e.fillOpacity,this.shadowColor=e.shadowColor.clone(),this.shadowDifference=e.shadowDifference,this.shadowOpacity=e.shadowOpacity,this.haloBlur=e.haloBlur,this.haloWidth=e.haloWidth}};(0,r._)([(0,w.Cb)({type:String,constructOnly:!0,nonNullable:!0})],yt.prototype,"name",void 0),(0,r._)([(0,w.Cb)({type:$e.Z,nonNullable:!0})],yt.prototype,"color",void 0),(0,r._)([(0,w.Cb)({type:$e.Z})],yt.prototype,"haloColor",void 0),(0,r._)([(0,w.Cb)({nonNullable:!0})],yt.prototype,"haloOpacity",void 0),(0,r._)([(0,w.Cb)({nonNullable:!0})],yt.prototype,"fillOpacity",void 0),(0,r._)([(0,w.Cb)({type:$e.Z,nonNullable:!0})],yt.prototype,"shadowColor",void 0),(0,r._)([(0,w.Cb)({nonNullable:!0})],yt.prototype,"shadowOpacity",void 0),(0,r._)([(0,w.Cb)({nonNullable:!0})],yt.prototype,"shadowDifference",void 0),(0,r._)([(0,w.Cb)({nonNullable:!0})],yt.prototype,"haloWidth",void 0),(0,r._)([(0,w.Cb)({nonNullable:!0})],yt.prototype,"haloBlur",void 0),yt=_t=(0,r._)([(0,x.j)("esri.views.support.HighlightOptions")],yt);const vt=yt;let bt=class extends S.Z{constructor(e){super(),this.nativeIndex=null,this._detectedDeviceType="unknown","standard"===e.mapping?this._detectedDeviceType="standard":Ct.test(e.id)?this._detectedDeviceType="spacemouse":this._detectedDeviceType="unknown",this.nativeIndex=e.index}get native(){const e=navigator.getGamepads?navigator.getGamepads():[];return null!=this.nativeIndex&&this.nativeIndex<e.length?e[this.nativeIndex]:null}get deviceType(){return this._detectedDeviceType}get axisThreshold(){return xt[this.deviceType]}};(0,r._)([(0,w.Cb)({nonNullable:!0,readOnly:!0})],bt.prototype,"nativeIndex",void 0),(0,r._)([(0,w.Cb)({type:String,readOnly:!0})],bt.prototype,"deviceType",null),(0,r._)([(0,w.Cb)({type:Number,readOnly:!0})],bt.prototype,"axisThreshold",null),bt=(0,r._)([(0,x.j)("esri.views.input.gamepad.GamepadInputDevice")],bt);const wt=bt,Ct=new RegExp("^(3dconnexion|space(mouse|navigator|pilot|explorer))","i"),xt={standard:.15,spacemouse:.025,unknown:0};let Tt=class extends S.Z{constructor(...e){super(...e),this.devices=new a.Z,this.enabledFocusMode="document"}};(0,r._)([(0,w.Cb)({type:a.Z.ofType(wt),readOnly:!0})],Tt.prototype,"devices",void 0),(0,r._)([(0,w.Cb)({type:["document","view","none"]})],Tt.prototype,"enabledFocusMode",void 0),Tt=(0,r._)([(0,x.j)("esri.views.input.gamepad.GamepadSettings")],Tt);const St=Tt;let Mt=class extends S.Z{constructor(){super(...arguments),this.gamepad=new St}};(0,r._)([(0,w.Cb)({readOnly:!0})],Mt.prototype,"gamepad",void 0),Mt=(0,r._)([(0,x.j)("esri.views.input.Input")],Mt);const Et=Mt;var Pt=i(12019),Rt=i(85168);const At=()=>(0,w.Cb)({type:["pan","rotate","zoom","none"],nonNullable:!0});let Ot=class extends S.Z{constructor(e){super(e),this.dragPrimary="pan",this.dragSecondary="rotate",this.dragTertiary="zoom",this.mouseWheel="zoom"}};(0,r._)([At()],Ot.prototype,"dragPrimary",void 0),(0,r._)([At()],Ot.prototype,"dragSecondary",void 0),(0,r._)([At()],Ot.prototype,"dragTertiary",void 0),(0,r._)([(0,w.Cb)({type:["zoom","none"],nonNullable:!0})],Ot.prototype,"mouseWheel",void 0),Ot=(0,r._)([(0,x.j)("esri.views.navigation.NavigationActionMap")],Ot);const Dt=Ot;let It=class extends S.Z{constructor(e){super(e),this.enabled=!0,this.device=null,this.mode="pan",this.tiltDirection="forward-down",this.velocityFactor=1}};(0,r._)([(0,w.Cb)({type:Boolean,nonNullable:!0})],It.prototype,"enabled",void 0),(0,r._)([(0,w.Cb)({type:wt})],It.prototype,"device",void 0),(0,r._)([(0,w.Cb)({type:["pan","zoom"],nonNullable:!0})],It.prototype,"mode",void 0),(0,r._)([(0,w.Cb)({type:["forward-down","forward-up"],nonNullable:!0})],It.prototype,"tiltDirection",void 0),(0,r._)([(0,w.Cb)({type:Number,nonNullable:!0})],It.prototype,"velocityFactor",void 0),It=(0,r._)([(0,x.j)("esri.views.navigation.gamepad.GamepadSettings")],It);const Lt=It;let Nt=class extends S.Z{constructor(e){super(e),this.actionMap=new Dt,this.browserTouchPanEnabled=!0,this.gamepad=new Lt,this.momentumEnabled=!0}get effectiveMomentumEnabled(){return this.momentumEnabled&&!(0,Pt.n)()}get mouseWheelZoomEnabled(){return"zoom"===this.actionMap.mouseWheel}set mouseWheelZoomEnabled(e){(0,Rt.Mr)(d.Z.getLogger(this),"mouseWheelZoomEnabled",{replacement:"actionMap.mouseWheel",version:"4.32",warnOnce:!0}),this.actionMap.mouseWheel=e?"zoom":"none"}};(0,r._)([(0,w.Cb)({type:Dt,nonNullable:!0})],Nt.prototype,"actionMap",void 0),(0,r._)([(0,w.Cb)({type:Boolean})],Nt.prototype,"browserTouchPanEnabled",void 0),(0,r._)([(0,w.Cb)({type:Lt,nonNullable:!0})],Nt.prototype,"gamepad",void 0),(0,r._)([(0,w.Cb)({type:Boolean})],Nt.prototype,"momentumEnabled",void 0),(0,r._)([(0,w.Cb)({type:Boolean})],Nt.prototype,"mouseWheelZoomEnabled",null),Nt=(0,r._)([(0,x.j)("esri.views.navigation.Navigation")],Nt);const Ft=Nt;var Ut=i(73584),Ht=i(56172),kt=i(92105);let Vt=class extends S.Z{constructor(e){super(e),this.required={extent:!1,heightModelInfo:!1,tileInfo:!1},this.defaultSpatialReference=null,this.userSpatialReference=null,this.sourcePreloadCount=10,this.priorityCollection=null,this.requiresExtentInSpatialReference=!0,this.suspended=!1,this._projectExtentTask={task:null,input:null,output:null,spatialReference:null}}destroy(){this._projectExtentTask.task&&(this._projectExtentTask.task=(0,p.IM)(this._projectExtentTask.task)),this._set("map",null)}get ready(){return!this._spatialReferenceTask.updating&&!this._tileInfoTask.updating&&!this._extentTask.updating}get heightModelInfoReady(){return!this._heightModelInfoTask.updating}get spatialReference(){return this.userSpatialReference??this._spatialReferenceTask.spatialReference}get extent(){return this._extentTask.extent}get heightModelInfo(){return this._heightModelInfoTask.heightModelInfo}get vcsWkid(){return this._heightModelInfoTask.vcsWkid}get latestVcsWkid(){return this._heightModelInfoTask.latestVcsWkid}get viewingMode(){return null==this.userSpatialReference||this.userSpatialReference.equals(this._spatialReferenceTask.spatialReference)?this._spatialReferenceTask.viewingMode:null}get tileInfo(){return this._tileInfoTask.tileInfo}get mapCollections(){const e=this.map?.(),t=[];return null!=this.priorityCollection&&t.push(this.priorityCollection),t.push({parent:e?.basemap,layers:e?.basemap?.baseLayers},{layers:e?.layers},{parent:e?.ground,layers:e?.ground?.layers},{parent:e?.basemap,layers:e?.basemap?.referenceLayers}),t}get _spatialReferenceTask(){if(this.suspended)return this._get("_spatialReferenceTask")??{updating:!1};let e;if(this._collectLayers(this.mapCollections,(t=>{const i=this._getSupportedSpatialReferences(t);if(i.length>0){const t=this._narrowDownSpatialReferenceCandidates(e,i);null!=t&&(e=t)}return 1===e?.length}))&&1!==e?.length)return{updating:!0};const t=this._pickSpatialReferenceCandidate(e);return{spatialReference:t?.spatialReference??null,viewingMode:t?.viewingMode??null,updating:!1}}get _tileInfoTask(){if(!this.required.tileInfo)return this._get("_tileInfoTask")??{updating:!1};const e=this.map?.(),t=this.spatialReference;if(!t)return{updating:this._spatialReferenceTask.updating};let i;const r=this._collectLayers([{parent:e?.basemap,layers:e?.basemap?.baseLayers},{layers:e?.layers}],(e=>!(!("tileInfo"in e)||!e.tileInfo?.spatialReference.equals(t)||(i=e,0))),(e=>"tileInfo"in e));return i?{tileInfo:i.tileInfo,updating:!1}:{updating:r}}get _heightModelInfoTask(){if(!this.required.heightModelInfo||this.suspended&&this._get("_heightModelInfoTask")?.heightModelInfo)return this._get("_heightModelInfoTask")??{updating:!1};let e={};const t=this._collectLayers(this.mapCollections,(t=>{const i=(0,Ut.Ku)(t);return!!i&&(e={heightModelInfo:i,vcsWkid:t.spatialReference?.vcsWkid,latestVcsWkid:t.spatialReference?.latestVcsWkid},!0)}),(e=>(0,Ut.qC)(e)));return{...e,updating:t}}get _extentCandidatesTask(){if(this.suspended||!this.required.extent)return this._get("_extentCandidatesTask")??{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const e=[],t=this._collectLayers(this.mapCollections,(t=>{const i="fullExtents"in t&&t.fullExtents||(null!=t.fullExtent?[t.fullExtent]:[]),r=this.requiresExtentInSpatialReference?null:i[0],n=i.find((e=>e.spatialReference.equals(this.spatialReference)))??r;if(n)return e.push({extent:n,layer:t}),!0;if(this._getSupportedSpatialReferences(t).length>0)for(const r of i)e.push({extent:r,layer:t});return!1}));return{candidates:e,updating:t}}get _extentTask(){const{candidates:e,updating:t}=this._extentCandidatesTask;if(t)return{updating:t};if(null==e||0===e.length)return{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const i=this._pickExtentCandidate(e),r=this.spatialReference;return i.extent.equals(this._projectExtentTask.input)&&r.equals(this._projectExtentTask.spatialReference)?{extent:this._projectExtentTask.output,updating:null!=this._projectExtentTask.task&&!this._projectExtentTask.task.finished}:(null!=this._projectExtentTask.task&&(this._projectExtentTask.task=(0,p.IM)(this._projectExtentTask.task)),this._projectExtentTask={input:i.extent.clone(),output:null,spatialReference:r.clone(),task:(0,me.vr)((async e=>{try{const t=await(0,kt.o)(i.extent,r,"portalItem"in i.layer?i.layer.portalItem:void 0,e);this._projectExtentTask={...this._projectExtentTask,task:null,output:t}}catch(t){if((0,f.Hc)(e))return;this._projectExtentTask={...this._projectExtentTask,task:null}}}))},{updating:!0})}_narrowDownSpatialReferenceCandidates(e,t){if(null==e)return t;const i=new Array;for(const r of e)for(const e of t){if(!r.spatialReference.equals(e.spatialReference))continue;const t=zt(r.viewingMode,e.viewingMode);if(!1!==t){i.push({spatialReference:r.spatialReference,viewingMode:t});break}}return i.length>0?i:null}_pickSpatialReferenceCandidate(e){const t=this.defaultSpatialReference;return null==e||e.length<1?t?{spatialReference:t,viewingMode:null}:null:(null!=t&&e.length>1&&e.some((({spatialReference:e})=>e.equals(t)))&&(e=e.filter((({spatialReference:e})=>e.equals(t)))),e.length>1&&e.some((({viewingMode:e})=>e!==Ht.JY.Local))&&(e=e.filter((({viewingMode:e})=>e!==Ht.JY.Local))),e[0])}_getSupportedSpatialReferences(e){const t="supportedSpatialReferences"in e&&e.supportedSpatialReferences||(e.spatialReference?[e.spatialReference]:[]);if(0===t.length)return[];const i=[];for(const r of t){const t=this.getSpatialReferenceSupport(r,e);if(null!=t){const e=t.constraints??[{spatialReference:r,viewingMode:null}];for(const{spatialReference:t,viewingMode:r}of e)this.requiresExtentInSpatialReference&&null!=this.userSpatialReference&&!t.equals(this.userSpatialReference)||i.push({spatialReference:t,viewingMode:r})}}return i}_pickExtentCandidate(e){const t=this.spatialReference;return e.find((({extent:e})=>t.equals(e.spatialReference)))||e[0]}_collectLayers(e,t,i=(()=>!0)){switch(this._loadMaybe(this.map?.())){case"loading":return!0;case"failed":return!1}const r=new Bt(i,t);for(const t of e)if(this._collectCollection(t,r),r.done||r.preloading===this.sourcePreloadCount)break;return r.updating}_collectCollection(e,t){if(e.layers){switch(this._loadMaybe(e.parent)){case"loading":return t.updating=!0,void++t.preloading;case"failed":return}for(const i of e.layers)if(t.layerFilter(i)){switch(this._loadMaybe(i)){case"failed":continue;case"loading":t.updating=!0,++t.preloading;break;case"loaded":if(t.updating||(t.done=t.pushLayer(i)),t.done||t.preloading===this.sourcePreloadCount)break;"layers"in i&&this._collectCollection({layers:i.layers},t)}if(t.done||t.preloading===this.sourcePreloadCount)break}}}_loadMaybe(e){return e&&"loadStatus"in e&&null!=e.loadStatus?"not-loaded"===e.loadStatus?(e.load().catch((e=>{(0,f.D_)(e)})),"loading"):e.loadStatus:"loaded"}};(0,r._)([(0,w.Cb)()],Vt.prototype,"required",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],Vt.prototype,"map",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],Vt.prototype,"getSpatialReferenceSupport",void 0),(0,r._)([(0,w.Cb)()],Vt.prototype,"defaultSpatialReference",void 0),(0,r._)([(0,w.Cb)()],Vt.prototype,"userSpatialReference",void 0),(0,r._)([(0,w.Cb)()],Vt.prototype,"sourcePreloadCount",void 0),(0,r._)([(0,w.Cb)()],Vt.prototype,"priorityCollection",void 0),(0,r._)([(0,w.Cb)()],Vt.prototype,"requiresExtentInSpatialReference",void 0),(0,r._)([(0,w.Cb)()],Vt.prototype,"suspended",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],Vt.prototype,"ready",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Vt.prototype,"heightModelInfoReady",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Vt.prototype,"spatialReference",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Vt.prototype,"extent",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Vt.prototype,"heightModelInfo",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Vt.prototype,"vcsWkid",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Vt.prototype,"latestVcsWkid",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Vt.prototype,"viewingMode",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Vt.prototype,"tileInfo",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Vt.prototype,"mapCollections",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Vt.prototype,"_spatialReferenceTask",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Vt.prototype,"_tileInfoTask",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Vt.prototype,"_heightModelInfoTask",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Vt.prototype,"_extentCandidatesTask",null),(0,r._)([(0,w.Cb)()],Vt.prototype,"_extentTask",null),(0,r._)([(0,w.Cb)()],Vt.prototype,"_projectExtentTask",void 0),Vt=(0,r._)([(0,x.j)("esri.views.support.DefaultsFromMap")],Vt);class Bt{constructor(e,t){this.layerFilter=e,this.pushLayer=t,this.preloading=-1,this.updating=!1,this.done=!1}}function zt(e,t){return null!=e?null!=t?e===t&&e:e:t}var Gt=i(57947),qt=i(76277),Zt=i(38209);class jt{constructor(e,t,i){this.layer=e,this.view=t,this.layerViewImporter=i,this._controller=new AbortController,this._deferred=(0,f.hh)(),this._started=!1,this.done=!1,this.promise=this._deferred.promise,(0,f.fu)(this._controller.signal,(()=>{this._recycleController?.abort();const t=new l.Z("cancelled:layerview-create","layerview creation cancelled",{layer:e});this._deferred.reject(t)}))}tryRecycle(e){if(!this.done||!this.layerView||!function(e){return"tryRecycleWith"in e}(this.layerView))return null;this._recycleController?.abort(),this._recycleController=new AbortController;const t=this.layer.type,i=this._recycleController.signal;for(let r=0;r<e.length;r++){const n=e[r];if(n.type!==t)continue;const s=this.layerView.tryRecycleWith(n,{signal:i});if(s){e.splice(r,1),this.layer=n;const t=this.layerView,a=t.view;return this.promise=s.then((()=>((0,f.k_)(i),n.emit("layerview-destroy",{view:a,layerView:t}),a.emit("layerview-destroy",{view:a,layerView:t}),n.emit("layerview-create",{view:a,layerView:t}),a.emit("layerview-create",{view:a,layerView:t}),t))),this.promise}}return null}destroy(){this._controller.abort();const{layerView:e}=this;if(e){const{layer:t,view:i}=this;t.emit("layerview-destroy",{view:i,layerView:e}),i.emit("layerview-destroy",{layer:t,layerView:e})}this.done=!0,this.layer=null,this.layerView=null,this.view=null,this.layerViewImporter=null,this._map=null}async start(){const{view:e}=this;if(this._started||!e.map)return;this._started=!0;const{_controller:{signal:t},layer:i}=this;this._map=e.map;try{let r,n;if(await i.load({signal:t}),i.prefetchResources&&await i.prefetchResources({signal:t}),function(e){return e.createLayerView!==Zt.Z.prototype.createLayerView}(i))r=await i.createLayerView(e,{signal:t});else{if(!this.layerViewImporter.hasLayerViewModule(i))throw new l.Z("layer:view-not-supported","No layerview implementation was found");const n=await this.layerViewImporter.importLayerView(i);(0,f.k_)(t),r="default"in n?new n.default({layer:i,view:e}):new n({layer:i,view:e})}const s=()=>{n=(0,p.hw)(n),r.destroyed||r.destroy(),r.layer=null,r.parent=null,r.view=null,this.done=!0};n=(0,f.fu)(t,s),(0,f.k_)(t);try{await r.when()}catch(e){throw s(),e}const a=this._map?.allLayers?.includes(i);if(!a)return s(),void this._deferred.reject(new l.Z("view:no-layerview-for-layer","The layer has been removed from the map",{layer:i}));this.layerView=r,i.emit("layerview-create",{view:e,layerView:r}),e.emit("layerview-create",{layer:i,layerView:r}),this.done=!0,this._deferred.resolve(r)}catch(t){i.emit("layerview-create-error",{view:e,error:t}),e.emit("layerview-create-error",{layer:i,error:t}),this.done=!0,this._deferred.reject(new l.Z("layerview:create-error","layerview creation failed",{layer:i,error:t}))}}}function Wt(e){return null!=e&&"object"==typeof e&&"layerViews"in e}let $t=class extends S.Z{constructor(e){super(e),this._layerLayerViewInfoMap=new Map,this._recyclingInfoMap=new Map,this._watchUpdatingTracking=new X.R,this.supportsGround=!0,this._preloadLayerViewModules=()=>{const e=this.view.map?.allLayers;if(e)for(const t of e)!1!==this.layerViewFilter?.(t)&&this.layerViewImporter.hasLayerViewModule(t)&&this.layerViewImporter.importLayerView(t)},this._reschedule=()=>this.destroyed?Promise.reject():(null==this._workPromise&&(this._workPromise=(0,f.hh)(),this._workPromise.promise.catch((()=>{}))),this.removeHandles("reschedule"),this.addHandles((0,g.Os)(this._doWork),"reschedule"),this._workPromise.promise),this._doWork=()=>{const e=this.view.map;if(this.destroyed||!e)return void this.clear();if(this._map!==e&&(this.clear(),this._map=e),null==this._workPromise)return void this.notifyChange("updating");this.removeHandles("reschedule"),this.removeHandles("collection-change");const t=new Set,i=[],r=this.view.ready,n=e=>{if(null!=e)for(const s of e)if(s){if(!1===this.layerViewFilter?.(s))continue;t.add(s);const e=this._layerLayerViewInfoMap.get(s);e&&r?e.start():e||this._recyclingInfoMap.has(s)||i.push(s),"layers"in s&&s.layers&&n(s.layers)}};for(const e of this._rootCollectionNames)n((0,Gt.U2)(this,e));const s=new Array,a=e=>{const t=e.tryRecycle(i);t?(this._recyclingInfoMap.set(e.layer,e),this.notifyChange("updating"),t.then((()=>{this._recyclingInfoMap.delete(e.layer),this._layerLayerViewInfoMap.set(e.layer,e),this._reschedule(),this.notifyChange("updating")})).catch((t=>{(0,f.D_)(t)||(this._recyclingInfoMap.delete(e.layer),e.destroy(),this._reschedule(),this.notifyChange("updating"))}))):s.push(e)};for(const e of this._layerLayerViewInfoMap.values())t.has(e.layer)||(this._layerLayerViewInfoMap.delete(e.layer),a(e));for(const e of this._recyclingInfoMap.values())t.has(e.layer)||(this._recyclingInfoMap.delete(e.layer),a(e));for(const e of i)this._createLayerView(e);this._refreshCollections(),s.forEach((e=>e.destroy()));const o=[e?.ground?.layers,e?.basemap?.baseLayers,e?.basemap?.referenceLayers,e?.layers].filter((e=>!!e));t.forEach((e=>"layers"in e&&o.push(e.layers))),this.addHandles(o.map((e=>this._watchUpdatingTracking.addOnCollectionChange((()=>e),this._reschedule))),"collection-change"),this._workPromise.resolve(),this._workPromise=null}}initialize(){this.addHandles([(0,_.on)((()=>this.view?.map?.allLayers),"change",this._preloadLayerViewModules,{onListenerAdd:this._preloadLayerViewModules}),(0,_.YP)((()=>{const e=this.view,t=e?.map;return[t?.basemap,t?.ground,t?.layers,e?.ready]}),(()=>this._reschedule()),_.tX)]),this._preloadLayerViewModules(),this._reschedule()}destroy(){this.clear(),(0,qt.O)(this._recyclingInfoMap),(0,qt.O)(this._layerLayerViewInfoMap),this._watchUpdatingTracking.destroy(),this._map=null,null!=this._workPromise&&(this._workPromise.reject((0,f.zE)()),this._workPromise=null)}get _layersToLayerViews(){const e=[["view.map.basemap.baseLayers","view.basemapView.baseLayerViews"],["view.map.layers","view.layerViews"],["view.map.basemap.referenceLayers","view.basemapView.referenceLayerViews"]];return this.supportsGround&&e.push(["view.map.ground.layers","view.groundView.layerViews"]),new Map(e)}get _rootCollectionNames(){return Array.from(this._layersToLayerViews.keys())}get updating(){return null!=this._workPromise||this._watchUpdatingTracking.updating||(0,Ue.oE)(this._layerLayerViewInfoMap,(e=>!e.done))||this._recyclingInfoMap.size>0}get updatingRemaining(){let e=0;for(const t of this._layerLayerViewInfoMap.values())t.done||++e;return e}clear(){this.destroyed||(this._clearCollections(),(0,qt.O)(this._layerLayerViewInfoMap))}async whenLayerView(e){if(await this._reschedule(),!this._layerLayerViewInfoMap.has(e)){if(this._recyclingInfoMap.has(e))return this._recyclingInfoMap.get(e).promise;throw new l.Z("view:no-layerview-for-layer","No layerview has been found for the layer",{layer:e})}return this._layerLayerViewInfoMap.get(e).promise}isCreatingLayerViewsForLayer(e,t){this.commitProperty("updatingRemaining");const i=this._layerLayerViewInfoMap.get(e);if(!i?.done)return!0;const r=i.layerView;return!(!r||!t||r.parent===t)||!!(i.done&&r&&"layers"in e&&e.layers?.length)&&e.layers.some((e=>this.isCreatingLayerViewsForLayer(e,r)))}_refreshCollections(){for(const[e,t]of this._layersToLayerViews)this._populateLayerViewsOwners((0,Gt.U2)(this,e),(0,Gt.U2)(this,t),this.view);this.notifyChange("updating"),this.notifyChange("updatingRemaining")}_clearCollections(){for(const e of this._layersToLayerViews.values())(0,Gt.U2)(this,e)?.removeAll()}_populateLayerViewsOwners(e,t,i){if(!e||!t)return void t?.removeAll();let r=0;for(const n of e){const e=this._layerLayerViewInfoMap.get(n);if(!e?.layerView)continue;const s=e.layerView;s.layer=n,s.parent=i,t.at(r)!==s&&t.splice(r,0,s),"layers"in n&&Wt(s)&&this._populateLayerViewsOwners(n.layers,s.layerViews,s),r+=1}r<t.length&&t.splice(r)}_createLayerView(e){e.load().catch((()=>{})),this.layerViewImporter.hasLayerViewModule(e)&&this.layerViewImporter.importLayerView(e);const t=new jt(e,this.view,this.layerViewImporter);t.promise.then((()=>this._refreshCollections()),(t=>{t&&((0,f.D_)(t)||"cancelled:layerview-create"===t.name)||d.Z.getLogger(this).error(`Failed to create layerview for layer title:'${e.title??"no title"}', id:'${e.id??"no id"}' of type '${e.type}'.`,{layer:e,error:t}),this._refreshCollections()})),this._layerLayerViewInfoMap.set(e,t),this.view.ready&&t.start(),this.notifyChange("updating"),this.notifyChange("updatingRemaining")}};(0,r._)([(0,w.Cb)()],$t.prototype,"_workPromise",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],$t.prototype,"_watchUpdatingTracking",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],$t.prototype,"_layersToLayerViews",null),(0,r._)([(0,w.Cb)({readOnly:!0})],$t.prototype,"_rootCollectionNames",null),(0,r._)([(0,w.Cb)({constructOnly:!0})],$t.prototype,"layerViewFilter",void 0),(0,r._)([(0,w.Cb)()],$t.prototype,"layerViewImporter",void 0),(0,r._)([(0,w.Cb)()],$t.prototype,"supportsGround",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],$t.prototype,"updating",null),(0,r._)([(0,w.Cb)({readOnly:!0})],$t.prototype,"updatingRemaining",null),(0,r._)([(0,w.Cb)({constructOnly:!0})],$t.prototype,"view",void 0),$t=(0,r._)([(0,x.j)("esri.views.support.LayerViewManager")],$t);const Xt=$t;let Yt=class extends S.Z{constructor(e){super(e),this.featureTitleFields=!1,this.utilityNetworkFields=!1,this.globalIdField=!1}};(0,r._)([(0,w.Cb)()],Yt.prototype,"featureTitleFields",void 0),(0,r._)([(0,w.Cb)()],Yt.prototype,"utilityNetworkFields",void 0),(0,r._)([(0,w.Cb)()],Yt.prototype,"globalIdField",void 0),Yt=(0,r._)([(0,x.j)("esri.views.support.RequiredFieldsOptions")],Yt);const Kt=Yt;var Qt;let Jt=class extends(ae.Z.EventedMixin(Me.Z.EsriPromiseMixin(S.Z))){static{Qt=this}constructor(e){super(e),this._userSpatialReference=null,this._cursor=null,this.handles=new Te.Z,this.updatingHandles=new X.R,this.allLayerViews=new Ce.Z({getCollections:()=>[this.basemapView?.baseLayerViews,this.groundView?.layerViews,this.layerViews,this.basemapView?.referenceLayerViews],getChildrenFunction:ii}),this.analyses=new z,this.basemapView=null,this.displayFilterEnabled=!0,this.fatalError=null,this.graphics=new Pe.J,this.groundView=null,this.typeSpecificPreconditionsReady=!0,this.layerViews=new a.Z,this.magnifier=new Ne,this.padding={left:0,top:0,right:0,bottom:0},this.ready=!1,this._readyStateWaitingTask=null,this.supportsGround=!0,this.type=null,this.scale=null,this.updating=!1,this.initialExtentRequired=!0,this.input=new Et,this.navigation=new Ft,this.layerViewManager=null,this.analysisViewManager=null,this.isHeightModelInfoRequired=!1,this.width=null,this.height=null,this.resizing=!1,this.suspended=!1,this.viewEvents=new Je.CE(this),this.persistableViewModels=new a.Z,this.requiredFieldsOptions=new Kt,this._isValid=!1,this._readyCycleForced=!1,this._lockedSpatialReference=null,this._userTimeZone=null,this._lockedTimeZone=null,this._userTimeExtent=null,this._lockedTimeExtent=null,this.theme=null,this.handles.add((0,_.YP)((()=>this.preconditionsReady),(e=>{const t=this.ready;if(e?(this._lockedSpatialReference=this.spatialReference,this._lockedTimeZone=this.timeZone,this._lockedTimeExtent=this.timeExtent,Qt.views.add(this)):(this._lockedSpatialReference=null,Qt.views.remove(this)),this.notifyChange("spatialReference"),!e&&t)this.toolViewManager?.detach(),null!=this.analysisViewManager&&this.analysisViewManager.detach(),this.layerViewManager?.clear(),this._teardown();else if(e&&!t){try{this._startup()}catch(e){return void queueMicrotask((()=>{this.fatalError=new l.Z("view:startup-error","View._startup failed",e)}))}null!=this.analysisViewManager&&this.analysisViewManager.attach(),this.toolViewManager.attach()}}),_.Z_))}initialize(){this.addResolvingPromise(Promise.all([this.loadAsyncDependencies(),this.validate()]).then((()=>(this._isValid=!0,(0,_.N1)((()=>this.ready)))))),this.basemapView=new Ie({view:this}),this.layerViewManager=new Xt({view:this,layerViewFilter:e=>this.layerViewFilter?.(e)??!0,layerViewImporter:{importLayerView:e=>this.importLayerView(e),hasLayerViewModule:e=>this.hasLayerViewModule(e)},supportsGround:this.supportsGround}),this.toolViewManager=new ft({view:this}),this.selectionManager=new We({view:this}),this.addHandles([(0,_.gx)((()=>"map-content-error"===this.readyState&&!this.spatialReference),(()=>{d.Z.getLogger(this).warn("#spatialReference","no spatial reference could be derived from the currently added map layers")})),(0,_.YP)((()=>this.initialExtentRequired),(e=>this.defaultsFromMap.required={...this.defaultsFromMap.required,extent:e}),_.tX),(0,_.YP)((()=>this.ready),(e=>{this.defaultsFromMap&&(this.defaultsFromMap.suspended=e,this.defaultsFromMap.userSpatialReference=e?this.spatialReference:this._userSpatialReference)}),_.Z_),(0,_.YP)((()=>this._userSpatialReference),(e=>{this.defaultsFromMap&&(this.defaultsFromMap.userSpatialReference=e)}),_.tX)])}destroy(){this.destroyed||(Qt.views.remove(this),this.viewEvents.destroy(),this.allLayerViews.destroy(),this.navigation&&(this.navigation.destroy(),this._set("navigation",null)),this.graphics=(0,p.SC)(this.graphics),this.analyses=(0,p.SC)(this.analyses),this.defaultsFromMap.destroy(),this._set("defaultsFromMap",null),(0,p.SC)(this.analysisViewManager),this.toolViewManager=(0,p.SC)(this.toolViewManager),this.layerViewManager=(0,p.SC)(this.layerViewManager),this.selectionManager=(0,p.SC)(this.selectionManager),this.basemapView=(0,p.SC)(this.basemapView),this.groundView?.destroy(),this.layerViews?.forEach((e=>e.destroy())),this.layerViews.length=0,this.invalidate(),this._emitter.clear(),this.handles.destroy(),this.map=(0,p.SC)(this.map),this.updatingHandles.destroy())}_startup(){this._set("ready",!0)}_teardown(){this._set("ready",!1)}whenReady(){return Promise.resolve(this)}toMap(){return d.Z.getLogger(this).error("#toMap()","Not implemented on this instance of View"),null}get activeTool(){return this.toolViewManager?.activeTool}set activeTool(e){this.toolViewManager&&(this.toolViewManager.activeTool=e)}get animation(){return this._get("animation")}set animation(e){this._set("animation",e)}get center(){return null}get defaultsFromMapSettings(){return{}}get defaultsFromMap(){return new Vt({required:{tileInfo:!1,heightModelInfo:!1,extent:!1},map:()=>this.map,getSpatialReferenceSupport:(e,t)=>this.getSpatialReferenceSupport(e,t),...this.defaultsFromMapSettings})}get extent(){return this._get("extent")}set extent(e){this._set("extent",e)}get heightModelInfo(){return this.getDefaultHeightModelInfo()}get highlights(){return this._get("highlights")??new(a.Z.ofType(vt))([new vt({name:gt.b}),new vt({name:gt.x,color:gt.hG})])}set highlights(e){this._set("highlights",(0,xe.Z)(e,this._get("highlights"),a.Z.ofType(vt)))}get interacting(){return this.navigating}get navigating(){return!1}get preconditionsReady(){return!this.destroying&&!this.destroyed&&!(this.fatalError||!this._isValid||this._readyCycleForced||!this.map||Se.Z.isLoadable(this.map)&&!this.map.loaded||0===this.width||0===this.height||!this.spatialReference||!this._validateSpatialReference(this.spatialReference)||!this._lockedSpatialReference&&!this.defaultsFromMap?.ready||!this.typeSpecificPreconditionsReady)}get resolution(){return 0}set map(e){e!==this._get("map")&&(e?.destroyed&&(d.Z.getLogger(this).warn("#map","The provided map is already destroyed",{map:e}),e=null),Se.Z.isLoadable(e)&&e.load().catch((()=>{})),this.constructed&&!this.destroyed&&(this.forceReadyCycle(),this._lockedSpatialReference=null),this._set("map",e))}get readyState(){if(this.destroyed)return this._get("readyState");if(!this.map)return"missing-map";if("container"in this&&!this.container)return"missing-container";if(this.fatalError)return"rendering-error";if(this.defaultsFromMap?.ready&&!this.spatialReference){const e=!("loaded"in this.map)||this.map.loaded,t=this.map.ground.loaded,i=this.map.basemap?.loaded??!0;return e&&i&&t&&!this.map?.allLayers.length?"empty-map":(this._readyStateWaitingTask||(this._readyStateWaitingTask=(0,me.vr)((e=>(0,f.e4)((0,u.Z)("view-readyState-waiting-delay"),null,e))),this.addHandles(this._readyStateWaitingTask),this.addHandles(this._readyStateWaitingTask,"ready-state-task")),this._readyStateWaitingTask?.finished?"map-content-error":"loading")}return this._readyStateWaitingTask=(0,p.IM)(this._readyStateWaitingTask),this.removeHandles("ready-state-task"),this.ready?"ready":"loading"}get spatialReference(){const e=this._userSpatialReference||this._lockedSpatialReference||this.getDefaultSpatialReference()||null;if(e&&this.defaultsFromMap?.required?.heightModelInfo){const t=e.clone();return t.vcsWkid=this.defaultsFromMap.vcsWkid,t.latestVcsWkid=this.defaultsFromMap.latestVcsWkid,t}return e}set spatialReference(e){const t=!(0,Ee.fS)(e,this._get("spatialReference"));this._set("_userSpatialReference",e),t&&(this._set("spatialReference",e),this._spatialReferenceChanged(e))}_spatialReferenceChanged(e){}get stationary(){return!this.animation&&!this.navigating&&!this.resizing}get timeExtent(){return this._userTimeExtent??this._lockedTimeExtent??this.getDefaultTimeExtent()??null}set timeExtent(e){this._userTimeExtent=e}get timeZone(){return this._userTimeZone??this._lockedTimeZone??this.getDefaultTimeZone()??Re.By}set timeZone(e){this._userTimeZone=e,(0,Oe.Do)(e)||d.Z.getLogger(this).warn("#timeZone",`the parsed value '${e}' may not be a valid IANA time zone`)}get tools(){return this.toolViewManager?.tools}get initialExtent(){return this.defaultsFromMap?.extent}get cursor(){return this.toolViewManager?.cursor??this._cursor??"default"}set cursor(e){this._cursor=e,this.notifyChange("cursor")}get size(){return[this.width,this.height]}get effectiveTheme(){return this.theme??new Ke}whenLayerView(e){return this.layerViewManager?.whenLayerView(e)??Promise.reject()}getDefaultSpatialReference(){return this.defaultsFromMap?.spatialReference}getDefaultHeightModelInfo(){return(this.map&&"heightModelInfo"in this.map?this.map.heightModelInfo:void 0)??this.defaultsFromMap?.heightModelInfo??null}getDefaultTimeZone(){return null}getDefaultTimeExtent(){return null}importLayerView(e){throw new l.Z("view:importLayerView-missing","importLayerView() not implemented")}hasLayerViewModule(e){return!1}async validate(){}async loadAsyncDependencies(){}invalidate(){this._isValid=!1}getSpatialReferenceSupport(){return{constraints:null}}_validateSpatialReference(e){return null!=this.getSpatialReferenceSupport(e)}when(e,t){return this.isResolved()&&!this.ready&&d.Z.getLogger(this).warn("#when()","Calling view.when() while the view is no longer ready but was already resolved once will resolve immediately. Use reactiveUtils.whenOnce(() => view.ready).then(...) instead."),super.when(e,t)}forceReadyCycle(){this.ready&&((0,_.gx)((()=>this.destroyed||!1===this.preconditionsReady),(()=>this._readyCycleForced=!1),{once:!0}),this._readyCycleForced=!0)}addAndActivateTool(e){this.toolViewManager.tools.add(e),this.activeTool=e}tryFatalErrorRecovery(){this.fatalError=null}static{this.views=new a.Z}};(0,r._)([(0,w.Cb)()],Jt.prototype,"_userSpatialReference",void 0),(0,r._)([(0,w.Cb)()],Jt.prototype,"activeTool",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Jt.prototype,"allLayerViews",void 0),(0,r._)([(0,w.Cb)((0,A.z)(z,"analyses"))],Jt.prototype,"analyses",void 0),(0,r._)([(0,w.Cb)()],Jt.prototype,"animation",null),(0,r._)([(0,w.Cb)()],Jt.prototype,"basemapView",void 0),(0,r._)([(0,w.Cb)()],Jt.prototype,"center",null),(0,r._)([(0,w.Cb)()],Jt.prototype,"defaultsFromMapSettings",null),(0,r._)([(0,w.Cb)()],Jt.prototype,"defaultsFromMap",null),(0,r._)([(0,w.Cb)()],Jt.prototype,"displayFilterEnabled",void 0),(0,r._)([(0,w.Cb)({type:O.Z})],Jt.prototype,"extent",null),(0,r._)([(0,w.Cb)()],Jt.prototype,"fatalError",void 0),(0,r._)([(0,w.Cb)((0,A.z)(Pe.J,"graphics"))],Jt.prototype,"graphics",void 0),(0,r._)([(0,w.Cb)()],Jt.prototype,"groundView",void 0),(0,r._)([(0,w.Cb)({readOnly:!0,type:D.Z})],Jt.prototype,"heightModelInfo",null),(0,r._)([(0,w.Cb)({type:a.Z.ofType(vt)})],Jt.prototype,"highlights",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Jt.prototype,"interacting",null),(0,r._)([(0,w.Cb)({constructOnly:!0})],Jt.prototype,"layerViewFilter",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],Jt.prototype,"navigating",null),(0,r._)([(0,w.Cb)({readOnly:!0,dependsOn:["fatalError","_isValid","_readyCycleForced","map","map.loaded?","width","height","spatialReference","_lockedSpatialReference","defaultsFromMap.ready","typeSpecificPreconditionsReady"]})],Jt.prototype,"preconditionsReady",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Jt.prototype,"typeSpecificPreconditionsReady",void 0),(0,r._)([(0,w.Cb)({type:a.Z,readOnly:!0})],Jt.prototype,"layerViews",void 0),(0,r._)([(0,w.Cb)()],Jt.prototype,"resolution",null),(0,r._)([(0,w.Cb)({type:Ne})],Jt.prototype,"magnifier",void 0),(0,r._)([(0,w.Cb)({value:null,type:we.Z})],Jt.prototype,"map",null),(0,r._)([(0,w.Cb)()],Jt.prototype,"padding",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],Jt.prototype,"ready",void 0),(0,r._)([(0,w.Cb)()],Jt.prototype,"_readyStateWaitingTask",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],Jt.prototype,"readyState",null),(0,r._)([(0,w.Cb)({type:N.Z})],Jt.prototype,"spatialReference",null),(0,r._)([(0,w.Cb)()],Jt.prototype,"stationary",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Jt.prototype,"supportsGround",void 0),(0,r._)([(0,w.Cb)({type:Ae.T})],Jt.prototype,"timeExtent",null),(0,r._)([(0,w.Cb)({type:String,nonNullable:!0})],Jt.prototype,"timeZone",null),(0,r._)([(0,w.Cb)()],Jt.prototype,"tools",null),(0,r._)([(0,w.Cb)()],Jt.prototype,"toolViewManager",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],Jt.prototype,"type",void 0),(0,r._)([(0,w.Cb)({type:Number})],Jt.prototype,"scale",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],Jt.prototype,"updating",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],Jt.prototype,"initialExtentRequired",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],Jt.prototype,"initialExtent",null),(0,r._)([(0,w.Cb)()],Jt.prototype,"cursor",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Jt.prototype,"input",void 0),(0,r._)([(0,w.Cb)({type:Ft,nonNullable:!0})],Jt.prototype,"navigation",void 0),(0,r._)([(0,w.Cb)()],Jt.prototype,"layerViewManager",void 0),(0,r._)([(0,w.Cb)()],Jt.prototype,"analysisViewManager",void 0),(0,r._)([(0,w.Cb)()],Jt.prototype,"selectionManager",void 0),(0,r._)([(0,w.Cb)()],Jt.prototype,"width",void 0),(0,r._)([(0,w.Cb)()],Jt.prototype,"height",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],Jt.prototype,"resizing",void 0),(0,r._)([(0,w.Cb)({value:null,readOnly:!0})],Jt.prototype,"size",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Jt.prototype,"suspended",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],Jt.prototype,"viewEvents",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],Jt.prototype,"persistableViewModels",void 0),(0,r._)([(0,w.Cb)()],Jt.prototype,"_isValid",void 0),(0,r._)([(0,w.Cb)()],Jt.prototype,"_readyCycleForced",void 0),(0,r._)([(0,w.Cb)()],Jt.prototype,"_lockedSpatialReference",void 0),(0,r._)([(0,w.Cb)()],Jt.prototype,"_userTimeZone",void 0),(0,r._)([(0,w.Cb)()],Jt.prototype,"_lockedTimeZone",void 0),(0,r._)([(0,w.Cb)()],Jt.prototype,"_userTimeExtent",void 0),(0,r._)([(0,w.Cb)()],Jt.prototype,"_lockedTimeExtent",void 0),(0,r._)([(0,w.Cb)({type:Ke})],Jt.prototype,"theme",void 0),(0,r._)([(0,w.Cb)({readOnly:!0,type:Ke})],Jt.prototype,"effectiveTheme",null),Jt=Qt=(0,r._)([(0,x.j)("esri.views.View")],Jt);const ei=globalThis.$arcgis;ei&&!ei.views&&Object.defineProperty(ei,"views",{configurable:!1,enumerable:!0,writable:!1,value:Jt.views});const ti=Jt;function ii(e){return e.layerViews}let ri=class extends Me.Z{constructor(e){super(e),this.state="running",this.target=null,this._resolver=null}initialize(){this._resolver=(0,f.hh)(),this.addResolvingPromise(this._resolver.promise)}get done(){return"finished"===this.state||"stopped"===this.state}stop(){"stopped"!==this.state&&"finished"!==this.state&&(this._set("state","stopped"),this._resolver?.reject(new l.Z("view:animation-stopped","ViewAnimation stopped")))}finish(){"stopped"!==this.state&&"finished"!==this.state&&(this._set("state","finished"),this._resolver?.resolve())}update(e,t){t||(t=(0,f.y8)(e)?"waiting-for-target":"running"),this._set("target",e),this._set("state",t)}};(0,r._)([(0,w.Cb)({readOnly:!0})],ri.prototype,"done",null),(0,r._)([(0,w.Cb)({readOnly:!0,type:String})],ri.prototype,"state",void 0),(0,r._)([(0,w.Cb)()],ri.prototype,"target",void 0),ri=(0,r._)([(0,x.j)("esri.views.ViewAnimation")],ri),function(e){e.State={RUNNING:"running",STOPPED:"stopped",FINISHED:"finished",WAITING_FOR_TARGET:"waiting-for-target"}}(ri||(ri={}));const ni=ri,si=()=>Promise.all([i.e(50624),i.e(96317)]).then(i.bind(i,96317)),ai=()=>i.e(27785).then(i.bind(i,27785)),oi={"base-dynamic":()=>Promise.all([i.e(85360),i.e(41643)]).then(i.bind(i,41643)),"base-elevation":ai,"base-tile":si,"bing-maps":si,"building-scene":()=>Promise.all([i.e(38586),i.e(55105),i.e(88792),i.e(60541),i.e(98733),i.e(50718),i.e(96526),i.e(17600),i.e(40993),i.e(79383),i.e(49405),i.e(59876),i.e(88534),i.e(52695),i.e(18179),i.e(20538),i.e(61197),i.e(47963),i.e(34267),i.e(36636)]).then(i.bind(i,14424)),catalog:()=>i.e(88366).then(i.bind(i,88366)),"catalog-dynamic-group":()=>i.e(23485).then(i.bind(i,23485)),"catalog-footprint":()=>Promise.all([i.e(55105),i.e(88792),i.e(50718),i.e(17600),i.e(79383),i.e(88534),i.e(44905),i.e(87022),i.e(26078),i.e(16435),i.e(68433),i.e(84580)]).then(i.bind(i,84580)),csv:()=>Promise.all([i.e(55105),i.e(88792),i.e(50718),i.e(17600),i.e(79383),i.e(88534),i.e(44905),i.e(87022),i.e(26078),i.e(16435),i.e(68433),i.e(4765)]).then(i.bind(i,4765)),dimension:()=>i.e(76284).then(i.bind(i,76284)),elevation:ai,feature:()=>Promise.all([i.e(55105),i.e(88792),i.e(50718),i.e(17600),i.e(79383),i.e(88534),i.e(44905),i.e(87022),i.e(26078),i.e(16435),i.e(68433),i.e(34071)]).then(i.bind(i,34071)),geojson:()=>Promise.all([i.e(55105),i.e(88792),i.e(50718),i.e(17600),i.e(79383),i.e(88534),i.e(44905),i.e(87022),i.e(26078),i.e(16435),i.e(68433),i.e(44908)]).then(i.bind(i,44908)),graphics:()=>Promise.all([i.e(55105),i.e(88534),i.e(44905),i.e(64815)]).then(i.bind(i,39088)),group:()=>i.e(14919).then(i.bind(i,14919)),imagery:()=>Promise.all([i.e(10215),i.e(85360),i.e(38394),i.e(75357)]).then(i.bind(i,75357)),"integrated-mesh":()=>Promise.all([i.e(55105),i.e(88534),i.e(52695),i.e(20538),i.e(61197),i.e(24804)]).then(i.bind(i,73051)),"integrated-mesh-3dtiles":()=>i.e(86309).then(i.bind(i,86309)),"line-of-sight":()=>i.e(37826).then(i.bind(i,37826)),"map-image":()=>Promise.all([i.e(85360),i.e(50624),i.e(64467)]).then(i.bind(i,64467)),media:()=>Promise.all([i.e(18208),i.e(23177),i.e(52616)]).then(i.bind(i,15705)),"ogc-feature":()=>Promise.all([i.e(55105),i.e(88792),i.e(50718),i.e(17600),i.e(79383),i.e(88534),i.e(44905),i.e(87022),i.e(26078),i.e(16435),i.e(68433),i.e(47714)]).then(i.bind(i,47714)),"open-street-map":si,"oriented-imagery":()=>Promise.all([i.e(55105),i.e(88792),i.e(50718),i.e(17600),i.e(79383),i.e(88534),i.e(44905),i.e(87022),i.e(26078),i.e(16435),i.e(68433),i.e(34071)]).then(i.bind(i,34071)),"point-cloud":()=>Promise.all([i.e(50718),i.e(17600),i.e(79383),i.e(52695),i.e(16786),i.e(59321)]).then(i.bind(i,59321)),viewshed:()=>i.e(37914).then(i.bind(i,37914)),voxel:()=>i.e(5797).then(i.bind(i,5797)),route:()=>Promise.all([i.e(55105),i.e(88534),i.e(80479),i.e(62569)]).then(i.bind(i,91775)),scene:e=>null==e.profile||"mesh-pyramids"===e.profile?Promise.all([i.e(55105),i.e(50718),i.e(17600),i.e(79383),i.e(88534),i.e(52695),i.e(20538),i.e(61197),i.e(91147),i.e(34267),i.e(29834)]).then(i.bind(i,29834)):Promise.all([i.e(55105),i.e(50718),i.e(17600),i.e(79383),i.e(88534),i.e(52695),i.e(26078),i.e(20538),i.e(91147),i.e(31048)]).then(i.bind(i,8378)),stream:()=>Promise.all([i.e(55105),i.e(88792),i.e(50718),i.e(17600),i.e(79383),i.e(88534),i.e(44905),i.e(26078),i.e(16435),i.e(77145),i.e(42810)]).then(i.bind(i,67494)),tile:si,"imagery-tile":()=>Promise.all([i.e(10215),i.e(38394),i.e(37148)]).then(i.bind(i,71655)),"vector-tile":()=>Promise.all([i.e(89693),i.e(7555)]).then(i.bind(i,7555)),wcs:()=>Promise.all([i.e(10215),i.e(38394),i.e(37148)]).then(i.bind(i,71655)),"web-tile":si,wfs:()=>Promise.all([i.e(55105),i.e(88792),i.e(50718),i.e(17600),i.e(79383),i.e(88534),i.e(44905),i.e(87022),i.e(26078),i.e(16435),i.e(68433),i.e(97619)]).then(i.bind(i,97619)),wms:()=>Promise.all([i.e(85360),i.e(63987)]).then(i.bind(i,63987)),wmts:()=>i.e(13954).then(i.bind(i,13954)),parquet:null,"geo-rss":null,kml:null,"knowledge-graph":null,"link-chart":null,"knowledge-graph-sublayer":null,"map-notes":null,"subtype-group":null,unknown:null,unsupported:null,video:null};const li=e=>null!=oi[e.type],ci=e=>{const t=oi[e.type];if(null==t)throw function(e){const t=e.declaredClass?e.declaredClass.slice(e.declaredClass.lastIndexOf(".")+1):"Unknown",i=t.replaceAll(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new l.Z(`${i}:view-not-supported`,`${t} is not supported in 3D`)}(e);return t(e)},hi="analyses-owner-handles";var ui,di;!function(e){e[e.PENDING=0]="PENDING",e[e.CREATED=1]="CREATED"}(ui||(ui={})),function(e){e[e.ADDED=0]="ADDED",e[e.REMOVED=1]="REMOVED"}(di||(di={}));let pi=class extends S.Z{constructor(e){super(e),this._allAnalysisViews=new a.Z,this._creatingViewCount=0,this._items=new Map,this._scheduledUpdateHandle=null,this._attachedToViewResolver=mi(),this._analysisModules={"area-measurement":{module:null},dimension:{module:null},"direct-line-measurement":{module:null},"line-of-sight":{module:null},slice:{module:null},viewshed:{module:null}},this._emitOnView=(e,t)=>this.view.emit(e,t)}destroy(){this._disconnectOwners(),this._attachedToViewResolver.reject((0,f.zE)("AnalysisViewManager was destroyed"))}attach(){this._connectOwners(),this._attachedToViewResolver.resolve()}detach(){this._disconnectOwners(),this._attachedToViewResolver.reject((0,f.zE)()),this._attachedToViewResolver=mi()}get updating(){return!this.view.ready||0!==this._creatingViewCount||this._allAnalysisViews.some((e=>e.updating))}get testInfo(){}async whenAnalysisView(e){await this._attachedToViewResolver.promise;const t=this._items.get(e);if(null==t||t.state.list===di.REMOVED)throw new l.Z("AnalysisViewManager:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});return t.createAnalysisViewTask.promise}_connectOwners(){this.addHandles(this._connectAnalysesCollection(this.view.analyses),hi)}_disconnectOwners(){this.removeHandles(hi),this._update(),this._creatingViewCount=0}_connectAnalysesCollection(e){for(const t of e)this._addAnalysis(t);const t=e.on("after-add",(e=>this._addAnalysis(e.item))),i=e.on("after-remove",(e=>this._removeAnalysis(e.item)));return(0,h.kB)((()=>{t.remove(),i.remove();for(const t of e)this._removeAnalysis(t)}))}_addAnalysis(e){const t=this._items.get(e);if(null==t){const t={state:{view:ui.PENDING,list:di.ADDED},analysis:e,view:null,createAnalysisViewTask:null};this._items.set(e,t),t.createAnalysisViewTask=(0,me.vr)((i=>this._createAnalysisViewPromise(t,i).then((t=>(this._emitOnView("analysis-view-create",{analysis:e,analysisView:t}),t)),(t=>{throw this._emitOnView("analysis-view-create-error",{analysis:e,error:t}),t}))))}else t.state.list=di.ADDED}_removeAnalysis(e){const t=this._items.get(e);null!=t?(t.state.list=di.REMOVED,this._scheduleUpdate()):d.Z.getLogger(this).error("Trying to remove analysis which was not added")}_scheduleUpdate(){null==this._scheduledUpdateHandle&&(this._scheduledUpdateHandle=(0,g.Os)((()=>this._update())))}_update(){this._scheduledUpdateHandle=(0,p.hw)(this._scheduledUpdateHandle),this._items.forEach((e=>{if(e.state.list!==di.REMOVED)return;const{analysis:t,view:i}=e;switch(this._items.delete(t),e.state.view){case ui.PENDING:e.createAnalysisViewTask=(0,p.IM)(e.createAnalysisViewTask);break;case ui.CREATED:null!=i&&(this._allAnalysisViews.remove(i),e.view=(0,p.SC)(i),e.createAnalysisViewTask=null,this._emitOnView("analysis-view-destroy",{analysis:t,analysisView:i}))}}))}async _createAnalysisViewPromise(e,t){const i=e.analysis,r=i.type,n=this._analysisModules[r];if(this._creatingViewCount+=1,null==n.module)try{n.module=await this._loadAnalysisModule(r)}catch(e){throw this._creatingViewCount-=1,e}if((0,f.Hc)(t))throw this._creatingViewCount-=1,(0,f.zE)("AnalysisView creation aborted");const s=new n.module.default({analysis:i,view:this.view});let a=!0;(0,f.fu)(t,(()=>{a&&this._destroyAnalysisView(i,s)}));try{await s.when()}catch(e){throw a=!1,this._destroyAnalysisView(i,s),e}if((0,f.Hc)(t))throw(0,f.zE)();return a=!1,e.view=s,e.state.view=ui.CREATED,this._allAnalysisViews.add(s),this._creatingViewCount-=1,s}_destroyAnalysisView(e,t){t.destroyed||(this._creatingViewCount-=1,t.destroy(),this._emitOnView("analysis-view-destroy",{analysis:e,analysisView:t}))}_loadAnalysisModule(e){switch(e){case"area-measurement":return Promise.all([i.e(18208),i.e(92273),i.e(43825),i.e(23177),i.e(8801),i.e(31798),i.e(28342)]).then(i.bind(i,28342));case"dimension":return Promise.all([i.e(18208),i.e(92273),i.e(43825),i.e(23177),i.e(8801),i.e(31798),i.e(78740),i.e(68597)]).then(i.bind(i,68597));case"direct-line-measurement":return Promise.all([i.e(18208),i.e(92273),i.e(43825),i.e(23177),i.e(8801),i.e(31798),i.e(88040)]).then(i.bind(i,88040));case"line-of-sight":return Promise.all([i.e(18208),i.e(92273),i.e(43825),i.e(73726)]).then(i.bind(i,34794));case"slice":return Promise.all([i.e(38586),i.e(55105),i.e(88792),i.e(60541),i.e(98733),i.e(96526),i.e(40993),i.e(49405),i.e(59876),i.e(18208),i.e(52695),i.e(43825),i.e(18179),i.e(47963),i.e(92889),i.e(25505)]).then(i.bind(i,59362));case"viewshed":return Promise.all([i.e(18208),i.e(92273),i.e(43825),i.e(37727),i.e(56080)]).then(i.bind(i,44976))}}};function mi(){const e=(0,f.hh)();return e.promise.catch((()=>{})),e}(0,r._)([(0,w.Cb)()],pi.prototype,"updating",null),(0,r._)([(0,w.Cb)({constructOnly:!0})],pi.prototype,"view",void 0),(0,r._)([(0,w.Cb)()],pi.prototype,"_allAnalysisViews",void 0),(0,r._)([(0,w.Cb)()],pi.prototype,"_creatingViewCount",void 0),pi=(0,r._)([(0,x.j)("esri.views.3d.analysis.AnalysisViewManager3D")],pi);const fi=pi;var _i=i(21414),gi=i(22365);let yi=class extends S.Z{constructor(e){super(e),this.collision=new Ci,this.distance=1/0,this.minimumPoiDistance=4,this.tilt=null}get altitude(){return this.mode===Ht.JY.Local?null:this._get("altitude")||null}set altitude(e){this.mode!==Ht.JY.Local?this._set("altitude",e):d.Z.getLogger(this).warn("Altitude constraint is ignored in local scenes")}get mode(){return this.state.viewingMode}clampAltitude(e){return this.altitude?(0,st.uZ)(e,this.altitude.min,this.altitude.max):e}clampTilt(e,t){if(!this.tilt)return t;const i=this.tilt(e);return(0,st.uZ)(t,i.min,i.max)}clampDistance(e){return Math.min(e,this.distance)}createDefaultTilt(){return this.mode===Ht.JY.Local?this._createDefaultTiltLocal():this._createDefaultTiltGlobal()}createConstantMaxTilt(e){return(t,i=wi)=>(i.min=bi.min,i.max=e,i)}_createDefaultTiltLocal(){const e=this.collision.enabled?(0,gi.uV)([[4e3,bi.max],[1e4,(0,st.Vl)(88)],[6e6,(0,st.Vl)(88)]]):()=>bi.max;return(t,i=wi)=>(i.min=bi.min,i.max=e(t),i)}_createDefaultTiltGlobal(){const e=this.collision.enabled?(0,gi.uV)([[4e3,bi.max],[5e4,(0,st.Vl)(88)],[6e6,(0,st.Vl)(88)],[2e7,bi.min]]):(0,gi.uV)([[3e5,bi.max],[3e6,(0,st.Vl)(88)],[6e6,(0,st.Vl)(88)],[2e7,bi.min]]);return(t,i=wi)=>(i.min=bi.min,i.max=e(t),i)}};(0,r._)([(0,w.Cb)()],yi.prototype,"altitude",null),(0,r._)([(0,w.Cb)({readOnly:!0})],yi.prototype,"collision",void 0),(0,r._)([(0,w.Cb)()],yi.prototype,"distance",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],yi.prototype,"minimumPoiDistance",void 0),(0,r._)([(0,w.Cb)()],yi.prototype,"tilt",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],yi.prototype,"state",void 0),yi=(0,r._)([(0,x.j)("esri.views.3d.state.Constraints")],yi);const vi=function(e){return{min:-2e5,max:4*e.radius}}(_i.sv),bi={min:(0,st.Vl)(.5),max:(0,st.Vl)(179.5)},wi={min:0,max:0};let Ci=class extends S.Z{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};(0,r._)([(0,w.Cb)({type:Boolean})],Ci.prototype,"enabled",void 0),(0,r._)([(0,w.Cb)({type:Number})],Ci.prototype,"elevationMargin",void 0),Ci=(0,r._)([(0,x.j)("esri.views.3d.state.Constraints.CollisionConstraint")],Ci);let xi=class extends Xe.Z{constructor(){super(...arguments),this.min=vi.min,this.max=vi.max}};(0,r._)([(0,w.Cb)({type:Number})],xi.prototype,"min",void 0),(0,r._)([(0,w.Cb)({type:Number})],xi.prototype,"max",void 0),xi=(0,r._)([(0,x.j)("esri.views.3d.constraints.AltitudeConstraint")],xi);let Ti=class extends Xe.Z{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}castNear(e){return Math.max(1e-8,e)}get far(){return this._get("far")}set far(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}castFar(e){return Math.max(1e-8,e)}autoUpdate(e,t){"auto"===this.mode&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==t&&this._set("far",t))}};(0,r._)([(0,w.Cb)({type:Number,value:1e-8})],Ti.prototype,"near",null),(0,r._)([(0,C.p)("near")],Ti.prototype,"castNear",null),(0,r._)([(0,w.Cb)({type:Number,value:1e-8})],Ti.prototype,"far",null),(0,r._)([(0,C.p)("far")],Ti.prototype,"castFar",null),(0,r._)([(0,w.Cb)({type:["auto","manual"]})],Ti.prototype,"mode",void 0),Ti=(0,r._)([(0,x.j)("esri.views.3d.constraints.ClipDistanceConstraint")],Ti);const Si={min:(0,st.BV)(bi.min),max:(0,st.BV)(bi.max)};let Mi=class extends Xe.Z{constructor(e){super(e),this.mode="auto"}get max(){return this._get("max")}set max(e){this._set("max",e),this.mode="manual"}castMax(e){return(0,st.uZ)(e,Si.min,Si.max)}autoUpdate(e){"auto"===this.mode&&this._get("max")!==e&&this._set("max",e)}};(0,r._)([(0,w.Cb)({type:["auto","manual"]})],Mi.prototype,"mode",void 0),(0,r._)([(0,w.Cb)({type:Number,value:Si.max})],Mi.prototype,"max",null),(0,r._)([(0,C.p)("max")],Mi.prototype,"castMax",null),Mi=(0,r._)([(0,x.j)("esri.views.3d.constraints.TiltConstraint")],Mi);let Ei=class extends Xe.Z{constructor(e){super(e),this.tilt=new Mi,this.altitude=new xi,this.clipDistance=new Ti}};(0,r._)([(0,w.Cb)({type:Mi})],Ei.prototype,"tilt",void 0),(0,r._)([(0,w.Cb)({type:xi})],Ei.prototype,"altitude",void 0),(0,r._)([(0,w.Cb)({type:Ti})],Ei.prototype,"clipDistance",void 0),Ei=(0,r._)([(0,x.j)("esri.views.3d.constraints.Constraints")],Ei);var Pi=i(24910),Ri=i(70331),Ai=i(5052);function Oi(e){return(0,Ee.fS)(e,Ri.HQ)||(0,Ee.BZ)(e)?{wkid:Ai.W.GCSMARS2000}:(0,Ee.fS)(e,Ri.VY)||(0,Ee.V2)(e)?{wkid:Ai.W.GCSMOON2000}:N.Z.WGS84}var Di=i(39355),Ii=i(47925),Li=i(41629),Ni=i(85382);class Fi{constructor(e,t,i,r,n,s,a,o,l=.5){this.coverage=e,this.density=t,this.absorption=i,this.cloudSize=r,this.detailSize=n,this.smoothness=s,this.cloudHeight=a,this.raymarchingSteps=o,this.median=l}}const Ui={sunny:new Fi([0,.6],[.03,.03],[0,0],[.9,.9],[.8,.8],[.7,.7],[.05,.05],Ni.p.SIXTEEN),cloudy:new Fi([.3,.65],[.2,.4],[0,0],[.85,.85],[.75,.75],[.3,.4],[1,1],Ni.p.TWOHUNDRED,.6),rainy:new Fi([.6,.8],[.5,.8],[.1,.5],[.9,.9],[.75,.75],[.5,.5],[1,1],Ni.p.TWOHUNDRED,.4),snowy:new Fi([.25,.75],[.3,.3],[0,0],[.95,.95],[.7,.7],[.69,.75],[.3,1],Ni.p.HUNDRED,.65),foggy:new Fi([.8,.8],[.5,.5],[0,0],[.95,.95],[.9,.9],[.55,.55],[.3,.3],Ni.p.SIXTEEN)};Ui.default=Ui.sunny;var Hi=i(79487),ki=i(96373),Vi=i(31865),Bi=i(10934),zi=i(26821),Gi=i(41788),qi=i(86875),Zi=i(55868),ji=i(58257),Wi=i(29107),$i=i(65650),Xi=i(51135);class Yi extends Wi.A{constructor(e,t){super(e,t,new ji.J(Zi.a,(()=>i.e(14507).then(i.bind(i,14507)))))}initializePipeline(e){return(0,Xi.sm)({blending:(0,Xi.if)($i.zi.CONSTANT_COLOR,$i.zi.ONE_MINUS_CONSTANT_COLOR,$i.db.ADD,e.writeTextureChannels===Li.uz.RG?[1,1,0,0]:[0,0,1,1]),depthTest:{func:$i.wb.LEQUAL},colorWrite:Xi.gf})}}var Ki=i(26605),Qi=i(80461),Ji=i(23625);class er extends Wi.A{constructor(e,t){super(e,t,new ji.J(Ki.a,(()=>i.e(92550).then(i.bind(i,92550)))))}initializePipeline(e){return(0,Xi.sm)({blending:e.mode===Qi.u.Full?Xi.LW:(0,Xi.wK)($i.zi.ZERO,$i.zi.ONE,$i.zi.ONE,$i.zi.ZERO),depthTest:{func:$i.wb.ALWAYS},colorWrite:Xi.gf})}}var tr=i(31454),ir=i(35928);let rr=class extends S.Z{constructor(e){super(e),this._needsRender=!0,this._passParameters=new Ki.N,this._configuration=new Qi.i,this._fbo=new tr.X(e.context.renderContext.rctx,new ir.X(Ji.a5)),e.context.techniques.precompile(er,new Qi.i);const t=new Qi.i;t.mode=Qi.u.WeatherMap,e.context.techniques.precompile(er,t)}get textureAtlas(){if(this._texture&&!this._needsRender)return this._texture;this._configuration.mode=this._texture?Qi.u.WeatherMap:Qi.u.Full;const e=this.context.techniques.get(er,this._configuration);return e.compiled&&(this._texture=this._render(e)),this._texture}updateWeatherMap(e){(0,zi.fS)(this._passParameters.weatherTile,e)||((0,zi.JG)(this._passParameters.weatherTile,e),this._needsRender=!0)}destroy(){this._fbo=(0,p.M2)(this._fbo)}_render(e){if(!this._fbo)return null;const t=this.context.renderContext.rctx,i=t.getViewport();return t.setViewport(0,0,Ji.a5,Ji.a5),t.bindFramebuffer(this._fbo),t.bindTechnique(e,this.context.renderContext.bind,this._passParameters),t.screen.draw(),t.setViewport(i.x,i.y,i.width,i.height),this._needsRender=!1,this._fbo.colorTexture}};(0,r._)([(0,w.Cb)({constructOnly:!0})],rr.prototype,"context",void 0),rr=(0,r._)([(0,x.j)("esri.views.3d.environment.NoiseTextureAtlas")],rr);var nr=i(50399),sr=i(78891);let ar=class extends S.Z{constructor(e){super(e),this._state=(0,Di.t)(Li.TH.Idle),this._passParameters=new Zi.C,this._weatherTileCount=128,this._sliceIndex=0,this._tileIndex=0,this._tilesPerSlice=1,this.coverage=(0,st.t7)(Ui.default.coverage[0],Ui.default.coverage[1],.5),this.density=(0,st.t7)(Ui.default.density[0],Ui.default.density[1],.5),this.absorption=(0,st.t7)(Ui.default.absorption[0],Ui.default.absorption[1],.5),this.cloudSize=(0,st.t7)(Ui.default.cloudSize[0],Ui.default.cloudSize[1],.5),this.detailSize=(0,st.t7)(Ui.default.detailSize[0],Ui.default.detailSize[1],.5),this.smoothness=(0,st.t7)(Ui.default.smoothness[0],Ui.default.smoothness[1],.5),this.cloudHeight=(0,st.t7)(Ui.default.cloudHeight[0],Ui.default.cloudHeight[1],.5),this.raymarchingSteps=Ui.default.raymarchingSteps,this._viewMatrix=(0,Bi.Ue)(),this._dirty=!0,this.running=!0,this._configuration=new Ni.t}initialize(){const e=(0,Ii.Iu)(this.view.spatialReference);this._passParameters.cloudRadius=.5*e.radius;const t=()=>this.setDirty();this.addHandles([this.view.resourceController.scheduler.registerTask(nr.T8.CLOUDS_GENERATOR,this),(0,_.YP)((()=>this.coverage),t,_.nn),(0,_.YP)((()=>this.density),t,_.nn),(0,_.YP)((()=>this.absorption),t,_.nn),(0,_.YP)((()=>this.cloudSize),t,_.nn),(0,_.YP)((()=>this.detailSize),t,_.nn),(0,_.YP)((()=>this.smoothness),t,_.nn),(0,_.YP)((()=>this.cloudHeight),t,_.nn),(0,_.YP)((()=>this.raymarchingSteps),t,_.nn)]);const i=(0,Gi.d9)(this._computeWeatherTile());let r=0;this.addHandles((0,_.YP)((()=>{const e=this._computeWeatherTile();return(0,zi.fS)(i,e)||(++r,(0,zi.JG)(i,e)),r}),t))}destroy(){this.destroyCubeMap(),this._passParameters.noiseTexture=(0,p.SC)(this._passParameters.noiseTexture)}_precompileTechniques(){this._configuration.steps=this.raymarchingSteps,this._configuration.writeTextureChannels=Li.uz.RG,this.context.techniques.precompile(Yi,this._configuration),this._configuration.writeTextureChannels=Li.uz.BA,this.context.techniques.precompile(Yi,this._configuration)}_acquireTechnique(){switch(this.raymarchingSteps){case Ni.p.SIXTEEN:this._tilesPerSlice=1;break;case Ni.p.HUNDRED:this._tilesPerSlice=4;break;case Ni.p.COUNT:case Ni.p.TWOHUNDRED:this._tilesPerSlice=8;break;default:(0,Hi.Bg)(this.raymarchingSteps)}return this._configuration.writeTextureChannels=1-this.parameters.readChannels,this._configuration.steps=this.raymarchingSteps,this.context.techniques.get(Yi,this._configuration)}_computeWeatherTile(){const{camera:e,environment:t}=this.view,{latitude:i,longitude:r}=e.position;if(null==i||null==r)return Gi.AG;(0,zi.t8)(hr,(i+90)/180,(r+180)/360);const n=Math.floor(this._weatherTileCount*Math.abs(2*hr[0]-1));hr[0]=Math.floor(2*this._weatherTileCount*hr[0]),hr[1]=Math.floor(4*(this._weatherTileCount-n)*hr[1]);let s=0,a=0;if("virtual"!==t?.lighting?.type&&null!=t?.lighting?.date){const e=new Date(t.lighting.date);e.setUTCHours(t.lighting.date.getUTCHours()+(t.lighting.displayUTCOffset??0)),s=31*e.getUTCMonth()+e.getUTCDate(),a=e.getUTCFullYear()}return hr[0]=(hr[0]+s)%(2*this._weatherTileCount),hr[1]=(hr[1]+a%100)%(4*this._weatherTileCount),hr}get state(){return this._state.value}set state(e){this._state.value=e}get usedMemory(){return(this._fbo?.usedMemory??0)+(this._passParameters.noiseTexture?.textureAtlas?.usedMemory??0)}_ensureNoiseTexture(){return this._passParameters.noiseTexture??=new rr({context:this.context}),this._passParameters.noiseTexture}_ensureFrameBufferCube(e){const t=this.context.renderContext.rctx;if(null==this._fbo){const i=new ir.X(e,e/2);i.target=$i.No.TEXTURE_2D_ARRAY,i.depth=6,i.wrapMode=$i.e8.CLAMP_TO_EDGE,this._fbo=new tr.X(t,i),this.parameters.data=this,this.parameters.absorption=this.absorption,this.parameters.coverage=this.coverage}return t.unbindTexture(this._fbo.colorTexture),this._fbo}get cubeMap(){return this._fbo}get parameters(){return this.context.renderContext.bind.clouds}destroyCubeMap(){this._fbo=(0,p.M2)(this._fbo),this.parameters.data=null}applyPreset(e,t){const i=e.median,r=e=>{const r=(0,st.t7)(e[0],e[1],i);return t<.5?(0,st.t7)(e[0],r,2*t):(0,st.t7)(r,e[1],2*(t-.5))};this.coverage=r(e.coverage),this.density=r(e.density),this.absorption=r(e.absorption),this.cloudSize=r(e.cloudSize),this.detailSize=r(e.detailSize),this.smoothness=r(e.smoothness),this.cloudHeight=r(e.cloudHeight),this.raymarchingSteps=e.raymarchingSteps,this._precompileTechniques()}setDirty(){this._dirty=this.running=!0}runTask(e){if(this.state===Li.TH.Fading)return sr.J;this._dirty&&(this._sliceIndex=this._tileIndex=0,this.state=Li.TH.Rendering,this._passParameters.absorption=this.absorption,this._passParameters.density=this.density,this._passParameters.cloudSize=this.cloudSize,this._passParameters.detailSize=this.detailSize,this._passParameters.smoothness=this.smoothness,this._passParameters.cloudHeight=this.cloudHeight,this._passParameters.coverage=this.coverage,this._ensureNoiseTexture().updateWeatherMap(this._computeWeatherTile()),this._dirty=!1);const t=this._acquireTechnique();if(!this._ensureNoiseTexture().textureAtlas||!t.compiled)return sr.J;const i=or[this._sliceIndex],r=lr[this._sliceIndex];(0,Vi.ji)(this._viewMatrix,cr,i,r),(0,ki.xO)(this._passParameters.viewMatrix,this._viewMatrix);const n=this.context.renderContext.rctx,s=n.getViewport(),a=Zi.c/this._tilesPerSlice,o=this._tileIndex*a;n.setViewport(0,o,Zi.c,a);const l=this._ensureFrameBufferCube(Zi.c);n.bindFramebuffer(l),this._passParameters.lastSlice=5===this._sliceIndex,n.bindTechnique(t,this.context.renderContext.bind,this._passParameters);const c=$i.No.TEXTURE_2D_ARRAY;return l.setColorTextureTarget(c,$i.Ii,this._sliceIndex),n.screen.draw(),n.gl.flush(),n.setViewport(s.x,s.y,s.width,s.height),this.requestRender(),++this._tileIndex,5===this._sliceIndex&&this._tileIndex===this._tilesPerSlice?(this._sliceIndex=this._tileIndex=0,this.state=Li.TH.Ready,this.running=!1):this._tileIndex===this._tilesPerSlice&&(++this._sliceIndex,this._tileIndex=0),e.madeProgress(),sr.J}};(0,r._)([(0,w.Cb)({constructOnly:!0})],ar.prototype,"context",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],ar.prototype,"view",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],ar.prototype,"requestRender",void 0),(0,r._)([(0,w.Cb)()],ar.prototype,"coverage",void 0),(0,r._)([(0,w.Cb)()],ar.prototype,"density",void 0),(0,r._)([(0,w.Cb)()],ar.prototype,"absorption",void 0),(0,r._)([(0,w.Cb)()],ar.prototype,"cloudSize",void 0),(0,r._)([(0,w.Cb)()],ar.prototype,"detailSize",void 0),(0,r._)([(0,w.Cb)()],ar.prototype,"smoothness",void 0),(0,r._)([(0,w.Cb)()],ar.prototype,"cloudHeight",void 0),(0,r._)([(0,w.Cb)()],ar.prototype,"raymarchingSteps",void 0),(0,r._)([(0,w.Cb)()],ar.prototype,"running",void 0),ar=(0,r._)([(0,x.j)("esri.views.3d.environment.CloudsRenderer")],ar);const or=[(0,qi.al)(1,0,0),(0,qi.al)(-1,0,0),(0,qi.al)(0,1,0),(0,qi.al)(0,-1,0),(0,qi.al)(0,0,1),(0,qi.al)(0,0,1)],lr=[(0,qi.al)(0,0,-1),(0,qi.al)(0,0,-1),(0,qi.al)(0,0,-1),(0,qi.al)(0,0,-1),(0,qi.al)(0,1,0),(0,qi.al)(0,1,0)],cr=(0,R.ll)(),hr=(0,Gi.ll)();var ur=i(32555),dr=i(26173),pr=i(40854),mr=i(52061),fr=i(74826);class _r extends fr.K{constructor(){super(...arguments),this.time=0,this.radius=1,this.width=500,this.opacity=0}}class gr extends Wi.A{constructor(e,t){super(e,t,new ji.J(pr.P,(()=>i.e(18383).then(i.bind(i,18383)))),new Map([[mr.T.POSITION,0],[mr.T.INSTANCEFEATUREATTRIBUTE,1]]))}initializePipeline(){return(0,Xi.sm)({blending:Xi.Zo,depthTest:{func:$i.wb.LEQUAL},colorWrite:Xi.gf})}}var yr=i(22567),vr=i(72894),br=i(52890),wr=i(52054),Cr=i(32420);let xr=class extends wr.Z{constructor(){super(...arguments),this.produces="disabled",this.consumes={required:[dr.CM.OPAQUE_ENVIRONMENT]}}_enable(){this.produces=dr.CM.OPAQUE_ENVIRONMENT,this.requestRender(Cr.Xx.UPDATE)}_disable(){this.produces="disabled",this.requestRender(Cr.Xx.UPDATE)}};(0,r._)([(0,w.Cb)()],xr.prototype,"produces",void 0),(0,r._)([(0,w.Cb)()],xr.prototype,"consumes",void 0),xr=(0,r._)([(0,x.j)("esri.views.3d.webgl-engine.effects.OpaqueEnvironment")],xr);let Tr=class extends xr{constructor(){super(...arguments),this.consumes={required:[dr.CM.TRANSPARENT_ENVIRONMENT]}}_enable(){this.produces=dr.CM.TRANSPARENT_ENVIRONMENT,this.requestRender(Cr.Xx.UPDATE)}};(0,r._)([(0,w.Cb)()],Tr.prototype,"consumes",void 0),Tr=(0,r._)([(0,x.j)("esri.views.3d.webgl-engine.effects.TransparentEnvironment")],Tr);var Sr=i(32335),Mr=i(92761),Er=i(15483);let Pr=class extends Tr{constructor(e){super(e),this._rainSpeed=.1,this._snowSpeed=.01,this._numParticles=0,this._passParameters=new _r,this._configuration=new yr.Y;const{view:t,type:i}=e;this._configuration.type="rainy"===i?yr.H.Rain:yr.H.Snow,t.stage.renderView.techniques.precompile(gr,this._configuration),this._passParameters.time=0,this._passParameters.radius=(0,Ii.Iu)(t.spatialReference).radius,this.addHandles([(0,_.YP)((()=>t.environment.weather),(e=>{e.type===i&&this.addHandles((0,_.YP)((()=>e.precipitation),(e=>this._adjustParticles(e)),_.tX))}),_.tX)]),this.addHandles((0,_.YP)((()=>t.stage?.renderer.renderContext.bind.clouds.fadeFactor??1),(e=>{this._passParameters.opacity=e,1===e&&(this.removeHandles("opacity"),this.addHandles((0,_.YP)((()=>t.stage?.renderer.renderContext.bind.clouds.opacity??1),(e=>this._passParameters.opacity=e),_.tX),"opacity"))}),_.Z_),"opacity")}initialize(){this.addHandles([(0,_.YP)((()=>this.view.environment.atmosphereEnabled),(e=>e?this._enable():this._disable()),_.tX)])}_adjustParticles(e){const t=e<.5?(0,st.t7)(0,.35,2*e):(0,st.t7)(.35,1,2*(e-.5));this._numParticles=Rr*t}destroy(){this._numParticles=0,this._vao=(0,p.M2)(this._vao),this._instanceIdBuffer=(0,p.M2)(this._instanceIdBuffer)}fadeOut(e){this.removeAllHandles(),this.addHandles((0,_.YP)((()=>this.renderContext?.bind.clouds.fadeFactor??1),(t=>{this._passParameters.opacity=1-t,1===t&&(this.removeAllHandles(),e())})),"opacity")}updateAnimation(e){const t=("rainy"===this.type?this._rainSpeed:this._snowSpeed)*(0,ur.D9)(e.time)%1e5;return this._passParameters.time!==t&&(this._passParameters.time=t,!0)}render(e){const t=this.renderingContext;this._instanceIdBuffer??=this._createInstanceIndices(t);const i=Math.round(this._numParticles*this._passParameters.opacity),r=e.find((({name:e})=>e===dr.CM.TRANSPARENT_ENVIRONMENT));if(i<1)return r;const n=this.techniques.get(gr,this._configuration);if(!n.compiled)return this.requestRender(Cr.Xx.UPDATE),r;const s=t.bindTechnique(n,this.bindParameters,this._passParameters);return this._vao??=function(e,t){const i=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new Sr.U(e,t,new Map([["geometry",(0,vr.K)(Ar)]]),new Map([["geometry",Mr.f.createVertex(e,$i.l1.STATIC_DRAW,i)]]))}(t,n.locations),t.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao),(0,Er.XP)(t,n.locations,this._instanceIdBuffer,Or,0),t.drawArraysInstanced($i.MX.TRIANGLES,0,3,i),(0,Er.UF)(t,n.locations,this._instanceIdBuffer,Or),r}_createInstanceIndices(e){const t=[];for(let e=0;e<Rr;e++)t.push(e);return Mr.f.createVertex(e,$i.l1.STATIC_DRAW,new Float32Array(t))}};(0,r._)([(0,w.Cb)({constructOnly:!0})],Pr.prototype,"type",void 0),Pr=(0,r._)([(0,x.j)("esri.views.3d.environment.Precipitation")],Pr);const Rr=25e4,Ar=(0,br.U$)().vec3f(mr.T.POSITION),Or=(0,vr.K)((0,br.U$)().f32(mr.T.INSTANCEFEATUREATTRIBUTE),1);var Dr=i(70973),Ir=i(20472);let Lr=class extends Ir.tY{constructor(e){super(e),this.produces=new Map([]),this._clouds=(0,Di.t)(null),this._incarnation=0,this._precipitation=null}initialize(){this.view.stage?.addRenderPlugin(this)}destroy(){this.removeHandles(),this.uninitializeRenderContext(),this.view?.stage?.removeRenderPlugin(this),this._set("view",null)}get updating(){return!!this._clouds.value?.running}get weatherAvailable(){return(0,Pi.l)(this.view.state.camera.eye)-(0,Ii.Iu)(this.view.spatialReference).radius<=Dr.rm}get usedMemory(){return this._clouds.value?.usedMemory??0}_fadeOutPrecipitation(){this._precipitation&&(this._precipitationOutgoing?.destroy(),this._precipitationOutgoing=this._precipitation,this._precipitationOutgoing.fadeOut((()=>{this._precipitationOutgoing=(0,p.SC)(this._precipitationOutgoing)})),this._precipitation=null,++this._incarnation)}get weather(){return this.view?.environmentManager?.weatherEnabled?this.view.environment.weather:null}initializeRenderContext(e){this._context=e;const t=this.view,i=()=>this._requestRender();this.addHandles([(0,_.YP)((()=>this._precipitation),i,_.Z_),(0,_.YP)((()=>this._clouds.value?.state),i,_.Z_),(0,_.YP)((()=>t.state.mode),i,_.Z_),(0,_.YP)((()=>this._updateClouds()),i,_.Z_),(0,_.YP)((()=>this._updatePrecipitation()),i,_.Z_),(0,_.YP)((()=>this.weather),(e=>this._initWeather(e)))])}uninitializeRenderContext(){this._context=null,this._clouds.value=(0,p.SC)(this._clouds.value),this._precipitation=(0,p.SC)(this._precipitation),this._precipitationOutgoing=(0,p.SC)(this._precipitationOutgoing)}prepareRender(e){const{bind:t,time:i}=e;if("local"!==this.view.viewingMode&&t.clouds.data){t.clouds.fade(t.camera,i,this.view.qualitySettings.fadeDuration);const e=this._clouds.value;e&&e.state===Li.TH.Idle&&0===e.coverage&&!e.running&&e.destroyCubeMap()}}acquireTechniques(){return[]}render(){}_requestRender(){this._context?.requestRender()}_initWeather(e){const t=this._context;if(!e||!t)return void(this._clouds.value=(0,p.SC)(this._clouds.value));if(this._clouds.value)return;const i=this.view;this._clouds.value=new ar({context:t,view:i,requestRender:()=>this._requestRender()})}_updateClouds(){const e=this.view.environment.weather;return null==e||null==this._clouds.value||this._clouds.value.applyPreset(Ui[e.type],function(e){switch(e.type){case"rainy":case"snowy":case"cloudy":case"sunny":return e.cloudCover;case"foggy":return e.fogStrength}}(e)),++this._incarnation}_updatePrecipitation(){const e=this.view.environment.weather;if(e.type===this._precipitation?.type)return this._incarnation;this._fadeOutPrecipitation();const t="rainy"===e.type||"snowy"===e.type,i=this._context;return t&&i&&(this._precipitation=new Pr({view:this.view,type:e.type}),++this._incarnation),this._incarnation}get test(){}hasHighlight(){return!1}};(0,r._)([(0,w.Cb)({constructOnly:!0})],Lr.prototype,"view",void 0),(0,r._)([(0,w.Cb)({type:Boolean,readOnly:!0})],Lr.prototype,"updating",null),(0,r._)([(0,w.Cb)()],Lr.prototype,"weatherAvailable",null),(0,r._)([(0,w.Cb)()],Lr.prototype,"_context",void 0),Lr=(0,r._)([(0,x.j)("esri.views.3d.environment.EnvironmentRenderer")],Lr);var Nr=i(32185),Fr=i(69069);const Ur={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};class Hr{constructor(e,t){this.direct=e,this.ambient=t}}function kr(e,t,i,r,n,s){(0,Pi.i)(s.ambient.color,1,1,1),s.ambient.intensity=Ur.global.ambient,(0,Pi.i)(s.direct.color,1,1,1),s.direct.intensity=Ur.global.direct;const a=t[2],o=(0,st.uZ)((Math.abs(a)-Ur.local.altitude)/(Ur.global.altitude-Ur.local.altitude),0,1);let l;if(s.globalFactor=o,null!=e&&(l=Fr.S.getTimes(e,t[1],t[0])),o<1){let t;if(null!=e)t=function(e,t,i){const r=e.valueOf();let n,s;t.polarException===Fr.S.PolarException.MIDNIGHT_SUN?(n=r-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,s=n+432e6):t.polarException===Fr.S.PolarException.POLAR_NIGHT?(n=r-2,s=r-1):(n=t.sunrise.valueOf(),s=t.sunset.valueOf());const a=s-n,o=n+a/2,l=a/4,c=o-l,h=o+l,u=.06*a,d=n-u/2,p=n+u/2,m=s-u/2,f=s+u/2,_=(0,Gi.Ue)(),g=(0,R.Ue)(),y=(0,R.Ue)();let v="";if(r<d||r>f)(0,zi.JG)(_,rn),(0,Pi.c)(g,$r),(0,Pi.c)(y,Qr),v="night";else if(r<p){const e=(r-d)/(p-d);(0,zi.t7)(_,rn,nn,e),(0,Pi.m)(g,$r,Xr,e),(0,Pi.m)(y,Qr,Jr,e),v="sun rising"}else if(r<c){const e=(r-p)/(c-p);(0,zi.t7)(_,nn,sn,e),(0,Pi.m)(g,Xr,Yr,e),(0,Pi.m)(y,Jr,en,e),v="early morning"}else if(r<o){const e=(r-c)/(o-c);(0,zi.t7)(_,sn,an,e),(0,Pi.m)(g,Yr,Kr,e),(0,Pi.m)(y,en,tn,e),v="late morning"}else if(r<h){const e=(r-o)/(h-o);(0,zi.t7)(_,an,on,e),(0,Pi.m)(g,Kr,ln,e),(0,Pi.m)(y,tn,cn,e),v="early afternoon"}else if(r<m){const e=(r-h)/(m-h);(0,zi.t7)(_,on,hn,e),(0,Pi.m)(g,ln,un,e),(0,Pi.m)(y,cn,dn,e),v="late afternoon"}else if(r<f){const e=(r-m)/(f-m);(0,zi.t7)(_,hn,rn,e),(0,Pi.m)(g,un,$r,e),(0,Pi.m)(y,dn,Qr,e),v="sun setting"}let b=0;switch(i){case"rainy":case"foggy":b=.8;break;case"snowy":b=.5}b>0&&(Wr(g,b),Wr(y,b));const w=jr(i);return{direct:{intensity:_[0]*w.direct,color:g},ambient:{intensity:_[1]*w.ambient,color:y},timeOfDay:v}}(e,l,r);else{const e=jr(r);t={direct:{intensity:Ur.local.directAtNoon*e.direct,color:(0,R.al)(1,1,1)},ambient:{intensity:Ur.local.ambientAtNoon*e.ambient,color:(0,R.al)(1,1,1)},timeOfDay:"early afternoon"}}(0,Pi.m)(s.ambient.color,t.ambient.color,s.ambient.color,o),s.ambient.intensity=(0,st.t7)(t.ambient.intensity,s.ambient.intensity,o),(0,Pi.m)(s.direct.color,t.direct.color,s.direct.color,o),s.direct.intensity=(0,st.t7)(t.direct.intensity,s.direct.intensity,o),s.specularStrength="rainy"===r||"snowy"===r||"foggy"===r?0:1,s.environmentStrength="rainy"===r?.7:"snowy"===r||"foggy"===r?.75:1}s.noonFactor=null!=e?function(e,t){const i=e.valueOf();let r,n;t.polarException===Fr.S.PolarException.MIDNIGHT_SUN?(r=i-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,n=r+432e6):t.polarException===Fr.S.PolarException.POLAR_NIGHT?(r=i-2,n=i-1):(r=t.sunrise.valueOf(),n=t.sunset.valueOf());const s=r+(n-r)/2;return 1-(0,st.uZ)(Math.abs(i-s)/432e5,0,1)}(e,l):1,null!=e?Br(e,t,i,s.direct.directionToLightSource):Vr(n,i,s.direct.directionToLightSource)}function Vr(e,t,i){t===Ht.JY.Global?(0,Pi.n)(mn,e.eye):(0,Pi.i)(mn,0,0,1),(0,Pi.g)(fn,e.viewForward,-1);const r=(0,gi.EU)(fn,mn),n=Math.max(r-2*gn,0),s=.85*n/(n+1),a=Math.max(gn,r-gn-s);(0,Vi.Us)(pn,-a,e.viewRight),(0,Pi.t)(i,fn,pn),(0,Pi.f)(i,i,(0,Pi.g)(_n,e.viewRight,yn)),(0,Pi.n)(i,i)}function Br(e,t,i,r){const n=Zr,s=(0,Vi.yR)(qr);if(i===Ht.JY.Global)Fr.S.getPosition(e,0,0,n),(0,Pi.i)(r,0,0,-1),(0,Vi.lM)(s,s,-n.azimuth),(0,Vi.uD)(s,s,-n.altitude),(0,Pi.t)(r,r,s);else{const i=Ur.planarDirection,a=i.globalAngles,o=t[2];let l=(Math.abs(o)-i.localAltitude)/(i.globalAltitude-i.localAltitude);l=(0,st.uZ)(l,0,1),l<1?(Fr.S.getPosition(e,t[1],t[0],n),n.azimuth=(1-l)*n.azimuth+l*a.azimuth,n.altitude=(1-l)*n.altitude+l*a.altitude):(n.azimuth=a.azimuth,n.altitude=a.altitude),(0,Pi.i)(r,0,-1,0),(0,Vi.jI)(s,s,-n.azimuth),(0,Vi.lM)(s,s,-n.altitude),(0,Pi.t)(r,r,s)}}const zr=(0,R.al)(.5773502691896258,-.5773502691896258,.5773502691896258);class Gr{constructor(){this.ambient={color:(0,R.al)(1,1,1),intensity:.55},this.direct={color:(0,R.al)(1,1,1),intensity:.55,directionToLightSource:(0,R.d9)(zr)},this.noonFactor=.5,this.globalFactor=0,this.specularStrength=1,this.environmentStrength=1}}const qr=(0,Bi.Ue)(),Zr={azimuth:0,altitude:0};function jr(e){switch(e){case"disabled":case"sunny":case"cloudy":return new Hr(1,1);case"rainy":return new Hr(.4,1.2);case"snowy":return new Hr(.5,1.3);case"foggy":return new Hr(.2,1.6)}}function Wr(e,t){const i=(e[0]+e[1]+e[2])/3;e[0]+=(i-e[0])*t,e[1]+=(i-e[1])*t,e[2]+=(i-e[2])*t}const $r=(0,R.al)(.01,.01,.01),Xr=(0,R.al)(1,.6,.5),Yr=(0,R.al)(1,.98,.98),Kr=(0,R.al)(1,1,1),Qr=(0,R.al)(.8,.8,1),Jr=(0,R.al)(.8,.8,1),en=(0,R.al)(.98,.98,1),tn=(0,R.al)(1,1,1),rn=(0,Gi.al)(.01,Ur.local.ambientAtNight),nn=(0,Gi.al)(Ur.local.directAtTwilight,Ur.local.ambientAtTwilight),sn=(0,Gi.al)(.9*Ur.local.directAtNoon,Ur.local.ambientAtNoon),an=(0,Gi.al)(Ur.local.directAtNoon,Ur.local.ambientAtNoon),on=sn,ln=Yr,cn=en,hn=nn,un=Xr,dn=Jr;new Date(0);const pn=(0,Bi.Ue)(),mn=(0,R.Ue)(),fn=(0,R.Ue)(),_n=(0,R.Ue)(),gn=.25,yn=.2;var vn=i(81021),bn=i(8562);let wn=class extends ae.Z.EventedAccessor{constructor(){super(),this._tmpLightParameters=new Gr,this._defaultLightParameters=new Gr,this._tmpDate=new Date,this._tmpTz={hours:0,minutes:0,seconds:0},this._viewHandlesKey="viewHandles",this._trackingEnabled=!1,this._mainLight=new bn.Eg,this._ambientLight=new bn.Mi,this._moonLight=new bn.AM,this._disableWeather=!1,this._renderer=null,this._resetReferencePosition()}destroy(){this.disconnectView()}get _view(){return this._renderer?.view}get updating(){return!!this._renderer?.updating||!this._canProjectCameraPosition}get weatherEnabled(){return this._view?.environment.atmosphereEnabled&&!this._disableWeather&&this._view?.state?.viewingMode===Ht.JY.Global&&(0,Ee.N$)(this._view.spatialReference)}get _weatherAvailable(){return this.weatherEnabled&&this._renderer?.weatherAvailable}get referencePositionGeographic(){return this._referencePositionGeographic}get _canProjectCameraPosition(){const e=this._view?.stateManager?.camera?.position?.spatialReference??N.Z.WGS84,t=Oi(e);return(0,L.isLoadedOrLoadFor)(e,t)}connectView(e){if(this._renderer)return;this._renderer=new Lr({view:e});const t=()=>this._updateRenderParameters(),i=()=>this._cameraHandler();this.addHandles([(0,_.YP)((()=>e.environment.lighting),(e=>this._updateLightingHandler(e)),_.Z_),(0,_.YP)((()=>"virtual"!==e.environment.lighting.type?e.environment.lighting.date:null),(e=>this._lightingDateHandler(e)),_.Z_),(0,_.YP)((()=>e.environment.lighting.directShadowsEnabled),t,_.Z_),(0,_.YP)((()=>e.qualitySettings.ambientOcclusion),t,_.Z_),(0,_.YP)((()=>e.qualitySettings.reflections),t,_.Z_),(0,_.YP)((()=>e.spatialReference),(()=>this._resetReferencePosition(!0)),_.Z_),(0,_.YP)((()=>[e.environment.weather.type,this.weatherEnabled]),(()=>this._updateLighting(null,vn.B.FadeWithWeather)),_.Z_),(0,_.YP)((()=>"snowy"===e.environment.weather.type&&e.environment.weather.snowCover),t,_.Z_),(0,_.YP)((()=>e.environment),(e=>e.setComputeWeatherAvailable((()=>this._weatherAvailable))),_.tX),(0,_.YP)((()=>e.viewingMode),(()=>this._resetReferencePosition(!0)),_.tX),(0,_.YP)((()=>"virtual"!==e.environment.lighting.type&&e.environment.lighting.cameraTrackingEnabled),(e=>this._updateCameraTracking(e)),_.tX),(0,_.YP)((()=>e.state.camera),i,_.tX),(0,_.gx)((()=>this._canProjectCameraPosition),i,_.Z_)],this._viewHandlesKey),this._updateRenderParameters(),this._updateLighting(),this._cameraHandler(),this.notifyChange("updating")}disconnectView(){this.removeHandles(this._viewHandlesKey),this._resetReferencePosition(),this._renderer=(0,p.SC)(this._renderer)}_updateLightingHandler(e){this._updateCameraTracking("virtual"!==e.type&&e.cameraTrackingEnabled),this._lightingDateHandler("virtual"!==e.type?e.date:null),this._updateRenderParameters()}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const e=this._view.environment.lighting;"virtual"!==e?.type&&(e.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){const t=this._view.environment.lighting;if("virtual"!==t?.type){if(e){if(!t.positionTimezoneInfo.autoUpdated&&(this._preupdateTracking(e),null!=this._referencePositionGeographic)){const e=(0,Nr.dF)(this._referencePositionGeographic,this._tmpTz);null!=e&&(t.autoUpdate(null,e),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}this._updateLighting(e)}}else this._updateLighting()}_preupdateTracking(e){!this._trackingEnabled&&"virtual"!==this._view.environment.lighting.type&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(e=null){const t=this._view;if(!t.ready)return;const i=t.stateManager.camera;if(!i)return;const{position:r}=i,n=Oi(r.spatialReference??N.Z.WGS84);if(!(0,U.K)(r,Tn,n)){if(null==this._referencePositionGeographic)return;return this._referencePositionGeographic=null,void this._updateLighting()}this._referencePositionGeographic?(0,Pi.G)(this._referencePositionGeographic,Tn)||((0,Pi.c)(this._referencePositionGeographic,Tn),this.notifyChange("referencePositionGeographic")):this._referencePositionGeographic=(0,R.d9)(Tn),this._autoUpdateTimezone(this._referencePositionGeographic,e)||this._updateLighting(e)}_updateLighting(e,t=vn.B.Immediate){const i=this._view,{lighting:r}=i.environment,n="virtual"===r.type,s=this._referencePositionGeographic,a=null!=s?this._tmpLightParameters:this._defaultLightParameters;if(s){e??=n?null:r.date;const t=this._weatherAvailable?i.environment.weather.type:"disabled";kr(e,s,i.state.viewingMode,t,i.state.camera,a)}else n&&Vr(i.state.camera,i.state.viewingMode,a.direct.directionToLightSource);const o=this._mainLight,l=a.direct;(0,Pi.g)(o.intensity,l.color,l.intensity*Math.PI),(0,Pi.c)(o.direction,l.directionToLightSource),o.specularStrength=a.specularStrength,o.environmentStrength=a.environmentStrength;const c=this._ambientLight;(0,Pi.g)(c.intensity,a.ambient.color,a.ambient.intensity);const h=this._moonLight;(0,Pi.m)(h.intensity,Cn,xn,a.globalFactor);const u=(1-.5*a.globalFactor)*(1-.4*a.noonFactor*(1-a.globalFactor));(0,Pi.g)(h.intensity,h.intensity,u),(0,Pi.c)(h.direction,l.directionToLightSource),this._view.stage?.renderer.updateLighting([o,c,h],a.noonFactor,a.globalFactor,this._weatherAvailable?t:vn.B.Immediate),this._updateRenderParameters()}_autoUpdateTimezone(e,t=null){if("virtual"===this._view.environment.lighting.type||!this._view.environment.lighting.cameraTrackingEnabled||null==e)return!1;const i=this._tmpDate;i.setTime((t||this._view.environment.lighting.date).getTime());const r=(0,Nr.dF)(e,this._tmpTz);if(null==r)return!1;let n=this._view.environment.lighting.positionTimezoneInfo;if(n.autoUpdated){if(n.hours===r.hours&&n.minutes===r.minutes&&n.seconds===r.seconds)return!1}else n=r;const s=i.getUTCHours()-(r.hours-n.hours),a=i.getUTCMinutes()-(r.minutes-n.minutes),o=i.getUTCSeconds()-(r.seconds-n.seconds);return i.setUTCHours(s),i.setUTCMinutes(a),i.setUTCSeconds(o),!t&&this._view.environment.lighting.autoUpdate(i,r)}_updateRenderParameters(){const e=this._view.stage;if(!e)return;const t=null==this._referencePositionGeographic||function(e,t){if(t===Ht.JY.Global)return!0;const i=Ur.planarDirection;return Math.abs(e)<i.localAltitude}(this._referencePositionGeographic[2],this._view.state.viewingMode);e.renderer.setParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&t,environment:this._view.environment,weatherVisible:this._weatherAvailable,qualitySettings:this._view.qualitySettings})}_resetReferencePosition(e=!1){this._referencePositionGeographic=null,e&&this._cameraHandler()}get test(){}};(0,r._)([(0,w.Cb)({type:Boolean,readOnly:!0})],wn.prototype,"updating",null),(0,r._)([(0,w.Cb)()],wn.prototype,"_disableWeather",void 0),(0,r._)([(0,w.Cb)()],wn.prototype,"weatherEnabled",null),(0,r._)([(0,w.Cb)()],wn.prototype,"_weatherAvailable",null),(0,r._)([(0,w.Cb)()],wn.prototype,"referencePositionGeographic",null),(0,r._)([(0,w.Cb)()],wn.prototype,"_referencePositionGeographic",void 0),(0,r._)([(0,w.Cb)()],wn.prototype,"_renderer",void 0),(0,r._)([(0,w.Cb)()],wn.prototype,"_canProjectCameraPosition",null),wn=(0,r._)([(0,x.j)("esri.views.3d.environment.EnvironmentManager")],wn);const Cn=(0,R.al)(.22,.22,.33),xn=(0,R.al)(.22,.22,.22),Tn=(0,R.Ue)();var Sn=i(28947),Mn=i(74558),En=i(24127);const Pn={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:Mn.Z,virtual:En.Z}};var Rn=i(63255),An=i(47826),On=i(17733),Dn=i(83946);const In={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:On.Z,virtual:Dn.Z}};let Ln=class extends Rn.Z{constructor(e){super(e)}clone(){throw new Error("Subclasses of Background should implement their own clone method.")}};(0,r._)([(0,w.Cb)({readOnly:!0,json:{read:!1}})],Ln.prototype,"type",void 0),Ln=(0,r._)([(0,x.j)("esri.webscene.background.Background")],Ln);const Nn=Ln;var Fn,Un=i(79775),Hn=i(88331);let kn=Fn=class extends Nn{constructor(e){super(e),this.type="color",this.color=new $e.Z([0,0,0,1])}clone(){return new Fn(this.cloneProperties())}cloneProperties(){return{color:this.color.clone()}}};(0,r._)([(0,Un.J)({color:"color"},{readOnly:!0}),(0,w.Cb)({json:{write:{isRequired:!0}}})],kn.prototype,"type",void 0),(0,r._)([(0,w.Cb)((0,Hn.aK)({nonNullable:!0,colorRequiredOnWrite:!0}))],kn.prototype,"color",void 0),kn=Fn=(0,r._)([(0,x.j)("esri.webscene.background.ColorBackground")],kn);const Vn=kn,Bn={base:Nn,key:"type",typeMap:{color:Vn}};const zn={types:Bn,json:{read:function(e){return(t,i,r)=>{if(!t)return t;for(const i in e.typeMap)if(t.type===i){const n=new e.typeMap[i];return n.read(t,r),n}}}(Bn),write:{overridePolicy:(e,t,i)=>({enabled:!i?.isPresentation})}}};var Gn;const qn=(e,t,i)=>({enabled:!i?.isPresentation});let Zn=class extends Rn.Z{static{Gn=this}constructor(e){super(e),this.lighting=new On.Z,this.background=null,this.atmosphereEnabled=!0,this.starsEnabled=!0}set weather(e){(0,Dr.b8)(e?.type,d.Z.getLogger(this))&&this._set("weather",e)}clone(){return new Gn(this.cloneConstructProperties())}cloneConstructProperties(){return{lighting:this.lighting&&"virtual"===this.lighting.type?Dn.Z.prototype.clone.call(this.lighting):On.Z.prototype.clone.call(this.lighting),background:(0,Sn.d9)(this.background),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,weather:this.weather.clone()}}};(0,r._)([(0,w.Cb)({types:In,nonNullable:!0,json:{write:!0}})],Zn.prototype,"lighting",void 0),(0,r._)([(0,w.Cb)(zn)],Zn.prototype,"background",void 0),(0,r._)([(0,w.Cb)({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:qn}}})],Zn.prototype,"atmosphereEnabled",void 0),(0,r._)([(0,w.Cb)({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:qn}}})],Zn.prototype,"starsEnabled",void 0),(0,r._)([(0,w.Cb)({types:Dr.Hr,nonNullable:!0,json:{write:!0},value:new An.Z})],Zn.prototype,"weather",null),Zn=Gn=(0,r._)([(0,x.j)("esri.webscene.Environment")],Zn);const jn=Zn;var Wn;let $n=class extends jn{static{Wn=this}constructor(e){super(e),this.lighting=this.castLighting(),this._computeWeatherAvailable=void 0,this.cachedCameraTrackingEnabled=null}static fromWebsceneEnvironment(e){const t=e.cloneConstructProperties();return new Wn({...t,lighting:t.lighting?"virtual"===t.lighting.type?En.Z.fromWebsceneLighting(t.lighting):Mn.Z.fromWebsceneLighting(t.lighting):void 0})}get weatherAvailable(){return this._computeWeatherAvailable?.()??!1}setComputeWeatherAvailable(e){this._computeWeatherAvailable=e}castLighting(e){return this._convertLightingWithDestroy(e)}applyLighting(e){this.lighting=this._convertLightingWithDestroy(e)}_convertLightingWithDestroy(e){const t=this._convertLighting(e);return t!==e&&this.addHandles((0,h.ed)(t)),t}_convertLighting(e){return e?e instanceof Mn.Z||e instanceof En.Z?e:e instanceof On.Z?this.lighting&&"virtual"!==this.lighting.type?this.lighting.cloneWithWebsceneLighting(e):new Mn.Z({...e.cloneConstructProperties(),...this.lighting?.cloneNonPersistentConstructProperties()}):e instanceof Dn.Z?this.lighting&&"virtual"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e):new En.Z({...e.cloneConstructProperties(),...this.lighting?.cloneNonPersistentConstructProperties()}):(0,T.N7)(Pn,e):new Mn.Z}clone(){return new Wn({lighting:this.lighting.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:(0,Sn.d9)(this.background)})}cloneWithWebsceneEnvironment(e){return new Wn({weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:(0,Sn.d9)(this.background),...e.cloneConstructProperties(),lighting:this._getLighting(e)})}_getLighting(e){switch(e.lighting.type){case"sun":return this.lighting&&"sun"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e.lighting):Mn.Z.fromWebsceneLighting(e.lighting);case"virtual":return this.lighting&&"virtual"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e.lighting):En.Z.fromWebsceneLighting(e.lighting);default:return(0,Hi.Bg)(e.lighting),Mn.Z.fromWebsceneLighting(e.lighting)}}};(0,r._)([(0,w.Cb)({nonNullable:!0})],$n.prototype,"lighting",void 0),(0,r._)([(0,w.Cb)()],$n.prototype,"_computeWeatherAvailable",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],$n.prototype,"weatherAvailable",null),(0,r._)([(0,C.p)("lighting")],$n.prototype,"castLighting",null),$n=Wn=(0,r._)([(0,x.j)("esri.views.3d.environment.SceneViewEnvironment")],$n);const Xn=$n;var Yn,Kn,Qn,Jn=i(12659),es=i(69055);!function(e){e[e.NONE=0]="NONE",e[e.TILT=1]="TILT",e[e.ALTITUDE=2]="ALTITUDE",e[e.DISTANCE=4]="DISTANCE",e[e.COLLISION=8]="COLLISION",e[e.ALL=15]="ALL",e[e.ALL_EXCEPT_COLLISION=7]="ALL_EXCEPT_COLLISION"}(Yn||(Yn={})),function(e){e[e.NONE=0]="NONE",e[e.ZOOM=1]="ZOOM",e[e.TUMBLE=2]="TUMBLE",e[e.LOOK_AROUND=3]="LOOK_AROUND",e[e.PAN=4]="PAN",e[e.ASCEND=5]="ASCEND"}(Kn||(Kn={})),function(e){e[e.TUMBLE=0]="TUMBLE",e[e.LOOK_AROUND=1]="LOOK_AROUND"}(Qn||(Qn={}));class ts{constructor(e=Yn.ALL,t=Kn.NONE,i=0,r=null,n=null,s=Qn.TUMBLE){this.selection=e,this.interactionType=t,this.interactionFactor=i,this.interactionStartCamera=r,this.interactionDirection=n,this.tiltMode=s}}function is(e,t){return 0!=(e&t)}function rs(e,t,i,r,n,s){0!==e&&(i?(s.min=Math.min(s.min,t),s.max=Math.max(s.max,t)):null!=r?(s.min-=Math.max(0,(t-s.min)*(1-r)),s.max+=Math.max(0,(t-s.max)*(1-r))):n&&(s.min-=Math.max(0,t-s.min-n),s.max+=Math.max(0,t-s.max-n)))}const ns=new ts(Yn.NONE);function ss(e,t,i,r){return t=t||e.viewForward,(0,Pi.c)(r,t),(0,Pi.g)(r,r,Math.sign((0,Pi.e)(t,i))),r}var as=i(316);function os(e,t,i=ns){if(!function(e,t){const i=e.state.constraints.altitude;return!(!e.state.isGlobal||!i||t.interactionType===Kn.TUMBLE&&is(t.selection,Yn.TILT))}(e,i)||!e.state.constraints.altitude)return 0;const r=function(e,t){return t.min=e.min,t.max=e.max,t}(e.state.constraints.altitude,ls);!function(e,t,i){const r=t.interactionType;if(r===Kn.NONE)return;const{min:n,max:s}=i,{interactionStartCamera:a,interactionFactor:o}=t;if(!a)return;const l=r===Kn.TUMBLE||r===Kn.ZOOM,c=os(e,a),h=0===c?0:e.renderCoordsHelper.getAltitude(a.eye);i.min=n,i.max=s,rs(c,h,l,o,.05*h,i)}(e,i,r);const n=e.renderCoordsHelper.getAltitude(t.eye),s=(0,st.uZ)(n,r.min,r.max)-n;return Math.abs(s)<=1e-6?0:s}const ls={min:0,max:0},cs=(0,R.Ue)(),hs=(0,R.Ue)(),us=(0,R.Ue)(),ds=(0,R.Ue)();function ps(e,t,i=ns){if(!e.state.isLocal)return 0;const r=e.state.constraints.distance;if(!e.pointsOfInterest.surfaceOrigin.renderLocation||r===1/0)return 0;fs.min=0,fs.max=r,function(e,t,i){const r=t.interactionType;if(r===Kn.NONE)return;const{min:n,max:s}=i,{interactionStartCamera:a,interactionFactor:o}=t;if(!a)return;const l=r===Kn.ZOOM||r===Kn.PAN,c=ps(e,a),h=0===c?0:ms(e,a);i.min=n,i.max=s,rs(c,h,l,o,.05*h,i)}(e,i,fs);const n=ms(e,t),s=fs.max-n;return s>=-1e-6?0:s}function ms(e,t){const i=e.pointsOfInterest.surfaceOrigin;return i.renderLocation?(0,Pi.j)(t.eye,i.renderLocation):0}const fs={min:0,max:0},_s=(0,R.Ue)(),gs=(0,R.Ue)(),ys=(0,R.Ue)(),vs=(0,R.Ue)(),bs=(0,R.Ue)();var ws,Cs=i(97750);function xs(e,t,i=ws.EYE){const r=e.state.constraints;if(!r.collision.enabled)return!1;const n=(0,Cs.wH)(e,t.eye),s=e.renderCoordsHelper.getAltitude(t.eye),a=n+r.collision.elevationMargin;if(s>=a)return!1;const o=(0,Pi.l)(t.eye);if((0,Pi.d)(Ts,t.center,t.eye),t.eye=e.renderCoordsHelper.setAltitude(Ss,a,t.eye),i===ws.EYE_AND_CENTER)t.center=(0,Pi.f)(Ts,t.eye,Ts);else if(i===ws.EYE_AND_CENTER_SCALE){const e=(o-s+a)/o;t.center=(0,Pi.g)(Ts,t.center,e)}return!0}!function(e){e[e.EYE=0]="EYE",e[e.EYE_AND_CENTER=1]="EYE_AND_CENTER",e[e.EYE_AND_CENTER_SCALE=2]="EYE_AND_CENTER_SCALE"}(ws||(ws={}));const Ts=(0,R.Ue)(),Ss=(0,R.Ue)();var Ms=i(13340);function Es(e,t,i,r=ns,n){if(!e.state.constraints.tilt)return 0;const s=Math.min(t.relativeElevation*Ns,t.distance),a=e.state.constraints.tilt(s,Fs);return function(e,t,i){if(t.interactionType===Kn.NONE)return;const{interactionStartCamera:r,interactionFactor:n}=t;if(!r)return;const{min:s,max:a}=i,o=Es(e,r,ns,t),l=0===o?0:(0,Ms.L)(e.renderCoordsHelper,r.center,r.eye);i.min=s,i.max=a,t.interactionType===Kn.TUMBLE?(is(t.selection,Yn.ALTITUDE)&&As(e,r,i),rs(o,l,!0,n,Ls,i)):rs(o,l,!1,n,Ls,i)}(e,i,a),r.interactionType===Kn.TUMBLE&&is(r.selection,Yn.ALTITUDE)&&As(e,r.interactionStartCamera,a),i.tiltMode===Qn.LOOK_AROUND||r.tiltMode===Qn.LOOK_AROUND?function(e,t,i,r){switch(r&&(r.requiresTwoSteps=!1),e.viewingMode){case"global":return function(e,t,i,r){const n=function(e,t,i){const r=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,n=r+(0,Ii.Iu)(e.spatialReference).radius,s=e.renderCoordsHelper.intersectManifold(t.ray,r,Is);return i.distance=Math.min(t.relativeElevation*Ns,t.distance),i.centerIsOnSurface=!1,null!=s?(i.distance=Math.min(t.relativeElevation*Ns,(0,Pi.j)(t.eye,s)),i.tiltAtCenter=(0,Ms.L)(e.renderCoordsHelper,s,t.eye),i.centerIsOnSurface=!0):e.state.isLocal?i.tiltAtCenter=(0,Ms.L)(e.renderCoordsHelper,t.center,t.eye):((0,es.j)((0,es.b)(es.t,n),t.ray,Is),i.distance=Math.min(t.relativeElevation*Ns,(0,Pi.j)(t.eye,Is)),i.tiltAtCenter=(0,st.ZF)(-(0,Pi.e)(t.viewForward,(0,Pi.n)(Is,Is)))),i.radius=n,i.eyeRadius=(0,Pi.l)(t.eye),i.constraints=e.state.constraints,i}(e,t,Us),s=(0,st.uZ)(n.tiltAtCenter,i.min,i.max);if(!Ps(n.tiltAtCenter-s))return 0;let a,o;return n.centerIsOnSurface?(a=function(e){const{constraints:t,distance:i,tiltAtCenter:r}=e;let n=r,s=t.clampTilt(i,r);const a=Rs(e,s);if(t.clampTilt(a,r)===s)return s;let o=0;for(;o<10&&Ps(s-n);){const i=(n+s)/2,r=Rs(e,i);Ps(t.clampTilt(r,i)-i)?n=i:s=i,o++}return s}(n),o=function(e,t){const i=(0,st.Kt)(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),r=(0,st.Kt)(e.radius/e.eyeRadius*Math.sin(t));return e.eyeRadius>e.radius?i-r:r-i}(n,a)):(a=n.constraints.clampTilt(n.distance,n.tiltAtCenter),r&&a<Math.PI/2&&(r.requiresTwoSteps=!0,a=Math.PI/2-1e-5),o=function(e,t){return e.tiltAtCenter-Math.PI/2-(t-Math.PI/2)}(n,a)),r&&(r.eyeCenterDistance=Rs(n,a)),o}(e,t,i,r);case"local":return function(e,t,i,r){const n=(0,Ms.L)(e.renderCoordsHelper,t.center,t.eye),s=(0,st.uZ)(n,i.min,i.max),a=n-s;if(!Ps(a))return 0;if(r){const i=Math.abs(e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude),n=e.renderCoordsHelper.getAltitude(t.eye)-i,a=Math.max(Math.cos(s),1e-4);Math.abs(a)>1e-4?r.eyeCenterDistance=n/a:r.eyeCenterDistance=t.distance}return a}(e,t,i,r)}}(e,t,a,n):function(e,t,i){const r=(0,Ms.L)(e.renderCoordsHelper,t.center,t.eye),n=r-(0,st.uZ)(r,i.min,i.max);return Ps(n)?n:0}(e,t,a)}function Ps(e){return Math.abs(e)>1e-9}function Rs(e,t){if(!e.centerIsOnSurface)return e.distance;const i=Math.PI-(0,st.uZ)(t,0,Math.PI),r=(0,st.Kt)(e.radius/e.eyeRadius*Math.sin(i)),n=Math.PI-i-r,s=Math.sin(n)/Math.sin(i);if(e.eyeRadius<e.radius&&s>1){const t=Math.PI-r,n=Math.PI-i-t;return Math.sin(n)/Math.sin(i)*e.eyeRadius}return s*e.eyeRadius}function As(e,t,i){const r=e.state.constraints;if(e.state.isLocal||!r.altitude||!t)return;const n=(0,Pi.k)(t.center),s=Math.sqrt(n),a=t.distance,o=(0,Ii.Iu)(e.spatialReference).radius,l=r.altitude.min+o,c=r.altitude.max+o,h=(l*l-a*a-n)/(-2*s*a),u=(c*c-a*a-n)/(-2*s*a);i.min=Math.max(i.min,Math.min(Math.PI-(0,st.ZF)(u),i.max)),i.max=Math.min(i.max,Math.PI-(0,st.ZF)(h))}const Os=(0,R.Ue)(),Ds=(0,Bi.Ue)(),Is=(0,R.Ue)(),Ls=(0,st.Vl)(5),Ns=30,Fs={min:0,max:0},Us={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,distance:0,tiltAtCenter:0},Hs={eyeCenterDistance:0,requiresTwoSteps:!1};var ks=i(87224);const Vs=e=>e*e,Bs=e=>1-Vs(1-e),zs=e=>e<.5?Vs(2*e)/2:(Bs(2*(e-.5))+1)/2,Gs=e=>e*e*e,qs=e=>1-Gs(1-e),Zs=e=>e<.5?Gs(2*e)/2:(qs(2*(e-.5))+1)/2,js=e=>e*e*e*e,Ws=e=>1-js(1-e),$s=e=>e<.5?js(2*e)/2:(Ws(2*(e-.5))+1)/2,Xs=e=>e*e*e*e*e,Ys=e=>1-Xs(1-e),Ks=e=>e<.5?Xs(2*e)/2:(Ys(2*(e-.5))+1)/2,Qs=e=>1-Math.cos(e*Math.PI/2),Js=e=>1-Qs(1-e),ea=e=>e<.5?Qs(2*e)/2:(Js(2*(e-.5))+1)/2,ta=e=>2**(10*(e-1)),ia=e=>1-ta(1-e),ra=e=>e<.5?ta(2*e)/2:(ia(2*(e-.5))+1)/2,na=e=>-(Math.sqrt(1-e*e)-1),sa=e=>1-na(1-e),aa=e=>e<.5?na(2*e)/2:(sa(2*(e-.5))+1)/2;function oa(e){const t=2*(e-Math.sqrt((e-1)*e)),i=t/2/e;return r=>r<i?e*r*r:t*r-t+1}function la(e,t){return(i,r)=>i<t?t*e(i/t,r):1-e((1-i)/(1-t),r)*(1-t)}const ca=la(oa(1),1),ha=la(oa(1),0),ua=la(oa(1),.5),da=la(oa(2),1),pa=la(oa(2),0),ma=la(oa(2),.5),fa=la(oa(3),1),_a=la(oa(3),0),ga=la(oa(3),.5),ya=la(oa(4),1),va=la(oa(4),0),ba=la(oa(4),.5),wa={linear:e=>e,"in-quad":Vs,"out-quad":Bs,"in-out-quad":zs,"in-coast-quad":ca,"out-coast-quad":ha,"in-out-coast-quad":ua,"in-cubic":Gs,"out-cubic":qs,"in-out-cubic":Zs,"in-coast-cubic":da,"out-coast-cubic":pa,"in-out-coast-cubic":ma,"in-quart":js,"out-quart":Ws,"in-out-quart":$s,"in-coast-quart":fa,"out-coast-quart":_a,"in-out-coast-quart":ga,"in-quint":Xs,"out-quint":Ys,"in-out-quint":Ks,"in-coast-quint":ya,"out-coast-quint":va,"in-out-coast-quint":ba,"in-sine":Qs,"out-sine":Js,"in-out-sine":ea,"in-expo":ta,"out-expo":ia,"in-out-expo":ra,"in-circ":na,"out-circ":sa,"in-out-circ":aa,"quad-in":Vs,"quad-out":Bs,"quad-in-out":zs,"quad-in-coast":ca,"quad-out-coast":ha,"quad-in-out-coast":ua,"cubic-in":Gs,"cubic-out":qs,"cubic-in-out":Zs,"cubic-in-coast":da,"cubic-out-coast":pa,"cubic-in-out-coast":ma,"quart-in":js,"quart-out":Ws,"quart-in-out":$s,"quart-in-coast":fa,"quart-out-coast":_a,"quart-in-out-coast":ga,"quint-in":Xs,"quint-out":Ys,"quint-in-out":Ks,"quint-in-coast":ya,"quint-out-coast":va,"quint-in-out-coast":ba,"sine-in":Qs,"sine-out":Js,"sine-in-out":ea,"expo-in":ta,"expo-out":ia,"expo-in-out":ra,"circ-in":na,"circ-out":sa,"circ-in-out":aa,ease:e=>ks.LI.ease(e),"ease-in":e=>ks.LI.easeIn(e),"ease-out":e=>ks.LI.easeOut(e),"ease-in-out":e=>ks.LI.easeInOut(e)};function Ca(e,t,i=Sa,r=t){r!==t&&r.copyFrom(t),r.computeUp(e.state.viewingMode);let n=!1;for(let t=0;t<Ma;t++){let t=0;for(const s of Ta)if(is(i.selection,s.type)){const a=Math.abs(s.error(e,r,i));s.apply(e,r,i)&&(n=!0,t+=a)}if(0===t)break}const s=is(i.selection,Yn.COLLISION),a=function(e,t){switch(e){case Kn.PAN:return ws.EYE_AND_CENTER;case Kn.ASCEND:return t.state.isGlobal?ws.EYE_AND_CENTER_SCALE:ws.EYE_AND_CENTER;default:return ws.EYE}}(i.interactionType,e);return s&&xs(e,r,a)&&(n=!0),n&&r.computeUp(e.state.viewingMode),n}function xa(e){const t=Math.min(1,e/150);return Zs(t)}const Ta=[{type:Yn.TILT,error:function(e,t,i){return Es(e,t,i)*t.distance},apply:function e(t,i,r,n=!0){Hs.eyeCenterDistance=0,Hs.requiresTwoSteps=!1;const s=Es(t,i,r,ns,Hs);if(0===s)return!1;switch((0,Vi.Us)(Ds,-s,i.viewRight),r.tiltMode){case Qn.LOOK_AROUND:(0,Pi.t)(Os,i.viewForward,Ds),(0,Pi.g)(Os,Os,Hs.eyeCenterDistance),i.center=(0,Pi.f)(Is,i.eye,Os);break;case Qn.TUMBLE:(0,Pi.d)(Os,i.center,i.eye),(0,Pi.t)(Os,Os,Ds),i.eye=(0,Pi.d)(Is,i.center,Os);break;default:(0,Hi.Bg)(r.tiltMode)}return i.up=(0,Pi.t)(Is,i.up,Ds),!Hs.requiresTwoSteps||!n||e(t,i,r,!1)}},{type:Yn.ALTITUDE,error:os,apply:function(e,t,i=ns){const r=os(e,t,i);if(0===r)return!1;const n=e.renderCoordsHelper,s=n.getAltitude(t.eye)+r,a=ss(t,i.interactionDirection,function(e,t,i,r){return e.renderCoordsHelper.worldUpAtPosition(t.eye,r),(0,Pi.g)(r,r,i),r}(e,t,Math.sign(r),hs),cs),o=(0,Pi.c)(us,t.viewForward),l=n.intersectInfiniteManifold((0,Jn.re)(t.eye,a),s,ds);return t.eye=null!=l?l:n.setAltitude(ds,s,t.eye),t.center=(0,as.W8)(ds,t.eye,o,t.center),!0}},{type:Yn.DISTANCE,error:ps,apply:function(e,t,i=ns){const r=ps(e,t,i);if(0===r)return!1;const n=e.pointsOfInterest.surfaceOrigin;if(!n.renderLocation)return!1;const s=ms(e,t)+r,a=(0,Pi.c)(_s,t.eye),o=ss(t,i.interactionDirection,function(e,t,i){return(0,Pi.E)(i,e.eye,t)}(t,n.renderLocation,vs),ys);if(!(0,es.i)((0,es.l)(n.renderLocation,s),(0,Jn.re)(t.eye,o),bs))return!1;t.eye=bs;const l=(0,Pi.d)(gs,t.eye,a);t.center=(0,Pi.f)(bs,t.center,l);const c=e.renderCoordsHelper.getAltitude(t.center),h=e.renderCoordsHelper.intersectInfiniteManifold(t.ray,c,bs);return null!=h&&(t.center=h),!0}}],Sa=new ts,Ma=5;var Ea=i(30748);class Pa{get pitch(){return this._pitch}get yaw(){return this._yaw}get distance(){return this._distance}get fov(){return this._fov}get size(){return this._size}constructor(e){this.viewingMode=e,this.center=(0,R.Ue)(),this._pitch=0,this._yaw=0,this._distance=0,this.direction=(0,R.d9)(Fa),this._fov=55,this._size=1}pixelsPerPanAtZoom(e){return this._size/2/(this._zoomToPanScale*e)}zoomAtPixelsPerPan(e){return this._size/2/(this._zoomToPanScale*e)}pixelsPerRotate(){const e=Math.max(Math.cos(Math.abs(this._pitch)),.5);return this._size/2/e}compareTo(e,t){if(this.viewingMode===Ht.JY.Global){const i=((0,Pi.l)(this.center)+(0,Pi.l)(e.center))/2;t.pan=(0,gi.EU)(this.center,e.center)*i}else t.pan=(0,Pi.j)(this.center,e.center);let i=Math.abs(e._yaw-this._yaw);i>=Math.PI&&(i=2*Math.PI-i);const r=Math.abs(e._pitch-this._pitch);t.rotate=Math.max(i,r),t.fov=e.fov-this.fov,t.sourceZoom=this._distance,t.targetZoom=e._distance}interpolate(e,t,i){this.viewingMode===Ht.JY.Global?(0,gi.ZA)(e.center,t.center,i.pan,this.center):(0,Pi.m)(this.center,e.center,t.center,i.pan),this._distance=isFinite(t.distance)?(0,st.t7)(e.distance,t.distance+i.zoomOffset,i.zoom):e.distance,this._pitch=(0,st.t7)(e.pitch,t.pitch,i.rotate);let r=e._yaw;const n=t._yaw;Math.abs(n-r)>=Math.PI&&(r+=2*(r<n?1:-1)*Math.PI),this._yaw=(0,st.t7)(r,n,i.rotate),this._fov=(0,st.t7)(e.fov,t.fov,i.fov)}copyFrom(e){(0,Pi.c)(this.center,e.center),this._pitch=e.pitch,this._yaw=e.yaw,this._distance=e.distance,(0,Pi.c)(this.direction,e.direction),this._size=e.size,this._fov=e.fov,this._zoomToPanScale=Math.atan(.5*this._fov),this.viewingMode=e.viewingMode}copyFromRenderCamera(e){const t=this._lookAtOrientation(e.center,Ha);(0,Pi.c)(this.center,e.center),(0,Pi.d)(Da,e.center,e.eye),(0,Pi.o)(Da,Da,t),(0,Pi.o)(Ia,e.up,t),this._distance=(0,Pi.l)(Da),0!==this._distance&&(Da[0]/=this._distance,Da[1]/=this._distance,Da[2]/=this._distance),this._pitch=function(e){return Math.PI-(0,gi.EU)(Na,e)}(Da),this._yaw=function(e,t){const i=La;return Math.abs(t[2])<.5?((0,Pi.c)(i,t),e[2]>0&&(0,Pi.g)(i,i,-1)):(0,Pi.c)(i,e),(0,Pi.h)(Aa,i,Na),(0,Pi.n)(Aa,Aa),(0,gi.EU)(Ua,Aa,Na)}(Da,Ia),this._size=Math.sqrt(e.width*e.width+e.height*e.height),this._fov=e.fov,this._zoomToPanScale=Math.atan(.5*this._fov)}copyToRenderCamera(e){const t=this._lookAtOrientation(this.center,Ha);(0,ki.p4)(t,t),this._axisAngleVec3(Ua,this._pitch-Math.PI/2,Fa,Da),this._axisAngleVec3(Na,this._yaw,Da,Da),this._axisAngleVec3(Ua,this._pitch-Math.PI/2,Na,Ia),this._axisAngleVec3(Na,this._yaw,Ia,Ia),(0,Pi.g)(Da,Da,this._distance),(0,Pi.o)(Da,Da,t),(0,Pi.o)(Ia,Ia,t),e.center=this.center,e.eye=(0,Pi.d)(Da,this.center,Da),e.up=Ia,e.fov=this._fov}_axisAngleVec3(e,t,i,r){const n=Math.cos(t),s=Math.sin(t);return(0,Pi.g)(Ra,i,n),(0,Pi.h)(Aa,e,i),(0,Pi.g)(Aa,Aa,s),(0,Pi.g)(Oa,e,(1-n)*(0,Pi.e)(e,i)),(0,Pi.f)(r,(0,Pi.f)(r,Ra,Aa),Oa)}_lookAtOrientation(e,t=(0,Ea.Ue)()){return this._upAtLookAt(e,Oa),(0,Pi.h)(Ra,this.direction,Oa),(0,Pi.n)(Ra,Ra),0===Ra[0]&&0===Ra[1]&&0===Ra[2]&&(0,Pi.c)(Ra,Ua),(0,Pi.h)(Aa,Oa,Ra),(0,Pi.n)(Aa,Aa),t[0]=Ra[0],t[1]=Aa[0],t[2]=Oa[0],t[3]=Ra[1],t[4]=Aa[1],t[5]=Oa[1],t[6]=Ra[2],t[7]=Aa[2],t[8]=Oa[2],t}_upAtLookAt(e,t){return this.viewingMode===Ht.JY.Local?(0,Pi.c)(t,Na):(0,Pi.n)(t,e)}}const Ra=(0,R.Ue)(),Aa=(0,R.Ue)(),Oa=(0,R.Ue)(),Da=(0,R.Ue)(),Ia=(0,R.Ue)(),La=(0,R.Ue)(),Na=R.eG,Fa=R.IO,Ua=R.E9,Ha=(0,Ea.Ue)();var ka=i(66130);class Va{constructor(){this.pan=0,this.rotate=0,this.fov=0,this.sourceZoom=0,this.targetZoom=0}}const Ba={desiredScreenFlow:2,minDuration:(0,ur.HA)(500),maxDuration:(0,ur.HA)(8e3)};(0,ur.HA)(4e3);class za{constructor(e){this._createCamera=e,this.compared=new Va,this.segmentStart=0,this.segmentEnd=1,this.settings={desiredScreenFlow:Ba.desiredScreenFlow},this.source=e(),this.target=e()}clone(){const e=new za(this._createCamera);return e.copyFrom(this),e}copyFrom(e){this.update(e.source,e.target,e.settings)}update(e,t,i){this.source!==e&&this.source.copyFrom(e),this.target!==t&&this.target.copyFrom(t),this.source.compareTo(this.target,this.compared),this.settings.desiredScreenFlow=i.desiredScreenFlow??Ba.desiredScreenFlow,this.desiredPixelFlow=this.settings.desiredScreenFlow*this.target.size,this.halfWindowSize=this.target.size/2}halfWindowPanAtZoom(e){const t=this.target.pixelsPerPanAtZoom(e);return this.halfWindowSize/t}get hasZoom(){return Math.abs(this.compared.sourceZoom-this.compared.targetZoom)>1e-5}get hasPan(){return this.compared.pan>(0,ka.bn)()}get hasFov(){return Math.abs(this.compared.fov)>(0,ka.bn)()}get hasRotate(){return this.compared.rotate>(0,ka.bn)()}}let Ga=class{constructor(){this.segments=new Array}get time(){return this.segments.reduce(((e,t)=>(0,ur._H)(e+t.time)),(0,ur._H)(0))}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1),e*=this.time;let i=0,r=0;const n=this.definition,s=this.segments.reduce(((e,t)=>e||t.definition.hasZoom),!1);for(let a=0;a<this.segments.length;a++){const o=this.segments[a],l=o.definition;if(e<=o.time||a===this.segments.length-1){if(this.segmentInterpolateComponentsAt(o,0===o.time?0:e/o.time,t),n.hasPan&&!isNaN(t.pan)&&isFinite(n.compared.pan)?t.pan=(i+l.compared.pan*t.pan)/n.compared.pan:t.pan=1,n.hasRotate&&!isNaN(t.rotate)&&isFinite(n.compared.rotate)?t.rotate=(r+l.compared.rotate*t.rotate)/n.compared.rotate:t.rotate=1,s&&!isNaN(t.zoom)&&isFinite(l.compared.targetZoom)){const{sourceZoom:e,targetZoom:i}=l.compared,r=t.zoom*(i-e)+e,n=this.segments[0].definition.compared.sourceZoom,s=this.segments[this.segments.length-1].definition.compared.targetZoom,a=Math.abs(i-n)>Math.abs(e-n)?i:e;t.zoomOffset=a-s,t.zoom=(r-n)/(a-n)}else t.zoom=1;return t}e-=o.time,i+=l.compared.pan,r+=l.compared.rotate}}segmentInterpolateComponentsAt(e,t,i){e.interpolateComponentsAt(t,i)}};class qa{get time(){return this._time}constructor(e){e&&this.update(e)}update(e){e&&(this.definition?this.definition.copyFrom(e):this.definition=e.clone()),this._updatePrecomputedVariables(),this._updatePixelFlow()}_updatePrecomputedVariables(){const e=this.definition,t=e.compared,i=t.sourceZoom,r=t.targetZoom;this._zoomSign=i>r?1:-1,this._panPixelsAtSource=t.pan*e.source.pixelsPerPanAtZoom(i);const n=(e.source.pixelsPerRotate()+e.target.pixelsPerRotate())/2;this._rotatePixels=t.rotate*n}_updatePixelFlow(){const e=this.definition.compared.sourceZoom,t=this.definition.compared.targetZoom,{hasZoom:i,hasPan:r,hasRotate:n}=this.definition;let s=0,a=0;i&&(r&&(s=(t/e-1)/(-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2*this._panPixelsAtSource)),n&&(a=this._zoomSign*(Math.log(e/t)/Math.LN2)*this.definition.halfWindowSize/this._rotatePixels)),this._zoomPixelFlow=0,this._panPixelFlow=0,this._rotatePixelFlow=0;const o=this.definition.desiredPixelFlow;if(i&&r&&n){const e=s+a+s*a;this._zoomPixelFlow=s*a/e*o,this._panPixelFlow=a/e*o,this._rotatePixelFlow=s/e*o}else if(i&&r){const e=1+s;this._zoomPixelFlow=s/e*o,this._panPixelFlow=1/e*o}else if(i&&n){const e=1+a;this._zoomPixelFlow=a/e*o,this._rotatePixelFlow=1/e*o}else if(r&&n){const e=this._panPixelsAtSource/this._rotatePixels,t=1+e;this._panPixelFlow=e/t*o,this._rotatePixelFlow=1/t*o}else r?this._panPixelFlow=o:i?this._zoomPixelFlow=o:n&&(this._rotatePixelFlow=o);if(this._time=(0,ur._H)(Math.max(this.rotateTime,this.zoomTime,this.panTime)),this.fovTime>this._time){const e=this.fovTime/this._time;this._time=this.fovTime,this._zoomPixelFlow/=e,this._panPixelFlow/=e,this._rotatePixelFlow/=e}}get rotateTime(){return this.definition.hasRotate?(0,ur._H)(this._rotatePixels/this._rotatePixelFlow):(0,ur._H)(0)}get zoomTime(){return this.definition.hasZoom?(0,ur._H)(this._zoomSign*(Math.log(this.definition.compared.sourceZoom/this.definition.compared.targetZoom)/Math.LN2)*this.definition.halfWindowSize/this._zoomPixelFlow):(0,ur._H)(0)}get fovTime(){return this.definition.hasFov?(0,ur._H)(Math.abs(this.definition.compared.fov)/Za):(0,ur._H)(0)}get panTime(){if(!this.definition.hasPan)return(0,ur._H)(0);if(this.definition.hasZoom){const e=-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2,t=e*this._panPixelsAtSource;return(0,ur._H)(Math.log(t*(this._zoomPixelFlow/this._panPixelFlow)+1)/(e*this._zoomPixelFlow))}return(0,ur._H)(this._panPixelsAtSource/this._panPixelFlow)}_interpolateComponentsZoom(e){if(0===e||1===e)return e;if(this.definition.hasZoom){const t=this.definition.compared.sourceZoom,i=this.definition.compared.targetZoom;return(t*(t/i)**-e-t)/(i-t)}return e}_interpolateComponentsFov(e){if(0===e)return this.definition.segmentStart;if(1===e)return this.definition.segmentEnd;if(this.definition.hasFov){const{segmentStart:t,segmentEnd:i}=this.definition;return t+e*(i-t)}return this.definition.segmentStart}_interpolateComponentsPan(e){if(0===e||1===e)return e;if(this.definition.hasPan&&this.definition.hasZoom){const t=-1/(this._zoomSign*this.definition.halfWindowSize)*this._zoomPixelFlow;return 1/this._panPixelsAtSource*(this._panPixelFlow*(2**(t*e*this._time)-1))/(t*Math.LN2)}return e}_interpolateComponentsRotate(e){return e}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1),t.zoom=this._interpolateComponentsZoom(e),t.pan=this._interpolateComponentsPan(e),t.rotate=this._interpolateComponentsRotate(e),t.zoomOffset=0,t.fov=this._interpolateComponentsFov(e)}}const Za=(0,st.Vl)(45);function ja(e,t,i){const r=t-e.compared.sourceZoom,n=e.halfWindowPanAtZoom(r);return-e.halfWindowSize*(i.ascensionFactor*Math.LN2*e.compared.pan+n)*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2*n)}function Wa(e,t,i){const r=1/t,n=Math.log(e.compared.sourceZoom*r),s=1/e.desiredPixelFlow,a=1/Math.LN2,o=t-e.compared.sourceZoom,l=1/o,c=(i.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(o))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*r*s*a*l*c-e.halfWindowSize*n*s*a*l+e.halfWindowSize*n*s*a*c/(o*o)}function $a(e,t,i){const r=t-e.compared.sourceZoom,n=1/r,s=1/t,a=Math.log(e.compared.sourceZoom*s),o=(i.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(r))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*n*(-2*n*s*o+2*n*a+2*s-2*a*o/(r*r)-o/(t*t))/(e.desiredPixelFlow*Math.LN2)}function Xa(e,t){return-e.halfWindowSize*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2)}function Ya(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function Ka(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}function Qa(e,t,i){return e.halfWindowSize*(-e.halfWindowPanAtZoom(t)-i.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*e.halfWindowPanAtZoom(-t+e.compared.targetZoom))}function Ja(e,t,i){const r=Math.log(t/e.compared.targetZoom),n=1/e.desiredPixelFlow,s=1/Math.LN2,a=-t+e.compared.targetZoom,o=1/a,l=(-e.halfWindowPanAtZoom(t)-i.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return-e.halfWindowSize*r*n*s*o+e.halfWindowSize*r*n*s*l/(a*a)+e.halfWindowSize*n*s*o*l/t}function eo(e,t,i){const r=t-e.compared.targetZoom,n=1/r,s=1/t,a=Math.log(t/e.compared.targetZoom),o=(e.halfWindowPanAtZoom(t)+i.descensionFactor*Math.LN2*e.compared.pan-e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*n*(-2*n*s*o-2*n*a+2*s+2*a*o/(r*r)-o/(t*t))/(e.desiredPixelFlow*Math.LN2)}function to(e,t){return e.halfWindowSize*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2)}function io(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function ro(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}function no(e,t){let i=function(e,t){const i=Math.max(e.compared.sourceZoom,e.compared.targetZoom),r=e.source.zoomAtPixelsPerPan(e.desiredPixelFlow/e.compared.pan)/2;return r<i?null!=t.maximumDistance?i+(t.maximumDistance-i)/2:1.5*i:t.maximumDistance?Math.min(t.maximumDistance,r):r}(e,t);const r={ascensionFactor:null!=t.ascensionFactor?t.ascensionFactor:.5,descensionFactor:null!=t.descensionFactor?t.descensionFactor:.5},n=0===r.ascensionFactor,s=0===r.descensionFactor,a=n?Xa:ja,o=n?Ya:Wa,l=n?Ka:$a,c=s?to:Qa,h=s?io:Ja,u=s?ro:eo,d=t=>a(e,t,r)+function(e,t,i){return-e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t))}(e,t,r)+c(e,t,r),p=t=>o(e,t,r)+function(e,t,i){return e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t))}(e,t,r)+h(e,t,r),m=t=>l(e,t,r)+function(e,t,i){return-2*e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t*t))}(e,t,r)+u(e,t,r);let f=d(i);const _=function(e){const t=e.compared.sourceZoom-e.compared.targetZoom;if(0===t)return e.compared.pan*e.halfWindowSize/(e.desiredPixelFlow*e.halfWindowPanAtZoom(e.compared.sourceZoom));const i=Math.LN2*e.compared.pan,r=t,n=e.halfWindowPanAtZoom(r),s=e.halfWindowSize*Math.log(e.compared.sourceZoom/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*n);return e.compared.sourceZoom<=e.compared.targetZoom?s*(i-n):s*(i+n)}(e);let g;const y=t.maximumIterations||20,v=null!=t.maximumDistance?t.maximumDistance:1/0;for(g=0;g<y;g++){const r=t.desiredSlope??1e-6;let n=p(i);Math.abs(n)>r&&(n+=r);const s=n/m(i);if(isNaN(s)||i>=v&&s<0){if(!isFinite(v))return null;i=v,f=d(i);break}if(i-=s,i<=e.compared.sourceZoom||i<=e.compared.targetZoom)return null;const a=d(i);if(Math.abs(a-f)/f<=.005)break;f=a}return isNaN(f)||f>.7*_||i<=e.compared.sourceZoom||i<=e.compared.targetZoom?null:i}class so extends Ga{constructor(e,t){super(),this._preallocSegments=[new qa,new qa,new qa],this._ascensionSegment=null,this._descensionSegment=null,this.update(e,t)}update(e,t){if(!e)return;this.definition?this.definition.copyFrom(e):this.definition=e.clone();const i=t?.apex?no(e,t.apex):null;this.segments.length=0,this._ascensionSegment=null,this._descensionSegment=null,i?this._updateWithApex(i,t?.apex):this._updateWithoutApex()}segmentInterpolateComponentsAt(e,t,i){e.interpolateComponentsAt(t,i),e===this._ascensionSegment?i.zoom=Bs(i.zoom):e===this._descensionSegment&&(i.zoom=Vs(i.zoom))}_updateWithApex(e,t){const[i,r,n]=this._preallocSegments,s=t?.ascensionFactor??.5,a=Math.min(1-s,null!=t?.ascensionFactor&&null!=t.descensionFactor?t.descensionFactor:.5),o=1-s-a;i.definition?i.definition.copyFrom(this.definition):i.definition=this.definition.clone(),i.definition.compared.targetZoom=e,i.definition.compared.pan=this.definition.compared.pan*s,i.definition.compared.rotate=this.definition.compared.rotate*s,i.definition.segmentEnd=s,i.update(),this._ascensionSegment=i,this.segments.push(i),o>0&&(r.definition?r.definition.copyFrom(this.definition):r.definition=this.definition.clone(),r.definition.copyFrom(this.definition),r.definition.compared.sourceZoom=e,r.definition.compared.targetZoom=e,r.definition.compared.pan=this.definition.compared.pan*o,r.definition.compared.rotate=this.definition.compared.rotate*o,r.definition.segmentStart=i.definition.segmentEnd,r.definition.segmentEnd=i.definition.segmentEnd+o,r.update(),this.segments.push(r)),n.definition?n.definition.copyFrom(this.definition):n.definition=this.definition.clone(),n.definition.compared.sourceZoom=e,n.definition.compared.pan=this.definition.compared.pan*a,n.definition.compared.rotate=this.definition.compared.rotate*a,n.definition.segmentStart=s+o,n.update(),this._descensionSegment=n,this.segments.push(n)}_updateWithoutApex(){const[e]=this._preallocSegments;e.update(this.definition),this.segments.push(e)}}const ao=new class{constructor(){this.pan=0,this.rotate=0,this.zoom=0,this.fov=0,this.zoomOffset=0}};class oo{get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}constructor(e){this.currentTime=(0,ur.HA)(0),this._animation=new class{get time(){return this._time}get isLinear(){return 1===this.path.segments.length}constructor(e){this._time=(0,ur.HA)(0),this._easing=ua,this.definition=new za(e),this.path=new so}update(e,t,i){this.definition.update(e,t,i),this.path.update(this.definition,i),this._time=this._applyTimeSettings((0,ur.up)(isFinite(this.path.time)?this.path.time:(0,ur._H)(0)),i),this._easing=i.easing??(this._time>=1e3?ua:ia)}cameraAt(e,t){e=Math.min(Math.max(0,e),1),e=this._normalizedEasing(e);const i=this.path.interpolateComponentsAt(e,ao);t.interpolate(this.definition.source,this.definition.target,i)}_normalizedEasing(e){const t=this._easing(0,this._time),i=this._easing(1,this._time);return(this._easing(e,this._time)-t)/(i-t)}_applyTimeSettings(e,t){const i=null!=t.speedFactor?t.speedFactor:1,r=t.minDuration??Ba.minDuration/i,n=t.maxDuration??Ba.maxDuration/i;return null!=t.duration?(0,ur.HA)(t.duration):(0,ur.HA)(Math.min(Math.max(e/i,r),n))}}((()=>new Pa(e))),this._current=new Pa(e)}update(e,t,i){const{source:r,target:n}=this._animation.definition,s=(0,Pi.d)(lo,t.center,e.center),a=(0,Pi.l)(s);a>=1e-5?(s[0]/=a,s[1]/=a,s[2]/=a):(s[0]=0,s[1]=1,s[0]=0),(0,Pi.c)(r.direction,s),(0,Pi.c)(n.direction,s),r.copyFromRenderCamera(e),n.copyFromRenderCamera(t),this._current.copyFrom(r),this._animation.update(r,n,i),this.currentTime=(0,ur.HA)(0),e.almostEquals(t)&&(this.currentTime=this._animation.time)}cameraAt(e,t){this._animation.cameraAt(e,this._current),this._current.copyToRenderCamera(t)}step(e,t){this.finished||(this.currentTime=(0,ur.HA)(this.currentTime+(0,ur.up)(e)),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,t)}}const lo=(0,R.Ue)();var co;!function(e){e[e.Ready=0]="Ready",e[e.Rejected=1]="Rejected",e[e.Running=2]="Running",e[e.Stopped=3]="Stopped",e[e.Finished=4]="Finished"}(co||(co={}));let ho=class extends S.Z{constructor(e){super(e),this.state=co.Ready}get running(){return this.state===co.Running}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.canStop&&(this.state=co.Stopped,!0)}finishController(){this.state=co.Finished}get steppingFinished(){return!1}};(0,r._)([(0,w.Cb)({constructOnly:!0})],ho.prototype,"view",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],ho.prototype,"running",null),(0,r._)([(0,w.Cb)()],ho.prototype,"state",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],ho.prototype,"isInteractive",null),ho=(0,r._)([(0,x.j)("esri.views.3d.state.controllers.CameraController")],ho);let uo=class extends ho{constructor(){super(...arguments),this._asyncResult=null}get canStop(){return!0}set asyncResult(e){this._asyncResult&&(this._asyncResult.reject((0,f.zE)()),this._asyncResult=null),this.state===co.Finished||this.state===co.Stopped?((0,p.O3)(e),this.state===co.Finished?e.resolve():e.reject((0,f.zE)())):this._asyncResult=e}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=co.Running,null!=this.viewAnimation&&this.viewAnimation.when((()=>this.updateStateFromViewAnimation()),(()=>this.updateStateFromViewAnimation()))}updateStateFromViewAnimation(){!this.viewAnimation||this.state!==co.Ready&&this.state!==co.Running||(this.viewAnimation.state===ni.State.FINISHED?this.finish():this.viewAnimation.state===ni.State.STOPPED&&(this.state=co.Stopped))}onControllerEnd(e){null==this.viewAnimation||this.viewAnimation.done||(this.state===co.Finished?this.viewAnimation.finish():this.state===co.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===co.Finished?this._asyncResult.resolve():this._asyncResult.reject((0,f.zE)()))}finish(){this.finishController()}};uo=(0,r._)([(0,x.j)("esri.views.3d.state.controllers.AnimationController")],uo);var po=i(48636),mo=i(92490);let fo=class extends uo{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.type="point-to-point",this.mode="interaction",this._hasTarget=!1}initialize(){this.animation=new oo(this.view.state.viewingMode),this.viewAnimation="interaction"===this.mode?null:new ni}get isInteractive(){return"interaction"===this.mode}begin(e,t){this._hasTarget=!0;const i=this.animationSettings(t);_o.copyFrom(this.view.state.camera);const r=new mo.r(this.view.state.viewingMode);this._intersectionHelper.intersectRay(_o.ray,r,go)&&(_o.center=go),this.animation.update(_o,e,i),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}get steppingFinished(){return this._hasTarget&&this.animation.finished}stepController(e,t){this._hasTarget&&this.animation.step(e,t)}onControllerEnd(e){this._hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),super.onControllerEnd(e)}animationSettings(e={}){return{apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0},...e,easing:"string"==typeof e.easing?wa[e.easing]:e.easing}}};(0,r._)([(0,w.Cb)({constructOnly:!0})],fo.prototype,"mode",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],fo.prototype,"isInteractive",null),fo=(0,r._)([(0,x.j)("esri.views.3d.state.controllers.PointToPointAnimationController")],fo);const _o=new po.Z,go=(0,R.Ue)();function yo(e){return null!=e&&"type"in e&&"point-to-point"===e.type}var vo=i(95437),bo=i(18156),wo=i(21117),Co=i(63271),xo=i(69811);function To(e=Po){return[e[0],e[1],e[2],e[3]]}function So(e,t){return Mo(e[0],e[1],e[2],t,xo.o6.get())}function Mo(e,t,i,r,n=To()){return n[0]=e,n[1]=t,n[2]=i,n[3]=r,n}function Eo(e,t,i){return(0,Pi.h)(i,e,t),(0,Pi.n)(i,i),i[3]=(0,Co.EU)(e,t),i}const Po=[0,0,1,0];(0,wo.Ue)(),(0,wo.Ue)();var Ro=i(77773),Ao=i(13445);function Oo(e,t,i,r){const n=(0,Ao.iE)(t,i,Do);return(0,es.i)(e,n,r)}const Do=(0,Jn.Ue)();var Io,Lo=i(43925);!function(e){e[e.Ellipsoid=0]="Ellipsoid",e[e.Silhouette=1]="Silhouette"}(Io||(Io={}));const No=[1,3e8],Fo=1508e5,Uo={exclude:new Set([Lo.xX])};function Ho(e,t,i){return i[0]=t[0]/(e.fullWidth/e.pixelRatio),i[1]=t[1]/(e.fullHeight/e.pixelRatio),i}function ko(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function Vo(e,t,i){const r=(0,Vi.Us)(xo.MP.get(),i[3],i);null==r||(0,Vi.I6)(r,Bi.Wd)||((0,Pi.d)(Ll,e.eye,t),(0,Pi.t)(Ll,Ll,r),e.eye=(0,Pi.f)(Ll,Ll,t),(0,Pi.d)(Ll,e.center,t),(0,Pi.t)(Ll,Ll,r),e.center=(0,Pi.f)(Ll,Ll,t),e.up=(0,Pi.t)(Ll,e.up,r))}function Bo(e,t,i,r){return(0,Ro.BR)(e,(0,Ao.iE)(t,i,kl),r)}function zo(e,t,i,r){const n=xo.WM.get();let s=1-i;(0,Pi.d)(n,t,e.eye);const a=(0,Pi.l)(n);let o=a*(1-s);s>=0&&o<r&&(o=r,s=-(o-a)/a),Math.abs(a-o)<1e-6||((0,Pi.g)(n,n,s),e.eye=(0,Pi.f)(Ll,e.eye,n),e.center=(0,Pi.m)(Ll,e.center,t,s))}function Go(e,t,i){t.getScreenCenter(qo),Oo(e,t,qo,Ll)&&(t.center=Ll);const r=t.distance,n=r*i;if(Math.abs(r-n)<1e-6)return;const s=(0,Pi.g)(xo.WM.get(),t.viewForward,n);t.eye=(0,Pi.d)(Ll,t.center,s)}const qo=(0,y.s1)();function Zo(e,t){(0,Pi.i)(t,0,0,0);for(const i of e)(0,Pi.f)(t,t,i);(0,Pi.g)(t,t,1/e.length)}function jo(e,t,i,r){return Math.sin(e/(0,Pi.l)(t))*(i+r.radius)}function Wo(e,t,i,r){return jo(Math.PI/2,t,i,r)+(e-Math.PI/2)}var $o;!function(e){e[e.Vertical=0]="Vertical",e[e.Horizontal=1]="Horizontal"}($o||($o={}));const Xo={Elevation:3e4,Angle:(0,st.Vl)(16)},Yo=(0,st.Vl)(80);function Ko(e,t,i,r,n,s){const a=(0,R.Ue)(),o=(0,es.c)();let l=!0,c=!0;return e.intersectScreen(i,a,s)?o[3]=(0,Pi.l)(a):(c=!1,t.aboveGround&&n!==Io.Ellipsoid?o[3]=Math.max((0,Pi.l)(t.center),.9*r):o[3]=(0,Pi.l)(t.eye)-t.relativeElevation,n===Io.Silhouette?tl(o,t,i,a):l=Oo(o,t,i,a)),{sphere:o,scenePickPoint:l?a:null,hasGeometryIntersection:c}}function Qo(e,t,i,r){const n=e.relativeElevation;if(n>Xo.Elevation&&"global"===r)return $o.Horizontal;(0,Ao.iE)(e,t,Vl);const s=Math.sign(n),a=i.worldUpAtPosition(e.eye,Ll);return-s*(0,Pi.e)(a,Vl.direction)<Math.sin(Xo.Angle)*(0,Pi.l)(Vl.direction)?$o.Vertical:$o.Horizontal}function Jo(e,t,i){(0,Pi.d)(el,i,t),e.eye=(0,Pi.d)(Ll,e.eye,el),e.center=(0,Pi.d)(Ll,e.center,el)}const el=(0,R.Ue)();function tl(e,t,i,r){const n=(0,Ao.iE)(t,i,kl);return!(null==n||((0,es.j)(e,n,il),(0,es.i)(e,n,r)?(0,Pi.s)(il,n.origin)<(0,Pi.s)(r,n.origin)&&((0,Pi.c)(r,il),1):((0,Pi.d)(rl,t.eye,t.center),(0,Pi.n)(rl,rl),(0,Ro.Oy)(rl,-(0,Pi.e)((0,Pi.n)(rl,rl),il),nl),(0,Ro.BR)(nl,n,r),1)))}const il=(0,R.Ue)(),rl=(0,R.Ue)(),nl=(0,Ro.Ue)();function sl(e,t,i,r,n,s){let a=0;if((0,Pi.h)(Ul,e,t),(0,Pi.d)(Nl,e,t),(0,Pi.l)(e)<=n||!r.aboveGround){(0,Pi.h)(i,Nl,r.eye);const o=(0,Pi.e)(e,t)/((0,Pi.l)(e)*(0,Pi.l)(t));if(o<.9999)a=(0,st.ZF)(o);else{const i=(0,Pi.l)((0,Pi.h)((0,R.Ue)(),e,t))/((0,Pi.l)(e)*(0,Pi.l)(t));a=(0,st.Kt)(i)}const l=Math.cos((0,st.uZ)(vo.Q4.normalize((0,st.Vl)(s)),0,Yo));a=-a-Math.max(0,(0,Pi.l)(t)-n)/(l*n)}else(0,Pi.d)(al,r.eye,r.center),(0,Pi.h)(i,Nl,al),a=-(0,Pi.l)(Nl)/n;return(0,Pi.n)(i,i),(0,Pi.g)(i,i,(0,Pi.l)(Ul)),a}const al=(0,R.Ue)();function ol(e,t,i,r){let n,s;const a=Math.cos((0,st.uZ)(vo.Q4.normalize((0,st.Vl)(r)),0,Yo));return n=t>i?-(t-i)/(a*i):t<-i?Math.PI-(t+i)/(a*i):(0,st.ZF)(t/i),s=e>i?-(e-i)/(a*i):e<-i?Math.PI-(e+i)/(a*i):(0,st.ZF)(e/i),(s-n)*i}function ll(e,t,i,r,n,s,a,o,l,c){(0,Pi.h)(Ul,e,t),(0,k.Tz)(s.up,s.eye,xl,Tl,Sl),(0,k.Tz)([0,0,1],s.eye,bl,wl,Cl),(0,Pi.c)(i,wl),(0,Pi.c)(r,bl),(0,Pi.n)(i,i),(0,Pi.g)(i,i,(0,Pi.l)(Ul)),(0,k.yS)(e,(0,Pi.n)(Tl,Tl),(0,Pi.n)(Sl,Sl),(0,Pi.n)(xl,xl),Ml),(0,k.yS)(t,Tl,Sl,xl,El),function(e,t,i,r,n,s,a,o,l,c){const h=ol(e[2],t[2],s[3],o),u=l?ol(e[0],t[0],s[3],180):t[0]-e[0],d=Math.sin(a)*u-Math.cos(a)*h,p=Math.cos(a)*u+Math.sin(a)*h;(0,Pi.n)(Ll,n);const m=l?d/Math.sqrt(Math.abs(s[3]**2-(0,Pi.e)(i,Ll)**2)):d/s[3],f=p/Math.sqrt(Math.abs(s[3]**2-(0,Pi.e)(i,r)**2));(0,zi.t8)(c,m,f)}(Ml,El,e,bl,wl,a,o,l,c,n)}function cl(e,t,i,r,n,s,a){(0,Vi.Us)(Al,n,r),(0,Vi.Us)(Ol,a,s),(0,Vi.Jp)(Dl,Al,Ol),(0,Pi.d)(t,e,i),(0,Pi.t)(t,t,Dl),(0,Pi.f)(t,t,i)}function hl(e,t,i,r,n,s){(0,Vi.Us)(Al,r,i),(0,Vi.Us)(Ol,s,n),(0,Vi.Jp)(Dl,Al,Ol),(0,Pi.d)(Ll,e.eye,t),(0,Pi.t)(Ll,Ll,Dl),e.eye=(0,Pi.f)(Ll,Ll,t),(0,Pi.d)(Ll,e.center,t),(0,Pi.t)(Ll,Ll,Dl),e.center=(0,Pi.f)(Ll,Ll,t),(0,Pi.d)(Ll,e.up,t),(0,Pi.t)(Ll,Ll,Dl),e.up=(0,Pi.f)(Ll,Ll,t)}const ul=.95,dl=(0,st.Vl)(18),pl=45,ml=1e-7;let fl=!1;function _l(e,t,i,r,n,s){const a=Math.abs(r)>Math.PI-dl||Math.abs(r)<dl,o=(Math.abs(e[2])<i*ul||Math.abs(t)>i)&&s;return a&&o?!fl&&n<pl-ml?fl=!0:fl&&n>pl+ml&&(fl=!1):fl=!1,fl}function gl(e,t,i,r,n,s){if(s)Eo(i,r,Rl),Vo(t,(0,es.a)(e),Rl);else{const s=sl(i,r,Hl,t,e[3],n);Vo(t,(0,es.a)(e),So(Hl,s))}}function yl(e,t,i,r,n,s,a){const o=a?20:1;let l,c;(0,Pi.c)(Il,r),Fl.copyFrom(t);for(let r=0;r<o&&(0,Pi.s)(i,Il)>1e-12&&(l=(0,Pi.s)(i,Il),ll(i,Il,wl,bl,Pl,Fl,e,n,s,a),hl(Fl,(0,es.a)(e),bl,Pl[1],wl,Pl[0]),cl(Il,Il,(0,es.a)(e),bl,Pl[1],wl,Pl[0]),c=(0,Pi.s)(i,Il),c<l||0===r);r++)t.copyFrom(Fl)}function vl(e,t,i,r,n,s,a,o,l){_l(e.center,(0,Pi.e)(e.up,e.center),(0,Pi.l)(e.center),-vo.Q4.normalize((0,st.Vl)(s)),a,t.aboveGround)?function(e,t,i,r,n,s){const{eye:a}=e;(0,k.Tz)([0,0,1],a,bl,wl,Cl);const o=t.translation[0]*i.pan,l="zoom"===n.mode?0:t.translation[1]*i.pan,c=Math.max(Math.sqrt(Math.abs(1-(0,Pi.e)(e.center,bl)**2/(0,Pi.l)(e.center)**2)),.5),h=(Math.sin(s)*l+Math.cos(s)*o)/c,u=-Math.cos(s)*l+Math.sin(s)*o;switch((0,Vi.U1)(r.pan.matrix,r.pan.matrix,h,bl),r.pan.enabled=!0,n.mode){case"pan":(0,Vi.U1)(r.pan.matrix,r.pan.matrix,u,wl),r.pan.enabled=!0;break;case"zoom":r.zoom=-t.translation[1]*i.zoom}}(t,i,r,o,l,-vo.Q4.normalize((0,st.Vl)(n))):function(e,t,i,r,n){const{eye:s,viewRight:a}=e,o=(0,Pi.h)(xo.WM.get(),a,s),l=t.translation[0]*i.pan;switch(0!==l&&((0,Vi.U1)(r.pan.matrix,r.pan.matrix,-l,o),r.pan.enabled=!0),n.mode){case"pan":{const e=t.translation[1]*i.pan;0!==e&&((0,Vi.U1)(r.pan.matrix,r.pan.matrix,e,a),r.pan.enabled=!0);break}case"zoom":r.zoom=-t.translation[1]*i.zoom}}(t,i,r,o,l)}const bl=(0,R.Ue)(),wl=(0,R.Ue)(),Cl=(0,R.Ue)(),xl=(0,R.Ue)(),Tl=(0,R.Ue)(),Sl=(0,R.Ue)(),Ml=(0,R.Ue)(),El=(0,R.Ue)(),Pl=(0,Gi.Ue)(),Rl=To(),Al=(0,Bi.Ue)(),Ol=(0,Bi.Ue)(),Dl=(0,Bi.Ue)(),Il=(0,R.Ue)(),Ll=(0,R.Ue)(),Nl=(0,R.Ue)(),Fl=new po.Z,Ul=(0,R.Ue)(),Hl=(0,R.Ue)(),kl={origin:(0,R.Ue)(),direction:(0,R.Ue)()},Vl={origin:(0,R.Ue)(),direction:(0,R.Ue)()};let Bl=class extends fo{constructor(){super(...arguments),this._zoomLocation=(0,R.Ue)(),this._tmpCamera=new po.Z,this._tmpViewDir=(0,R.Ue)(),this._tmpRayDir=(0,Jn.Ue)(),this._targetOnSphere=(0,R.Ue)(),this._tmpCenter=(0,R.Ue)(),this._beginCamera=new po.Z,this._constraintOptions=new ts(Yn.ALL_EXCEPT_COLLISION,Kn.ZOOM,null,this._beginCamera),this._sphere=(0,es.c)()}initialize(){this._intersector=new mo.r(this.view.state.viewingMode)}step(e,t){if(!this.running)return;const i=this.view.state;this.animation.finished?this._beginCamera.copyFrom(i.camera):this.animation.cameraAt(1,this._beginCamera);let r=!1,n=!1;this._intersectionHelper.intersectScreen(t,this._zoomLocation,0===this.view.map.ground.opacity?Uo:{})&&(r=e>0,n=!0),this._tmpCamera.copyFrom(i.camera),r?this._intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter):this._intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:(0,Pi.c)(this._zoomLocation,this._tmpCamera.center),this._updateCamera(this._tmpCamera,e,t,n),this.begin(this._tmpCamera)}animationSettings(){return{duration:(0,ur.HA)(600),easing:ia}}_updateCamera(e,t,i,r){const n=Qo(e,i,this.view.renderCoordsHelper,this.view.viewingMode),s=Math.abs(this.view.camera.position.z),a=this._zoomLocation;(0,Pi.n)(Gl,e.eye),(0,Pi.g)(Gl,Gl,-1),(0,Ao.iE)(e,i,this._tmpRayDir),(0,Pi.n)(this._tmpRayDir.direction,this._tmpRayDir.direction);const o=(0,st.uZ)(Math.min(8,1/Math.abs((0,Pi.e)(Gl,this._tmpRayDir.direction)))*s,200,Fo);if(n===$o.Horizontal){let r=.6**t;this._sphere[3]=(0,Pi.l)(a),(0,Pi.d)(this._tmpViewDir,e.center,e.eye);const n=Math.min((0,Pi.l)(this._tmpViewDir),o);let s=n*r;if(r<=1&&s<4&&(s=4,r=s/n),Math.abs(n-s)<1e-6)return;const l=(0,Pi.l)(e.center);if(this._sphere[3]!==l){const t=this._sphere[3]+r*(l-this._sphere[3]);e.center=(0,Pi.g)(zl,e.center,t/l)}(0,Pi.g)(this._tmpViewDir,this._tmpViewDir,-r),e.eye=(0,Pi.f)(zl,e.center,this._tmpViewDir),Ca(this.view,e,this._constraintOptions),(0,Pi.s)(a,e.center)>1e-12&&Oo(this._sphere,e,i,this._targetOnSphere)&&function(e,t,i,r,n,s,a){_l(i,(0,Pi.e)(t.up,i),e[3],-vo.Q4.normalize((0,st.Vl)(n)),s,t.aboveGround)?yl(e,t,i,r,-vo.Q4.normalize((0,st.Vl)(n)),s,a):gl(e,t,i,r,s,a)}(this._sphere,e,a,this._targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{let n=.6**Math.abs(t);const s=t>0?1:-1;(0,Pi.d)(this._tmpViewDir,a,e.eye);const l=(0,Pi.l)(this._tmpViewDir),c=this.view.stage.renderView.getMinimalDepthForArea(null,i[0],i[1],this.view.state.camera,60);let h=null!=c?c:o;h=r&&t>0?Math.min(h,l):h,(0,Pi.g)(this._tmpRayDir.direction,this._tmpRayDir.direction,h),(0,Pi.f)(a,this._tmpRayDir.origin,this._tmpRayDir.direction);let u=h*n;const d=Math.max(4,1.01*e.nearFar[0]);if(t>0&&u<d&&(u=d,n=u/h),Math.abs(h-u)<1e-6)return;(0,Pi.g)(this._tmpRayDir.direction,this._tmpRayDir.direction,s*(1-n)),e.eye=(0,Pi.f)(zl,e.eye,this._tmpRayDir.direction),e.center=(0,Pi.f)(zl,e.center,this._tmpRayDir.direction)}xs(this.view,e)}};Bl=(0,r._)([(0,x.j)("esri.views.3d.state.controllers.ZoomStepControllerGlobal")],Bl);const zl=(0,R.Ue)(),Gl=(0,R.Ue)();var ql=i(23555);let Zl=class extends fo{constructor(){super(...arguments),this._zoomLocation=(0,R.Ue)(),this._tmpCamera=new po.Z,this._tmpRayDir=(0,R.Ue)(),this._tmpCenter=(0,R.Ue)(),this._beginCamera=new po.Z,this._constraintOptions=new ts(Yn.ALL,Kn.ZOOM,null,this._beginCamera)}step(e,t){if(!this.running)return;const i=this.view.state;this.animation.finished?this._beginCamera.copyFrom(i.camera):this.animation.cameraAt(1,this._beginCamera),this._tmpCamera.copyFrom(i.camera);const r=new mo.r(this.view.state.viewingMode);let n=!1;e>0?(n=this._intersectionHelper.intersectScreenFreePointFallback(t,this._zoomLocation,this.view.basemapTerrain.invisible?Uo:{}),this._intersectionHelper.intersectRay(this._tmpCamera.ray,r,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter)):this._intersectionHelper.intersectRay(this._tmpCamera.ray,r,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:(0,Pi.c)(this._zoomLocation,this._tmpCamera.center);const s=.6**e;let a=this.view.stage.renderView.getMinimalDepthForArea((0,ql.$L)(this.view),t[0],t[1],this.view.state.camera,60);(0,Pi.d)($l,this._tmpCamera.eye,this._zoomLocation),(0,Pi.n)($l,$l);const o=(0,st.uZ)(Math.min(8,1/Math.abs((0,Pi.e)(Wl,$l)))*Math.abs(this.view.camera.position.z),200,Fo);if(a=null!=a?a:o,a){const e=(0,R.Ue)();(0,Pi.d)(e,this._zoomLocation,this._tmpCamera.eye),(a<(0,Pi.l)(e)||!n)&&((0,Pi.n)(e,e),(0,Pi.f)(this._zoomLocation,this._tmpCamera.eye,(0,Pi.g)(e,e,a)))}this._updateCamera(this._tmpCamera,s,this._zoomLocation),this.begin(this._tmpCamera)}animationSettings(){return{duration:(0,ur.HA)(600),easing:ia}}_updateCamera(e,t,i){(0,Pi.d)(this._tmpRayDir,i,e.eye);const r=(0,Pi.l)(this._tmpRayDir);let n=r*t;const s=t<=1,a=Math.max(4,1.01*e.nearFar[0]);0!==n&&(s&&n<a&&(n=a,t=n/r),Math.abs(r-n)<1e-6||((0,Pi.g)(this._tmpRayDir,this._tmpRayDir,t),e.eye=(0,Pi.d)(jl,i,this._tmpRayDir),e.center=(0,Pi.m)(jl,e.center,i,1-t),Ca(this.view,e,this._constraintOptions)))}};Zl=(0,r._)([(0,x.j)("esri.views.3d.state.controllers.ZoomStepControllerLocal")],Zl);const jl=(0,R.Ue)(),Wl=(0,R.al)(0,0,1),$l=(0,R.Ue)();var Xl=i(42527);function Yl(e,t){switch(t){case"primary":return"touch"===e.pointerType||0===e.button;case"secondary":return"touch"!==e.pointerType&&2===e.button;case"tertiary":return"touch"!==e.pointerType&&1===e.button}}function Kl(e,t){const{button:i,pointerType:r}=e;return"touch"!==r&&t.some((e=>"primary"===e&&0===i||"secondary"===e&&2===i||"tertiary"===e&&1===i))}function Ql(e,{dragPrimary:t,dragSecondary:i,dragTertiary:r}){return[{key:"primary",value:t},{key:"secondary",value:i},{key:"tertiary",value:r}].filter((t=>t.value===e)).map((e=>e.key))}class Jl extends Xl.a{constructor(e,t){super(!0),this._view=e,this.registerIncoming("double-click",t,(e=>this._handleDoubleClick(e)))}_handleDoubleClick(e){const t=e.data;if(Yl(t,"primary")){const i=this._view.state.isGlobal?new Bl({view:this._view,mode:"animation"}):new Zl({view:this._view,mode:"animation"});this._view.state.switchCameraController(i),i.step(Math.log(.5)/Math.log(.6),(0,y.s1)(t.x,t.y)),e.stopPropagation()}}}var ec=i(73749),tc=i(27583),ic=i(67764),rc=i(60321);let nc=class extends S.Z{constructor(e){super(e)}initialize(){this.addHandles(this.view.basemapTerrain.on("elevation-change",(e=>this._handleElevationChangeEvent(e))))}_handleElevationChangeEvent(e){if(this.view.state.cameraController)return;const t=this.view.state.camera;null!=e.spatialReference&&(0,Cs.lM)(this.view,t,e.extent,e.spatialReference)&&this._applyToCurrentCamera()}_applyToCurrentCamera(){this.view.state.updateCamera((e=>xs(this.view,e,ws.EYE_AND_CENTER)))}};(0,r._)([(0,w.Cb)({constructOnly:!0})],nc.prototype,"view",void 0),nc=(0,r._)([(0,x.j)("esri.views.3d.state.SurfaceCollisionConstraint")],nc);let sc=class extends S.Z{constructor(e){super(e),this.nearFarHeuristic=(0,rc.l)(e.view.state.viewingMode,e.view.basemapTerrain,e.view.renderCoordsHelper.spatialReference)}initialize(){this.addHandles([(0,_.YP)((()=>[this.view.constraints?.clipDistance?.near,this.view.constraints?.clipDistance?.far]),(()=>this._clipDistanceNearFarChanged())),(0,_.YP)((()=>this.view.constraints?.clipDistance?.mode),(()=>this._updateNearFar())),this.view.state.events.on("before-camera-change",(({camera:e,sceneDepthRange:t})=>this._updateCameraNearFar(e,t))),(0,_.YP)((()=>this.view.stage.renderer.sceneDepthRange.value),(()=>this._updateNearFar()),_.Z_),(0,_.YP)((()=>this.view.renderDataExtent),(()=>this._updateNearFar()),_.Z_),(0,_.YP)((()=>[this.view.constraints?.altitude?.min,this.view.constraints?.altitude?.max]),(()=>this._updateAltitude()),_.Z_),(0,_.YP)((()=>this.view.constraints?.tilt?.max),(()=>this._updateTiltMax()),_.Z_),(0,_.YP)((()=>this.view.constraints?.tilt?.mode),(()=>this._updateTilt()),_.Z_),(0,_.YP)((()=>this.view.state?.camera),(()=>this._updateTiltAutoMax()),_.Z_),(0,_.YP)((()=>[this.view.map?.ground?.navigationConstraint?.type,this.view.state?.constraints?.collision?.enabled]),(()=>this._updateCollision()),_.Z_)]),this.view.state.isLocal&&this.addHandles((0,_.YP)((()=>this.view.renderDataExtent),(e=>this._updateLocalSurfaceDistance(e)),_.nn)),this._updateNearFar(),this.view.state.viewingMode!==Ht.JY.Local&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new nc({view:this.view}))}destroy(){this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){const e=this.view.constraints?.clipDistance;e&&"auto"!==e.mode&&this.view.state.updateCamera((t=>ac(t,e)))}_updateNearFar(){this.view.state.updateCamera((e=>this._updateCameraNearFar(e)))}_updateCameraNearFar(e,t){const i=this.view.constraints&&this.view.constraints.clipDistance;"manual"===(i?i.mode:"auto")?ac(e,i):this._updateCameraNearFarAuto(e,i,t)}_updateCameraNearFarAuto(e,t,i){const r=(0,Cs.wH)(this.view,e.eye),n=this.nearFarHeuristic.compute(e,this.view.renderDataExtent,i??this.view.stage.renderer.sceneDepthRange.value,r);e.near=n.near,e.far=n.far,t&&t.autoUpdate(e.near,e.far)}_updateCollision(){const e=this.view.map?.ground?.navigationConstraint?.type,t=!e||"stay-above"===e,i=this.view.state.constraints.collision;if(t!==i.enabled){i.enabled=t,t&&this._reapplyConstraints(Yn.COLLISION);const e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode||this._updateTiltAuto()}}_updateAltitude(){const e=this.view.constraints&&this.view.constraints.altitude;e&&this.view.state.viewingMode!==Ht.JY.Local?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){const e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode&&(this._updateTiltManual(e),this._reapplyConstraints())}_updateTilt(){const e=this.view.constraints&&this.view.constraints.tilt;"manual"===(e?e.mode:"auto")?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(e){const t=this.view.state.constraints;t.tilt=t.createConstantMaxTilt((0,st.Vl)(e.max))}_updateTiltAuto(){const e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){const e=this.view.constraints&&this.view.constraints.tilt;if(!e||"auto"!==e.mode)return;const t=this.view.state.constraints;if(t.tilt){const i=t.tilt(this.view.state.camera.distance).max;e.autoUpdate((0,st.BV)(i))}}_updateLocalSurfaceDistance(e){if(null==e)return;let t=Math.max(e.width,e.height);if(t<=0)return;null!=e.zmax&&null!=e.zmin&&(t=Math.max(t,e.zmax-e.zmin));const i=this.view.state,r=3*t/Math.atan(i.camera.fov/2);r!==i.constraints.distance&&(i.constraints.distance=r)}_reapplyConstraints(e=Yn.ALL){this.view.state.updateCamera((t=>Ca(this.view,t,new ts(e,Kn.NONE,null))))}};function ac(e,t){t&&(e.near=t.near,e.far=t.far)}(0,r._)([(0,w.Cb)({constructOnly:!0})],sc.prototype,"view",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],sc.prototype,"surfaceCollisionConstraint",void 0),sc=(0,r._)([(0,x.j)("esri.views.3d.state.ConstraintsManager")],sc);var oc=i(59505);let lc=class extends ho{set desiredCamera(e){this._set("desiredCamera",e.clone())}constructor(e){super(e)}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=co.Running,this.addHandles(this.view.basemapTerrain.on("elevation-change",(e=>this._handleElevationChangeEvent(e)))),this._applyCorrection()}onControllerEnd(){this.removeAllHandles()}stepController(){}_handleElevationChangeEvent(e){(null==e.spatialReference||(0,Cs.lM)(this.view,this.desiredCamera,e.extent,e.spatialReference))&&this._applyCorrection()}_applyCorrection(){this.view.state.updateCamera((e=>{e.copyViewFrom(this.desiredCamera),xs(this.view,e,ws.EYE_AND_CENTER)||this.constraintEnabled||(this.state=co.Stopped)}))}};(0,r._)([(0,w.Cb)({constructOnly:!0})],lc.prototype,"desiredCamera",null),lc=(0,r._)([(0,x.j)("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],lc);var cc=i(46451),hc=i(82890),uc=i(82868),dc=i(74238),pc=i(96937),mc=i(2051),fc=i(16447),_c=i(33869),gc=i(90494);function yc(e){return 360-vo.BV.normalize(e)}function vc(e){return vo.BV.normalize(360-e)}function bc(e,t,i){const r=t.camera;if(null!=r)return function(e,t){const i=e.position;let r;try{r=(0,L.tryProjectWithZConversion)(i,t)}catch(e){return null}if(!r)return null;const n=e.clone();return n.position=r.clone(),n}(r,(0,se.h5)(e));const{targetGeometry:n}=t;if(null==n)return null;const{camera:s,mode:a}=Cc(e,t.rotation,i);if("point"===n.type)return function(e,t,i,r,n){const s=e.spatialReference;let a;try{a=(0,L.tryProjectWithZConversion)(i.clone(),s)}catch(e){return null}if(!a)return null;const o=null!=t.scale?(0,se._U)(e,t.scale):e.state.camera.distance;return(0,se.Hm)(e,a,o,r,n)}(e,t,n,s,a);const o=n.extent;return null==o?null:(0,se.S9)(e,o,s.heading,s.tilt,a)}async function wc(e,t,i,r){const n=t.camera;if(null!=n)return async function(e,t,i){const r=e.position,n=await(0,L.projectWithZConversion)(r,t,{signal:i});(0,f.k_)(i);const s=e.clone();return s.position=n.clone(),s}(n,(0,se.h5)(e),r);const{targetGeometry:s}=t;if(null==s)throw new Error("Viewpoint has no targetGeometry!");const{camera:a,mode:o}=Cc(e,t.rotation,i);if("point"===s.type)return async function(e,t,i,r,n,s){const a=e.spatialReference,o=await(0,L.projectWithZConversion)(i.clone(),a,{signal:s});(0,f.k_)(s);const l=null!=t.scale?(0,se._U)(e,t.scale):e.state.camera.distance;return(0,se.gL)(e,o,l,r,n,s)}(e,t,s,a,o,r);const l=s.extent;if(null==l)throw new Error("Target geometry has no extent!");return(0,se.Ic)(e,l,a.heading,a.tilt,o,r)}function Cc(e,t,i){const r=(0,se.l0)(e,e.state.camera);let n=se.Q8.ADJUST;return null!=t&&(r.heading=yc(t),n=se.Q8.LOCKED),null!=i&&(r.tilt=i),{camera:r,mode:n}}async function xc(e,t,i){const r=function(e,t){if(!t||!e.spatialReference)return null;const i={target:void 0};return"declaredClass"in t||Array.isArray(t)?i.target=t:(Object.assign(i,t),!i.target&&"center"in t&&t.center&&(i.target=t.center)),i}(e,t);if(!r)throw new l.Z("viewpointutils-create:no-target","Missing target for creating viewpoint");const a=new n.Z({fov:e.camera.fov}),o=new s.Z({camera:a});if(r.target instanceof s.Z)return Oc(await async function(e,t,i,r,n){if(t.camera)return Rc(e,t.camera,r,n);n.scale=t.scale,n.rotation=t.rotation,n.targetGeometry=null!=t.targetGeometry?t.targetGeometry.clone():null,n.camera=null,null!=i.heading?n.rotation=vc(i.heading):null!=i.rotation&&(n.rotation=i.rotation);const s=Tc(e,i);return null!=s&&(n.scale=s),n.camera=await wc(e,n,i.tilt,r),n}(e,r.target,r,i,o));if(r.target instanceof n.Z)return Oc(await Rc(e,r.target,i,o));const c=null!=r.scale||null!=r.zoom;if(r.target instanceof O.Z){const t=r.target.xmin===r.target.xmax||r.target.ymin===r.target.ymax;return Oc(c||t?await Ac(e,r,r.target.center,a,i,o):await async function(e,t,i,r,n,s){s.targetGeometry=i.clone();const a=(0,Cs.dP)(e);(0,se.l0)(e,a,r);const o=Sc(r,t)?se.Q8.LOCKED:se.Q8.ADJUST;return s.camera=await(0,se.Ic)(e,i,r.heading,r.tilt,o,n),s}(e,r,r.target,a,i,o))}const h=new Dc,u=c?function(e,t){const i=Tc(e,t);return i?(0,V.DE)(i):void 0}(e,r):void 0;if(await Pc(e,r.target,u,h,i),isFinite(h.boundingBox[0])){let t;if((0,fc.be)(h.boundingBox,Ic),zc.x=Ic[0],zc.y=Ic[1],zc.z=Ic[2],zc.spatialReference=e.spatialReference,isFinite(zc.z)&&h.hasZ?t=(0,fc.wp)(h.boundingBox):(zc.z=void 0,t=(0,H.wp)((0,fc.y8)(h.boundingBox,Uc))),c||t)return Oc(await Ac(e,r,zc,a,i,o));const n=function(e,t){const i=.66;if(!t.length)return i;let r=Number.NEGATIVE_INFINITY;for(let e=0;e<t.length;e++){const i=t[e].screenSpaceBoundingRect;r=Math.max(r,Math.abs(i[0]),Math.abs(i[1]),Math.abs(i[2]),Math.abs(i[3]))}return i-r/Math.min(e.width,e.height)*2}(e,h.screenSpaceObjects);return Oc(await async function(e,t,i,r,n,s,a,o){o.targetGeometry=i.clone();const l=(0,Cs.dP)(e),c=function(e,t,i,r,n){let s=0;null!=i.z?s=i.z:e.basemapTerrain&&e.elevationProvider&&(s=(0,gc.KO)(e.elevationProvider,i)),(0,Pi.i)(Ic,i.x,i.y,s),(0,dc.B)(e.spatialReference,Ic,Lc,e.renderSpatialReference),(0,ki.xO)(Nc,Lc),(0,ki.p4)(Nc,Nc),(0,fc.cS)(Fc);const a=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(let t=0;t<a.length;t++){const i=a[t];let n=r[i[2]];isFinite(n)||(n=s),(0,Pi.i)(Ic,r[i[0]],r[i[1]],n),(0,mc.S)(Ic,e.spatialReference,Ic,e.renderSpatialReference),(0,fc.pp)(Fc,(0,Pi.o)(Ic,Ic,Nc))}const o=(0,fc.bf)(Fc),l=(0,fc.Cb)(Fc),c=(0,fc.Ye)(Fc),h=1/Math.tan(t.fovX/2),u=1/Math.tan(t.fovY/2),d=.5*Math.sqrt(o*o+c*c)*Math.max(u,h)+.5*l,p=.5*l*u+.5*Math.max(o,c);return Math.max(d,p)/n}(e,l,i,r,n);(0,se.l0)(e,l,s);const h=Sc(s,t)?se.Q8.LOCKED:se.Q8.ADJUST;return o.camera=await(0,se.gL)(e,o.targetGeometry,c,s,h,a),o.scale=(0,se.Xt)(e,c),o}(e,r,zc,h.boundingBox,n,a,i,o))}return r.position?Oc(await async function(e,t,i,r,n){const s=(0,Cs.dP)(e);(0,Pi.c)(Hc,s.viewForward),(0,se.t_)(e,s.eye,Hc,s.up,Bc);const a=e.spatialReference,{position:o}=t;if(o){const e=await(0,L.projectWithZConversion)(o,a,{signal:n});i.position=e}else i.position=new I.Z;return i.heading=null!=t.heading?t.heading:Bc.heading,i.tilt=null!=t.tilt?t.tilt:Bc.tilt,Mc(e,null,i,r)}(e,r,a,o,i)):Oc(await async function(e,t,i,r,n){if(null!=t.heading||null!=t.rotation||null!=t.scale||null!=t.tilt||null!=t.zoom||null!=t.zoomFactor){const s=(0,Cs.dP)(e),{spatialReference:a,renderSpatialReference:o}=e,l=new I.Z({spatialReference:a});return(0,pc.f)(s.center,o,l)?Ac(e,t,l,i,r,n):n}return n.scale=e.scale,n.camera=e.camera.clone(),Sc(n.camera,t),n}(e,r,a,i,o))}function Tc(e,t){return null==t.scale&&null!=t.zoom?(0,se.EO)(e,t.zoom):t.scale}function Sc(e,t){let i=!1;return null!=t.heading?(e.heading=t.heading,i=!0):null!=t.rotation&&(e.heading=yc(t.rotation),i=!0),null!=t.tilt&&(e.tilt=t.tilt,i=!0),null!=t.fov&&(e.fov=t.fov),i}function Mc(e,t,i,r){const n=e.spatialReference||N.Z.WGS84;if(t??=(0,se.n3)(e,i),null==t)return r;const s=new I.Z({spatialReference:n});return(0,pc.f)(t.center,e.renderSpatialReference,s)?(r.targetGeometry=s,r.scale=(0,se.Xt)(e,t.distance),r.rotation=vc(i.heading),r.camera=i,r):r}async function Ec(e,t,i,r){const n=()=>new l.Z("viewpointutils:invalid-geometry","The target is missing a valid geometry");if(!t)throw n();"mesh"===t.type&&(t=t.extent);const s=e.basemapTerrain.spatialReference;if(!t.hasZ&&e.basemapTerrain){let i;switch(t.type){case"point":i=t;break;case"multipoint":case"polyline":i=t.extent?.center;break;case"extent":i=t.center;break;case"polygon":i=t.centroid}null!=i&&s&&e.elevationProvider?(i=await(0,L.projectWithZConversion)(i,s,{signal:r}),Ic[2]=(0,gc.KO)(e.elevationProvider,i)??0):Ic[2]=0}const a=Gc[t.type],o=new Array;if(a(t,t.hasZ?e=>{o.push([e[0],e[1],e[2]])}:e=>{o.push([e[0],e[1]])},Ic),0===o.length)throw n();const c=t.spatialReference,h=e.spatialReference,u=await(0,L.projectWithZConversion)(new uc.Z({spatialReference:c,hasZ:t.hasZ,hasM:!1,points:o}),h,{signal:r});if(t.hasZ&&(i.hasZ=!0),t.hasZ)for(const[e,t,r]of u.points)Ic[0]=e,Ic[1]=t,Ic[2]=r,(0,fc.pp)(i.boundingBox,Ic);else for(const[e,t]of u.points)Ic[0]=e,Ic[1]=t,(0,fc.pp)(i.boundingBox,Ic)}async function Pc(e,t,i,r,n){if(Array.isArray(t)&&2===t.length){const i=t[0],s=t[1];if("number"==typeof i&&"number"==typeof s)return zc.x=i,zc.y=s,zc.z=void 0,zc.spatialReference=e.spatialReference?.isGeographic?e.spatialReference:N.Z.WGS84,void await Ec(e,zc,r,n)}t&&"map"in t&&"function"==typeof t.map?await Promise.allSettled(t.map((t=>Pc(e,t,i,r,n)))):t instanceof hc.Z?await Ec(e,t,r,n):t instanceof cc.Z&&await async function(e,t,i,r,n){const s=await(0,me.q6)(e.whenViewForGraphic(t));if(!1===s.ok||null==s.value||!("whenGraphicBounds"in s.value))return void await Ec(e,t.geometry,r,n);const a=s.value,o=await(0,me.q6)(a.whenGraphicBounds(t,{minDemResolution:i}));if(!1===o.ok||!o.value)return void await Ec(e,t.geometry,r,n);const{screenSpaceObjects:l,boundingBox:c}=o.value;(0,fc.TC)(r.boundingBox,c),l&&l.forEach((e=>{r.screenSpaceObjects.push(e)})),isFinite(c[2])&&(r.hasZ=!0)}(e,t,i,r,n)}async function Rc(e,t,i,r){const n=e.spatialReference,s=await(0,L.projectWithZConversion)(t.position,n,{signal:i}),a=t.clone();return a.position=s,Mc(e,null,a,r)}async function Ac(e,t,i,r,n,s){s.targetGeometry=i.clone();const a=(0,Cs.dP)(e);if(t.position)return async function(e,t,i,r,n,s,a){const o=e.renderSpatialReference;return await(0,U.U)(t,Vc,o,0,{signal:a}),await(0,U.U)(i,kc,o,0,{signal:a}),s.targetGeometry=new I.Z(t),n.position=new I.Z(i),(0,Pi.d)(Hc,Vc,kc),(0,se.t_)(e,kc,Hc,r.up,n),s.scale=(0,se.Xt)(e,(0,Pi.j)(kc,Vc)),s.rotation=vc(n.heading),s.camera=n,s}(e,s.targetGeometry,t.position,a,r,s,n);if(t.zoomFactor){const i=a.distance/t.zoomFactor,r=(0,Pi.g)(Ic,a.viewForward,-i);a.eye=(0,Pi.f)(Ic,a.center,r),s.scale=(0,se.Xt)(e,i)}(0,se.l0)(e,a,r);const o=Sc(r,t)?se.Q8.LOCKED:se.Q8.ADJUST;if(!t.zoomFactor){const i=Tc(e,t);if(null==i){await(0,U.U)(s.targetGeometry,Ic,e.renderSpatialReference,0,{signal:n});const t=(0,_c.g8)(a.frustum,Ic)?(0,Pi.j)(a.eye,Ic):a.distance;s.camera=await(0,se.gL)(e,s.targetGeometry,t,r,o),s.scale=(0,se.Xt)(e,t)}else s.scale=i,s.camera=await(0,se.UI)(e,s.targetGeometry,s.scale,r,o,n)}return s}function Oc(e){return null!=e?.camera&&(e.rotation=vc(e.camera.heading)),e}class Dc{constructor(){this.hasZ=!1,this.boundingBox=(0,fc.cS)(),this.screenSpaceObjects=new Array}}const Ic=(0,R.Ue)(),Lc=(0,Bi.Ue)(),Nc=(0,Ea.Ue)(),Fc=(0,fc.Ue)(),Uc=(0,H.Ue)(),Hc=(0,R.Ue)(),kc=(0,R.Ue)(),Vc=(0,R.Ue)(),Bc={heading:0,tilt:0},zc=new I.Z,Gc={point(e,t,i){i[0]=e.x,i[1]=e.y,null!=e.z&&(i[2]=e.z),t(i)},polygon(e,t,i){const r=e.hasZ;for(let n=0;n<e.rings.length;n++){const s=e.rings[n];for(let e=0;e<s.length;e++)i[0]=s[e][0],i[1]=s[e][1],r&&(i[2]=s[e][2]),t(i)}},polyline(e,t,i){const r=e.hasZ;for(let n=0;n<e.paths.length;n++){const s=e.paths[n];for(let e=0;e<s.length;e++)i[0]=s[e][0],i[1]=s[e][1],r&&(i[2]=s[e][2]),t(i)}},multipoint(e,t,i){const r=e.points,n=e.hasZ;for(let e=0;e<r.length;e++)i[0]=r[e][0],i[1]=r[e][1],n&&(i[2]=r[e][2]),t(i)},extent(e,t,i){null!=e.zmin&&null!=e.zmax?(t((0,Pi.i)(i,e.xmin,e.ymin,e.zmin)),t((0,Pi.i)(i,e.xmax,e.ymin,e.zmin)),t((0,Pi.i)(i,e.xmin,e.ymax,e.zmin)),t((0,Pi.i)(i,e.xmax,e.ymax,e.zmin)),t((0,Pi.i)(i,e.xmin,e.ymin,e.zmax)),t((0,Pi.i)(i,e.xmax,e.ymin,e.zmax)),t((0,Pi.i)(i,e.xmin,e.ymax,e.zmax)),t((0,Pi.i)(i,e.xmax,e.ymax,e.zmax))):(t((0,Pi.i)(i,e.xmin,e.ymin,i[2])),t((0,Pi.i)(i,e.xmax,e.ymin,i[2])),t((0,Pi.i)(i,e.xmin,e.ymax,i[2])),t((0,Pi.i)(i,e.xmax,e.ymax,i[2])))}};class qc{constructor(e,t,i){this._target=e,this._options=t,this.view=i,this.state="pending",this._animationController=null,this.promise=new Promise(((e,t)=>{this._resolveCallback=e,this._rejectCallback=t;const i=new AbortController;null!=this._options.signal&&(0,f.fu)(this._options.signal,(()=>this.abort())),this._abortController=i,this._waitForReady()}))}_resolve(e){if("finished"!==this.state)return this.state="finished",this._resolveCallback(e)}_reject(e){if("finished"!==this.state)return this.state="finished",this._rejectCallback(e)}abort(e=!1){this._abortController.abort(),"wait-for-animation-finish"===this.state&&!e&&null!=this._animationController&&this.view.state.cameraController===this._animationController&&this._animationController.running&&this._animationController.stopController(),this._reject((0,f.zE)())}async _waitForReady(){if(this.state="wait-for-ready",!this.view.ready)try{await(0,_.N1)((()=>this.view.ready),this._abortController.signal)}catch(e){return this._reject(e)}this._createViewPoint()}async _createViewPoint(){if("finished"!==this.state){this.state="wait-for-viewpoint",this._animationController=this._options.animate?this._getAnimationController():null;try{const e=await xc(this.view,this._target,this._abortController.signal);if("finished"===this.state)return;const t=e?this._getCameraFromViewpoint(e):null;if(null==t)return;if(this._options.animate){if(null==this._animationController)return;this._startAnimation(t,this._animationController)}else this.view.stateManager.setStateCamera(t.camera,{applyConstraints:!t.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this._resolve()}catch(e){this._reject(e)}}}_getCameraFromViewpoint(e){const t=!!(this._target instanceof s.Z&&this._target.camera||this._target instanceof n.Z),i=e.camera;if(null==i)return null;if(!this.view.stateManager.isCompatible(i)){const e=i.position,t=e&&e.spatialReference,r=t?t.wkid:"none",n=this.view.spatialReference?.wkid;return this._reject(new l.Z("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${r}, view: ${n})`,{camera:i})),null}const r=(0,se.n3)(this.view,i);return null==r?(this._reject(new l.Z("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:e,camera:r,isFullySpecified:t}}_startAnimation(e,t){this.state="wait-for-animation-finish";const i=t.viewAnimation;if(null==i)return void this._reject(new l.Z("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(i.update(e.viewpoint,"running"),!t.running||null==t.viewAnimation||t.viewAnimation.target!==e.viewpoint||this.view.state.cameraController!==t)return this.abort();let r;e.isFullySpecified?(r=new lc({view:this.view,desiredCamera:e.camera}),xs(this.view,e.camera,ws.EYE_AND_CENTER)):Ca(this.view,e.camera),t.begin(e.camera,this._options);const n=e=>{if(null!=this.view.state)switch(t.state){case co.Finished:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this._resolve()}break;case co.Ready:case co.Rejected:case co.Running:case co.Stopped:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this._reject(e)}}};i.when((()=>{const i=this.view.state.cameraController;r&&(i&&i.running?yo(i)&&null!=i.viewAnimation&&i.viewAnimation.target===e.viewpoint&&(this.view.state.cameraController=r):null!=t.viewAnimation&&t.viewAnimation.target===e.viewpoint&&t.state===co.Finished&&(this.view.state.cameraController=r))}),(e=>n(e))),t.asyncResult={resolve:()=>n(),reject:e=>n(e)}}_getAnimationController(){let e=null,t=null;const i=this.view.state.cameraController;return yo(i)&&(i.updateStateFromViewAnimation(),i.running&&(e=i,t=e.viewAnimation)),null==e&&(e=new fo({view:this.view,mode:"animation"}),t=e.viewAnimation,this.view.state.switchCameraController(e),e.state===co.Rejected)?(t?.stop(),this._reject(new l.Z("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null):e}}var Zc=i(10517),jc=i(4486),Wc=i(96571),$c=i(99734);let Xc=class extends S.Z{constructor(e){super(e),this.ready=!1,this._windowDevicePixelRatio=1,this._devicePixelRatioOverride=null,this._idleTimeout=sh,this.test={viewStateManager:this,contentCameraResetState:new Map,setDevicePixelRatio:e=>this._devicePixelRatioOverride=e,renderState:null,get maximumPixelRatio(){return this.viewStateManager.view.qualitySettings.maximumPixelRatio},get updatingIgnoreRenderState(){return null!=this.renderState},get idleTimeoutEnabled(){return this.viewStateManager._idleTimeout>0},set idleTimeoutEnabled(e){this.viewStateManager._idleTimeout=e?sh:0}},this._propertiesPool=new Wc.L({frustum:oc.i},this),this._cameraSetByUser=!1,this._gotoOperation=null,this._cameraChangeTime=0,this._tmpCanvasSize=new Yc}initialize(){this._cameraChangeTime=performance.now(),this.addHandles([(0,_.on)((()=>this.view.state.events),"before-camera-change",(({camera:e})=>e&&this._updateElevation(e))),(0,_.YP)((()=>this.view.state?.camera),((e,t)=>this._cameraChangedHandler(e,t)),_.Z_)]),(0,_.gx)((()=>this.view.state?.camera),(e=>this._updateElevation(e)),{once:!0,sync:!0}),this.addHandles([(0,g.A)({prepare:()=>this._prepareFrame()}),(0,_.YP)((()=>this.view.state.cameraController),(()=>{this._cameraSetByUser=!0,this.removeHandles(rh)})),(0,_.on)((()=>this.view.state.events),"camera-projection-changed",(()=>this.notifyChange("scale")))])}destroy(){this.exit(),this._propertiesPool=(0,p.SC)(this._propertiesPool)}get camera(){const e=this._get("camera");if(!this.ready)return e;const t=(0,se.l0)(this.view,this.view.state.camera,eh);return t&&e&&t.equals(e)?e:t.clone()}set camera(e){this._updatePropertyBeforeReady("camera",e)||(this.view.elevationProvider?.enableCache(!0),this.setStateCamera((0,se.n3)(this.view,e),{applyConstraints:!1})||d.Z.getLogger(this).error("#camera=","Invalid camera",e),this.view.elevationProvider?.enableCache(!1))}get contentCamera(){const e=this._get("contentCamera");if(!this.ready)return e;const t=(0,se.l0)(this.view,this.view.state.contentCamera,eh);return t&&e&&t.equals(e)?e:t.clone()}set contentCamera(e){if(this._updatePropertyBeforeReady("contentCamera",e))return;const t=(0,se.n3)(this.view,e);this.view.state.contentCamera=null!=t?t:null}installContentCameraReset(e){if(this.removeHandles(nh),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const t=this.zoom,i=this.view.state.camera.distance**2,r=(0,R.nI)(this.view.state.camera.center),n=e.sticky?this.contentCamera.clone():null;return this.addHandles([(0,_.YP)((()=>this.contentCamera),(()=>{e.sticky||(this.removeHandles(nh),this.test.contentCameraResetState.clear())})),(0,_.YP)((()=>this.zoom),(e=>{void 0!==e&&void 0!==t&&(this.test.contentCameraResetState.set("view.zoom",Math.abs(e-t)/2),Math.abs(e-t)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=n))})),(0,_.YP)((()=>this.view.state.camera),(e=>{const t=(0,Pi.s)(r,e.center);this.test.contentCameraResetState.set("camera.center",t/i),t>i?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=n)}))],nh),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){this._updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this._centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():d.Z.getLogger(this).error("#center=","Invalid center",e):d.Z.getLogger(this).error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e):d.Z.getLogger(this).error("#center=","Center may not be null or undefined"))}get visibleArea(){if(!this.ready){const e=this._get("extent");return e?ic.Z.fromExtent(e):null}return(0,se.ao)(this.view,this.view.pointsOfInterest.focus.renderLocation)}get extent(){if(!this.ready)return this._get("extent");const e=this.view,t=(0,se.HH)(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return null!=t?t:this._get("extent")}set extent(e){this._updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this._extentToCamera(e),{applyConstraints:!0})||d.Z.getLogger(this).error("#extent=","Invalid extent",e):d.Z.getLogger(this).error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e):d.Z.getLogger(this).error("#extent=","Extent may not be null or undefined"))}get frustum(){const e=this._propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get constraintsManager(){return this._constraintsManager}get _initialViewpoint(){const e=this.view.map;return e&&"initialViewProperties"in e?e.initialViewProperties?.viewpoint:void 0}get hasInitialView(){return!!this._initialViewpoint}get scale(){if(!this.ready)return this._get("scale");const e=this.view.basemapTerrain.tilingScheme,t=this.view.pointsOfInterest.cameraOnSurface.scale;return e&&t?(0,se.Br)(this.view,t,this.view.state.contentCamera,e):this._get("scale")}set scale(e){this._updatePropertyBeforeReady("scale",e)||this.setStateCamera(this._scaleToCamera(e),{applyConstraints:!0})||d.Z.getLogger(this).error("#scale=","Invalid scale",e)}get padding(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,t=e.padding,i=e.pixelRatio,r=this._get("padding"),n=Math.round(t[Zc.Np.TOP]/i),s=Math.round(t[Zc.Np.RIGHT]/i),a=Math.round(t[Zc.Np.BOTTOM]/i),o=Math.round(t[Zc.Np.LEFT]/i);return null!=r&&r.top===n&&r.right===s&&r.bottom===a&&r.left===o?r:{top:n,right:s,bottom:a,left:o}}set padding(e){this._updatePropertyBeforeReady("padding",e)||(this._paddingToArray(e,this.view.state.camera.pixelRatio,ih),this.view.state.updateCamera((e=>e.padding=ih)))}_paddingToArray(e,t,i){e?(0,ec.s)(i,e.top||0,e.right||0,e.bottom||0,e.left||0):(0,ec.s)(i,0,0,0,0);for(let e=0;e<4;e++)i[e]=Math.round(i[e]*t)}get screenCenter(){const e=this.padding;return(0,y.vW)((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?function(e,t,i=null){return null==i&&(i=new s.Z),Mc(e,null,t.clone(),i)}(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){if(!this._updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this._viewpointToCamera(e),{applyConstraints:!e.camera})||d.Z.getLogger(this).error("#viewpoint=","Invalid viewpoint",e);else{const t=null!=e.camera?e.camera.position:e.targetGeometry,i=null!=t&&t.spatialReference;d.Z.getLogger(this).error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(i?i.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e)}else d.Z.getLogger(this).error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?(0,se.sO)(this.view,this.scale):this._get("zoom")}set zoom(e){this._updatePropertyBeforeReady("zoom",e)||void 0===e||this.setStateCamera(this._zoomToCamera(e),{applyConstraints:!0})||d.Z.getLogger(this).error("#zoom=","Invalid zoom",e)}_computeCanvasSize(){if(this._devicePixelRatioOverride)return this.view.state.contentPixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*this._devicePixelRatioOverride),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*this._devicePixelRatioOverride),this._tmpCanvasSize.pixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize;const e=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio),t=(this._usePhysicalPixelRendering?this._windowDevicePixelRatio:e)*this.view.resolutionScale;this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*t),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*t);const i=this.view.stage.renderView.renderingContext?.parameters.maxTextureSize;return i&&(0,tr.d)(this._tmpCanvasSize,i),this._tmpCanvasSize.pixelRatio=this._tmpCanvasSize.width>0?this._tmpCanvasSize.width/this.view.surface.clientWidth*.5+this._tmpCanvasSize.height/this.view.surface.clientHeight*.5:t,this.view.state&&(this.view.state.contentPixelRatio=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)),this._tmpCanvasSize}get _rasterPixelRatio(){return null!=this._devicePixelRatioOverride?this._devicePixelRatioOverride:this._usePhysicalPixelRenderingAny?this._windowDevicePixelRatio:Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)}get _usePhysicalPixelRendering(){return this.view?.stage?.renderer.isFeatureEnabled(jc.Y.PhysicalPixelRendering)??!1}get _usePhysicalPixelRenderingAny(){const e=this.view?.stage?.renderer;return e&&(e.isFeatureEnabled(jc.Y.PhysicalPixelRendering,$c.n.IDLE)||e.isFeatureEnabled(jc.Y.PhysicalPixelRendering,$c.n.INTERACTING)||e.isFeatureEnabled(jc.Y.PhysicalPixelRendering,$c.n.ANIMATING))}preinit(e){return!(this._isOverridden("center")&&!(0,L.isLoadedOrLoadFor)(this.center.spatialReference,e)||this._isOverridden("camera")&&!(0,L.isLoadedOrLoadFor)(this.camera.position.spatialReference,e)||this._isOverridden("extent")&&!(0,L.isLoadedOrLoadFor)(this.extent.spatialReference,e)||!(!this._isOverridden("viewpoint")||(0,L.isLoadedOrLoadFor)(this.viewpoint.targetGeometry?.spatialReference,e)&&(0,L.isLoadedOrLoadFor)(this.viewpoint.camera?.position?.spatialReference,e)))}init(){this._constraintsManager=new sc({view:this.view}),this._prepareFrame();const e=this._getInitialProperties();this._cameraSetByUser=!1,this._set("ready",!0);for(const t of e)this.set(t.name,t.value);if(!this._cameraSetByUser){const e=this._initialViewpoint||this.view.initialExtent;e&&this.isCompatible(e)?this._setInitialView(e):this.view.state.viewingMode===Ht.JY.Local&&this.addHandles((0,_.gx)((()=>this.view.basemapTerrain.ready),(()=>{this.removeHandles(rh),this._setInitialView(this.view.dataExtent)}),{once:!0,initial:!0}),rh)}}exit(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this._cameraSetByUser=!1,this.removeHandles(rh),this._constraintsManager=(0,p.SC)(this._constraintsManager))}async goTo(e,t){return t={animate:!0,...t},null!=this._gotoOperation&&this._gotoOperation.abort(t.animate),this._gotoOperation=new qc(e,t,this.view),this.view.resourceController.scheduler.stopFrame(),this._gotoOperation.promise}debugSetCameraOnContent(){this.setStateCamera((0,Cs.dP)(this.view),{applyConstraints:!1})}step(e){const t=this.view.state,i=t?.cameraController;i&&(t.updateCamera((t=>i.stepController(e,t))),i.steppingFinished&&i.finishController())}_cancelGoToOperation(){null!=this._gotoOperation&&(this._gotoOperation.abort(),this._gotoOperation=null)}_getInitialProperties(){const e=new Set,t=[];for(const{propertyName:i,overrides:r}of Qc){const n=e.has(i),s=this._isOverridden(i);!n&&s&&t.push({name:i,value:this._get(i)}),this._clearOverride(i),(n||s)&&r.forEach((t=>e.add(t)))}return t}_setInitialView(e){if(null==e||this._cameraSetByUser)return;if(e instanceof n.Z)return void this.setStateCamera((0,se.n3)(this.view,e),{applyConstraints:!1});if(e instanceof s.Z){if(e.targetGeometry instanceof O.Z){const t=(0,se.S9)(this.view,e.targetGeometry,0,.5,se.Q8.LOCKED);return void(null!=t&&this.setStateCamera((0,se.n3)(this.view,t),{applyConstraints:!0}))}const t={applyConstraints:!e.camera},i=this._viewpointToCamera(e);return void this.setStateCamera(i,t)}const t=(0,se.S9)(this.view,e,0,.5,se.Q8.LOCKED);null!=t&&this.setStateCamera((0,se.n3)(this.view,t),{applyConstraints:!0})}_updatePropertyBeforeReady(e,t){return!this.ready&&(this._override(e,t),t&&Kc.has(e)&&this._override("hasInitialView",!0),!0)}isCompatible(e){return null!=e&&(e instanceof s.Z?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof n.Z?this.isCompatible(e.position):e.spatialReference&&!(0,L.requiresLoad)(e.spatialReference,this.view.spatialReference))}_getPreservingHeadingTilt(e=Jc){return this._cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}_centerPointAtDistanceToCamera(e,t,i=th){const{heading:r,tilt:n}=this._getPreservingHeadingTilt(),s=(0,se.P$)(this.view,r,n,e,t,se.Q8.ADJUST);return null==s?null:(i.copyFrom(this.view.state.camera),i.eye=s.eye,i.center=s.center,i.up=s.up,i)}_centerToCamera(e){let t;if(e.hasZ)t=this.view.state.camera.distance;else{const{centerOnContent:e}=this.view.pointsOfInterest;e.runTask(),t=e.distance}return this._centerPointAtDistanceToCamera(e,t)}_extentToCamera(e){const{heading:t,tilt:i}=this._getPreservingHeadingTilt(),r=(0,se.S9)(this.view,e,t,i,se.Q8.ADJUST,eh);return r?(0,se.n3)(this.view,r):null}_scaleToCamera(e){if(null==e)return null;const t=this.view,i=t.pointsOfInterest.centerOnContent;i.runTask();const r=i.renderLocation,n=t.pointsOfInterest.cameraOnSurface.renderLocation,s=(0,se.cb)(t,e,t.state.contentCamera,r,n);return this._centerPointAtDistanceToCamera(r,s)}_zoomToCamera(e){return this._scaleToCamera((0,se.EO)(this.view,e))}_viewpointToCamera(e){return(0,se.n3)(this.view,bc(this.view,e))}setStateCamera(e,t){return!(null==e||!this.view.state.stopActiveCameraController()||(this._cameraSetByUser=!0,t.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera((i=>{t.positionAndOrientationOnly?(i.eye=e.eye,i.center=e.center,i.up=e.up,i.fov=e.fov):i.copyFrom(e),t.applyConstraints&&Ca(this.view,i)})),t.applyConstraints||(this.view.state.cameraController=new lc({view:this.view,desiredCamera:e})),0))}_prepareFrame(){const{surface:e,canvas:t}=this.view;if(!e||!t)return;this._windowDevicePixelRatio=window.devicePixelRatio;const i=this._computeCanvasSize();if(0!==i.width&&0!==i.height&&(t.width===i.width&&t.height===i.height||(t.width=i.width,t.height=i.height),this.view.state)){const e=this.view.state.camera;e.fullWidth===i.width&&e.fullHeight===i.height&&e.pixelRatio===i.pixelRatio||(th.copyFrom(e),th.pixelRatio!==i.pixelRatio&&(this._paddingToArray(this.padding,i.pixelRatio,ih),th.padding=ih),th.fullWidth=i.width,th.fullHeight=i.height,th.pixelRatio=i.pixelRatio,this.view.state.camera=th),this._updateViewState()}}_updateElevation(e){const t=this.view.basemapTerrain?.spatialReference,i=this.view.renderCoordsHelper?.getAltitude(e.eye)??0,r=t?(0,Cs.wH)(this.view,e.eye):0;e.relativeElevation=i-r}_updateViewState(){null!=this.test.renderState?this.view.state.mode=this.test.renderState:this.view.animation?this.view.state.mode=$c.n.ANIMATING:this.view.interacting?this.view.state.mode=$c.n.INTERACTING:(this.view.state.mode===$c.n.ANIMATING&&(this._cameraChangeTime=0),performance.now()-this._cameraChangeTime<this._idleTimeout?this.view.state.mode=$c.n.INTERACTING:this.view.state.mode=$c.n.IDLE),this.view.state.rasterPixelRatio=this._rasterPixelRatio}_cameraChangedHandler(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=performance.now(),this._updateViewState())}};(0,r._)([(0,w.Cb)({type:n.Z,dependsOn:["view.state.camera","ready"]})],Xc.prototype,"camera",null),(0,r._)([(0,w.Cb)({type:n.Z,dependsOn:["view.state.contentCamera","ready"]})],Xc.prototype,"contentCamera",null),(0,r._)([(0,w.Cb)({type:I.Z})],Xc.prototype,"center",null),(0,r._)([(0,w.Cb)()],Xc.prototype,"visibleArea",null),(0,r._)([(0,w.Cb)({type:O.Z})],Xc.prototype,"extent",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Xc.prototype,"frustum",null),(0,r._)([(0,w.Cb)()],Xc.prototype,"_constraintsManager",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],Xc.prototype,"constraintsManager",null),(0,r._)([(0,w.Cb)()],Xc.prototype,"_initialViewpoint",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Xc.prototype,"hasInitialView",null),(0,r._)([(0,w.Cb)({readOnly:!0,type:Boolean})],Xc.prototype,"ready",void 0),(0,r._)([(0,w.Cb)({type:Number})],Xc.prototype,"scale",null),(0,r._)([(0,w.Cb)()],Xc.prototype,"padding",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Xc.prototype,"screenCenter",null),(0,r._)([(0,w.Cb)({constructOnly:!0})],Xc.prototype,"view",void 0),(0,r._)([(0,w.Cb)({type:s.Z})],Xc.prototype,"viewpoint",null),(0,r._)([(0,w.Cb)({type:Number})],Xc.prototype,"zoom",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Xc.prototype,"_rasterPixelRatio",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Xc.prototype,"_usePhysicalPixelRendering",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Xc.prototype,"_usePhysicalPixelRenderingAny",null),(0,r._)([(0,w.Cb)()],Xc.prototype,"_windowDevicePixelRatio",void 0),(0,r._)([(0,w.Cb)()],Xc.prototype,"_devicePixelRatioOverride",void 0),Xc=(0,r._)([(0,x.j)("esri.views.3d.state.ViewStateManager")],Xc);class Yc{constructor(){this.width=0,this.height=0,this.pixelRatio=1}}const Kc=new Set(["camera","viewpoint","extent","scale","center","zoom"]),Qc=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],Jc={heading:0,tilt:0},eh=new n.Z,th=new po.Z,ih=(0,tc.Ue)(),rh="pending-initial-view",nh="content-camera-reset",sh=300;let ah=class extends ho{constructor(){super(...arguments),this.startCamera=new po.Z,this.currentCamera=new po.Z,this._isInteractive=!1,this._interactingTimeoutHandle=void 0}get isInteractive(){return this._isInteractive}stepController(e,t){t.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(t)}onControllerStart(e){this.state=co.Running,this.startCamera.copyFrom(e),this.currentCamera.copyFrom(e)}onControllerEnd(e){e.copyViewFrom(this.currentCamera)}commitCamera(){this._isInteractive=!0,this._interactingTimeoutHandle?.remove(),this._interactingTimeoutHandle=Qe.m.setTimeout((()=>{this._isInteractive=!1,this._interactingTimeoutHandle=void 0}),100),this.view.state.updateCamera((e=>this.stepController(0,e))),this.steppingFinished&&this.finishController()}};var oh;(0,r._)([(0,w.Cb)({readOnly:!0})],ah.prototype,"isInteractive",null),(0,r._)([(0,w.Cb)()],ah.prototype,"_isInteractive",void 0),ah=(0,r._)([(0,x.j)("esri.views.3d.state.controllers.InteractiveController")],ah),function(e){e[e.CENTER=0]="CENTER",e[e.EYE=1]="EYE"}(oh||(oh={}));let lh=class extends ah{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.pivot=oh.CENTER,this._rotScale=0,this._lastPoint=(0,Gi.Ue)(),this._tmpWorldUp=(0,R.Ue)(),this._tmpViewDir=(0,R.Ue)(),this._tmpRotCurPoint=(0,Gi.Ue)(),this._tmpTransf=(0,Bi.Ue)(),this._tmpAxis=(0,R.Ue)(),this._tmpPivotPoint=(0,R.Ue)(),this._pivotPos=(0,R.Ue)(),this._constraintOptions=new ts(Yn.ALL,Kn.TUMBLE,0,this.startCamera)}initialize(){this._rotScale=this.pivot===oh.CENTER?3:1.5}begin(e){if(this.running){switch(this.pivot){case oh.EYE:(0,Pi.c)(this._pivotPos,this.startCamera.eye),this._constraintOptions.interactionType=Kn.LOOK_AROUND,this._constraintOptions.tiltMode=Qn.LOOK_AROUND,this._constraintOptions.selection=Yn.NONE;break;case oh.CENTER:{const t=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos,this.view.basemapTerrain.invisible?Uo:{});t||(0,Pi.c)(this._pivotPos,this.startCamera.center),this._constrainPivotPoint(e,t),this.startCamera.center=this._pivotPos,this._constraintOptions.interactionType=Kn.TUMBLE,this._constraintOptions.tiltMode=Qn.TUMBLE,this._constraintOptions.selection=Yn.ALL&~Yn.DISTANCE;break}}Ho(this.startCamera,e,this._lastPoint)}}_constrainPivotPoint(e,t){const i=this.startCamera,r=(0,R.Ue)();(0,Pi.d)(r,this._pivotPos,i.eye);const n=(0,Pi.l)(r),s=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(i.eye,hh);let a=Math.max(Math.min(5,1/Math.abs((0,Pi.e)(hh,i.viewForward)))*s,10);t&&(a=Math.min(n,a));const o=(0,y.s1)(i.width/i.pixelRatio*.5,i.height/i.pixelRatio*.5),l=Qo(this.startCamera,o,this.view.renderCoordsHelper,this.view.viewingMode);let c=this.view.stage.renderView.getMinimalDepthForArea((0,ql.$L)(this.view),i.fullWidth/i.pixelRatio*.5,i.fullHeight/i.pixelRatio*.5,i,225,90),h=this.view.stage.renderView.getMinimalDepthForArea((0,ql.$L)(this.view),e[0],e[1],i,90);null==c&&null==h||(c=c??h??0,h=null==h||l===$o.Horizontal?c:h,a=c>h?h:c,a=t?Math.min(a,n):a),(0,Pi.n)(r,r),(0,Pi.c)(this._pivotPos,(0,Pi.f)(this._tmpPivotPoint,i.eye,(0,Pi.g)(this._tmpPivotPoint,r,a)))}update(e){if(this.running){switch(this.pivot){case oh.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,e,this.currentCamera.center,this._pivotPos);break;case oh.CENTER:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,e,this.currentCamera.eye,this._pivotPos)}Ca(this.view,this.currentCamera,this._constraintOptions),this.commitCamera()}}end(){this.running&&this.finishController()}_applyRotation(e,t,i,r){this.view.renderCoordsHelper.worldUpAtPosition(r,this._tmpWorldUp),Ho(e,t,this._tmpRotCurPoint);let n=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale,s=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;(0,Pi.d)(this._tmpViewDir,i,r);const a=(0,Pi.l)(this._tmpViewDir),o=(0,st.ZF)((0,Pi.e)(this._tmpViewDir,this._tmpWorldUp)/a);if(this.pivot===oh.EYE){n*=-.5;const e=.5*Math.PI-o,t=.5*Math.PI*.99;n=e-Math.max(-t,Math.min(t,e+n))}return n=(0,st.uZ)(n+o,bi.min,bi.max)-o,(0,Pi.h)(this._tmpAxis,e.up,this._tmpViewDir),this.pivot===oh.CENTER&&(s=-s),(0,Vi.Us)(this._tmpTransf,s,this._tmpWorldUp),(0,Vi.U1)(this._tmpTransf,this._tmpTransf,n,this._tmpAxis),(0,Pi.t)(this._tmpViewDir,this._tmpViewDir,this._tmpTransf),e.up=(0,Pi.t)(ch,e.up,this._tmpTransf),(0,Pi.f)(ch,r,this._tmpViewDir),(0,zi.JG)(this._lastPoint,this._tmpRotCurPoint),ch}};(0,r._)([(0,w.Cb)()],lh.prototype,"pivot",void 0),lh=(0,r._)([(0,x.j)("esri.views.3d.state.controllers.RotateController")],lh);const ch=(0,R.Ue)(),hh=(0,R.Ue)();class uh extends Xl.a{constructor(e,t,i,r){super(!0),this._view=e,this.pointerActions=t,this._pivot=i,this.registerIncoming("drag",r,(e=>this._handleDrag(e)))}_handleDrag(e){const t=e.data;if(t.pointers.size>1)return;if(!Kl(e.data,this.pointerActions))return;const i=(0,y.s1)(t.center.x,t.center.y);switch(t.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._cameraController=new lh({view:this._view,pivot:this._pivot}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":this._cameraController&&this._cameraController.update(i);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}}const dh="esri-component";let ph=class extends S.Z{constructor(){super(...arguments),this.widget=null}destroy(){this.node=null,this.widget?.destroy()}get id(){return this._get("id")??this.widget?.id??this.node?.id}set id(e){this._set("id",e)}set node(e){const t=this._get("node");e!==t&&(e&&e.classList.add(dh),t&&t.classList.remove(dh),this._set("node",e))}castNode(e){return this.widget?.destroy(),e?"string"==typeof e||function(e){return e&&"nodeType"in e}(e)?(this._set("widget",null),(0,o.L)(e)):(function(e){return e&&"function"==typeof e.render}(e)&&!e.domNode&&(e.domNode=document.createElement("div")),this._set("widget",e),e.domNode):(this._set("widget",null),null)}};(0,r._)([(0,w.Cb)()],ph.prototype,"id",null),(0,r._)([(0,w.Cb)()],ph.prototype,"node",null),(0,r._)([(0,C.p)("node")],ph.prototype,"castNode",null),(0,r._)([(0,w.Cb)({readOnly:!0})],ph.prototype,"widget",void 0),ph=(0,r._)([(0,x.j)("esri.views.ui.Component")],ph);const mh=ph;var fh=i(51067),_h=i(1803),gh=i(68808),yh=i(24225),vh=i(23039);const bh="esri-fov-overlay",wh={base:bh,outer:`${bh}-outer`,reset:`${bh}-reset`,text:`${bh}-text`};let Ch=class extends _h.Z{constructor(e){super(e),this.onReset=()=>{},this._messagesCommon=null,this._messagesUnits=null,this.fov=null}render(){return(0,vh.u)("div",{class:wh.outer},(0,vh.u)("div",{class:wh.base},(0,vh.u)("p",{class:wh.text},this._overlay),(0,vh.u)("p",{class:wh.reset,onclick:this.onReset,title:this._messagesCommon.reset},this._reset)))}get _overlay(){const{fov:e,_messagesUnits:t}=this;if(!t||null==e)return"";const i=(0,fh.L4)((0,st.BV)(e),"degrees","arithmetic","arithmetic",0),r=xh/(2*Math.tan(e/2));return`${i} | ${(0,fh.VG)(t,r,"millimeters",0,"abbr")} |`}get _reset(){return this._messagesUnits&&null!=this.fov?"↺":""}};(0,r._)([(0,w.Cb)()],Ch.prototype,"onReset",void 0),(0,r._)([(0,w.Cb)(),(0,yh.H)("esri/t9n/common")],Ch.prototype,"_messagesCommon",void 0),(0,r._)([(0,w.Cb)(),(0,yh.H)("esri/core/t9n/Units")],Ch.prototype,"_messagesUnits",void 0),(0,r._)([(0,w.Cb)()],Ch.prototype,"fov",void 0),(0,r._)([(0,w.Cb)()],Ch.prototype,"_overlay",null),(0,r._)([(0,w.Cb)()],Ch.prototype,"_reset",null),Ch=(0,r._)([(0,x.j)("esri.widgets.FovOverlay")],Ch);const xh=Math.sqrt(1872);let Th=class extends ah{constructor(e){super(e),this.onStop=null,this._timeOutId=void 0,this._onReset=()=>{this._startSize=this._lastDrag=null,this._setFov(Sh),this.updateTimeout()},this._center=(0,R.Ue)(),this._viewForward=(0,R.Ue)(),this._constraints=new ts(Yn.ALL,Kn.ZOOM)}begin(e){!function(e){return!Array.isArray(e)}(e)?(this._lastDrag=e[1],this._startSize=null,this._ensureStartSize(this.view.state.camera)):this._showOverlay().fov=e.fov}updateTimeout(){clearTimeout(this._timeOutId),this._timeOutId=setTimeout(this.onStop,1500)}update(e){if(null==this._lastDrag)return this._lastDrag=e[1],this._startSize=null,void this._ensureStartSize(this.view.state.camera);const t=-(this._lastDrag-e[1])/2;this._lastDrag=e[1],this.step(t)}step(e){if(!this.running)return void(this._startSize=this._lastDrag=null);const t=this.view.state,i=this.currentCamera.copyFrom(t.camera),r=(0,st.BV)(i.fov)+e,n=(0,st.Vl)((0,st.uZ)(r,Mh,Eh));n!==i.fov?this._setFov(n):this._showOverlay().fov=i.fov}finish(){this.running&&(this._startSize=this._lastDrag=null,this.finishController())}destroy(){this.hideOverlay()}onControllerEnd(e){super.onControllerEnd(e),this._startSize=this._lastDrag=null,this.hideOverlay()}_showOverlay(){return this._overlay||(this._overlay=new mh({id:"esri.FovOverlay",node:new Ch({onReset:this._onReset})}),this.view.ui.add(this._overlay)),this._overlay.widget}hideOverlay(){this._overlay&&(this.view.ui.remove(this._overlay),this._overlay=(0,p.SC)(this._overlay))}_setFov(e){const t=this.view.state,i=this.currentCamera.copyFrom(t.camera),r=this._ensureStartSize(i)/Math.tan(e/2),n=(0,Pi.f)(Ph,this._center,(0,Pi.g)(Ph,this._viewForward,-r));i.eye=n,i.fov=e,this._constraints.interactionStartCamera=t.camera,this._constraints.interactionFactor=xa(this.currentCamera.height-t.camera.height),Ca(this.view,this.currentCamera,this._constraints),this.begin(i),this.commitCamera()}_ensureStartSize(e){if(null==this._startSize){(0,Pi.c)(this._viewForward,e.viewForward);const t=this.view.stage.renderView.getMinimalDepthForArea(null,e.fullWidth/e.pixelRatio*.5,e.fullHeight/e.pixelRatio*.5,e,80),i=(0,Pi.j)(e.eye,this.view.pointsOfInterest.centerOnContent.renderLocation),r=t??i;(0,Pi.f)(this._center,e.eye,(0,Pi.g)(Ph,this._viewForward,r)),this._startSize=r*Math.tan(e.fov/2)}return this._startSize}};(0,r._)([(0,w.Cb)()],Th.prototype,"onStop",void 0),Th=(0,r._)([(0,x.j)("esri.views.3d.state.controllers.FovController")],Th);const Sh=(0,st.Vl)((new n.Z).fov),Mh=10,Eh=150,Ph=(0,R.Ue)();let Rh=class extends ah{constructor(){super(...arguments),this._pickPoint=(0,R.Ue)(),this._tmpP0=(0,Gi.Ue)(),this._panAxisAngle=To(),this._tmpRayDir=(0,R.Ue)(),this._tmpRayDirPick=(0,R.Ue)(),this._targetOnSphere=(0,R.Ue)(),this._navMode=$o.Horizontal,this._tmpRay={origin:(0,R.Ue)(),direction:(0,R.Ue)()},this.dragBeginPoint=(0,y.s1)(),this._normalizedAnchorPoint=(0,Gi.Ue)(),this._constraintOptions=new ts(Yn.ALL_EXCEPT_COLLISION,Kn.ZOOM,0,this.startCamera),this._sphere=(0,es.c)(),this._hasPickPoint=!1}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;(0,zi.JG)(this.dragBeginPoint,e),Ho(this.startCamera,e,this._normalizedAnchorPoint);const t=(0,Ii.Iu)(this.view.spatialReference),i=Ko(this._intersectionHelper,this.startCamera,e,t.radius,Io.Ellipsoid,this.view.basemapTerrain.invisible?Uo:{});if(this._navMode=Qo(this.startCamera,e,this.view.renderCoordsHelper,this.view.viewingMode),this._navMode===$o.Horizontal)this._hasPickPoint=!!i.scenePickPoint,this._pickPoint=i.scenePickPoint??this._pickPoint,this._sphere=i.sphere;else{let t;(0,Ao.iE)(this.startCamera,e,this._tmpRay),(0,Pi.n)(this._tmpRay.direction,this._tmpRay.direction),null!=i.scenePickPoint&&((0,Pi.d)(this._tmpRayDirPick,this.startCamera.eye,i.scenePickPoint),t=(0,Pi.l)(this._tmpRayDirPick));const r=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(this.startCamera.eye,Oh);let n=(0,st.uZ)(Math.min(30,1/Math.abs((0,Pi.e)(Oh,this._tmpRay.direction)))*r,No[0],No[1]);const s=this.view.stage.renderView.getMinimalDepthForArea(null,e[0],e[1],this.view.state.camera,80);n=null!=s?s:n,n=null!=t?Math.min(n,t):n,this._hasPickPoint=!0,(0,Pi.g)(this._tmpRay.direction,this._tmpRay.direction,n),(0,Pi.f)(this._pickPoint,this._tmpRay.origin,this._tmpRay.direction)}}update(e){if(this.running){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this._navMode===$o.Horizontal){(0,Pi.d)(this._tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const t=(0,Pi.l)(this._tmpRayDir);Ho(this.currentCamera,e,this._tmpP0);const i=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let r=t*2**i;const n=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<n&&(r=n),Math.abs(t-r)<1e-6)return;if(this._hasPickPoint&&r<t){const e=1-(1-r/t)*(1-this._sphere[3]/(0,Pi.l)(this.currentCamera.center));this.currentCamera.center=(0,Pi.g)(Ah,this.currentCamera.center,e)}(0,Pi.g)(this._tmpRayDir,this._tmpRayDir,-r/t),this.currentCamera.eye=(0,Pi.f)(Ah,this.currentCamera.center,this._tmpRayDir),this._constraintOptions.interactionFactor=xa((0,zi.TE)(this.dragBeginPoint,e)),Ca(this.view,this.currentCamera,this._constraintOptions),this._hasPickPoint&&(tl(this._sphere,this.currentCamera,this.dragBeginPoint,this._targetOnSphere),Eo(this._pickPoint,this._targetOnSphere,this._panAxisAngle),Vo(this.currentCamera,(0,es.a)(this._sphere),this._panAxisAngle))}else{const t=(0,Pi.l)(this._tmpRay.direction);Ho(this.currentCamera,e,this._tmpP0);const i=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let r=t*2**i;const n=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<n&&(r=n),Math.abs(t-r)<1e-6)return;(0,Pi.g)(this._tmpRayDir,this._tmpRay.direction,1-r/t),this.currentCamera.eye=(0,Pi.f)(Ah,this.currentCamera.eye,this._tmpRayDir),this.currentCamera.center=(0,Pi.f)(Ah,this.currentCamera.center,this._tmpRayDir)}xs(this.view,this.currentCamera),this.commitCamera()}}finish(){this.running&&this.finishController()}};Rh=(0,r._)([(0,x.j)("esri.views.3d.state.controllers.ZoomControllerGlobal")],Rh);const Ah=(0,R.Ue)(),Oh=(0,R.Ue)();let Dh=class extends ah{constructor(){super(...arguments),this._tmpP=(0,R.Ue)(),this._tmpDir=(0,R.Ue)(),this._tmpN=(0,R.Ue)(),this._tmpP0=(0,Gi.Ue)(),this._tmpPOI=(0,R.Ue)(),this._tmpRayDir=(0,R.Ue)(),this.dragBeginPoint=(0,y.s1)(),this._normalizedAnchorPoint=(0,Gi.Ue)(),this._constraintOptions=new ts(Yn.ALL,Kn.ZOOM,0,this.startCamera,(0,R.Ue)()),this._plane=(0,Ro.Ue)()}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;(0,zi.JG)(this.dragBeginPoint,e),Ho(this.startCamera,e,this._normalizedAnchorPoint);const t=this._intersectionHelper.intersectScreenFreePointFallback(e,this._tmpP,this.view.basemapTerrain.invisible?Uo:{});(0,Pi.d)(this._tmpDir,this._tmpP,this.startCamera.eye);const i=(0,Pi.l)(this._tmpDir);(0,Pi.n)(this._tmpDir,this._tmpDir);const r=Math.abs(this.view.camera.position.z);let n=(0,st.uZ)(Math.min(30,1/Math.abs((0,Pi.e)(Lh,this._tmpDir)))*r,No[0],No[1]);const s=this.view.stage.renderView.getMinimalDepthForArea((0,ql.$L)(this.view),e[0],e[1],this.view.state.camera,80);n=null!=s?s:n,n=t?Math.min(n,i):n,(0,Pi.g)(this._tmpDir,this._tmpDir,n),(0,Pi.f)(this._tmpP,this.startCamera.eye,this._tmpDir),(0,Pi.d)(this._tmpN,this.startCamera.eye,this.startCamera.center),(0,Pi.n)(this._tmpN,this._tmpN),this._tmpN[1]<0&&(0,Pi.u)(this._tmpN,this._tmpN),(0,Ro.Yq)(this._tmpP,this._tmpN,this._plane)}update(e){if(!this.running)return;(function(e,t,i,r){return(0,Ro.BR)(e,(0,Ao.u4)(t,i,kl),r)})(this._plane,this.currentCamera,this.dragBeginPoint,this._tmpPOI)||(0,Pi.c)(this._tmpPOI,this.currentCamera.center),Ho(this.currentCamera,e,this._tmpP0);let t=4*(this._tmpP0[1]-this._normalizedAnchorPoint[1]);(0,zi.JG)(this._normalizedAnchorPoint,this._tmpP0),(0,Pi.d)(this._tmpRayDir,this._tmpPOI,this.currentCamera.eye);const i=(0,Pi.l)(this._tmpRayDir);let r=i*(1-t);this._constraintOptions.interactionDirection&&((0,Pi.c)(this._constraintOptions.interactionDirection,this._tmpRayDir),(0,Pi.g)(this._constraintOptions.interactionDirection,this._constraintOptions.interactionDirection,Math.sign(t)/i));const n=this.view.state.constraints.minimumPoiDistance;t>=0&&r<n&&(r=n,t=-(r-i)/i),Math.abs(i-r)<1e-6||((0,Pi.g)(this._tmpRayDir,this._tmpRayDir,t),this.currentCamera.eye=(0,Pi.f)(Ih,this.currentCamera.eye,this._tmpRayDir),(0,Pi.m)(Ih,this.currentCamera.center,this._tmpPOI,t),this._tmpPOI[2]>this.startCamera.center[2]?Ih[2]=Math.max(this.startCamera.center[2],Ih[2]):Ih[2]=Math.min(this.startCamera.center[2],Ih[2]),this.currentCamera.center=Ih,this._constraintOptions.interactionFactor=xa((0,zi.TE)(this.dragBeginPoint,e)),Ca(this.view,this.currentCamera,this._constraintOptions),this.commitCamera())}finish(){this.running&&this.finishController()}};Dh=(0,r._)([(0,x.j)("esri.views.3d.state.controllers.ZoomControllerLocal")],Dh);const Ih=(0,R.Ue)(),Lh=(0,R.al)(0,0,1);class Nh extends Xl.a{constructor(e,t,i){super(!0),this._view=e,this.pointerActions=t,this._fovModifier=i,this.registerIncoming("drag",[i],(e=>this._handleZoom(e))),this.registerIncoming("drag",(e=>this._handleZoom(e)))}_handleZoom(e){const t=e.data;if(t.pointers.size>1)return;if(!Kl(e.data,this.pointerActions))return;const i=(0,y.s1)(t.center.x,t.center.y);switch(t.action){case"start":{this._cameraController?.finish();const t=this._view,r=e.modifiers.has(this._fovModifier);this._cameraController=r?new Th({view:t,onStop:()=>this._stopController()}):t.state.isGlobal?new Rh({view:t}):new Dh({view:t}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break}case"update":this._cameraController?.update(i);break;case"end":this._cameraController instanceof Th?this._cameraController.updateTimeout():this._stopController()}e.stopPropagation()}_stopController(){this._cameraController?.finish(),this._cameraController=null}}var Fh=i(59758);function Uh(e){let t=e*e;return e<0&&(t*=-1),t}function Hh(e,t,i){const r=i,n=e.state,s=e.device,a="forward-down"===t.tiltDirection?1:-1;return"standard"===s.deviceType?(r.translation[0]=Uh(n.axes[0]),r.translation[1]=Uh(n.axes[1]),r.translation[2]=Uh(n.buttons[7])-Uh(n.buttons[6]),r.heading=Uh(n.axes[2]),r.tilt=Uh(n.axes[3])):"spacemouse"===s.deviceType&&(r.translation[0]=1.2*Uh(n.axes[0]),r.translation[1]=1.2*Uh(n.axes[1]),r.translation[2]=2*-Uh(n.axes[2]),r.heading=1.2*Uh(n.axes[5]),r.tilt=1.2*Uh(n.axes[3])),r.tilt*=a,(0,Pi.g)(r.translation,r.translation,1),r}function kh(e,t){const i=t;return i.translation[0]=e[1]-e[0],i.translation[1]=e[3]-e[2],i.translation[2]=e[4]-e[5],i.heading=e[7]-e[6],i.tilt=e[8]-e[9],i.zoom=e[10]-e[11],i}function Vh(e){return 0===e.translation[0]&&0===e.translation[1]&&0===e.translation[2]&&0===e.heading&&0===e.tilt&&0===e.zoom}let Bh=class extends ah{constructor(e){super(e),this._filteredSurfaceElevation=0,this._transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this._keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this._tmpCamera=new po.Z,this._headingStart=0,this._constraintOptions=new ts(Yn.ALL,Kn.NONE,0,new po.Z,null,Qn.LOOK_AROUND)}handleEventGamepad(e){const t=Hh(e,this.view.navigation.gamepad,this._transformation);("end"===e.action||Vh(t))&&this.finishController()}activateDirection(e){this._keysButtonState[e]=1,kh(this._keysButtonState,this._transformation)}directionActive(e){return 1===this._keysButtonState[e]}countActiveDirections(){return this._keysButtonState.reduce(((e,t)=>t>0?e+1:e),0)}deactivateDirection(e){this._keysButtonState[e]=0;Vh(kh(this._keysButtonState,this._transformation))&&this.finishController()}onControllerStart(e){this._filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this._headingStart=this.view.camera.heading,super.onControllerStart(e)}_updateFilteredSurfaceElevation(e){const t=this.view.pointsOfInterest.cameraOnSurface.location.z;this._filteredSurfaceElevation+=1*(t-this._filteredSurfaceElevation)*e}stepController(e,t){this._updateStartHeading(),this._updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(t),this._updateCameraCenter(),this._constraintOptions.interactionStartCamera?.copyFrom(this.currentCamera),this._calculateControlTransformation(e,this.currentCamera,Xh),this._applyDisabledMovementTypes(Xh),this._applyPan(Xh.pan),this._applyRotate(Xh.rotate),this._applyZoom(Xh.zoom),this._applyAscend(Xh.ascend),this._constraintOptions.interactionType=Kn.NONE,this._constraintOptions.selection=Yn.COLLISION,Ca(this.view,this.currentCamera,this._constraintOptions),super.stepController(e,t)}_updateStartHeading(){0!==this._transformation.heading&&(this._headingStart=this.view.camera.heading)}_applyRotate(e){if(!e.enabled)return;const t=this.currentCamera;(0,Pi.d)(Yh,t.center,t.eye),(0,Pi.t)(Yh,Yh,e.matrix),t.center=(0,Pi.f)(Yh,Yh,t.eye),t.up=(0,Pi.t)(Yh,t.up,e.matrix),this._constraintOptions.interactionType=Kn.LOOK_AROUND,this._constraintOptions.selection=Yn.ALL_EXCEPT_COLLISION,Ca(this.view,t,this._constraintOptions)}_applyPan(e,t=this.currentCamera){e.enabled&&(t.eye=(0,Pi.t)(Yh,t.eye,e.matrix),t.center=(0,Pi.t)(Yh,t.center,e.matrix),this.view.state.isGlobal&&(t.up=(0,Pi.t)(Yh,t.up,e.matrix)),this._constraintOptions.interactionType=Kn.PAN,this._constraintOptions.selection=Yn.ALL,Ca(this.view,t,this._constraintOptions))}_applyZoom(e){if(!e)return;const t=this.currentCamera.viewForward;this.currentCamera.eye=(0,Pi.f)(Yh,this.currentCamera.eye,(0,Pi.g)(xo.WM.get(),t,e)),(0,Pi.c)(Kh,t),(0,Pi.u)(Kh,Kh),this._constraintOptions.interactionDirection=Kh,this._constraintOptions.interactionType=Kn.ZOOM,this._constraintOptions.selection=Yn.ALL_EXCEPT_COLLISION,Ca(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_applyAscend(e){if(!e)return;const t=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,xo.WM.get());if(this._constraintOptions.interactionDirection=(0,Pi.c)(Kh,t),this.view.state.isGlobal){const t=(0,Pi.l)(this.currentCamera.eye),i=(t+e)/t;this.currentCamera.eye=(0,Pi.g)(Yh,this.currentCamera.eye,i),this.currentCamera.center=(0,Pi.g)(Yh,this.currentCamera.center,i)}else{const i=(0,Pi.g)(xo.WM.get(),t,e);this.currentCamera.eye=(0,Pi.f)(Yh,this.currentCamera.eye,i),this.currentCamera.center=(0,Pi.f)(Yh,this.currentCamera.center,i)}this._updateCameraCenter(),this._constraintOptions.interactionType=Kn.ASCEND,this._constraintOptions.selection=Yn.COLLISION,Ca(this.view,this.currentCamera,this._constraintOptions)&&this._updateCameraCenter(),this._constraintOptions.selection=Yn.ALL_EXCEPT_COLLISION,Ca(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_calculateControlTransformation(e,t,i){!function(e){e.zoom=0,e.ascend=0,e.pan.enabled=!1,(0,Vi.yR)(e.pan.matrix),e.rotate.enabled=!1,(0,Vi.yR)(e.rotate.matrix)}(i);const r=this._computeVelocities(e);this.view.state.isLocal?this._calculateControlTransformationLocal(r,t,i):this._calculateControlTransformationGlobal(r,t,i)}_updateCameraCenter(){const e=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,t=this.view.renderCoordsHelper,i=this.currentCamera.ray;this.currentCamera.center=t.intersectManifoldClosestSilhouette(i,e,Yh)}_calculateControlTransformationLocal(e,t,i){const{viewRight:r,viewForward:n}=t,s=this._transformation,a=this.view.navigation.gamepad,o=(0,Pi.i)(xo.WM.get(),n[0],n[1],0);(0,Pi.n)(o,o);const l=s.translation[0]*e.pan;if(0!==l){const e=(0,Pi.g)(xo.WM.get(),r,l);(0,Vi.Iu)(i.pan.matrix,i.pan.matrix,e),i.pan.enabled=!0}switch(a.mode){case"pan":{const t=-s.translation[1]*e.pan;if(0!==t){const e=(0,Pi.g)(xo.WM.get(),o,t);(0,Vi.Iu)(i.pan.matrix,i.pan.matrix,e),i.pan.enabled=!0}i.zoom=s.zoom*e.zoom;break}case"zoom":i.zoom=(-s.translation[1]+s.zoom)*e.zoom;break;default:(0,Hi.Bg)(a.mode)}const c=s.translation[2]*e.ascend;i.ascend=c;const h=-s.heading*e.rotate;0!==h&&((0,Vi.U1)(i.rotate.matrix,i.rotate.matrix,h,this.view.renderCoordsHelper.worldUpAtPosition(t.eye,xo.WM.get())),i.rotate.enabled=!0);const u=s.tilt*e.rotate,d=(0,Ms.L)(this.view.renderCoordsHelper,t.center,t.eye),p=(0,st.uZ)(d+u,bi.min,bi.max)-d;p&&((0,Vi.U1)(i.rotate.matrix,i.rotate.matrix,p,r),i.rotate.enabled=!0)}_calculateControlTransformationGlobal(e,t,i){const{eye:r,viewRight:n}=t,s=this._transformation,a=this.view.navigation.gamepad,o=(0,Pi.h)(xo.WM.get(),n,r);(0,Pi.n)(o,o),(0,Pi.u)(o,o),vl(this.startCamera,t,s,e,this.view.camera.heading,this._headingStart,this.view.camera.tilt,i,a),this._tmpCamera.copyFrom(this.currentCamera),this._applyPan(Xh.pan,this._tmpCamera);const l=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,c=s.translation[2]*e.ascend;i.ascend=c;const h=-s.heading*e.rotate;0!==h&&((0,Vi.U1)(i.rotate.matrix,i.rotate.matrix,h,this._tmpCamera.eye),i.rotate.enabled=!0);const u=s.tilt*e.rotate,d=this._clampTiltDeltaGlobalToValidRange(u,t.ray,l);0!==d&&((0,Vi.U1)(i.rotate.matrix,i.rotate.matrix,d,this._tmpCamera.viewRight),i.rotate.enabled=!0),i.zoom+=s.zoom*e.zoom}_clampTiltDeltaGlobalToValidRange(e,t,i){const r=(0,Ii.Iu)(this.view.spatialReference),n=jo(bi.min,t.origin,i,r);let s=0,a=0;const o=xo.WM.get();if(this.view.renderCoordsHelper.intersectManifold(t,i,o)){s=jo((0,Ms.L)(this.view.renderCoordsHelper,o,t.origin),t.origin,i,r),a=jo(bi.max,t.origin,i,r)}else{(0,es.j)((0,es.b)(es.t,i+r.radius),t,o);s=Wo(Math.PI+(0,Co.EU)(t.direction,o),t.origin,i,r),a=Wo(bi.max,t.origin,i,r)}return(0,st.uZ)(s+e,n,a)-s}_getPointAbsoluteSurfaceElevation(e,t,i){const{renderCoordsHelper:r}=this.view,n=r.getAltitude(e),s=t+Math.abs(n-t);return r.setAltitude(i,s,e),s}_clampedDistanceToSurface(e,t){const{renderCoordsHelper:i}=this.view,{camera:r}=this.view.state,{direction:n}=(0,se.kE)(this.view,t,0,Gh,Qh),s=i.intersectManifoldClosestSilhouette((0,Jn.re)(t,n),e,xo.WM.get()),a=(0,Pi.j)(t,s),o=i.intersectManifoldClosestSilhouette((0,Jn.re)(t,(0,Pi.E)(xo.WM.get(),t,r.center)),e,xo.WM.get()),l=(0,Pi.j)(t,o);return Math.min(a,l)}_computeHeadingRotateRadius(e){const{renderCoordsHelper:t,state:i}=this.view,{camera:r,isGlobal:n}=i,s=t.intersectManifoldClosestSilhouette(r.ray,this._filteredSurfaceElevation,xo.WM.get());if(n){const t=(0,Pi.d)(xo.WM.get(),e,s),i=(0,Pi.l)(t);(0,Pi.g)(t,t,1/i);const r=(0,Pi.n)(xo.WM.get(),e),n=(0,st.ZF)((0,Pi.e)(r,t));return i*Math.sin(Math.min(qh,n))}{const i=(0,Pi.c)(xo.WM.get(),e);return t.setAltitude(i,this._filteredSurfaceElevation),(0,Pi.j)(s,i)}}_minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:jh}_computeVelocities(e){const t=this._filteredSurfaceElevation,i=t+(0,Ii.Iu)(this.view.spatialReference).radius,{camera:r,isGlobal:n}=this.view.state,s=xo.WM.get(),a=this._getPointAbsoluteSurfaceElevation(r.eye,t,s),o=this._clampedDistanceToSurface(t,s),l=r.width/2,c=Zh*r.width,h=Zh*r.width,u=o*Math.tan(.5*r.fovX)/l,d=u/i,p=u/this._computeHeadingRotateRadius(s),m=a-t;return{pan:(n?d:u)*c*e,ascend:Math.max(this._minimumAscendVelocity()*e,2**(c*e/l)*m-m),zoom:2**(c*e/l)*o-o,rotate:(0,st.uZ)(p*h,Wh,$h)*e}}_applyDisabledMovementTypes(e){null==this.disableMovements||void 0!==this.disableMovements.mode&&this.view.state.viewingMode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&(0,Vi.yR)(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&(0,Vi.yR)(e.rotate.matrix))}static activatesFor(e,t){const i=Hh(t,e.navigation.gamepad,zh);return!("end"===t.action||Vh(i))}};(0,r._)([(0,w.Cb)({constructOnly:!0})],Bh.prototype,"gamepadDevice",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],Bh.prototype,"disableMovements",void 0),Bh=(0,r._)([(0,x.j)("esri.views.3d.state.controllers.GamepadKeyboardController")],Bh);const zh={translation:[0,0,0],heading:0,tilt:0,zoom:0},Gh=80,qh=(0,st.Vl)(Gh),Zh=.75,jh=5,Wh=(0,st.Vl)(30),$h=(0,st.Vl)(80),Xh={zoom:0,ascend:0,pan:{enabled:!1,matrix:(0,Bi.Ue)()},rotate:{enabled:!1,matrix:(0,Bi.Ue)()}},Yh=(0,R.Ue)(),Kh=(0,R.Ue)(),Qh=(0,Fh.dp)();class Jh extends Xl.a{constructor(e){super(!0),this._view=e,this._watchHandles=new Te.Z,this._handle=this.registerIncoming("gamepad",(e=>this._handleEventGamepad(e))),this._handle.pause()}onInstall(e){super.onInstall(e),this._watchHandles.add([(0,_.YP)((()=>this._view.navigation.gamepad.enabled),(e=>{e?this._handle.resume():(this._handle.pause(),this._cameraControllerGamepad&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null))}),_.nn),(0,_.YP)((()=>this._view.navigation.gamepad.device),(e=>{this._cameraControllerGamepad&&e&&this._cameraControllerGamepad.gamepadDevice!==e&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null)}))])}onUninstall(){this._watchHandles.removeAll(),super.onUninstall()}_handleEventGamepad(e){const t=this._view.navigation.gamepad.device;if(t&&e.data.device!==t)return;const i=this._cameraControllerGamepad?.running;if(i||Bh.activatesFor(this._view,e.data)){if(!i){const t=new Bh({view:this._view,gamepadDevice:e.data.device});this._view.state.switchCameraController(t),t.state!==co.Rejected&&(this._cameraControllerGamepad=t)}this._cameraControllerGamepad&&this._cameraControllerGamepad.running&&this._cameraControllerGamepad.gamepadDevice===e.data.device&&this._cameraControllerGamepad.handleEventGamepad(e.data)}}}var eu;!function(e){e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT",e[e.FORWARD=2]="FORWARD",e[e.BACKWARD=3]="BACKWARD",e[e.UP=4]="UP",e[e.DOWN=5]="DOWN",e[e.HEADINGLEFT=6]="HEADINGLEFT",e[e.HEADINGRIGHT=7]="HEADINGRIGHT",e[e.TILTUP=8]="TILTUP",e[e.TILTDOWN=9]="TILTDOWN",e[e.ZOOMIN=10]="ZOOMIN",e[e.ZOOMOUT=11]="ZOOMOUT"}(eu||(eu={}));class tu extends Xl.a{constructor(e,t){super(!0),this._view=e,this._keyToDirection=new Map,this._keyToAction=new Map,this._disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:Ht.JY.Local},this._stickyKeyTimeoutHandle=void 0,this._stickyKeyDuration=200,this._addKeysMapping(t),this.registerIncoming("key-down",null,(e=>this._handleKeyDown(e))),this.registerIncoming("key-up",null,(e=>this._handleKeyUp(e))),this.registerIncoming("blur",null,(()=>this._handleStop())),this._visibilityHandle=function(e){const t=()=>e("visible"===document.visibilityState);return document.addEventListener("visibilitychange",t),(0,h.kB)((()=>document.removeEventListener("visibilitychange",t)))}((e=>e?null:this._handleStop()))}onUninstall(){this._visibilityHandle?.remove(),this._handleStop()}setStickyKeyDuration(e){this._stickyKeyDuration=e}_addKeysMapping(e){this._addKeyMapping(e.pan.left,eu.LEFT),this._addKeyMapping(e.pan.right,eu.RIGHT),this._addKeyMapping(e.pan.forward,eu.FORWARD),this._addKeyMapping(e.pan.backward,eu.BACKWARD),this._addKeyMapping(e.pan.up,eu.UP),this._addKeyMapping(e.pan.down,eu.DOWN),this._addKeyMapping(e.lookAround.headingLeft,eu.HEADINGLEFT),this._addKeyMapping(e.lookAround.headingRight,eu.HEADINGRIGHT),this._addKeyMapping(e.lookAround.tiltUp,eu.TILTUP),this._addKeyMapping(e.lookAround.tiltDown,eu.TILTDOWN),this._addKeyMapping(e.zoom.zoomIn,eu.ZOOMIN),this._addKeyMapping(e.zoom.zoomOut,eu.ZOOMOUT),this._addKeyAction(e.reset.heading,(()=>this._resetHeading())),this._addKeyAction(e.reset.tilt,(()=>this._resetTilt()))}_addKeyMapping(e,t){for(const i of this._eachKey(e))this._keyToDirection.set(i,t)}*_eachKey(e){"string"==typeof e?yield e:yield*e}_addKeyAction(e,t){for(const i of this._eachKey(e))this._keyToAction.set(i,t)}_handleKeyDown(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this._keyToAction.get(e.data.key);if(null!=t)return e.stopPropagation(),void t();const i=this._keyToDirection.get(e.data.key);if(null!=i&&(this._cameraControllerKeyboard&&this._cameraControllerKeyboard.running||(this._cameraControllerKeyboard=new Bh({view:this._view,disableMovements:this._disableMovements}),this._view.state.switchCameraController(this._cameraControllerKeyboard)),this._cameraControllerKeyboard.running)){if(e.stopPropagation(),this._cameraControllerKeyboard.directionActive(i))return;if(this._cameraControllerKeyboard.activateDirection(i),this._cameraControllerKeyboard.countActiveDirections()>1||!this._isPanning(i))return;this._stickyKeyDuration>0&&(this._stickyKeyTimeoutHandle=setTimeout((()=>{this._stickyKeyTimeoutHandle=void 0,null!=this._stickyDirection&&void 0!==this._stickyDirection&&(this._cameraControllerKeyboard?.deactivateDirection(this._stickyDirection),this._stickyDirection=void 0)}),this._stickyKeyDuration))}}_handleStop(){this._cameraControllerKeyboard?.running&&(this._cameraControllerKeyboard.finishController(),this._cameraControllerKeyboard=null)}_handleKeyUp(e){if(e.data.native.ctrlKey||e.data.native.metaKey||!this._cameraControllerKeyboard?.running)return;const t=this._keyToDirection.get(e.data.key);if(null==t)return;e.stopPropagation();const i=void 0===this._stickyKeyTimeoutHandle;void 0===this._stickyKeyTimeoutHandle||1!==this._cameraControllerKeyboard?.countActiveDirections()?(this._cameraControllerKeyboard?.deactivateDirection(t),i&&(this._stickyDirection=void 0)):this._stickyDirection=t}_isPanning(e){return e<=3}_resetHeading(){this._view.goTo({heading:0}).catch((()=>{}))}_resetTilt(){this._view.goTo({tilt:0}).catch((()=>{}))}}class iu extends Xl.a{constructor(e,t){super(!0),this._view=e,this.registerIncoming("mouse-wheel",[t],(e=>this._handleFov(e))),this.registerIncoming("mouse-wheel",(e=>this._handleZoom(e)))}_handleZoom(e){if(!this._mouseWheelZoomEnabled)return;const t=e.data;this._zoomController?.running||(this._stopFovController(),this._zoomController=this._view.state.isGlobal?new Bl({view:this._view,mode:"interaction"}):new Zl({view:this._view,mode:"interaction"}),this._view.state.switchCameraController(this._zoomController)),this._zoomController.step(-t.deltaY/60,(0,y.s1)(t.x,t.y)),e.preventDefault(),e.stopPropagation()}_handleFov(e){this._mouseWheelZoomEnabled&&(this._fovController?.running||(this._zoomController?.finish(),this._fovController?.hideOverlay(),this._fovController=new Th({view:this._view,onStop:()=>this._stopFovController()}),this._view.state.switchCameraController(this._fovController),this._fovController.state!==co.Rejected)?(this._fovController.updateTimeout(),this._fovController.step(e.data.deltaY/20),e.preventDefault(),e.stopPropagation()):this._stopFovController())}get _mouseWheelZoomEnabled(){return"zoom"===this._view.navigation.actionMap.mouseWheel}_stopFovController(){this._fovController?.finish(),this._fovController=null}}class ru{constructor(e){this._gain=e}reset(e){this._value=e}set gain(e){this._gain=e}get value(){return void 0===this._value?0:this._value}update(e){void 0===this._value?this._value=e:this._value=this._gain*e+(1-this._gain)*this._value}}let nu=class extends uo{constructor(){super(...arguments),this._beginCamera=new po.Z,this._elapsedTimeSec=0,this.constraintOptions=new ts(Yn.ALL,Kn.PAN,0,this._beginCamera)}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new ni}get steppingFinished(){return this.momentum.isFinished(this._elapsedTimeSec)}onControllerStart(e){this._beginCamera.copyFrom(e),super.onControllerStart(e)}stepController(e,t){t.copyViewFrom(this._beginCamera),this._elapsedTimeSec+=e,this.momentumStep(this._elapsedTimeSec,t),Ca(this.view,t,this.constraintOptions)}};nu=(0,r._)([(0,x.j)("esri.views.3d.state.controllers.momentum.MomentumController")],nu);let su=class extends nu{constructor(e){super(e),this.interactionType=Kn.PAN,this._tmpPan=(0,R.Ue)()}momentumStep(e,t){const i=this.momentum.value(e);(0,Pi.g)(this._tmpPan,this.momentum.direction,i),t.eye=(0,Pi.d)(au,t.eye,this._tmpPan),t.center=(0,Pi.d)(au,t.center,this._tmpPan),this.constraintOptions.interactionDirection=this._tmpPan}};(0,r._)([(0,w.Cb)({constructOnly:!0})],su.prototype,"momentum",void 0),su=(0,r._)([(0,x.j)("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],su);const au=(0,R.Ue)(),ou=(0,R.Ue)(),lu=(0,R.Ue)();let cu=class extends nu{constructor(e){super(e),this.interactionType=Kn.PAN}momentumStep(e,t){const i=this.momentum.value1(e),r=this.momentum.value2(e);(0,Pi.c)(lu,t.eye),(0,Pi.n)(lu,lu),(0,Pi.h)(this.momentum.axis2,lu,this.momentum.axis1),hl(t,ou,this.momentum.axis1,i,this.momentum.axis2,r)}};(0,r._)([(0,w.Cb)({constructOnly:!0})],cu.prototype,"momentum",void 0),cu=(0,r._)([(0,x.j)("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],cu);let hu=class extends nu{set center(e){this._set("center",(0,R.d9)(e))}set axis(e){this._set("axis",(0,R.d9)(e))}constructor(e){super(e),this.interactionType=Kn.TUMBLE}momentumStep(e,t){const i=this.momentum.value(e);Vo(t,this.center,So(this.axis,i))}};(0,r._)([(0,w.Cb)({constructOnly:!0})],hu.prototype,"momentum",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],hu.prototype,"center",null),(0,r._)([(0,w.Cb)({constructOnly:!0})],hu.prototype,"axis",null),hu=(0,r._)([(0,x.j)("esri.views.3d.state.controllers.momentum.RotationMomentumController")],hu);let uu=class extends nu{set zoomCenter(e){this._set("zoomCenter",(0,R.d9)(e))}constructor(e){super(e),this.interactionType=Kn.ZOOM,this.constraintOptions.interactionDirection=(0,R.Ue)()}momentumStep(e,t){const{interactionDirection:i}=this.constraintOptions;if(!i)return;(0,Pi.c)(i,t.eye);const r=this.momentum.valueDelta(0,e);zo(t,this.zoomCenter,r,this.view.state.constraints.minimumPoiDistance),(0,Pi.E)(i,t.eye,i)}};(0,r._)([(0,w.Cb)({constructOnly:!0})],uu.prototype,"momentum",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],uu.prototype,"zoomCenter",null),uu=(0,r._)([(0,x.j)("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],uu);let du=class extends nu{set screenCenter(e){this._set("screenCenter",(0,y.s1)(e[0],e[1]))}set sceneCenter(e){this._set("sceneCenter",(0,R.d9)(e))}constructor(e){super(e),this.interactionType=Kn.ZOOM,this.radius=0,this._tmpSceneCenter=(0,R.Ue)(),this._tmpZoomAxisAngle=To(),this._sphere=(0,es.c)()}initialize(){this._sphere[3]=this.radius}momentumStep(e,t){const i=this.momentum.valueDelta(0,e);Go(this._sphere,t,i),this.constraintOptions.interactionType=Kn.ZOOM,Ca(this.view,t,this.constraintOptions),tl(this._sphere,t,this.screenCenter,this._tmpSceneCenter),Eo(this.sceneCenter,this._tmpSceneCenter,this._tmpZoomAxisAngle),Vo(t,(0,es.a)(this._sphere),this._tmpZoomAxisAngle),this.constraintOptions.interactionType=Kn.PAN}};(0,r._)([(0,w.Cb)({constructOnly:!0})],du.prototype,"momentum",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],du.prototype,"screenCenter",null),(0,r._)([(0,w.Cb)({constructOnly:!0})],du.prototype,"sceneCenter",null),(0,r._)([(0,w.Cb)({constructOnly:!0})],du.prototype,"radius",void 0),du=(0,r._)([(0,x.j)("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],du);class pu{constructor(e){this._gain=e,this.lastValue=void 0,this.filteredDelta=void 0}update(e){if(this.hasLastValue()){const t=this.computeDelta(e);this._updateDelta(t)}this.lastValue=e}reset(){this.lastValue=void 0,this.filteredDelta=void 0}hasLastValue(){return void 0!==this.lastValue}hasFilteredDelta(){return void 0!==this.filteredDelta}computeDelta(e){return void 0===this.lastValue?NaN:e-this.lastValue}_updateDelta(e){void 0!==this.filteredDelta?this.filteredDelta=(1-this._gain)*this.filteredDelta+this._gain*e:this.filteredDelta=e}}class mu{constructor(e,t,i){this._initialVelocity=e,this._stopVelocity=t,this._friction=i,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}get duration(){return this._duration}isFinished(e){return e>this.duration}get friction(){return this._friction}value(e){return this.valueFromInitialVelocity(this._initialVelocity,e)}valueDelta(e,t){const i=this.value(e);return this.value(e+t)-i}valueFromInitialVelocity(e,t){t=Math.min(t,this.duration);const i=1-this.friction;return e*(i**t-1)/Math.log(i)}}class fu extends mu{constructor(e,t,i,r,n){super(e,t,i),this._sceneVelocity=r,this.direction=n}value(e){return super.valueFromInitialVelocity(this._sceneVelocity,e)}}class _u{constructor(e=300,t=12,i=.84){this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=i,this.enabled=!0,this._time=new pu(.6),this._screen=[new pu(.4),new pu(.4)],this._scene=[new pu(.6),new pu(.6),new pu(.6)],this._tmpDirection=(0,R.Ue)()}add(e,t,i){if(this.enabled){if(this._time.hasLastValue()&&this._time.computeDelta(i)<.015)return;this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._scene[0].update(t[0]),this._scene[1].update(t[1]),this._scene[2].update(t[2]),this._time.update(i)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._scene[0].reset(),this._scene[1].reset(),this._scene[2].reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta()||!this._time.hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,i=null==e||null==t?0:Math.sqrt(e*e+t*t),r=this._time.filteredDelta,n=null==r||null==i?0:i/r;return Math.abs(n)<this._minimumInitialVelocity?null:this.createMomentum(n,this._stopVelocity,this._friction)}createMomentum(e,t,i){(0,Pi.i)(this._tmpDirection,this._scene[0].filteredDelta??0,this._scene[1].filteredDelta??0,this._scene[2].filteredDelta??0);const r=(0,Pi.l)(this._tmpDirection);r>0&&(0,Pi.g)(this._tmpDirection,this._tmpDirection,1/r);const n=this._time.filteredDelta;return new fu(e,t,i,null==n?0:r/n,this._tmpDirection)}}class gu{constructor(e){this._gain=e}update(e){void 0!==this.filteredValue?this.filteredValue=(1-this._gain)*this.filteredValue+this._gain*e:this.filteredValue=e}reset(){this.filteredValue=void 0}get hasFilteredValue(){return void 0!==this.filteredValue}}const yu=1e-5;class vu extends mu{constructor(e,t,i,r,n,s=0,a){super(e,t,i),this._angularVelocity1=r,this.axis1=n,this.angularVelocity2=s,this.axis2=a}value1(e){return super.valueFromInitialVelocity(this._angularVelocity1,e)}value2(e){return super.valueFromInitialVelocity(this.angularVelocity2,e)}}class bu{constructor(e=300,t=12,i=.84){this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=i,this.enabled=!0,this._tmpAxis1=(0,R.Ue)(),this._tmpAxis2=(0,R.Ue)(),this._tmpAngles=(0,Gi.Ue)(),this._time=new pu(.3),this._screen=[new pu(.4),new pu(.4)],this._angle1=new gu(.6),this._angle2=new gu(.6),this._axis1=(0,R.Ue)(),this._axis2=(0,R.Ue)(),this._lastScene=(0,R.Ue)()}addMomentumDirectRotation(e,t,i,r,n,s){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;let e=sl(this._lastScene,t,this._tmpAxis2,r,n,s);this._angle2.update(0),(0,Pi.k)(this._tmpAxis2)<yu?e=0:(0,Pi.n)(this._axis1,this._tmpAxis2),this._angle1.update(e),(0,Pi.c)(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}addMomentumPreserveHeading(e,t,i,r,n,s,a){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;ll(this._lastScene,t,this._tmpAxis2,this._tmpAxis1,this._tmpAngles,r,n,s,a,!1),(0,Pi.k)(this._tmpAxis2)<yu?(this._angle1.update(0),this._angle2.update(0)):(this._angle1.update(this._tmpAngles[1]),this._angle2.update(this._tmpAngles[0]),(0,Pi.n)(this._axis1,this._tmpAxis1),(0,Pi.n)(this._axis2,this._tmpAxis2)),(0,Pi.c)(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._angle1.reset(),this._angle2.reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,i=null==e||null==t?null:Math.sqrt(e*e+t*t),r=this._time.filteredDelta,n=null==i||null==r?0:i/r;return Math.abs(n)<this._minimumInitialVelocity?null:this.createMomentum(n,this._stopVelocity,this._friction)}createMomentum(e,t,i){const r=this._time.filteredDelta,n=this._angle1.filteredValue,s=this._angle2.filteredValue,a=null==r||null==s?0:s/r;return new vu(e,t,i,null==r||null==n?0:n/r,this._axis1,a,this._axis2)}}class wu{constructor(e=2.5,t=.01,i=.95,r=12){this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=i,this._maxVelocity=r,this.enabled=!0,this.value=new pu(.8),this.time=new pu(.3)}add(e,t){if(this.enabled&&null!=t){if(this.time.hasLastValue()){if(this.time.computeDelta(t)<.01)return;if(this.value.hasFilteredDelta()){const t=this.value.computeDelta(e);this.value.filteredDelta*t<0&&this.value.reset()}}this.time.update(t),this.value.update(e)}}reset(){this.value.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.value.hasFilteredDelta()||!this.time.hasFilteredDelta())return null;let e=this.value.filteredDelta/this.time.filteredDelta;return e=(0,st.uZ)(e,-this._maxVelocity,this._maxVelocity),Math.abs(e)<this._minimumInitialVelocity?null:this.createMomentum(e,this._stopVelocity,this._friction)}createMomentum(e,t,i){return new mu(e,t,i)}}class Cu extends wu{constructor(e=3,t=.01,i=.95,r=12){super(e,t,i,r)}add(e,t){const i=this.value.lastValue;if(null!=i){let t=e-i;for(;t>Math.PI;)t-=2*Math.PI;for(;t<-Math.PI;)t+=2*Math.PI;e=i+t}super.add(e,t)}}class xu extends mu{constructor(e,t,i){super(e,t,i)}value(e){const t=super.value(e);return Math.exp(t)}valueDelta(e,t){const i=super.value(e),r=super.value(e+t)-i;return Math.exp(r)}}class Tu extends wu{constructor(e=2.5,t=.01,i=.95,r=12){super(e,t,i,r)}add(e,t){super.add(Math.log(e),t)}createMomentum(e,t,i){return new xu(e,t,i)}}let Su=class extends ah{constructor(){super(...arguments),this._smoothRotation=new ru(.05),this._rotationAxis=(0,R.Ue)(),this._beginAngle=0,this._beginHeading=0,this._panningPlane=(0,Ro.Ue)(),this._beginRadius=0,this._smoothScaling=new ru(.05),this._zoomCenterScreen=(0,y.s1)(),this._zoomMomentumEstimator=new Tu,this._rotationMomentumEstimator=new Cu,this._panSphericalMomentumEstimator=new bu,this._panPlanarMomentumEstimator=new _u,this._adjustedSphere=(0,es.c)(),this._tmp3d=(0,R.Ue)(),this._tmpScreenPointArray=(0,y.s1)(),this._beginScreenPoint=(0,y.s1)(),this._beginScenePoint=(0,R.Ue)(),this._screenPickPoint=(0,y.s1)(),this._scenePickPoint=(0,R.Ue)(),this._navMode=$o.Horizontal,this._sphere=(0,es.c)(),this._pointerCount=0,this._tmpInteractionDirection=(0,R.Ue)(),this._beginCamera=new po.Z,this._constraintOptions=new ts(Yn.ALL,Kn.NONE,0,this._beginCamera)}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;this._zoomMomentumEstimator.enabled=this._rotationMomentumEstimator.enabled=this._panPlanarMomentumEstimator.enabled=this._panSphericalMomentumEstimator.enabled=this.view.navigation.momentumEnabled,this._beginHeading=-vo.Q4.normalize((0,st.Vl)(this.view.camera.heading)),this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._smoothRotation.reset(),(0,y.md)(e.center,this._screenPickPoint),(0,zi.JG)(this._beginScreenPoint,this._screenPickPoint);const t=Ko(this._intersectionHelper,this.startCamera,this._screenPickPoint,(0,Ii.Iu)(this.view.spatialReference).radius,Io.Silhouette,this.view.basemapTerrain.invisible?Uo:{});null!=t.scenePickPoint&&(this._scenePickPoint=t.scenePickPoint,this._sphere=t.sphere,(0,Pi.c)(this._beginScenePoint,this._scenePickPoint),this._navMode=Qo(this.startCamera,this._screenPickPoint,this.view.renderCoordsHelper,this.view.viewingMode),this._navMode===$o.Vertical&&this._preparePlanarPanMode(e,t.hasGeometryIntersection),this._beginCamera.copyFrom(this.startCamera))}update(e){if(!this.running)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1;this._navMode===$o.Horizontal?(t&&this._zoomSpherical(e),this._panningSpherical(e),t&&this._rotateSpherical(e)):(t&&this._zoomPlanar(e),this._panningPlanar(e),t&&this._rotatePlanar(e)),this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return this._navMode===$o.Horizontal?new du({view:this.view,momentum:t,screenCenter:this._zoomCenterScreen,sceneCenter:this._beginScenePoint,radius:this._sphere[3]}):new uu({view:this.view,momentum:t,zoomCenter:this._beginScenePoint});const i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new hu({view:this.view,momentum:i,center:(0,es.a)(this._sphere),axis:this._rotationAxis});if(this._navMode===$o.Horizontal){const e=this._panSphericalMomentumEstimator.evaluateMomentum();if(e)return new cu({view:this.view,momentum:e})}else{const e=this._panPlanarMomentumEstimator.evaluateMomentum();if(e)return new su({view:this.view,momentum:e})}return null}_preparePlanarPanMode(e,t){const i=(0,Pi.u)(this._tmp3d,this.startCamera.viewForward);(0,Ro.Yq)(this._scenePickPoint,i,this._panningPlane);const r=(0,y.s1)(this._screenPickPoint[0],0),n=(0,R.Ue)(),s=(0,Pi.l)(this.startCamera.eye);this._adjustedSphere[3]=s<this._sphere[3]?s-100:this._sphere[3],tl(this._adjustedSphere,this.startCamera,r,n);const a=(0,y.J$)();this.startCamera.projectToRenderScreen(n,a);const o=(0,R.Ue)(),l=(0,R.Ue)(),c=(0,R.Ue)();(0,Pi.d)(o,this._scenePickPoint,this.currentCamera.eye);const h=(0,Pi.l)(o);(0,Pi.n)(o,o);const u=5*Math.max(Math.abs(this.view.camera.position.z),50),d=this.view.stage.renderView.getMinimalDepthForArea(null,this._screenPickPoint[0],this._screenPickPoint[1],this.view.state.camera,80);let p=null!=d?d:u;p=t?Math.min(p,h):p,(0,Pi.c)(c,(0,Pi.f)(l,this.currentCamera.eye,(0,Pi.g)(l,o,p))),this._panningPlane[3]=-(0,Pi.e)((0,Ro.st)(this._panningPlane),c),this.startCamera.center=(0,Pi.f)(l,this.startCamera.eye,(0,Pi.g)(l,this.startCamera.viewForward,p));const m=(0,y.md)(e.center,this._tmpScreenPointArray);Bo(this._panningPlane,this.startCamera,m,this._beginScenePoint)}_zoomSpherical(e){const t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(t),Go(this._sphere,this.currentCamera,this._smoothScaling.value),(0,y.md)(e.center,this._zoomCenterScreen),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),this._constraintOptions.interactionType=Kn.ZOOM,this._constraintOptions.interactionFactor=xa(e.radius-this._beginRadius),Ca(this.view,this.currentCamera,this._constraintOptions)}_panningSpherical(e){const t=(0,y.md)(e.center,this._tmpScreenPointArray);tl(this._sphere,this.currentCamera,t,this._tmp3d),_l(this._beginScenePoint,(0,Pi.e)(this.currentCamera.up,this._beginScenePoint),this._sphere[3],this._beginHeading,this.view.camera.tilt,this.startCamera.aboveGround)?(yl(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this._beginHeading,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumPreserveHeading(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere,this._beginHeading,this.view.camera.tilt)):(gl(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumDirectRotation(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere[3],this.view.camera.tilt)),this._constraintOptions.interactionType=Kn.PAN,this._constraintOptions.interactionFactor=xa((0,zi.TE)(this._screenPickPoint,t)),Ca(this.view,this.currentCamera,this._constraintOptions)}_rotateSpherical(e){(0,Pi.n)(this._rotationAxis,this._scenePickPoint),this.currentCamera.aboveGround||(0,Pi.u)(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value,i=t+ko(e.angle-t),r=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=r,this._smoothRotation.update(i);const n=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(n,.001*e.timestamp),Vo(this.currentCamera,(0,es.a)(this._sphere),So(this._rotationAxis,n)),this._constraintOptions.interactionType=Kn.TUMBLE,this._constraintOptions.interactionFactor=xa(e.radius*i),Ca(this.view,this.currentCamera,this._constraintOptions)}_panningPlanar(e){const t=(0,y.md)(e.center,this._tmpScreenPointArray);Bo(this._panningPlane,this.currentCamera,t,this._tmp3d)&&(Jo(this.currentCamera,this._beginScenePoint,this._tmp3d),this._panPlanarMomentumEstimator.add(t,this._tmp3d,.001*e.timestamp),this._constraintOptions.interactionType=Kn.PAN,this._constraintOptions.interactionFactor=xa((0,zi.TE)(this._beginScreenPoint,t)),this._constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this._tmpInteractionDirection),Ca(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null)}_zoomPlanar(e){const t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(t),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),zo(this.currentCamera,this._beginScenePoint,this._smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this._constraintOptions.interactionType=Kn.ZOOM,this._constraintOptions.interactionFactor=xa(e.radius-this._beginRadius),Ca(this.view,this.currentCamera,this._constraintOptions)}_rotatePlanar(e){(0,Pi.c)(this._rotationAxis,this._beginScenePoint),this.currentCamera.aboveGround||(0,Pi.u)(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value;let i=e.angle-t;i=ko(i);const r=t+i,n=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=n,this._smoothRotation.update(r);const s=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(s,.001*e.timestamp),Vo(this.currentCamera,(0,es.a)(this._sphere),So(this._rotationAxis,s)),this._constraintOptions.interactionType=Kn.TUMBLE,this._constraintOptions.interactionFactor=xa(e.radius*s),Ca(this.view,this.currentCamera,this._constraintOptions)}};Su=(0,r._)([(0,x.j)("esri.views.3d.state.controllers.PinchAndPanControllerGlobal")],Su);const Mu=(0,R.al)(0,0,1);let Eu=class extends ah{constructor(){super(...arguments),this._rotationValueSmooth=new ru(.05),this._scalingValueSmooth=new ru(.05),this._planeHorizontal=(0,Ro.Ue)(),this._planeVertical=(0,Ro.Ue)(),this._rotationMomentumEstimator=new Cu,this._panMomentumEstimator=new _u(300,12,.9),this._zoomMomentumEstimator=new Tu,this._beginRadius=0,this._beginCenter=(0,R.Ue)(),this._beginAngle=0,this._tmpPoints=[],this._navMode=$o.Horizontal,this._beginCenterScreen=(0,y.s1)(),this._tmpCentroid3d=(0,R.Ue)(),this._tmpCentroid2d=(0,y.s1)(),this._tmp2d=(0,y.s1)(),this._pointerCount=0,this._beginCamera=new po.Z,this._constraintOptions=new ts(Yn.ALL,Kn.NONE,0,this._beginCamera)}begin(e){if(!this.running)return;const t=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=t,this._rotationMomentumEstimator.enabled=t,this._panMomentumEstimator.enabled=t,this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._rotationValueSmooth.reset(),this._scalingValueSmooth.reset(),(0,y.md)(e.center,this._beginCenterScreen),(0,Ro.Oy)(Mu,0,this._planeHorizontal);const i=(0,R.Ue)(),r=this._intersectionHelper.intersectScreenFreePointFallback(this._beginCenterScreen,i,this.view.basemapTerrain.invisible?Uo:{}),n=(0,R.Ue)();(0,Pi.u)(n,this.startCamera.viewForward);const s=(0,R.Ue)();(0,Pi.c)(s,Mu);const a=(0,Pi.e)(n,s);this._navMode=Qo(this.startCamera,this._beginCenterScreen,this.view.renderCoordsHelper,this.view.viewingMode);const o=Math.min(5,1/Math.abs((0,Pi.e)(s,this.startCamera.viewForward)))*Math.max(Math.abs(this.view.camera.position.z),50);(0,Ro.T5)(this._planeHorizontal,this._planeHorizontal,i),this.startCamera.aboveGround||(0,Ro.tk)(this._planeHorizontal,this._planeHorizontal);const l=(0,R.Ue)(),c=(0,R.Ue)(),h=(0,R.Ue)();(0,Pi.d)(l,i,this.currentCamera.eye);const u=(0,Pi.l)(l);if((0,Pi.n)(l,l),this._navMode===$o.Vertical){(0,Pi.g)(s,s,a),(0,Pi.d)((0,Ro.st)(this._planeVertical),n,s),(0,Pi.n)((0,Ro.st)(this._planeVertical),(0,Ro.st)(this._planeVertical)),(0,Ro.T5)(this._planeVertical,this._planeVertical,i);const t=this.view.stage.renderView.getMinimalDepthForArea((0,ql.$L)(this.view),this._beginCenterScreen[0],this._beginCenterScreen[1],this.view.state.camera,80);let d=null!=t?t:o;d=r?Math.min(d,u):d,(0,Pi.c)(h,(0,Pi.f)(c,this.currentCamera.eye,(0,Pi.g)(c,l,d))),this._planeVertical[3]=-(0,Pi.e)((0,Ro.st)(this._planeVertical),h),this._computePlanePoints(e.pointers,this._planeVertical,this.startCamera,this._tmpPoints),Zo(this._tmpPoints,this._beginCenter)}else{const t=r?u:o;(0,Pi.c)(h,(0,Pi.f)(c,this.currentCamera.eye,(0,Pi.g)(c,l,t))),this._planeHorizontal[3]=-(0,Pi.e)((0,Ro.st)(this._planeHorizontal),h),this._computePlanePoints(e.pointers,this._planeHorizontal,this.startCamera,this._tmpPoints),Zo(this._tmpPoints,this._beginCenter)}this._beginCamera.copyFrom(this.startCamera)}update(e){if(!this.running)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1,i=this._navMode===$o.Horizontal?this._planeHorizontal:this._planeVertical,r=this._beginCenter;if(t){const t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._scalingValueSmooth.gain=i,this._scalingValueSmooth.update(t),zo(this.currentCamera,r,this._scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this._zoomMomentumEstimator.add(this._scalingValueSmooth.value,.001*e.timestamp),this._constraintOptions.interactionType=Kn.ZOOM,this._constraintOptions.interactionFactor=xa(Math.abs(e.radius-this._beginRadius)),Ca(this.view,this.currentCamera,this._constraintOptions)}if(this._computePlanePoints(e.pointers,i,this.currentCamera,this._tmpPoints),Zo(this._tmpPoints,this._tmpCentroid3d),(0,y.md)(e.center,this._tmpCentroid2d),Jo(this.currentCamera,r,this._tmpCentroid3d),this._panMomentumEstimator.add(this._tmpCentroid2d,this._tmpCentroid3d,.001*e.timestamp),this._constraintOptions.interactionType=Kn.PAN,this._constraintOptions.interactionFactor=xa((0,zi.TE)(this._beginCenterScreen,this._tmpCentroid2d)),Ca(this.view,this.currentCamera,this._constraintOptions),t){const t=r,i=this._rotationValueSmooth.value,n=i+ko(e.angle-i),s=.00125*Math.min(Math.max(e.radius,40),120);this._rotationValueSmooth.gain=s,this._rotationValueSmooth.update(n);const a=this._rotationValueSmooth.value-this._beginAngle;this._rotationMomentumEstimator.add(a,.001*e.timestamp);const o=(0,Ro.st)(this._planeHorizontal);Vo(this.currentCamera,t,So(o,a)),this._constraintOptions.interactionType=Kn.TUMBLE,this._constraintOptions.interactionFactor=xa(Math.abs(e.radius*a)),Ca(this.view,this.currentCamera,this._constraintOptions)}this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return new uu({view:this.view,momentum:t,zoomCenter:this._beginCenter});const i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new hu({view:this.view,momentum:i,center:this._beginCenter,axis:(0,Ro.st)(this._planeHorizontal)});const r=this._panMomentumEstimator.evaluateMomentum();return r?new su({view:this.view,momentum:r}):null}_computePlanePoints(e,t,i,r){r.length=e.size;const n=this._tmp2d;let s=0;return e.forEach((e=>{n[0]=e.x,n[1]=e.y,void 0===r[s]&&(r[s]=(0,R.Ue)()),Bo(t,i,n,r[s]),s+=1})),r}get _intersectionHelper(){return this.view.sceneIntersectionHelper}};Eu=(0,r._)([(0,x.j)("esri.views.3d.state.controllers.PinchAndPanControllerLocal")],Eu);class Pu extends Xl.a{constructor(e,t,i){super(!0),this._view=e,this.pointerActions=t,this._lastEndTimestamp=0,this._lastTimestamp=0,this.registerIncoming("drag",i,(e=>this._handleDrag(e)))}_handleDrag(e){if("mouse"===e.data.pointerType&&!Kl(e.data,this.pointerActions))return;const t=e.timestamp-this._lastEndTimestamp,i=this._momentum&&this._momentum.running&&t<40;switch(e.data.action){case"start":case"update":if(i)break;this._controller&&this._controller.running?e.data.timestamp-this._lastTimestamp>2&&(this._controller.update(e.data),this._lastTimestamp=e.timestamp):this._startController(e);break;case"end":case"removed":this._endController(e,!0);break;case"added":this._endController(e,!1),this._startController(e)}e.stopPropagation()}_endController(e,t){if(this._controller?.running){this._lastEndTimestamp=e.timestamp;const i=this._controller.end(e.data);t&&i&&(this._momentum=i,this._view.state.switchCameraController(this._momentum))}this._controller=null}_startController(e){this._controller=this._createController(),this._view.state.switchCameraController(this._controller),this._controller.begin(e.data),this._lastTimestamp=e.timestamp}_createController(){return this._view.state.isGlobal?new Su({view:this._view}):new Eu({view:this._view})}}class Ru extends Xl.a{constructor(e,t){super(!0),this.view=e,this.registerIncoming("pointer-down",t,(()=>this.view.state.stopActiveCameraController()))}}class Au extends Xl.a{constructor(e,t=!1){super(!0),this._view=e,this._invert=t,this.registerIncoming("vertical-two-finger-drag",(e=>this._handleTwoFinger(e)))}_handleTwoFinger(e){const t=this._invert?-1:1,i=(0,y.s1)(0,e.data.delta*t);switch(e.data.action){case"begin":this._cameraController?.end(),this._cameraController=new lh({view:this._view,pivot:oh.CENTER}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":this._cameraController?.update(i);break;case"end":this._cameraController?.end(),this._cameraController=null}}}function Ou(e){const t=e.native;return t?{buttons:t.buttons.map((e=>e.pressed?e.value||1:0)),axes:t.axes.map((t=>function(e,t){const i=Math.abs(e);return i<t?0:Math.sign(e)*(i-t)/(1-t)}(t,e.axisThreshold)))}:{buttons:[],axes:[]}}class Du{constructor(e,t){this._element=e,this._input=t,this._hasEventListeners=!1,this._onConnectGamepad=e=>{this._connectGamepad(e.gamepad)},this._onDisconnectGamepad=e=>{const t=e.gamepad,i=t.index,r=this._inputDevices[i];r&&(this._emitGamepadEvent(t,Ou(r),!1),this._inputDevices.splice(i,1),this._latestUpdate.splice(i,1),this._input.gamepad.devices.remove(r),this.ensurePollingState())},this._frameTask=null,this._latestUpdate=new Array,this._inputDevices=new Array,this._callback=null;const i="getGamepads"in window.navigator,r=window.isSecureContext;this.supported=i&&r,this.supported&&(Lu((e=>this._connectGamepad(e))),window.addEventListener("gamepadconnected",this._onConnectGamepad),window.addEventListener("gamepaddisconnected",this._onDisconnectGamepad),this.ensurePollingState())}destroy(){this.hasEventListeners=!1,this.supported&&(window.removeEventListener("gamepadconnected",this._onConnectGamepad),window.removeEventListener("gamepaddisconnected",this._onDisconnectGamepad))}set hasEventListeners(e){this._hasEventListeners!==e&&(this._hasEventListeners=e,this.ensurePollingState())}get _eventsEnabled(){return this.supported&&this._inputDevices.length>0&&this._hasEventListeners}set onEvent(e){this._callback=e}_connectGamepad(e){const t=new wt(e);"unknown"!==t.deviceType&&(this._inputDevices[e.index]=t,this._input.gamepad.devices.add(t)),this.ensurePollingState()}ensurePollingState(){this._eventsEnabled?this._startPolling():this._stopPolling()}_startPolling(){null==this._frameTask&&(this._frameTask=(0,g.A)({update:()=>this._readGamepadState()}))}_stopPolling(){null!=this._frameTask&&(this._frameTask.remove(),this._frameTask=null,this._latestUpdate=new Array)}_readGamepadState(){const e=document.hasFocus(),t=this._element.contains(document.activeElement),i="document"===this._input.gamepad.enabledFocusMode&&!e||"view"===this._input.gamepad.enabledFocusMode&&!t;Lu((e=>{const t=this._inputDevices[e.index];if(!t)return;const r=this._latestUpdate[e.index],n=Ou(t),s=i||function(e){for(let t=0;t<e.axes.length;t++)if(0!==e.axes[t])return!1;for(let t=0;t<e.buttons.length;t++)if(0!==e.buttons[t])return!1;return!0}(n);if(r){if(r.timestamp===e.timestamp)return;if(!r.active&&s)return;if(function(e,t){if(e.axes.length!==t.axes.length)return!1;if(e.buttons.length!==t.buttons.length)return!1;for(let i=0;i<e.axes.length;i++)if(e.axes[i]!==t.axes[i])return!1;for(let i=0;i<e.buttons.length;i++)if(e.buttons[i]!==t.buttons[i])return!1;return!0}(r.state,n))return}this._emitGamepadEvent(e,n,!s)}))}_emitGamepadEvent(e,t,i){const r=this._latestUpdate[e.index],n=r&&r.active;if(!n&&!i)return;const s=!n&&i?"start":n&&i?"update":"end";this._latestUpdate[e.index]={timestamp:e.timestamp,state:t,active:i},this._callback&&this._callback({device:this._inputDevices[e.index],state:t,action:s})}}function Iu(e){if(!e)return!1;if(!e.connected)return!1;for(let t=0;t<e.axes.length;t++)if(isNaN(e.axes[t]))return!1;return!0}function Lu(e){for(const t of navigator.getGamepads())Iu(t)&&e(t)}const Nu=(0,u.Z)("edge"),Fu=(0,u.Z)("chrome"),Uu=(0,u.Z)("ff"),Hu=(0,u.Z)("safari"),ku="esri-view-surface",Vu={touchNone:`${ku}--touch-none`,touchPan:`${ku}--touch-pan`};class Bu{static{this.test={disableSubpixelCoordinates:!1}}constructor(e,t){this._active={},this._callback=()=>{},this._activePointerCaptures=new Set,this._keyDownState=new Set,this._eventId=1,this._browserTouchPanningEnabled=!1,this._element=e,e.getAttribute("tabindex")||e.setAttribute("tabindex","0"),this._eventHandlers={"key-down":this._handleKey,"key-up":this._handleKey,"pointer-down":this._handlePointer,"pointer-move":this._handlePointerPreventDefault,"pointer-up":this._handlePointerPreventDefault,"pointer-enter":this._handlePointer,"pointer-leave":this._handlePointer,"pointer-cancel":this._handlePointer,"mouse-wheel":this._handleMouseWheel,"pointer-capture-lost":this._handlePointerCaptureLost},this._updateTouchAction(),this._element.addEventListener("keydown",this._preventAltKeyDefault),this._gamepadSource=new Du(e,t),this._gamepadSource.onEvent=e=>this._callback("gamepad",e)}destroy(){this._callback=()=>{},this.activeEvents=null,this._activePointerCaptures.forEach((e=>this._releasePointerCaptureSafe(e))),this._activePointerCaptures.clear(),this._gamepadSource=(0,p.SC)(this._gamepadSource),this._removeTouchAction(),this._element.removeEventListener("keydown",this._preventAltKeyDefault)}get browserTouchPanningEnabled(){return this._browserTouchPanningEnabled}set browserTouchPanningEnabled(e){this._browserTouchPanningEnabled=e,this._updateTouchAction(),this._updateTouchEventHandling()}set onEventReceived(e){this._callback=e}set activeEvents(e){for(const t in this._active)if(!e||!e.has(t)){const e=this._active[t];this._element.removeEventListener(zu[t],e),delete this._active[t]}e&&e.forEach((e=>{if(!this._active[e]&&zu[e]){const t=(this._eventHandlers[e]||this._handleDefault).bind(this,e);this._element.addEventListener(zu[e],t),this._active[e]=t}})),this._gamepadSource&&(this._gamepadSource.hasEventListeners=e?.has("gamepad")??!1)}setPointerCapture(e,t){t?this._setPointerCaptureSafe(e.pointerId):(this._releasePointerCaptureSafe(e.pointerId),this._activePointerCaptures.delete(e.pointerId))}_updateTouchAction(){this._element.classList.remove(this._browserTouchPanningEnabled?Vu.touchNone:Vu.touchPan),this._element.classList.add(this._browserTouchPanningEnabled?Vu.touchPan:Vu.touchNone)}_updateTouchEventHandling(){this._browserTouchPanningEnabled?this._element.addEventListener("touchmove",this._preventMultiTouchPanning):this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_removeTouchAction(){this._element.classList.remove(Vu.touchNone),this._element.classList.remove(Vu.touchPan),this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_setPointerCaptureSafe(e){try{this._element.setPointerCapture(e),this._activePointerCaptures.add(e)}catch{}}_releasePointerCaptureSafe(e){try{if(this._element.hasPointerCapture&&!this._element.hasPointerCapture(e))return;this._element.releasePointerCapture(e)}catch(e){}}_updateNormalizedPointerLikeEvent(e,t){const i=(0,at.Eu)(this._element,e);return Bu.test.disableSubpixelCoordinates&&(i.x=Math.round(i.x),i.y=Math.round(i.y)),t.x=i.x,t.y=i.y,t}_handleKey(e,t){const{key:i}=t;i&&"key-up"===e&&this._keyDownState.delete(i);const r={native:t,key:i,repeat:!!i&&this._keyDownState.has(i)};i&&"key-down"===e&&this._keyDownState.add(r.key),this._callback(e,r)}_handlePointer(e,t){const i=this._updateNormalizedPointerLikeEvent(t,{native:t,x:0,y:0,pointerType:t.pointerType,button:t.button,buttons:t.buttons,eventId:this._eventId++});this._callback(e,i)}_handlePointerPreventDefault(e,t){const i=this._updateNormalizedPointerLikeEvent(t,{native:t,x:0,y:0,pointerType:t.pointerType,button:t.button,buttons:t.buttons,eventId:this._eventId++});t.preventDefault(),this._callback(e,i)}_getDeltaFromTrackpadOrMouseWheel(e){return e.shiftKey&&(0,u.Z)("mac")&&0===e.deltaY?e.deltaX:e.deltaY}_handleMouseWheel(e,t){let i=this._getDeltaFromTrackpadOrMouseWheel(t);switch(t.deltaMode){case 0:Nu&&(i=i/document.documentElement.clientHeight*600);break;case 1:i*=30;break;case 2:i*=900}Nu?i*=.7:Fu||Hu?i*=.6:Uu&&(i*=1.375);const r=Math.abs(i);r>100&&(i=i/r*200/(1+Math.exp(-.02*(r-100))));const n=this._updateNormalizedPointerLikeEvent(t,{native:t,x:0,y:0,deltaY:i});this._callback(e,n)}_handlePointerCaptureLost(e,t){this._activePointerCaptures.delete(t.pointerId),this._handleDefault(e,t)}_handleDefault(e,t){const i={native:t};t.preventDefault(),this._callback(e,i)}_preventAltKeyDefault(e){"Alt"===e.key&&e.preventDefault()}_preventMultiTouchPanning(e){e.touches.length>1&&e.preventDefault()}}const zu={"key-down":"keydown","key-up":"keyup","pointer-down":"pointerdown","pointer-up":"pointerup","pointer-move":"pointermove","mouse-wheel":"wheel","pointer-capture-got":"gotpointercapture","pointer-capture-lost":"lostpointercapture","context-menu":"contextmenu","pointer-enter":"pointerenter","pointer-leave":"pointerleave","pointer-cancel":"pointercancel",focus:"focus",blur:"blur"};class Gu extends Xl.a{constructor(){super(!0),this.registerIncoming("context-menu",(e=>e.data.native.preventDefault()))}}const qu=(e={})=>({maximumClickDelay:300,maximumDoubleClickDistance:10,maximumDoubleTouchDistance:35,maximumDoubleClickDelay:250,maximumDoubleTouchDelay:350,...e});function Zu(e,t){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}function ju(e){const{native:t}=e,{pointerId:i,button:r,pointerType:n}=t;return"mouse"===n?`${i}:${r}`:`${n}`}class Wu extends Xl.a{constructor(e){super(!1),this._navigationTouch=e,this._startStateModifiers=new Set,this._activePointerMap=new Map,this._isDragging=!1,this._isCurrentDragSuppressed=!1,this._drag=this.registerOutgoing("drag"),this.registerIncoming("pointer-drag",this._handlePointerDrag.bind(this)),this.registerIncoming("pointer-up",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-capture-lost",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-cancel",this._handlePointerUpAndPointerLost.bind(this))}_createPayload(e,t,i,r){return{action:e,pointerType:this._pointerType,button:this._mouseButton,buttons:t.buttons,timestamp:r,pointers:Yu(this._activePointerMap),pointer:t,angle:i.angle,radius:i.radius,center:i.center}}_addPointer(e){const t=e.native.pointerId,i=Xu(this._activePointerMap).angle,r={event:e,initialAngle:0,lastAngle:0};this._activePointerMap.set(t,r);const n=Ku(r,$u(this._activePointerMap));r.initialAngle=n,r.lastAngle=n,this._updatePointerAngles(i)}_updatePointer(e){if(e&&null==e.x&&null==e.y)return;const t=e.native.pointerId,i=this._activePointerMap.get(t);i?i.event=e:this._addPointer(e)}_removePointer(e){const t=Xu(this._activePointerMap).angle;this._activePointerMap.delete(e),this._updatePointerAngles(t)}_updatePointerAngles(e){const t=Xu(this._activePointerMap);this._activePointerMap.forEach((i=>{i.initialAngle=Ku(i,t)-e,i.lastAngle=Ku(i,t)-e}))}_emitEvent(e,t,i){const r=Xu(this._activePointerMap);this._drag.emit(this._createPayload(e,t,r,i),void 0,this._startStateModifiers)}_handlePointerUpAndPointerLost(e){const t=e.data.native.pointerId,i=(0,ur.HA)(e.timestamp);this._activePointerMap.get(t)&&(1===this._activePointerMap.size?(this._updatePointer(e.data),!this._isCurrentDragSuppressed&&this._emitEvent("end",e.data,i),this._isDragging=!1,this._isCurrentDragSuppressed=!1,this._removePointer(t)):(this._removePointer(t),this._emitEvent("removed",e.data,(0,ur.HA)(e.timestamp))))}_handlePointerDrag(e){const t=e.data,i=t.currentEvent,r=(0,ur.HA)(e.timestamp);switch(t.action){case"start":case"update":this._isDragging?this._activePointerMap.has(i.native.pointerId)?(this._updatePointer(i),!this._isCurrentDragSuppressed&&this._emitEvent("update",i,r)):(this._addPointer(i),this._emitEvent("added",i,r),this._isCurrentDragSuppressed=this._isSuppressed):(this._updatePointer(i),this._pointerType=e.data.startEvent.pointerType,this._mouseButton=e.data.startEvent.button,this._startStateModifiers=e.modifiers,this._isDragging=!0,this._isCurrentDragSuppressed=this._isSuppressed,!this._isCurrentDragSuppressed&&this._emitEvent("start",i,r))}}get _isSuppressed(){return!!this._navigationTouch&&!this._navigationTouch.browserTouchPanEnabled&&"touch"===this._pointerType&&1===this._activePointerMap.size}}function $u(e){const t=[];return e.forEach((e=>{t.push((0,y.vW)(e.event.x,e.event.y))})),function(e,t){if(t?(t.radius=0,t.center.x=0,t.center.y=0):t={radius:0,center:(0,y.vW)()},0===e.length)return t;if(1===e.length)return t.center.x=e[0].x,t.center.y=e[0].y,t;if(2===e.length){const[i,r]=e,[n,s]=[r.x-i.x,r.y-i.y];return t.radius=Math.sqrt(n*n+s*s)/2,t.center.x=(i.x+r.x)/2,t.center.y=(i.y+r.y)/2,t}let i=0,r=0;for(let t=0;t<e.length;t++)i+=e[t].x,r+=e[t].y;i/=e.length,r/=e.length;const n=e.map((e=>e.x-i)),s=e.map((e=>e.y-r));let a=0,o=0,l=0,c=0,h=0,u=0,d=0;for(let e=0;e<n.length;e++){const t=n[e],i=s[e],r=t*t,p=i*i;a+=r,o+=p,l+=t*i,c+=r*t,h+=p*i,u+=t*p,d+=i*r}const p=.5*(c+u),m=.5*(h+d),f=a*o-l*l,_=(p*o-m*l)/f,g=(a*m-l*p)/f,v=(0,y.vW)(_+i,g+r);return{radius:Math.sqrt(_*_+g*g+(a+o)/e.length),center:v}}(t)}function Xu(e){const t=$u(e);let i=0;return e.forEach((e=>{let r=Ku(e,t),n=r-e.lastAngle;for(;n>Math.PI;)n-=2*Math.PI;for(;n<-Math.PI;)n+=2*Math.PI;r=e.lastAngle+n,e.lastAngle=r;const s=r-e.initialAngle;i+=s})),i/=e.size||1,{angle:i,radius:t.radius,center:t.center}}function Yu(e){const t=new Map;return e.forEach(((e,i)=>t.set(i,e.event))),t}function Ku(e,t){const i=e.event,r=i.x-t.center.x,n=i.y-t.center.y;return Math.atan2(n,r)}var Qu;!function(e){e[e.Left=0]="Left",e[e.Middle=1]="Middle",e[e.Right=2]="Right",e[e.Back=3]="Back",e[e.Forward=4]="Forward",e[e.Undefined=-1]="Undefined"}(Qu||(Qu={}));class Ju extends Xl.a{constructor(e={},t=Qe.m){super(!1),this._clock=t,this._pointerState=new Map,this._parameters=qu(e),this._immediateDoubleClick=this.registerOutgoing("immediate-double-click"),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this)),this.registerIncoming("pointer-up",this._handlePointerUp.bind(this))}onUninstall(){this._pointerState.forEach((e=>{e.immediateDoubleClick&&e.immediateDoubleClick.timeoutHandle.remove()})),super.onUninstall()}_handlePointerDown(e){const t=e.data,i=ju(t);if(!this._pointerState.has(i)){const e={downButton:t.native.button,x:t.x,y:t.y,immediateDoubleClick:null};this._pointerState.set(i,e),this.startCapturingPointer(t.native)}}_handlePointerUp(e){const t=e.data,i=ju(t),r=this._pointerState.get(i);if(r&&r.downButton===t.native.button){const i=r.immediateDoubleClick,n="touch"===e.data.native.pointerType?this._parameters.maximumDoubleTouchDistance:this._parameters.maximumDoubleClickDistance;i?(i.timeoutHandle.remove(),Zu(i,e.data)>n?this._startImmediateDoubleClick(e,r):(this._immediateDoubleClick.emit(e.data,void 0,i.modifiers),this._removeState(t))):Zu(r,e.data)>n?this._removeState(t):this._startImmediateDoubleClick(e,r)}}_startImmediateDoubleClick(e,t){const i="touch"===e.data.native.pointerType?this._parameters.maximumDoubleTouchDelay:this._parameters.maximumDoubleClickDelay;t.immediateDoubleClick={x:e.data.x,y:e.data.y,modifiers:e.modifiers,timeoutHandle:this._clock.setTimeout((()=>this._removeState(e.data)),i)}}_removeState(e){const t=ju(e);this._pointerState.delete(t),this.stopCapturingPointer(e.native),this.refreshHasPendingInputs()}}class ed extends Xl.a{constructor(e={},t=Qe.m){super(!1),this._clock=t,this._pointerState=new Map,this._parameters=((e={})=>({maximumClickDelay:300,movementUntilMouseDrag:1.5,movementUntilPenDrag:6,movementUntilTouchDrag:6,holdDelay:500,...e}))(e),this._pointerDrag=this.registerOutgoing("pointer-drag"),this._immediateClick=this.registerOutgoing("immediate-click"),this._pointerHold=this.registerOutgoing("hold"),this.registerIncoming("pointer-down",(e=>this._handlePointerDown(e))),this.registerIncoming("pointer-up",(e=>this._handlePointerLoss(e,"pointer-up"))),this.registerIncoming("pointer-capture-lost",(e=>this._handlePointerLoss(e,"pointer-capture-lost"))),this.registerIncoming("pointer-cancel",(e=>this._handlePointerLoss(e,"pointer-cancel"))),this._moveHandle=this.registerIncoming("pointer-move",(e=>this._handlePointerMove(e))),this._moveHandle.pause()}onUninstall(){this._pointerState.forEach((e=>{e.holdTimeout=(0,p.hw)(e.holdTimeout)})),super.onUninstall()}_handlePointerDown(e){const t=e.data,i=t.native.pointerId;let r=null;0===this._pointerState.size&&(r=this._clock.setTimeout((()=>{const t=this._pointerState.get(i);if(t){if(!t.isDragging){const i=t.previousEvent;this._pointerHold.emit(i,void 0,e.modifiers),t.holdEmitted=!0}t.holdTimeout=null}}),this._parameters.holdDelay));const n={startEvent:t,previousEvent:t,startTimestamp:e.timestamp,isDragging:!1,downButton:t.native.button,holdTimeout:r,modifiers:new Set};this._pointerState.set(i,n),this.startCapturingPointer(t.native),this._moveHandle.resume(),this._pointerState.size>1&&this._startDragging(e)}_handlePointerMove(e){const t=e.data,i=t.native.pointerId,r=this._pointerState.get(i);r&&(r.isDragging?this._pointerDrag.emit(td("update",r,t),void 0,r.modifiers):function(e,t){const i=t.x-e.x,r=t.y-e.y;return Math.sqrt(i*i+r*r)}(t,r.startEvent)>this._getDragThreshold(t.native.pointerType)&&this._startDragging(e),r.previousEvent=t)}_getDragThreshold(e){switch(e){case"touch":return this._parameters.movementUntilTouchDrag;case"pen":return this._parameters.movementUntilPenDrag;default:return this._parameters.movementUntilMouseDrag}}_startDragging(e){const t=e.data,i=t.native.pointerId;this._pointerState.forEach((r=>{null!=r.holdTimeout&&(r.holdTimeout.remove(),r.holdTimeout=null),r.isDragging||(r.modifiers=e.modifiers,r.isDragging=!0,i===r.startEvent.native.pointerId?this._pointerDrag.emit(td("start",r,t)):this._pointerDrag.emit(td("start",r,r.previousEvent),e.timestamp))}))}_handlePointerLoss(e,t){const i=e.data,r=i.native.pointerId,n=this._pointerState.get(r);n&&(null!=n.holdTimeout&&(n.holdTimeout.remove(),n.holdTimeout=null),n.isDragging?this._pointerDrag.emit(td("end",n,"pointer-up"===t?i:n.previousEvent),void 0,n.modifiers):"pointer-up"===t&&n.downButton===i.native.button&&e.timestamp-n.startTimestamp<=this._parameters.maximumClickDelay&&!n.holdEmitted&&this._immediateClick.emit(i),this._pointerState.delete(r),this.stopCapturingPointer(i.native),0===this._pointerState.size&&this._moveHandle.pause())}}function td(e,t,i){return{action:e,startEvent:t.startEvent,previousEvent:t.previousEvent,currentEvent:i}}class id extends Xl.a{constructor(e={},t=Qe.m){super(!1),this._clock=t,this._pointerState=new Map,this._parameters=qu(e),this._click=this.registerOutgoing("click"),this._doubleClick=this.registerOutgoing("double-click"),this.registerIncoming("immediate-click",(e=>this._handleImmediateClick(e))),this.registerIncoming("pointer-down",(e=>this._handlePointerDown(e)))}onUninstall(){this._pointerState.forEach((e=>e.doubleClickTimer=(0,p.hw)(e.doubleClickTimer)))}get hasPendingInputs(){for(const e of this._pointerState.values())if(null!=e.doubleClickTimer)return!0;return!1}_clearDoubleClickTimer(e,t){const i=this._pointerState.get(e);i&&(i.doubleClickTimer=(0,p.hw)(i.doubleClickTimer),t&&this._click.emit(i.event.data,void 0,i.event.modifiers),this._pointerState.delete(e),this.refreshHasPendingInputs())}_doubleClickTimeoutExceeded(e){const t=this._pointerState.get(e);1===t.pointerDownCount&&this._click.emit(t.event.data,void 0,t.event.modifiers),t.doubleClickTimer=null,this._pointerState.delete(e),this.refreshHasPendingInputs()}_handleImmediateClick(e){const t=e.data,{pointerType:i}=t.native,r=function(e){const{pointerId:t,pointerType:i,button:r}=e.native;return"mouse"===i?`${t}:${r}`:`${i}`}(t);if(!this._pointerState.has(r))return void this._startClick(e);const n=this._pointerState.get(r),{data:s,modifiers:a}=n.event,o="touch"===i?this._parameters.maximumDoubleTouchDistance:this._parameters.maximumDoubleClickDistance;Zu(s,t)>o?(this._clearDoubleClickTimer(r,!0),this._startClick(e)):(this._clearDoubleClickTimer(r,!1),2===n.pointerDownCount&&this._doubleClick.emit(s,void 0,a))}_handlePointerDown(e){const t=ju(e.data),i=this._pointerState.get(t);i&&(i.pointerDownCount+=1)}_startClick(e){const{data:t}=e,{native:{pointerType:i}}=t,r=ju(t),n="touch"===i?this._parameters.maximumDoubleTouchDelay:this._parameters.maximumDoubleClickDelay,s=this._clock.setTimeout((()=>this._doubleClickTimeoutExceeded(r)),n);this._pointerState.set(r,{event:e,doubleClickTimer:s,pointerDownCount:1}),this.refreshHasPendingInputs()}}class rd{constructor(e){this._callbacks=e,this._currentCount=0,this._callbacks.condition||(this._callbacks.condition=()=>!0)}handle(e){const t=e.data,i=t.pointers.size;switch(t.action){case"start":this._currentCount=i,this._emitStart(e);break;case"added":this._emitEnd(this._previousEvent),this._currentCount=i,this._emitStart(e);break;case"update":this._emitUpdate(e);break;case"removed":this._startEvent&&this._emitEnd(this._previousEvent),this._currentCount=i,this._emitStart(e);break;case"end":this._emitEnd(e),this._currentCount=0}this._previousEvent=e}_emitStart(e){this._startEvent=e,this._callbacks.condition?.(this._currentCount,e)&&this._callbacks.start(this._currentCount,e,this._startEvent)}_emitUpdate(e){this._callbacks.condition?.(this._currentCount,e)&&this._callbacks.update(this._currentCount,e,this._startEvent)}_emitEnd(e){this._callbacks.condition?.(this._currentCount,e)&&this._callbacks.end(this._currentCount,e,this._startEvent),this._startEvent=null}}class nd extends Xl.a{constructor(e=20,t=40){super(!1),this._threshold=e,this._maxDelta=t,this._state="ready",this._emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this._dragEventSeparator=new rd({start:(e,t)=>this._observeStart(e,t),update:(e,t,i)=>this._observeUpdate(e,t,i),end:(e,t)=>this._observeEnd(t)}),this.registerIncoming("drag",(e=>this._dragEventSeparator.handle(e)))}get failed(){return"failed"===this._state}_observeStart(e,t){1===e&&this._emittedArtificalEnd2&&(this._emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),t.stopPropagation()),this._state=2===e?"ready":"failed"}_observeUpdate(e,t,i){if("failed"!==this._state&&2===e)return"active"===this._state?(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void t.stopPropagation()):void(this._checkMovementWithinLimits(t.data,i.data)?this._checkVerticalThresholdReached(t.data,i.data)&&(this._state="active",this._emittedArtificalEnd2=!0,this._thresholdReachedCenter=t.data.center,this._artificalDrag.emit({action:"end",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),t.stopPropagation()):this._state="failed")}_observeEnd(e){"active"===this._state&&(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this._state="ready",e.stopPropagation())}_checkMovementWithinLimits(e,t){let i=-1/0,r=1/0,n=-1/0,s=1/0;for(const{x:e,y:a}of t.pointers.values())i=Math.max(i,e),r=Math.min(r,e),n=Math.max(n,a),s=Math.min(s,a);let a=-1/0,o=1/0,l=-1/0,c=1/0;for(const{x:t,y:i}of e.pointers.values())a=Math.max(a,t),o=Math.min(o,t),l=Math.max(l,i),c=Math.min(c,i);const h=i-r,u=n-s,d=a-o,p=l-c;return Math.abs(e.center.x-t.center.x)<this._threshold&&Math.abs(d-h)<=this._maxDelta&&Math.abs(p-u)<=this._maxDelta}_checkVerticalThresholdReached(e,t){let i=Math.abs(e.center.y-t.center.y);return e.pointers.forEach(((e,r)=>{const n=t.pointers.get(r);i=Math.min(i,Math.abs(e.y-n.y))})),i>=this._threshold}}let sd=class extends S.Z{constructor(){super(...arguments),this.mode="default",this._updateMode=({mode:e,dragPrimary:t,dragSecondary:i,dragTertiary:r})=>{"pro"===e&&(i="zoom",r="pan"===t?"rotate":"pan");const n={dragPrimary:t,dragSecondary:i,dragTertiary:r};this._modeDragPan&&(this._modeDragPan.pointerActions=Ql("pan",n)),this._modeDragRotate&&(this._modeDragRotate.pointerActions=Ql("rotate",n)),this._modeDragZoom&&(this._modeDragZoom.pointerActions=Ql("zoom",n))}}destroy(){this.disconnect()}get primaryDragAction(){return this.view.navigation.actionMap.dragPrimary}set primaryDragAction(e){const{actionMap:t}=this.view.navigation;t.dragPrimary=e,t.dragSecondary="pan"===e?"rotate":"pan"}get updating(){return!!this._inputManager?.updating}get latestPointerType(){return this._inputManager?.latestPointerType}get latestPointerLocation(){return this._inputManager?.latestPointerLocation}get multiTouchActive(){return this._inputManager?.multiTouchActive??!1}disconnect(){this.removeAllHandles(),this.view.viewEvents.disconnect(),this._modeDragPan=null,this._modeDragRotate=null,this._modeDragZoom=null,this._modeKeyboardNavigation=null,this._inputManager=(0,p.SC)(this._inputManager),this._source=(0,p.SC)(this._source)}connect(){const e=this.view;this._source=new Bu(this.view.surface,e.input);const t=[new Ju,new ed,new id,new Wu(this.view.navigation),new nd],i=new fe.$({eventSource:this._source,recognizers:t});this._inputManager=i,i.installHandlers("prevent-context-menu",[new Gu],fe.f.INTERNAL);const r={fov:"Shift",pan:{left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:["u","U"],down:["j","J"]},lookAround:{headingLeft:["a","A"],headingRight:["d","D"],tiltUp:["w","W"],tiltDown:["s","S"],modifier:"b"},zoom:{zoomIn:["+","="],zoomOut:["-","_"]},reset:{heading:["n","N"],tilt:["p","P"]}};this._modeDragPan=new Pu(e,["primary"]),this._modeDragRotate=new uh(e,["secondary"],oh.CENTER),this._modeDragZoom=new Nh(e,["tertiary"],r.fov),this._modeKeyboardNavigation=new tu(e,r),i.installHandlers("navigation",[new Ru(e),new Jl(e),new Jh(e),new iu(e,r.fov),new uh(e,["primary"],oh.EYE,[r.lookAround.modifier]),new uh(e,["secondary"],oh.CENTER,[r.lookAround.modifier]),new Pu(e,["tertiary"],[r.lookAround.modifier]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,this._modeKeyboardNavigation,new Au(e)],fe.f.INTERNAL),this.view.viewEvents.connect(i),this.addHandles([(0,_.YP)((()=>this.view.navigation?.browserTouchPanEnabled),(e=>{this._source.browserTouchPanningEnabled=!e}),_.nn),(0,_.YP)((()=>{const{actionMap:e}=this.view.navigation,{dragPrimary:t,dragSecondary:i,dragTertiary:r}=e;return{mode:this.mode,dragPrimary:t,dragSecondary:i,dragTertiary:r}}),this._updateMode,_.tX)])}isModifierKeyDown(e){return this._inputManager?.isModifierKeyDown(e)??!1}get test(){}};(0,r._)([(0,w.Cb)()],sd.prototype,"view",void 0),(0,r._)([(0,w.Cb)({type:["default","pro"]})],sd.prototype,"mode",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],sd.prototype,"updating",null),(0,r._)([(0,w.Cb)()],sd.prototype,"latestPointerType",null),(0,r._)([(0,w.Cb)()],sd.prototype,"latestPointerLocation",null),(0,r._)([(0,w.Cb)()],sd.prototype,"multiTouchActive",null),(0,r._)([(0,w.Cb)()],sd.prototype,"_inputManager",void 0),sd=(0,r._)([(0,x.j)("esri.views.3d.input.SceneInputManager")],sd);const ad=sd;var od=i(89420),ld=i(87511),cd=i(63974),hd=i(27762);let ud,dd,pd=!1,md=!1,fd=!1,_d=!1,gd=null;function yd(e){fd=hd.h.DECONFLICTOR_SHOW_VISIBLE,_d=hd.h.DECONFLICTOR_SHOW_INVISIBLE,pd=fd||_d,md=hd.h.DECONFLICTOR_SHOW_GRID,gd=null,pd||md?(dd&&ud&&dd.clearRect(0,0,ud.width,ud.height),gd=()=>function(e){null==ud&&(ud=document.createElement("canvas"),ud.setAttribute("id","debugCanvas2d"),e.surface.parentElement.style.position="relative",e.surface.parentElement.appendChild(ud),ud.style.position="absolute",ud.style.width="100%",ud.style.height="100%",ud.style.display="block",ud.style.pointerEvents="none",dd=ud.getContext("2d"),dd.font="12px Arial");const{width:t,height:i}=e.state.camera;ud.width=t,ud.height=i}(e)):ud&&(ud.parentElement.removeChild(ud),ud=null)}function vd(){gd&&(gd(),gd=null)}function bd(e,t,i,r,n){vd();const s=ud.height,a=dd;a.beginPath(),a.lineWidth=1,a.strokeStyle=n,a.moveTo(e,s-i),a.lineTo(t,s-i),a.stroke(),a.lineTo(t,s-r),a.stroke(),a.lineTo(e,s-r),a.stroke(),a.lineTo(e,s-i),a.stroke(),a.closePath()}function wd(e,t,i=!1){pd&&(t&&fd||!t&&_d)&&bd(e[0],e[2],e[1],e[3],i?t?"pink":"grey":t?"green":"red")}class Cd{constructor(e,t,i){this._setVisibility=e,this._canConflict=t,this._compare=i,this.done=!1,this._items=new Array,this._accBinsNumX=15,this._accBinsNumY=20,this._accBinsSizeX=0,this._accBinsSizeY=0,this._accBins=null}destroy(){this._generator=null}reset(e,t){this._initBins(e,t),this._items.length=0,this.done=!1,this._generator=null}add(e){this._items.push(e)}run(e){this._generator??=this._run(e),this.done=!!this._generator.next(e).done}*_run(e){yield*this._sort(e),yield*this._deconflict(e),function(e){const t=md?e():null;if(!t?.bins)return;vd();const i=dd;let r=0;for(let e=0;e<t.numX;e++)for(let n=0;n<t.numY;n++){const s=t.bins[e][t.numY-1-n];r+=s.length;const a=e*t.sizeX,o=(e+1)*t.sizeX,l=n*t.sizeY,c=(n+1)*t.sizeY;i.fillText(s.length.toFixed(),a+5,l+15),bd(a,o,l,c,"blue")}i.fillText("total totalShownLabels: "+r,70,40),i.fillText("total visible labels: "+t.numVisible,70,50),i.fillText("total numTests: "+t.numTests,70,30)}((()=>({bins:this._accBins,numX:this._accBinsNumX,numY:this._accBinsNumY,sizeX:this._accBinsSizeX,sizeY:this._accBinsSizeY,numTests:0,numVisible:this._items.length})))}*_sort(e){for(const t of ld.Z.iterableSort(this._items,0,this._items.length,this._compare))e.madeProgress(),e.done&&(e=yield)}_isConflicted(e){let t=!0;return this._forEachBin(e.aabr,(i=>(t=!1,i.some((t=>this._canConflict(t,e)&&(0,H.kK)(t.aabr,e.aabr))))))||t}*_deconflict(e){for(const t of this._items){e.done&&(e=yield);const i=!this._isConflicted(t);this._setVisibility(t,i),wd(t.aabr,i),i&&this._addToBins(t),e.madeProgress()}}_initBins(e,t){if(null==this._accBins){this._accBins=[];for(let e=0;e<this._accBinsNumX;e++){this._accBins.push([]);const e=this._accBins[this._accBins.length-1];for(let t=0;t<this._accBinsNumY;t++)e.push(new cd.Z)}}else for(let e=0;e<this._accBinsNumX;e++)for(let t=0;t<this._accBinsNumY;t++)this._accBins[e][t].clear();this._accBinsSizeX=e/this._accBinsNumX,this._accBinsSizeY=t/this._accBinsNumY}_addToBins(e){this._forEachBin(e.aabr,(t=>t.push(e)))}_forEachBin(e,t){if(!this._accBins)return!1;const i=Math.max(Math.floor(e[0]/this._accBinsSizeX),0),r=Math.max(Math.floor(e[1]/this._accBinsSizeY),0),n=Math.min(Math.floor(e[2]/this._accBinsSizeX),this._accBinsNumX-1),s=Math.min(Math.floor(e[3]/this._accBinsSizeY),this._accBinsNumY-1);for(let e=i;e<=n;e++)for(let i=r;i<=s;i++)if(t(this._accBins[e][i]))return!0;return!1}}var xd=i(10841),Td=i(69371),Sd=i(75025);class Md{constructor(e){this._gl=e,this._sync=e.fenceSync(e.SYNC_GPU_COMMANDS_COMPLETE,0)}poll(){const e=this._gl,t=e.clientWaitSync(this._sync,e.SYNC_FLUSH_COMMANDS_BIT,0);if(t===e.WAIT_FAILED)throw new Error("clientWaitSync failed");return t!==e.TIMEOUT_EXPIRED}destroy(){this._gl.deleteSync(this._sync),this._sync=null}}var Ed=i(8158);let Pd=class extends wr.Z{constructor(e){super(e),this.category=dr.lu.COMPOSITE,this.running=!1,this.done=!0,this._origin=(0,R.Ue)(),this._textureWidth=256,this._uploadBuffer=new Float32Array(3*this._textureWidth),this._counter=0,this._width=0,this._height=0,this._pipeline=(0,Xi.sm)({colorWrite:Xi.gf}),this._format=0}initialize(){this.view.resourceController.scheduler.registerTask(nr.T8.GRAPHICS_CORE,this),this.produces="disabled",this.consumes.required=[this.category],this.formatOverride&&(this._format=this.formatOverride)}destroy(){this._program=(0,p.M2)(this._program);const e=this.gl;this._sync=(0,p.SC)(this._sync),this._pixelBuffer&&(e.deleteBuffer(this._pixelBuffer),this._pixelBuffer=null),this._texture=(0,p.M2)(this._texture)}precompile(){this._ensureShader(this.renderingContext)}render(e){const t=e.find((({name:e})=>e===this.category));if(this._sync)return t;this.produces="disabled";const i=this.renderingContext,r=this.gl,n=t.getTexture(r.DEPTH_STENCIL_ATTACHMENT);if(!n)return t;const s=this.view.stage.renderer.fboCache.acquire(this._width,this._height,"hud visibility",Td.qz.R32FLOAT);i.bindFramebuffer(s.fbo),i.setPipelineState(this._pipeline);const a=this._ensureShader(i);i.useProgram(a);i.bindTexture(n,0),a.setUniform1i("depthTex",0);return i.bindTexture(this._texture,1),a.setUniform1i("positionTex",1),(0,Vi.Jp)(Dd,this.camera.viewMatrix,(0,Vi.vc)(Dd,this._origin)),a.setUniformMatrix4fv("view",Dd),a.setUniformMatrix4fv("proj",this.camera.projectionMatrix),a.setUniform1i("count",this._counter),i.screen.draw(),this._pixelBuffer||(this._pixelBuffer=r.createBuffer()),0===this._format&&(this._format=r.getParameter(r.IMPLEMENTATION_COLOR_READ_FORMAT)===$i.VI.RED&&r.getParameter(r.IMPLEMENTATION_COLOR_READ_TYPE)===$i.g.FLOAT?$i.VI.RED:$i.VI.RGBA),r.bindBuffer(r.PIXEL_PACK_BUFFER,this._pixelBuffer),r.bufferData(r.PIXEL_PACK_BUFFER,this._width*this._height*(this._format===$i.VI.RED?4:16),r.STREAM_READ),r.readPixels(0,0,this._width,this._height,this._format,$i.g.FLOAT,0),this._sync=new Md(r),s.release(),setTimeout((()=>this.running=!0),0),t}runTask(){if(!this._sync)return void(this.running=!1);try{if(!this._sync.poll())return sr.J}catch(e){return this.running=!1,void(this._sync=(0,p.SC)(this._sync))}this.running=!1,this._sync=(0,p.SC)(this._sync);const e=this.gl;e.bindBuffer(e.PIXEL_PACK_BUFFER,this._pixelBuffer),this._cpuBuffer=new Float32Array(this._width*this._height*(this._format===$i.VI.RED?1:4)),e.getBufferSubData(e.PIXEL_PACK_BUFFER,0,this._cpuBuffer),e.bindBuffer(e.PIXEL_PACK_BUFFER,null),this.done=!0}init(e,t){const i=this._textureWidth;if(this._width=i,this._height=Math.ceil(e/i),this._counter=0,this._texture?.dispose(),0===this._height)return;const r=new ir.X(this._width,this._height);r.pixelFormat=$i.VI.RGB,r.dataType=$i.Br.FLOAT,r.samplingMode=$i.cw.NEAREST,this._texture=new Ed.x(this.renderingContext,r),this.done=!1,(0,Pi.i)(this._origin,Math.fround(t[0]),Math.fround(t[1]),Math.fround(t[2]))}addPosition(e){const t=this._width;if(this._counter>=t*this._height)return-1;const i=this._counter%t;return(0,Pi.a)(Od,e,this._origin),this._uploadBuffer[3*i+0]=Od[0],this._uploadBuffer[3*i+1]=Od[1],this._uploadBuffer[3*i+2]=Od[2],i===t-1&&this._flush(),this._counter++}start(){if(0===this._width||0===this._height)return;const e=this._width;this._counter%e>0&&this._flush(),this.produces=this.category,this.requestRender(Cr.Xx.UPDATE)}getOcclusion(e){return this._cpuBuffer?.[this._format===$i.VI.RED?e:4*e]??-1}_flush(){const e=this._width,t=Math.floor(this._counter/e);this._texture?.updateData(0,0,t,e,1,this._uploadBuffer)}_ensureShader(e){return null!=this._program||(this._program=e.programCache.acquire(Rd,Ad,Sd.i)),this._program}};(0,r._)([(0,w.Cb)()],Pd.prototype,"category",void 0),(0,r._)([(0,w.Cb)()],Pd.prototype,"formatOverride",void 0),(0,r._)([(0,w.Cb)()],Pd.prototype,"running",void 0),(0,r._)([(0,w.Cb)()],Pd.prototype,"done",void 0),Pd=(0,r._)([(0,x.j)("esri.views.3d.webgl-engine.lib.GPUPointOcclusionQuery")],Pd);const Rd="#version 300 es\nprecision highp float;\nin vec2 position;\n\nvoid main() {\n    gl_Position = vec4(position, 0.0, 1.0);\n}",Ad="#version 300 es\nprecision highp float;\nout highp vec4 fragColor;\n\nuniform highp mat4 proj;\nuniform highp mat4 view;\n\nuniform highp int count;\n\nuniform highp sampler2D depthTex;\nuniform highp sampler2D positionTex;\n\nfloat linearizeDepth(float depth) {\n  float depthNdc = depth * 2.0 - 1.0;\n  float c1 = proj[3][2];\n  float c2 = proj[2][2];\n  return -c1 / (depthNdc + c2 + 1e-7);\n}\n\nvoid main() {\n  int u = int(floor(gl_FragCoord.x));\n  int v = int(floor(gl_FragCoord.y));\n  if (u + v * textureSize(positionTex, 0).x >= count) {\n    fragColor = vec4(-1);\n    return;\n  }\n  vec4 posWorld = vec4(texelFetch(positionTex, ivec2(u, v), 0).rgb, 1.0);\n\n  vec4 posView = view * posWorld;\n  vec4 projected = proj * posView;\n\n  vec3 clipPos = projected.xyz / projected.w;\n\n  if (clipPos.x < -1.0 || clipPos.x > 1.0 || clipPos.y < -1.0 || clipPos.y > 1.0) {\n    fragColor = vec4(-1);\n    return;\n  }\n\n  vec3 uvDepth = 0.5 * clipPos + vec3(0.5);\n\n  float depth = texture(depthTex, uvDepth.xy).r;\n\n  if (uvDepth.z <= depth) {\n    fragColor = vec4(0);\n    return;\n  }\n\n  fragColor = vec4(linearizeDepth(depth) - linearizeDepth(uvDepth.z));\n}\n",Od=(0,R.Ue)(),Dd=(0,Bi.Ue)();var Id=i(31484),Ld=i(3970),Nd=i(83584);const Fd=(0,R.Ue)(),Ud=(0,R.Ue)(),Hd=(0,tc.Ue)(),kd=(0,tc.Ue)(),Vd=(0,R.Ue)(),Bd=(0,Bi.Ue)(),zd=(0,es.c)(),Gd=(0,Jn.Ue)(),qd=(0,R.Ue)(),Zd=(0,H.Ue)();class jd{constructor(e){this.id=e,this.aabr=(0,H.Ue)(),this.altitude=0,this.distance=0,this.distanceToOccluder=0,this.culled=!1,this.visible=!1,this.priority=0}}function Wd(e,t){const i=0!==e.distanceToOccluder&&e.distance>e.distanceToOccluder,r=0!==t.distanceToOccluder&&t.distance>t.distanceToOccluder;return i!==r?+i-+r:e.priority!==t.priority?t.priority-e.priority:e.distance!==t.distance?e.distance-t.distance:e.visible!==t.visible?+t.visible-+e.visible:e.id-t.id}class $d{constructor(e,t){this.graphics3DGraphic=e,this.slicePlaneEnabled=t,this._info=null,this._labelInfo=null}ensureInfo(e){let t=this.getInfo(e);return t||(t=new jd(this.graphics3DGraphic.graphic.uid),this._setInfo(e,t)),t}getInfo(e){return e===xd.E.LABEL?this._labelInfo:this._info}removeInfo(e){this._setInfo(e,null)}_setInfo(e,t){e===xd.E.LABEL?this._labelInfo=t:this._info=t}}var Xd;!function(e){e[e.Idle=0]="Idle",e[e.CheckOcclusion=1]="CheckOcclusion",e[e.WaitOcclusion=2]="WaitOcclusion",e[e.Collect=3]="Collect",e[e.Deconflict=4]="Deconflict",e[e.NumStates=5]="NumStates"}(Xd||(Xd={}));class Yd{constructor(){this.camera=new po.Z,this.slicePlane=(0,od.d)(),this.slicePlaneEnabled=!1}copyFrom(e){this.camera.copyFrom(e.camera),(0,od.a)(e.slicePlane,this.slicePlane),this.slicePlaneEnabled=e.slicePlaneEnabled}}let Kd=class extends S.Z{get dirty(){return this._dirty}get state(){return this._state}constructor(e){super(e),this._dirty=!1,this._viewState=new Yd,this._state=Xd.Idle,this._checkOcclusion=new Map,this._active=new Map,this._checkOcclusionIterator=null,this._activeIterator=null,this._occlusionQueryUids=new Array,this._updatingHandles=new X.R,this._deconflictor=new Cd(((e,t)=>{e.visible=t,this._setGraphicVisibility(this._active.get(e.id),t)}),((e,t)=>e.id!==t.id),Wd),this._baseOccludedVisibility=10,this._altitudeFactor=2,this._minAltitudeDifference=100}initialize(){this._updatingHandles.add((()=>(this.view?.map?.ground?.opacity??0)>0),(()=>this.setDirty())),this._updatingHandles.add((()=>this.view.ready),(()=>this._occlusionQuery=null))}destroy(){this._occlusionQuery=null,this._updatingHandles.destroy(),this._deconflictor.destroy(),this._checkOcclusion.clear(),this._active.clear()}setDirty(){!this._dirty&&(this._active.size>0||this._checkOcclusion.size>0)&&(this._dirty=!0,this.notifyChange("updating"))}setPriority(e,t){const i=this._active.get(e.graphic.uid)?.getInfo(this.visibilityGroup);i&&(i.priority=t)}get updating(){return this._state!==Xd.Idle||this._dirty||this._updatingHandles.updating}get updatingProgress(){if(!this.updating)return 1;const e=this._state/Xd.NumStates;return this._dirty?.5*e:e}get running(){return this.view.ready&&null!=this.view.state&&this.updating}runTask(e){switch(this._state){case Xd.Idle:this._startUpdate(),e.madeProgress();case Xd.CheckOcclusion:if(this._state=Xd.CheckOcclusion,!this._processCheckOcclusion(e))return;case Xd.WaitOcclusion:if(this._state=Xd.WaitOcclusion,this._occlusionQuery&&!this._occlusionQuery.done)return sr.J;this._readOcclusionQueryResult(),e.madeProgress();case Xd.Collect:if(this._state=Xd.Collect,!this._collectActiveGraphics(e))return;case Xd.Deconflict:if(this._state=Xd.Deconflict,this._deconflictor.run(e),!this._deconflictor.done)return;default:this._state=Xd.Idle,this.notifyChange("updating")}}setGraphicsActive(e,t){t?e.forEach((e=>this.addToActiveGraphics(e))):e.forEach((e=>this.removeFromActiveGraphics(e)))}layerSupportsDeconfliction(e){if(null==e||"object3d"!==e.type)return!1;const t=e.stageObject;if(1!==(t?.geometries.length??0))return!1;const i=t?.geometries[0],r=i?.material;return r instanceof Ld.A}_startUpdate(){yd(this.view),this._dirty=!1,this._viewState.copyFrom(this.viewState);const{fullWidth:e,fullHeight:t}=this._viewState.camera;this._deconflictor.reset(e,t),this._resetIterators(),this._occlusionQueryUids.length=0,this._checkOcclusion.size||(this._occlusionQuery=(0,p.SC)(this._occlusionQuery))}addToActiveGraphics(e){e.ensureInfo(this.visibilityGroup),this._active.set(e.graphics3DGraphic.graphic.uid,e),this.setDirty()}removeFromActiveGraphics(e){(function(e,t){const i=e.graphics3DGraphic;i.destroyed||i.setVisibilityFlag(t,xd.P.DECONFLICTION,!0)})(e,this.visibilityGroup),e.removeInfo(this.visibilityGroup),this._active.delete(e.graphics3DGraphic.graphic.uid),this.setDirty()}addToCheckOcclusion(e){this._checkOcclusion.set(e.graphics3DGraphic.graphic.uid,e),this.setDirty()}removeFromCheckOcclusion(e){this._checkOcclusion.delete(e.graphics3DGraphic.graphic.uid)}_processCheckOcclusion(e){if(0===this._checkOcclusion.size)return!0;const t=this._ensureCheckOcclusionIterator(),i=this._viewState.camera,r=(0,Vi.p4)(Bd,i.viewInverseTransposeMatrix),n=this.view.map.ground.opacity>0,s="global"===this.view.viewingMode&&n&&i.relativeElevation>0?zd:null;let a=0;null!=s&&((0,Pi.t)((0,es.a)(s),R.AG,i.viewMatrix),s[3]=(0,Ii.Iu)(this.view.spatialReference).radius,a=(0,es.h)(s,R.AG));const o=(0,H.Ue)();for(;;){if(e.done)return!1;e.madeProgress();const n=t.next();if(!0===n.done)break;const l=n.value,c=l.graphics3DGraphic;if(c.destroyed)continue;if(!c.isVisible(xd.E.GRAPHIC,xd.P.DECONFLICTION))continue;const h=ep(c,this.visibilityGroup);let u=null,d=!0;for(const e of h){if(!this.layerSupportsDeconfliction(e))continue;u=tp,this._projectHudLayer(e,i,u),(0,H.cS)(o);const t=e.stageObject.geometries[0].material;if(this._expandBoundingRect(o,i,e,t,u),u.isOutsideScreen){d=!1;break}if(this._isCulledBySlice(l,u.positionView)){d=!1;break}if(null!=s&&Jd(u,s,a)){d=!1;break}(0,Pi.t)(Ud,u.positionView,r),u.altitude=this.view.renderCoordsHelper.getAltitude(Ud);const n=l.ensureInfo(this.visibilityGroup);if(n.altitude=u.altitude,n.distance=u.distance,n.distanceToOccluder=u.distanceToOccluder,n.culled=!1,(0,H.JG)(n.aabr,o),t.parameters.occlusionTest)break;this._ensureOcclusionQuery().addPosition(Ud)===this._occlusionQueryUids.length&&this._occlusionQueryUids.push(c.graphic.uid);break}if(this._active.has(c.graphic.uid)&&(!d||!u)){const e=l.ensureInfo(this.visibilityGroup);e.visible=!u,e.culled=!0}}return this._checkOcclusionIterator=null,this._occlusionQueryUids.length||(this._occlusionQuery=(0,p.SC)(this._occlusionQuery)),this._occlusionQuery?.start(),!0}_readOcclusionQueryResult(){if(!this._occlusionQuery||!this._occlusionQueryUids.length)return;const e=this._viewState.camera,t=this.view.renderCoordsHelper.getAltitude(e.eye);for(let e=0;e<this._occlusionQueryUids.length;e++){const i=this._occlusionQueryUids[e],r=this._checkOcclusion.get(i);if(!r)continue;const n=this._occlusionQuery.getOcclusion(e)??-1,s=r.getInfo(this.visibilityGroup);s&&(s.distanceToOccluder=n>0?s.distance-n:0);const a=n<=0||this._occludedVisibility(s?.distanceToOccluder??0,s?.distance??n,s?.altitude??0,t);this._active.has(i)?s&&(s.culled=!a,s.visible=a):this._setGraphicVisibility(r,a)}this._occlusionQueryUids.length=0}_collectActiveGraphics(e){const t=this._ensureActiveGraphicsIterator(),i=this.visibilityGroup===xd.E.LABEL;for(;!e.done;){e.madeProgress();const r=t.next();if(!0===r.done)return this._activeIterator=null,!0;const n=r.value,s=n.getInfo(this.visibilityGroup);s&&(i&&!n.graphics3DGraphic.isVisible()||s.culled?(wd(s.aabr,!1,!0),this._setGraphicVisibility(n,s.visible)):this._deconflictor.add(s))}return!1}_occludedVisibility(e,t,i,r){const n=Math.max(this._minAltitudeDifference,Math.abs(i-r))-this._minAltitudeDifference;return 0===e||t-e<=this._baseOccludedVisibility+this._altitudeFactor*n}_resetIterators(){this._checkOcclusionIterator=null,this._activeIterator=null}_ensureCheckOcclusionIterator(){return this._checkOcclusionIterator??=this._checkOcclusion.values(),this._checkOcclusionIterator}_ensureActiveGraphicsIterator(){return this._activeIterator??=this._active.values(),this._activeIterator}_ensureOcclusionQuery(){return this._occlusionQuery??=new Pd({view:this.view}),this._occlusionQueryUids.length||this._occlusionQuery.init(this._checkOcclusion.size,this._viewState.camera.eye),this._occlusionQuery}_projectHudLayer(e,t,i){const r=e.stageObject,n=r.geometries[0],s=n.material,a=(0,es.a)(r.boundingVolumeWorldSpace.bounds);(0,Pi.t)(Fd,a,t.viewMatrix);const o=n.attributes,l=o.get(mr.T.NORMAL).data,c=o.get(mr.T.CENTEROFFSETANDDISTANCE).data;s.applyShaderOffsetsView(Fd,l,r.transformation,c,t,i.scaleInfo,Fd),(0,ec.s)(Hd,Fd[0],Fd[1],Fd[2],1),(0,ec.t)(kd,Hd,t.projectionMatrix),(0,Pi.g)(i.positionNDC,kd,1/kd[3]),s.applyShaderOffsetsNDC(i.positionNDC,c,t,i.positionNDC,Vd),i.distanceWithoutPolygonOffset=t.depthNDCToWorld(Vd[2]),i.distance=Vd[2]===i.positionNDC[2]?i.distanceWithoutPolygonOffset:t.depthNDCToWorld(i.positionNDC[2]),(0,ec.s)(kd,i.positionNDC[0],i.positionNDC[1],i.positionNDC[2],1),(0,ec.t)(Hd,kd,t.inverseProjectionMatrix),(0,ec.d)(Hd,Hd,1/Hd[3]),(0,Pi.i)(i.positionView,Fd[0],Fd[1],Fd[2])}_isCulledBySlice(e,t){return e.slicePlaneEnabled&&this._viewState.slicePlaneEnabled&&(0,od.e)(this._viewState.slicePlane,t)}_expandBoundingRect(e,t,i,r,{positionNDC:n,scaleInfo:s}){const a=i.getScreenSize(Qd);(0,Id.TU)(a,s.factor,a),a[0]*=t.pixelRatio,a[1]*=t.pixelRatio;const o=(0,H.cv)(r.calculateRelativeScreenBounds(a,s.factorAlignment.scale*t.pixelRatio,Zd),(0,st.t7)(0,t.fullWidth,.5+.5*n[0]),(0,st.t7)(0,t.fullHeight,.5+.5*n[1])),l=this.marginFactor;if(0!==l){const e=l*Math.min((0,H.d_)(o),(0,H.Cb)(o));o[0]-=e,o[1]-=e,o[2]+=e,o[3]+=e}(0,H.jn)(e,o,e)}_setGraphicVisibility(e,t){const i=e?.graphics3DGraphic;i&&!i.destroyed&&(i.setVisibilityFlag(this.visibilityGroup,xd.P.DECONFLICTION,t),this.visibilityGroup===xd.E.LABEL&&this.view.labeler.setLabelGraphicVisibility(i,t))}};(0,r._)([(0,w.Cb)({constructOnly:!0})],Kd.prototype,"view",void 0),(0,r._)([(0,w.Cb)({type:Boolean,readOnly:!0})],Kd.prototype,"updating",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Kd.prototype,"_updatingHandles",void 0),Kd=(0,r._)([(0,x.j)("esri.views.3d.layers.graphics.Deconflictor")],Kd);const Qd=(0,Gi.Ue)();function Jd(e,t,i){return(0,Pi.c)(Gd.direction,e.positionView),(0,Pi.i)(Gd.origin,0,0,0),!!(0,es.i)(t,Gd,qd)&&e.distanceWithoutPolygonOffset>i}function ep(e,t){return t===xd.E.LABEL?e.labelLayers:e.layers}const tp=new class{constructor(){this.positionView=(0,R.Ue)(),this.positionNDC=(0,R.Ue)(),this.altitude=0,this.distance=0,this.distanceToOccluder=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo=new Nd.G}get isOutsideScreen(){const e=this.positionNDC;return e[0]<-1||e[1]<-1||e[2]<-1||e[0]>=1||e[1]>=1||e[2]>=1}};let ip=class extends Kd{constructor(e){super(e),this.visibilityGroup=xd.E.LABEL,this.marginFactor=.05,this._lastDeconfliction=0}get viewState(){return this.parent.viewState}runTask(e){if(this.parent.running)return sr.J;const t=performance.now();if(this.view.state.mode!==$c.n.IDLE&&t-this._lastDeconfliction<2e3)return sr.J;const i=super.runTask(e);return this.state===Xd.Idle&&(this._lastDeconfliction=t),i}};(0,r._)([(0,w.Cb)({constructOnly:!0})],ip.prototype,"parent",void 0),ip=(0,r._)([(0,x.j)("esri.views.3d.layers.graphics.LabelDeconflictor")],ip);let rp=class extends Kd{constructor(){super(...arguments),this._contexts=new Map,this.visibilityGroup=xd.E.GRAPHIC,this._marginFactor=-.1,this.test={overrideMarginFactor:e=>{this._marginFactor=e,this.setDirty()}}}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this._updatingHandles.add((()=>this.view?.state?.camera),(()=>{this._updateViewState(),this.setDirty()})),this._updatingHandles.add((()=>this.view?.slice?.plane),(()=>{this._updateSlicePlane(),this._slicePlaneChanged()}),_.nn),this.addHandles((0,_.YP)((()=>this.view.basemapTerrain?.updating||this.view.graphicsView?.updating||this.view.allLayerViews.some((e=>e.updating))),((e,t)=>{!e&&t&&this.setDirty()}),_.Z_)),this._frameTask=this.view.resourceController.scheduler.registerTask(nr.T8.GRAPHICS_DECONFLICTOR,this),this._labels=new ip({view:this.view,parent:this})}destroy(){this._labels=(0,p.SC)(this._labels),this._frameTask=(0,p.hw)(this._frameTask)}get marginFactor(){return this._marginFactor}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}runTask(e){const t=super.runTask(e);return this.running||this._labels.setDirty(),t}_updateViewState(){this.view?.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this._updateSlicePlane())}_updateSlicePlane(){const e=this.view?.slice?.plane;null!=e&&(0,od.t)(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=null!=e}_slicePlaneChanged(){for(const e of this._contexts.keys())if(e.symbolCreationContext.slicePlaneEnabled)return void this.setDirty()}addGraphicsOwner(e){const t=this._getGraphicsContext(e);return{addGraphic:i=>this._addGraphic(e,t,i),removeGraphic:e=>this._removeGraphic(t,e),labelingInfoChange:()=>this._labelsEnabledChanged(e,t),featureReductionChange:()=>this._enabledChanged(e,t),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,t),clear:()=>t.forEach((e=>this._removeGraphic(t,e.graphics3DGraphic))),remove:()=>this._removeGraphicsOwner(e),setDirty:()=>this.setDirty()}}_removeGraphicsOwner(e){const t=this._contexts.get(e);t&&(t.forEach((e=>this._removeGraphic(t,e.graphics3DGraphic))),this._contexts.delete(e),this.setDirty())}_addGraphic(e,t,i){const r=i.graphic.uid,n=new $d(i,e.symbolCreationContext.slicePlaneEnabled);t.set(r,n),this.addToCheckOcclusion(n),np(e)&&this.addToActiveGraphics(n),e.labelsEnabled&&(this._labels.addToCheckOcclusion(n),this._labels.addToActiveGraphics(n));const s=!this._graphicSupportsDeconfliction(i)||!np(e);i.setVisibilityFlag(xd.E.GRAPHIC,xd.P.DECONFLICTION,s)}_removeGraphic(e,t){const i=t.graphic.uid,r=e.get(i);r&&(this.removeFromActiveGraphics(r),this.removeFromCheckOcclusion(r),this._labels.removeFromActiveGraphics(r),this._labels.removeFromCheckOcclusion(r),e.delete(i),this.setDirty())}_enabledChanged(e,t){np(e)?t.forEach((e=>this.addToActiveGraphics(e))):(t.forEach((e=>this.removeFromActiveGraphics(e))),function(e){const t=e.graphics3DGraphics;t&&t.forEach((e=>e.setVisibilityFlag(xd.E.GRAPHIC,xd.P.DECONFLICTION,!0)))}(e))}_labelsEnabledChanged(e,t){e.labelsEnabled?(t.forEach((e=>this._labels.addToCheckOcclusion(e))),t.forEach((e=>this._labels.addToActiveGraphics(e)))):(t.forEach((e=>this._labels.removeFromCheckOcclusion(e))),t.forEach((e=>this._labels.removeFromActiveGraphics(e))))}_slicePlaneEnabledChanged(e,t){const i=e.symbolCreationContext.slicePlaneEnabled;t.forEach((e=>e.slicePlaneEnabled=i)),this.setDirty()}_graphicSupportsDeconfliction(e){if(e.isDraped)return!1;const t=e.layers;if(!t?.length)return!1;for(const e of t)if(this.layerSupportsDeconfliction(e))return!0;return!1}_getGraphicsContext(e){const t=this._contexts.get(e);if(t)return t;const i=new Map;return this._contexts.set(e,i),this.setDirty(),i}};function np(e){const t=e.layer;return!(!t?.featureReduction||"selection"!==t.featureReduction.type)}rp=(0,r._)([(0,x.j)("esri.views.3d.layers.graphics.GraphicsDeconflictor")],rp);var sp=i(62640),ap=i(67908),op=i(91383),lp=i(30146),cp=i(8008);class hp{constructor(e,t){this._renderCoordsHelper=e,this.opaqueGround=t,this._cache=new Map,this._cameraForward=(0,R.Ue)(),this._cameraEye=(0,R.Ue)(),this._cameraFovY=55*Math.PI/180,this._frustumBoundingSphereCenter=(0,R.Ue)(),this._frustumBoundingSphereRadius=0,this._frustum=new oc.i(e),this._renderSR=e.spatialReference;const i=(0,Ri.rS)(this._renderSR);this._renderSREllipsoidRadius=(0,Ii.Iu)(i).radius}setup(e){this._aboveGround=e.aboveGround,this._frustum.update(e),(0,Pi.n)(this._cameraForward,e.viewForward),(0,Pi.c)(this._cameraEye,e.eye),this._cameraFovY=e.fovY,this._updateFrustumBoundingSphere()}done(){this._cache.clear()}compute(e){if(this._cache.has(e.id))return this._cache.get(e.id);const t=this._isVisibleInFrustum(e);return this._cache.set(e.id,t),t}_isVisibleInFrustum(e){return this._renderCoordsHelper.viewingMode===Ht.JY.Local?this._isTileVisibleInFrustumLocal(e):this._isTileVisibleInFrustumGlobal(e)}_updateFrustumBoundingSphere(){const e=this._frustum,t=e.origin,i=Ap;(0,Pi.n)(i,e.direction);const r=e.points,n=Op;(0,Pi.a)(n,r[4],t);const s=.5*(0,Pi.e)(n,n)/(0,Pi.e)(i,n),a=this._frustumBoundingSphereCenter;(0,Pi.b)(a,t,i,s);const o=1+s;this._frustumBoundingSphereRadius=o}_isTileVisibleInFrustumLocal(e){const t=e.spatialReference,i=e.extent,r=this._renderSR;if(wp[0]=i[0],wp[1]=i[1],wp[2]=0,wp[3]=i[2],wp[4]=i[3],wp[5]=0,!(0,lp.projectBuffer)(wp,t,0,wp,r,0))return!1;(0,Pi.i)(Cp[0],wp[0],wp[1],0),(0,Pi.i)(Cp[1],wp[3],wp[1],0),(0,Pi.i)(Cp[2],wp[3],wp[4],0),(0,Pi.i)(Cp[3],wp[0],wp[4],0),(0,Pi.i)(xp,.5*(wp[0]+wp[3]),.5*(wp[1]+wp[4]),.5*(wp[2]+wp[5]));const n=om,s=.5*(0,Pi.F)(Cp[0],Cp[2]),a=this._frustum,o=this._frustumBoundingSphereRadius,l=this._frustumBoundingSphereCenter,c=Ip;(0,Pi.a)(c,l,xp);const h=(0,Pi.e)(n,c),u=Dp;if((0,Pi.b)(u,xp,n,h),(0,Pi.F)(u,l)>s+o)return!1;const d=this._cameraForward,p=(0,Pi.e)(d,om),m=this._cameraFovY,f=this._cameraEye;if(Math.abs(p)<Math.abs(Math.cos(.5*m))){let e=!0;const t=(0,Pi.i)(lm,d[0],d[1],0),i=(0,Pi.e)(f,t);for(let r=0;r<4;++r){const n=Cp[r];if((0,Pi.e)(n,t)-i>0){e=!1;break}}if(e)return!1}{const e=Cp[0],t=Cp[2];if(e[0]<=f[0]&&f[0]<=t[0]&&e[1]<=f[1]&&f[1]<=t[1])return!0}const _=bp,g=this.opaqueGround&&this._aboveGround,y=this.opaqueGround&&!this._aboveGround,v=Math.min(y?rm:1/0,h+o),b=Math.max(g?-430:-1/0,h-o);for(let e=0;e<4;++e)(0,Pi.b)(_[e],Cp[e],n,v),(0,Pi.b)(_[e+4],Cp[e],n,b);if(_p(a.planes,_,8))return!1;if(gp(a.planes,_,8))return!0;for(let e=0;e<4;++e){const t=_[e],i=_[e+4];if(cm(a.planes,t,i))return!0;const r=_[(e+1)%4];if(cm(a.planes,t,r))return!0;const n=_[4+(e+1)%4];if(cm(a.planes,i,n))return!0}if(dm[0][3]=+Cp[0][0],dm[1][3]=-Cp[2][0],dm[2][3]=+Cp[0][1],dm[3][3]=-Cp[2][1],dm[4][3]=+b,dm[5][3]=-v,gp(dm,a.points))return!0;if(gp(dm,a.points))return!0;for(let e=0;e<4;++e){const t=f,i=a.points[e+4];if(hm(dm,t,i))return!0;const r=a.points[4+(e+1)%4];if(hm(dm,i,r))return!0}return!1}_isTileVisibleInFrustumGlobal(e){if(e.level<yp)return!0;const t=e.spatialReference,i=e.extent,r=this.opaqueGround&&this._aboveGround,n=this.opaqueGround&&!this._aboveGround,s=Cp,a=.5*(i[0]+i[2]);if((0,Pi.i)(s[0],i[0],i[1],0),(0,Pi.i)(s[1],i[2],i[1],0),(0,Pi.i)(s[2],i[2],i[3],0),(0,Pi.i)(s[3],i[0],i[3],0),(0,Pi.i)(s[4],a,i[1],0),(0,Pi.i)(s[5],a,i[3],0),!function(e,t,i,r,n,s,a=1){const o=(0,cp.R8)(t,n);if(null==o)return!1;if(o===cp.iq){if(e===r&&i===s)return!0;const t=i+a;for(let n=i,a=s;n<t;++n,++a)(0,Pi.c)(r[a],e[n]);return!0}const l=i+a;for(let t=i,n=s;t<l;++t,++n)o(e[t],0,r[n],0);return!0}(s,t,0,s,this._renderSR,0,6))return!1;const o=s[0][2]>0,l=s[3][2]<0,c=o||l,h=this._renderSREllipsoidRadius;if(c){const e=Sp;up(e,pm,s[0]);const t=Mp;if(up(t,pm,s[1]),o){const i=Tp,r=s[4],n=Ep;up(n,r,pm),up(i,n,r);const a=s[0];(0,Pi.h)(a,e,i),pp(a,h);const o=s[1];(0,Pi.h)(o,t,i),pp(o,h)}else if(l){const i=Tp,r=s[5],n=Ep;up(n,r,pm),up(i,r,n);const a=s[3];(0,Pi.h)(a,i,e),pp(a,h);const o=s[2];(0,Pi.h)(o,i,t),pp(o,h)}}const u=xp,d=(0,Pi.a)(Hp,s[3],s[0]);(0,Pi.n)(d,d);const p=(0,Pi.f)(kp,s[0],s[3]);(0,Pi.g)(p,p,.5);const m=-(0,Pi.e)(p,d),f=(0,Pi.f)(Vp,s[0],s[1]);(0,Pi.g)(f,f,.5);const _=(0,Pi.f)(Bp,s[2],s[3]);(0,Pi.g)(_,_,.5);const g=(0,Pi.a)(zp,_,f);(0,Pi.n)(g,g);const y=-(m+(0,Pi.e)(d,f))/(0,Pi.e)(d,g);(0,Pi.b)(u,f,g,y),pp(u,h);const v=this._frustumBoundingSphereRadius,b=this._frustumBoundingSphereCenter,w=this._frustum,C=w.planes,x=Pp;(0,Pi.n)(x,u);const T=(0,Pi.e)(s[0],x)/(0,Pi.H)(s[0]),S=w.origin,M=w.points;let E=!1;if(r){{E=!0;const e=(0,Pi.n)(nm,S);for(let t=0;t<4;++t){const i=M[4+t],r=(0,Pi.a)((0,R.Ue)(),i,S);(0,Pi.n)(r,r);const n=(0,Pi.h)((0,R.Ue)(),e,r);(0,Pi.n)(n,n);const s=(0,Pi.h)((0,R.Ue)(),r,n);if((0,Pi.n)(s,s),(0,Pi.e)(S,s)>h){E=!1;break}}}if(E&&(0,Pi.e)(S,x)<h*T-rm)return!1;const e=(0,Pi.n)(nm,w.origin);if((0,Pi.e)(e,x)<0)return!1;{const e=(0,Pi.n)(sm,w.direction);if((0,Pi.e)(e,x)>am)return!1}}const P=Math.sqrt(1-T*T);if(P>.9)return!0;let A=!1;const O=(0,Pi.e)(x,b),D=(0,Pi.H)(b);if(D<=v&&!C.some((e=>(0,Ro.jH)(e,Lp)>0))){if(!r)return!0;A=!0}const I=O/D;if(!A&&O<=0&&-O>v)return!1;const L=v/D;if(Math.sqrt(1-I*I)*Math.sqrt(1-L*L)-L*I>P)return!1;if(!E){if(s.some((e=>w.intersectsPoint(e))))return!0;if(w.intersectsPoint(u))return!0}const N=Np;(0,Pi.a)(N,b,Lp);const F=(0,Pi.e)(N,x),U=Rp;(0,Pi.g)(U,x,F);const H=(0,Pi.F)(U,b),k=t.isWGS84,V=e.lij,B=k&&V[2]===2**V[0]-1,z=k&&0===V[2],G=z?Qp:B?Yp:$p,q=z?Jp:B?Kp:Xp;if(!A){const e=s,t=em,i=Gp,r=qp,n=Lp;for(const s of G){const a=e[s];if(dp(i,e[(s+1)%4],a),dp(r,n,a),up(t,r,i),vp(t,M,1))return!1}}let Z=null;if(!r&&F<1.01*v){const e=2.5*v;if(H>T*e+v)return!1;const t=Up,i=e/T;for(let e=0;e<4;++e)(0,Pi.g)(t[e],s[e],i/h);(0,Pi.i)(t[4],0,0,0),Z=t}else{const e=(n?h+rm:F+v)/T,t=r?h-rm:(F-v)/T,i=Fp;for(let r=0;r<4;++r){const n=s[r];(0,Pi.g)(i[r],n,t/h),(0,Pi.g)(i[r+4],n,e/h)}Z=i}if(_p(C,Z,Z.length))return!1;const j=w.lines,W=Zp,$=jp;for(const e of j){(0,Pi.n)($,e.direction);for(const e of q){const t=Z[e];if((0,Pi.n)(W,t),im($,W,Z,M))return!1;const i=(e+1)%4;if(r){const e=Z[i];if((0,Pi.a)(W,e,t),(0,Pi.n)(W,W),im($,W,Z,M))return!1}if(n){const t=Z[4+e],r=Z[4+i];if((0,Pi.a)(W,r,t),(0,Pi.n)(W,W),im($,W,Z,M))return!1}}}return!0}}function up(e,t,i){return(0,Pi.h)(e,t,i),(0,Pi.n)(e,e),e}function dp(e,t,i){return(0,Pi.a)(e,t,i),(0,Pi.n)(e,e),e}function pp(e,t){return(0,Pi.g)(e,e,t/(0,Pi.H)(e)),e}const mp=[_c.Nu.LEFT,_c.Nu.RIGHT,_c.Nu.BOTTOM,_c.Nu.TOP,_c.Nu.FAR];function fp(e,t,i){for(let r=0;r<i;++r)if((0,Ro.jH)(e,t[r])<=0)return!1;return!0}function _p(e,t,i){for(const r of mp)if(fp(e[r],t,i))return!0;return!1}function gp(e,t,i=t.length){for(let r=0;r<i;++r){const i=t[r];let n=!0;for(const t of e)if((0,Ro.jH)(t,i)>0){n=!1;break}if(n)return!0}return!1}const yp=2;function vp(e,t,i){for(const r of t)if((0,Pi.e)(r,e)<i)return!1;return!0}const bp=[(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)()],wp=[0,0,0,0,0,0],Cp=[(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)()],xp=(0,R.Ue)(),Tp=(0,R.Ue)(),Sp=(0,R.Ue)(),Mp=(0,R.Ue)(),Ep=(0,R.Ue)(),Pp=(0,R.Ue)(),Rp=(0,R.Ue)(),Ap=(0,R.Ue)(),Op=(0,R.Ue)(),Dp=(0,R.Ue)(),Ip=(0,R.Ue)(),Lp=(0,R.vV)(0,0,0),Np=(0,R.Ue)(),Fp=[(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)()],Up=[(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)()],Hp=(0,R.Ue)(),kp=(0,R.Ue)(),Vp=(0,R.Ue)(),Bp=(0,R.Ue)(),zp=(0,R.Ue)(),Gp=(0,R.Ue)(),qp=(0,R.Ue)(),Zp=(0,R.Ue)(),jp=(0,R.Ue)(),Wp=(0,R.Ue)(),$p=[0,1,2,3],Xp=[0,1,2,3],Yp=[0,1,3],Kp=[0,1,3],Qp=[1,2,3],Jp=[1,2,3],em=(0,R.Ue)();const tm=[0,0];function im(e,t,i,r){const n=i.length,s=r.length;if(0===n||0===s)return!0;const a=Wp;up(a,e,t);const o=s<n,l=o?i:r,c=tm;return function(e,t,i){let r=1/0,n=-1/0;for(const e of i){const i=(0,Pi.e)(t,e);r=Math.min(r,i),n=Math.max(n,i)}e[0]=r,e[1]=n}(c,a,o?r:i),function(e,t,i,r){let n=1/0,s=-1/0;for(const a of r){const r=(0,Pi.e)(i,a);if(n=Math.min(n,r),s=Math.max(s,r),n<=t&&s>=e)return!1}return!0}(c[0],c[1],a,l)}const rm=430,nm=(0,R.Ue)(),sm=(0,R.Ue)(),am=Math.cos(.25*Math.PI),om=(0,R.al)(0,0,1),lm=(0,R.Ue)();function cm(e,t,i){const r={t0:0,t1:1};for(const n of mp)if(!um(e[n],t,i,r))return!1;return r.t0<r.t1}function hm(e,t,i){const r={t0:0,t1:1};for(const n of e)if(!um(n,t,i,r))return!1;return r.t0<r.t1}function um(e,t,i,r){let{t0:n,t1:s}=r;const a=(0,Ro.jH)(e,t),o=(0,Ro.jH)(e,i);if(a>=0&&o>=0)return!1;if(a<0&&o>=0){const e=-a/(o-a);if(e<n)return!1;e<s&&(s=e)}else if(a>=0&&o<0){const e=a/(a-o);if(e>s)return!1;e>n&&(n=e)}return r.t0=n,r.t1=s,!0}const dm=[(0,Ro.al)(-1,0,0,1),(0,Ro.al)(1,0,0,-1),(0,Ro.al)(0,-1,0,1),(0,Ro.al)(0,1,0,-1),(0,Ro.al)(0,0,-1,1),(0,Ro.al)(0,0,1,-1)],pm=(0,R.vV)(0,0,1);class mm{constructor(e,t,i){this._renderCoordsHelper=e,this._tilingScheme=t,this._camera=new po.Z,this._surfaceElevation=0,this._focusOnMap=[0,0],this._visibility=new hp(e,i)}set opaqueGround(e){this._visibility.opaqueGround=e}setup(e,t,i){this._camera.copyFrom(e),this._surfaceElevation=i,this._focusOnMap[0]=t.x,this._focusOnMap[1]=t.y,this._visibility.setup(this._camera)}done(){this._visibility.done()}update(e){const{measures:t,extent:i,level:r}=e;t.visible=this._visibility.compute(e),t.distance=(0,H.TE)(i,this._focusOnMap),t.mergeable=!0,t.lodLevel=yp,t.splitPriority=Math.max(0,yp-r),t.visible&&(this._isGlobal?this._updateSplitAndLodGlobal(e):this._updateSplitAndLodLocal(e))}_updateSplitAndLodGlobal(e){const t=e.level,i=this._renderCoordsHelper,{eye:r,fov:n}=this._camera,s=i.referenceEllipsoid.radius,a=(0,Pi.H)(r)-s;if(2*Math.atan(s/a)<n&&a>0)return void(e.measures.lodLevel=Math.max(t,yp));const o=fm,{extent:l}=e,{_surfaceElevation:c}=this;(0,Pi.i)(o[0],l[0],l[1],c),(0,Pi.i)(o[1],l[2],l[1],c),(0,Pi.i)(o[2],l[2],l[3],c),(0,Pi.i)(o[3],l[0],l[3],c);const h=(0,Pi.i)(_m,.5*(l[0]+l[2]),.5*(l[1]+l[3]),c),u=this._tilingScheme.spatialReference;for(let e=0;e<4;++e)i.toRenderCoords(o[e],u,o[e]);i.toRenderCoords(h,u,h);const d=(0,Pi.n)(bm.direction,h),p=(0,Pi.e)(r,d),m=(0,Pi.g)(ym,d,p);this._updateSplitAndLod(e,o,h,m)}_updateSplitAndLodLocal(e){const t=fm,{extent:i}=e,{_surfaceElevation:r}=this;(0,Pi.i)(t[0],i[0],i[1],r),(0,Pi.i)(t[1],i[2],i[1],r),(0,Pi.i)(t[2],i[2],i[3],r),(0,Pi.i)(t[3],i[0],i[3],r);const n=this._tilingScheme.spatialReference;for(let e=0;e<4;++e)this._renderCoordsHelper.toRenderCoords(t[e],n,t[e]);const s=(0,Pi.i)(_m,.5*(t[0][0]+t[2][0]),.5*(t[0][1]+t[2][1]),.25*(t[0][2]+t[1][2]+t[2][2]+t[3][2])),a=(0,Pi.i)(gm,s[0],s[1],0),{eye:o,far:l}=this._camera,c=(0,Pi.i)(ym,a[0],a[1],o[2]);(0,Pi.i)(bm.origin,a[0],a[1],o[2]-2*l),(0,Pi.c)(bm.direction,vm),this._updateSplitAndLod(e,t,s,c)}_updateSplitAndLod(e,t,i,r){const n=Math.max((0,Pi.F)(t[0],t[2]),(0,Pi.F)(t[1],t[3]),(0,Pi.F)(t[0],i)+(0,Pi.F)(i,t[2]),(0,Pi.F)(t[1],i)+(0,Pi.F)(i,t[3])),{eye:s,near:a,fov:o,viewForward:l,width:c,height:h,pixelRatio:u,frustum:d}=this._camera,p=(0,Pi.e)(s,l),m=(0,Pi.e)(i,l)-p,f=(0,Pi.F)(i,s);let _=m,g=m,y=f,v=f;const b=(e,t)=>t<a?1:Math.sqrt(e*e-t*t)/t;let w=b(f,m);for(const e of t){const t=(0,Pi.e)(e,l)-p;_=Math.min(_,t),g=Math.max(g,t);const i=(0,Pi.F)(e,s);v=Math.max(v,i),y=Math.min(y,i);const r=b(i,t);w=Math.min(w,r)}if(g<a)return void(e.measures.lodLevel=0);const C=Math.cos(.5*o),x=(0,Pi.F)(s,r);w>C&&x>Cm*n&&(g=xm*v,_=xm*y);const T=.5*Math.sqrt(c*c+h*h)/u,S=2*Math.tan(.5*o),M=e=>Math.max(a,e)*wm/T*S,E=e.level,P=n*2**E*Math.max(1,S),R=M(_),A=Math.ceil(Math.log2(Math.max(1,P/R)));if(e.measures.lodLevel=Math.max(A,e.measures.lodLevel),e.measures.splitPriority+=e.measures.lodLevel-E,E<A){const i=+(0,_c.g8)(d,t[0])+ +(0,_c.g8)(d,t[1])+ +(0,_c.g8)(d,t[2])+ +(0,_c.g8)(d,t[3]);e.measures.splitPriority+=i}const O=M(g)/R;O>2.5&&(e.measures.splitPriority+=O)}get _isGlobal(){return this._renderCoordsHelper.viewingMode===Ht.JY.Global}}const fm=[(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)(),(0,R.Ue)()],_m=(0,R.Ue)(),gm=(0,R.Ue)(),ym=(0,R.Ue)(),vm=(0,R.vV)(0,0,1),bm=(0,Jn.al)(R.AG,vm),wm=312,Cm=.5,xm=2;var Tm=i(58300);let Sm=class extends S.Z{constructor(e){super(e),this.tiles=new a.Z,this.tileSize=512,this._idToTile=new Map,this._clients=new Set,this._dirty=(0,Di.t)(!1),this._pendingTiles=(0,Di.t)(null),this._newTiles=new cd.Z,this._tests=!1,this._measurements=new mm(e.renderCoordsHelper,e.tilingSchemeOwner.tilingScheme,this._opaqueGround)}initialize(){const e=()=>this._setDirty();this.addHandles([(0,_.YP)((()=>this.tileSize),(()=>this._reset()),_.tX),(0,_.YP)((()=>this.cameraOnSurface?.location),e,_.tX),(0,_.YP)((()=>this.viewState?.contentCamera),e,_.tX),(0,_.YP)((()=>this.focus?.location),e,_.tX),(0,_.YP)((()=>this.terrain?.baseOpacity??1),e),(0,_.YP)((()=>this.tilingScheme),(e=>{this._reset(),this._measurements=new mm(this.renderCoordsHelper,e,this._opaqueGround)}),_.Z_),(0,_.YP)((()=>this._opaqueGround),(e=>this._measurements.opaqueGround=e),_.Z_)]),this._frameWorker=this.scheduler?.registerTask(nr.T8.FEATURE_TILE_TREE,this)}destroy(){this._frameWorker=(0,p.hw)(this._frameWorker)}get tilingScheme(){const e=this.tilingSchemeOwner.tilingScheme;return e?e.clone():null}set filterExtent(e){if(null!=e&&!e.spatialReference.equals(this.viewState.spatialReference))return void d.Z.getLogger(this).error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const t=this._get("filterExtent");if(t===e||null!=t&&e&&t.equals(e))return;const i=null!=e?e.clone():null;this._set("filterExtent",i),this._setDirty()}get _filterExtentRect(){if(null==this.filterExtent)return null;const e=(0,H.Ue)();return(0,Tm.G)(this.filterExtent,e,this.tilingScheme.spatialReference),e}get _rootTileIds(){const{tilingScheme:e}=this;return this._filterExtentRect&&e?e.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}get updating(){return this._dirty.value||!!this._pendingTiles.value}addClient(){const e=(0,ap.D)();return this._clients.add(e),1===this._clients.size&&this._setDirty(),(0,h.kB)((()=>this._removeClient(e)))}_removeClient(e){this._clients.delete(e),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}get _opaqueGround(){return 1===(this.terrain?.baseOpacity??1)}_setDirty(){this._hasClients&&!this.suspended&&(this._frameWorker?this._dirty.value=!0:this.runTask(nr.G5))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty.value=!1}get running(){return this.updating}_reset(){this._newTiles.clear(),this._pendingTiles.value=null,this._setDirty()}_getRootTiles(){const e=this.tilingScheme;return this._rootTileIds.map((t=>new op.Q(t[0],t[1],t[2],e)))}runTask(e){e=this._tests?nr.G5:e,this._dirty.value=!1,this._pendingTiles.value||(this._startUpdate(e),null!=this._frameWorker&&(this._frameWorker.priority=nr.T8.FEATURE_TILE_TREE_ACTIVE)),this._splitPendingTiles(e),this._pendingTiles.value||null==this._frameWorker||(this._frameWorker.priority=nr.T8.FEATURE_TILE_TREE)}_startUpdate(e){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();const{_measurements:t,_filterExtentRect:i,_newTiles:r}=this;t.setup(this.viewState.contentCamera,this.focus.location,this.cameraOnSurface.location.z??0),this._pendingTiles.value=this._getRootTiles().filter((e=>{if(t.update(e),e.measures.visible&&(!i||(0,H.kK)(e.extent,i))){if(e.measures.splitPriority>0)return!0;r.push(e)}return!1})).sort(Mm),this._newTiles.clear(),e.madeProgress()}_splitPendingTiles(e){const t=this._pendingTiles.value;if(!t)return;const{tilingScheme:i,_filterExtentRect:r,_newTiles:n,_measurements:s}=this;for(;t.length>0&&this._tileBudgetRatio<=2;){const a=t.pop();if(e.madeProgress(),a.measures.splitPriority>0){i.ensureMaxLod(a.level+1);const e=a.createChildren();for(const i of e)s.update(i),!i.measures.visible||r&&!(0,H.kK)(i.extent,r)||(i.measures.splitPriority>0?t.push(i):n.push(i));t.sort(Mm),this._mergeNewTiles(2),this._mergeNewTiles(2,!0)}else n.push(a);if(e.done)return}n.pushArray(t),this._pendingTiles.value=null,this._updateTiles(),n.clear(),s.done()}get _tileBudgetRatio(){return(this._newTiles.length+(this._pendingTiles.value?.length??0))/60}_mergeNewTiles(e,t=!1){if(this._tileBudgetRatio<=e)return;const{_newTiles:i,_measurements:r}=this;i.sort(((e,t)=>t.measures.distance-e.measures.distance));const n=new Map(i.map((e=>[e.id,e]))),s=i.length;for(const s of n.values()){const{lij:a,measures:o}=s;if(!o.mergeable||a[1]%2!=0||a[2]%2!=0||a[0]<=1||s.lodLevelDelta>=4)continue;const l=o.lodLevel;let c=l,h=!0;const u=n.get((0,op.J)(a[0],a[1]+1,a[2]));let d=Math.abs((u?.measures.lodLevel??0)-l),p=0===d||t&&u?.measures.mergeable&&d<=1;if(!u||!p)continue;c+=u.measures.lodLevel,h&&=0===d;const m=n.get((0,op.J)(a[0],a[1],a[2]+1));if(d=Math.abs((m?.measures.lodLevel??0)-l),p=0===d||t&&m?.measures.mergeable&&d<=1,!m||!p)continue;c+=m.measures.lodLevel,h&&=0===d;const f=n.get((0,op.J)(a[0],a[1]+1,a[2]+1));if(d=Math.abs((f?.measures.lodLevel??0)-l),p=0===d||t&&f?.measures.mergeable&&d<=1,!f||!p)continue;c+=f.measures.lodLevel,h&&=0===d,i.removeUnordered(s),i.removeUnordered(u),i.removeUnordered(m),i.removeUnordered(f),n.delete(s.id),n.delete(u.id),n.delete(m.id),n.delete(f.id);const _=new op.Q(a[0]-1,a[1]/2,a[2]/2,this.tilingScheme);if(r.update(_),_.measures.visible=!0,_.measures.lodLevel=c/4,_.measures.mergeable=h,i.push(_),n.set(_.id,_),this._tileBudgetRatio<=e)return}i.length<s&&this._mergeNewTiles(e,t)}_updateTiles(){this._mergeNewTiles(1),this._mergeNewTiles(1,!0);for(const e of this.tiles.items)e.used=!1;let e=!1;const t=this._newTiles.filter((t=>{const i=this._idToTile.get(t.id);return i?(e||=i.measures.lodLevel!==t.measures.lodLevel,i.measures={...t.measures},i.used=!0):this._idToTile.set(t.id,t),!i})),i=this.tiles.items.filter((e=>!e.used&&(this._idToTile.delete(e.id),!0)));this.tiles.removeMany(i),this.tiles.addMany(t),this._sortTiles(),!e||i.length||t.length||this.tiles.emit("change")}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort(((e,t)=>e.measures.distance-t.measures.distance)),this.tiles.forEach(((e,t)=>e.loadPriority=t))}};function Mm(e,t){return e.lodLevelDelta-t.lodLevelDelta||e.measures.splitPriority-t.measures.splitPriority||t.measures.distance-e.measures.distance}(0,r._)([(0,w.Cb)({constructOnly:!0})],Sm.prototype,"scheduler",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],Sm.prototype,"renderCoordsHelper",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],Sm.prototype,"tilingSchemeOwner",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],Sm.prototype,"cameraOnSurface",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],Sm.prototype,"focus",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],Sm.prototype,"viewState",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],Sm.prototype,"terrain",void 0),(0,r._)([(0,w.Cb)()],Sm.prototype,"tiles",void 0),(0,r._)([(0,w.Cb)()],Sm.prototype,"tileSize",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],Sm.prototype,"tilingScheme",null),(0,r._)([(0,w.Cb)()],Sm.prototype,"filterExtent",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Sm.prototype,"_filterExtentRect",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Sm.prototype,"_rootTileIds",null),(0,r._)([(0,w.Cb)({value:!1})],Sm.prototype,"suspended",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Sm.prototype,"updating",null),Sm=(0,r._)([(0,x.j)("esri.views.3d.layers.support.FeatureTileTree3D")],Sm);var Em=i(79860),Pm=i(65001);let Rm=class extends S.Z{constructor(e){super(e),this._propertiesPool=new Wc.L({camera:po.Z},this),this._lastSeenCameraProjectionValues=new po.Z,this.mode=$c.n.ANIMATING,this._cssCamera=new po.Z,this._camera=new po.Z,this.rasterPixelRatio=1,this.contentPixelRatio=1,this.constraints=new yi({state:this}),this.events=new ae.Z,this._cameraChanged=!1,this._updateQueue=new Array,this._processingUpdates=!1}reset(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new Wc.L({camera:po.Z},this)}destroy(){this.cameraController=null,this._propertiesPool?.destroy(),this._propertiesPool=null}createInitialCamera(){if(this.viewingMode===Ht.JY.Global){const e=(0,Ii.Iu)(this.spatialReference).radius;this.camera=new po.Z({eye:(0,R.al)(4*e,0,0),center:(0,R.al)(e,0,0),up:(0,R.al)(0,0,1)})}else this.camera=new po.Z({eye:(0,R.al)(0,0,100),center:(0,R.al)(0,0,0),up:(0,R.al)(0,1,0)})}get animation(){return this.cameraController instanceof uo&&null!=this.cameraController.viewAnimation?this.cameraController.viewAnimation:null}get cssCamera(){const e=this._cssCamera.copyFrom(this.camera),{height:t,width:i,pixelRatio:r}=this.camera;return e.pixelRatio=1,e.height=Math.round(t/r),e.width=Math.round(i/r),e}get camera(){return this._camera}set camera(e){e!==Om&&Om.copyFrom(e),Om.computeUp(this.viewingMode),this.events.emit("before-camera-change",{camera:Om});const t=this._camera;if(function(e,t){return e.fov!==t.fov||e.fullViewport[0]!==t.fullViewport[0]||e.fullViewport[1]!==t.fullViewport[1]||e.fullViewport[2]!==t.fullViewport[2]||e.fullViewport[3]!==t.fullViewport[3]||e.padding[Zc.Np.TOP]!==t.padding[Zc.Np.TOP]||e.padding[Zc.Np.RIGHT]!==t.padding[Zc.Np.RIGHT]||e.padding[Zc.Np.BOTTOM]!==t.padding[Zc.Np.BOTTOM]||e.padding[Zc.Np.LEFT]!==t.padding[Zc.Np.LEFT]}(this._lastSeenCameraProjectionValues,Om)&&(this._lastSeenCameraProjectionValues.copyFrom(Om),this.events.emit("camera-projection-changed",this._lastSeenCameraProjectionValues)),!t.equals(Om)&&(this._camera=this._propertiesPool.get("camera").copyFrom(Om),this._cameraChanged=!t.almostEquals(Om),this._cameraChanged)){const e=(0,Em.Fs)((()=>{this._cameraChanged=!1,e.remove()}))}}get pixelRatio(){return this.camera.pixelRatio}get alignPixelEnabled(){return this.pixelRatio===this.rasterPixelRatio&&this.mode===$c.n.IDLE}get updating(){return this.mode!==$c.n.IDLE}get contentCamera(){return this._contentCamera??this.camera}set contentCamera(e){if(null==e)return void(this._contentCamera=null);const t=e.clone();this.events.emit("before-camera-change",{camera:t,sceneDepthRange:Pm.P.infinite}),this._contentCamera=t}get fixedContentCamera(){return null!=this._contentCamera}get isGlobal(){return this.viewingMode===Ht.JY.Global}get isLocal(){return this.viewingMode===Ht.JY.Local}get viewingMode(){return(0,Ht.wg)(this.view.viewingMode)}get spatialReference(){return this.view.spatialReference}get highlights(){const e=this.view.highlights.items.slice(0,gt.Ke);for(let t=0;t<e.length;){const i=e[t],r=e.findIndex((e=>e.name===i.name));r>=0&&t>r?e.splice(t,1):++t}return e}get highlightOrderMap(){const e=new Map;return this.highlights.forEach(((t,i)=>e.set(t.name,i))),e}get navigating(){return!!this.cameraController?.isInteractive}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){this.stopActiveCameraController()?(this.cameraController?.destroy(),e&&(this.removeHandles(Dm),this.addHandles((0,_.gx)((()=>e.state===co.Finished||e.state===co.Stopped),(()=>{this._set("cameraController",null),this.updateCamera((t=>e.onControllerEnd(t)))}),{sync:!0,once:!0}),Dm),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=co.Rejected)}switchCameraController(e){this.cameraController=e}stopActiveCameraController(){return!this.cameraController||this.cameraController.stopController()}updateCamera(e){this._updateQueue.push(e),this._processUpdateQueue()}_processUpdateQueue(){if(0===this._updateQueue.length||this._processingUpdates)return;this._processingUpdates=!0;const e=this._updateQueue.shift();Om.copyFrom(this._get("camera")),e(Om),this.camera=Om,this._processingUpdates=!1,this._processUpdateQueue()}};(0,r._)([(0,w.Cb)({constructOnly:!0})],Rm.prototype,"view",void 0),(0,r._)([(0,w.Cb)()],Rm.prototype,"mode",void 0),(0,r._)([(0,w.Cb)({readOnly:!0,type:ni})],Rm.prototype,"animation",null),(0,r._)([(0,w.Cb)({type:po.Z})],Rm.prototype,"cssCamera",null),(0,r._)([(0,w.Cb)()],Rm.prototype,"_cssCamera",void 0),(0,r._)([(0,w.Cb)({type:po.Z})],Rm.prototype,"camera",null),(0,r._)([(0,w.Cb)()],Rm.prototype,"_camera",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],Rm.prototype,"pixelRatio",null),(0,r._)([(0,w.Cb)()],Rm.prototype,"rasterPixelRatio",void 0),(0,r._)([(0,w.Cb)()],Rm.prototype,"contentPixelRatio",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],Rm.prototype,"alignPixelEnabled",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Rm.prototype,"updating",null),(0,r._)([(0,w.Cb)({})],Rm.prototype,"_contentCamera",void 0),(0,r._)([(0,w.Cb)({type:po.Z})],Rm.prototype,"contentCamera",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Rm.prototype,"fixedContentCamera",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Rm.prototype,"events",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],Rm.prototype,"isGlobal",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Rm.prototype,"isLocal",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Rm.prototype,"viewingMode",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Rm.prototype,"highlights",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Rm.prototype,"highlightOrderMap",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Rm.prototype,"navigating",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Rm.prototype,"stationary",null),(0,r._)([(0,w.Cb)()],Rm.prototype,"_cameraChanged",void 0),(0,r._)([(0,w.Cb)()],Rm.prototype,"cameraController",null),Rm=(0,r._)([(0,x.j)("esri.views.3d.state.ViewState")],Rm);const Am=Rm;const Om=new po.Z,Dm="ViewStateHandles";var Im=i(51870),Lm=i(43759),Nm=i(61442),Fm=i(32033),Um=i(19821);function Hm(e){return(t,i,r)=>!(0,od.e)(e,(0,Pi.m)(km,t,i,r))}const km=(0,R.Ue)();class Vm{constructor(e,t,i){this.viewingMode=e,this._forEachLayer=t,this._view=i,this._externalIntersectionHandlers=new cd.Z,this._tolerance=mo.j,this._tmpRay=(0,Jn.Ue)(),this._tmpRegion=(0,H.Ue)(),this._validateHUDIntersector=new mo.r(this.viewingMode),this._validateHUDIntersector.options.hud=!1}intersectScreen(e,t,i){return this.intersectRay(this._getPickRay(e,this._tmpRay),Zm(this.viewingMode),t,i)}intersectScreenFreePointFallback(e,t,i){return this.intersectRayFreePointFallback(this._getPickRay(e,this._tmpRay),t,i)}intersectRayFreePointFallback(e,t,i){return this.intersectRay(e,Zm(this.viewingMode),t,i)||this._intersectRayFreePointLocal(e,t)}intersectRay(e,t,i,r){return t.options.selectionMode=!1,t.options.store=Nm.e.MIN,this.computeIntersection(e,t,!1,r),!!t.results.min&&t.results.min.getIntersectionPoint(i)}getCenterRayWithSubpixelOffset(e,t,i=.5,r=.5){return e.getRenderCenter(Ym,i,r),Ym[0]+=.0466,Ym[1]-=.0123,(0,Ao.eW)(e,Ym,t)}intersectIntersectorScreen(e,t,i){this.computeIntersection(this._getPickRay(e,this._tmpRay),t,!1,i)}intersectToolIntersectorScreen(e,t,i){const r=this._getPickRay(e,this._tmpRay);this.intersectToolIntersectorRay(r,t,i)}intersectToolIntersectorRay(e,t,i){t.options.selectionMode=!0,this.computeIntersection(e,t,!1,i);const r=t.results.min;this._view.basemapTerrain&&this._view.basemapTerrain.opaque||(0,Fm.n)(r)&&r.intersector!==Um.q.TERRAIN||(t.options.selectionMode=!1,this.computeIntersection(e,t,!1,i))}setTolerance(e=mo.j){this._tolerance=e}addIntersectionHandler(e){this._externalIntersectionHandlers.push(e),this._externalIntersectionHandlers.sort(((e,t)=>e.type===Um.q.TERRAIN?1:t.type===Um.q.TERRAIN?-1:0))}removeIntersectionHandler(e){null!=this._externalIntersectionHandlers.removeUnordered(e)&&this._externalIntersectionHandlers.sort(((e,t)=>e.type===Um.q.TERRAIN?1:t.type===Um.q.TERRAIN?-1:0))}_getPickRay(e,t){const i=this._view.state.camera;return(0,Ao.u4)(i,e,t)}_intersectRayFreePointLocal(e,t){return this.viewingMode!==Ht.JY.Local||null==e||(0,Pi.f)(t,e.origin,(0,Pi.n)(xo.WM.get(),e.direction)),!1}intersectElevationFromScreen(e,t,i=0,r=null){return this._intersectElevation(this._getPickRay(e,this._tmpRay),t,i,r)}_intersectElevation(e,t,i=0,r=null){if(null==e)return null;const n=this._view,{renderCoordsHelper:s}=n,a=(0,v._R)(n.spatialReference),o=null!=t?t.mode:"absolute-height",l=(0,Im.fm)(t)/a,c=("on-the-ground"!==o?l+i:0)*a/s.unitInMeters,{camera:h}=n.state;if("absolute-height"===o){const t=s?.getAltitude(h.eye),i=(0,Pi.e)((0,Pi.n)($m,e.direction),s.worldUpAtPosition(h.eye,Xm));if(t<c&&i<0||t>=c&&i>0)return null;if(s.intersectInfiniteManifold(e,c,$m)){const e=(0,Lm.K0)(n,$m);return e.z??=0,e.z-=l,e}return null}const u=(0,y.Wv)(xo.WM.get());h.projectToRenderScreen(e.origin,u);const d=new jm(null,this._forEachLayer),{slice:{plane:p}}=n,m=null!=p?Hm(p):null,f=new mo.r(this.viewingMode);f.options.store=Nm.e.MIN,f.options.verticalOffset=c,f.options.normalRequired=!1;const _=e.origin,g=(0,Pi.f)(xo.WM.get(),_,e.direction);f.reset(_,g,h),f.point=u;let b=null;if(r&&"type"in r&&"graphics"===r.type){const e=n.allLayerViews.find((e=>e.layer===r))?.uid;b=e?t=>t.layerViewUid===e:null}else r&&(b=e=>e.graphicUid!==r.uid);switch(o){case"relative-to-scene":{const e=e=>(!b||b(e))&&!!e.lastValidElevationBB;f.intersect(d.layers,u,this._tolerance,null,e),this._externalIntersectionHandlers.forAll((e=>{if(e.type===Um.q.I3S||e.type===Um.q.TERRAIN||e.type===Um.q.TILES3D){const t=e.slicePlaneEnabled?m:null;e.intersect(f,t,f.rayBegin,f.rayEnd,u,!1)}}));break}case"on-the-ground":case"relative-to-ground":this._externalIntersectionHandlers.forAll((e=>{if(e.isGround){const t=e.slicePlaneEnabled?m:null;e.intersect(f,t,f.rayBegin,f.rayEnd,u,!1)}}))}if(f.results.min.getIntersectionPoint($m)){const e=(0,Lm.K0)(n,$m);return e.z=i,e}return null}computeIntersection(e,t,i,r){if(null==e)return;const n=this._view.state.camera,s=(0,y.Wv)(xo.WM.get());n.projectToRenderScreen(e.origin,s);const a=new jm(r,this._forEachLayer);t.options.selectOpaqueTerrainOnly=!r||!("include"in r||"exclude"in r);const o=e.origin,l=(0,Pi.f)(xo.WM.get(),e.origin,e.direction);t.reset(o,l,n),t.intersect(a.layers,s,this._tolerance);const c=this._view.slice.plane,h=null!=c?Hm(c):null;t.intersect(a.sliceableLayers,s,this._tolerance,h);const u=r&&(r.requiresGroundFeedback||r.enableDraped);this._externalIntersectionHandlers.forAll((e=>{const r=e.layerViewUid,n=Array.isArray(r),c=n?r:[r];n&&(t.options.filteredLayerViewUids=[]);let d=!1;for(const e of c)a.filterLayerViewUid(e)?d=!0:n&&t.options.filteredLayerViewUids.push(e);if(t.options.isFiltered=!d,e.isGround&&u||!t.options.isFiltered){const r=e.slicePlaneEnabled?h:null;e.intersect(t,r,o,l,s,i)}}));const d=xo.WM.get(),p=this._view.basemapTerrain;if(r&&r.enableDraped&&null!=p.spatialReference&&t.results.ground.getIntersectionPoint(d)){const e=p.overlayManager.renderer,i=this._view.renderCoordsHelper.spatialReference,r=xo.WM.get();this._view.renderCoordsHelper.fromRenderCoords(d,r,p.spatialReference),r[2]=this._view.elevationProvider?.getElevation(d[0],d[1],d[2],i,"ground")??0,e.intersect(t,r,t.results.ground,(e=>a.filterRenderGeometry(e)))}t.sortResults(),this._processHUDResults(t)}_processHUDResults(e){const t=e.results.hud;(0,H.JG)(this._tmpRegion,H.G_);const i=this._view.state.camera,r=[],n=this._tmpRegion,s=e=>{const t=new Gm(e),s=t.result.target.object.geometries.every((e=>e.material instanceof Ld.A&&e.material.parameters.occlusionTest));r.push({item:t,occlusionTest:s}),s&&(i.projectToRenderScreen(e.target.center,t.screenPoint),t.screenPoint[0]=Math.floor(t.screenPoint[0]),t.screenPoint[1]=Math.floor(t.screenPoint[1]),(0,H.Ho)(n,t.screenPoint))};e.sortResults(t.all),null!=t.min.distance&&s(t.min);for(const e of t.all)t.min.target.object!==e.target.object&&t.max.target.object!==e.target.object&&s(e);if(null!=t.max.distance&&t.max.target.object!==t.min.target.object&&s(t.max),!r.length)return;n[0]===n[2]&&(n[2]+=1),n[1]===n[3]&&(n[3]+=1);const a=i.fullWidth,o=i.fullHeight,l=Math.max(0,n[0]-Bm),c=Math.max(0,n[1]-Bm),h=Math.min((0,H.d_)(n)+2*Bm,a-l),u=Math.min((0,H.Cb)(n)+2*Bm,o-c),d=h>0&&u>0?new Uint8Array(h*u*4):null;d&&this._view.stage.renderer.readHUDVisibility(l,c,h,u,d);let p=!0;const m=null==e.results.max.distance;let f=0;for(const{item:t,occlusionTest:i}of r){let r=!i;if(i&&d)for(const e of zm){const i=4*(Math.min(t.screenPoint[0]+e[0],a)-n[0]+(Math.min(t.screenPoint[1]+e[1],o)-n[1])*h);if(i>=0&&i<d.length&&d[i]){r=!0;break}}r&&(p&&(e.results.min.copy(t.result),p=!1),m&&e.results.max.copy(t.result),e.options.store===Nm.e.ALL&&e.results.all.splice(f++,0,t.result))}}}const Bm=1,zm=(()=>{const e=[],t=Bm;for(let i=-1;i<=t;i++)for(let r=-1;r<=t;r++)e.push([r+t,i+t]);return e})();class Gm{constructor(e){this.result=e,this.screenPoint=(0,y.J$)()}}let qm;function Zm(e){return qm&&qm.viewingMode===e||(qm=new mo.r(e)),qm}class jm{constructor(e,t){this.layers=new Array,this.sliceableLayers=new Array,this.include=e?.include,this.exclude=e?.exclude,t((e=>{e.pickable&&this.filterLayerViewUid(e.apiLayerViewUid)&&(e.sliceable?this.sliceableLayers:this.layers).push(e)}))}filterLayerViewUid(e){const{include:t,exclude:i}=this;return null==e?null==t&&null==i:(null==t||t.has(e))&&(null==i||!i.has(e))}filterRenderGeometry(e){return this.filterLayerViewUid(e.layerViewUid)}}function Wm(e){return"object"==typeof e&&"intersect"in e}const $m=(0,R.Ue)(),Xm=(0,R.Ue)(),Ym=(0,y.J$)();var Km=i(95964),Qm=i(71298);let Jm=class extends(ae.Z.EventedMixin(S.Z)){get spatialReference(){return this.view?.basemapTerrain?.spatialReference}constructor(e){super(e),this._im=new Array,this._ground=new Array,this._scene=new Array,this.lastElevationQuery=null,this._cacheEnabled=!1}destroy(){this._cachedQuery=(0,p.SC)(this._cachedQuery)}enableCache(e){e||(this.lastElevationQuery=null),this._cacheEnabled=e}getElevation(e,t,i,r,n){if(this._cacheEnabled&&null!=this.lastElevationQuery){const s=this.lastElevationQuery;if(e===s.x&&t===s.y&&i===s.z&&(0,Ee.fS)(r,s.spatialReference)&&n===s.queryContext)return s.result}let s=null;return s=ef(s,this._im,e,t,i,r,n),null==s&&(s=ef(s,this._ground,e,t,i,r,n)),"scene"===n&&(s=ef(s,this._scene,e,t,i,r,n)),this._cacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:i,spatialReference:r,queryContext:n,result:s}),s}getSphereElevationBounds(e,t,i){const r=new Qm.r;function n(n){for(const s of n)if(s.getSphereElevationBounds){const n=s.getSphereElevationBounds(e,t,i);null!=n&&r.expandElevationRangeValues(n.elevationRangeMin,n.elevationRangeMax)}}return n(this._ground),n(this._im),"scene"===i&&n(this._scene),r}getRootElevationBounds(){const e=new Qm.r;for(const t of[this._im,this._ground,this._scene])t.forEach((t=>{if(t.getRootElevationBounds){const i=t.getRootElevationBounds();null!=i&&e.expandElevationRangeValues(i.elevationRangeMin,i.elevationRangeMax)}}));return e}async queryElevation(e,t,i,r,n,s=null,a=0){const o=this._getElevationQuery(r);try{const l=await o.queryElevation(e,t,s,a);return"scene"===n?ef(l,this._scene,e,t,i,r,n):l}catch(s){return(0,f.r9)(s),this.getElevation(e,t,i,r,n)}}register(e,t){this.addHandles(t.on("elevation-change",(e=>this.emit("elevation-change",e))),t),this._providersFromContext(e).push(t)}unregister(e){this.removeHandles(e);for(const t of[this._im,this._ground,this._scene]){const i=t.indexOf(e);i>-1&&t.splice(i,1)}}_providersFromContext(e){switch(e){case"ground":return this._ground;case"im":return this._im;case"scene":return this._scene}}_getElevationQuery(e=this.view.spatialReference){const t=this._cachedQuery;if(null!=t&&(0,Ee.fS)(e,t.spatialReference))return t;t?.destroy({completeTasks:!0});const{wkid:i,wkt:r,wkt2:n,latestWkid:s}=e,a=new Km.K(this.view.resourceController.scheduler,new N.Z({wkid:i,wkt:r,wkt2:n,latestWkid:s}),(()=>this.view.map?.ground),{maximumAutoTileRequests:4});return this._cachedQuery=a,a}};function ef(e,t,i,r,n,s,a){for(const o of t){const t=o.getElevation(i,r,n,s,a);null!=t&&(e=null!=e?Math.max(t,e):t)}return e}(0,r._)([(0,w.Cb)({constructOnly:!0})],Jm.prototype,"view",void 0),(0,r._)([(0,w.Cb)()],Jm.prototype,"spatialReference",null),Jm=(0,r._)([(0,x.j)("esri.views.3d.support.CombinedElevationProvider")],Jm);class tf{static isValidProfile(e){return e in tf.profiles}static getDefaultProfile(){return(0,u.Z)("esri-iPhone")?"low":"medium"}static apply(e,t){const i=tf.profiles[e];t.graphics3D.maxTotalNumberOfFeatures=i.graphics3D.maxTotalNumberOfFeatures,t.graphics3D.maxNumberOfDrawCalls=i.graphics3D.maxNumberOfDrawCalls,t.graphics3D.maxTotalNumberOfVertices=i.graphics3D.maxTotalNumberOfVertices,t.graphics3D.polygonLodFactor=i.graphics3D.polygonLodFactor,t.graphics3D.polylineLodFactor=i.graphics3D.polylineLodFactor,t.graphics3D.snapshotAvailable=i.graphics3D.snapshotAvailable,t.graphics3D.skipHighSymbolLods=i.graphics3D.skipHighSymbolLods;const r=t.sceneService.object,n=i.sceneService.object;r.lodFactor=n.lodFactor,t.sceneService.point.lodFactor=i.sceneService.point.lodFactor,t.sceneService.integratedMesh.lodFactor=i.sceneService.integratedMesh.lodFactor,t.sceneService.pointCloud.lodFactor=i.sceneService.pointCloud.lodFactor,t.tiledSurface.lodBias=i.tiledSurface.lodBias,t.tiledSurface.angledSplitBias=i.tiledSurface.angledSplitBias,t.tiledSurface.vtlContentZoom=i.tiledSurface.vtlContentZoom,t.tiledSurface.elevationLevelDelta=i.tiledSurface.elevationLevelDelta,t.tiledSurface.reduceTileLevelDifferences=i.tiledSurface.reduceTileLevelDifferences,t.heatmap.pixelRatio=i.heatmap.pixelRatio,t.heatmap.maxTotalNumberOfFeatures=i.heatmap.maxTotalNumberOfFeatures,t.fadeDuration=i.fadeDuration,t.antialiasingEnabled=i.antialiasingEnabled,t.physicallyBasedRenderingEnabled=i.physicalBasedRenderingEnabled,t.highQualityTransparency=i.highQualityTransparency,t.highResolutionAtmosphere=i.highResolutionAtmosphere,t.reflections=i.reflections,t.ambientOcclusion=i.ambientOcclusion,t.maxTexturePixels=i.maxTexturePixels,t.memoryLimit=i.memoryLimit,t.additionalCacheMemory=i.additionalCacheMemory,t.frameRate=i.frameRate,t.maximumPixelRatio=i.maximumPixelRatio}static{this.test={reset(){const e=lf();for(const t of Object.keys(e))tf.profiles[t]=e[t]}}}}const rf=120,nf=200,sf=240,af=300,of=430;function lf(){const e=!!(0,u.Z)("esri-mobile"),t=!!(0,u.Z)("ios"),i=(0,ur.HA)(400);return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxNumberOfDrawCalls:8e3,maxTotalNumberOfVertices:255e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1,skipHighSymbolLods:!0},heatmap:{pixelRatio:.125,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:.2},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5}},tiledSurface:{lodBias:-1,angledSplitBias:.5,vtlContentZoom:.75,elevationLevelDelta:3,reduceTileLevelDifferences:!0},fadeDuration:(0,ur.HA)(0),antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,maxTexturePixels:e?1048576:4194304,memoryLimit:200+rf,additionalCacheMemory:0,frameRate:0,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:625e4,polygonLodFactor:e?.8:1,polylineLodFactor:e?1.2:1.5,snapshotAvailable:!t,skipHighSymbolLods:!1},heatmap:{pixelRatio:.25,maxTotalNumberOfFeatures:13e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1}},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,elevationLevelDelta:3,reduceTileLevelDifferences:!(0,u.Z)("disable-feature:reduce-map-tile-levels")},fadeDuration:i,antialiasingEnabled:!1,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,maxTexturePixels:e?4194304:4096**2,memoryLimit:e?600+nf:750+sf,additionalCacheMemory:e?-100:150,frameRate:0,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:125e5,polygonLodFactor:e?1.2:2,polylineLodFactor:e?1.2:2,snapshotAvailable:!t,skipHighSymbolLods:!1},heatmap:{pixelRatio:.5,maxTotalNumberOfFeatures:23e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1}},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,elevationLevelDelta:2,reduceTileLevelDifferences:!(0,u.Z)("disable-feature:reduce-map-tile-levels")},fadeDuration:i,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!0,reflections:!0,ambientOcclusion:!0,maxTexturePixels:e?4096**2:1/0,memoryLimit:e?900+af:1500+of,additionalCacheMemory:e?-150:0,frameRate:0,maximumPixelRatio:e?1:1/0}}}!function(e){e.profiles=lf()}(tf||(tf={}));const cf=tf;var hf;!function(e){e[e.ELEVATION=0]="ELEVATION",e[e.MAP=1]="MAP"}(hf||(hf={}));const uf=[hf.ELEVATION,hf.MAP];var df=i(22455);async function pf(e,t){const{results:i,ground:r}=await(0,df.ZV)(e,t),n=(!r.layer||!(0,B.nx)(r.layer.type))&&r.mapPoint,s=[],a=function(e){const t=new Map;for(const i of e.allLayerViews){const e=i.layer.uid;t.set(e,i)}return t}(e),o=n?function(e,t){const i=new Set,r=new Set;for(let t=e.basemapTerrain.numLayers(hf.MAP)-1;t>=0;t--){const n=e.basemapTerrain.layerViewByIndex(t,hf.MAP);i.add(n.layer.uid),r.add(n)}const n=e.basemapTerrain.overlayManager.renderer.layers;for(const{uid:e}of n){const n=t.get(e);n&&(i.add(e),r.add(n))}return{layerUids:i,layerViews:Array.from(r).reverse()}}(e,a):mf;let l=0,c=0;const h=()=>{const e=o.layerViews[c];n&&e&&"fetchPopupFeaturesAtLocation"in e&&s.push({mapPoint:r.mapPoint,layerView:e}),++c};let u=null;for(;l<i.length||c<o.layerViews.length;){const t=i[l];if(t&&"graphic"!==t.type)++l;else if("scene"!==t?.layer?.type||t?.layer?.parent!==e?.map?.basemap)if(t){const e=t.layer?.uid,i=o.layerUids.has(e)&&t.distance===r.distance,n=a.get(t.layer?.uid);if(u??=t.mapPoint,c<o.layerViews.length&&(i||(t.distance??0)>r.distance)&&o.layerViews[c]!==n){h();continue}s.push({graphic:t.graphic,layerView:n}),++l}else h();else++l}return u??=r.mapPoint,{hits:s,location:u}}const mf={layerUids:new Set,layerViews:[]};let ff=class extends S.Z{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxNumberOfDrawCalls=17e3,this.maxTotalNumberOfVertices=17e5,this.snapshotAvailable=!0,this.polygonLodFactor=1,this.polylineLodFactor=1,this.skipHighSymbolLods=!1}};(0,r._)([(0,w.Cb)()],ff.prototype,"minTotalNumberOfFeatures",void 0),(0,r._)([(0,w.Cb)()],ff.prototype,"maxTotalNumberOfFeatures",void 0),(0,r._)([(0,w.Cb)()],ff.prototype,"maxNumberOfDrawCalls",void 0),(0,r._)([(0,w.Cb)()],ff.prototype,"maxTotalNumberOfVertices",void 0),(0,r._)([(0,w.Cb)()],ff.prototype,"snapshotAvailable",void 0),(0,r._)([(0,w.Cb)()],ff.prototype,"polygonLodFactor",void 0),(0,r._)([(0,w.Cb)()],ff.prototype,"polylineLodFactor",void 0),(0,r._)([(0,w.Cb)()],ff.prototype,"skipHighSymbolLods",void 0),ff=(0,r._)([(0,x.j)("esri.views.3d.support.QualitySettings.Graphics3DSettings")],ff);let _f=class extends S.Z{constructor(){super(...arguments),this.lodFactor=1}};(0,r._)([(0,w.Cb)()],_f.prototype,"lodFactor",void 0),_f=(0,r._)([(0,x.j)("esri.views.3d.support.QualitySettings.LoDFactorSettings")],_f);let gf=class extends S.Z{constructor(){super(...arguments),this.object=new _f,this.point=new _f,this.integratedMesh=new _f,this.pointCloud=new _f}};(0,r._)([(0,w.Cb)({type:_f})],gf.prototype,"object",void 0),(0,r._)([(0,w.Cb)({type:_f})],gf.prototype,"point",void 0),(0,r._)([(0,w.Cb)({type:_f})],gf.prototype,"integratedMesh",void 0),(0,r._)([(0,w.Cb)({type:_f})],gf.prototype,"pointCloud",void 0),gf=(0,r._)([(0,x.j)("esri.views.3d.support.QualitySettings.SceneServiceSettings")],gf);let yf=class extends S.Z{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.vtlContentZoom=1,this.elevationLevelDelta=3,this.reduceTileLevelDifferences=!0}};(0,r._)([(0,w.Cb)()],yf.prototype,"lodBias",void 0),(0,r._)([(0,w.Cb)()],yf.prototype,"angledSplitBias",void 0),(0,r._)([(0,w.Cb)()],yf.prototype,"vtlContentZoom",void 0),(0,r._)([(0,w.Cb)()],yf.prototype,"elevationLevelDelta",void 0),(0,r._)([(0,w.Cb)()],yf.prototype,"reduceTileLevelDifferences",void 0),yf=(0,r._)([(0,x.j)("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],yf);let vf=class extends S.Z{constructor(){super(...arguments),this.pixelRatio=1,this.maxTotalNumberOfFeatures=5e4}};(0,r._)([(0,w.Cb)()],vf.prototype,"pixelRatio",void 0),(0,r._)([(0,w.Cb)()],vf.prototype,"maxTotalNumberOfFeatures",void 0),vf=(0,r._)([(0,x.j)("esri.views.3d.support.QualitySettings.HeatmapSettings")],vf);let bf=class extends S.Z{constructor(){super(...arguments),this.graphics3D=new ff,this.sceneService=new gf,this.tiledSurface=new yf,this.heatmap=new vf,this.fadeDuration=(0,ur.HA)(400),this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0,this.highResolutionAtmosphere=!1,this.reflections=!1,this.ambientOcclusion=!1,this.bloom=!1,this.maxTexturePixels=1/0,this.memoryLimit=750,this.additionalCacheMemory=0,this.frameRate=void 0,this.maximumPixelRatio=1/0}};(0,r._)([(0,w.Cb)({type:ff})],bf.prototype,"graphics3D",void 0),(0,r._)([(0,w.Cb)({type:gf})],bf.prototype,"sceneService",void 0),(0,r._)([(0,w.Cb)({type:yf})],bf.prototype,"tiledSurface",void 0),(0,r._)([(0,w.Cb)({type:vf})],bf.prototype,"heatmap",void 0),(0,r._)([(0,w.Cb)()],bf.prototype,"fadeDuration",void 0),(0,r._)([(0,w.Cb)()],bf.prototype,"antialiasingEnabled",void 0),(0,r._)([(0,w.Cb)()],bf.prototype,"physicallyBasedRenderingEnabled",void 0),(0,r._)([(0,w.Cb)()],bf.prototype,"highQualityTransparency",void 0),(0,r._)([(0,w.Cb)()],bf.prototype,"highResolutionAtmosphere",void 0),(0,r._)([(0,w.Cb)()],bf.prototype,"reflections",void 0),(0,r._)([(0,w.Cb)()],bf.prototype,"ambientOcclusion",void 0),(0,r._)([(0,w.Cb)()],bf.prototype,"bloom",void 0),(0,r._)([(0,w.Cb)()],bf.prototype,"maxTexturePixels",void 0),(0,r._)([(0,w.Cb)()],bf.prototype,"memoryLimit",void 0),(0,r._)([(0,w.Cb)()],bf.prototype,"additionalCacheMemory",void 0),(0,r._)([(0,w.Cb)()],bf.prototype,"frameRate",void 0),(0,r._)([(0,w.Cb)()],bf.prototype,"maximumPixelRatio",void 0),bf=(0,r._)([(0,x.j)("esri.views.3d.support.QualitySettings")],bf);const wf=bf;var Cf=i(32243),xf=i(88270),Tf=i(48621),Sf=i(78619),Mf=i(61719);class Ef{constructor(e){this.client=e,this._cancelled=!1,this.size=0,this.duration=0}}class Pf{constructor(e){this.typeWorkerQuota=e,this.tasks=new Array,this.numWorkers=0,this.statistics=new Rf}}class Rf{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}}class Af{constructor(e,t,i,r){this._workerFunc=e,this._callbackFunc=t,this._maxTotalNumWorkers=i,this._totalNumWorkers=0,this._clients=r.map((e=>new Pf(e)))}destroy(){this._clients.length=0}hasQuota(e){const t=this._clients[e];return!!t&&(this._totalNumWorkers<this._maxTotalNumWorkers||t.numWorkers+t.tasks.length<t.typeWorkerQuota)}push(e){const t=this._clients[e.client];t&&(this._totalNumWorkers<this._maxTotalNumWorkers?(t.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,((e,t)=>this._taskCallback(e,t)))):t.tasks.push(e))}cancel(e){this._taskFinished(e),e._cancelled=!0}_taskFinished(e){const t=this._clients[e.client];this._totalNumWorkers--,t&&(t.numWorkers--,t.statistics.requests++,t.statistics.size+=e.size||0,t.statistics.duration+=e.duration||0,t.statistics.speed=t.statistics.duration>0?t.statistics.size/t.statistics.duration:0,(0,Mf.hu)(t.numWorkers>=0)),this._next()}_next(){for(const e of this._clients)if(e&&e.numWorkers<e.typeWorkerQuota&&this._processQueue(e))return;for(const e of this._clients)if(e&&this._processQueue(e))return}_processQueue(e){for(;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),((e,t)=>this._taskCallback(e,t))))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(e,t){e._cancelled||(this._callbackFunc(e,t),this._taskFinished(e))}getStatsForType(e){const t=this._clients[e];return t?{quota:t.typeWorkerQuota,workers:t.numWorkers,queueSize:t.tasks.length,requestStats:t.statistics}:null}get test(){}}class Of{constructor(e,t){this.element=e,this.type="image+type",this.isOpaque="image/jpeg"===t}}var Df=i(74796);let If=class extends S.Z{constructor(){super(...arguments),this._tasks=new Map,this._onLoadQueue=new Array,this._doneQueue=new Array,this.updating=!1}setup(e,t,i){this._loadQueue=new Af(((e,t)=>this._startLoading(e,t)),((e,t)=>this._doneLoadingCB(e,t)),e,t),i&&(this._frameTask=i.registerTask(nr.T8.STREAM_DATA_LOADER,this))}destroy(){this._frameTask=(0,p.hw)(this._frameTask),this._tasks.forEach((e=>(0,p.IM)(e.abortController))),this._loadQueue=(0,p.SC)(this._loadQueue),this._onLoadQueue=null,this._doneQueue=null,this._tasks=null}hasDownloadSlots(e){return this._loadQueue.hasQuota(e)}request(e,t,i,r={}){const n=(0,f.hh)();n.__signal=null!=r?r.signal:null;const s=this._createOrUpdateTask(e,t,i,r,n);return(0,f.fu)(r,(()=>this._cancelRequest(s,n))),n.promise}_createTask(e,t,i,r,n,s){const a=new Nf(e,t,i,r,n);return this._updateTask(a,s),this._tasks.set(n,a),1===this._tasks.size&&this._set("updating",!0),this._loadQueue.push(a),a}_cancelRequest(e,t){(0,Fe.e$)(e.resolvers,t),t.reject((0,f.zE)()),0===e.resolvers.length&&(e.status===Ff.DOWNLOADING&&(e.status=Ff.CANCELLED,this._loadQueue.cancel(e),e.abortController?.abort(),e.request=null,e.abortController=null),e.status=Ff.CANCELLED,this._tasks.delete(e.key),0===this._tasks.size&&this._set("updating",!1))}_updateTask(e,t){e.resolvers.push(t)}_createOrUpdateTask(e,t,i,r,n){const s=function(e,t,i){return`${e}:${t}:${i}`}(r?.uid||e,t,i),a=this._tasks.get(s);return a?(this._updateTask(a,n),a):this._createTask(e,r,t,i,s,n)}_doneLoadingCB(e,t){this._loadQueue&&((0,Mf.hu)(e.status===Ff.DOWNLOADING),e.status=Ff.DOWNLOADED,this._frameTask?this._doneQueue.push({task:e,err:t}):this._doneLoading(e,t))}get running(){return this._doneQueue.length>0||this._onLoadQueue.length>0}runTask(e){for(;!e.done&&this._onLoadQueue.length>0;){const t=this._onLoadQueue.shift();(0,f.k_)(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this._doneQueue.length>0;){const t=this._doneQueue.shift();t.task.status!==Ff.DOWNLOADED&&(t.err=t.err||(0,f.zE)()),this._doneLoading(t.task,t.err),e.madeProgress()}}_doneLoading(e,t){if(t&&!(0,f.D_)(t)&&e.numRetries>0)return--e.numRetries,void this._loadQueue.push(e);let i=(0,Df.Cm)(e.result)||e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const r of e.resolvers)if(t)(0,f.D_)(t)?r.reject(t):r.reject(new l.Z("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${t}`,{url:e.url,error:t}));else{--i;const t=i>0?(0,Sn.d9)(e.result):e.result;r.resolve(t)}this._tasks.delete(e.key),0===this._tasks.size&&this._set("updating",!1)}_startLoading(e,t){if(e.status===Ff.CANCELLED)return!1;let i,r;switch(e.startTime=performance.now(),e.status=Ff.DOWNLOADING,e.docType){case"binary":r="array-buffer",i=0;break;case"image":r="image";break;case"image+type":r="array-buffer";break;default:r="json"}e.abortController=new AbortController;const n=e.abortController.signal;e.request=(0,Sf.Z)(e.url,{...e.options,responseType:r,timeout:i,signal:n});const s=i=>{e.duration=performance.now()-e.startTime,e.size=i instanceof ArrayBuffer?i.byteLength:e.size||0,e.result=i,this._frameTask?this._onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},a=i=>{e.status===Ff.DOWNLOADING&&t(e,i)};return"image+type"!==e.docType?(e.request.then((e=>s(e.data)),a),!0):(e.request.then((t=>{const o=t.data,l=function(e){if(e.byteLength<2)return"unknown";const t=new Uint8Array(e,0,e.byteLength);return 137===t[0]&&80===t[1]?"image/png":71===t[0]&&73===t[1]?"image/gif":66===t[0]&&77===t[1]?"image/bmp":255===t[0]&&216===t[1]?"image/jpeg":"unknown"}(o);if(r="image",e.size=o.byteLength,"unknown"===l)return e.request=(0,Sf.Z)(e.url,{responseType:r,timeout:i,signal:n}),void e.request.then((e=>s(e.data)),a);const c=new Blob([o],{type:l}),h=window.URL.createObjectURL(c);e.request=(0,Sf.Z)(h,{responseType:r,timeout:i,signal:n}),e.request.then((e=>s(new Of(e.data,l))),a).finally((()=>window.URL.revokeObjectURL(h)))}),a),!0)}get test(){}};(0,r._)([(0,w.Cb)({readOnly:!0})],If.prototype,"updating",void 0),If=(0,r._)([(0,x.j)("esri.views.3d.support.StreamDataLoader")],If);const Lf=0;class Nf extends Ef{constructor(e,t,i,r,n){super(r),this.url=e,this.options=t,this.docType=i,this.key=n,this.result=null,this.status=Ff.QUEUED,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0,this.numRetries=Lf}}var Ff;!function(e){e[e.QUEUED=1]="QUEUED",e[e.DOWNLOADING=2]="DOWNLOADING",e[e.DOWNLOADED=3]="DOWNLOADED",e[e.CANCELLED=4]="CANCELLED"}(Ff||(Ff={}));let Uf=class extends S.Z{constructor(){super(...arguments),this.updating=!1}};(0,r._)([(0,w.Cb)({readOnly:!0})],Uf.prototype,"updating",void 0),Uf=(0,r._)([(0,x.j)("esri.views.3d.support.ResourceController.ResourceControllerMain")],Uf);let Hf=class extends Uf{constructor(){super(...arguments),this._immediateTask=nr.sq,this._normalTask=nr.sq,this._updatingObjects=(0,Di.t)([]),this._frameTask=null}get immediate(){return this._immediateTask}get normal(){return this._normalTask}initialize(){this._scheduler=(0,nr.z4)(),this._memoryController=(0,Tf.c)(this.view),this._streamDataLoader=new If,this._streamDataLoader.setup(xf.NT,xf.Ty,this._scheduler),this.addHandles([(0,_.YP)((()=>this.view.state?.mode),(e=>{null!=e&&(this._scheduler.state=e)}),_.Z_),(0,_.YP)((()=>this.view.stationary),(()=>this._stationaryChangedHandler()))]),this._frameTask=(0,g.A)({update:e=>this._frame(e)}),this._immediateTask=this._scheduler.registerTask(nr.T8.RESOURCE_CONTROLLER_IMMEDIATE),this._normalTask=this._scheduler.registerTask(nr.T8.RESOURCE_CONTROLLER)}destroy(){this._immediateTask.remove(),this._normalTask.remove(),this._frameTask=(0,p.hw)(this._frameTask),this._streamDataLoader=(0,p.SC)(this._streamDataLoader),this._memoryController=(0,p.SC)(this._memoryController),this._scheduler=(0,p.SC)(this._scheduler),this.view=null}get updating(){return!!(this._memoryController?.updating||this._streamDataLoader?.updating||this._immediateTask?.updating)||this._updatingObjects?.value.some((e=>e.updating))}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}createStreamDataRequester(e){const t=this._streamDataLoader;return{request:(i,r,n)=>t.request(i,r,e,n),get busy(){return!t.hasDownloadSlots(e)}}}addUpdatingObject(e){const t=this._updatingObjects;return t.value=[...t.value,e],(0,h.kB)((()=>{t.value=t.value.filter((t=>t!==e))}))}_frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step((0,ur.D9)(e.deltaTime)),!this._scheduler)||(this._memoryController.update(),this._scheduler.frame(e))}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}get test(){}};(0,r._)([(0,w.Cb)()],Hf.prototype,"view",void 0),(0,r._)([(0,w.Cb)()],Hf.prototype,"_scheduler",void 0),(0,r._)([(0,w.Cb)()],Hf.prototype,"_memoryController",void 0),(0,r._)([(0,w.Cb)()],Hf.prototype,"_streamDataLoader",void 0),(0,r._)([(0,w.Cb)()],Hf.prototype,"_immediateTask",void 0),(0,r._)([(0,w.Cb)()],Hf.prototype,"_normalTask",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],Hf.prototype,"updating",null),Hf=(0,r._)([(0,x.j)("esri.views.3d.support.ResourceController")],Hf);var kf=i(46965),Vf=i(15165);class Bf{constructor(e){this.layer=null,this.memory=0,this.displayedNumberOfFeatures=0,this.maximumNumberOfFeatures=null,this.totalNumberOfFeatures=null,this.layer=e.layer;const t=e.performanceInfo;this.memory=t.usedMemory,this.displayedNumberOfFeatures=t.displayedFeatures,this.maximumNumberOfFeatures=t.maximumFeatures,this.totalNumberOfFeatures=t.totalFeatures}}class zf{constructor(e){if(this.totalMemory=0,this.usedMemory=0,this.quality=1,this.load=0,this.terrainMemory=0,this.edgesMemory=0,this.layerPerformanceInfos=new Array,this.cachedMemory=0,this.fboMemory=0,null!=e.resourceController){const t=e.resourceController.memoryController;this.totalMemory=(t.maxMemory??0)*kf.Y.MEGABYTES,this.usedMemory=Math.round(t.usedMemory*this.totalMemory),this.quality=e.quality,this.load=e.resourceController.scheduler.load,this.cachedMemory=t.usedCacheMemory}this.terrainMemory=e.basemapTerrain?.usedMemory??0,this.edgesMemory=e.stage?.renderer.usedMemory.edges??0,this.fboMemory=e.stage?.renderer.usedMemory.fbos??0,e.allLayerViews?.items.forEach((e=>{(0,Vf.l)(e)&&this.layerPerformanceInfos.push(new Bf(e))})),this.layerPerformanceInfos.sort(((e,t)=>t.memory-e.memory))}}var Gf=i(95631),qf=i(58744);class Zf{constructor(e){this._gltfLoading=new Map,this._wosrLoading=new Map,this._gltfMemCache=e("gltf-resources",(()=>{})),this._wosrMemCache=e("wosr-resources",(()=>{}))}destroy(){this._gltfLoading.forEach((e=>e.abortController.abort())),this._wosrLoading.forEach((e=>e.abortController.abort())),this._gltfMemCache.destroy(),this._wosrMemCache.destroy()}loadGLTF(e,t,r){const n=r?`gltfPBR:${e}`:`gltf:${e}`,s=this._gltfMemCache.get(n);return null!=s?Promise.resolve(s):jf(this._gltfLoading,this._gltfMemCache,n,(async t=>{const{loadGLTF:n}=await Promise.all([i.e(50022),i.e(917)]).then(i.bind(i,50022));return n(new Gf.C(t.streamDataRequester),e,t,r)}),t)}loadWOSR(e,t){const i=`wosr:${e}:${t.disableTextures}`,r=this._wosrMemCache.get(i);return null!=r?Promise.resolve(r):jf(this._wosrLoading,this._wosrMemCache,i,(t=>(0,qf.zD)(e,t)),t)}}async function jf(e,t,i,r,n){(0,f.k_)(n);const s=(0,f.fu)(n,(()=>function(e,t){const i=e.get(t);if(null!=i&&--i.refCount>0)return;e.delete(t),null!=i&&i.abortController.abort()}(e,i)));let a=e.get(i);if(a)a.refCount++;else{const t=new AbortController;a={refCount:1,abortController:t,promise:r({...n,signal:t.signal})},e.set(i,a)}try{const r=await a.promise;return t.put(i,r),e.delete(i),(0,f.k_)(n),r}finally{(0,p.hw)(s)}}var Wf=i(95490);let $f=class extends S.Z{constructor(e,t){super({}),this._stage=e,this._textureRequests=new Map,this._frameTask=t?.registerTask(nr.T8.TEXTURE_UNLOAD)??nr.sq}normalizeCtorArgs(){return{}}destroy(){super.destroy(),this._frameTask?.remove(),this._textureRequests?.forEach((e=>this._releaseTextureRequest(e))),this._textureRequests?.clear()}get updating(){return this._frameTask.updating}fromData(e,t){const i=this.makeUid(e);let r=this._textureRequests.get(i);if(!r){const e=new Yf;e.texture=t(),this._stage&&(e.texture.load(this._stage.renderView.renderingContext),this._stage.addTexture(e.texture)),this._textureRequests.set(i,e),r=e}return r.referenceCount++,new Xf(i,r.texture,(()=>this._release(i)))}_release(e){const t=this._textureRequests.get(e);t?(t.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),t.referenceCount--,t.referenceCount<1&&this._frameTask.schedule((()=>this._releaseNow(e)))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`)}get test(){}_releaseNow(e){if(!this._textureRequests)return;const t=this._textureRequests.get(e);!t||t.referenceCount>0||(t.texture?.unload(),this._releaseTextureRequest(t),this._textureRequests.delete(e))}_releaseTextureRequest(e){e.texture?this._stage?.removeTexture(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}makeUid(e,t=null){return null!=t?`${e}.${t}px`:e}};(0,r._)([(0,w.Cb)()],$f.prototype,"_frameTask",void 0),(0,r._)([(0,w.Cb)()],$f.prototype,"updating",null),$f=(0,r._)([(0,x.j)("esri.views.3d.support.TextureCollection")],$f);class Xf{constructor(e,t,i){this.uid=e,this.texture=t,this.release=i}}class Yf{constructor(){this.referenceCount=0}}var Kf=i(28751);class Qf extends $f{constructor(e,t,i){super(t,i),this._streamDataRequester=e}async fromUrl(e,t,i){(0,f.k_)(i);const r=i?.signal,n=this.makeUid(e,t);let s=this._textureRequests.get(n);if(!s){const i=new AbortController,r=this._streamDataRequester.request(e,"image",{uid:n,signal:i.signal});s=new Yf,s.abortController=i;const a=s;this._textureRequests.set(n,s),s.textureAsync=r.then((async i=>{const r=this._createTexture(e,i,t);return a.texture=r,a.abortController=null,await r.load(this._stage.renderView.renderingContext),this._stage.addTexture(r),new Xf(n,r,(()=>this._release(n)))}),(e=>{throw a.abortController=null,e}))}s.referenceCount++;try{return await(0,f.Hl)(s.textureAsync,r)}catch(e){throw this._release(n),e}}_createTexture(e,t,i){const r={width:t.width,height:t.height,wrap:{s:$i.e8.CLAMP_TO_EDGE,t:$i.e8.CLAMP_TO_EDGE},preMultiplyAlpha:!0,reloadable:!0};if((0,Wf.zd)(e)){if(i||0===t.width&&0===t.height){const e=t.width?t.height/t.width:1;i=i||64,e>1?(t.width=Math.round(i/e),t.height=i):(t.width=i,t.height=Math.round(i*e))}this._stage.renderView?.renderingContext.driverTest.svgPremultipliesAlpha.result&&(r.preMultiplyAlpha=!1)}return new Kf.x(t,r)}}class Jf{constructor(e){this.streamDataRequester=null,this._graphicsOwners=[],this._screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this._viewState=e.viewState,this._view=e.view,this._pointsOfInterest=e.pointsOfInterest,this.streamDataRequester=e.resourceController.createStreamDataRequester(xf.Bh.SYMBOLOGY),this.objectResourceCache=new Zf(((t,i)=>e.resourceController.memoryController.newCache(t,i))),this.textures=new Qf(this.streamDataRequester,e.view.stage,e.resourceController.scheduler);const t=(0,Ii.Iu)(this._view.spatialReference).radius;this.screenSizePerspectiveSettings=(0,Id.Gw)(e.viewingMode,t),this.screenSizePerspectiveSettingsLabels=(0,Id.n9)(e.viewingMode,t)}destroy(){this.textures.destroy(),this.streamDataRequester=null}addGraphicsOwner(e){if(!e)return(0,h.kB)();this._graphicsOwners.push(e);const t=(0,_.YP)((()=>e.layer?.screenSizePerspectiveEnabled),(()=>this._updateScreenSizePerspectiveEnabled()));return this._updateScreenSizePerspectiveEnabled(),(0,h.kB)((()=>{t.remove(),(0,Fe.e$)(this._graphicsOwners,e),this._updateScreenSizePerspectiveEnabled()}))}_updateScreenSizePerspectiveEnabled(){const e=this._graphicsOwners.some((e=>!0===e.layer?.screenSizePerspectiveEnabled));if(e&&!this._screenSizePerspectiveHandles){this._screenSizePerspectiveHandles=new Te.Z;const e=()=>this._updateScreenSizePerspectiveSettings();this._screenSizePerspectiveHandles.add([(0,_.YP)((()=>this._pointsOfInterest.centerOnSurfaceInfrequent.distance),e,_.Z_),this._viewState.events.on("camera-projection-changed",e)]),this._updateScreenSizePerspectiveSettings()}else e||(this._screenSizePerspectiveHandles=(0,p.SC)(this._screenSizePerspectiveHandles))}_updateScreenSizePerspectiveSettings(){const e=this._pointsOfInterest;e_.distance=e.centerOnSurfaceInfrequent.distance,e_.fovY=this._viewState.camera.fovY,this.screenSizePerspectiveSettings.update(e_),this.screenSizePerspectiveSettingsLabels.update(e_),this._view.stage.renderView.requestRender()}get test(){}}const e_={distance:0,fovY:0};let t_=class extends S.Z{constructor(){super(),this._propertiesPool=new Wc.L({plane:od.B},this),this.isDecoration=!0,this.addHandles((0,h.ed)(this._propertiesPool))}set plane(e){if(!e)return void this._set("plane",e);const t=this._propertiesPool.get("plane");(0,od.a)(e,t),this._set("plane",t)}};(0,r._)([(0,w.Cb)()],t_.prototype,"plane",null),(0,r._)([(0,w.Cb)()],t_.prototype,"isDecoration",void 0),t_=(0,r._)([(0,x.j)("esri.views.3d.support.ViewSlice")],t_);i(62197);var i_=i(38365),r_=(i(90901),i(75777),i(9726)),n_=i(37500);class s_{constructor(e){this.destination=e}hide(){null!=this.graphic&&(this.destination.remove(this.graphic),this.graphic=null)}}class a_ extends s_{constructor(e,t,i=""){super(e),this._symbol=new r_.Z({symbolLayers:new a.Z([new i_.Z({material:{color:t},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new n_.Z({text:i,halo:{color:"white",size:1/.75},material:{color:t},size:12})])})}show(e,t){if(!t)return;this.hide();const i=new I.Z({x:e[0],y:e[1],z:e[2],spatialReference:t});this.graphic=new cc.Z({geometry:i,symbol:this._symbol}),this.destination.add(this.graphic)}}let o_=class extends S.Z{constructor(e){super(e)}};(0,r._)([(0,w.Cb)({constructOnly:!0})],o_.prototype,"renderCoordsHelper",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],o_.prototype,"surface",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],o_.prototype,"state",void 0),o_=(0,r._)([(0,x.j)("esri.views.3d.support.pointsOfInterest.PointOfInterest")],o_);const l_=Array;let c_=class extends o_{constructor(e){super(e),this._dirty=!1,this._propertiesPool=new Wc.L({location:I.Z,renderLocation:l_},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.renderLocation=(0,R.Ue)(),this._tmpPoint=new I.Z}initialize(){if(this.scheduler&&this.addHandles(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const e=()=>this._setDirty();this.addHandles((0,_.on)((()=>this.map?.ground?.layers),"change",e,{onListenerAdd:e,onListenerRemove:e}))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool=(0,p.SC)(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get scale(){const e=this._camera,t=(0,Pi.j)(e.eye,this.renderLocation),i={renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}};return(0,se.Xt)(i,t)}get updating(){return this._dirty||null!=this._pendingElevationQueryController}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){const e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}get running(){return!this._pendingElevationQueryController&&this._dirty}runTask(){if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map?.ground)return this._updateSurfaceAltitude(0),sr.J;const e=this.state.spatialReference;this._tmpPoint.spatialReference=e,this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this._tmpPoint);const t=(this._tmpPoint.z??0)>u_&&this.renderCoordsHelper.viewingMode===Ht.JY.Global&&(e.isWGS84||e.isWebMercator);let i=new AbortController;return this.map.ground.queryElevation(this._tmpPoint,{signal:i.signal,cache:this.cache,minDemResolution:t?d_:0}).then((e=>this._updateSurfaceAltitude(e.geometry.z??0))).catch((e=>{(0,f.D_)(e)||this._updateSurfaceAltitude(0)})).catch((()=>{})).then((()=>{this._pendingElevationQueryController===i&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),i=null})),this._pendingElevationQueryController=i,sr.J}_updateSurfaceAltitude(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(h_,this._estimatedSurfaceAltitude,this._camera.eye),(0,Pi.q)(this._get("renderLocation"),h_)||(this._set("renderLocation",(0,Pi.c)(this._propertiesPool.get("renderLocation"),h_)),this.notifyChange("renderLocation"))}};(0,r._)([(0,w.Cb)({constructOnly:!0})],c_.prototype,"scheduler",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],c_.prototype,"cache",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],c_.prototype,"task",void 0),(0,r._)([(0,w.Cb)()],c_.prototype,"location",null),(0,r._)([(0,w.Cb)({constructOnly:!0})],c_.prototype,"map",void 0),(0,r._)([(0,w.Cb)()],c_.prototype,"renderLocation",void 0),(0,r._)([(0,w.Cb)()],c_.prototype,"scale",null),(0,r._)([(0,w.Cb)()],c_.prototype,"updating",null),c_=(0,r._)([(0,x.j)("esri.views.3d.support.pointsOfInterest.CameraOnSurface")],c_);const h_=(0,R.Ue)(),u_=1e5,d_=1e6,p_=Array;let m_=class extends o_{constructor(e){super(e),this._propertiesPool=new Wc.L({location:I.Z,renderLocation:p_},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.distance=0,this.renderLocation=(0,R.Ue)(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker=(0,p.hw)(this._frameWorker),this._propertiesPool=(0,p.SC)(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get running(){return this.updating}runTask(){return this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1,sr.J}_updateRenderLocation(){const e=__;let t=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,e);const i=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&i&&(t=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,e),t&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const r=g_;t&&this._latestSurfaceAltitudeChangesDistanceSignificantly(e,r)&&((0,Pi.c)(e,r),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t?this.distance=(0,Pi.j)(this._camera.eye,e):((0,Pi.g)(e,this._camera.viewForward,this._get("distance")),(0,Pi.f)(e,e,this._camera.eye)),(0,Pi.q)(this._get("renderLocation"),e)||this._set("renderLocation",(0,Pi.c)(this._propertiesPool.get("renderLocation"),e))}_calculateSurfaceIntersection(e,t){const i=this._camera;if(!this.renderCoordsHelper.intersectInfiniteManifold(i.ray,e,t))return!1;if(this.state.isGlobal){const r=(0,Ii.Iu)(this.renderCoordsHelper.spatialReference).radius,n=r+e,s=(0,Pi.k)(i.eye),a=s<n*n,o=(0,Pi.j)(i.eye,t);if(a&&o>r/4){const e=n-Math.sqrt(s);return(0,Pi.g)(t,i.viewForward,e),(0,Pi.f)(t,t,i.eye),!0}}else{const e=this.surface?.ready?this.surface.extent:null;null!=e&&(0,F.d)(e,this.surface?.spatialReference,y_,this.renderCoordsHelper.spatialReference)&&(t[0]=(0,st.uZ)(t[0],y_[0],y_[2]),t[1]=(0,st.uZ)(t[1],y_[1],y_[3]))}return!0}_latestSurfaceAltitudeChangesDistanceSignificantly(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||null==e)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){if(hd.h.TESTS_DISABLE_OPTIMIZATIONS)return!0;const i=this._camera.eye,r=(0,Pi.j)(i,e),n=(0,Pi.j)(i,t);if(Math.abs(n-r)/r>f_)return!0}return!1}};(0,r._)([(0,w.Cb)({constructOnly:!0})],m_.prototype,"scheduler",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],m_.prototype,"task",void 0),(0,r._)([(0,w.Cb)()],m_.prototype,"distance",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],m_.prototype,"estimateSurfaceAltitudeAtCenter",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],m_.prototype,"location",null),(0,r._)([(0,w.Cb)({readOnly:!0})],m_.prototype,"renderLocation",void 0),(0,r._)([(0,w.Cb)()],m_.prototype,"updating",void 0),m_=(0,r._)([(0,x.j)("esri.views.3d.support.pointsOfInterest.CenterOnSurface")],m_);const f_=.05,__=(0,R.Ue)(),g_=(0,R.Ue)(),y_=(0,H.Ue)();var v_=i(83986);class b_{constructor(e){this.events=new ae.Z,this._handles=(0,v_.w)((()=>e),(e=>e.on("visible-geometry-changed",(e=>this.events.emit("request-update",e)))))}destroy(){this._handles.destroy()}}const w_=Array;let C_=class extends o_{constructor(e){super(e),this._propertiesPool=new Wc.L({location:I.Z,renderLocation:w_},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.addHandles([(0,_.YP)((()=>this.centerOnSurface.renderLocation),(()=>this.updateRenderLocation())),(0,_.YP)((()=>this.state.contentCamera),(()=>this.updateRenderLocation()))]),this.scheduler&&this.addHandles(this.scheduler.registerTask(nr.T8.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool=(0,p.SC)(this._propertiesPool)}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get worldUnitsPerContentPixel(){const{camera:e,contentPixelRatio:t}=this.state;return e.computeRenderPixelSizeAt(this.renderLocation)*(e.pixelRatio/t)}get running(){return this._dirty}runTask(){const e=this._get("renderLocation"),t=this.centerOnSurface.renderLocation,i=this.renderCoordsHelper,r=this.state.contentCamera;this._dirty=!1,i.worldUpAtPosition(t,x_);const n=Math.max(0,(Math.acos((0,Pi.e)(x_,r.viewForward))-.5*Math.PI)*(r.aboveGround?1:-1));if(Number.isNaN(n)){if(!e||!(0,Pi.G)(e,t)){const e=this._propertiesPool.get("renderLocation");(0,Pi.c)(e,t),this._set("renderLocation",e)}return sr.J}const s=1-(0,st.uZ)(n/(.5*Math.PI),0,1),a=s*s*s;this._calculateScreenHorizontalEdgeOnSurface(S_);const o=this._propertiesPool.get("renderLocation");return(0,Pi.m)(o,t,S_,a),e&&(0,Pi.G)(e,o)||this._set("renderLocation",o),sr.J}_calculateScreenHorizontalEdgeOnSurface(e){const t=this.state.contentCamera,i=t.getRenderCenter((0,y.J$)());if(i[1]=t.aboveGround?t.padding[Zc.Np.BOTTOM]:t.fullHeight-t.padding[Zc.Np.TOP],this.estimateSurfaceIntersectionAtRenderPoint(i,e))return e;const r=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(i,T_)){(0,Pi.d)(T_,T_,t.eye);const i=(0,Pi.n)(T_,T_);if(this.renderCoordsHelper.intersectInfiniteManifold((0,Jn.re)(t.eye,i),r,e))return e}return this.renderCoordsHelper.setAltitude(e,r,t.eye)}updateRenderLocation(){this._dirty=!0}};(0,r._)([(0,w.Cb)()],C_.prototype,"_dirty",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],C_.prototype,"scheduler",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],C_.prototype,"centerOnSurface",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],C_.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),(0,r._)([(0,w.Cb)()],C_.prototype,"updating",null),(0,r._)([(0,w.Cb)()],C_.prototype,"location",null),(0,r._)([(0,w.Cb)()],C_.prototype,"renderLocation",void 0),(0,r._)([(0,w.Cb)()],C_.prototype,"worldUnitsPerContentPixel",null),C_=(0,r._)([(0,x.j)("esri.views.3d.support.pointsOfInterest.Focus")],C_);const x_=(0,R.Ue)(),T_=(0,R.Ue)(),S_=(0,R.Ue)();let M_=class extends S.Z{get surface(){return this.view.map?.ground}get surfaceView(){return this.view.basemapTerrain}get renderLocation(){if(!this.location)return null;const e=(0,R.Ue)();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}constructor(e){super(e),this.location=null,this._updateController=null}initialize(){this.view.state.isLocal&&(this.addHandles([(0,_.YP)((()=>[this.surfaceView?.spatialReference,this.surfaceView?.extent]),(()=>this._update())),(0,_.on)((()=>this.surface?.layers),"change",(()=>this._update()))]),this._update())}_update(){if(this._updateController&&(this._updateController.abort(),this._updateController=null),null==this.surfaceView?.extent||null==this.surfaceView.spatialReference)return void this._set("location",null);const e=(0,H.be)(this.surfaceView.extent),t=new I.Z({x:e[0],y:e[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this.surface.queryElevation(t,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then((e=>{this._updateController=null,this._set("location",e.geometry)})).catch((e=>{}))):this._set("location",t)}};(0,r._)([(0,w.Cb)({constructOnly:!0})],M_.prototype,"view",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],M_.prototype,"cache",void 0),(0,r._)([(0,w.Cb)()],M_.prototype,"surface",null),(0,r._)([(0,w.Cb)()],M_.prototype,"surfaceView",null),(0,r._)([(0,w.Cb)({readOnly:!0})],M_.prototype,"location",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],M_.prototype,"renderLocation",null),M_=(0,r._)([(0,x.j)("esri.views.3d.support.pointsOfInterest.StableSurfaceCenter")],M_);let E_=class extends S.Z{constructor(e){super(e),this._tileGeometryUpdateExtent=(0,H.cS)(),this._tileGeometryUpdateSpatialReference=null,this.events=new ae.Z,this.updating=!1}initialize(){this.addHandles([this.surface.on("elevation-change",(e=>this._tileGeometryChanged(e))),this.scheduler.registerTask(nr.T8.SURFACE_GEOMETRY_UPDATES,this)])}get running(){return this.updating}runTask(){return this.updating?(this._tileGeometryUpdateSpatialReference&&this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",P_),(0,H.cS)(this._tileGeometryUpdateExtent),this._set("updating",!1),sr.J):sr.J}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=e.spatialReference,(0,H.jn)(this._tileGeometryUpdateExtent,e.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let t=1;t<this.centerOnSurfaces.length;t++){const i=this.centerOnSurfaces[t];i.distance>e.distance&&(e=i)}return e}_centerIntersectsExtent(e,t){const i=this.state.contentCamera.eye,r=O_,n=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(i,R_,t),this.renderCoordsHelper.fromRenderCoords(n.renderLocation,A_,t),R_[0]<A_[0]?(r[0]=R_[0],r[2]=A_[0]):(r[0]=A_[0],r[2]=R_[0]),R_[1]<A_[1]?(r[1]=R_[1],r[3]=A_[1]):(r[1]=A_[1],r[3]=R_[1]),(0,H.kK)(r,e)}};(0,r._)([(0,w.Cb)({constructOnly:!0})],E_.prototype,"state",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],E_.prototype,"centerOnSurfaces",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],E_.prototype,"renderCoordsHelper",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],E_.prototype,"scheduler",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],E_.prototype,"surface",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],E_.prototype,"updating",void 0),E_=(0,r._)([(0,x.j)("esri.views.3d.support.pointsOfInterest.SurfaceGeometryUpdates")],E_);const P_={},R_=(0,R.Ue)(),A_=(0,R.Ue)(),O_=(0,H.cS)();let D_=class extends S.Z{constructor(e){super(e),this.renderPointOfView=(0,R.Ue)(),this._pois=new Array,this._updatingHandles=new X.R,this._debugCenters=null,this._tmpRay=(0,Jn.Ue)(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new Wc.L({renderPointOfView:I_},this),this._contentIntersector=new mo.r(e.view.state.viewingMode),this._surfaceIntersector=new mo.r(e.view.state.viewingMode),this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=Nm.e.MIN}initialize(){const{state:e,basemapTerrain:t,renderCoordsHelper:i,map:r}=this.view,n=()=>this._estimateSurfaceAltitudeAtCenter(),s=this.view.resourceController.scheduler,a=t?.elevationQueryCache,o={state:e,scheduler:s,surface:t,renderCoordsHelper:i};this._set("centerOnSurfaceInfrequent",new m_({...o,task:nr.T8.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:n})),this._set("centerOnSurfaceFrequent",new m_({...o,task:nr.T8.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:n})),this._set("centerOnContent",new m_({...o,task:nr.T8.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()})),this._set("cameraOnSurface",new c_({...o,cache:a,task:nr.T8.POINT_OF_INTEREST_INFREQUENT,map:r})),this._set("surfaceGeometryUpdates",new E_({...o,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]})),this._set("contentGeometryUpdates",new b_(this.view.allLayerViews)),this._set("surfaceOrigin",new M_({cache:a,view:this.view})),this._set("focus",new C_({state:e,scheduler:s,surface:t,renderCoordsHelper:i,centerOnSurface:this.centerOnSurfaceFrequent,estimateSurfaceIntersectionAtRenderPoint:(e,t)=>this._estimateSurfaceIntersectionAtRenderPoint(e,this.view.state.contentCamera,t)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.focus),this.addHandles([(0,_.YP)((()=>e.contentCamera),(e=>this._cameraChanged(e)),_.Z_),this._updatingHandles.add((()=>t.extent),(()=>this._updateCenterPointsOfInterest())),this._updatingHandles.add((()=>this.view.map?.ground?.navigationConstraint?.type),(e=>{this._surfaceIntersector.options.backfacesTerrain="none"===e}),_.nn),(0,_.gx)((()=>!t.updating),(()=>this._updateCenterPointsOfInterest()),_.Z_),(0,_.on)((()=>this.surfaceGeometryUpdates.events),"request-update",(()=>this._updateCenterPointsOfInterest())),(0,_.on)((()=>this.contentGeometryUpdates.events),"request-update",(()=>this._updateCenterOnContent())),this._updatingHandles.add((()=>hd.h.SHOW_POI),(e=>this._setDebug(e)),_.nn)]),this._cameraChanged(this.view.state.contentCamera);for(const e of this._pois)e.runTask()}destroy(){this._setDebug(!1),this._propertiesPool.destroy();for(const e of this._pois)e.destroy();this.surfaceOrigin.destroy(),this._updatingHandles.destroy()}get updating(){return!(!this.surfaceGeometryUpdates?.updating&&!this._pois.some((e=>e.updating)))||this._updatingHandles.updating}get _centerRay(){return this._centerRayDirty&&(this._centerRayCached=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.contentCamera,this._tmpRay),this._centerRayDirty=!1),this._centerRayCached}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const e=this._centerRay;return null==e||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,L_,F_)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(L_):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const e=this._centerRay;if(null==e)return this._surfaceAltitudeAtCenter;const t=e.origin,i=(0,Pi.f)(L_,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e,this.view.state.contentCamera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,t,i),this._surfaceIntersector.results.min.getIntersectionPoint(L_)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(L_)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(e,t,i){const r=(0,Ao.eW)(t,e,N_);if(null==r)return null;const n=r.origin,s=(0,Pi.f)(L_,r.origin,r.direction);return this._surfaceIntersector.resetWithRay(r,t),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,n,s),this._surfaceIntersector.results.min.getIntersectionPoint(i)?i:null}_cameraChanged(e){this._updateCenterPointsOfInterest();const t=e.eye;(0,Pi.q)(this.renderPointOfView,t)||this._set("renderPointOfView",(0,Pi.c)(this._propertiesPool.get("renderPointOfView"),t))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const e of this._pois)e.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(e){if(!e)return this._debugCenters?.forEach((e=>e.hide())),void this.removeHandles("debug");if(!this._debugCenters){this._debugCenters=new Map;const e=this.view.graphics;this._debugCenters.set(this.centerOnContent,new a_(e,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new a_(e,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new a_(e,"red","CenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new a_(e,"blue","CameraOnSurface")),this._debugCenters.set(this.focus,new a_(e,"green","Focus"))}for(const e of this._pois)this.addHandles(this._updatingHandles.add((()=>e.renderLocation),(t=>this._debugCenters?.get(e)?.show(t,e.renderCoordsHelper.spatialReference)),_.nn),"debug")}get test(){}};(0,r._)([(0,w.Cb)()],D_.prototype,"centerOnContent",void 0),(0,r._)([(0,w.Cb)()],D_.prototype,"centerOnSurfaceFrequent",void 0),(0,r._)([(0,w.Cb)()],D_.prototype,"centerOnSurfaceInfrequent",void 0),(0,r._)([(0,w.Cb)()],D_.prototype,"cameraOnSurface",void 0),(0,r._)([(0,w.Cb)()],D_.prototype,"focus",void 0),(0,r._)([(0,w.Cb)()],D_.prototype,"renderPointOfView",void 0),(0,r._)([(0,w.Cb)()],D_.prototype,"surfaceOrigin",void 0),(0,r._)([(0,w.Cb)()],D_.prototype,"contentGeometryUpdates",void 0),(0,r._)([(0,w.Cb)()],D_.prototype,"surfaceGeometryUpdates",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],D_.prototype,"view",void 0),(0,r._)([(0,w.Cb)()],D_.prototype,"updating",null),D_=(0,r._)([(0,x.j)("esri.views.3d.support.pointsOfInterest.PointsOfInterest")],D_);const I_=Array,L_=(0,R.Ue)(),N_=(0,Jn.Ue)(),F_={exclude:new Set([Lo.xX])};var U_=i(69071);class H_{constructor(e,t){this._cache=e(t,((e,t,i)=>{switch(t){case U_.lN.ALL:return e.forEach((e=>e.dispose())),0;case U_.lN.SOME:{const t=e.shift();return t?(i-=Math.round(t.cachedMemory),t.dispose()):i>0&&(d.Z.getLogger("esri/core/MemCachePool").warn("Encountered empty MemCachePool with non-zero memory."),i=0),i}}}))}hitrate(){return this._cache.hitRate}destroy(){this._cache.destroy()}clear(){this._cache.clear()}getSize(e){return this._cache.getSize(e)}pop(e){const t=this._cache.peek(e);if(!t)return;const i=t.pop();return t.length>0?i&&(t.cachedMemory=this._cache.getSize(e)-Math.round(i.cachedMemory),this._cache.updateSize(e,t)):this._cache.pop(e),i}put(e,t,i=U_.Jv){const r=this._cache.peek(e);if(r)r.push(t),r.cachedMemory=this._cache.getSize(e)+Math.round(t.cachedMemory),this._cache.updateSize(e,r);else{const r=new k_(t);this._cache.put(e,r,i)}}}class k_ extends Array{constructor(e){super(),this.item=e,this.cachedMemory=e.cachedMemory,this.push(e)}}var V_=i(77450),B_=i(42810),z_=i(38600),G_=i(81808);class q_{constructor(e=0,t=0){this.min=e,this.max=t,this.level=0,this.hasNoDataValues=!1}copyFrom(e){this.min=e.min,this.max=e.max,this.level=e.level,this.hasNoDataValues=e.hasNoDataValues}}var Z_=i(5135);class j_{constructor(e,t,i){this.type="elevation",this.level=e[0],this.i=e[1],this.j=e[2],this.extent=t,this.samplerData=new Z_.K(i,t)}computeMinMaxValue(e,t,i,r){r.min=1/0,r.max=-1/0,r.hasNoDataValues=!1;const n=e-this.level;if(n<=0)return r;const s=2**n;if(Math.floor(t/s)!==this.i||Math.floor(i/s)!==this.j)return r;let a=1/0,o=-1/0;const l=this.samplerData.data.width,c=this.samplerData.data.values,h=.5*ce.zl;let u=(l-1)/s,d=(i-this.j*s)*u,p=(t-this.i*s)*u;if(u<1){const e=Math.floor(d),t=Math.floor(p),i=e+t*l,n=c[i],s=c[i+1],a=c[i+l],o=c[i+l+1];if(n+s+a+o<h){const i=d-e,l=p-t,c=(0,gi.bX)(n,s,a,o,i,l),h=(0,gi.bX)(n,s,a,o,i+u,l),m=(0,gi.bX)(n,s,a,o,i,l+u),f=(0,gi.bX)(n,s,a,o,i+u,l+u);return r.min=Math.min(c,h,m,f),r.max=Math.max(c,h,m,f),r}d=e,p=t,u=1}else d=Math.floor(d),p=Math.floor(p),u=Math.ceil(u);for(let e=d;e<=d+u;e++)for(let t=p;t<=p+u;t++){const i=c[e+t*l];i<h?(a=Math.min(a,i),o=Math.max(o,i)):r.hasNoDataValues=!0}return r.min=a,r.max=o,r}}const W_=.5*ce.zl;function $_(e,t,i){if(null==i)return null;for(const r of i){if(!r)continue;const i=r.safeWidth;let n=(0,st.uZ)(r.dy*(r.y1-t),0,i),s=(0,st.uZ)(r.dx*(e-r.x0),0,i);const a=Math.floor(n),o=Math.floor(s),l=r.data.width,c=a*l+o,h=r.data.values,u=h[c],d=h[c+1],p=c+l,m=h[p],f=h[p+1];if(u+m+d+f<W_){n-=a,s-=o;const e=u+(d-u)*s;return e+(m+(f-m)*s-e)*n}}return null}var X_=i(6883);let Y_=class extends S.Z{constructor(e){super(e)}initialize(){this.addHandles([this.layerViews.on("change",(()=>this.notifyChange("stencilEnabledExtents")))])}destroy(){}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}_computeStencilEnabledExtents(){const e=[];return this.layerViews.forEach((t=>{const i=t.layer;if("operationalLayerType"in i&&(0,B.$4)(i.operationalLayerType)&&null!=this.viewSpatialReference){const t=J_(i.fullExtent,this.viewSpatialReference);null!=t&&e.push((0,H.oJ)(t))}})),e}};(0,r._)([(0,w.Cb)({readOnly:!0})],Y_.prototype,"layerViewsExtent",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Y_.prototype,"tiledLayersExtent",null),(0,r._)([(0,w.Cb)({readOnly:!0})],Y_.prototype,"stencilEnabledExtents",null),(0,r._)([(0,w.Cb)()],Y_.prototype,"viewSpatialReference",void 0),(0,r._)([(0,w.Cb)()],Y_.prototype,"tilingScheme",void 0),(0,r._)([(0,w.Cb)()],Y_.prototype,"defaultTiledLayersExtent",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],Y_.prototype,"layers",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],Y_.prototype,"layerViews",void 0),Y_=(0,r._)([(0,x.j)("esri.views.3d.terrain.ExtentHelper")],Y_);let K_=class extends Y_{_computeLayerViewsExtent(){return this._globalExtent}_computeTiledLayersExtent(){return this._globalExtent}get _globalExtent(){return this.viewSpatialReference.isWebMercator?ce.uU:ce.JR}};K_=(0,r._)([(0,x.j)("esri.views.3d.terrain.ExtentHelper.ExtentHelperGlobal")],K_);let Q_=class extends Y_{_computeLayerViewsExtent(){const e=(0,H.cS)(),t=this.viewSpatialReference;this.layerViews.forEach((i=>{const r=i.layer;if(i.isResolved()&&("graphics"!==r.type||!r.internal)){const r=J_("fullExtentInLocalViewSpatialReference"in i&&i.fullExtentInLocalViewSpatialReference||i.layer.fullExtent,t);(0,H.jn)(e,r,e)}}));const i=(0,H.sU)(e)?e:null,r=this._get("layerViewsExtent");return(0,H.fS)(i,r)?r:i}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const t=this.viewSpatialReference,i=(0,H.cS)();this.layers.forEach((r=>{if(r.loaded&&(0,B.iC)(r)){const n=(0,X_.E_)(r,t,Ht.JY.Local);if(null==n)return;const{tileInfo:s,fullExtent:a}=n,o="tilemapCache"in r?r.tilemapCache?.effectiveMaxLOD:void 0;null!=s&&null!=a&&((0,X_.x4)(r)||e.compatibleWith(s,o)&&a.spatialReference.equals(e.spatialReference))&&(0,H.jn)(i,a,i)}})),(0,H.jn)(i,this.defaultTiledLayersExtent,i);const r=(0,H.sU)(i)?i:null,n=this._get("tiledLayersExtent");return(0,H.fS)(r,n)?n:r}};function J_(e,t){return null==e||e.spatialReference.equals(t)?e:(0,L.projectWithoutEngine)(e,e.spatialReference,t)}Q_=(0,r._)([(0,x.j)("esri.views.3d.terrain.ExtentHelper.ExtentHelperLocal")],Q_);var eg=i(85216),tg=i(97290),ig=i(61471),rg=i(25909),ng=i(62935),sg=i(51440);function ag(){const e=globalThis.require?.modules;if(e){const t=Object.keys(e);for(const i of t)i.includes(".glsl")&&delete e[i]}}class og{constructor(e,t){this.screen=e,this.olid=t}}const lg=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let cg,hg=class extends S.Z{constructor(e){super(e),this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Set,this._drapeTargets=new Set,this._placementDirty=!1,this._contentUpdated=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._latestOriginId=0}initialize(){const e=this.view;this.renderer=new ig.CB({parent:this}),e.stage.renderer.plugins.add(this.renderer);const t=()=>this.requestRender();this._groundIntersector=new mo.r(this.view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this.addHandles([(0,_.YP)((()=>this.renderer.hasHighlights),t),this.renderer.events.on("has-water",(()=>e.stage?.renderer.updateHasFlags())),this.renderer.events.on("content-changed",t),(0,_.YP)((()=>e.state.camera.pixelRatio),t),(0,_.YP)((()=>e.state.alignPixelEnabled),t),this.renderer.events.on("textures-disposed",(()=>this.surface.requestRender())),(0,_.YP)((()=>[e.pointsOfInterest?.renderPointOfView,e.pointsOfInterest?.centerOnSurfaceFrequent?.location]),(()=>this.setPlacementDirty())),(0,_.YP)((()=>[e.state?.pixelRatio,e.state?.contentPixelRatio]),(()=>this.setPlacementDirty()),_.Z_),this.surface.on("elevation-change",(()=>this.setPlacementDirty())),e.on("resize",(()=>this.setPlacementDirty())),e.resourceController.scheduler.registerTask(nr.T8.OVERLAY,this),e.stage.renderView.events.on("force-camera-for-screenshot",(e=>{this._updateOverlays(nr.G5,e.camera,Cr.Xx.BACKGROUND),this.renderer.hasOverlays&&this._drawOverlays(Cr.Xx.BACKGROUND,e)}))]),e.stage.renderer.overlay=this}destroy(){this.view?.stage&&(this.view.stage.renderer.plugins.remove(this.renderer),this.view.stage.renderer.overlay=null),cg&&(cg.hide(),cg=null),this.renderer=(0,p.SC)(this.renderer)}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.renderer.longitudeCyclical=null;const t=this.view.renderSpatialReference;null!=e&&null!=t?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this.renderer.longitudeCyclical=e.isWebMercator?new vo.pE(-20037508.342787,20037508.342787):new vo.pE(-180,180))):this.renderer.disposeOverlays()}get running(){return this._placementDirty&&(this._drapeSources.size>0||this.view.graphics.length>0||hd.h.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this.view.state.isGlobal}get worldToPCSRatio(){return null!=this._spatialReference&&this._spatialReference.isGeographic&&!this.view.state.isLocal?(0,Ii.Iu)(this._spatialReference).metersPerDegree:1}get _overlayStretch(){return 1.3/this.view.resolutionScale}get _longitudeCyclical(){return this.renderer.longitudeCyclical}get suspended(){return this.surface.suspended}get updating(){return this.running||this.renderer.updating||this._contentUpdated}get rendersOccludedDraped(){return this.renderer.rendersOccludedDraped}render(){if(this._contentUpdated=!1,this.renderer.processSyncDrapeSources(),this.renderer.hasOverlays)return this._precompileShaders()?this._drawOverlays(Cr.Xx.UPDATE):null}get hasOverlays(){return this.renderer.hasOverlays}registerDrapeSource(e,t){this._drapeSources.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources),this.renderer.registerDrapeSource(e,t),this._updateDrapeSourceExtent(e),this._setContentDirty(),this.notifyChange("running")}registerGeometryDrapeSource(e){const t=new ng.S({stage:this.view.stage,drapeSource:e,rendererContext:this.renderer});return this.registerDrapeSource(e,t),t}_updateDrapeSourceExtent(e){2===this.renderer.overlays.length&&null!=e.setDrapingExtent&&null!=this._spatialReference&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference)}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.removeDrapeSourceRenderer(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))}registerDrapeTarget(e){this._drapeTargets.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}unregisterDrapeTarget(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setContentDirty(){this.setPlacementDirty(),this.requestRender()}setPlacementDirty(){this._placementDirty=!0}runTask(e){return this._updateOverlays(e,this.view.state.contentCamera,Cr.Xx.UPDATE)}_updateOverlays(e,t,i){if(!this._spatialReference)return sr.J;const r=this._computeOverlayHeight(t);this._computeOverlayExtents(t,r,pg),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources,pg.stretch);const n=this._updateOverlay(eg.fu.INNER,pg.inner,r,1*pg.pixelRatioAdjustment,pg.mapUnitsPerPixel),s=(0,H.d_)(pg.inner)/(0,H.d_)(pg.outer),a=this._updateOverlay(eg.fu.OUTER,pg.outer,r,s*pg.pixelRatioAdjustment,pg.mapUnitsPerPixel);n!==gg.EXTENT&&a!==gg.EXTENT||(this._drapeSources.forEach((e=>this._updateDrapeSourceExtent(e))),this.updateOverlayParameters(i)),n===gg.NONE&&a===gg.NONE||this.requestRender(),this._placementDirty=!1,e.madeProgress()}_computeOverlayHeight(e){const t=this.view.state.contentPixelRatio*this.view.resolutionScale,i=e.fullWidth/e.pixelRatio*t,r=e.fullHeight/e.pixelRatio*t,n=Math.ceil(1.5*Math.max(i,r)),{maxPreferredTexturePixels:s,maxTextureSize:a}=this.view.stage.renderView.renderingContext.parameters,o=.5*a;return(0,sg.nq)((0,sg.tI)({width:n,height:n},{maxPreferredTexturePixels:2*s,maxTextureSize:o})[1],o)}_updateOverlay(e,t,i,r,n){if(0===this.renderer.overlays.length)return gg.NONE;const s=this.renderer.overlays[e],a=s.mapUnitsPerPixel;if(s.mapUnitsPerPixel=n,s.pixelRatio=r,function(e,t){const i=1e-5,r=hd.h.TESTS_DISABLE_OPTIMIZATIONS?0:i*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]);return Math.abs(t[0]-e[0])<=r&&Math.abs(t[1]-e[1])<=r&&Math.abs(t[2]-e[2])<=r&&Math.abs(t[3]-e[3])<=r}(t,s.extent)&&i===s.resolution)return a===n?gg.NONE:gg.RERENDER_ONLY;(0,H.JG)(s.extent,t),s.resolution=i;const o=(0,H.be)(s.extent);return s.renderLocalOrigin=(0,rg.a)(o[0],o[1],0,"OV_"+this._latestOriginId++),gg.EXTENT}updateOverlayParameters(e){this.surface.allTiles.forAll((e=>this.updateTileOverlayParameters(e))),this.surface.requestRender(e)}updateTileOverlayParameters(e){if(!e.renderData)return;const t=e.renderData.overlay;if(0===this.renderer.overlays.length)this._clearTileOverlayData(eg.fu.INNER,t),this._clearTileOverlayData(eg.fu.OUTER,t);else{const[i,r]=this.renderer.overlays,n=e.extent;this._rectInsideRect(i.extent,n)||this._rectanglesOverlap(n,i.extent)||this._rectanglesOverlap(n,r.extent)?(this._setTileOverlayData(n,eg.fu.INNER,t),this._setTileOverlayData(n,eg.fu.OUTER,t)):(this._clearTileOverlayData(eg.fu.INNER,t),this._clearTileOverlayData(eg.fu.OUTER,t))}}overlayPixelSizeInMapUnits(e,t){if(0===this.renderer.overlays.length)return t();const i=this.renderer.overlays[eg.fu.INNER],r=this.renderer.overlays[eg.fu.OUTER],n=this._pointIsInExtent(e,i.extent)?i:r;return(n.extent[2]-n.extent[0])/n.resolution}_setTileOverlayData(e,t,i){if(0===this.renderer.overlays.length)return;const r=this.renderer.overlays[t].extent,n=(0,H.d_)(r),s=(0,H.Cb)(r);let a=e[0];if(this._longitudeCyclical){a=this._longitudeCyclical.minimalMonotonic(r[0],a);const t=this._longitudeCyclical.minimalMonotonic(r[0],e[2]);a>t&&(a=t-(e[2]-e[0]))}i.setScale(t,(0,H.d_)(e)/n,(0,H.Cb)(e)/s),i.setOffset(t,(a-r[0])/n,(e[1]-r[1])/s)}_clearTileOverlayData(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)}reloadShaders(){ag(),this.requestRender(),this.runTask(nr.G5)}requestRender(e=Cr.Xx.UPDATE){this.renderer.hasOverlays?(e===Cr.Xx.UPDATE?(this._contentUpdated=!0,this._drawTexturesDirty=!0):this._drawTexturesAnimateDirty=!0,this.view.stage.renderView.requestRender(e)):this.setPlacementDirty()}_intersectGroundFromView(e,t,i,r,n){const s=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,_g,t,i);if(null==s)return!1;const a=s.origin,o=(0,Pi.f)(dg,s.origin,s.direction);this._groundIntersector.reset(a,o,e),this._groundIntersector.intersect([]),this.view.basemapTerrain.intersect(this._groundIntersector,null,a,o);const l=this._groundIntersector.results.min;return l.getIntersectionPoint(n)&&l.withinDistance(r)}_findHorizonBasedPointOfInterest(e,t){let i=.5;const r=.55,n=this.view.renderCoordsHelper.getAltitude(e.eye),s=this.view.pointsOfInterest.centerOnSurfaceFrequent,a=1e-5,o=(0,st.uZ)(s.estimatedSurfaceAltitude,e.aboveGround?-1/0:n+a,e.aboveGround?n-a:1/0),l=e.aboveGround;if("global"===this.view.viewingMode){const t=dg;(0,es.j)((0,es.b)(es.t,(0,Ii.Iu)(this.view.spatialReference).radius+o),(0,Jn.re)(e.eye,e.viewForward),t),(0,Pi.d)(t,t,e.eye);const n=vo.Q4.normalize((0,Co.cp)(e.viewForward,t,e.viewRight))/e.fovY+.5,s=n<=0||n>=1?.5:r;i=l?s*n:n+s*(1-n)}else{const t=.5*Math.PI-Math.acos(-e.viewForward[2]),n=Math.tan(t),s=(0,tc.al)(0,n,1,0),a=(0,ec.t)(s,s,e.projectionMatrix)[1],o=(0,st.uZ)(.5+.5*a,0,1);i=1===o||0===o?.5:l?o*r:1-(1-o)*r}return this._intersectGroundFromView(e,.5,i,s.distance,t)}_computeOverlayExtents(e,t,i){const r=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,n=(0,R.Ue)();this._findHorizonBasedPointOfInterest(e,n)||(0,Pi.c)(n,r),hd.h.OVERLAY_SHOW_CENTER?(null==cg&&(cg=new a_(this.view.graphics,"red")),cg.show(n,this._renderSR)):null!=cg&&cg.hide();const s=Math.max(.1,(0,Pi.j)(e.eye,n)),a=(0,Ms.L)(this.view.renderCoordsHelper,r,e.eye);this._overlaySREqualsRenderSR||(0,mc.S)(n,this._renderSR,n,this._spatialReference);const o=this.surface.extent,l=!this._isSpherical&&this._spatialReference?.isGeographic,c=l&&this._spatialReference?1/(0,Ii.Iu)(this._spatialReference).metersPerDegree:1,h=this.view.state.contentPixelRatio,u=e.perScreenPixelRatio/h*s*c;i.mapUnitsPerPixel=u/this.worldToPCSRatio,i.stretch=this._overlayStretch;let d=t*u/2*i.stretch,p=!1,m=l?90:1/0;this._isSpherical&&o&&this._spatialReference&&(this._spatialReference.isWebMercator?(d/=Math.cos((0,tg.mZ)(n[1])),m=o[3]):(p=!0,d/=(0,Ii.Iu)(this._spatialReference).metersPerDegree,m=90),d>=m&&(d=m,n[1]=0,this._spatialReference.isWebMercator&&(n[0]=0)));let f=1;p&&(f=1/Math.max(.2,Math.cos(Math.abs((0,st.Vl)(n[1])))),d*f>180&&(f=180/d),i.mapUnitsPerPixel*=f);const _=Math.log(2)/12;d=Math.exp(Math.round(Math.log(d)/_)*_);const g=d*f,y=.5*t/(32*g),v=.5*t/(32*d);n[0]=Math.round(n[0]*y)/y,n[1]=Math.round(n[1]*v)/v;const b=i.inner;b[0]=n[0]-g,b[1]=n[1]-d,b[2]=n[0]+g,b[3]=n[1]+d,this._isSpherical&&this._shiftExtentToFitBounds(b,1/0,m);const w=i.outer;if(6*g>(0,H.d_)(o))(0,H.JG)(w,o);else if(Math.PI/2-Math.abs(a-Math.PI/2)<=.25*Math.PI)w[0]=b[0]-g,w[1]=b[1]-d,w[2]=b[2]+g,w[3]=b[3]+d;else{(0,mc.S)(e.eye,this._renderSR,dg,this._spatialReference),(0,zi.$X)(ug,n,dg);let t=-Math.atan2(ug[1],ug[0])+.125*Math.PI;t<0&&(t+=2*Math.PI);const i=Math.floor(t/(.25*Math.PI));(0,ec.d)(ug,lg[i],2*d),ug[0]*=f,ug[2]*=f,(0,ec.g)(w,b,ug)}if(this._isSpherical)w[0]=this._longitudeCyclical.clamp(w[0]),w[2]=this._longitudeCyclical.clamp(w[2]),w[1]=Math.max(w[1],-m),w[3]=Math.min(w[3],m);else{const e=(0,H.jV)(b,o,mg),t=(0,H.jV)(w,o,fg);(0,H.r3)(e,t)&&(w[2]=w[0],w[3]=w[1])}const C=Math.abs(b[2]-b[0])/t;i.mapUnitsPerPixel=Math.max(i.mapUnitsPerPixel,C),i.pixelRatioAdjustment=i.mapUnitsPerPixel/C}_precompileShaders(){return!!this.renderer.hasOverlays&&(this.renderer.precompileShaders(this.view.state),!0)}_drawOverlays(e,t=this.view.state){if(!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return this.renderer;const i=this._drawTexturesDirty;this._drawTexturesDirty=this._drawTexturesAnimateDirty=!1;const r=this.renderer.computeValidity();return this.renderer.releaseRenderTargets(),this.renderer.drawOverlays(t),r!==this.renderer.computeValidity()&&this.updateOverlayParameters(Cr.Xx.UPDATE),i?(this.surface.requestRender(e),e===Cr.Xx.UPDATE&&this.surface.requestUpdate()):this.surface.requestRender(Cr.Xx.BACKGROUND),this.renderer}_rectanglesOverlap(e,t){return null!=e&&(this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):(0,H.kK)(e,t))}_rectInsideRect(e,t){return null!=t&&(this._longitudeCyclical?this._longitudeCyclical.contains(e[0],e[2],t[0])&&this._longitudeCyclical.contains(e[0],e[2],t[2])&&t[1]>e[1]&&t[3]<e[3]:(0,H.r3)(e,t))}_pointIsInExtent(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];const i=e.x,r=e.y;return i>t[0]&&i<t[2]&&r>t[1]&&r<t[3]}_shiftExtentToFitBounds(e,t,i){let r=0,n=0;e[0]<-t?r=e[0]+t:e[2]>t&&(r=t-e[2]),e[1]<-i?n=e[1]+i:e[3]>i&&(n=i-e[3]),(0,H.cv)(e,r,n)}get test(){}};(0,r._)([(0,w.Cb)()],hg.prototype,"_spatialReference",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],hg.prototype,"running",null),(0,r._)([(0,w.Cb)()],hg.prototype,"_placementDirty",void 0),(0,r._)([(0,w.Cb)()],hg.prototype,"_contentUpdated",void 0),(0,r._)([(0,w.Cb)()],hg.prototype,"_isSpherical",null),(0,r._)([(0,w.Cb)()],hg.prototype,"worldToPCSRatio",null),(0,r._)([(0,w.Cb)()],hg.prototype,"renderer",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],hg.prototype,"view",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],hg.prototype,"surface",void 0),(0,r._)([(0,w.Cb)()],hg.prototype,"suspended",null),(0,r._)([(0,w.Cb)()],hg.prototype,"updating",null),(0,r._)([(0,w.Cb)({type:Boolean})],hg.prototype,"rendersOccludedDraped",null),hg=(0,r._)([(0,x.j)("esri.views.3d.terrain.OverlayManager")],hg);const ug=(0,tc.Ue)(),dg=(0,R.Ue)(),pg=new class{constructor(){this.inner=(0,H.Ue)(),this.outer=(0,H.Ue)(),this.mapUnitsPerPixel=0,this.pixelRatioAdjustment=1,this.stretch=1.3}},mg=(0,H.Ue)(),fg=(0,H.Ue)(),_g=(0,Jn.Ue)();var gg;!function(e){e[e.NONE=0]="NONE",e[e.EXTENT=1]="EXTENT",e[e.RERENDER_ONLY=2]="RERENDER_ONLY"}(gg||(gg={}));var yg=i(59384),vg=i(29499);class bg{constructor(){this.numVerticesPerSide=0,this.samplerData=null,this.samplerDataVersion=0,this.clippingArea=null,this.wireframe=!1,this.cornerPeerNeighbors=[null,null,null,null],this.cornerNeighborCornerTiles=[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],this.cornerNeighborCornerTileSamplerVersions=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],this.edgeResolutions=[-1,-1,-1,-1],this.edgePeerNeighbors=[null,null,null,null],this.edgePeerNeighborSamplerVersions=[-1,-1,-1,-1]}}var wg,Cg=i(72913);class xg{constructor(){this.indices=null,this.indexCount=0,this.edgeIndicesStartIndex=0,this.poleIndicesStartIndex=0,this.vertexAttributes=null,this.edgeVerticesStartIndex=0,this.poleVerticesStartIndex=0,this.maxEdgeVertexCount=0,this.boundingBox=(0,fc.cS)(),this.numVerticesPerSide=0,this.minu=0,this.minv=0,this.maxu=1,this.maxv=1,this.outerEdgesOffsetAndLength=[0,0,0,0,0,0,0,0]}release(){this.vertexAttributes=(0,p.RY)(this.vertexAttributes),this.indices=null}reset(){this.indices=null,this.vertexAttributes=null,(0,fc.cS)(this.boundingBox),this.numVerticesPerSide=0}getEdgeFirstVertexIndex(e){return this.outerEdgesOffsetAndLength[2*e]}getEdgeCount(e){return this.outerEdgesOffsetAndLength[2*e+1]}getEdgeVertexIndex(e,t){return this.getEdgeAttributeIndex(e,t)}getEdgeVertexPosition(e,t,i,r){this._getEdgeVertexRaw(this.getEdgeAttributeIndex(e,r),t),(0,Pi.f)(t,t,i)}getEdgeNormal(e,t,i){const{typedBuffer:r,typedBufferStride:n}=this.vertexAttributes.normalCompressed;(0,Cg.rc)(t,r,this.getEdgeAttributeIndex(e,i),n)}setEdgeNormalFromValues(e,t,i,r,n){this._setNormal(this.getEdgeAttributeIndex(e,t),i,r,n)}setEdgeVertexFromValuesRawPositionUV(e,t,i,r,n,s,a){const o=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(o,i,r,n),this._setUV(o,s,a)}setEdgeVertexFromValuesRawPositionUVNormal(e,t,i,r,n,s,a,o,l,c){const h=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(h,i,r,n),this._setUV(h,s,a),this._setNormal(h,o,l,c)}_getEdgeVertexRaw(e,t){this.vertexAttributes.position.getVec(e,t)}_setNormal(e,t,i,r){const{typedBuffer:n,typedBufferStride:s}=this.vertexAttributes.normalCompressed;(0,Cg.hd)(n,e,t,i,r,s)}_setUV(e,t,i){this.vertexAttributes.uv0.setValues(e,Math.round(t*yg.rU),Math.round(i*yg.rU))}getEdgeAttributeIndex(e,t){return(0,X_.Fp)(0<=t&&t<this.getEdgeCount(e)),this.getEdgeFirstVertexIndex(e)+t}}class Tg{constructor(e){this._getFadeDuration=e,this._fadeStart=0,this._delayedTime=0}clear(){this._current=(0,p.SC)(this._current),this._next=(0,p.SC)(this._next),this._waiting=(0,p.SC)(this._waiting),this._delayed=(0,p.SC)(this._delayed)}get current(){if(null==this._current)return null;if(!this._isFadingEnabled){let e=null;this._delayed?(e=this._delayed,this._delayed=null):this._waiting?(e=this._waiting,this._waiting=null):this._next&&(e=this._next,this._next=null),e&&(this.clear(),this._current=e)}let e=Tg.test.fadeMoment;if(this._delayed&&(e=e||performance.now(),e>=this._delayedTime&&(this._push(this._delayed,wg.Immediate),this._delayed=null)),this._next){e=e||performance.now();const t=this._fadeDuration,i=null!=this._current&&this._next.texture===this._current.texture,r=this._next.type!==eg.Ns.FADING,n=e-this._fadeStart>=t;(i||r||n)&&((0,p.SC)(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(e))}return this._current}get next(){return this._next}get fadeFactor(){if(null==this._next)return 1;const e=Tg.test.fadeMoment||performance.now(),t=Math.max(0,e-this._fadeStart),i=this._fadeDuration;return t>i?0:1-t/i}get isFading(){return null!=this._next||null!=this._delayed}push(e,t=wg.Immediate){this._delayed=(0,p.SC)(this._delayed),this._push(e,t)}_push(e,t){if(this._isFadingEnabled||this.clear(),null==this._current)return void(this._current=e);const i=Tg.test.fadeMoment||performance.now();return t!==wg.Immediate?(this._delayed=e,void(this._delayedTime=i+t)):null==this._next?(this._next=e,void(this._fadeStart=this._alignFadeStart(i))):void(null!=e&&((0,p.SC)(this._waiting),this._waiting=e))}get _fadeDuration(){const e=this._getFadeDuration();return this._waiting?.5*e:e}_alignFadeStart(e){const t=this._getFadeDuration();return e+t-e%t}get _isFadingEnabled(){return this._getFadeDuration()>0}static{this.test={fadeMoment:0}}}!function(e){e[e.Immediate=0]="Immediate",e[e.Delayed=5e3]="Delayed"}(wg||(wg={}));class Sg{constructor(e,t,i,r,n,s){this.texture=e,this.type=t,this.offsetAndScale=i,e.retain(),this.opacities=(0,R.al)(r,n,s)}destroy(){this.texture.release()}}class Mg{constructor(){this._scales=(0,tc.al)(-1,-1,-1,-1),this._offsets=(0,tc.al)(-1,-1,-1,-1)}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(e,t,i){this._scales[2*e]=t,this._scales[2*e+1]=i}setOffset(e,t,i){this._offsets[2*e]=t,this._offsets[2*e+1]=i}get scales(){return this._scales}get offsets(){return this._offsets}}var Eg=i(25907),Pg=i(26041),Rg=i(91708);class Ag extends Wi.A{constructor(e,t){super(e,t,new ji.J(Rg.a,(()=>i.e(73752).then(i.bind(i,73752)))),Og),this.type="TerrainTechnique",this.useStencil=!1}initializePipeline(e){return this._stencilPipelineState=this._createPipeline(e,!0),this._createPipeline(e,!1)}_createPipeline(e,t){const{renderOccluded:i,output:r}=e,n=e.backfaceCullingEnabled&&!i;return(0,Xi.sm)({blending:i?Xi.Zo:null,culling:n?Xi.Rd:null,depthTest:i?null:{func:$i.wb.LESS},depthWrite:i?null:Xi.ck,colorWrite:Xi.gf,stencilTest:t?(0,Pg.iV)(Cr.hU.IntegratedMeshMaskExcluded):null,drawBuffers:(0,Wi.E)(r)})}getPipeline(){return this.useStencil?this._stencilPipelineState:super.getPipeline()}}const Og=new Map([[mr.T.POSITION,0],[mr.T.UV0,1],[mr.T.NORMALCOMPRESSED,2]]);class Dg{constructor(){this.geometry=new xg,this.intersectionData=null,this.geometryState=null,this._vao=null,this._texture=null,this._textureOpacity=1,this._textureRef=new Tg((()=>this._tile.surface.fadeDuration)),this.overlay=new Mg,this._localOrigin=null,this._geometryStateChangedSinceLastUpdate=!0,this._hasGeometry=!1,this._modifiedFlags=0}get tile(){return this._tile}get localOrigin(){return this._localOrigin}init(e,t){this.clear(),this._tile=e,this.geometry.reset(),this.intersectionData=null,this.geometryState=new bg,this._localOrigin=t,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear(),this._tile=null,this.intersectionData=null,this.geometryState=null}updateGeometryIfNeeded(e){if((!this._vao||this._geometryStateChangedSinceLastUpdate||this.wireframeChanged||this.clippingAreaChanged||this.samplerDataChanged||this.numVerticesPerSideChanged||this.dirtyCorners||this.dirtyEdgeResolutions||this.dirtyEdges)&&(this._updateGeometry(e),this._geometryStateChangedSinceLastUpdate=!1),X_.T9&&this.tile.intersectsClippingArea)for(let e=0;e<4;++e)(0,X_.Fp)(this.geometry.getEdgeCount(e)===this.geometryState.edgeResolutions[e]+1)}_calculateEdgeResolution(e,t){const i=this.tile,r=this.geometryState.numVerticesPerSide-1;if(!i.surface.isGlobal){const t=i.surface.extent;if(null!=t&&(0===e&&i.extent[3]>t[3]||1===e&&i.extent[2]>t[2]||2===e&&i.extent[1]<t[1]||3===e&&i.extent[0]<t[0]))return r}const n=i.level,s=X_.OC[e];if(!t)return(0,X_.Fp)(null==i.surface?.rootTiles||i.surface.updatingRootTiles||!i.shouldHaveNeighbor(s)),r;if(t.loaded){const i=t,s=i.renderData.geometryState,a=n-i.level;if((0,X_.Fp)(a>=0),0===a){const e=s.numVerticesPerSide-1;return Math.max(e,r)}const o=2**a,l=s.edgeResolutions[(e+2)%4]/o;return Math.max(1,l)}(0,X_.Fp)(!t.leaf);let a=r;return t.forAllSubtreeOnSide((0,X_._F)(s),(e=>e===i||(e.loaded?(a=Math.max(a,2**(e.level-n)),!0):((0,X_.Fp)(!e.leaf),!1)))),a}updateNeighborData(){const e=this.tile;if(!e.intersectsClippingArea)return;const t=e.renderData.geometryState,i=t=>(t.loaded||t.level===e.level)&&t?.intersectsClippingArea,r=t.edgePeerNeighbors,n=t.edgePeerNeighborSamplerVersions;for(let s=0;s<4;++s){const a=e.findNeighborTile(X_.OC[s],i),o=Bg(e,a),l=o?.renderData?.geometryState.samplerDataVersion??-1,c=r[s],h=o!==Bg(e,c),u=n[s]!==l;X_.T9&&a&&((0,X_.Fp)(e.level>=a.level),(0,X_.Fp)(e.level-a.level<=ce.qC)),r[s]=a,(h||u)&&(n[s]=l,this._markEdgeDirty(s));const d=t.edgeResolutions[s],p=this._calculateEdgeResolution(s,a);(0,X_.Fp)((0,st.wt)(p)),(0,X_.Fp)(p>=1),t.edgeResolutions[s]=p,d!==p&&this._markEdgeResolutionDirty(s)}for(let n=0;n<4;++n){const s=e.findNeighborTile(X_.cA[n],i);t.cornerPeerNeighbors[n]=s;const a=Bg(e,r[n]),o=Bg(e,r[(n+1)%4]),l=Bg(e,s);Vg[n]=l,Vg[(n+1)%4]=o,Vg[(n+2)%4]=e,Vg[(n+3)%4]=a,(0,X_.Fp)(Vg.some((t=>t?.loaded||t===e)));const c=Vg.reduce(((e,t)=>Math.min(e,t?.level??1/0)),1/0);Vg.forEach(((e,t)=>{e&&e?.level>c&&(Vg[t]=null)})),(0,X_.Fp)(Vg.some((t=>t?.loaded||t===e)));const h=t.cornerNeighborCornerTiles,u=t.cornerNeighborCornerTileSamplerVersions;for(let e=0;e<4;++e){const t=Vg[e],i=t?.renderData.geometryState.samplerDataVersion??-1,r=4*n+e,s=h[r]!==t,a=!s&&u[r]!==i;(s||a)&&(h[r]=t,u[r]=i,this._markCornerDirty(n))}X_.T9&&(0,X_.Fp)(Xg.some((t=>h[4*n+t]?.loaded||h[4*n+t]===e)))}X_.T9&&(0,X_.Fp)(this.geometryState.edgeResolutions.every((e=>e>0)));for(let e=0;e<4;++e)Vg[e]=null}_updateGeometry(e){if(!this.tile.intersectsClippingArea)return;X_.T9&&(0,X_.Fp)(!this.tile.intersectsClippingArea||this.geometryState.edgeResolutions.every((e=>e>0))),this.intersectionData=null;const{tile:t,_vao:i,geometry:r,geometryState:n}=this,s=!i||this.wireframeChanged||this.samplerDataChanged||this.clippingAreaChanged||this.numVerticesPerSideChanged,a=0!==this.dirtyEdgeResolutions,o=n.edgeResolutions.reduce(((e,t)=>e+t+1),0),l=s||a&&o>(r?.maxEdgeVertexCount??0),c=!l&&a,h=!c&&(0!==this.dirtyEdges||a),u=!h&&0!==this.dirtyCorners;l?(this.releaseGeometry(),this._createGeometry(e)):c?t.updateEdgeElevationsAndResolutions():h||u?t.updateEdgeElevations():u?t.updateCornerElevations():console.warn("Update for no reason?"),this._modifiedFlags=0}get hasGeometry(){return this._hasGeometry}releaseGeometry(){return this._hasGeometry=!1,this.intersectionData=null,!!this._vao&&(this._vao=(0,p.M2)(this._vao),this.geometry.release(),!0)}ensureTexture(e,t,i,r){const n=t?$i.VI.RGBA:$i.VI.RGB;return null!=this._texture&&(i===eg.Ns.FADING&&this._tile.surface.fadeDuration>0&&this._isTextureVisible(this._texture)||this._texture.descriptor.width!==e||this._texture.descriptor.pixelFormat!==n)&&this.releaseTexture(),null==this._texture&&(this._texture=r(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){this._texture&&(this._texture=(0,p.RY)(this._texture),this.tile.setMemoryDirty())}reuseTexture(e,t){return!(!e||!this._texture||(e.setTextureReference(new Sg(this._texture,eg.Ns.FADING,t,this._textureOpacity,0,1)),0))}get numVerticesPerSideChanged(){return 0!=(this._modifiedFlags&zg)}get samplerDataChanged(){return 0!=(this._modifiedFlags&Gg)}get clippingAreaChanged(){return 0!=(this._modifiedFlags&qg)}get wireframeChanged(){return 0!=(this._modifiedFlags&Zg)}get dirtyEdges(){return this._modifiedFlags>>jg&15}get dirtyCorners(){return this._modifiedFlags>>Wg&15}get dirtyEdgeResolutions(){return this._modifiedFlags>>$g&15}_markCornerDirty(e){const t=1<<e<<Wg;this._modifiedFlags|=t}_markEdgeDirty(e){const t=1<<e<<jg;this._modifiedFlags|=t,this._markCornerDirty((e+0)%4),this._markCornerDirty((e+3)%4)}_markEdgeResolutionDirty(e){const t=1<<e<<$g;this._modifiedFlags|=t,this._markEdgeDirty(e)}_markAllEdgesAndCornersDirty(){this._modifiedFlags|=15<<Wg|15<<jg|15<<$g}updateGeometryState(){const e=this._elevationInfo,t=this.tile,i=e.samplerData?t.getElevationVerticesPerSide(e.maxTileLevel):t.minimumVerticesPerSide,r=Math.max(i,5);let n=t.clippingArea;t.intersectsClippingArea&&!t.withinClippingArea||(n=null);const s=this.geometryState;let a=!1;s.numVerticesPerSide!==r&&(this._modifiedFlags|=1,s.numVerticesPerSide=r,s.samplerDataVersion++,a=!0),e.changed&&(this._modifiedFlags|=2,s.samplerData=e.samplerData,s.samplerDataVersion++,a=!0),(0,Fe.fS)(s.clippingArea,n)||(this._modifiedFlags=4,s.clippingArea=n,a=!0);const o=t.surface.wireframe;return s.wireframe!==o&&(this._modifiedFlags=8,s.wireframe=o,a=!0),this._geometryStateChangedSinceLastUpdate||=a,a&&this._markAllEdgesAndCornersDirty(),this._hasGeometry=!0,this._geometryStateChangedSinceLastUpdate}_createGeometry(e){this.tile.createGeometry();const t=this.geometry.vertexAttributes,i=this.geometry.indices,r=e.gl;this._vao=new Sr.U(e,Og,new Map([["geometry",(0,vr.K)(t.layout)]]),new Map([["geometry",Mr.f.createVertex(e,r.STATIC_DRAW,t.buffer)]]),Mr.f.createIndex(e,r.STATIC_DRAW,i)),this._hasGeometry=!0}get vao(){return this._vao}setTextureReference(e,t=wg.Immediate){e?.texture===this._texture?this._textureOpacity=e.opacities[0]:this.releaseTexture(),this._textureRef.push(e,t)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_isTextureVisible(e){return this._textureRef.current?.texture===e||this._textureRef.next?.texture===e&&this._textureRef.fadeFactor<1}get _elevationInfo(){const e=this.geometryState.samplerData,t=this.tile.layerInfo[hf.ELEVATION],i=t.length,r=new Array(i);let n=0,s=0,a=!1;for(let o=0;o<i;o++){const i=t[o],l=i.upsampleInfo?.tile;if(l){const t=l.layerInfo[hf.ELEVATION][o].data,i=t&&t.samplerData;e&&e[n]===i||(a=!0),r[n++]=i,s=Math.max(s,l.lij[0])}else if(i.data){const t=this.tile.surface.layerViewByIndex(o,hf.ELEVATION);if((0,Eg.W4)(this.tile,t)){const t=i.data;e&&e[n]===t.samplerData||(a=!0),r[n++]=t.samplerData,s=this.tile.level}}}null!=e&&e.length!==n&&(a=!0);const o=n>0,l=o?r:null;return o&&(r.length=n),{changed:a,samplerData:l,maxTileLevel:s}}get estimatedGeometryMemoryUsage(){const e=this.intersectionData?.estimatedMemoryUsage??0;return(this.geometry.indices?.byteLength??0)+(this.geometry.vertexAttributes?.byteLength??0)+e}get texture(){return this._texture}get test(){}checkGeometryWaterproofness(){if(!X_.T9)return;const e=this.tile;if(!e.loaded||!e.intersectsClippingArea||0===e.level)return void(0,X_.Fp)(e?.loaded);const t=e.surface.extent;if(null!=t&&!e.intersectsExtent(t))return;const i=X_.OC.map(((i,r)=>null!=t&&(r<2?-1:1)*(e.extent[3-r]-t[3-r])<0)),r=e.level;(0,X_.Fp)(0===this.dirtyCorners),(0,X_.Fp)(0===this.dirtyEdges),(0,X_.Fp)(0===this.dirtyEdgeResolutions),(0,X_.Fp)(!this.numVerticesPerSideChanged),(0,X_.Fp)(!this.samplerDataChanged),(0,X_.Fp)(!this.clippingAreaChanged),(0,X_.Fp)(!this.wireframeChanged);const n=X_.cA.map((t=>e.findNeighborCornerTileExact(t,(t=>!t.intersectsClippingArea||t.loaded||t.level===e.level))??null)).map((e=>e?.intersectsClippingArea?e:null)),s=this.geometryState;for(let t=0;t<4;++t){const i=s.cornerPeerNeighbors[t],r=n[t];(0,X_.Fp)(r===i,`Tile[${e.lij}].corner[${t}] out of date: cur=[${i?.lij}] exp=[${r?.lij}]`)}X_.OC.forEach(((t,n)=>{if(i[n])return;const s=e.findNeighborTile(t,(e=>(e.level===r||e?.loaded)&&e?.intersectsClippingArea));if(!s){const i=!e.surface.updatingRootTiles&&null!=e.surface.rootTiles&&e.surface.rootTiles.length>0&&e.shouldHaveNeighbor(t);return void(0,X_.Fp)(!i)}(0,X_.Fp)(s.loaded||s.level===e.level),(0,X_.Fp)(s===this.geometryState.edgePeerNeighbors[n]);const a=r-s.level;if(!s.loaded)return(0,X_.Fp)(!s.leaf),void(0,X_.Fp)(0===a);const o=s.renderData;(0,X_.Fp)(e.isEdgeNeighbor(s,t)),(0,X_.Fp)(a>=0);const l=2**a;if(a<0)return void(0,X_.Fp)(!1);const c=e.renderData,h=c.geometry,u=c.localOrigin,d=h.getEdgeCount(n),p=h.numVerticesPerSide-1,m=o.geometry;if(!m)return void(0,X_.Fp)(!1);const f=o.localOrigin,_=this.geometryState.edgePeerNeighbors[n];if(_?.loaded){const e=_.renderData;(0,X_.Fp)(c.geometryState.edgePeerNeighborSamplerVersions[n]===e.geometryState.samplerDataVersion),(0,X_.Fp)(this.geometryState.edgePeerNeighborSamplerVersions[n]===e.geometryState.samplerDataVersion)}const g=(n+2)%4,y=m.getEdgeCount(g),v=d-1,b=y-1;(0,X_.Fp)(v*l===b,`Tile[${e.lij}]:e${n},res=${v} edgeRes mismatch with Neighbor[${s.lij}]:e${g},res=${b} (expected:${v*l})`);const w=e.extent,C=t===vg.X.NORTH||t===vg.X.SOUTH,x=y-1,T=x>>a,S=d-1;if(T<1)return void(0,X_.Fp)(1===S);(0,X_.Fp)(T===S),(0,X_.Fp)((0,st.wt)(T));const M=m.numVerticesPerSide-1;(0,X_.Fp)(a>0||T===Math.max(M,p));const E=e.getNeighborEdgeStartVertexIndex(n,s);(0,X_.Fp)(0<=E&&E<l);const P=E*T;(0,X_.Fp)(0<=P&&P<=x-T);let A=0,O=P;h.getEdgeVertexPosition(n,Ig,u,0),h.getEdgeVertexPosition(n,Lg,u,d-1);const D=(0,Pi.j)(Ig,Lg),I=Math.max(kg,1e-4*D);for(let i=0;i<=T;++i){h.getEdgeVertexPosition(n,Ig,u,A),m.getEdgeVertexPosition(g,Lg,f,O);const r=i/T,a=C?w[0]+r*(w[2]-w[0]):t===vg.X.WEST?w[0]:w[2],l=C?t===vg.X.SOUTH?w[1]:w[3]:w[1]+r*(w[3]-w[1]),p=e.surface.extent;if(null==p||(0,H.jE)(p,a,l)){const t=(0,Pi.F)(Ig,Lg),i=(0,Pi.H)(Ig)-_i.sv.radius,r=(0,Pi.H)(Lg)-_i.sv.radius,_=t<I;if(!_){console.warn(`Tile edge vertex position mismatch: between [${e.lij}].edge${n}[${A}/${d}] and [${s.lij}].edge${g}[${O}/${y}]`),null!=p&&console.warn("  surface extent= ",p," x,y=",a,",",l);const v=(0,R.Ue)();(0,Pi.d)(v,c.localOrigin,o.localOrigin),(0,Pi.H)(v)>0&&console.warn(`   localOrigins: ${c.localOrigin} vs ${o.localOrigin} d=${(0,Pi.H)(v)} [${v}]`),(()=>{const t=(0,R.d9)(Ig),i=(0,R.d9)(Lg);e.updateEdgeElevations(),s.updateEdgeElevations(),h.getEdgeVertexPosition(n,Ig,u,A),m.getEdgeVertexPosition(g,Lg,f,O);const r=(0,R.Ue)();(0,Pi.a)(r,Ig,t),(0,Pi.H)(r)>0&&console.warn(`  XXX Tile[${e.lij}] edge out of date: ${t} vs ${Ig} d=${(0,Pi.H)(r)} [${r}]`),(0,Pi.a)(r,Lg,i),(0,Pi.H)(r)>0&&console.warn(`  XXX Neighbor[${s.lij}] edge out of date: ${i} vs ${Lg} d=${(0,Pi.H)(r)} [${r}]`)})();const b=h.getEdgeCount(n),w=m.getEdgeCount(y);(0,X_.Fp)(_,`Mismatch in tile [${e.lij}].edge[${n}][${A}/${b}] vs neighbor [${s.lij}].edge[${g}][${O}/${w}] ${(0,X_.zT)(Ig)} vs ${(0,X_.zT)(Lg)}  dist=${t} h(t|n|d)=${i}|${r}|${r-i}`)}h.getEdgeNormal(n,Ng,A),m.getEdgeNormal(g,Fg,O),(0,Pi.n)(Ug,Ng),(0,Pi.n)(Hg,Fg);const v=(0,Pi.e)(Ug,Hg),b=1-v<.01||e===s;if(!b){const t=(0,R.Ue)();(0,Pi.a)(t,Ng,Fg);const i=()=>`Mismatch in tile edge normal ${(0,X_.sP)(e.lij)} (${A}/${d-1}) edge ${n} vs neighbor ${(0,X_.sP)(s.lij)}  (${O}/${y-1}) nedge ${g} :${(0,X_.zT)(Ng)} vs ${(0,X_.zT)(Fg)}  dot = ${v} : ${(0,X_.zT)(t)}`;console.warn("Mismatch in tile edge normal: ",i());{e.updateEdgeElevations(),s.updateEdgeElevations();const t=(0,R.Ue)(),i=(0,R.Ue)();h.getEdgeNormal(n,t,A),m.getEdgeNormal(g,i,O),(0,Pi.G)(Ng,t)||console.warn("Missing update in tile normal: ",(0,X_.zT)(Ng)," => ",(0,X_.zT)(t)),(0,Pi.G)(Fg,i)||console.warn("Missing update in neighbor normal: ",(0,X_.zT)(Fg)," => ",(0,X_.zT)(i))}(0,X_.Fp)(b,i())}}A+=1,O+=1}}))}}const Ig=(0,R.Ue)(),Lg=(0,R.Ue)(),Ng=(0,R.Ue)(),Fg=(0,R.Ue)(),Ug=(0,R.Ue)(),Hg=(0,R.Ue)(),kg=1,Vg=[null,null,null,null];function Bg(e,t){return t?.loaded||t===e?t:null}const zg=1,Gg=2,qg=4,Zg=8,jg=4,Wg=8,$g=12,Xg=[0,1,2,3];class Yg{get updating(){return!!this._tileRequested}init(e,t,i,r){this.tile=e,this._layerIdx=t,this._layerClass=i,this._suspended=r,this._tileLayerInfo=e.getLayerInfo(t,i),this._tileRequested=null;const n=this._findAncestorWithData();this._setUpsampleTile(n)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e,t){this._setUpsampleTile(e,t),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass,eg.Ns.FADING,t):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return null!=e?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){const e=this._layerIdx,t=this._layerClass,i=this.tile.surface.layerViewByIndex(e,t),{minLevel:r,maxLevel:n}=i.dataLevelRange,s=this._desiredMinLevelDelta,a=this._progressiveLevelModulo+s,o=this._scaleRangeEnabled?Eg.W4:()=>!0;let l=this.tile;const c=l.level;let h;const u=this._tileLayerInfo.upsampleInfo,d=u?.tile?.level??-1,p=null!=u&&d-c>=s,m=(0,Eg.Ay)(i),f="vector-tile-3d"===i.type?i.schemaHelper:null;for(;l&&o(l,i)&&l.level>=r;){const i=l.level,o=c-i,u=l.layerInfo[t][e];if(u.data&&o>=s){(!p||i>d)&&this._setUpsampleTile(l),u.dataInvalidated&&(h=l);break}const _=f?.getLevelRowColumn(l.lij)??l.lij;if("unavailable"!==m?.getAvailability(_[0],_[1],_[2])&&i<=n&&!u.data&&!u.dataMissing&&((!h||l.level===r||i%ce.GZ==0||c-h.level<s)&&(h=l),o>=a))break;l=l.parent}if(null!=h&&c-h.level<s)if(u)h=null;else{const i=this._findAncestorWithData();null!=i&&(this._setUpsampleTile(i),h=i.layerInfo[t][e].dataInvalidated?i:null)}return h}_findAncestorWithData(){const e=this.tile.elevationLevel,t=this._desiredMinLevelDelta;let i;for(let r=this.tile;r;r=r.parent)if(r.hasLayerData(this._layerIdx,this._layerClass)){if(e-r.level>=t)return r;i=r}return i}_setUpsampleTile(e,t){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass,eg.Ns.FADING,t)}get test(){}}const Kg=new Error("Abstract method called on TileAgent"),Qg=new class extends Yg{constructor(){super(...arguments),this.type="none"}get _desiredMinLevelDelta(){throw Kg}get _progressiveLevelModulo(){throw Kg}dispose(){}};var Jg;!function(e){e[e.INSIDE=0]="INSIDE",e[e.INTERSECTS=1]="INTERSECTS",e[e.OUTSIDE=2]="OUTSIDE"}(Jg||(Jg={}));class ey{constructor(){this.waitingAgents=new cd.Z,this.pendingUpdates=0}static acquire(e){const t=ty.acquire();return t._init(e),t}release(){this.dispose(),iy.delete(this),ty.release(this)}dispose(){this.loadingAgent=(0,p.M2)(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=(0,X_.ep)(this._data)}static prune(){ty.prune(0)}_init(e){this.waitingAgents.clear(),this._data=(0,X_.ep)(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=e,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=(0,p.IM)(this.requestAbort),this.requestPromise=null}_unsetUpsampleInfo(){this.upsampleInfo&&(this.upsampleInfo.tile?.unrefMapData(),this._pool.release(this.upsampleInfo),this.upsampleInfo=null)}setUpsampleInfo(e,t){if(e!==t&&null!=t){if(null==this.upsampleInfo)this.upsampleInfo=this._pool.acquire();else{if(this.upsampleInfo.tile===t)return;this.upsampleInfo.tile?.unrefMapData()}t.refMapData(),(0,Eg.QT)(e,t,this.upsampleInfo)}else this._unsetUpsampleInfo()}get data(){return this._data}set data(e){(0,X_.ep)(this._data),this._data=e}}const ty=new V_.Z(ey,null,(()=>{})),iy=new Map;var ry;!function(e){e[e.NONE=0]="NONE",e[e.SPLIT=1]="SPLIT",e[e.ELEVATION=2]="ELEVATION",e[e.MERGE=4]="MERGE",e[e.GEOMETRY=8]="GEOMETRY",e[e.TEXTURE_NOFADING=16]="TEXTURE_NOFADING",e[e.TEXTURE_FADING=32]="TEXTURE_FADING"}(ry||(ry={}));class ny{constructor(){this._lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this._dirty=!0,this._previouslyRendered=!1,this.extent=(0,H.Ue)(),this._elevationBoundsMin=NaN,this._elevationBoundsMax=0,this.layerInfo=[[],[]],this.extentInRadians=(0,H.Ue)(),this.centerAtSeaLevel=(0,R.Ue)(),this._center=[(0,R.Ue)(),(0,es.c)(),(0,R.Ue)()],this.up=(0,R.tN)(),this._withinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=0,this._rasterTileMemory=0,this._vectorTileMemory=0,this._mapDataRefCount=0,this.screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0,this.onCompressionFinished=()=>{this.setPendingUpdate(ry.TEXTURE_NOFADING),this.setMemoryDirty()},this.extentMidX=0,this.extentMidY=0,this.distanceToPOI=-1,this._lastPOI=(0,R.Ue)(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0}get lij(){return this._lij}get spatialReference(){return this._surface.spatialReference??this._surface.tilingScheme.spatialReference}get elevationLevelDelta(){return this._surface.getElevationLevelDelta(this.level)}static prune(){oy.prune(0),ly.prune(0),ey.prune()}get _cached(){return!this.leaf&&this._mapDataRefCount<=0}get withinClippingArea(){return this._withinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBoundsMin(){return this._elevationBoundsMin}get elevationBoundsMax(){return this._elevationBoundsMax}get level(){return this._lij[0]}get key(){return`${this._lij[0]}/${this._lij[1]}/${this._lij[2]}`}get edgeLen(){return this._edgeLen}get radius(){return this._center[hy.MIDDLE][3]}get visible(){return this._dirty&&this.computeVisibility(),this._visible}get frustumVisibility(){return this._dirty&&this.computeVisibility(),this._frustumVisibility}computeVisibility(){this._dirty=!1;const e=this.parent?.frustumVisibility??Jg.INTERSECTS;this._frustumVisibility=e===Jg.INSIDE?Jg.INSIDE:e===Jg.OUTSIDE?Jg.OUTSIDE:this._calculateFrustumVisibility(this.surface.frustum);const t=this._frustumVisibility!==Jg.OUTSIDE&&this._intersectsClippingArea;t!==this._visible&&(this._visible=t,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setDirty(),this.updateAgentSuspension())}get _loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setDirty()),e}init(e,t,i,r,n){this._lij[0]=e,this._lij[1]=t,this._lij[2]=i,this.ellipsoid=(0,Ii.Iu)(n.tilingScheme.spatialReference),n.tilingScheme.getExtent(e,t,i,this.extent),n.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this.extentMidX=.5*(this.extent[0]+this.extent[2]),this.extentMidY=.5*(this.extent[1]+this.extent[3]),this._withinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,n.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[hy.MIDDLE][3]=0,this.elevationLevel=e,r&&!Number.isNaN(r.elevationBoundsMin)?(this._elevationBoundsMin=r.elevationBoundsMin,this._elevationBoundsMax=r.elevationBoundsMax):(this._elevationBoundsMin=0,this._elevationBoundsMax=0),this._pendingUpdates=0,this.renderData=null,this.screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=r,this.clearChildren(),this._surface=n,this.updateVisibility(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0;for(const e of uf){const t=n.numLayers(e),i=this.layerInfo[e];for(const e of i)e.release();i.length=t;for(let r=0;r<t;r++)i[r]=ey.acquire(this._surface.upsampleInfoPool),e===hf.ELEVATION&&this.findElevationBoundsForLayer(r,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(n.tilingScheme.pixelSize,ce.Cf)}dispose(){null!=this._surface&&((0,X_.wu)(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(this.key),this.layerInfo.forEach((e=>{e.forEach((e=>e.release())),e.length=0})),this._surface=this._parent=null,this.clearChildren(),this.setMemoryDirty())}refMapData(){++this._mapDataRefCount,this._cached||this._surface.upsampleMapCache.pop(this.key)}unrefMapData(){--this._mapDataRefCount,this._cached&&this.cachedMemory>0&&this._surface.upsampleMapCache.put(this.key,this)}setMemoryDirty(){this._usedMemory=0}get usedMemory(){return this._ensureUsedMemory()+(this._cached?0:this._mapTileMemory)}get cachedMemory(){return this._ensureUsedMemory(),null==this._surface?this.usedMemory:this._cached?this._mapTileMemory:0}get _mapTileMemory(){return this._rasterTileMemory+this._vectorTileMemory}get _cpuImageMemorySize(){const e=this._surface.tilingScheme.pixelSize;return e*e*4}_ensureUsedMemory(){if(this._usedMemory>0)return this._vectorTileMemory=this.layerInfo[hf.MAP].reduce(((e,{data:t})=>e+((0,Df.AK)(t)?t.usedMemoryPerReference:0)),0),this._usedMemory;this._usedMemory=this._baseUsedMemory,this._rasterTileMemory=0,this._vectorTileMemory=0;for(const{data:e}of this.layerInfo[hf.MAP])(0,Df.AK)(e)?this._vectorTileMemory+=e.usedMemoryPerReference:this._rasterTileMemory+=this.getTerrainDataMemory(e);for(const e of this.layerInfo[hf.ELEVATION])this._usedMemory+=e.data?this._cpuImageMemorySize:0;return this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._rasterTileMemory+=this.renderData.texture?.cachedMemory??0),this._cached&&this._surface.upsampleMapCache.updateSize(this.key,this),this._usedMemory}getUsedMemoryForLayer(e,t){const i=this.layerInfo[e][t];return i?.data?e===hf.MAP?this._cached?0:this.getTerrainDataMemory(i.data):e===hf.ELEVATION?this._cpuImageMemorySize:0:0}getTerrainDataMemory(e){return(0,Df.Q_)(e)?e.texture.usedMemory:(0,Df.yd)(e)?e.memoryUsage:(0,Df.AK)(e)?e.usedMemoryPerReference:(0,Df.Cm)(e)||e instanceof HTMLImageElement?this._cpuImageMemorySize:0}updateScreenDepth(e){const t=this._center[hy.MIDDLE],i=e,r=t[0],n=t[1],s=t[2],a=i[2]*r+i[6]*n+i[10]*s+i[14];this.screenDepth=a<0?0:a/(i[3]*r+i[7]*n+i[11]*s+i[15])}shouldSplit(e,t,i){if(!this.visible)return ry.NONE;if(e.frustum&&(!this._intersectsClippingArea||this._calculateFrustumVisibility(e.frustum)===Jg.OUTSIDE))return ry.NONE;const r=this.level;(0,Pi.d)(_y,(0,es.a)(this._center[hy.MIDDLE]),t);let n=(0,Pi.k)(_y),s=_y,a=(0,es.a)(this._center[hy.MIDDLE]);(0,Pi.d)(gy,this._center[hy.TOP],t);const o=(0,Pi.k)(gy);o<n&&(n=o,s=gy,a=this._center[hy.TOP]),(0,Pi.d)(yy,this._center[hy.BOTTOM],t);const l=(0,Pi.k)(yy);if(l<n&&(n=l,s=yy,a=this._center[hy.BOTTOM]),this._edgeLen2>n&&r<e.maxLod)return ry.SPLIT;const c=Math.sqrt(n),h=e.fovX*c*2,u=this._edgeLen/h,d=()=>{if(r<e.maxLod)return this.elevationLevel=r,ry.NONE;const t=r+Math.ceil(-Math.log2(e.relativeWidthLimit/u));return t!==this.elevationLevel?(this.elevationLevel=t,ry.ELEVATION):ry.NONE},p=null!=i?i-r:1/0;if(p<=.5)return d();const m=(0,Pi.e)(this.up,_y),f=this._elevationBoundsMax-this._elevationBoundsMin,_=f/this.edgeLen;if(e.aboveGround&&m>0&&_<.001&&m/c-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-_>0)return ry.NONE;const g=null!=i?3-Math.min(p,2):1;if(u*g<e.relativeWidthLimit||r>=e.maxLod)return d();if(r<7)return ry.SPLIT;(0,Pi.g)(vy,this.up,m),(0,Pi.d)(vy,vy,s);const y=(0,Pi.k)(vy);if(y<=this.radius*this.radius)return ry.SPLIT;(0,Pi.g)(vy,vy,this.radius/Math.sqrt(y)),(0,Pi.f)(vy,vy,a),(0,Pi.d)(vy,t,vy);const v=Math.min(1,(Math.abs((0,Pi.e)(vy,this.up))+.5*f+this._curvatureHeight)/(0,Pi.l)(vy)),b=.1/e.angledSplitBias,w=e.fovY*c*2;return v*(this._edgeLen/w*g)<b*e.relativeHeightLimit?ry.NONE:ry.SPLIT}createChildren(){const e=this._children,t=this.lij[0]+1,i=2*this.lij[1],r=2*this.lij[2];return e[0]=this.surface.createTile(t,i,r,this),e[1]=this.surface.createTile(t,i,r+1,this),e[2]=this.surface.createTile(t,i+1,r,this),e[3]=this.surface.createTile(t,i+1,r+1,this),e}clearChildren(){this._children[0]=this._children[1]=this._children[2]=this._children[3]=null}get loaded(){return this.renderData?.hasGeometry??!1}load(){this.refMapData();for(const e of uf)this._createOrUpdateAgents(0,e);this.surface.renderer.loadTile(this)}unload(){this.renderData&&this.unrefMapData(),this.surface.renderer.unloadTile(this);for(const e of uf){const t=this.layerInfo[e];for(const e of t)e.loadingAgent&&e.loadingAgent!==Qg&&(ay(e.loadingAgent),e.loadingAgent=null),e.pendingUpdates=0}this.resetPendingUpdate(ry.GEOMETRY),this.resetPendingUpdate(ry.TEXTURE_NOFADING),this.resetPendingUpdate(ry.TEXTURE_FADING)}unloadMapData(){const e=this.layerInfo[hf.MAP];for(const t of e)t.loadingAgent&&t.loadingAgent!==Qg&&(ay(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0,t.invalidateSourceData();this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(e){if((0,H.fS)(e,this._clippingArea))return!1;const t=this._intersectsClippingArea,i=this._withinClippingArea;null!=e?(this._intersectsClippingArea=this.intersectsExtent(e),this._withinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._withinClippingArea=!0),this._clippingArea=e,this.updateVisibility();const r=i&&this._withinClippingArea,n=!(i||t||this._withinClippingArea||this._intersectsClippingArea);return!this.renderData||r||n||this.setPendingUpdate(ry.GEOMETRY),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(e,t){return this.layerInfo[t][e]}hasLayerData(e,t){const i=this.layerInfo[t][e];return!(!i?.data||i.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(const e of uf){const t=this.layerInfo[e];for(const e of t)if(e.loadingAgent&&e.loadingAgent!==Qg&&e.loadingAgent.updating)return!0}return!1}_isSuspended(e){return!!this.hasPendingUpdate(ry.SPLIT)||e!==hf.ELEVATION&&!this._loadable}get hasPendingUpdates(){return 0!==this._pendingUpdates}hasPendingUpdate(e){return(this._pendingUpdates&e)===e}setPendingUpdate(e){const t=this._pendingUpdates;return this._pendingUpdates|=e,e===ry.SPLIT||e===ry.MERGE?this._surface.setTileTreeDirty():this._surface.requestUpdate(),t!==this._pendingUpdates}resetPendingUpdate(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}requestLayerData(e,t,i){const r=this.layerInfo[t][e];if(r.waitingAgents.has(i))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),i.tile.lij.toString(),t,e),!0;if(r.waitingAgents.push(i),r.data&&!r.dataInvalidated){console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),i.tile.lij.toString(),t,e);const n=(0,Df.AK)(r.data);return i.dataArrived(this,n),!0}if(r.requestPromise)return!0;(0,p.IM)(r.requestAbort),r.requestAbort=new AbortController;const n=this._surface.requestTileData(this,e,t,r.requestAbort);if(!n)return r.requestAbort=null,!1;const s=()=>{r.requestPromise===n&&(r.requestPromise=null,r.requestAbort=null)};return r.requestPromise=n,n.then(s,s),!0}get leaf(){return null==this._children[0]}hasLij(e){return this._lij[0]===e[0]&&this._lij[1]===e[1]&&this._lij[2]===e[2]}findByLij(e){if(this.hasLij(e))return this;const t=this._children;return t[0]?t[0].findByLij(e)||t[1].findByLij(e)||t[2].findByLij(e)||t[3].findByLij(e):null}distanceToSquared(e){return(0,Pi.k)((0,Pi.d)(vy,(0,es.a)(this._center[hy.MIDDLE]),e))}containsPoint(e){const t=this.extent;return e[0]>=t[0]&&e[1]>=t[1]&&e[0]<=t[2]&&e[1]<=t[3]}containsPointXY(e,t){const i=this.extent;return e>=i[0]&&t>=i[1]&&e<=i[2]&&t<=i[3]}unrequestLayerData(e,t,i){const r=this.layerInfo[t][e],n=r.waitingAgents,s=null!=n.removeUnordered(i);(0,X_.wu)(s,"agent has not requested this piece of map data"),n.length<1&&(r.abortRequest(),this.setMemoryDirty())}dataArrived(e,t,i){const r=(0,Df.AK)(i),n=this.layerInfo[t][e];n.data=i,n.dataInvalidated=!1,n.waitingAgents.forAll((e=>e.dataArrived(this,r))),n.waitingAgents.clear(),this.setMemoryDirty()}dataMissing(e,t){const i=this.layerInfo[t][e];i.dataMissing=!0,i.waitingAgents.forAll((e=>e.dataMissing())),i.waitingAgents.clear(),this.setMemoryDirty()}updateRenderData(e,t,i){switch(i&&this.forEachLoadedNeighbor((i=>i.updateRenderData(e,t))),e){case hf.MAP:return this._updateTexture(t);case hf.ELEVATION:return this._updateGeometry()}}_updateTexture(e){this.renderData&&(this.resetPendingUpdate(e===eg.Ns.FADING?ry.TEXTURE_NOFADING:ry.TEXTURE_FADING),this.setPendingUpdate(e===eg.Ns.FADING?ry.TEXTURE_FADING:ry.TEXTURE_NOFADING))}_updateGeometry(){this.setPendingUpdate(ry.GEOMETRY);for(const e of this.layerInfo[hf.ELEVATION])e.pendingUpdates|=ry.GEOMETRY}invalidateLayerData(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)}computeElevationBounds(){const e=this._elevationBoundsMin,t=this._elevationBoundsMax;let i=1/0,r=-1/0;const n=this.layerInfo[hf.ELEVATION];let s=!0;for(const e of n)null!=e.elevationBounds&&(i=Math.min(i,e.elevationBounds.min),r=Math.max(r,e.elevationBounds.max),e.elevationBounds.hasNoDataValues||(s=!1));s&&(i=Math.min(i,0),r=Math.max(r,0)),e===i&&t===r||(this._elevationBoundsMin=i,this._elevationBoundsMax=r,this.updateRadiusAndCenter(),this._surface.setTileTreeDirty())}_updateCenter(){const e=this._elevationBoundsMin,t=this._elevationBoundsMax,i=.5*(e+t),r=this._center;(0,Pi.g)(vy,this.up,i),(0,Pi.f)((0,es.a)(r[hy.MIDDLE]),this.centerAtSeaLevel,vy),(0,Pi.g)(vy,this.up,e),(0,Pi.f)(r[hy.TOP],this.centerAtSeaLevel,vy),(0,Pi.g)(vy,this.up,t),(0,Pi.f)(r[hy.BOTTOM],this.centerAtSeaLevel,vy)}findElevationBoundsForLayer(e,t){const i=this.layerInfo[hf.ELEVATION][e],r=this.elevationLevelDelta,n=Math.max(this.elevationLevel-r,0),s=i.elevationBounds;if(null!=s&&s.level>=t&&s.level<=n)return;const a=this._surface.layerViewByIndex(e,hf.ELEVATION);if(!(0,Eg.W4)(this,a))return;const o=cy;let l=!1;const c=i.data;if(c&&c.level<=n){const e=i.data;o.min=e.samplerData.data.minValue,o.max=e.samplerData.data.maxValue,o.hasNoDataValues=e.samplerData.data.hasNoDataValues,o.level=this.level,l=!0}else{let t,i,s=0;for(let a=this._parent;a&&(!i||s<r)&&(s=this.elevationLevel-a.level,t=i||t,i=a.layerInfo[hf.ELEVATION][e].data,!(!i&&t&&a.level<=n));a=a.parent);i=i||t,i&&(i.computeMinMaxValue(this._lij[0],this._lij[1],this._lij[2],o),o.min!==1/0&&(o.level=i.level,l=!0))}l&&(null==i.elevationBounds&&(i.elevationBounds=new q_),i.elevationBounds.copyFrom(o))}modifyLayers(e,t,i){const r=this.layerInfo[i];for(const e of r)e.loadingAgent&&e.loadingAgent!==Qg&&(ay(e.loadingAgent),e.loadingAgent=null),e.waitingAgents.clear();for(let t=0;t<r.length;++t)void 0===e[t]&&r[t].release();const n=new Array(...r),s=t.length;r.length=s;for(let e=0;e<s;e++){const i=t[e];r[e]=i>-1?n[i]:ey.acquire(this._surface.upsampleInfoPool)}this.setMemoryDirty()}restartAgents(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e,eg.Ns.FADING))}updateAgents(e){if(this.renderData){const t=this.layerInfo[e];for(const e of t)e.loadingAgent===Qg&&(e.loadingAgent=null);this._createOrUpdateAgents(0,e)}}updateAgentSuspension(){for(const e of uf){const t=this._isSuspended(e);for(const i of this.layerInfo[e])i.loadingAgent&&i.loadingAgent!==Qg&&(i.loadingAgent.setSuspension(t),i.loadingAgent===Qg&&this.updateRenderData(e,eg.Ns.FADING))}}removeLayerAgent(e,t){const i=this.layerInfo[t][e];i.loadingAgent&&i.loadingAgent!==Qg&&i.loadingAgent.dispose(),i.loadingAgent=null}agentDone(e,t){const i=this.layerInfo[t][e];i.loadingAgent=Qg,i.data||null!=i.upsampleInfo||this._createOrUpdateAgents(e+1,t)}_hasBlendableAncestor(e){return"normal"!==e.blendMode||(0,B.CY)(e.parent)&&this._hasBlendableAncestor(e.parent)}_hasBlendModes(e,t,i){for(let r=e;r<t;++r){const e=this._surface.layerViewByIndex(r,i);if((0,X_.TK)(e)&&"normal"!==e?.layer?.blendMode||(0,B.CY)(e?.layer?.parent)&&this._hasBlendableAncestor(e?.layer?.parent))return!0}return!1}_createOrUpdateAgents(e,t){const i=this.layerInfo[t];if(0===i.length)return;const r=this._isSuspended(t);for(let n=e;n<i.length;++n){const s=i[n],a=this._surface.layerViewByIndex(n,t);let o=!1;if(s.loadingAgent?(0,Eg.W4)(this,a)?(s.loadingAgent!==Qg&&s.loadingAgent.setSuspension(r),s.loadingAgent!==Qg&&(o=s.loadingAgent.update())):s.dispose():(0,Eg.W4)(this,a)&&(s.loadingAgent=sy(this,n,t,r),o=s.loadingAgent.startLoading(),o?s.loadingAgent===Qg&&this.setPendingUpdate(ry.GEOMETRY):(ay(s.loadingAgent),s.loadingAgent=Qg)),s.loadingAgent===Qg&&this.updateRenderData(t,eg.Ns.FADING),!this._hasBlendModes(e,i.length,t)&&o&&a.isOpaque)return}}_isWithinExtent(e){const t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]}intersectsExtent(e){const t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]}getElevationVerticesPerSide(e){const t=this.elevationLevel-this.level,i=Math.max(this.level-e,this.elevationLevelDelta-t),r=(0,st.uZ)(1+(this._maxTesselation>>i),2,this._maxTesselation+1),n=this.minimumVerticesPerSide;return Math.max(r,n)}_findLIJ(e,t){if(!e)return null;const i=this.surface.rootTiles;if(null!=i)for(const r of i)if(uy(r,e)){let i=r,n=e[0]-i.level-1;for(;n>=0&&!i.leaf&&!t(i);){const t=e[1]>>n&1,r=e[2]>>n&1;i=i.children[2*t+r],n--}return t(i)?i:null}return null}findNeighborTile(e,t){const i=this._lij,r=this._getNeighborLIJ(i,e);return r?dy(i,r)?t(this)?this:null:this._findLIJ(r,t):null}findCorner(e,t){const i=e===vg.X.NORTH_EAST?1:e===vg.X.NORTH_WEST?0:e===vg.X.SOUTH_WEST?2:3;let r=this;for(;r.children[0]&&(!t||!t(r));)r=r.children[i];return r}findNeighborCornerTileExact(e,t){return this.findNeighborTile(e,(e=>t(e)||e.level===this.level))?.findCorner((0,X_.$v)(e),t)||null}forAllSubtreeOnSide(e,t){const i=e===vg.X.NORTH?[0,1]:e===vg.X.NORTH_EAST?[1]:e===vg.X.EAST?[1,3]:e===vg.X.SOUTH_EAST?[3]:e===vg.X.SOUTH?[2,3]:e===vg.X.SOUTH_WEST?[2]:e===vg.X.WEST?[0,2]:[0],r=e=>{const n=e.children;!t(e)&&n[0]&&i.forEach((e=>r(n[e])))};r(this)}getNeighborEdgeStartVertexIndex(e,t){if(!t)return 0;const i=this.level-t.level;if((0,X_.Fp)(!X_.T9||i>=0),0===i)return 0;const r=2**i,n=!(1&~e),s=n?0:1,a=t.lij[s+1]*r,o=this._lij[s+1],l=o-a,c=n?r-1-l:l;return X_.T9&&((0,X_.Fp)(a<=o&&o<a+r),(0,X_.Fp)(0<=c&&c<r)),c}forEachLoadedNeighbor(e){const t=this.level,i=e=>e.level===t||e.loaded;X_.OC.forEach((t=>{const r=this.findNeighborTile(t,i);null!=r&&r!==this&&r.forAllSubtreeOnSide((0,X_._F)(t),(i=>!!i.loaded&&(e(i,t),!0)))})),X_.cA.forEach((t=>{const r=this.findNeighborTile(t,i)?.findCorner((0,X_.$v)(t),(e=>e.loaded));(0,X_.Fp)(!r||py(this,r,t)),r?.loaded&&e(r,t)}))}_getNeighborLIJ(e,t){const i=(0,X_.Mw)(t)?-1:(0,X_.uv)(t)?1:0,r=(0,X_.OD)(t)?-1:(0,X_.Eu)(t)?1:0,n=[e[0],e[1]+i,e[2]+r];return n[1]<0?null:this.surface.isGlobal?this._wrapLIJ(n):n[2]<0?null:n}_wrapLIJ(e){return!e||e[1]<0||e[1]>=2**e[0]?null:this.surface.wrapEastWest(e)}isEdgeNeighbor(e,t){if(null==e)return!1;if(0===this.level&&0===e.level){if(this._eastEnd&&e._westEnd&&t===vg.X.EAST)return!0;if(this._westEnd&&e._eastEnd&&t===vg.X.WEST)return!0}const i=Math.max(1e-6*(this.extent[2]-this.extent[0]),1);switch(t){case vg.X.NORTH:return(0,X_.Wq)(this.extent[3],e.extent[1],i);case vg.X.SOUTH:return(0,X_.Wq)(this.extent[1],e.extent[3],i);case vg.X.EAST:return(0,X_.Wq)(this.extent[2],e.extent[0],i)||(0,X_.Wq)(this.extent[2],-e.extent[0],i);case vg.X.WEST:return(0,X_.Wq)(this.extent[0],e.extent[2],i)||(0,X_.Wq)(this.extent[0],-e.extent[2],i)}}get _eastEnd(){return this._lij[2]===this.surface.lijEastEnd(this.level)-1}get _westEnd(){return 0===this._lij[2]}checkGeometryWaterproofness(){X_.V0&&((0,X_.Fp)(this.loaded),this.renderData?.checkGeometryWaterproofness())}shouldHaveNeighbor(e){const t=this.extent,i=this.surface.rootTilesExtent,r=.25*(t[2]-t[0]);if((0,X_.Mw)(e)&&t[3]+r>=i[3])return!1;if((0,X_.uv)(e)&&t[1]-r<=i[1])return!1;const n=this.surface.isGlobal;return!(!n&&(0,X_.OD)(e)&&t[0]-r<=i[0]||!n&&(0,X_.Eu)(e)&&t[2]+r>=i[2])}updateDistanceToPOI(e){const t=this._lastPOI;if(this.distanceToPOI>=0&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return;(0,Pi.c)(this._lastPOI,e);const i=this._center[hy.MIDDLE],r=e[0]-i[0],n=e[1]-i[1],s=e[2]-i[2];this.distanceToPOI=r*r+n*n+s*s}}function sy(e,t,i,r){const n=i===hf.ELEVATION?ly.acquire():oy.acquire();return n.init(e,t,i,r),n}function ay(e){e.dispose(),function(e){return"elevation"===e.type}(e)?ly.release(e):function(e){return"map"===e.type}(e)&&oy.release(e)}const oy=new V_.Z(class extends Yg{constructor(){super(),this.type="map",this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return ce.GZ}}),ly=new V_.Z(class extends Yg{constructor(){super(...arguments),this.type="elevation",this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return this.tile.elevationLevelDelta-(this.tile.elevationLevel-this.tile.level)}get _progressiveLevelModulo(){return 0}}),cy=new q_;var hy;function uy(e,t){const i=e.lij,r=t[0]-i[0];return!(r<0)&&t[1]>>r===i[1]&&t[2]>>r===i[2]}function dy(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function py(e,t,i){return null!=e&&null!=t&&t!==e&&(e.level>=t.level?my(e,t,i):my(t,e,(0,X_.$v)(i)))}function my(e,t,i){(0,X_.Fp)(e.level>=t.level);const r=(0,X_._0)(i),n=(0,X_.wt)(i),s=e.extent,a=t.extent,o=[r?s[0]:s[2],n?s[3]:s[1]],l=[r?a[2]:a[0],n?a[1]:a[3]],c=1e-5*(s[2]-s[0]),h=(0,X_.Wq)(o[0],l[0],c)||e.surface.isGlobal&&(0,X_.Wq)(o[0],-l[0],c),u=(0,X_.Wq)(o[1],l[1],c);if(h&&u)return!0;if(e.level===t.level)return(0,X_.Fp)(!1),!1;if(!h&&!u)return(0,X_.Fp)(!1),!1;const d=h?fy(a[1],a[3],s[1],s[3],c):fy(a[0],a[2],s[0],s[2],c);return(0,X_.Fp)(d),d}function fy(e,t,i,r,n){return e-n<=i&&i<=r&&r<=t+n}!function(e){e[e.TOP=0]="TOP",e[e.MIDDLE=1]="MIDDLE",e[e.BOTTOM=2]="BOTTOM"}(hy||(hy={}));const _y=(0,R.Ue)(),gy=(0,R.Ue)(),yy=(0,R.Ue)(),vy=(0,R.Ue)();function by(e,t){const{tile:i,geometry:r,geometryState:n}=e,{extentInRadians:s,surface:a}=i,{isWebMercator:o,renderer:l}=a,{numVerticesPerSide:c,wireframe:h}=n,u=c-1,d=(c-2)**2,p=o&&(t===eg.tk.HAS_SOUTH_POLE||t===eg.tk.HAS_BOTH_POLES),m=o&&(t===eg.tk.HAS_NORTH_POLE||t===eg.tk.HAS_BOTH_POLES),f=((p?1:0)+(m?1:0))*Jy*c,_=Yy(n),g=d+f+4*_,y=l.tileGeometryCache.acquire(g);r.numVerticesPerSide=c,r.vertexAttributes=y,r.maxEdgeVertexCount=_;const{boundingBox:v}=r;(0,fc.cS)(v);const b=Sy(e);Gy.update(u,s,b),function(e){const{tile:t}=e;if(!t.intersectsClippingArea)return;const{geometry:i,geometryState:r,localOrigin:n}=e,{numVerticesPerSide:s,samplerData:a}=r,o=s-2,l=s-1,{vertexAttributes:c,boundingBox:h}=i,{position:u,uv0:d}=c,{typedBuffer:p,typedBufferStride:m}=c.normalCompressed,{extent:f}=t,_=f[0],g=f[2],y=f[1],v=f[3],b=t.ellipsoid.radius,w=n[0],C=n[1],x=n[2],T=u.typedBuffer,S=u.typedBufferStride,M=1/l;let E=0;if(1<=o){const e=M,t=y*(1-e)+v*e,i=Gy.sinLatLUT[1],r=Gy.cosLatLUT[1];for(let n=1;n<=o;n++){const s=n*M,o=_*(1-s)+g*s,l=Gy.sinLonLUT[n],c=Gy.cosLonLUT[n],u=b+$_(o,t,a),p=u*c*r-w,m=u*l*r-C,f=u*i-x;Xy(p,m,f,h);const y=(n-1)*S;T[y]=p,T[y+1]=m,T[y+2]=f,d.setValues(n-1,Math.round(s*yg.rU),Math.round(e*yg.rU))}}for(let e=1;e<=o;e++){const t=e*M,i=y*(1-t)+v*t,r=Gy.sinLatLUT[e],n=Gy.cosLatLUT[e],s=e+1,c=s*M,u=y*(1-c)+v*c,f=Gy.sinLatLUT[s],P=Gy.cosLatLUT[s],R=Gy.sinLonLUT[0],A=Gy.cosLonLUT[0],O=b+$_(_,i,a);let D=A*n*O-w,I=R*n*O-C,L=r*O-x;const N=E*S;let F=T[N],U=T[N+1],H=T[N+2];for(let t=1;t<=o;t++){const s=t*M,v=_*(1-s)+g*s,R=Gy.sinLonLUT[t],A=Gy.cosLonLUT[t];let O=0,N=0,k=0;if(t<o){const e=(E+1)*S;O=T[e],N=T[e+1],k=T[e+2]}else{const e=Gy.sinLonLUT[l],t=Gy.cosLonLUT[l],s=b+$_(g,i,a);O=t*n*s-w,N=e*n*s-C,k=r*s-x}const V=D,B=I,z=L;D=F,I=U,L=H,F=O,U=N,H=k;const G=O-V,q=N-B,Z=k-z;let j=0,W=0,$=0;if(e>1){const e=(E-o)*S;j=T[e],W=T[e+1],$=T[e+2]}else{const e=Gy.sinLatLUT[0],t=Gy.cosLatLUT[0],i=b+$_(v,y,a);j=A*t*i-w,W=R*t*i-C,$=e*i-x}const X=b+$_(v,u,a),Y=A*P*X-w,K=R*P*X-C,Q=f*X-x;if(e<o){const e=E+o,t=e*S;T[t]=Y,T[t+1]=K,T[t+2]=Q,Xy(Y,K,Q,h),d.setValues(e,Math.round(s*yg.rU),Math.round(c*yg.rU))}const J=j-Y,ee=W-K,te=$-Q;let ie=A*n,re=R*n,ne=r;ne*ne<.999&&(ie=Z*ee-q*te,re=G*te-Z*J,ne=q*J-G*ee);const se=1/Math.sqrt(ie*ie+re*re+ne*ne);(0,Cg.hd)(p,E,ie*se,re*se,ne*se,m),++E}}}(e),r.poleVerticesStartIndex=d;const w=function(e,t,i){const{tile:r,localOrigin:n,geometry:s}=e,{extent:a,ellipsoid:o}=r,{boundingBox:l,numVerticesPerSide:c,vertexAttributes:h,poleVerticesStartIndex:u}=s,d=c-1,p=n[0],m=n[1],f=n[2],_=o.radius,g=a[1],y=a[3],v=[];let b=u;const w=(e,t)=>{const i=t*c;Xy(-p,-m,e*_-f,l),v.push(new By(1===e,i,1===e?0:2,b,Jy));const r=Ty(-1===e?g:y,_),n=e*Math.PI/2-r,s=.99*(1===e?1:-1),a=_+0,{position:o,uv0:u}=h,{typedBuffer:w,typedBufferStride:C}=h.normalCompressed;for(let e=1;e<=Jy;++e){const t=r+n*(e/Jy),i=Math.cos(t),c=Math.sin(t);for(let e=0;e<=d;e++){const t=e/d,r=Gy.sinLonLUT[e],n=Gy.cosLonLUT[e]*i,h=r*i,_=c,g=n*a-p,y=h*a-m,v=_*a-f;Xy(g,y,v,l),o.setValues(b,g,y,v),u.setValues(b,Math.round(t*yg.rU),Math.round(s*yg.rU)),(0,Cg.hd)(w,b,n,h,_,C),++b}}};return t&&w(-1,0),i&&w(1,d),v}(e,p,m);r.edgeVerticesStartIndex=d+f,Ly(e),wy(e),Oy(r,w,h),e.intersectionData=null}function wy(e){e.tile.intersectsClippingArea&&(xy(e),Cy(e))}function Cy(e,t=!1){const{geometry:i,geometryState:r,tile:n,localOrigin:s}=e,{level:a,extent:o,extentInRadians:l,ellipsoid:c}=n,h=c.radius,u=l[0],d=l[2],p=l[1],m=l[3],{samplerData:f}=r,_=o[0],g=o[2],y=o[1],v=o[3],b=Sy(e),{boundingBox:w,vertexAttributes:C}=i,x=s[0],T=s[1],S=s[2],{position:M,uv0:E}=C,P=M.typedBuffer,R=M.typedBufferStride;for(let s=0;s<4;++s){const l=1===s||3===s,c=r.edgeResolutions[s];(0,X_.Fp)((0,st.wt)(c));const C=c+1,M=Bg(n,r.edgePeerNeighbors[s]);if(jy(n,M,s)){Fy(e,s,M);continue}const A=null!=M;(0,X_.Fp)(!A||M.level===n.level),(0,X_.Fp)(!A||(0,Eg.gl)(n,M)<=0);const O=M?.renderData,D=O?.geometryState;if(X_.T9){const e=n.surface;if(!M&&e&&!e.updatingRootTiles){const t=X_.OC[s],i=n.findNeighborTile(t,(e=>e.loaded||e.leaf||e.level===n.level));i?i.intersectsClippingArea&&((0,X_.Fp)(!i.loaded),(0,X_.Fp)(!i.leaf),(0,X_.Fp)(i.level===a)):(0,X_.Fp)(null==e?.rootTiles||!n.shouldHaveNeighbor(t))}}const I=1===s?o[2]:o[0],L=M?.extent,N=L&&l?1===s?L[0]:L[2]:I,F=0===s?o[3]:o[1],U=1===s?1:0,H=0===s?1:0,k=1===s?d:u,V=0===s?m:p,B=Math.sin(k),z=Math.cos(k),G=Math.sin(V),q=Math.cos(V),Z=D?.samplerData,j=A?(e,t,i)=>.5*($_(e,t,f)+$_(i,t,Z)):(e,t,i)=>$_(e,t,f),W=i.outerEdgesOffsetAndLength[2*s+0],$=t&&C>3?C-3:1,X=null!=f&&f.some((e=>null!=e)),Y=null!=Z&&Z.some((e=>null!=e)),K=X||Y,Q=1/c,J=W;(0,X_.Fp)(!L||(0,X_.Wq)(L[2]-L[0],o[2]-o[0])),(()=>{const e=1===s?-1:3===s?1:0,t=0===s?-1:2===s?1:0,r=(o[2]-o[0])*Q,n=e*r,a=t*r,c=l?e*((d-u)*Q):0,p=l?0:t*Q,m=H,M=l?k+c:k,O=l?Math.sin(M):B,D=l?Math.cos(M):z,L=l?k-c:k,W=l?Math.sin(L):B,X=l?Math.cos(L):z,Y=l?V:b(m+p),ee=l?G:Math.sin(Y),te=l?q:Math.cos(Y),ie=l?V:b(m-p),re=l?G:Math.sin(ie),ne=l?q:Math.cos(ie);let se=0,ae=0,oe=0;{const e=0*Q,t=l?I:_*(1-e)+g*e,i=l?N:t,r=l?y*(1-e)+v*e:F,n=l?k:u*(1-e)+d*e,s=l?B:Math.sin(n),a=l?z:Math.cos(n),o=l?b(e):V,c=l?Math.sin(o):G,p=l?Math.cos(o):q,m=h+j(t,r,i);se=a*p*m,ae=s*p*m,oe=c*m}let le=0,ce=0,he=0;{const e=1*Q,t=l?I:_*(1-e)+g*e,i=l?N:t,r=l?y*(1-e)+v*e:F,n=l?k:u*(1-e)+d*e,s=l?B:Math.sin(n),a=l?z:Math.cos(n),o=l?b(e):V,c=l?Math.sin(o):G,p=l?Math.cos(o):q,m=h+j(t,r,i);le=a*p*m,ce=s*p*m,he=c*m}for(let e=1;e<C-1;e+=$){let t=0,r=0,o=0;{const i=(e+1)*Q,n=l?I:_*(1-i)+g*i,s=l?N:n,a=l?y*(1-i)+v*i:F,c=l?k:u*(1-i)+d*i,p=l?B:Math.sin(c),m=l?z:Math.cos(c),f=l?b(i):V,w=l?Math.sin(f):G,C=l?Math.cos(f):q,x=h+j(n,a,s);t=m*C*x,r=p*C*x,o=w*x}const c=t,p=r,m=o,C=le,M=ce,L=he;le=c,ce=p,he=m;{const t=J+e,i=t*R,r=C-x,n=M-T,s=L-S;P[i]=r,P[i+1]=n,P[i+2]=s,Xy(r,n,s,w);const a=e*Q,o=l?U:a,c=l?a:H;E.setValues(t,Math.round(o*yg.rU),Math.round(c*yg.rU))}const $=se,Y=ae,ie=oe;se=C,ae=M,oe=L;const ue=C,de=M,pe=L,me=1/Math.sqrt(ue*ue+de*de+pe*pe),fe=pe*me;let _e=0,ge=0,ye=0;if(K&&fe*fe<.999){let t=0,i=0,r=0;{const e=0===s?-1:1;t=e*(c-$),i=e*(p-Y),r=e*(m-ie)}{const o=e*Q,c=l?I:_*(1-o)+g*o,p=l?N:c,m=l?y*(1-o)+v*o:F,w=l?k:u*(1-o)+d*o,C=l?B:Math.sin(w),x=l?z:Math.cos(w),T=l?b(o):V,S=l?Math.sin(T):G,M=l?Math.cos(T):q;let E=ue,P=de,R=pe;if(A){const e=h+$_(p-n,m-a,Z),t=l?M:ne;E=(l?X:x)*t*e,P=(l?W:C)*t*e,R=(l?S:re)*e}{const e=h+$_(c+n,m+a,f),o=l?M:te,u=(l?D:x)*o*e,d=(l?O:C)*o*e,p=(l?S:ee)*e;A||(E=2*ue-u,P=2*de-d,R=2*pe-p);const _=3===s?-1:1,g=_*(E-u),y=_*(P-d),v=_*(R-p);_e=r*y-i*v,ge=t*v-r*g,ye=i*g-t*y;const b=1/Math.sqrt(_e*_e+ge*ge+ye*ye);_e*=b,ge*=b,ye*=b}}}else _e=ue*me,ge=de*me,ye=pe*me;i.setEdgeNormalFromValues(s,e,_e,ge,ye)}})()}}function xy(e){Uy(e)}function Ty(e,t){return Math.PI/2-2*Math.atan(Math.exp(-e/t))}function Sy(e){const{tile:t}=e;if(t.surface.isWebMercator){const e=t.extent,i=t.ellipsoid.radius;return t=>function(e,t,i,r){return Ty(e*(1-r)+t*r,i)}(e[1],e[3],i,t)}const i=t.extentInRadians;return e=>function(e,t,i){return e*(1-i)+t*i}(i[1],i[3],e)}function My(e,t){const{tile:i,geometryState:r,geometry:n}=e,{extent:s,surface:a}=i,{wireframe:o}=r,l=s[0],c=s[1],h=s[2]-l,u=s[3]-c,{numVerticesPerSide:d,clippingArea:p}=r,m=null!=p?Math.max(0,(p[0]-l)/h):0,f=null!=p?Math.max(0,(p[1]-c)/u):0,_=null!=p?Math.min(1,(p[2]-l)/h):1,g=null!=p?Math.min(1,(p[3]-c)/u):1,y=(d-2)**2,v=Yy(r),b=y+4*v,w=a.renderer.tileGeometryCache.acquire(b),{boundingBox:C}=n;(0,fc.cS)(C),n.numVerticesPerSide=d,n.vertexAttributes=w,n.maxEdgeVertexCount=v,n.minu=m,n.minv=f,n.maxu=_,n.maxv=g,function(e){const t=e.tile;if(!t.intersectsClippingArea)return;const{geometry:i,geometryState:r,localOrigin:n}=e,{samplerData:s,clippingArea:a,numVerticesPerSide:o}=r,{surface:l,extent:c,ellipsoid:h}=t,{isWebMercatorOnPlateCarree:u}=l,d=null!=a?a:qy,p=c[0],m=c[1],f=c[2],_=c[3],g=Math.max(p,d[0]),y=Math.min(f,d[2]),v=Math.max(m,d[1]),b=Math.min(_,d[3]),w=h.radius,C=t.horizontalScale,x=o-1,T=o-2,{minu:S,minv:M,maxu:E,maxv:P,boundingBox:R,vertexAttributes:A}=i,{position:O,uv0:D}=A,{typedBuffer:I,typedBufferStride:L}=A.normalCompressed,N=n[0],F=n[1],U=n[2],H=O.typedBuffer,k=O.typedBufferStride;let V=0;const B=(0,st.uZ)(m,v,b),z=u?(Math.PI/2-2*Math.atan(Math.exp(-B/w)))*w:B*C,G=1/x,q=(0,st.uZ)(m*(1-G)+_*G,v,b);let Z=z,j=u?(Math.PI/2-2*Math.atan(Math.exp(-q/w)))*w:q*C;for(let e=1;e<=T;e++){const t=e/x,i=(0,st.uZ)(m*(1-t)+_*t,v,b),r=(0,st.uZ)(t,M,P),n=j,a=(e-1)/x,o=(0,st.uZ)(m*(1-a)+_*a,v,b),l=Z,c=(e+1)/x,h=(0,st.uZ)(m*(1-c)+_*c,v,b),d=u?(Math.PI/2-2*Math.atan(Math.exp(-h/w)))*w:h*C,A=(0,st.uZ)(c,M,P);Z=j,j=d;const O=(0,st.uZ)(p,g,y);let B=O*C,z=$_(O,i,s);const G=1/x,q=(0,st.uZ)(G,S,E),W=(0,st.uZ)(p*(1-q)+f*q,g,y);let $=q,X=W,Y=W*C,K=$_(W,i,s);if(1===e){const e=Y-N,t=Z-F,i=K-U,n=0*k;H[n]=e,H[n+1]=t,H[n+2]=i,Xy(e,t,i,R);const s=(0,st.uZ)(G,S,E);D.setValues(V,Math.round(s*yg.rU),Math.round(r*yg.rU))}for(let t=1;t<=T;t++){const a=Y,c=K,u=(t+1)/x,m=(0,st.uZ)(u,S,E),_=(0,st.uZ)(p*(1-u)+f*u,g,y),v=X;X=_;{const a=V+1,o=a*k;if(1===e||t===T){const l=_*C,c=$_(_,i,s);if(1===e&&t<T){const e=l-N,t=n-F,i=c-U;H[o]=e,H[o+1]=t,H[o+2]=i,Xy(e,t,i,R),D.setValues(a,Math.round(m*yg.rU),Math.round(r*yg.rU))}Y=l,K=c}else Y=H[o]+N,K=H[o+2]+U}const b=Y,w=K,M=B,P=z;B=a,z=c;const O=(V-T)*k,G=1===e?$_(v,o,s):H[O+2]+U,q=$_(v,h,s);if(e<T){const e=V+T,t=e*k,i=a-N,r=d-F,n=q-U;H[t]=i,H[t+1]=r,H[t+2]=n,Xy(i,r,n,R);const s=$;$=m,D.setValues(e,Math.round(s*yg.rU),Math.round(A*yg.rU))}{const e=b-M,t=l-d,i=t*(w-P),r=e*(G-q),n=-t*e,s=i*i+r*r+n*n;if(0===s)(0,Cg.hd)(I,V,0,0,1,L);else{const e=1/Math.sqrt(s);(0,Cg.hd)(I,V,i*e,r*e,n*e,L)}}++V}}}(e),n.edgeVerticesStartIndex=y,Ly(e),Ey(e),Oy(n,[],o),e.intersectionData=null}function Ey(e,t){e.tile.intersectsClippingArea&&(Ry(e),Py(e,!1))}function Py(e,t){const{geometry:i,geometryState:r,localOrigin:n}=e,s=e.tile,{surface:a,extent:o}=s,{clippingArea:l,samplerData:c}=r,h=null!=l?l:qy,u=o[0],d=o[2],p=o[1],m=o[3],f=[m>h[3],d>h[2],p<h[1],u<h[0]],_=s.horizontalScale,g=Ay(a.isWebMercatorOnPlateCarree,s.ellipsoid.radius,_),{minu:y,minv:v,maxu:b,maxv:w,boundingBox:C}=i,x=Math.max(u,h[0]),T=Math.min(d,h[2]),S=Math.max(p,h[1]),M=Math.min(m,h[3]),E=n[0],P=n[1],R=n[2];for(let n=0;n<4;++n){const o=1===n||3===n,l=r.edgeResolutions[n];(0,X_.Fp)((0,st.wt)(l));const h=l+1,A=f[n],O=Bg(s,r.edgePeerNeighbors[n]);if(!A&&jy(s,O,n)){Fy(e,n,O);continue}const D=null!=O&&!A,I=O?.renderData,L=I?.geometryState;if(X_.T9&&((0,X_.Fp)(!D||O.level===s.level),(0,X_.Fp)(!D||(0,Eg.gl)(s,O)<=0),s&&!O&&!a.updatingRootTiles)){const e=X_.OC[n],t=s.findNeighborTile(e,(e=>e.loaded||e.leaf||e.level===s.level));a.updatingRootTiles||(t?t.intersectsClippingArea&&((0,X_.Fp)(!t.loaded),(0,X_.Fp)(!t.leaf),(0,X_.Fp)(t.level===s.level)):(0,X_.Fp)(null==a?.rootTiles||!s.shouldHaveNeighbor(e)))}const N=(0,st.uZ)(1===n?d:u,x,T),F=(0,st.uZ)(0===n?m:p,S,M),U=L?.samplerData,H=t&&h>3?h-3:1,k=(0,st.uZ)(1===n?1:0,y,b),V=(0,st.uZ)(0===n?1:0,v,w),B=D?(e,t)=>.5*($_(e,t,U)+$_(e,t,c)):(e,t)=>$_(e,t,c),z=(d-u)/l,G=o?1===n?z:-z:0,q=o?0:0===n?z:-z,Z=-G,j=-q;let W=0,$=0,X=0;{const e=0/l,t=o?N:(0,st.uZ)(u*(1-e)+d*e,x,T),i=o?(0,st.uZ)(p*(1-e)+m*e,S,M):F,r=B(t,i);W=t*_,$=g(i),X=r}let Y=0,K=0,Q=0;{const e=1/l,t=o?N:(0,st.uZ)(u*(1-e)+d*e,x,T),i=o?(0,st.uZ)(p*(1-e)+m*e,S,M):F,r=B(t,i);Y=t*_,K=g(i),Q=r}for(let e=1;e<h-1;e+=H){const t=e/l,r=Y,s=K,a=Q;{const l=o?k:(0,st.uZ)(t,y,b),c=o?(0,st.uZ)(t,v,w):V,h=r-E,u=s-P,d=a-R;Xy(r,u,d,C),i.setEdgeVertexFromValuesRawPositionUV(n,e,h,u,d,l,c)}{const t=(e+1)/l,i=o?N:(0,st.uZ)(u*(1-t)+d*t,x,T),r=o?(0,st.uZ)(p*(1-t)+m*t,S,M):F,n=B(i,r);Y=i*_,K=g(r),Q=n}const h=Y,f=Q,A=W,O=$,I=X;W=r,$=s,X=a;let L=0,H=0,z=0;if(o){const e=K-s,i=f-a,o=O-s,l=I-a,h=(0,st.uZ)(p*(1-t)+m*t,S,M),u=N+Z,d=u*_-r,g=$_(u,h,c)-a,y=3===n?-1:1;if(L=y*(-o+e)*g,H=y*d*(-l+i),z=-y*d*(-o+e),D){const t=N+G,n=t*_-r;L=(-o+e)*(g-($_(t,h,U)-a)),H=(d-n)*(-l+i),z=-(d-n)*(-o+e)}}else{const e=h-r,i=f-a,o=A-r,l=I-a,p=(0,st.uZ)(u*(1-t)+d*t,x,T),m=F+j,_=$_(p,m,c)-a,y=g(m)-s,v=2===n?-1:1;if(L=v*y*(-l+i),H=v*(-o+e)*_,z=-v*y*(-o+e),D){const t=p,r=F+q,n=g(r)-s;L=(-y+n)*(-l+i),H=(-o+e)*(-_+($_(t,r,U)-a)),z=-(-y+n)*(-o+e)}}const J=1/Math.sqrt(L*L+H*H+z*z);i.setEdgeNormalFromValues(n,e,L*J,H*J,z*J)}}}function Ry(e,t){Uy(e)}function Ay(e,t,i){return e?e=>function(e,t){return(Math.PI/2-2*Math.atan(Math.exp(-e/t)))*t}(e,t):e=>function(e,t){return e*t}(e,i)}function Oy(e,t,i){const{numVerticesPerSide:r,vertexAttributes:n,maxEdgeVertexCount:s}=e,a=r-1,o=n.count,l=2*(r-3)*(r-3),c=4*(a+s-3),h=Xg.reduce(((t,i)=>t+(a+e.getEdgeCount(i)-3)),0),u=t.reduce(((e,t)=>e+a*(2*(t.latitudeResolution-1)+1)),0),d=3*(i?2:1),p=(l+c+u)*d,m=o>=65536?new Uint32Array(p):new Uint16Array(p);for(let e=0;e<p;++e)m[e]=0;e.indices=m,e.indexCount=(l+h+u)*d,e.poleIndicesStartIndex=l*d,e.edgeIndicesStartIndex=(l+u)*d,i?(function(e){const{indices:t,numVerticesPerSide:i,vertexAttributes:r}=e,{position:n}=r,{typedBuffer:s,typedBufferStride:a}=n,o=i-2;let l=0;for(let e=0;e<i-3;++e){const r=e*o;for(let n=0;n<i-3;++n){const i=e*o+n,c=i+1,h=c+o,u=h-1,d=r+n,p=d+1,m=p+o;Ky(d,p,m,m-1,a,s)?(Qy(t,l,i,c,h),l+=6,Qy(t,l,h,u,i)):(Qy(t,l,i,c,u),l+=6,Qy(t,l,u,h,c)),l+=6}}}(e),function(e,t){const{indices:i,numVerticesPerSide:r,poleIndicesStartIndex:n}=e,s=r-1;let a=n;for(const n of t){const t=n.connectedOuterEdgeOffset;let o=e.getEdgeVertexIndex(t,0),l=1;for(let e=0;e<n.latitudeResolution;++e){const t=0===e?n.rowOffset:o+r;for(let r=0;r<s;r++)Qy(i,a,o,o+1,t+r),a+=6,e<n.latitudeResolution-1&&(Qy(i,a,o+1,t+r+1,t+r),a+=6),o+=l;o=t,l=1}}}(e,t),Iy(e)):(function(e){const{numVerticesPerSide:t,indices:i,vertexAttributes:r}=e,{position:n}=r,{typedBuffer:s,typedBufferStride:a}=n,o=t-2,l=t-3,c=0,h=t-3;let u=0;for(let e=0;e<l;++e){const t=e*o;for(let e=c;e<h;++e){const r=t+e,n=r+1,l=n+o,c=l-1;Ky(r,n,l,c,a,s)?(i[u]=r,i[u+1]=n,i[u+2]=l,i[u+3]=l,i[u+4]=c,i[u+5]=r):(i[u]=r,i[u+1]=n,i[u+2]=c,i[u+3]=c,i[u+4]=n,i[u+5]=l),u+=6}}}(e),function(e,t){const{numVerticesPerSide:i,indices:r,poleIndicesStartIndex:n}=e,s=i-1;let a=n;for(const n of t){const t=n.isNorth?1:2,o=n.isNorth?2:1,l=n.isNorth?3:4,c=n.isNorth?4:3;let h=e.getEdgeVertexIndex(n.connectedOuterEdgeOffset,0),u=1;for(let e=0;e<n.latitudeResolution;++e){const d=0===e?n.rowOffset:h+i;for(let i=0;i<s;i++){const s=d+i;r[a]=h,r[a+t]=h+1,r[a+o]=s,e<n.latitudeResolution-1?(r[a+l]=h+1,r[a+c]=s+1,r[a+5]=s,a+=6):a+=3,h+=u}h=d,u=1}}}(e,t),Dy(e))}function Dy(e){const{indices:t,numVerticesPerSide:i,edgeIndicesStartIndex:r}=e,n=i-1,s=n-2;let a=r;for(let i=0;i<4;++i){const r=$y[i];let o=0,l=0;const c=e.getEdgeCount(i),h=r.count;(0,X_.Fp)(h===n-1);const u=1===i||2===i,d=u?1:2,p=u?2:1,m=e.getEdgeFirstVertexIndex(i),f=1,_=r.vertex0Index,g=r.stride;for(;o<c-1||l<h-1;){const e=_+l*g,i=m+o*f,r=o<c-1,u=l<h-1,y=r&&(!u||(r?0+n*(o+.5)/(c-1):0)<=(u?1+s*(l+.5)/(h-1):0));y?++o:++l;const v=y?i+f:e+g;t[a]=e,t[a+d]=i,t[a+p]=v,a+=3}}e.indexCount=a}function Iy(e){const{indices:t,numVerticesPerSide:i,edgeIndicesStartIndex:r}=e,n=i-1,s=n-2;let a=r;for(let i=0;i<4;++i){const r=$y[i];let o=0,l=0;const c=e.getEdgeCount(i),h=r.count;(0,X_.Fp)(h===n-1);const u=1===i||2===i,d=u?1:3,p=u?3:1,m=e.getEdgeFirstVertexIndex(i),f=1,_=r.vertex0Index,g=r.stride;for(;o<c-1||l<h-1;){const e=_+l*g,i=m+o*f,r=o<c-1,u=l<h-1,y=r&&(!u||(r?0+n*(o+.5)/(c-1):0)<=(u?1+s*(l+.5)/(h-1):0));y?++o:++l;const v=y?i+f:e+g;t[a]=e,t[a+d]=i,t[a+d+1]=i,t[a+p]=v,t[a+p+1]=v,t[a+5]=e,a+=6}}e.indexCount=a}function Ly(e){const{geometry:t,geometryState:i}=e,{edgeResolutions:r}=i,{numVerticesPerSide:n,edgeVerticesStartIndex:s}=t,a=n-2;let o=s;for(let e=0;e<4;++e){{const t=0===e||2===e,i=(0===e?a-1:0)*a+(1===e?a-1:0),r=(t?0:1)*a+(t?1:0),n=$y[e];n.vertex0Index=i,n.stride=r,n.count=a}{const i=r[e]+1;t.outerEdgesOffsetAndLength[2*e+0]=o,t.outerEdgesOffsetAndLength[2*e+1]=i,o+=i}}}function Ny(e){Ly(e),e.geometryState.wireframe?Iy(e.geometry):Dy(e.geometry)}function Fy(e,t,i){const{geometryState:r,geometry:n,tile:s,localOrigin:a}=e,o=1===t||3===t,l=r.edgeResolutions[t];(0,X_.Fp)((0,st.wt)(l));const c=l+1,{boundingBox:h,minu:u,minv:d,maxu:p,maxv:m,vertexAttributes:f}=n,_=(0,st.uZ)(1===t?1:0,u,p),g=(0,st.uZ)(0===t?1:0,d,m),y=i.renderData,v=y.geometryState,b=y.geometry,w=(t+2)%4,C=b.getEdgeCount(w),x=s.getNeighborEdgeStartVertexIndex(t,i)*l,T=l*2**(s.level-i.level);(0,X_.Fp)(v.edgeResolutions[w]===T),(0,X_.Fp)(C-1===T);const S=y.localOrigin[0]-a[0],M=y.localOrigin[1]-a[1],E=y.localOrigin[2]-a[2],P=n.getEdgeFirstVertexIndex(t),{position:R,uv0:A}=f,O=R.typedBuffer,D=R.typedBufferStride,I=f.normalCompressed,L=I.typedBuffer,N=I.typedBufferStride,F=b.vertexAttributes,U=b.getEdgeFirstVertexIndex(w),H=F.position.typedBuffer,k=F.position.typedBufferStride,V=F.normalCompressed.typedBuffer,B=F.normalCompressed.typedBufferStride;for(let e=1;e<c-1;++e){const t=P+e,i=U+(x+e),r=t*D,n=i*k,s=H[n]+S,a=H[n+1]+M,c=H[n+2]+E;O[r]=s,O[r+1]=a,O[r+2]=c,Xy(s,a,c,h);const f=t*N,y=i*B;L[f]=V[y],L[f+1]=V[y+1];const v=e/l,b=o?_:(0,st.uZ)(v,u,p),w=o?(0,st.uZ)(v,d,m):g;A.setValues(t,Math.round(b*yg.rU),Math.round(w*yg.rU))}}function Uy(e){const{geometry:t,geometryState:i,localOrigin:r}=e,{clippingArea:n,samplerData:s}=i,{minu:a,minv:o,maxu:l,maxv:c,boundingBox:h,vertexAttributes:u}=t,d=e.tile,{surface:p,ellipsoid:m,extent:f,extentInRadians:_,horizontalScale:g}=d,y="local"===p.view?.viewingMode,v=m.radius;let b=0,w=0,C=0;const x=y?(()=>{const e=n,t=null!=e&&(f[3]>e[3]||f[2]>e[2]||f[1]<e[1]||f[0]<e[0]),i=Ay(p.isWebMercatorOnPlateCarree,v,g);return(r,n,s)=>{const a=0===r?f[0]:f[2],o=0===n?f[1]:f[3],l=t?(0,st.uZ)(a,e[0],e[2]):a,c=t?(0,st.uZ)(o,e[1],e[3]):o,h=s;b=l*g,w=i(c),C=h}})():(e,t,i)=>{const r=_[0===t?1:3],n=_[0===e?0:2],s=Math.cos(r),a=Math.sin(r),o=Math.sin(n),l=Math.cos(n),c=v+i;b=l*s*c,w=o*s*c,C=a*c};let T=0,S=0,M=0,E=0,P=0,R=0,A=0,O=0,D=0;const I=y&&p.isWebMercatorOnPlateCarree,L=(e,t,i,r,n)=>{let s=0,a=0,o=0;if(y){const e=t*g,n=I?(Math.PI/2-2*Math.atan(Math.exp(-i/v)))*v:i*g;s=e-b,a=n-w,o=r-C}else{const n=Sy(e),l=e.tile,c=l.extent,h=l.extentInRadians,u=(t-c[0])/(c[2]-c[0]),d=(i-c[1])/(c[3]-c[1]),p=h[0]*(1-u)+h[2]*u,m=n(d),f=Math.cos(m),_=Math.sin(m),g=Math.sin(p),y=Math.cos(p),x=v+r;s=y*f*x-b,a=g*f*x-w,o=_*x-C}switch(n){case 0:A+=s,O+=a,D+=o;break;case 1:E-=s,P-=a,R-=o;break;case 2:A-=s,O-=a,D-=o;break;case 3:E+=s,P+=a,R+=o}},N=n??qy,F=f[0],U=f[2],H=f[1],k=f[3],V=[k>N[3],U>N[2],H<N[1],F<N[0]],B=Math.max(F,N[0]),z=Math.min(U,N[2]),G=Math.max(H,N[1]),q=Math.min(k,N[3]),Z=e=>Math.max(N[0],Math.min(N[2],e)),j=e=>Math.max(N[1],Math.min(N[3],e)),W=e=>{const t=i.cornerNeighborCornerTiles;T=0,S=0,M=1,E=0,P=0,R=0,A=0,O=0,D=0;let r=1/0;for(let i=0;i<4;++i){const n=t[4*e+i];r=Math.min(r,n?.level??1/0)}for(let i=0;i<4;++i){const n=t[4*e+i];Zy[i]=n?.level===r?n:null}let n=1,s=0;for(let e=0;e<4;++e){const t=Zy[e];t&&(n=Math.max(n,t?.renderData.geometryState.numVerticesPerSide),s=t.extent[2]-t.extent[0])}const a=s,o=n;(0,X_.Fp)(o>1);const l=a/o;for(let e=0;e<4;++e){const t=Zy[(e+3)%4],i=Zy[e%4];if(!t&&!i)continue;const r=0===e?1:1===e?2:2===e?3:0,n=0===e?2:1===e?3:2===e?0:1;if(t&&i){const s=zy[e][0]*l,a=zy[e][1]*l,o=t.extent,c=Z(o[0===r||1===r?2:0]+s),h=j(o[0===r||3===r?3:1]+a),u=i.extent,d=Z(u[0===n||1===n?2:0]+s),p=j(u[0===n||3===n?3:1]+a),m=t.renderData,f=i.renderData,_=$_(c,h,m.geometryState.samplerData),g=$_(d,p,f.geometryState.samplerData);L(m,c,h,.5*(_+g),e)}else{const s=t??i,a=t?r:n,o=s.extent,c=zy[e],h=Z(o[0===a||1===a?2:0]+c[0]*l),u=j(o[0===a||3===a?3:1]+c[1]*l),d=s.renderData,p=$_(h,u,d.geometryState.samplerData);L(d,h,u,p,e)}}if(!y){const e=Math.sqrt(b*b+w*w+C*C);T=b/e,S=w/e,M=C/e}if(y||M*M<.999){const e=Math.sqrt(E*E+P*P+R*R);E/=e,P/=e,R/=e;const t=Math.sqrt(A*A+O*O+D*D);A/=t,O/=t,D/=t,T=R*O-P*D,S=E*D-R*A,M=P*A-E*O;const i=1/Math.sqrt(T*T+S*S+M*M);T*=i,S*=i,M*=i}},$=i.cornerNeighborCornerTiles;for(let e=0;e<4;++e){const n=e,p=(e+1)%4,m=0===e||1===e?1:0,f=0===e||3===e?1:0,_=(0,st.uZ)(m,a,l),g=(0,st.uZ)(f,o,c),y=t.getEdgeFirstVertexIndex(n),v=t.getEdgeCount(n),E=0===e||3===e?v-1:0,P=t.getEdgeFirstVertexIndex(p),R=t.getEdgeCount(p),A=0===e||1===e?R-1:0;let O=-1;for(let t=0;t<4;++t){const i=$[4*e+t],r=$[4*e+O];i&&(-1===O||(0,Eg.gl)(r,i)>0)&&(O=t)}const D=O,I=$[4*e+D];if(I!==d){const t=d.level-I.level,n=2**t,s=[I.lij[0]+t,I.lij[1]*n,I.lij[2]*n],a=[s[1]+n===d.lij[1],0===e&&(1===D||0===D&&I!==$[4*e+3])||1===e&&(0===D||1===D&&I!==$[4*e+2]),s[1]===d.lij[1]+1,2===e&&(3===D||2===D&&I!==$[4*e+1])||3===e&&(2===D||3===D&&I!==$[4*e+0])],o=a.reduce(((e,t)=>e+(t?1:0)),0);(0,X_.Fp)(1===o||2===o);let l=-1,c=-1;const p=I.renderData;if(1===o){const t=a.findIndex((e=>e));(0,X_.Fp)(0<=t&&t<=3),l=(t+2)%4;const r=i.edgeResolutions[t];c=d.getNeighborEdgeStartVertexIndex(t,I)*r+r*(0===t&&0===e||1===t&&0===e||2===t&&1===e||3===t&&3===e?1:0)}else{(0,X_.Fp)(a[1]||a[3]),l=a[1]?3:1;const t=p.geometryState.edgeResolutions[l];c=0===e||3===e?0:t}const m=p.geometry;{const e=y+E,t=P+A,i=m.getEdgeFirstVertexIndex(l)+c,n=m.vertexAttributes,s=p.localOrigin,a=n.position,o=a.typedBuffer,d=i*a.typedBufferStride,f=o[d]+s[0]-r[0],v=o[d+1]+s[1]-r[1],b=o[d+2]+s[2]-r[2];Xy(f,v,b,h);const w=u.position,C=w.typedBuffer,x=e*w.typedBufferStride;C[x]=f,C[x+1]=v,C[x+2]=b;const T=t*w.typedBufferStride;C[T]=f,C[T+1]=v,C[T+2]=b;const S=u.uv0;S.setValues(e,Math.round(_*yg.rU),Math.round(g*yg.rU)),S.setValues(t,Math.round(_*yg.rU),Math.round(g*yg.rU));{const r=n.normalCompressed.typedBuffer,s=i*n.normalCompressed.typedBufferStride,a=u.normalCompressed,o=a.typedBuffer;{const t=e*a.typedBufferStride;o[t]=r[s],o[t+1]=r[s+1]}{const e=t*a.typedBufferStride;o[e]=r[s],o[e+1]=r[s+1]}}}}else{let i;if(V[n]||V[p]){i=$_((0,st.uZ)(F*(1-m)+U*m,B,z),(0,st.uZ)(H*(1-f)+k*f,G,q),s)}else i=Hy($,e);x(m,f,i),W(e);const a=b-r[0],o=w-r[1],l=C-r[2];Xy(a,o,l,h),t.setEdgeVertexFromValuesRawPositionUVNormal(n,E,a,o,l,_,g,T,S,M),t.setEdgeVertexFromValuesRawPositionUVNormal(p,A,a,o,l,_,g,T,S,M)}}for(let e=0;e<4;++e)Zy[e]=null}function Hy(e,t){const i=4*t,r=Xg.reduce(((t,r)=>Math.min(t,e[i+r]?.level??1/0)),1/0);X_.T9&&((0,X_.Fp)(!e[i+0]||!e[i+2]||py(e[i+0],e[i+2],vg.X.SOUTH_WEST)),(0,X_.Fp)(!e[i+1]||!e[i+3]||py(e[i+1],e[i+3],vg.X.NORTH_WEST)));let n=0,s=0;for(let t=0;t<4;++t){const a=e[i+t];if(a&&a.level===r){const e=0===t||1===t,i=0===t||3===t,r=a.extent,o=r[e?0:2],l=r[i?1:3],c=a.renderData?.geometryState?.samplerData;s+=$_(o,l,c),n++}}const a=n?s/n:0;return(0,X_.Fp)(null!=a),a}function ky(e){const{vao:t,geometry:i}=e,{vertexAttributes:r,edgeVerticesStartIndex:n}=i,s=r.position.typedBuffer;t.vertexBuffers.get("geometry").setSubData(s,n,n,s.length)}function Vy(e){const{vao:t,geometry:i}=e,{indices:r,indexCount:n,edgeIndicesStartIndex:s}=i;t.indexBuffer.setSubData(r,s,s,n)}class By{constructor(e,t,i,r,n){this.isNorth=e,this.connectedRowOffset=t,this.connectedOuterEdgeOffset=i,this.rowOffset=r,this.latitudeResolution=n}}const zy=[[0,1],[1,0],[0,-1],[-1,0]],Gy=new class{constructor(){this.sinLonLUT=new Array(ce.Cf+1),this.cosLonLUT=new Array(ce.Cf+1),this.sinLatLUT=new Array(ce.Cf+1),this.cosLatLUT=new Array(ce.Cf+1)}update(e,t,i){const r=t[0],n=t[2];for(let t=0;t<=e;t++){const s=t/e,a=r*(1-s)+n*s;this.sinLonLUT[t]=Math.sin(a),this.cosLonLUT[t]=Math.cos(a);const o=i(s);this.sinLatLUT[t]=Math.sin(o),this.cosLatLUT[t]=Math.cos(o)}}},qy=(0,H.al)(-1/0,-1/0,1/0,1/0),Zy=[null,null,null,null];function jy(e,t,i){if(!t)return!1;const r=(0,Eg.gl)(e,t);return r>0||0===r&&i>=2}class Wy{constructor(){this.vertex0Index=0,this.stride=1,this.count=0}getVertexIndex(e){return(0,X_.Fp)(0<=e&&e<this.count),this.vertex0Index+this.stride*e}}const $y=[new Wy,new Wy,new Wy,new Wy];function Xy(e,t,i,r){e<r[0]?r[0]=e:e>r[3]&&(r[3]=e),t<r[1]?r[1]=t:t>r[4]&&(r[4]=t),i<r[2]?r[2]=i:i>r[5]&&(r[5]=i)}function Yy(e){const{edgeResolutions:t,numVerticesPerSide:i}=e,r=1+Math.max(...t);return Math.max(i,r)}function Ky(e,t,i,r,n,s){const a=e*n,o=s[a],l=s[a+1],c=s[a+2],h=t*n,u=s[h],d=s[h+1],p=s[h+2],m=i*n,f=s[m],_=s[m+1],g=s[m+2],y=r*n,v=s[y],b=s[y+1],w=s[y+2];return(u-v)*(u-v)+(d-b)*(d-b)+(p-w)*(p-w)>(o-f)*(o-f)+(l-_)*(l-_)+(c-g)*(c-g)}function Qy(e,t,i,r,n){e[t]=i,e[t+1]=r,e[t+2]=r,e[t+3]=n,e[t+4]=n,e[t+5]=i}const Jy=6;var ev=i(87807);class tv extends ny{constructor(e,t,i,r,n){super(),this._horizontalScaleFactor=1,this._extentInRenderSR=(0,H.Ue)(),this._baseUsedMemory=900,this._subtreeGeometryElevationBoundMin=0,this._subtreeGeometryElevationBoundMax=0,this.init(e,t,i,r,n)}init(e,t,i,r,n){super.init(e,t,i,r,n);const s=n.view.renderSpatialReference,a=n.spatialReference,o=null!=s&&(0,Ee.QM)(s)&&null!=a&&a.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this._horizontalScaleFactor=o;const{isWebMercatorOnPlateCarree:l}=n,c=this._extentInRenderSR,h=this.extent;if(l){const e=(0,R.al)(h[0],h[1],0);(0,mc.S)(e,N.Z.WebMercator,e,N.Z.PlateCarree);const t=(0,R.al)(h[2],h[3],0);(0,mc.S)(t,N.Z.WebMercator,t,N.Z.PlateCarree),c[0]=e[0],c[1]=e[1],c[2]=t[0],c[3]=t[1]}else for(let e=0;e<4;++e)c[e]=h[e]*o;this.centerAtSeaLevel[0]=.5*(c[0]+c[2]),this.centerAtSeaLevel[1]=.5*(c[1]+c[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(c[2]-c[0],c[3]-c[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const e=this._extentInRenderSR,t=.5*(e[2]-e[0]),i=.5*(e[3]-e[1]),r=Math.sqrt(t*t+i*i),n=.5*(this.elevationBoundsMax-this.elevationBoundsMin),s=Math.max(r,n);this._center[hy.MIDDLE][3]=s}_calculateFrustumVisibility(e){const t=this._aabb(),i=t[0],r=t[1],n=t[2],s=t[3],a=t[4],o=t[5];let l=!0;for(let t=0;t<6;t++){const c=e[t],h=c[0],u=c[1],d=c[2],p=c[3];if(h*(h>0?i:s)+u*(u>0?r:a)+d*(d>0?n:o)+p>=0)return Jg.OUTSIDE;l=l&&h*(h<0?i:s)+u*(u<0?r:a)+d*(d<0?n:o)+p<=0}return l?Jg.INSIDE:Jg.INTERSECTS}_aabb(){const e=this._extentInRenderSR;return(0,fc.re)(e[0],e[1],Math.min(this.elevationBoundsMin,this._subtreeGeometryElevationBoundMin),e[2],e[3],Math.max(this.elevationBoundsMax,this._subtreeGeometryElevationBoundMax))}intersectsRay(e,t,i,r){return iv[0]=1/t[0],iv[1]=1/t[1],iv[2]=1/t[2],(0,ev.Fw)(this._aabb(),e,iv,i,r)}createGeometry(){My(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds(),this.setMemoryDirty()}_updateSubtreeGeometryElevationsBounds(){const e=this._subtreeGeometryElevationBoundMin,t=this._subtreeGeometryElevationBoundMax,i=this.renderData;let r=e,n=t;if(i){const e=i.geometry.boundingBox;r=e[2],n=e[5]}else if(!this.leaf){r=1/0,n=-1/0;for(const e of this.children){const t=e;r=Math.min(r,t._subtreeGeometryElevationBoundMin),n=Math.max(n,t._subtreeGeometryElevationBoundMax)}}if(r!==this._subtreeGeometryElevationBoundMin||n!==this._subtreeGeometryElevationBoundMax){this._subtreeGeometryElevationBoundMin=r,this._subtreeGeometryElevationBoundMax=n;this.parent?._updateSubtreeGeometryElevationsBounds()}}get minimumVerticesPerSide(){return this.level<9?3:2}updateCornerElevations(){(function(e,t){e.tile.intersectsClippingArea&&(Ry(e),Py(e,!0),ky(e),e.intersectionData=null)})(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}updateEdgeElevations(){(function(e,t){e.tile.intersectsClippingArea&&(Ey(e),ky(e),e.intersectionData=null)})(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}updateEdgeElevationsAndResolutions(){(function(e,t){e.tile.intersectsClippingArea&&(Ny(e),Ey(e),ky(e),Vy(e),e.intersectionData=null)})(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}get horizontalScale(){return this._horizontalScaleFactor}}const iv=(0,R.Ue)();var rv=i(74446);class nv{constructor(){this.extent=(0,tc.Ue)(),this.minLevel=0,this.maxLevel=0,this.callback=null}}let sv=class extends S.Z{constructor(){super(...arguments),this._queries=new cd.Z({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new cd.Z({initialSize:30}),this._queryPool=new V_.Z(nv)}queryVisibleLevelRange(e,t,i,r){const n=this._queryPool.acquire();(0,ec.c)(n.extent,e),n.minLevel=t??-Number.MAX_VALUE,n.maxLevel=i??Number.MAX_VALUE,n.callback=r,this._queryQueue.push(n),this.notifyChange("updating")}get updating(){return 0!==this._queryQueue.length}prepare(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){const e=this._queryQueue.pop();this._queries.push(e)}this._queriesInvPtr=this._queries.length}process(){for(let e=0;e<this._queries.length;e++){const t=this._queries.data[e];this._queryPool.release(t),t.callback(e>=this._queriesInvPtr),t.callback=null}this._queries.clear(),this.notifyChange("updating")}queriesForTile(e){const t=e.level;let i=0;for(;i<this._queriesInvPtr;){const r=this._queries.data[i],n=r.extent;t>=r.minLevel&&t<=r.maxLevel&&n[0]<=e.extent[2]&&n[2]>=e.extent[0]&&n[1]<=e.extent[3]&&n[3]>=e.extent[1]?(this._queries.swapElements(i,this._queriesInvPtr-1),this._queriesInvPtr--):i++}}};(0,r._)([(0,w.Cb)()],sv.prototype,"updating",null),sv=(0,r._)([(0,x.j)("esri.views.3d.terrain.ScaleRangeQueries")],sv);var av=i(60199);class ov extends ny{constructor(e,t,i,r,n){super(),this._convexHull=new Array(24),this._boundingSphere=(0,es.c)(),this._baseUsedMemory=1816,this.init(e,t,i,r,n)}init(e,t,i,r,n){super.init(e,t,i,r,n);const s=this.ellipsoid.radius,a=this.extentInRadians[0],o=this.extentInRadians[1],l=this.extentInRadians[2],c=this.extentInRadians[3],h=(0,st.t7)(o,c,.5),u=(0,st.t7)(a,l,.5),d=0===e?0:Math.min(Math.abs(o),Math.abs(c));this._edgeLen=(l-a)*Math.cos(d)*s,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=s-Math.sqrt(s*s-this._edgeLen2/4),function(e,t,i,r){const n=Math.cos(i);e[0]=Math.cos(t)*n*r,e[1]=Math.sin(t)*n*r,e[2]=Math.sin(i)*r}(this.centerAtSeaLevel,u,h,this.ellipsoid.radius),(0,Pi.n)(this.up,this.centerAtSeaLevel),this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateBoundingVolumes();const e=this._center;if(0===this.lij[0])(0,Pi.i)((0,es.a)(e[hy.MIDDLE]),0,0,0),(0,Pi.i)(e[hy.TOP],0,0,0),(0,Pi.i)(e[hy.BOTTOM],0,0,0),e[hy.MIDDLE][3]=this.ellipsoid.radius+this.elevationBoundsMax;else{this._updateCenter();const t=e[hy.MIDDLE],i=this.convexHull;let r=0;for(let e=0;e<8;++e)r=Math.max(r,cv((0,es.a)(t),i,3*e));e[hy.MIDDLE][3]=Math.sqrt(r)}}_calculateFrustumVisibility(e){if(!(0,_c.hr)(e,this._boundingSphere))return Jg.OUTSIDE;if(this.lij[0]<10)return Jg.INTERSECTS;const t=this.convexHull,i=this.surface.view.state.camera.near;let r=!0;for(let n=0;n<_c.N9;n++){const s=n===_c.Nu.NEAR,a=e[n],o=a[0],l=a[1],c=a[2],h=a[3]-(s?i:0);let u=!1;for(let e=0;e<8;++e){const i=3*e;if(o*t[i]+l*t[i+1]+c*t[i+2]+h<0){if(u=!0,!r)break}else r=!1}if(!u)return Jg.OUTSIDE}return r?Jg.INSIDE:Jg.INTERSECTS}computeElevationBounds(){super.computeElevationBounds(),this._updateBoundingVolumes()}createGeometry(){by(this.renderData,this._getPatchType()),this._updateBoundingVolumes(),this.setMemoryDirty()}_updateBoundingVolumes(){this._updateConvexHull(),this._updateBoundingSphere(),X_.T9&&this._checkBVs()}_updateBoundingSphere(){const e=this._boundingSphere,t=(0,es.a)(e),i=this.elevationBoundsMin,r=this.elevationBoundsMax,n=this.ellipsoid.radius,s=r;if(0===this.level)(0,Pi.i)(t,0,0,0),e[3]=n+s;else{const s=this.extentInRadians,a=.5*(s[0]+s[2]),o=s[1],l=s[3];uv(pv,a,o,n),uv(mv,a,l,n),(0,Pi.f)(t,pv,mv),(0,Pi.g)(t,t,(n+.5*(i+r))/(0,Pi.H)(t));const c=this.convexHull;let h=0;const u=(e,t)=>{const i=e[0]-c[3*t],r=e[1]-c[3*t+1],n=e[2]-c[3*t+2];return Math.sqrt(i*i+r*r+n*n)};for(let e=0;e<8;++e){const i=u(t,e);h=Math.max(h,i)}const d=h;e[3]=d+2}}_updateConvexHull(){const e=this.extentInRadians,t=this.ellipsoid.radius;if(0===this.level)return;const i=this.elevationBoundsMin,r=this.elevationBoundsMax,n=this._getPatchType(),s=this.surface.isWebMercator,a=s&&n===eg.tk.HAS_NORTH_POLE,o=s&&n===eg.tk.HAS_SOUTH_POLE,l=o||a,c=Math.PI/2,h=e[0],u=e[2],d=o?-c:e[1],p=a?c:e[3],m=.5*(h+u),f=i,_=t+(l?Math.min(0,f-1):f),g=(e,t,i)=>uv(e,t,i,_),y=(0,R.Ue)(),v=(0,R.Ue)(),b=(0,R.Ue)(),w=(0,R.Ue)();g(y,h,d),g(v,h,p),g(b,u,p),g(w,u,d);const C=(e,t)=>{for(let i=0;i<3;++i)this._convexHull[3*t+i]=e[i]};C(y,0),C(v,1),C(b,2),C(w,3);const x=r,T=t+(l?Math.max(0,x+1):x),S=(0,R.Ue)(),M=(0,R.Ue)(),E=(0,R.Ue)();uv(M,m,p,_),uv(E,m,d,_),(0,Pi.f)(S,M,E),(0,Pi.n)(S,S);const P=(0,R.Ue)(),A=(0,R.Ue)(),O=(e,t)=>{(0,Pi.a)(A,e,t),(0,Pi.n)(A,A);const i=-(0,Pi.e)(e,P)/(0,Pi.e)(A,P);(0,X_.Fp)(i>=0),(0,Pi.g)(A,A,i),(0,Pi.f)(e,e,A)};if(2**this.lij[0]>2*this.lij[1]){const e=E,t=(0,R.Ue)();(0,Pi.h)(t,dv,e),(0,Pi.n)(t,t),(0,Pi.h)(P,e,t),(0,Pi.n)(P,P),(0,X_.Fp)((0,X_.Wq)((0,Pi.e)(P,e)/(0,Pi.H)(e),0)),O(y,v),O(w,b),C(y,0),C(w,3)}else if(2**this.lij[0]!==2*this.lij[1]){const e=M,t=(0,R.Ue)();(0,Pi.h)(t,dv,e),(0,Pi.n)(t,t),(0,Pi.h)(P,t,e),(0,Pi.n)(P,P),O(v,y),O(b,w),C(v,1),C(b,2)}const D=(e,t)=>{const i=T/(0,Pi.e)(t,S);for(let r=0;r<3;++r)this._convexHull[3*e+r]=t[r]*i};D(4,y),D(5,v),D(6,b),D(7,w)}_getPatchType(){const e=this.lij[1],t=0===e,i=e===(1<<this.level)-1;return t?i?eg.tk.HAS_BOTH_POLES:eg.tk.HAS_NORTH_POLE:i?eg.tk.HAS_SOUTH_POLE:eg.tk.REGULAR}intersectsRay(e,t,i,r){const n=this._boundingSphere,s=n[3]+i,a=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],o=n[0]-e[0],l=n[1]-e[1],c=n[2]-e[2],h=(o*t[0]+l*t[1]+c*t[2])/a,u=t[0]*h-o,d=t[1]*h-l,p=t[2]*h-c;return u*u+d*d+p*p<s*s}get minimumVerticesPerSide(){return this.level<lv.length?lv[this.level]+1:2}updateCornerElevations(){(function(e){e.tile.intersectsClippingArea&&(xy(e),Cy(e,!0),ky(e),e.intersectionData=null)})(this.renderData),this._updateBoundingVolumes()}updateEdgeElevations(){(function(e){e.tile.intersectsClippingArea&&(wy(e),ky(e),e.intersectionData=null)})(this.renderData),this._updateBoundingVolumes()}updateEdgeElevationsAndResolutions(){(function(e){e.tile.intersectsClippingArea&&(Ny(e),wy(e),ky(e),Vy(e),e.intersectionData=null)})(this.renderData),this._updateBoundingVolumes()}_checkBVs(){if(!X_.T9)return;if(this.level<=2)return;const e=this._boundingSphere,t=e[3],i=(0,es.a)(e),r=(0,R.Ue)(),n=this.ellipsoid.radius,s=this.elevationBoundsMin,a=this.elevationBoundsMax,o=n+s,l=this._center[hy.MIDDLE][3],c=this.convexHull,h=(e,t)=>{for(let i=0;i<3;++i)e[i]=c[3*t+i]};{const e=(0,R.Ue)(),t=(0,R.Ue)(),i=(0,R.Ue)(),r=(0,R.Ue)(),n=(0,R.Ue)(),s=(s,a,o,l)=>{h(t,s),h(i,a),h(r,o),(0,Pi.a)(t,t,i),(0,Pi.a)(r,r,i),(0,Pi.h)(e,t,r),(0,Pi.n)(e,e);const c=(0,Pi.e)(e,i);h(n,l);const u=(0,Pi.e)(e,n),d=Math.abs(u-c);(0,X_.Fp)((0,X_.Wq)(d,0),`Non coplanar ${s},${a},${o},${l} diff = ${d}`)};s(0,1,2,3),s(4,5,6,7),s(0,1,4,5),s(1,2,5,6),s(2,3,6,7),s(3,0,7,4)}const u=(0,av.bg)(24),d=(0,R.Ue)(),p=(0,R.Ue)(),m=(0,R.Ue)(),f=(0,R.Ue)(),_=(e,t,i,r)=>{h(d,t),h(p,i),h(m,r),(0,Pi.a)(d,d,p),(0,Pi.n)(d,d),(0,Pi.a)(m,m,p),(0,Pi.n)(m,m),(0,Pi.h)(f,d,m),(0,Pi.n)(f,f);const n=(0,Pi.e)(f,p);((e,t,i)=>{const r=4*e;for(let e=0;e<3;++e)u[r+e]=t[e];u[r+3]=i})(e,f,n)};_(0,0,1,2),_(1,1,0,4),_(2,1,5,2),_(3,3,2,6),_(4,4,0,3),_(5,4,6,5);const g=(e,t,i,r)=>{const n=4*e;return u[n]*t+u[n+1]*i+u[n+2]*r-u[n+3]},y=(e,t,i,r)=>g(e,t,i,r)>=-1,v=(e,t)=>y(e,t[0],t[1],t[2]),b=2**this.lij[0]>2*this.lij[1],w=(e,r,n)=>Math.sqrt(hv(e,r,n,i[0],i[1],i[2]))<t,C=e=>w(e[0],e[1],e[2]),x=(e,t)=>w(e[t],e[t+1],e[t+2]),T=this.extentInRadians,S=.5*(T[0]+T[2]),M=T[1],E=T[3],P=(0,R.Ue)(),A=(0,R.Ue)();uv(P,S,E,o),uv(A,S,M,o);const O=b?"Upper":"Lower";let D=!0;for(let e=0;e<6;++e){for(let t=0;t<8;++t){const i=3*t,r=y(e,c[i],c[i+1],c[i+2]);D&&=r,(0,X_.Fp)(r,`Tile[${this.lij}] Convex hull point ${t} outside of plane ${e}`)}(0,X_.Fp)(v(e,A),`Tile[${this.lij}] (${O}) bottom mid outside of plane ${e}`),(0,X_.Fp)(v(e,P),`Tile[${this.lij}] (${O}) top mid outside of plane ${e}`)}(0,X_.Fp)(D,"Not all convex hull points are inside  convex hull polyhedron"),(0,X_.Fp)(C(A),`Tile[${this.lij}] (${O}) bottom mid outside of bounding sphere`),(0,X_.Fp)(C(P),`Tile[${this.lij}] (${O}) top mid outside of bounding sphere`);for(let e=0;e<8;++e){const t=x(c,3*e);(0,X_.Fp)(t,`Tile[${this.lij}] Convex hull point ${e} outside of bounding sphere`)}for(let e=0;e<6;++e)for(let t=0;t<8;++t){const i=3*t;y(e,c[i],c[i+1],c[i+2])||console.error(`Tile[${this.lij}] Convex hull point ${t} outside of plane ${e}`)}const{extentInRadians:I}=this,L=Math.max(I[2]-I[0],I[3]-I[1]),N=Math.round(L*n),{renderData:F}=this;if(!F)return;const{geometry:U,geometryState:H,localOrigin:k}=F,V=U.vertexAttributes?.position;if(!V)return;const B=(0,R.Ue)(),z=U.numVerticesPerSide-2,{indices:G,indexCount:q,edgeVerticesStartIndex:Z,poleVerticesStartIndex:j}=U;if(!G)return;const W=new Set;for(let e=0;e<q;++e){const o=G[e];if(W.has(o))continue;W.add(o);const c=o<j,h=o>=Z;let u=!1,d=-1;if(h){let e=Z;for(let t=0;t<4;++t){const i=H.edgeResolutions[t];if(o===e||o===e+i-1){u=!0;break}if(e+=i,o<e){d=t;break}}}const p=h?H.edgePeerNeighbors[d]:null,m=h&&p&&(0,Eg.gl)(this,p)>0;V.getVec(o,r),(0,Pi.f)(B,r,k);const f=(0,Pi.H)(B)-n;let _=0,v=!1;const b=s-f,w=f-a,C=b>1,x=w>1,T=C||x,S=()=>{const e=c?"internal":h&&!u?"edge":u?"corner":"pole";return`Tile[${this.lij}].vertex[${o}]:${e}`+(C?"(below)":x?"(above)":"")+(m?"(Neighbor)":"")},M=(0,Pi.F)(B,i);if(M>=t+0){const e=M-t;T||(console.error(`${S()} is out of the bounding sphere by ${e.toFixed(0)} / ${t.toFixed(0)}[tol=0] h=${f.toFixed(0)} / [${s.toFixed(0)}..${a.toFixed(0)}] (${(e/t).toFixed(0)})`),v=!0)}for(let e=0;e<6;++e)if(!y(e,B[0],B[1],B[2])){const i=g(e,B[0],B[1],B[2]),r=o%z,n=(o-r)/z;0===e&&b||5===e&&w||(console.error(`${S()} (${r},${n})|${z}] is out of the bounding trapezoid plane ${e} h=${Math.round(f)} / [${Math.round(s)}..${Math.round(a)}] dist=${Math.round(i)} radii = ${Math.round(t)}/${Math.round(l)}} : maxL = ${N}`),++_)}if(v||_>0)break}}get convexHull(){return this._convexHull}}const lv=[128,64,64,32,16,8,8,4];function cv(e,t,i){return hv(e[0],e[1],e[2],t[i],t[i+1],t[i+2])}function hv(e,t,i,r,n,s){const a=r-e,o=n-t,l=s-i;return a*a+o*o+l*l}const uv=(e,t,i,r)=>{const n=Math.cos(t),s=Math.sin(t),a=Math.cos(i),o=Math.sin(i);e[0]=r*a*n,e[1]=r*a*s,e[2]=r*o},dv=[0,0,1],pv=(0,R.Ue)(),mv=(0,R.Ue)();let fv=class extends S.Z{constructor(){super(...arguments),this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}};(0,r._)([(0,w.Cb)()],fv.prototype,"fovX",void 0),(0,r._)([(0,w.Cb)()],fv.prototype,"fovY",void 0),(0,r._)([(0,w.Cb)()],fv.prototype,"relativeWidthLimit",void 0),(0,r._)([(0,w.Cb)()],fv.prototype,"relativeHeightLimit",void 0),(0,r._)([(0,w.Cb)()],fv.prototype,"maxLod",void 0),(0,r._)([(0,w.Cb)()],fv.prototype,"angledSplitBias",void 0),(0,r._)([(0,w.Cb)()],fv.prototype,"aboveGround",void 0),(0,r._)([(0,w.Cb)()],fv.prototype,"frustum",void 0),fv=(0,r._)([(0,x.j)("esri.views.3d.terrain.SplitLimits")],fv);var _v=i(81342),gv=i(61796);const yv=(0,br.U$)().vec3f(mr.T.POSITION).vec2u16(mr.T.UV0,{glNormalized:!0}).vec2i16(mr.T.NORMALCOMPRESSED,{glNormalized:!0});class vv{constructor(e){this._storage=new H_(((t,i)=>e.newCache(t,i)),"TileGeometry")}acquire(e){const t=4*Math.ceil(e/4),i=this._storage,r=function(e){return e.toString()}(t),n=i.pop(r);if(n)return n;const s=yv.createBuffer(t);return s.release=()=>i.put(r,s),s}clear(){this._storage.clear()}destroy(){this._storage.destroy()}}function bv(e){return(0,B.aQ)(e.layer)}var wv=i(58226),Cv=i(91102);class xv extends wv.R{constructor(){super(...arguments),this.opacity=1,this.baseOpacity=1,this.texture=null,this.fboTexture=null,this.backgroundColor=R.AG}}class Tv extends Wi.A{constructor(e,t){super(e,t,new ji.J(Cv.B,(()=>i.e(5755).then(i.bind(i,5755)))))}}var Sv=i(20350),Mv=(i(71090),i(64544)),Ev=(i(85600),i(13772),i(5379)),Pv=i(11034),Rv=i(76496),Av=i(92937),Ov=i(8267);class Dv{constructor(e,t,i,r,n,s){this._symbols=e,this._styleRepository=r,this._zoom=n,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new Av.HX(t,i,Rv.cn),this._si=Math.sin(Math.PI*s/180),this._co=Math.cos(Math.PI*s/180),r.cachedStyles&&(this._styleProps=r.cachedStyles);for(const t of e)for(const e of t.symbols)this._allNeededMatrices.has(e.tile)||this._allNeededMatrices.set(e.tile,(0,Pv.d9)(e.tile.transforms.tileUnitsToPixels))}work(e){const t=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){const i=this._symbols[this._currentLayerCursor],r=this._getProperties(i.styleLayerUID),n=this._styleRepository.layerContexts?.get(i.styleLayerUID);for(;this._currentSymbolCursor<i.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-t>e)return!1;const s=i.symbols[this._currentSymbolCursor];if(!s.uniqueSymbol?.show)continue;const a=this._computeCoordinates(s,r,n),o=s.uniqueSymbol;if(!o.show)continue;const{iconAllowOverlap:l,textAllowOverlap:c}=r;for(const e of a){if(!e.enabled)continue;const t=o.parts[e.partIndex];t.show&&(!(e.partIndex?c:l)&&this._doesCollide(e)&&(e.hard?o.show=!1:t.show=!1))}o.show&&this._insertColliders(o.parts,a,r)}}return!0}_insertColliders(e,t,i){const{iconIgnorePlacement:r,textIgnorePlacement:n}=i;for(const i of t){if(!i.enabled)continue;if(i.partIndex?n:r)continue;if(!e[i.partIndex].show)continue;const t=i.xScreen+i.dxScreen,s=i.yScreen+i.dyScreen,a=t+i.width,o=s+i.height,[l,c,h,u]=this._gridIndex.getCellSpan(t,s,a,o);for(let e=c;e<=u;e++)for(let t=l;t<=h;t++)this._gridIndex.cells[e][t].push(i)}}_computeCoordinates(e,t,i){const{iconRotationAlignment:r,textRotationAlignment:n,iconTranslate:s,iconTranslateAnchor:a,textTranslate:o,textTranslateAnchor:l}=t,c=this._si,h=this._co,u=this._zoom,d=this._allNeededMatrices.get(e.tile),p=e.uniqueSymbol,m=e.colliders(i);let f=0;for(const e of m){const[t,i]=0===e.partIndex?s:o,p=0===e.partIndex?a:l,m=e.minLod<=u&&u<=e.maxLod;f+=m?0:1,e.enabled=m,e.xScreen=e.xTile*d[0]+e.yTile*d[3]+d[6],e.yScreen=e.xTile*d[1]+e.yTile*d[4]+d[7],p===Ov.fD.MAP?(e.xScreen+=h*t-c*i,e.yScreen+=c*t+h*i):(e.xScreen+=t,e.yScreen+=i),Ov.aF.VIEWPORT===(0===e.partIndex?r:n)?(e.dxScreen=e.dxPixels,e.dyScreen=e.dyPixels):(e.dxScreen=h*(e.dxPixels+e.width/2)-c*(e.dyPixels+e.height/2)-e.width/2,e.dyScreen=c*(e.dxPixels+e.width/2)+h*(e.dyPixels+e.height/2)-e.height/2)}return m.length>0&&f===m.length&&p&&(p.show=!1),m}_getProperties(e){const t=this._styleProps.get(e);if(t)return t;const i=this._styleRepository.getLayerStyleProperties?.(e,this._zoom);return this._styleProps.set(e,i),i}_doesCollide(e){const t=e.xScreen+e.dxScreen,i=e.yScreen+e.dyScreen,r=t+e.width,n=i+e.height,[s,a,o,l]=this._gridIndex.getCellSpan(t,i,r,n);for(let e=a;e<=l;e++)for(let a=s;a<=o;a++){const s=this._gridIndex.cells[e][a];for(const e of s){const s=e.xScreen+e.dxScreen,a=e.yScreen+e.dyScreen,o=s+e.width,l=a+e.height;if(!(r<s||t>o||n<a||i>l))return!0}}return!1}}var Iv=i(25330),Lv=i(30393);function Nv(e){return(e.uniqueSymbol?.show&&e.uniqueSymbol?.lastShow)??!1}function Fv(e,t){if(e.priority-t.priority)return e.priority-t.priority;if(Nv(e)&&!Nv(t))return-1;if(Nv(t)&&!Nv(e))return 1;const i=e.tile.key,r=t.tile.key;return i.world-r.world?i.world-r.world:i.level-r.level?i.level-r.level:i.row-r.row?i.row-r.row:i.col-r.col?i.col-r.col:e.xTile-t.xTile?e.xTile-t.xTile:e.yTile-t.yTile}class Uv{get running(){return this._running}constructor(e,t,i,r,n,s,a,o){this.selectionMode=e,this._visibleTiles=t,this._symbolRepository=i,this._styleRepository=r,this._createCollisionJob=n,this._assignTileSymbolsOpacity=s,this._symbolLayerSorter=a,this._isLayerVisible=o,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}setScreenSize(e,t){this._screenWidth===e&&this._screenHeight===t||this.restart(),this._screenWidth=e,this._screenHeight=t}restart(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}continue(e){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){const t=performance.now();if(!this._selectionJob.work(e))return!1;if(this._selectionJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-t))))return!1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){const t=performance.now();if(!this._collisionJob.work(e))return!1;if(this._collisionJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-t))))return!1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){const t=performance.now();if(!this._opacityJob.work(e))return!1;if(this._opacityJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-t))))return!1}return this._running=!1,!0}_isFeatureFiltered(e,t,i){const r=t.getFilterFlags(e),n=r&Lv.g3,s=null==i.featureEffect||i.featureEffect.excludedLabelsVisible||r&Lv.kU;return!(n&&s)}_getFilteredByLayer(){let e;if(this._styleRepository?.layerContexts)for(const t of this._symbolRepository.uniqueSymbols){const i=this._styleRepository.layerContexts?.get(t.styleLayerUID);if(i?.attributeView)for(const r of t.uniqueSymbols){e??=new Map,e.get(t.styleLayerUID)||e.set(t.styleLayerUID,new Set);const n=e.get(t.styleLayerUID),s=i.attributeView,a=i.layerView;this._isFeatureFiltered(r.id,s,a)&&n.add(r.id)}}return e}_resetSelection(){for(let e=0;e<this._symbolRepository.uniqueSymbols.length;e++){const t=this._symbolRepository.uniqueSymbols[e];for(let e=0;e<t.uniqueSymbols.length;e++){const i=t.uniqueSymbols[e];for(const e of i.tileSymbols)e.selectedForRendering=!1}}}_createSelectionJob(){const e="feature-tile"===this.selectionMode?kv:Vv,t=this._symbolRepository.uniqueSymbols;this._resetSelection();const i=[];let r=0,n=0;const s=this._isLayerVisible,a=this._getFilteredByLayer(),o=this._styleRepository?.layerContexts;const l=this._symbolLayerSorter;return{work:function(l){let c;const h=performance.now();for(;n<t.length;n++,r=0){const u=t[n],d=u.styleLayerUID,p=a?.get(d);let m=0;if(o){const e=o.get(d).layerView;m=e.view.allLayerViews.items.indexOf(e)}if(!s(d)){i[n]||(i[n]={styleLayerUID:d,layerOrder:m,symbols:[]});continue}i[n]||={styleLayerUID:d,symbols:[],layerOrder:m};const f=i[n];for(;r<u.uniqueSymbols.length;r++){if(c=u.uniqueSymbols[r],r%100==99&&performance.now()-h>l)return!1;if(c.lastShow=c.show,c.id&&p?.has(c.id)){c.show=!1,c.parts[0].show=!1,c.parts[1].show=!1;continue}const t=e(c);if(t){t.selectedForRendering=!0,f.symbols.push(t),c.show=!0;for(const e of c.parts)e.show=!0}else c.show=!1}}for(const e of i)e.symbols.sort(Fv);return i.sort(((e,t)=>t.layerOrder-e.layerOrder)),!0},get sortedSymbols(){return i.sort(l)}}}_createOpacityJob(){const e=this._assignTileSymbolsOpacity,t=this._visibleTiles;let i=0;function r(t,i){for(const e of t.symbols.values())Hv(e,i);e(t,i);for(const e of t.childrenTiles)r(e,i)}return{work(n){const s=performance.now();for(;i<t.length;i++){if(performance.now()-s>n)return!1;const a=t[i];if(null!=a.parentTile)continue;const o=performance.now();a instanceof Iv.i?r(a,o):e(a,o)}return!0}}}}function Hv(e,t){for(const i of e){const e=i.uniqueSymbol;for(const i of e.parts){const r=i.targetOpacity>.5?1:-1;i.startOpacity+=r*((t-i.startTime)/Rv.v7),i.startOpacity=Math.min(Math.max(i.startOpacity,0),1),i.startTime=t,i.targetOpacity=e.show&&i.show?1:0}}}function kv(e){let t=null,i=null,r=null;for(const n of e.tileSymbols){const e=n.tile;e.isReady&&e.isCoverage?t=n:e.isReady?i=n:e.rendering&&(r=n)}return t??i??r}function Vv(e){let t=null,i=!1,r=!1;for(const n of e.tileSymbols)if(!r||!i){const e=n.tile;(!t||e.isCoverage||e.neededForCoverage&&!i)&&(t=n,(e.neededForCoverage||e.isCoverage)&&(r=!0),e.isCoverage&&(i=!0))}return r?t:null}var Bv=i(64274);class zv{static fromSymbols(e,t){let i=e.length;if(i>=Gv){let r=t;do{r/=2,i/=4}while(i>qv&&r>Zv);const n=new Av.HX(t,t,r);for(const t of e)n.getCell(t.xTile,t.yTile).push(t);return new zv(t,e,n)}return new zv(t,e,null)}constructor(e,t,i){this.tileCoordRange=e,this._symbols=t,this._index=i}addSymbols(e){for(const t of e)this._symbols.push(t);if(this._index)for(const t of e)this._index.getCell(t.xTile,t.yTile).push(t)}removeSymbols(e){const t=new Set(e);if(this._symbols=this._symbols.filter((e=>!t.has(e))),this._index)for(const e of this._index.cells)for(let i=0;i<e.length;i++)e[i]=e[i].filter((e=>!t.has(e)))}getSymbols(){return this._symbols}getCandidate(e,t,i,r){if(!this._index){for(const n of this._symbols)if(i===n.hash&&Math.abs(e-n.xTile)<=r&&Math.abs(t-n.yTile)<=r)return n;return null}const n=this._index.getCellSpan(e-r,t-r,e+r,t+r),[s,a,o,l]=n;for(let n=a;n<=l;n++)for(let a=s;a<=o;a++){const s=this._index.cells[n][a];for(const n of s)if(i===n.hash&&Math.abs(e-n.xTile)<=r&&Math.abs(t-n.yTile)<=r)return n}return null}}const Gv=32,qv=8,Zv=64;class jv{constructor(e,t){this.tileCoordRange=e,this._visibleTiles=t,this._indexMapByTile=new Map,this._uniqueSymbolsByStyleLayerId=new Map}get uniqueSymbols(){return null==this._uniqueSymbolLayerArray&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray()),this._uniqueSymbolLayerArray}registerVectorTile(e,t){const i=this._ensureIndexMap(e),r=t?.values()??i.keys();for(const e of r){const t=i.get(e);t&&(this._removeSymbols(e,t.getSymbols()),i.delete(e))}this._addSymbols(e.key,i,e.symbols),this._invalidate()}unregisterVectorTile(e){this._removeTile(e),this._invalidate()}registerFeatureTile(e){this._ensureIndexMap(e),this._invalidate()}unregisterFeatureTile(e){this._removeTile(e),this._invalidate()}insertFeatureTileMetrics(e,t){const i=this._indexMapByTile.get(e);if(!i)throw new Error(`tile ${e.id} not registered!`);this._addSymbols(e.key,i,Wv(t)),this._invalidate()}removeFeatureTileMetrics(e,t){const i=this._indexMapByTile.get(e);if(!i)return;const r=Wv(t);for(const[e,t]of i.entries()){const i=r.get(e);i&&(t.removeSymbols(i),this._removeSymbols(e,i))}this._invalidate()}deleteStyleLayers(e){for(const t of this._indexMapByTile.values())for(const i of e){const e=t.get(i);e&&(this._removeSymbols(i,e.getSymbols()),t.delete(i))}this._invalidate()}querySymbols(e,t,i,r){const n=[];for(const[r,s]of this._uniqueSymbolsByStyleLayerId.entries())for(const a of s){const s=a.tileSymbols.find((e=>e.selectedForRendering));s&&(0,Av.Fe)(s,e,t*(window.devicePixelRatio||1),i)&&n.push({vtlSymbol:s,styleLayerUID:r,tileKey:s.tile.key})}return n}_ensureIndexMap(e){let t=this._indexMapByTile.get(e);return t||(t=new Map,this._indexMapByTile.set(e,t)),t}_invalidate(){this._uniqueSymbolLayerArray=null}_addSymbols(e,t,i){for(const[e,r]of i){let i=t.get(e);i?i.addSymbols(r):(i=zv.fromSymbols(r,this.tileCoordRange),t.set(e,i))}this._updateUniqueSymbols(e,i)}_removeTile(e){const t=this._indexMapByTile.get(e);if(t){for(const[e,i]of t.entries())this._removeSymbols(e,i.getSymbols());this._indexMapByTile.delete(e),this._invalidate()}}_removeSymbols(e,t){for(const i of t){const t=i.uniqueSymbol;if(t){if(t.tileSymbols=t.tileSymbols.filter((e=>e!==i)),0===t.tileSymbols.length){const i=this._uniqueSymbolsByStyleLayerId.get(e);i.delete(t),0===i.size&&this._uniqueSymbolsByStyleLayerId.delete(e)}i.uniqueSymbol=null}}}_updateUniqueSymbols(e,t){if(0!==t.size){for(const i of this._visibleTiles)i.parentTile||i.key.world!==e.world||i.key.level===e.level&&!i.key.equals(e)||this._matchSymbols(i,e,t);for(const[e,i]of t)for(const t of i)if(!t.uniqueSymbol){t.uniqueSymbol=new Bv.V(t);let i=this._uniqueSymbolsByStyleLayerId.get(e);i||(i=new Set,this._uniqueSymbolsByStyleLayerId.set(e,i)),i.add(t.uniqueSymbol)}}}_matchSymbols(e,t,i){if(e.key.level>t.level){const i=e.key.level-t.level;if(e.key.row>>i!==t.row||e.key.col>>i!==t.col)return}if(t.level>e.key.level){const i=t.level-e.key.level;if(t.row>>i!==e.key.row||t.col>>i!==e.key.col)return}const r=new Map;for(const[n,s]of i){const i=[],a=20+(e.key.level<t.level?1:1<<e.key.level-t.level),o=this._indexMapByTile.get(e)?.get(n);if(o)for(const r of s){if(r.uniqueSymbol)continue;const n=(0,Av.rX)(this.tileCoordRange,r.xTile,t,e.key),s=(0,Av.Yc)(this.tileCoordRange,r.yTile,t,e.key),l=-20,c=this.tileCoordRange+20;if(!(n>=l&&n<c&&s>=l&&s<c)){i.push(r);continue}const h=o.getCandidate(n,s,r.hash,a)?.uniqueSymbol;h?(r.uniqueSymbol=h,h.tileSymbols.push(r)):i.push(r)}i.length>0&&r.set(n,i)}for(const i of e.childrenTiles||[])this._matchSymbols(i,t,r)}_createUniqueSymbolLayerArray(){const e=this._uniqueSymbolsByStyleLayerId,t=new Array(e.size);let i,r=0;for(const[n,s]of e){const e=new Array(s.size);i=0;for(const t of s)e[i++]=t;t[r]={styleLayerUID:n,uniqueSymbols:e},r++}return t}}function Wv(e){const t=new Map;for(const i of e){const e=i.labelClassId;let r=t.get(e);r||(r=[],t.set(e,r)),r.push(i)}return t}const $v=(0,Pv.Ue)();var Xv=i(58783);class Yv extends Xv.I{_createTransforms(){return{displayViewScreenMat3:(0,Pv.Ue)(),tileMat3:(0,Pv.Ue)()}}}class Kv{constructor(){this._candidateTiles=[]}schedule(e){this._candidateTiles.includes(e)||this._candidateTiles.push(e)}reshuffle(e){const t=[];for(const i of this._candidateTiles)e>0?(i.reshuffle(),e--):t.push(i);this._candidateTiles=t}}class Qv{constructor(){this._renderParams={reshuffleManager:new Kv,context:null,drawPhase:1,state:new Jv,stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,allowDelayedRender:!1,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1,highlightGradient:null,stencilSymbols:!0,is3D:!0,backgroundColor:null},this._backgroundTile=new Yv(new Mv.Z(0,0,0,0),0,0,0,Ev.er,Ev.er,Ev.V2,Ev.V2),this._heading=0,this._declutteredForHeading=new WeakMap}dispose(){this._renderParams=null}renderBackground(e,t,i,r,n,s,a,o,l,c){const h=this._backgroundTile;this._updateRenderParameters(e,t,h,i,n,s,a,o,l,c),this._renderParams.stencilSymbols=!1,i.drawBackground(this._renderParams,h,r)}renderContent(e,t,i,r,n,s,a,o,l,c,h,u){this._declutter(i),r.forAll((({sourceLayerInfo:{data:e}})=>this._declutter(e)));const d=r.length>0;d&&this._stencilSymbols(e,t,i,r,n,s,a,o,l,c,h,u);let p=1;i.stencilRef=d?p:0,e.setStencilFunction($i.wb.EQUAL,i.stencilRef,255),this._render(e,t,i,n,s,a,o,l,c,h,u),r.forAll((({sourceLod:t,offset:i,sourceLayerInfo:{data:r}})=>{r.stencilRef=++p,this._renderSymbols(e,t,r,n,s,a,o,i,c,h,u)}))}_stencilSymbols(e,t,i,r,n,s,a,o,l,c,h,u){let d=1;i.stencilRef=d,e.setDepthTestEnabled(!1),e.setDepthWriteEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp($i.xS.KEEP,$i.xS.KEEP,$i.xS.REPLACE),e.setStencilWriteMask(255),e.setStencilFunction($i.wb.ALWAYS,i.stencilRef,255),this._stencilTileSymbols(e,t,i,n,s,a,o,l,c,h,u),r.forAll((({sourceLod:t,offset:i,sourceLayerInfo:{data:r}})=>{r.stencilRef=++d,e.setStencilFunction($i.wb.ALWAYS,r.stencilRef,255),this._stencilTileSymbols(e,t,r,n,s,a,o,i,c,h,u)})),e.setStencilWriteMask(0),e.setBlendingEnabled(!0),e.setDepthTestEnabled(!0),e.setColorMask(!0,!0,!0,!0)}_renderSymbols(e,t,i,r,n,s,a,o,l,c,h){e.setStencilFunction($i.wb.EQUAL,i.stencilRef,255),this._render(e,t,i,r,n,s,a,o,l,c,h,Ov.fR.SYMBOL)}_render(e,t,i,r,n,s,a,o,l,c,h,u){this._updateRenderParameters(e,t,i,r,s,a,o,l,c,h),this._renderParams.stencilSymbols=!1,r.drawTile(this._renderParams,i,n,u)}_stencilTileSymbols(e,t,i,r,n,s,a,o,l,c,h){this._updateRenderParameters(e,t,i,r,s,a,o,l,c,h),this._renderParams.stencilSymbols=!0,i.triangleCount=0,r.drawSymbols(this._renderParams,i,n)}_updateRenderParameters(e,t,i,r,n,s,a,o,l,c){"type"in i&&"vector-tile"===i.type&&!i.stage&&i.attachWithContext(e);const h=t[0]-n.getLevelShift(t[0]),u=this._renderParams;u.context=e,u.painter=r,u.glyphMosaic=r.glyphMosaic,u.spriteMosaic=r.spriteMosaic,u.pixelRatio=l*c,u.displayLevel=h,u.requiredLevel=h;const d=n.getScale(t[0]),[p,m]=n.getOffset(t,s*d),f=Ev.dp*s*d/o,_=i.transforms.displayViewScreenMat3;_[0]=f,_[4]=-f,_[6]=-1-p-a[0]*s*2,_[7]=1+m+(1-a[1])*s*2-2;const g=u.state,y=o/c;g.size[0]=y,g.size[1]=y,g.pixelRatio=c,g.rotation=(360-this._heading)%360;const v=2/y;(0,ki.t8)(g.displayViewMat3,v,0,0,0,-v,0,-1,1,1);const b=(0,ki.yR)(g.displayMat3),w=(0,ka.c$)(this._heading);(0,ki.Iu)(b,b,[y/2,y/2]),(0,ki.U1)(b,b,w),(0,ki.Iu)(b,b,[-y/2,-y/2]),(0,ki.Jp)(b,g.displayViewMat3,b)}updateHeading(e){this._heading=e}_declutter(e){this._declutteredForHeading.get(e)!==this._heading&&(function(e,t){const i=e.transforms.tileUnitsToPixels,r=(0,ka.c$)(t),n=Math.cos(r),s=Math.sin(r),a=Math.ceil(512*(Math.abs(s)+Math.abs(n)));(0,ki.yR)($v),(0,ki.Iu)($v,$v,[a/2,a/2]),(0,ki.U1)($v,$v,r),(0,ki.Iu)($v,$v,[-256,-256]),(0,ki.bA)($v,$v,[1/8,1/8,1]),e.transforms.tileUnitsToPixels=$v;const o=[],l=new jv(Ev.V2,o),c=new Uv("vector-tile",o,l,null,((i,r,n)=>new Dv(i,r,n,e.styleRepository,e.key.level,t)),((e,t)=>{(0,Av.C$)(e,t,!1)}),(()=>0),(t=>{const i=e.styleRepository.getStyleLayerByUID(t).getLayoutProperty("visibility");return!i||i.getValue()!==Ov.EE.NONE}));o.push(e),l.registerVectorTile(e),c.setScreenSize(a,a),c.continue(1/0),l.unregisterVectorTile(e),e.transforms.tileUnitsToPixels=i}(e,(360-this._heading)%360),this._declutteredForHeading.set(e,this._heading))}}class Jv{constructor(){this.size=[0,0],this.pixelRatio=1,this.rotation=0,this.displayMat3=(0,Ea.Ue)(),this.displayViewMat3=(0,Ea.Ue)(),this.transform=null,this.inverseTransform=null,this.viewMat2d=null,this.viewMat3=null,this.id=0,this.extent=null,this.center=null,this.scale=1,this.resolution=0,this.worldScreenWidth=0,this.spatialReference=null,this.viewpoint=null,this.getScreenTransform=null,this.toMap=null,this.toScreen=null,this.clone=null,this.copy=null,this.toJSON=null}}var eb=i(17993),tb=i(83046);class ib extends tb.m{constructor(){super(...arguments),this.blendMode=eb.iM.Normal}}(0,r._)([(0,tb.o)({count:eb.iM.COUNT})],ib.prototype,"blendMode",void 0);var rb=i(93288),nb=i(82214),sb=i(12024);class ab extends ib{constructor(){super(...arguments),this.output=nb.l.Composite,this.baseOpacityMode=rb.I.NotRequired,this.premultipliedSource=sb.m.Off}}(0,r._)([(0,tb.o)({count:nb.l.COUNT})],ab.prototype,"output",void 0),(0,r._)([(0,tb.o)({count:rb.I.COUNT})],ab.prototype,"baseOpacityMode",void 0),(0,r._)([(0,tb.o)({count:sb.m.COUNT})],ab.prototype,"premultipliedSource",void 0);class ob extends ab{constructor(){super(...arguments),this.background=Cv.a.BelowLayer}}(0,r._)([(0,tb.o)({count:Cv.a.COUNT})],ob.prototype,"background",void 0);var lb=i(86295);class cb extends Wi.A{constructor(e,t){super(e,t,new ji.J(lb.R,(()=>i.e(41709).then(i.bind(i,41709)))))}}class hb extends ab{constructor(){super(...arguments),this.colorizerType=Sv.U.Stretch,this.stretchType=Sv.H.Noop,this.applyColormap=!0,this.requireBilinearWithNN=!1}}(0,r._)([(0,tb.o)({count:Sv.U.COUNT})],hb.prototype,"colorizerType",void 0),(0,r._)([(0,tb.o)({count:Sv.H.COUNT})],hb.prototype,"stretchType",void 0),(0,r._)([(0,tb.o)()],hb.prototype,"applyColormap",void 0),(0,r._)([(0,tb.o)()],hb.prototype,"requireBilinearWithNN",void 0);var ub=i(54704);class db{constructor(e){this._rctx=e,this._fbos=new Map}get(e){return this._getPool(e)}dispose(){this._fbos.forEach((e=>e.dispose())),this._fbos.clear()}_getPool(e){const t=this._fbos.get(e);if(t)return t;const i=new tr.X(this._rctx,new ir.X(e),new ub.Y($i.wo.DEPTH24_STENCIL8,e));return this._fbos.set(e,i),i}}var pb=i(1812),mb=i(54753);class fb{constructor(e,t){this._rctx=e,this._techniques=t,this._fbos=[],this._vectorTileHelper=new Qv,this._bindParameters=new pb.p(null),this._blendConfiguration=new ob,this._current=0,this._lastUsedIds=new Array,this._lastCreatedBufferId=0,this._onHoldIds=new Array,this._vaoQuad=(0,mb.ow)(this._rctx,mb.Ar.Pos2Tex)}dispose(){this._fbos.forEach(p.M2),this._fbos=null,this._vtFBO=(0,p.M2)(this._vtFBO),this._vaoQuad=(0,p.M2)(this._vaoQuad),this._vectorTileHelper=(0,p.M2)(this._vectorTileHelper)}updateHeading(e){this._vectorTileHelper?.updateHeading(e)}_acquireBlendTechnique(e,t,i,r=sb.m.Off,n=Cv.a.BelowLayer){return this._blendConfiguration.output=t,this._blendConfiguration.blendMode=e,this._blendConfiguration.baseOpacityMode=i,this._blendConfiguration.premultipliedSource=r,this._blendConfiguration.background=n,this._techniques.precompile(Tv,this._blendConfiguration),this._techniques.get(Tv,this._blendConfiguration)}drawBackground(e,t){const i=this._acquireBlendTechnique(eb.iM.Normal,t?nb.l.ColorComposite:nb.l.GridComposite,rb.I.NotRequired,sb.m.Off,Cv.a.Only),r=this._rctx.bindTechnique(i,this._bindParameters,e);this._render(r)}_render(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays($i.MX.TRIANGLE_STRIP,0,(0,Er._V)(this._vaoQuad,"geometry"))}drawGroup(e,t,i,r,n=sb.m.On){t===nb.l.Composite&&(e.fboTexture=this._fbos[this.getLastOnHoldId()].get(i).colorTexture,null==e.fboTexture&&(e.fboTexture=this._rctx.emptyTexture)),e.texture=this.currentFBO(i).colorTexture,this.closeGroup(i);const s=e.baseOpacity<1?rb.I.Required:rb.I.NotRequired,a=this._acquireBlendTechnique(r,t,s,n),o=this._rctx.bindTechnique(a,this._bindParameters,e);this._render(o)}drawImageData(e,t,i,r,n=sb.m.Off){if(null==e.texture)return;const s=e.baseOpacity<1?rb.I.Required:rb.I.NotRequired;e.fboTexture=t===nb.l.GroupBackgroundComposite||r===eb.iM.Normal&&s===rb.I.NotRequired&&n===sb.m.Off?null:this.switch(i).colorTexture,null==e.fboTexture&&(e.fboTexture=this._rctx.emptyTexture);const a=this._acquireBlendTechnique(r,t,s,n),o=this._rctx.bindTechnique(a,this._bindParameters,e);this._render(o)}drawRasterData(e,t,i,r,n){const s=n.sourceLayerInfo.data;if(!s.source)return;if(n.tile.surface.layerViewByIndex(n.layerIndex,hf.MAP).ensureSymbolizerParameters(s),!s.bind(this._rctx))return;const a=e.baseOpacity<1?rb.I.Required:rb.I.NotRequired;e.fboTexture=r===eb.iM.Normal&&a===rb.I.NotRequired?null:this.switch(i).colorTexture;const o=this._acquireRasterTechnique(s,t,r,a);if(!o)return;s.opacity=e.opacity;const l=s.getUniforms(this._rctx);l.scale=n.scale,l.offset=n.offset,l.backgroundColor=e.backgroundColor,l.fboTexture=e.fboTexture,l.baseOpacity=e.baseOpacity;const c=this._rctx.bindTechnique(o,this._bindParameters,l);this._render(c)}_acquireRasterTechnique(e,t,i,r){if(!this._rctx.capabilities.colorBufferFloat)return null;const n=e.symbolizerParameters,s=["stretch","lut","hillshade"].indexOf(n.type);return this._rasterConfiguration??=new hb,this._rasterConfiguration.output=t,this._rasterConfiguration.blendMode=i,this._rasterConfiguration.baseOpacityMode=r,this._rasterConfiguration.colorizerType=s,this._rasterConfiguration.applyColormap=!!n.colormap,this._rasterConfiguration.requireBilinearWithNN=e.isBilinearWithStretchColorRamp,this._rasterConfiguration.stretchType=e.hasStretchTypeNone()?Sv.H.Noop:Sv.H.PerBand,this._techniques.precompile(cb,this._rasterConfiguration),this._techniques.get(cb,this._rasterConfiguration)}drawVectorData(e,t,i,r,n,s,a,o){const l=this._rctx,c=n.sourceLayerInfo.data,h=n.tile.surface.layerViewByIndex(n.layerIndex,hf.MAP),u=e.baseOpacity<1?rb.I.Required:rb.I.NotRequired,p=u===rb.I.Required||e.opacity<1||r!==eb.iM.Normal||t!==nb.l.Composite,m=p?sb.m.On:sb.m.Off,f=this._acquireBlendTechnique(r,t,u,m);l.setPipelineState(f.getPipeline());let _=null,g=null;p?(g=this.currentFBO(i),null==this._vtFBO&&(this._vtFBO=new db(this._rctx)),_=this._vtFBO.get(i),l.bindFramebuffer(_),this._clearCurrentFBO()):o&&l.clear($i.Hf.DEPTH);try{this._vectorTileHelper.renderBackground(l,n.sourceLod,h.painter,h.layer.styleRepository,h.schemaHelper,Math.round(1/n.scale),n.offset,a,s,h.contentZoom),c&&this._vectorTileHelper.renderContent(l,n.sourceLod,c,n.vtlNeighborInfos,h.painter,h.layer.styleRepository,h.schemaHelper,Math.round(1/n.scale),n.offset,a,s,h.contentZoom)}catch(e){d.Z.getLogger("esri.views.3d.terrain").warnOnce("A render call containing vector tiles did not resolve correctly.",e)}return!_||(l.bindFramebuffer(g),e.texture=_.colorTexture,e.offset=Gi.AG,e.scale=1,this.drawImageData(e,t,i,r,m),o)}copyFBOToTexture(e){const t=this._rctx,i=t.bindTexture(e.texture,Ed.x.TEXTURE_UNIT_FOR_UPDATES),r=e.descriptor;t.gl.copyTexImage2D($i.No.TEXTURE_2D,0,r.pixelFormat,0,0,r.width,r.height,0),e.generateMipmap(),t.bindTexture(i,Ed.x.TEXTURE_UNIT_FOR_UPDATES)}_clearCurrentFBO(){this._rctx.setStencilWriteMask(255),this._rctx.setClearColor(0,0,0,0),this._rctx.setClearDepth(1),this._rctx.setClearStencil(0),this._rctx.clear($i.Hf.COLOR|$i.Hf.DEPTH|$i.Hf.STENCIL)}_initFBO(e,t,i){this._rctx.bindFramebuffer(e),i&&(this._rctx.setViewport(0,0,t,t),this._clearCurrentFBO())}ensureBuffer(e){this._lastUsedIds.length=0,this._lastUsedIds.push(1),this._lastCreatedBufferId=1,this._onHoldIds.length=0,this.bind(e)}bind(e,t=0,i=!0){if(this._current=t,t>=this._fbos.length)for(let e=this._fbos.length;e<=t;e++)this._fbos.push(new db(this._rctx));this._initFBO(this._fbos[t].get(e),e,i)}_bindNextFreeBuffer(e){this._lastUsedIds.length>0?this.bind(e,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(e,this._lastCreatedBufferId))}openGroup(e){this._onHoldIds.push(this._current),this._bindNextFreeBuffer(e)}switch(e){const t=this.currentFBO(e),i=this._current;return this._bindNextFreeBuffer(e),this._lastUsedIds.push(i),t}getLastOnHoldId(){return this._onHoldIds[this._onHoldIds.length-1]}closeGroup(e){const t=this._current;this._bindNextFreeBuffer(e),this._lastUsedIds.push(t),this._lastUsedIds.push(this._onHoldIds.pop())}unbind(){this._rctx.bindFramebuffer(null)}currentFBO(e){return this._fbos[this._current].get(e)}}class _b{constructor(){this.sourceLayerInfo=null,this.sourceLod=[0,0,0],this.offset=[-1,0]}}var gb=i(42377);class yb{constructor(e,t){this._texture=e,this._cache=t,this.type="tile-texture",this._refCount=1,this._texture.descriptor.context.instanceCounter.increment($i._g.TileTexture,this)}retain(){++this._refCount}release(){--this._refCount,0===this._refCount&&(this._cache?(this._texture.abortCompression(),this._cache.put(vb(this.descriptor),this)):this.dispose())}dispose(){this._texture.descriptor.context.instanceCounter.decrement($i._g.TileTexture,this),this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}get descriptor(){return this._texture.descriptor}get cachedMemory(){return this._texture.usedMemory}}function vb(e,t=(0,gb.gP)(e.internalFormat)){return`${e.width} ${e.pixelFormat} ${t}`}var bb=i(37580);function wb(e,t){let i=t.width,r=t.height;return(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement)&&(i=e.width,r=e.height),(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof Uint8Array)&&(t.pixelFormat===$i.VI.RGBA||t.pixelFormat===$i.VI.RGB)&&(0,st.wt)(i)&&(0,st.wt)(r)&&i>=16&&r>=16}class Cb extends bb.q{constructor(e){super("TextureCompressionWorker","compress",{compress:e=>[e.data]},e)}isCompressible(e,t){return wb(e,t)}}class xb{constructor(e,t,i,r,n,s){this.start=e,this.end=t,this.blendMode=i,this.opacity=r,this.output=n,this.baseOpacity=s}}class Tb{constructor(e,t,i,r,n){this._rctx=e,this.tileSize=t,this._techniques=i,this._cache=r,this._compressionTracker=n,this._passParameters=new xv,this._backgroundColor=null,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._compositor=new fb(this._rctx,this._techniques)}dispose(){this._compositor=(0,p.M2)(this._compositor),this._backgroundTexture=(0,p.RY)(this._backgroundTexture)}get backgroundIsGrid(){return null==this._backgroundColor}get backgroundColor(){return this._backgroundColor}updateHeading(e){this._compositor?.updateHeading(e)}updateTileTexture(e,t){if(!e.renderData)return;const i=e.surface,r=i.baseOpacity;let n=0,s=0,a=this.tileSize,o=!1,l=!1;const c=i.view.state.contentPixelRatio;let h=!1;Rb.clear(),Ab.length=0;const u=e.layerInfo[hf.MAP];let d=0,p=null;for(;d<u.length;d++){const t=i.layerViewByIndex(d,hf.MAP),m=t.layer,f=!(0,Eg.W4)(e,t),_=m.opacity,g=t.fullOpacity;if(l=l||(0,B.sy)(m),bv(t))continue;if((0,X_.TK)(t)){let e="normal"!==t.layer.blendMode;if((0,B.CY)(m.parent)){const t=m.parent.uid;null!=t&&""!==t&&(e=Eb(m.parent)||e)}e&&(h=e,o=!1)}if((f||0===_)&&!h){u[d].pendingUpdates&=~(ry.TEXTURE_NOFADING&ry.TEXTURE_FADING);continue}++s;const y=(0,X_.Q)(t),v=Sb(e,d,y);if(v){if(u[d].pendingUpdates&=~(ry.TEXTURE_NOFADING&ry.TEXTURE_FADING),(0,B.CY)(m.parent)){const e=m.parent.uid;null!=e&&""!==e&&Pb(m.parent,d)}y?a=Math.max(a,this.tileSize*c):1===r&&1===g&&(t.isOpaque||this._dataToTexture(v,(0,B.i$)(m))&&v.sourceLayerInfo.data.descriptor.isOpaque)&&(o=!0),++n,null===p&&(p=d)}}const m=a/this.tileSize;0!==n&&null!==p?1===n&&!h&&this._useLayerTexture(e,p)||this._composeLayers(e,t,d-1,l,a,m,!o||h,Rb,h):this._useBackgroundTexture(e,s,t!==eg.Ns.FADING)}setBackground(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundTexture&&this._drawBackgroundTexture(this._backgroundTexture))}_ensureBackgroundTexture(){return null==this._backgroundTexture&&(this._backgroundTexture=this._buildTexture(this.tileSize,!1),this._drawBackgroundTexture(this._backgroundTexture)),this._backgroundTexture}_drawBackgroundTexture(e){this._compositor.bind(this.tileSize),this._passParameters.offset=Gi.AG,this._passParameters.scale=1,this._passParameters.opacity=1,this.backgroundColor&&(this._passParameters.backgroundColor=this.backgroundColor),this._compositor.drawBackground(this._passParameters,null!=this.backgroundColor),this._compositor.copyFBOToTexture(e),this._compositor.unbind()}_useBackgroundTexture(e,t,i){const r=e.renderData,n=!i&&null!=r.textureReference&&(e.surface.view.layerViewManager.updating||t>0)?wg.Delayed:wg.Immediate,s=this._ensureBackgroundTexture();r.setTextureReference(new Sg(s,eg.Ns.FADING,Db,e.surface.baseOpacity,0,1),n)}_useLayerTexture(e,t){const i=e.surface.layerViewByIndex(t,hf.MAP),r=(0,B.sy)(i.layer),n=r?e.surface.baseOpacity:1,s=r?1:e.surface.baseOpacity,a=i.fullOpacity,o=Sb(e,t,!1);return!!this._dataToTexture(o,(0,B.i$)(i.layer))&&(e.renderData.setTextureReference(new Sg(o.sourceLayerInfo.data,eg.Ns.FADING,(0,tc.al)(o.offset[0],o.offset[1],o.scale,o.scale),n,s,a)),!0)}_composeLayers(e,t,i,r,n,s,a,o,l){this._compositor.ensureBuffer(n);const c=e.surface.baseOpacity;let h=!1,u=$i.cw.LINEAR_MIPMAP_LINEAR,d=!1,p=0;for(let t=i;t>=0;t--){const i=e.surface.layerViewByIndex(t,hf.MAP),m=i.layer,f=(0,X_.Q)(i),_=Sb(e,t,f),g=m.opacity,y=!(0,Eg.W4)(e,i);if(!_||(0===g||y)&&!l)continue;const v=!(0,B.sy)(m)&&!h;v&&(h=!0);let b=!1;o.forEach((e=>{e.start===t&&(e.output=r?nb.l.Composite:a&&v?this.backgroundIsGrid?nb.l.GridComposite:nb.l.ColorComposite:nb.l.Composite,e.baseOpacity=v?c:1,Ab.push(e),this._compositor.openGroup(n),b=!0)}));const w=0===p,C=b?nb.l.GroupBackgroundComposite:a&&w?this.backgroundIsGrid?nb.l.GridComposite:nb.l.ColorComposite:nb.l.Composite,x=eb.pU[(0,X_.TK)(i)?i.layer.blendMode:"normal"];for(this._passParameters.baseOpacity=v&&!b&&c<1?c:1,this._passParameters.opacity=g,(0,X_.Ke)(_)?d=this._compositor.drawVectorData(this._passParameters,C,n,x,_,s,this.tileSize,d):(0,X_.Ay)(_)?(this._compositor.drawRasterData(this._passParameters,C,n,x,_),Mb(_)&&(u=$i.cw.NEAREST)):this._dataToTexture(_,(0,B.i$)(m))&&(this._passParameters.texture=_.sourceLayerInfo.data.texture,this._passParameters.offset=_.offset,this._passParameters.scale=_.scale,this._compositor.drawImageData(this._passParameters,C,n,x));Ab.length>0&&Ab[Ab.length-1].end===t;){const e=Ab.pop();this._passParameters.baseOpacity=e.baseOpacity,this._passParameters.opacity=e.opacity,this._passParameters.offset=Gi.AG,this._passParameters.scale=1,this._compositor.drawGroup(this._passParameters,e.output,n,eb.pU[e.blendMode])}p++}const m=e.renderData,f=l||h&&c<1,_=m.ensureTexture(n,f,t,(()=>this._buildTexture(n,f,u)));this._compositor.copyFBOToTexture(_),this._compositor.unbind(),m.setTextureReference(new Sg(_,t,Db,h?1:c,0,1))}_dataToTexture(e,t){if((0,X_.S3)(e)){const i=e.sourceLayerInfo,r=1===e.scale&&!t;i.data=this._buildTexture(i.data,!0,r,e.tile.onCompressionFinished),e.tile.setMemoryDirty()}return(0,X_.z7)(e)}_buildTexture(e,t,i=$i.cw.LINEAR_MIPMAP_LINEAR,r=(()=>{})){if(null==e)return null;const n=new ir.X;n.wrapMode=$i.e8.CLAMP_TO_EDGE,n.samplingMode="boolean"==typeof i?$i.cw.LINEAR_MIPMAP_LINEAR:i,n.maxAnisotropy=this._maxAnisotropy,n.preMultiplyAlpha=!0,n.flipped=!0,n.hasMipmap=!0,t||(n.pixelFormat=$i.VI.RGB);const s=this._rctx,a="boolean"==typeof i&&i;let o;if("number"==typeof e)n.width=n.height=e,o=this._buildTileTexture(n);else if((0,Df.Cm)(e))n.isOpaque=e.isOpaque,n.isOpaque&&(n.pixelFormat=$i.VI.RGB),n.width=e.element.width,n.height=e.element.height,o=this._buildTileTexture(n,a,r,e.element);else try{n.width=e.width,n.height=e.height,o=this._buildTileTexture(n,a,r,e)}catch(e){o=new yb((0,mb.l_)(s)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const l=s.bindTexture(o.texture,Ed.x.TEXTURE_UNIT_FOR_UPDATES);return o.generateMipmap(),s.bindTexture(l,Ed.x.TEXTURE_UNIT_FOR_UPDATES),o}_buildTileTexture(e,t=!1,i=(()=>{}),r){const n=this._cache.pop(vb(e,!1))??this._cache.pop(vb(e,!0));if(t&&=wb(r,e),n)return n.retain(),t?n.texture.enableCompression({compressionTracker:this._compressionTracker,compressionCallback:i}):n.texture.disableCompression(),n.texture.setData(r),n;e.compress=t?{compressionTracker:this._compressionTracker,compressionCallback:i}:void 0;const s=new Ed.x(this._rctx,e,r);return new yb(s,this._cache)}get test(){}}function Sb(e,t,i){Ob.layerIndex=t,Ob.vtlNeighborInfos.clear();const r=e.layerInfo[hf.MAP][t];if((0,zi.t8)(Ob.offset,0,0),Ob.tile=e,Ob.scale=1,Ob.sourceLod=e.lij,Ob.sourceLayerInfo=r,Ob.isVTLBackground=i,r.data)return i&&e.forEachLoadedNeighbor(((i,n)=>{if(i.level!==e.level)return;const s=i.layerInfo[hf.MAP][t];if(!(0,X_.B9)(s)||r.data===s.data)return;const a=Ob.vtlNeighborInfos.pushNew();a.offset=Ib[n],a.sourceLod=i.lij,a.sourceLayerInfo=s})),Ob;const n=r.upsampleInfo,s=n?.tile?.layerInfo[hf.MAP][t];return s&&n.tile?(Ob.tile=n.tile,(0,zi.JG)(Ob.offset,n.offset),Ob.scale=n.scale,Ob.sourceLod=n.tile.lij,Ob.sourceLayerInfo=s,Ob):i?Ob:null}function Mb(e){const t=e.sourceLayerInfo.data;return!!t.source&&"nearest"===t.interpolation}function Eb(e){let t="normal"!==e.blendMode;return(0,B.CY)(e.parent)&&(t=Eb(e.parent)||t),t}function Pb(e,t){(0,B.CY)(e.parent)&&Pb(e.parent,t);const i=e.uid;if(null!=i&&""!==i){const r=Rb.get(i);r?r.start=t:Rb.set(i,new xb(t,t,e.blendMode,e.opacity,nb.l.Composite,1))}}const Rb=new Map,Ab=new Array,Ob=new class{constructor(){this.sourceLod=[0,0,0],this.offset=[0,0],this.scale=1,this.layerIndex=0,this.isVTLBackground=!1,this.vtlNeighborInfos=new cd.Z({allocator:e=>e||new _b})}},Db=(0,tc.al)(0,0,1,1),Ib=new Array;Ib[vg.X.NORTH]=[0,-1],Ib[vg.X.NORTH_EAST]=[-1,-1],Ib[vg.X.EAST]=[-1,0],Ib[vg.X.SOUTH_EAST]=[-1,1],Ib[vg.X.SOUTH]=[0,1],Ib[vg.X.SOUTH_WEST]=[1,1],Ib[vg.X.WEST]=[1,0],Ib[vg.X.NORTH_WEST]=[1,-1];var Lb=i(9779);const Nb=1e-6;class Fb{constructor(e,t,i,r,n){this.aabb=e,this.axis=t,this.d=i,this.midStartIndex=r,this.rightStartIndex=n}}class Ub{constructor(e,t,i,r){this.globalTriangleVertexIndices=e,this.firstTriangleIndex=t,this.positions=r,this._rayDirection=(0,R.Ue)(),this._callback=Gb,this._intersectionOptions=zb,this.bspNodeTree=new Array;const n=i-t,s=new(n<Vb?Uint8Array:n<Bb?Uint16Array:Uint32Array)(n);this.triangleIndexMap=s;for(let e=0;e<n;++e)s[e]=e;{const a=function(e,t,i,r,n){const s=i-t,a=new Float32Array(6*s);for(let i=0;i<s;++i){const s=3*(i+t),o=e[s]*n,l=e[s+1]*n,c=e[s+2]*n;for(let e=0;e<3;++e){const t=r[o+e],n=r[l+e],s=r[c+e];a[6*i+e]=Math.min(t,n,s),a[6*i+3+e]=Math.max(t,n,s)}}return a}(e,t,i,r.data,r.stride),o=(0,st.uZ)(Math.log2(n/40),2,10),l=(e,t,i)=>{const r=function(e,t,i,r){if(r<=i)return(0,fc.al)(NaN,NaN,NaN,NaN,NaN,NaN);{const r=6*e[i];for(let e=0;e<3;++e)Hb[e]=t[r+0+e],kb[e]=t[r+3+e]}for(let n=i+1;n<r;++n){const i=6*e[n];for(let e=0;e<3;++e)Hb[e]=Math.min(Hb[e],t[i+0+e]),kb[e]=Math.max(kb[e],t[i+3+e])}return(0,fc.al)(Hb[0],Hb[1],Hb[2],kb[0],kb[1],kb[2])}(s,a,e,t),n=t-e;if(n<=40){const i=new Fb(r,void 0,0,e,t);return this.bspNodeTree.push(i),i}const{axis:c,midValue:h}=function(e){const t=e[3]-e[0],i=e[4]-e[1],r=e[5]-e[2],n=t>i?t>r?0:i>r?1:2:i>r?1:r>t?2:0;return{axis:n,midValue:(e[n]+e[n+3])/2}}(r),u=function(e,t,i,r,n,s){let a=i,o=r;for(;a<o;){const i=e[a];t[6*i+n+3]<=s?++a:(--o,e[a]=e[o],e[o]=i)}let l=a;for(o=r;l<o;){const i=e[o-1];t[6*i+n]>=s?--o:(e[o-1]=e[l],e[l]=i,++l)}return{next:a,mid:l}}(s,a,e,t,c,h),d=(e,t)=>{if(i>o)return;const r=t-e;return r<40||r>=.8*n?void 0:l(e,t,i+1)},p=new Fb(r,c,h,u.next,u.mid);return this.bspNodeTree.push(p),p.leftNode=d(e,u.next),p.rightNode=d(u.mid,t),p};l(0,n,0)}}intersectRayTriangleRange(e,t){if(e>=t)return;const i=this.positions;(0,ev.ET)(this._rayFrom,this._rayDirection,e,t,this.globalTriangleVertexIndices,i.data,i.stride,this._intersectionOptions.normalRequired,this._callback,this.triangleIndexMap,this.firstTriangleIndex),Ub.numFacesTested+=t-e}intersectRay(e,t,i,r){Ub.numFacesTested=0;const n=e,s=t,a=s[0]-n[0],o=s[1]-n[1],l=s[2]-n[2];if(a*a+o*o+l*l<Nb)return;this._rayFrom=n;const c=this._rayDirection;c[0]=a,c[1]=o,c[2]=l;const h=this.triangleIndexMap.length;this._callback=r,this._intersectionOptions=i,this.intersectRayBSP(this.bspNodeTree[0],0,h),this._callback=Gb,this._intersectionOptions=zb}intersectRayBSP(e,t,i){const r=this._rayFrom,n=this._rayDirection;if(!function(e,t,i){const r=t,n=i;let s=0,a=1/0;for(let t=0;t<3;++t){{const i=e[t];if(r[t]<i){if(n[t]<=Nb)return!1;const e=(i-r[t])/n[t];s=Math.max(s,e)}else if(n[t]<=-1e-6){const e=(i-r[t])/n[t];a=Math.min(a,e)}if(s>a)return!1}{const i=e[t+3];if(r[t]>i){if(n[t]>=-1e-6)return!1;const e=(i-r[t])/n[t];s=Math.max(s,e)}else if(n[t]>=Nb){const e=(i-r[t])/n[t];a=Math.min(a,e)}if(s>a)return!1}}return!0}(e.aabb,r,n))return;const s=e.axis,a=e.d;if(r[s]<a||n[s]<0){const i=t,r=e.midStartIndex;if(i<r){const t=e.leftNode;void 0!==t?this.intersectRayBSP(t,i,r):this.intersectRayTriangleRange(i,r)}}if(this.intersectRayTriangleRange(e.midStartIndex,e.rightStartIndex),r[s]>a||n[s]>0){const t=e.rightStartIndex,r=i;if(t<r){const i=e.rightNode;void 0!==i?this.intersectRayBSP(i,t,r):this.intersectRayTriangleRange(t,r)}}}static{this.numFacesTested=0}get estimatedMemoryUsage(){return this.triangleIndexMap.byteLength}}const Hb=[1/0,1/0,1/0],kb=[-1/0,-1/0,-1/0];const Vb=255,Bb=65535,zb=new ev.sT,Gb=()=>{};var qb=i(41044),Zb=i(47744),jb=i(81749),Wb=i(19596),$b=i(948),Xb=i(13896),Yb=i(57716),Kb=i(31839),Qb=i(42510),Jb=i(76144),ew=i(91041);class tw extends ew.W{constructor(e){super(),this.spherical=e,this.overlayMode=Jb.gT.Disabled,this.tileBlendInput=Zb.R.LayerOnly,this.transparencyMode=Lb.w.Opaque,this.pbrMode=Qb.f7.Simplified,this.receiveShadows=!1,this.backfaceCullingEnabled=!1,this.textureFadingEnabled=!1,this.renderOccluded=!1,this.screenSpaceReflections=!1,this.cloudReflections=!1,this.screenSizePerspective=!1,this.receiveAmbientOcclusion=!1,this.tileBorders=!1,this.visualizeNormals=!1,this.normalType=Yb.r.Compressed,this.textureCoordinateType=Kb.I.Default,this.highStepCount=!1,this.useCustomDTRExponentForWater=!1,this.useFillLights=!1,this.hasColorTexture=!0,this.draped=!1}get overlayEnabled(){return this.overlayMode!==Jb.gT.Disabled}}(0,r._)([(0,tb.o)({count:Jb.gT.COUNT})],tw.prototype,"overlayMode",void 0),(0,r._)([(0,tb.o)({count:Zb.R.COUNT})],tw.prototype,"tileBlendInput",void 0),(0,r._)([(0,tb.o)({count:Lb.w.COUNT})],tw.prototype,"transparencyMode",void 0),(0,r._)([(0,tb.o)({count:Qb.f7.COUNT})],tw.prototype,"pbrMode",void 0),(0,r._)([(0,tb.o)()],tw.prototype,"receiveShadows",void 0),(0,r._)([(0,tb.o)()],tw.prototype,"backfaceCullingEnabled",void 0),(0,r._)([(0,tb.o)()],tw.prototype,"textureFadingEnabled",void 0),(0,r._)([(0,tb.o)()],tw.prototype,"renderOccluded",void 0),(0,r._)([(0,tb.o)()],tw.prototype,"screenSpaceReflections",void 0),(0,r._)([(0,tb.o)()],tw.prototype,"cloudReflections",void 0),(0,r._)([(0,tb.o)()],tw.prototype,"screenSizePerspective",void 0),(0,r._)([(0,tb.o)()],tw.prototype,"receiveAmbientOcclusion",void 0),(0,r._)([(0,tb.o)()],tw.prototype,"tileBorders",void 0),(0,r._)([(0,tb.o)()],tw.prototype,"visualizeNormals",void 0);const iw=(0,fc.Ue)();let rw=class extends Ir.tY{get _isGlobal(){return this._stage.viewingMode===Ht.JY.Global}get _techniques(){return this._context.techniques}get _rctx(){return this._context.renderContext.rctx}constructor(e,t,i,r,n,s){super({}),this._overlayRenderer=e,this._stage=t,this._allTiles=i,this._ellipsoidRadius=r,this._compressionTracker=n,this.type=Um.q.TERRAIN,this.isGround=!0,this._passParameters=new Rg.T,this._drawParameters=new Xb.w,this._renderDataPool=new V_.Z(Dg),this._visiblePatchesByOrigin=new Map,this._allPatchesByOrigin=new Map,this._patchesByOriginDirty=!0,this._patchSortingDirty=!0,this._tileIterator=new Eg.AA,this._castShadows=!1,this._inViewshed=!1,this._tileRenderer=null,this._stencilEnabledLayerExtents=new Array,this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this.renderOccludedFlags=Wb.yD.Occlude,this.produces=new Map([[$b.r.OPAQUE_TERRAIN,()=>this._produces()&&this.transparency===Lb.w.Opaque],[$b.r.TRANSPARENT_TERRAIN,()=>this._produces()&&(this.transparency===Lb.w.Transparent||this.transparency===Lb.w.InvisibleWithDraped)],[$b.r.OCCLUDED_GROUND,()=>this._produces()&&this.renderOccludedFlags===ig.Qi]]),this._tileSize=256,this._configuration=new tw(t.viewingMode===Ht.JY.Global),this._tileTextureCache=new H_(((e,t)=>s.newCache(e,t)),"TileTexture"),this.tileGeometryCache=new vv(s)}normalizeCtorArgs(){return{}}initialize(){this._stage.addRenderPlugin(this),this.addHandles((0,_.YP)((()=>this._overlayRenderer.rendersOccludedDraped),(e=>{this.renderOccludedFlags=e?ig.Qi:Wb.yD.Occlude,this.setNeedsRender()}),_.Z_))}destroy(){this._stage.removeRenderPlugin(this),this._tileTextureCache.destroy(),this.tileGeometryCache.destroy()}_produces(){return this.visible&&!!this._rootTiles&&!this.renderingDisabled}consumes(){return this._overlayRenderer.hasWater?Ir.of:Ir.jt}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setDirty()}set visible(e){this._set("visible",!!e),this.setDirty()}updateHeading(e){this._tileRenderer?.updateHeading(e)}set transparency(e){this._configuration.transparencyMode!==e&&(this._configuration.transparencyMode=e,this.setNeedsRender())}get transparency(){return this._configuration.transparencyMode}get renderPatchBorders(){return this._configuration.tileBorders}set renderPatchBorders(e){this._configuration.tileBorders!==e&&(this._configuration.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get visualizeNormals(){return this._configuration.visualizeNormals}set visualizeNormals(e){this._configuration.visualizeNormals!==e&&(this._configuration.visualizeNormals=e,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}get cullBackFaces(){return this._configuration.backfaceCullingEnabled}set cullBackFaces(e){this._configuration.backfaceCullingEnabled!==e&&(this._configuration.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(e){this._set("renderOrder",e),this._setSortingDirty()}get layerViewUid(){return Lo.xX}get slicePlaneEnabled(){return this._configuration.hasSlicePlane}set slicePlaneEnabled(e){this._configuration.hasSlicePlane!==e&&(this._configuration.hasSlicePlane=e,this.setNeedsRender())}set textureFadingEnabled(e){this._configuration.textureFadingEnabled!==e&&(this._configuration.textureFadingEnabled=e,this.setNeedsRender())}set pbrMode(e){this._configuration.pbrMode!==e&&(this._configuration.pbrMode=e,this.setNeedsRender())}setDebugScreenSizePerspective(e){this._configuration.screenSizePerspective!==e&&(this._configuration.screenSizePerspective=e,this.setNeedsRender())}setRootTiles(e){this._rootTiles=e,this.setDirty()}setStencilEnabledLayerExtents(e){this._stencilEnabledLayerExtents=e,this._setSortingDirty()}set tileSize(e){this._tileSize=e,null!=this._tileRenderer&&(this._tileRenderer.tileSize=e),this.setDirty()}get tileSize(){return this._tileSize}_ensureRenderData(e){e.renderData||(e.renderData=this._renderDataPool.acquire(),e.renderData.init(e,this._getLocalOriginOfTile(e)))}loadTile(e){this._ensureRenderData(e),this.updateTileGeometryState(e),this.reuseTextureFromParent(e)||this.updateTileTexture(e,ry.TEXTURE_FADING)}reuseTextureFromParent(e){const t=e.parent;if(!t)return!1;const i=(0,tc.al)(1&e.lij[2]?.5:0,1&e.lij[1]?0:.5,.5,.5);return t.renderData?.reuseTexture(e.renderData,i)??!1}updateTileTexture(e,t){null!=this._tileRenderer&&(this._tileRenderer.updateTileTexture(e,t===ry.TEXTURE_FADING?eg.Ns.FADING:eg.Ns.UNFADED),this.setNeedsRender(),e.resetPendingUpdate(t))}updateTileGeometryState(e){for(const t of e.layerInfo[hf.ELEVATION])t.pendingUpdates&=~ry.GEOMETRY;e.resetPendingUpdate(ry.GEOMETRY);const t=e.renderData.updateGeometryState();return t&&this.setDirty(),t}updateGeometryIfNeeded(e){e.loaded&&e.renderData.updateGeometryIfNeeded(this._rctx)}unloadTile(e){const t=e.renderData;t&&(t.releaseGeometry(),this._renderDataPool.release(t),t.clear(),e.renderData=null,e.setMemoryDirty(),this.setDirty())}_getLocalOriginOfTile(e){const t=Math.max(0,7*Math.floor((e.level-3)/7));if(this._isGlobal&&0===t)return R.AG;for(;e.parent&&e.level>t;)e=e.parent;return e.centerAtSeaLevel}getStats(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.setNeedsRender())}setDirty(e=Cr.Xx.UPDATE){this._patchesByOriginDirty=!0,this._context.requestRender(e)}_setSortingDirty(e=Cr.Xx.UPDATE){this._patchSortingDirty=!0,this._context.requestRender(e)}setNeedsRender(e=Cr.Xx.UPDATE){this._context.requestRender(e)}initializeRenderContext(e){this._context=e,this._tileRenderer=new Tb(this._rctx,this._tileSize,this._techniques,this._tileTextureCache,this._compressionTracker),this.updateTileBackground()}uninitializeRenderContext(){this._tileRenderer=(0,p.M2)(this._tileRenderer)}intersect(e,t,i,r){if(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&this.transparency!==Lb.w.Opaque)return;const n=nw,s=sw;(0,Pi.d)(n,r,i),(0,Pi.i)(s,1/n[0],1/n[1],1/n[2]);const a=e.results.min,o=e.results.max,l=e.results.ground,c=e.options.store===Nm.e.MIN,h=!!e.results.ground.target,u=(0,Lo.lV)(e.verticalOffset),d=e.tolerance;let p,m=c&&null!=a.distance?a.distance:1/0;const f=e.options,_=f.normalRequired||!f.backfacesTerrain,g=new ev.sT(!1,_),y=h=>{const y=h.renderData;if(!y?.vao)return;const v=y.geometry;(0,fc.t8)(iw,v.boundingBox);const b=y.localOrigin;null!=u&&(u.localOrigin=b,u.applyToAabb(iw));const w=iw;if(aw[0]=i[0]-b[0],aw[1]=i[1]-b[1],aw[2]=i[2]-b[2],!(0,ev.Fw)(w,aw,s,d,m))return;const C=(e,t,i)=>{e.set(this.type,h,t,i),m=c&&null!=a.distance?a.distance:1/0},x=(s,c,h)=>{if((!_||null!=h)&&s>=0&&(f.backfacesTerrain||(0,Pi.e)(h,n)<0)&&(f.invisibleTerrain||!f.selectionMode||null==t||t(i,r,s))){if((null==l.distance||s<l.distance)&&C(l,s,h),f.isFiltered)return;f.store===Nm.e.ALL&&(null==p?(p=new Fm.x(e.ray),C(p,s,h),e.results.all.push(p)):s<p.distance&&C(p,s,h)),(null==a.distance||s<a.distance)&&C(a,s,h),f.store!==Nm.e.MIN&&(null==o.distance||s>o.distance)&&C(o,s,h)}},T=ow;(0,Pi.d)(T,r,b);const{indices:S,indexCount:M}=v,E=v.vertexAttributes,P=E.getField(mr.T.POSITION,_v.ct),R=new jb.U(P.typedBuffer,3,E.stride/4),A=M/3;if(!u&&A>200){const e=h.renderData;null==e.intersectionData&&(e.intersectionData=new Ub(S,0,A,R)),e.intersectionData.intersectRay(aw,T,g,x)}else(0,ev.CN)(aw,T,0,A,S,R,u,g,x)},v=this._rootTiles;null!=v&&(()=>{const t=this._tileIterator;t.reset(v);const r=e.options.invisibleTerrain;for(let e=t.next();e;e=t.next())!(e.visible||r&&e.intersectsClippingArea)||null==u&&!e.intersectsRay(i,n,d,m)||h&&this._useStencilForTile(e)?t.skipSubtree():y(e)})()}processScaleRangeQueries(e,t){if(!t.done&&e)for(this._updatePatchGroups();e.updating&&!t.done;){e.prepare();for(const t of this._visiblePatchesByOrigin.values())for(const i of t)null!=i.renderData?.textureReference&&e.queriesForTile(i);e.process(),t.madeProgress()}}acquireTechniques(e){const t=!!(0,u.Z)("enable-feature:terrain-shadows")&&e.bind.shadowMap.enabled;t!==this._castShadows&&(this._castShadows=t,this._patchesByOriginDirty=!0);const i=e.bind.viewshedEnabled;if(this._inViewshed!==i&&(this._inViewshed=i,this._patchesByOriginDirty=!0),e.bind.slot===$b.r.OCCLUDED_GROUND){if(0==(e.renderOccludedMask&ig.Qi))return null}else{const t=this.transparency===Lb.w.Opaque?$b.r.OPAQUE_TERRAIN:$b.r.TRANSPARENT_TERRAIN;if(e.bind.slot!==t)return null}if(this.transparency===Lb.w.Invisible)return null;const r=this._configuration;switch(r.screenSpaceReflections=r.cloudReflections=r.receiveShadows=r.receiveAmbientOcclusion=r.renderOccluded=r.hasHighlightMixTexture=!1,r.overlayMode=this._overlayRenderer.mode,e.output){case qb.H_.Color:case qb.H_.ColorEmission:{r.screenSpaceReflections=null!=e.bind.ssr.lastFrameColor,r.cloudReflections=null!=e.bind.clouds.data,r.receiveShadows=e.bind.shadowMap.ready;const t=e.bind.slot===$b.r.OCCLUDED_GROUND;return r.renderOccluded=t,r.receiveAmbientOcclusion=!t&&null!=e.bind.ssao,this._acquireTechnique(e.output)}case qb.H_.Shadow:case qb.H_.ShadowExcludeHighlight:return this._castShadows?this._acquireTechnique(qb.H_.Shadow):null;case qb.H_.ViewshedShadow:return this._inViewshed?this._acquireTechnique(qb.H_.ViewshedShadow):null;case qb.H_.Depth:case qb.H_.Normal:return this._acquireTechnique(e.output);case qb.H_.ObjectAndLayerIdColor:return this._acquireTechnique(qb.H_.ObjectAndLayerIdColor);case qb.H_.Highlight:return r.hasHighlightMixTexture=null!=e.bind.highlightMixTexture,this._overlayRenderer.hasHighlights?this._acquireTechnique(qb.H_.Highlight):null}return null}render(e,t){switch(this._updatePatchGroups(),t.useStencil=!1,e.output){case qb.H_.Color:case qb.H_.ColorEmission:{const i=e.bind.slot===$b.r.OCCLUDED_GROUND?gv.D.Occluded:gv.D.Color;this._renderMaterialPass(e,t,i);break}case qb.H_.Depth:case qb.H_.Normal:this._renderAuxiliaryPass(e,t,gv.D.Color,this._visiblePatchesByOrigin);break;case qb.H_.Highlight:{const i=e.bind.highlight?.name;i&&this._overlayRenderer.hasHighlights&&this._overlayRenderer.renders(gv.D.Highlight)&&this._overlayRenderer.hasHighlight(i)&&this._renderAuxiliaryPass(e,t,gv.D.Highlight,this._visiblePatchesByOrigin);break}case qb.H_.Shadow:case qb.H_.ShadowExcludeHighlight:case qb.H_.ViewshedShadow:this._renderAuxiliaryPass(e,t,null,this._allPatchesByOrigin);break;case qb.H_.ObjectAndLayerIdColor:this._renderAuxiliaryPass(e,t,gv.D.ObjectAndLayerIdColor,this._visiblePatchesByOrigin)}}updateTileBackground(e){if(null==this._tileRenderer)return;const t=this._tileRenderer;let i;if(null!=e){const t=$e.Z.toUnitRGBA(e);i=(0,R.al)(t[0]||0,t[1]||0,t[2]||0)}t.setBackground(i),this._allTiles.forAll((e=>t.updateTileTexture(e,eg.Ns.FADING))),this._configuration.tileBlendInput=t.backgroundIsGrid?Zb.R.GridComposite:null!=t.backgroundColor?Zb.R.ColorComposite:Zb.R.LayerOnly,this.setNeedsRender()}_updatePatchGroups(){if(this._patchesByOriginDirty&&(this._rebuildPatchGroups(),this._patchesByOriginDirty=!1,this._patchSortingDirty=!0),this._patchSortingDirty&&this.renderOrder!==rv.z.NONE){const e=Array.from(this._visiblePatchesByOrigin.values()),t=this._stencilEnabledLayerExtents;for(const i of e)(0,Eg.zW)(this.renderOrder,i,t);e.sort(((e,t)=>(0,Eg.dF)(e[0],t[0],this.renderOrder))),this._visiblePatchesByOrigin=new Map(e.map((e=>[e[0].renderData.localOrigin,e]))),this._patchSortingDirty=!1}}_rebuildPatchGroups(){const e=this._rootTiles;if(null!=e){e[0]?.surface.checkAllTilesWaterproofness(),this._visiblePatchesByOrigin.clear(),this._allPatchesByOrigin.clear();for(const t of e)this._rebuildPatchGroupsForRootTile(t)}}_rebuildPatchGroupsForRootTile(e){const t=this._tileIterator;for(t.resetOne(e);!t.done;){const e=t.next(),i=e.renderData;if(!i){this._numTilesCulled++;continue}const r=i.localOrigin;if(this._castShadows||this._inViewshed){let t=this._allPatchesByOrigin.get(r);t||(t=[],this._allPatchesByOrigin.set(r,t)),t.push(e)}if(!e.visible){this._numTilesCulled++,t.skipSubtree();continue}let n=this._visiblePatchesByOrigin.get(r);n||(n=[],this._visiblePatchesByOrigin.set(r,n)),n.push(e),t.skipSubtree()}}_useStencilForTile(e){for(const t of this._stencilEnabledLayerExtents)if(e.intersectsExtent(t))return!0;return!1}_renderAuxiliaryPass(e,t,i,r){const n=e.rctx;this._passParameters.overlayContent=i,n.bindTechnique(t,e.bind,this._passParameters);const s=this._stencilEnabledLayerExtents.length>0;r.forEach((r=>{this._drawParameters.origin=r[0].renderData.localOrigin,t.program.bindDraw(e.bind,this._passParameters,this._drawParameters);for(let n=0;n<r.length;n++)this._renderPatch(e,t,r[n],$i.MX.TRIANGLES,s,i)})),e.rctx.bindVAO(null)}_renderMaterialPass(e,t,i){const{rctx:r}=e;this._passParameters.overlayContent=i,r.bindTechnique(t,e.bind,this._passParameters),this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0;const n=e.bind.camera,s=t.program;if(this._configuration.screenSizePerspective&&this.pointsOfInterest){const e=(0,Id.Gw)(this._stage.viewingMode,this._ellipsoidRadius),t=this.pointsOfInterest.centerOnSurfaceFrequent.distance;e.update({distance:t,fovY:n.fovY})}const a=this._stencilEnabledLayerExtents.length>0,o=i===gv.D.Occluded;o&&(s.bindTexture("tex",r.emptyTexture),s.setUniform3fv("textureOpacities",R.AG),s.setUniform4fv("texOffsetAndScale",tc.AG));const l=null!=this._tileRenderer?.backgroundColor?this._tileRenderer.backgroundColor:R.AG;this._configuration.tileBlendInput===Zb.R.ColorComposite&&s.setUniform3fv("backgroundColor",l);const c=this.wireframe?$i.MX.LINES:$i.MX.TRIANGLES;this._configuration.textureFadingEnabled&&s.bindTexture("texNext",r.emptyTexture);const h=this._visiblePatchesByOrigin;for(const r of h.values()){const n=r[0].renderData.localOrigin;this._drawParameters.origin=n,t.program.bindDraw(e.bind,this._passParameters,this._drawParameters),this._numOriginsRendered++;for(const n of r){const r=n.renderData,l=r.textureReference;if(null!=l){if(!o){s.setUniform4fv("texOffsetAndScale",l.offsetAndScale),s.bindTexture("tex",l.texture.texture);const e=r.textureFadeFactor,t=e<1?r.nextTextureReference:null;this._configuration.textureFadingEnabled&&t&&e<1?(s.setUniform1f("fadeFactor",e),s.setUniform4fv("nextTexOffsetAndScale",t.offsetAndScale),s.setUniform3fv("nextTexOpacities",t.opacities),s.bindTexture("texNext",t.texture.texture)):s.setUniform1f("fadeFactor",1),r.textureIsFading&&this.setNeedsRender(),s.setUniform3fv("textureOpacities",l.opacities)}this._renderPatch(e,t,n,c,a,i),n.renderOrder=this._numTilesRendered,this._numTilesRendered++}}}e.rctx.bindVAO(null)}_renderPatch(e,t,i,r,n,s){const a=i.renderData,o=a.vao,l=o?.indexBuffer;if(!o||null==l)return void(X_.T9&&console.error("Rendered tile with no indices: ",i.lij," : ",a));const c=t.program;null==s||this._overlayRenderer.isEmpty||this._bindOverlayPatchData(c,a.overlay),n&&(t.useStencil=this._useStencilForTile(i),e.rctx.setPipelineState(t.getPipeline()));const h=a.geometry.indexCount;e.rctx.bindVAO(o),c.assertCompatibleVertexAttributeLocations(o),e.rctx.drawElements(r,h,l.indexType,0)}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}_acquireTechnique(e){return this._configuration.output=e,this._techniques.get(Ag,this._configuration)}get test(){}hasHighlight(e){return this._overlayRenderer.hasHighlight(e)}};(0,r._)([(0,w.Cb)({readOnly:!0})],rw.prototype,"_isGlobal",null),(0,r._)([(0,w.Cb)()],rw.prototype,"renderOccludedFlags",void 0),(0,r._)([(0,w.Cb)({value:!1})],rw.prototype,"renderingDisabled",null),(0,r._)([(0,w.Cb)({value:!0})],rw.prototype,"visible",null),(0,r._)([(0,w.Cb)()],rw.prototype,"renderPatchBorders",null),(0,r._)([(0,w.Cb)()],rw.prototype,"visualizeNormals",null),(0,r._)([(0,w.Cb)()],rw.prototype,"cullBackFaces",null),(0,r._)([(0,w.Cb)({value:rv.z.FRONT_TO_BACK})],rw.prototype,"renderOrder",null),(0,r._)([(0,w.Cb)()],rw.prototype,"wireframe",null),rw=(0,r._)([(0,x.j)("esri.views.3d.terrain.TerrainRenderer")],rw);const nw=(0,R.Ue)(),sw=(0,R.Ue)(),aw=(0,R.Ue)(),ow=(0,R.Ue)();class lw{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}}var cw=i(39717),hw=i(76060);let uw=class extends S.Z{constructor(e){super(e)}initialize(){this.addHandles([this.layers.on("change",(()=>this._update())),(0,_.YP)((()=>this.extentHelper.layerViewsExtent),(()=>this._setAdHocTilingScheme()))]),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._waitTask=null,this.layers.destroy()}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this.layers.some((t=>!(!(0,B.iC)(t)||t.isRejected()||t.isFulfilled()&&!function(e,t,i){return null!=(0,X_.E_)(e,t,i)}(t,this.viewSpatialReference,this.viewingMode)||(e=t,"vector-tile"===t?.type||(0,X_.x4)(t))))),e)if(e.isResolved()){const t=(0,X_.E_)(e,this.viewSpatialReference,this.viewingMode);if(null!=t){const e=new hw.t(t.tileInfo);this._lockTilingScheme(e)}}else this._updateWhen(e)}_updateWhen(e){const t=e.when().catch((()=>{})).then((()=>{t!==this._waitTask||this.destroyed||this._update()}));this._waitTask=t}_lockTilingScheme(e){if(this.viewingMode===Ht.JY.Global){const t=e.levels.length-1,i=e.spatialReference;i.isWebMercator?e=hw.t.makeWebMercatorAuxiliarySphere(t):(0,cw.O)(i)&&(e=hw.t.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this.removeAllHandles(),this.addHandles((0,_.YP)((()=>this.extentHelper.tiledLayersExtent),(()=>this._updateTiledLayerExtent())))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(this.viewingMode===Ht.JY.Global){const e=this.extentHelper.viewSpatialReference;e.isWebMercator?this.tilingScheme=hw.t.WebMercatorAuxiliarySphere:(0,cw.M)(e)&&(this.tilingScheme=hw.t.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{const e=this.extentHelper.layerViewsExtent;null==e||(0,H.fS)(e,this.extent)||(this.tilingScheme=hw.t.fromExtent(e,this.extentHelper.viewSpatialReference),this._set("extent",e))}}get test(){}};(0,r._)([(0,w.Cb)()],uw.prototype,"tilingScheme",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],uw.prototype,"extent",void 0),(0,r._)([(0,w.Cb)({value:!1})],uw.prototype,"tilingSchemeLocked",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],uw.prototype,"viewSpatialReference",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],uw.prototype,"layers",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],uw.prototype,"extentHelper",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],uw.prototype,"viewingMode",void 0),uw=(0,r._)([(0,x.j)("esri.views.3d.terrain.TilingSchemeLogic")],uw);class dw{constructor(){this._offset=(0,Gi.Ue)(),this.scale=0}get offset(){return this._offset}init(e,t,i,r){this.tile=e,this._offset[0]=t,this._offset[1]=i,this.scale=r}dispose(){this.tile=null,this._offset[0]=0,this._offset[1]=0,this.scale=0}}var pw,mw=i(27546),fw=i(17426);let _w=class extends(ae.Z.EventedMixin(S.Z)){static{pw=this}get allTiles(){return this._allTiles}get demResolution(){const{_allTiles:e,tilingScheme:t}=this;if(0===e.length)return{min:1,max:1};const i=(0,v.c9)(t.spatialReference);let r=Number.POSITIVE_INFINITY,n=Number.NEGATIVE_INFINITY;for(const s of e){const e=t.resolutionAtLevel(s.level)*i;r=Math.min(r,e),n=Math.max(n,e)}return{min:r,max:n}}constructor(e){super(e),this.terrainTextureCompressionTracker=new fw.x,this._iteratorPool=new V_.Z(Eg.AA,(e=>e.remove=()=>this._iteratorPool.release(e))),this._postorderIterator=new Eg.rv,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._usedMemory=null,this._performanceInfo=new lw,this._viewChanged=!1,this.heading=0,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=(0,R.Ue)(),this._eyePosSurfaceSR=(0,R.Ue)(),this._splitLimits=new fv,this._frustum=(0,_c.Ue)(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._watchUpdatingTracking=new X.R,this._frameTask=nr.sq,this._allTiles=new cd.Z,this._upsampleInfoPool=new V_.Z(dw),this._shouldEmitChangeEvent=!1,this._rootTilesExtent=(0,H.Ue)(),this.updatingProgress=.5,this._maxNumUpdating=1,this.maxTextureScale=1.2,this._spatialReference=N.Z.WebMercator,this._elevationProjectorCache=new Map,this.visibleElevationBounds=new q_(1/0,-1/0),this.rootTileElevationBounds=new q_(1/0,-1/0),this._projectorCache=new Map,this._radiusModifier=Math.cos(Math.PI/16/16),this._tilingSchemeSpatialReference=null,this._updatingRootTiles=!1,this._pendingTilesForElevationUpdateEvent=new Set,this._pendingTilesToUpdate=new Set,this.totalGeometryUpdates=0,this.totalTileUpdates=0,this._oneBatchPerFrameTask=!0,this._layerViewsDirty=!1,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._isWebMercator=!1,this._isWebMercatorOnPlateCarree=!1;const t=e.view;this.overlayManager=new hg({...e,surface:this}),this._isGlobal=!t.state?.isLocal,this._isGeographic=this._spatialReference?.isGeographic??!1,this._tileConstructor=this._isGlobal?ov:tv,this._ellipsoid=(0,Ii.Iu)(t.spatialReference),this._renderer=new rw(this.overlayManager.renderer,t.stage,this._allTiles,this._ellipsoid.radius,this.terrainTextureCompressionTracker,t.resourceController.memoryController),(0,mw.Dc)()||(this._scaleRangeQueries=new sv)}initialize(){const e=this.view,t=e.resourceController,r=t.memoryController;this._tileCache=new H_(((e,t)=>r.newCache(e,t)),"terrain-tile"),this._upsampleMapCache=r.newCache("terrain-upsample",(e=>e.unloadMapData())),this._elevationQueryCache=new B_.b(r.newCache("elevation-query"));const n=this.overlayManager;this.addHandles([(0,_.YP)((()=>n.renderer.isEmpty),(()=>this._evaluateTransparency())),(0,_.YP)((()=>this.renderer.visible),(e=>this.suspended=!e)),(0,_.YP)((()=>this.heading),(e=>{this._renderer.updateHeading(e),this._updateTileTextures(eg.Ns.FADING)})),(0,_.YP)((()=>({heading:e.camera?.heading,state:e.state?.mode})),(({heading:e,state:t})=>{if(null==e)return;if(this.isGlobal&&this.isGeographic||this.isWebMercatorOnPlateCarree)return void(this.heading=90*Math.round(e/90)%360);const i=Math.round(e)%360,r=Math.abs(i-this.heading);(t===$c.n.IDLE||Math.min(r,360-r)>=30)&&(this.heading=i)}))],"overlayManager"),this.addHandles([(0,_.YP)((()=>this.baseOpacity),(()=>{this._handleLayerViewChanges(),this._updateTileTextures(this._evaluateTransparency()?eg.Ns.UNFADED:eg.Ns.IMMEDIATE)}),_.tX),(0,_.YP)((()=>this.hasCompositeBlendMode),(()=>this._updateTileTextures(this._evaluateTransparency()?eg.Ns.UNFADED:eg.Ns.IMMEDIATE)),_.tX),(0,_.YP)((()=>this.backgroundColor),((e,t)=>{e?.equals(t)||(this._handleLayerViewChanges(),this._renderer.updateTileBackground(e))}),_.Z_),(0,_.YP)((()=>this.snapLevel),(()=>this._viewChanged=!0),_.Z_),(0,_.YP)((()=>this.view.pointsOfInterest),(e=>{this._renderer.pointsOfInterest=e,this._watchUpdatingTracking.removeAll(),e&&this._watchUpdatingTracking.add((()=>e.focus.renderLocation),(()=>this._allTilesSorted=!1))})),(0,_.YP)((()=>hd.h.TERRAIN_TILE_TREE_SHOW_TILES),(t=>{t&&!this._treeDebugger?i.e(23657).then(i.bind(i,23657)).then((({TerrainTileTree3DDebugger:t})=>{!this._treeDebugger&&hd.h.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new t({view:e}))})):t||(this._treeDebugger=(0,p.SC)(this._treeDebugger))}),_.nn)]);const{spatialReference:s}=e;this._extentHelper=function(e,t){return e===Ht.JY.Global?new K_(t):new Q_(t)}(this.viewingMode,{layers:e.map.allLayers,layerViews:e.allLayerViews,viewSpatialReference:s});const a=new Ce.Z({getCollections:()=>e.defaultsFromMap?.mapCollections?.map((({layers:e})=>e)),getChildrenFunction:e=>e&&"layers"in e?e.layers:null}),o=new uw({layers:a,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:s});this._set("tilingSchemeLogic",o),this._updateTilingScheme(),this._elevationDataRequester=t.createStreamDataRequester(xf.Bh.ELEVATION),this._mapDataRequester=t.createStreamDataRequester(xf.Bh.BASEMAP);const l=t.scheduler;this._frameTask=l.registerTask(nr.T8.TERRAIN_SURFACE,this),this.addHandles([(0,_.YP)((()=>this._extentHelper.stencilEnabledExtents),(e=>this._renderer.setStencilEnabledLayerExtents(e)),_.nn),(0,_.YP)((()=>this.tilingSchemeLogic.tilingScheme),(()=>this._updateTilingScheme()),_.Z_),(0,_.YP)((()=>this.extent),(()=>this._updateRootTiles()),_.nn),e.on("resize",(()=>this._viewChangeUpdate())),(0,_.YP)((()=>{const t=e.state;return[this._lodBias,this.lodSnappingEnabled,e.quality,t.camera,t.contentCamera,t.fixedContentCamera]}),(()=>this._viewChangeUpdate()),_.tX),(0,_.YP)((()=>e.qualitySettings?.fadeDuration),(e=>this._renderer.textureFadingEnabled=e>0),_.nn),(0,_.YP)((()=>e.qualitySettings?.physicallyBasedRenderingEnabled),(e=>this._renderer.pbrMode=e?Qb.f7.Simplified:Qb.f7.Disabled),_.nn),(0,_.YP)((()=>e.qualitySettings?.tiledSurface.elevationLevelDelta),(()=>this._updateAllTileGeometries())),(0,_.YP)((()=>this._userClippingExtent),(()=>this._updateClippingExtent()),_.Z_)]),this.addHandles(e.allLayerViews.on("after-changes",(()=>this._layerViewsDirty=!0))),this._layerViewsDirty=!0,this._handleLayerViewChanges(),this._renderer.updateTileBackground(this.backgroundColor)}destroy(){this._frameTask.remove(),this._watchUpdatingTracking.destroy(),this._removeAllTiles(),this._set("tilingSchemeLogic",(0,p.SC)(this.tilingSchemeLogic)),this._basemapLayerViewHandles.forEach(((e,t)=>this._unregisterTiledLayerView(t))),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",(0,p.SC)(this.overlayManager)),this._tileCache=(0,p.SC)(this._tileCache),ny.prune(),this._treeDebugger=(0,p.SC)(this._treeDebugger),this._renderer.destroy(),this._iteratorPool=(0,p.SC)(this._iteratorPool),this._upsampleMapCache=(0,p.SC)(this._upsampleMapCache),this._elevationQueryCache=(0,p.SC)(this._elevationQueryCache),this._set("view",null),this._extentHelper=(0,p.SC)(this._extentHelper),this._upsampleInfoPool=(0,p.SC)(this._upsampleInfoPool),iy.size>0&&(console.log(`${iy.size} live TilePerLayerInfo allocations:`),iy.forEach((e=>console.log(e,"\n"))))}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){if(this.lodSnappingEnabled){const{view:e,tilingScheme:t}=this,i=e.scale;if(t&&i){const r=t.levelAtScale(i)+e.qualitySettings.tiledSurface.lodBias,n=t.getMaxLod();return r<=0?null:Math.min(r,n||1/0)}}return null}get lodSnappingEnabled(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get hasStencilEnabledExtents(){return this._extentHelper.stencilEnabledExtents.length>0}get _userClippingExtent(){const{spatialReference:e}=this,{clippingArea:t}=this.view;if(null==t||null==e)return null;const i=(0,H.Ue)(),r=(0,Tm.G)(t,i,e)?i:null,n=this._get("extent");return(0,H.fS)(r,n)?n:r}get rootTilesExtent(){return this._rootTilesExtent}get extent(){const e=(0,H.jV)(this.groundExtent,this._userClippingExtent,(0,H.Ue)()),t=this._get("extent");return(0,H.fS)(e,t)?t:e}get groundExtent(){return null!=this._tilingSchemeExtent?this._tilingSchemeExtent:this._rootTilesExtent}get _tilingSchemeExtent(){return this.tilingSchemeLogic?.extent}get updating(){return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this.running||this._watchUpdatingTracking?.updating||this._asyncWorkItems>0)&&this.ready&&!this.suspended||this.overlayManager?.updating||this.terrainTextureCompressionTracker.compressing)}get running(){return(this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||!this._allTilesSorted||this._layerViewsDirty||this._scaleRangeQueries?.updating||this._frameTask.updating)&&this.ready&&!this.suspended}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get baseOpacity(){return this.view?.map?.ground?.opacity??1}set baseOpacity(e){this.view.map.ground.opacity=e}get viewingMode(){return this.view.state.viewingMode}get ready(){return null!=this._rootTiles}set renderOrder(e){this._renderer.renderOrder=e,this._set("renderOrder",e)}get rootTiles(){return this._rootTiles}get spatialReference(){return this.tilingScheme?.spatialReference??null}get backgroundColor(){return this.view?.map?.ground?.surfaceColor}set backgroundColor(e){this.view.map.ground.surfaceColor=e}set slicePlaneEnabled(e){this._renderer.slicePlaneEnabled=e,this._set("slicePlaneEnabled",e),this._evaluateTransparency()}get tilingSchemeLocked(){return this.tilingSchemeLogic?.tilingSchemeLocked??!1}get wireframe(){return this._renderer?.wireframe}set wireframe(e){e!==this._renderer.wireframe&&(this._renderer.wireframe=e,this._updateAllTileGeometries())}get opaque(){return this._renderer.transparency===Lb.w.Opaque}get invisible(){return this._renderer.transparency===Lb.w.Invisible}set suspended(e){this._set("suspended",e),this._viewChangeUpdate()}get fadeDuration(){return this.view.qualitySettings.fadeDuration??0}intersect(e,t,i,r){this._renderer.intersect(e,t,i,r)}getElevationLevelDelta(e){return e<4?3:this.view.qualitySettings.tiledSurface.elevationLevelDelta}getElevation(e,t,i,r){const n=this._rootTiles;if(!n?.length)return null;if(0===n[0].layerInfo[hf.ELEVATION].length)return null;let s=this._elevationProjectorCache.get(r);if(void 0===s&&(s=(0,cp.R8)(r,this._spatialReference)??null,this._elevationProjectorCache.set(r,s)),null==s)return d.Z.getLogger(this).error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;const a=(0,Pi.i)(yw,e,t,i);return s(a,0,a,0),xw(n,a[0],a[1])}getElevations(e,t,i){const r=this._rootTiles,n=r?r[0].layerInfo[hf.ELEVATION].length:0;if(r?.length&&0!==n)for(let n=0;n<t;++n){const t=3*n;i(n,xw(r,e[t],e[t+1]))}else for(let e=0;e<t;++e)i(e,null)}getScale(e){if(!this.tilingScheme)return null;if(!(0,U.K)(e,yw,this.spatialReference))return d.Z.getLogger(this).error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;const t=this._rootTiles;if(null!=t)for(const e of t)if(e?.containsPoint(yw)){let t=e;for(;t.children[0]&&!t.rendered;){const e=t.children[0].extent;let i=0;yw[0]>e[2]&&(i+=1),yw[1]<e[1]&&(i+=2),t=t.children[i]}return this._getLodBiasCorrectedScale(t.level)}return 1/0}_ensureProjector(e){const t=this._projectorCache.get(e);if(t)return t;const i=(0,cp.R8)(e,this._tilingSchemeSpatialReference)??null;return this._projectorCache.set(e,i),i}getSphereElevationBounds(e,t){const i=this._ensureProjector(t);if(null==i)return d.Z.getLogger(this).error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),null;(0,es.e)(e,vw);const r=(0,es.a)(vw);i(r,0,r,0);const n=new Qm.r,s=this._rootTiles;if(null!=s){const e=[];for(const t of s)e.push(t);let t=0;for(;t<e.length;){const i=e[t];if(++t,!(0,H.hr)(i.extent,vw))continue;const r=i.children;if(null==r[0]||i.rendered)n.expandElevationRangeValues(i.elevationBoundsMin,i.elevationBoundsMax);else for(const t of r)e.push(t)}}return n}getRootElevationBounds(){return new Qm.r(this.rootTileElevationBounds.min,this.rootTileElevationBounds.max)}getLowerBoundRadius(){const e=(this._ellipsoid.radius+this.visibleElevationBounds.min)*this._radiusModifier;return Math.min(e,this._ellipsoid.radius)}getSphereScale(e,t){if(!this.tilingScheme)return null;if(!(0,U.K)(e,(0,es.a)(vw),this.spatialReference))return d.Z.getLogger(this).error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;vw[3]=t;let i=null;const r=e=>{if(e&&(0,H.hr)(e.extent,vw)){const t=e.children;if(t[0]&&!e.rendered)for(const e of t)r(e);else{const t=this._getLodBiasCorrectedScale(e.level);i=null==i?t:Math.min(i,t)}}},n=this._rootTiles;if(null!=n)for(const e of n)r(e);return i}queryVisibleScaleRange(e,t,i,r){if(!this._scaleRangeQueries)return;const n=t?this.tilingScheme.levelAtScale(t):0,s=i?this.tilingScheme.levelAtScale(i):1/0,a=this._lodBias;this._scaleRangeQueries.queryVisibleLevelRange(e,n+a,s+a,r)}_evaluateTransparency(){const e=this.baseOpacity,t=this.overlayManager.renderer.isEmpty,i=this._renderer.transparency,r=this._isFullyTransparent?t?Lb.w.Invisible:Lb.w.InvisibleWithDraped:e>=1&&!this.hasCompositeBlendMode&&!this._renderer.slicePlaneEnabled?Lb.w.Opaque:Lb.w.Transparent;return this._renderer.transparency=r,i!==r}_updateTilingScheme(){const e=this.tilingSchemeLogic.tilingScheme;if(e===this.tilingScheme)return;(0,X_.wu)(!!e,"tiling scheme cannot be reset to undefined"),this._isGlobal=!this.view?.state?.isLocal,this.tilingScheme&&this._removeAllTiles();const t=e?.spatialReference??N.Z.WebMercator;this._spatialReference=t,this._isWebMercator=!!t?.isWebMercator,this._isWebMercatorOnPlateCarree=this._isWebMercator&&(0,Ee.QM)(this.view?.renderSpatialReference),this._isGeographic=t?.isGeographic??!1,this._set("tilingScheme",e),this._tilingSchemeSpatialReference=this.tilingScheme?.spatialReference,this._projectorCache.clear(),this._updateClippingExtent(),e&&(this._updateTiledLayers(),this._renderer.tileSize=e.pixelSize,this.overlayManager.spatialReference=e.spatialReference,this._updateRootTiles())}static{this._tileMemcacheKey="TerrainTileMemcache"}_acquireTile(e,t,i,r){const n=this._tileCache.pop(pw._tileMemcacheKey);return n?(n.init(e,t,i,r,this),n):new this._tileConstructor(e,t,i,r,this)}get updatingRootTiles(){return this._updatingRootTiles}_updateRootTiles(){const{extent:e,tilingScheme:t}=this;if(!t)return;const i=bw;let r=t.rootTilesInExtent(e,i,5*ce.$X);if(null!=this._rootTiles){if(r.length>ce.$X)return void d.Z.getLogger(this).warn(ce.C5);const e=this._rootTiles.map((e=>e.lij)),t=(0,Fe.e5)(e,r,dy);if(this._updatingRootTiles=!0,t.removed.length>0||t.added.length>0){const e=this._rootTiles.filter((e=>!(t.removed.findIndex((t=>dy(t,e.lij)))>-1&&(this._purgeTile(e),1))));t.added.forEach((t=>e.push(this._newRootTile(t)))),this._setRootTiles(e)}}else this._updatingRootTiles=!0,r.length>ce.$X&&(d.Z.getLogger(this).warn(ce.p1),r=t.rootTilesInExtent(e,i,ce.$X)),this._setRootTiles(r.map((e=>this._newRootTile(e))));(0,H.fS)(i,this._rootTilesExtent)||(this._rootTilesExtent=(0,H.Ue)(i)),this.renderer.visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready"),this._updateAllTileGeometries(),this._updatingRootTiles=!1,this.checkAllTilesWaterproofness()}_updateAllTileGeometries(){const e=this._allTiles.filter((e=>e.loaded&&e.intersectsClippingArea));e.sort(Eg.gl),e.forEach((e=>this._renderer.updateTileGeometryState(e))),e.forEach((e=>e.renderData.updateNeighborData())),this._updateTilesGeometries(e),this._pendingTilesToUpdate.clear()}_updateTilesGeometries(e){if(0===e.length)return;e.sort(Eg.gl);const t=this.renderer;e.forEach((e=>t.updateGeometryIfNeeded(e))),e.forEach((e=>this._pendingTilesForElevationUpdateEvent.add(e)))}_shouldSplit(e){return e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.snapLevel)===ry.SPLIT}_newRootTile(e){const t=this._acquireTile(0,e[1],e[2],null);return this._shouldSplit(t)&&t.setPendingUpdate(ry.SPLIT),this._loadTile(t),this._markTileToUpdate(t),this._updateRootTileElevationBounds(),t}_setRootTiles(e){if(this._rootTiles=e,this._allTiles.clear(),null!=e){const t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());t.remove()}this._renderer.setRootTiles(this._rootTiles),this._updateTilesVisibility(e),this.notifyChange("demResolution")}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this.renderer.visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this._rootTiles)))}_updateClippingStatus(e){e.updateClippingStatus(this.extent)&&e.resetPendingUpdate(ry.GEOMETRY)&&this._updateTileGeometryState(e)}_updateTilesVisibility(e){if(null==e)return;const t=(0,Eg.t8)(e),i=this.visibleElevationBounds;let r=t?i.min:1/0,n=t?i.max:-1/0;const s=this.extent,a=this.view.state.contentCamera.viewProjectionMatrix;this.setTileTreeDirty();const o=this._iteratorPool.acquire();for(o.reset(e);!o.done;){const e=o.next();e.updateClippingStatus(s)&&e.resetPendingUpdate(ry.GEOMETRY)&&this._updateTileGeometryState(e),e.computeVisibility(),e.updateScreenDepth(a),e.renderData&&(r=Math.min(e.elevationBoundsMin,r),n=Math.max(e.elevationBoundsMax,n))}o.remove(),this._viewChanged=!0,this._allTilesDirty=!0,this._updatePendingTileGeometries(),isFinite(r)&&isFinite(n)&&(i.min!==r||i.max!==n)&&(this.visibleElevationBounds=new q_(r,n))}_updateRootTileElevationBounds(){let e=1/0,t=-1/0;const i=this._rootTiles;null!=i&&i.forEach((({elevationBoundsMin:i,elevationBoundsMax:r})=>{e=Math.min(e,i),t=Math.max(t,r)}));const r=this.rootTileElevationBounds;r.min===e&&r.max===t||(this.rootTileElevationBounds=new q_(e,t))}_updateViewDependentParameters(){const{camera:e,contentCamera:t}=this.view.state,i=Math.tan(.5*t.fovX),r=Math.tan(.5*t.fovY),n=this.tilingScheme.pixelSize,s=2**-this._lodBias*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=i,this._splitLimits.fovY=r,this._splitLimits.relativeWidthLimit=n/e.width*this.maxTextureScale*s,this._splitLimits.relativeHeightLimit=n/e.height*this.maxTextureScale*s,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?this._splitLimits.frustum=(0,_c.JG)(this._splitLimits.frustum??(0,_c.Ue)(),t.frustum):this._splitLimits.frustum=null,(0,_c.JG)(this._frustum,e.frustum),(0,Pi.c)(this._eyePosRenderSR,t.eye),(0,mc.S)(e.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateTileGeometryState(e){e.updateVisibility(),this._renderer.updateTileGeometryState(e)&&this._markTileToUpdate(e),this.setMemoryDirty()}_markAllTileNeighborsForUpdate(e){e.forEachLoadedNeighbor((e=>{this._layerViews[hf.MAP].some(X_.Q)&&e.setPendingUpdate(ry.TEXTURE_FADING),this._pendingTilesToUpdate.add(e)}))}_updateTileTexture(e,t){const i=e.resetPendingUpdate(ry.TEXTURE_FADING)?ry.TEXTURE_FADING:!!e.resetPendingUpdate(ry.TEXTURE_NOFADING)&&ry.TEXTURE_NOFADING;i&&(this._renderer.updateTileTexture(e,i),this._usedMemory=null,t.madeProgress())}_emitElevationUpdateEventForTiles(){if(!this._shouldEmitChangeEvent)return;const e=ww.extent;(0,H.cS)(e),this._pendingTilesForElevationUpdateEvent.forEach((t=>(0,H.jn)(e,t.extent,e))),this._pendingTilesForElevationUpdateEvent.clear(),ww.spatialReference=this.spatialReference,this.emit("elevation-change",ww),this._shouldEmitChangeEvent=!1}runTask(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this.renderer.processScaleRangeQueries(this._scaleRangeQueries,e),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateAllTilesStatus(e),this._sortTiles(e);const t=!this.view.state.fixedContentCamera;if(this._mergeAndSplit(e,t),this._updateElevation(e),this._updateTextures(e),t||this._mergeAndSplit(e,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),this._updatePendingTileGeometries(),this._emitElevationUpdateEventForTiles(),e.done&&e.hasProgressed&&this.requestUpdate(),this.notifyChange("updatingProgressValue"),X_.T9&&this._checkTileInvariant(),!e.hasProgressed)return sr.J}_checkTileInvariant(){const e=new Map;this._allTiles.forAll((t=>e.set(t,new Set))),this._allTiles.forAll((t=>{if((0,X_.wu)(t.rendered===t.leaf,` rendered ${t.rendered} != ${t.leaf} leaf`),!t.leaf){const e=e=>0===e.unmergableChildCount&&0===e.maxLevelDeltaNeighborCount,i=t.children.reduce(((t,i)=>t+(e(i)?0:1)),0);if((0,X_.wu)(t.unmergableChildCount===i,` Tile[${t.lij.toString()}] unmergeable child count mismatch: actual ${t.unmergableChildCount} vs ${i}`),t.hasPendingUpdate(ry.MERGE)){(0,X_.wu)(!t.hasPendingUpdate(ry.SPLIT),"Tile can be both split and merge at the same time");for(const e of t.children)(0,X_.wu)(e.leaf||e.hasPendingUpdate(ry.MERGE),"Child of tile to merge must also merge")}}for(let i=0;i<4;++i){if(t.rendered){const e=t.renderData?.geometryState.edgePeerNeighbors[i];if(null!=e){{const r=t.level-e.level<=ce.qC;r||(console.log(`tile level delta [${t.lij.toString()}] vs [${e.lij.toString()}] > ${ce.qC}  (edge[${i}])`),(0,X_.wu)(r,`tile level delta [${t.level}] vs [${e.level}] > ${ce.qC}`))}(0,X_.wu)(t.level-e.level<=ce.qC,`Max tile lod delta exceeded: [${t.lij.toString()}] vs [${e.lij.toString()}]`)}}const r=t.level-ce.qC,n=e=>e.leaf||e.level===t.level,s=t.findNeighborTile(X_.OC[i],n);if(null!=s){if(t.leaf&&t.level>=ce.qC){let i=s;for(;t.level-i.level<ce.qC;)i=i.parent;if(!dy([r,t.lij[1]>>ce.qC,t.lij[2]>>ce.qC],i.lij)){const r=e.get(i);(0,X_.wu)(!r.has(t),"Cannot already have neighbor"),r.add(t)}}(0,X_.wu)(s.rendered||s.level===t.level,"Non-same-level-neighbor of rendered must be rendered"),(0,X_.wu)(t.level-s.level<=ce.qC,`Tile level delta [${t.level}] vs [${s.level}] > ${ce.qC}`)}}})),this._allTiles.forAll((t=>{const i=t.maxLevelDeltaNeighborCount,r=e.get(t);(0,X_.wu)(i===r.size,`Tile[${t.lij.toString()}] merge-blocker mismatch: actual ${i} vs ${r.size}`)}))}_updateAllTilesStatus(e){if(!this._viewChanged||!this._rootTiles||e.done)return;this._viewChanged=!1;const t=new Tw(this._allTiles.length);t.pushAll(this._rootTiles);const i=this.snapLevel,r=this._splitLimits,n=this._eyePosRenderSR;this._allTiles.forAll((e=>{e.maxLevelDeltaNeighborCount=0,e.unmergableChildCount=0}));const s=this.view.state.contentCamera.viewProjectionMatrix;for(;!t.empty;){const e=t.pop(),a=e.parent,o=null!=a&&a.hasPendingUpdate(ry.MERGE),l=o?ry.MERGE:e.shouldSplit(r,n,i),c=l===ry.SPLIT;e.leaf?Sw(e,c):t.pushAll(e.children),o?(e.resetPendingUpdate(ry.SPLIT),e.leaf||e.setPendingUpdate(ry.MERGE),this._updateClippingStatus(e),e.updateVisibility(),e.updateScreenDepth(s)):c?(e.resetPendingUpdate(ry.MERGE),e.leaf&&e.setPendingUpdate(ry.SPLIT)):(e.resetPendingUpdate(ry.SPLIT)&&e.updateAgentSuspension(),l===ry.ELEVATION&&e.updateAgents(hf.ELEVATION),e.leaf||(e.setPendingUpdate(ry.MERGE),e.resetPendingUpdate(ry.SPLIT)))}this.requestUpdate(),(this._shortBatches||!this._oneBatchPerFrameTask)&&this._updatePendingTileGeometries(),e.madeProgress()}_sortTiles(e){e.done||this._allTilesSorted||((0,Eg.b)(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),e.madeProgress())}_markTileToUpdate(e){(0,X_.Fp)(e.loaded),e.intersectsClippingArea&&(this._pendingTilesToUpdate.add(e),this._markAllTileNeighborsForUpdate(e))}_updatePendingTileGeometries(){const e=this._pendingTilesToUpdate,t=Array.from(e.keys()).filter((e=>e.loaded&&e.intersectsClippingArea));if(0===t.length)return void e.clear();const i=(i,r)=>{!r?.loaded||!r.intersectsClippingArea||r.level<i.level||e.has(r)||(e.add(r),t.push(r),r.renderData.updateNeighborData())};t.sort(Eg.gl);const r=t.length;for(let n=0;n<r;++n){const r=t[n];(0,X_.Fp)(r.loaded),(0,X_.Fp)(r.intersectsClippingArea);const s=r.renderData;s.updateNeighborData();const a=s.dirtyEdgeResolutions,o=s.geometryState,l=e=>{const t=X_.cA[e];i(r,o.cornerPeerNeighbors[e]?.findCorner((0,X_.$v)(t),(e=>e.loaded)))};for(let t=0;t<4;++t)if(a&1<<t){const n=s.geometryState.edgePeerNeighbors[t];n&&n?.level>=r.level&&n.forAllSubtreeOnSide((0,X_._F)(X_.OC[t]),(t=>!(!t.loaded||!t.intersectsClippingArea||((0,X_.Fp)(e.has(t)||(0,Eg.gl)(r,t)<0),i(r,t),0)))),l((t+1)%4),l(t)}}e.clear(),this._updateTilesGeometries(t),this._shouldEmitChangeEvent=!0,X_.T9&&X_.V0&&this.checkAllTilesWaterproofness()}_mergeAndSplit(e,t){if(this.suspended||e.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate();let i=!1;const r=this.view.state.fixedContentCamera;let n=!1;for(;!e.done;){n=!0;let s=!1;const a=!this._allTiles.some((n=>{if(!i&&!r&&!n.visible)return e.done;let a=n;if(n.hasPendingUpdate(ry.MERGE)){if(!t||n.unmergableChildCount>0)return e.done;for(n.resetPendingUpdate(ry.MERGE);null!=a.parent&&0===a.parent.unmergableChildCount&&a.parent.resetPendingUpdate(ry.MERGE);)a=a.parent;this._mergeTile(a),s=!0,e.madeProgress()}else if(n.resetPendingUpdate(ry.SPLIT)){let t=!0;const i=n.level;if(i>=ce.qC){const e=e=>e.leaf||i-e.level<ce.qC;for(let r=0;r<4;++r){const s=n.findNeighborTile(X_.OC[r],e);null!=s&&i-s.level===ce.qC&&(t=!1,X_.T9&&((0,X_.Fp)(s.leaf),(0,X_.Fp)(s.hasPendingUpdate(ry.SPLIT))))}}t?(this._splitTile(n),e.madeProgress(),s=!0):n.setPendingUpdate(ry.SPLIT)}return e.done}));if(s&&(this._allTilesSorted=!1,this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries()),a){if(!i){i=!0;continue}if(!s)break}else this._allTilesDirty=!0}n?e.madeProgress():this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries(),this._sortTiles(e)}_updateElevation(e){e.done||(this._allTiles.some((t=>(t.resetPendingUpdate(ry.GEOMETRY)&&(this._updateTileGeometryState(t),this._shortBatches&&this._updatePendingTileGeometries(),e.madeProgress()),e.done))),!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries())}_updateTextures(e){e.done||this._allTiles.some((t=>(this._updateTileTexture(t,e),e.done)))}_updateClippingExtent(){this.spatialReference&&(this.overlayManager?.updateOverlayParameters(Cr.Xx.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}get _lodBias(){const e=this.view.quality;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*ce.if}_getLodBiasCorrectedScale(e){const t=this.tilingScheme.levels,i=(0,st.uZ)(e-this._lodBias,0,t.length-1),r=i-Math.floor(i);return t[Math.floor(i)].scale*(1-r)+t[Math.ceil(i)].scale*r}_removeAllTiles(){null!=this._rootTiles&&(this._rootTiles.forEach((e=>this._purgeTile(e))),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.notifyChange("demResolution"),this.renderer.visible=!1}_purgeSubtree(e){const t=e.children;t[0]&&(this._purgeTile(t[0]),this._purgeTile(t[1]),this._purgeTile(t[2]),this._purgeTile(t[3]),e.clearChildren())}_purgeTile(e){e.leaf?Ew(e):this._purgeSubtree(e),this._allTiles.removeUnordered(e),this._unloadTile(e),e.dispose(),this._tileCache.put(pw._tileMemcacheKey,e),this.notifyChange("demResolution")}_unloadTile(e){this._pendingTilesToUpdate.delete(e),this._pendingTilesForElevationUpdateEvent.delete(e),e.unload()}_splitTile(e){(0,X_.wu)(e.leaf,"Tile that is already split should not be split again!"),(0,X_.wu)(e.rendered,"Tile marked to split is not rendered"),Ew(e);const t=e.createChildren();this._allTiles.pushArray(t),this.notifyChange("demResolution"),e.updateAgentSuspension(),(0,X_.wu)(e.rendered,"parent should be rendered"),t.forEach((e=>this._loadTile(e))),t.forEach((e=>this._pendingTilesToUpdate.add(e))),this._unloadTile(e),this._markAllTileNeighborsForUpdate(e),this._emitTileScaleChange(e,e.level+1),this._allTilesDirty=!0,this._shortBatches&&this._updatePendingTileGeometries(),t.forEach((e=>Sw(e,e.hasPendingUpdate(ry.SPLIT)))),++this._performanceInfo.numSplit}_emitTileScaleChange(e,t=e.level){Cw.spatialReference=this.spatialReference,Cw.extent=e.extent,Cw.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",Cw)}createTile(e,t,i,r){(0,X_.wu)(!!r,"createTile sanity check");const n=this._acquireTile(e,t,i,r);return n.updateClippingStatus(this.extent),n.updateScreenDepth(this.view.state.contentCamera.viewProjectionMatrix),this._shouldSplit(n)&&n.setPendingUpdate(ry.SPLIT),n}get _shortBatches(){return this.view.state.mode!==$c.n.IDLE}_mergeTile(e){(0,X_.wu)(!e.hasPendingUpdate(ry.SPLIT),"_mergeTile sanity check"),(0,X_.wu)(!e.leaf,"Cannot merge a leaf"),e.leaf||(this._purgeSubtree(e),(0,X_.wu)(!e.renderData,"Merging tile with existing render data?"),this._loadTile(e),this._markTileToUpdate(e),this._emitTileScaleChange(e),this._shortBatches&&this._updatePendingTileGeometries(),Sw(e,!1),this._allTilesDirty=!0,++this._performanceInfo.numMerged)}_loadTile(e){e.load(),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager?.hasOverlays&&this.overlayManager.updateTileOverlayParameters(e)}_handleLayerViewChanges(e=nr.G5){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let t=!1;const i=new Set;let r=-1;for(let e=this.view.allLayerViews.length-1;e>=0;e--){const n=this.view.allLayerViews.items[e];if(i.add(n.uid),(0,X_.wP)(n)||(0,X_.a_)(n))if(this._basemapLayerViewHandles.has(n.uid)&&!(0,X_.a_)(n)){const e=this._layerClassFromLayerView(n),i=this._getLayerIdxByUID(e,n.uid);null!=i&&((i<r||null==r)&&(t=!0),r=i)}else this._registerTiledLayerView(n),n.layer.loaded&&(t=!0)}this._basemapLayerViewHandles.forEach(((e,r)=>{i.has(r)||(this._unregisterTiledLayerView(r),t=!0)})),t&&this._updateTiledLayers(),this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._evaluateTransparency(),e.madeProgress()}get _isFullyTransparent(){if(this.view.map?.ground?.opacity>0)return!1;for(const e of this.view.allLayerViews.items)if((0,X_.GL)(e)&&!(0,B.sy)(e.layer)&&0!==e.fullOpacity)return!1;return!0}_hasCompositeBlendMode(){for(const e of this.view.allLayerViews.items)if(((0,X_.TK)(e)||(0,X_.a_)(e))&&(0,eb.MV)(eb.pU[e.layer.blendMode]))return!0;return!1}_layerClassFromLayerView(e){return(0,X_._1)(e)?hf.ELEVATION:hf.MAP}_registerTiledLayerView(e){const t=[];if(((0,X_.TK)(e)||(0,X_.a_)(e))&&t.push((0,_.YP)((()=>e.layer.blendMode),(()=>{this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._updateTileTextures(eg.Ns.UNFADED)}))),!(0,X_.a_)(e)){const i=this._layerClassFromLayerView(e);t.push((0,_.YP)((()=>e.suspended),(()=>this._updateTiledLayers()))),t.push((0,_.YP)((()=>e.fullOpacity),(()=>this._updateTileTextures(eg.Ns.UNFADED)))),t.push((0,_.YP)((()=>"effectiveScaleRange"in e.layer?e.layer.effectiveScaleRange:null),(()=>this._restartAllAgents(i)))),t.push(e.on("data-changed",(()=>{const t=this._getLayerIdxByUID(i,e.uid);null!=t&&this._invalidateLayerData(t,i)})))}this._unregisterTiledLayerView(e.uid),this._basemapLayerViewHandles.set(e.uid,t)}_unregisterTiledLayerView(e){const t=this._basemapLayerViewHandles.get(e);if(t){for(const e of t)e.remove();this._basemapLayerViewHandles.delete(e)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const e=this.view.allLayerViews,t=[[],[]];let i=null;e.forEach((e=>{if(!e.layer||e.suspended||!(0,X_.wP)(e)||!e.fullExtent)return;const r=this._layerClassFromLayerView(e);if(r===hf.MAP){const t=e.displayLevelRange.maxLevel;t!==1/0&&(null===i||t>i)&&(i=t)}t[r].push(e)}));for(const e of uf){const i=this._layerViews[e],r=t[e];r.reverse();const n=r.length;let s=i.length!==n;const a=new Array(n),o=new Array(i.length);this._layerIndexByUid[e].clear();for(let t=0;t<n;t++){const n=r[t].uid;this._layerIndexByUid[e].set(n,t);const l=i.indexOf(r[t]);a[t]=l,t!==l&&(s=!0),l>-1&&(o[l]=t)}if(s){const t=this._postorderIterator;for(t.reset(this._rootTiles);!t.done;)t.next().modifyLayers(o,a,e);this._layerViews[e]=r,this._restartAllAgents(e),this._updateTilesVisibility(this._rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&(this._viewChangeUpdate(),this.notifyChange("tilingScheme"))}_restartAllAgents(e){const t=this._postorderIterator;for(t.reset(this._rootTiles);!t.done;){const i=t.next();i.restartAgents(e),e===hf.ELEVATION&&i.computeElevationBounds()}this._updateRootTileElevationBounds()}layerViewByIndex(e,t){return this._layerViews[t][e]}numLayers(e){return this._layerViews[e].length}_updateTileTextures(e){this._allTiles.forAll((t=>{t.updateAgents(hf.MAP),e===eg.Ns.IMMEDIATE?this.renderer.updateTileTexture(t,ry.TEXTURE_NOFADING):t.updateRenderData(hf.MAP,e)})),this._evaluateTransparency()}_invalidateLayerData(e,t){this._allTiles.forAll((i=>i.removeLayerAgent(e,t))),this._allTiles.forAll((i=>i.invalidateLayerData(e,t)))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(e=Cr.Xx.UPDATE){this.renderer.setNeedsRender(e)}requestUpdate(){1==++this._pendingUpdates&&(this._hasPendingUpdates=!0)}requestTileData(e,t,i,r){const n=this.layerViewByIndex(t,i),s=n.layer;return!s.tilemapCache||(0,X_.Q)(n)?this._requestTileData(e,i,n,r):(++this._asyncWorkItems,s.tilemapCache.fetchAvailability(e.level,e.lij[1],e.lij[2],{...r,timeout:6e3}).then((()=>--this._asyncWorkItems)).catch((t=>{throw--this._asyncWorkItems,(0,f.k_)(r),(0,f.D_)(t)||this._dataMissing(e,i,n),t})).then((()=>this._frameTask.schedule((()=>this._requestTileData(e,i,n,r)),r.signal))))}_requestTileData(e,t,i,r){if(this.destroying)return Promise.resolve();const n=t===hf.ELEVATION;return r.requester??=n?this._elevationDataRequester:this._mapDataRequester,n?(0,X_._1)(i)?this._requestElevationTileData(e,i,r):Promise.reject():(0,X_.GL)(i)?this._requestMapTileData(e,i,r):Promise.reject()}_requestElevationTileData(e,t,i){++this._asyncWorkItems;const r=r=>{!(0,f.Hc)(i)&&r&&(this.setMemoryDirty(),this.requestUpdate(),this._elevationDataArrived(e,t,r))};return t.fetchElevationTile(e,i).then((e=>this._frameTask.schedule((()=>r(e)))),(i=>{(0,f.D_)(i)||(d.Z.getLogger(this).error(`Tile ${e.lij.toString()} layer ${hf.ELEVATION}/${t.uid} error ${i}`),this._dataMissing(e,hf.ELEVATION,t),this.requestUpdate())})).finally((()=>--this._asyncWorkItems))}_elevationDataArrived(e,t,i){const r=this._layerIndexByUid[hf.ELEVATION].get(t.uid);if(null==r)return void d.Z.getLogger(this).warn("TerrainSurface: received data from unknown layer %d %s",hf.ELEVATION,e.lij.toString());const n=new j_(e.lij,e.extent,i);e.dataArrived(r,hf.ELEVATION,n);const s=[e],a=e.level,o=this._iteratorPool.acquire();for(o.reset(s);!o.done;){const e=o.next();e.findElevationBoundsForLayer(r,a),e.computeElevationBounds()}0===a&&this._updateRootTileElevationBounds(),o.remove(),this._updateTilesVisibility(s)}_requestMapTileData(e,t,i){++this._asyncWorkItems;const r=(r,n)=>{(0,X_.ep)(n),(0,f.Hc)(i)||(console.error(`Tile ${e.lij.toString()} layer ${hf.MAP}/${t.uid} error ${r}`),this._dataMissing(e,hf.MAP,t),this.requestUpdate())},n=e=>t=>r(t,e);return t.fetchTile(e.lij,i).then((r=>this._frameTask.schedule((()=>{this.requestUpdate(),(0,f.Hc)(i)?(0,X_.ep)(r):this._mapTileDataArrived(e,t,r)}),i.signal,n(r)).catch(n(r))),((e,t=null)=>this._frameTask.schedule((()=>r(e,t))))).finally((()=>--this._asyncWorkItems))}_mapTileDataArrived(e,t,i){const r=this._getLayerIdxByUID(hf.MAP,t.uid);if(null==r)return(0,X_.ep)(i),void d.Z.getLogger(this).warn("TerrainSurface: received data from unknown layer");e.dataArrived(r,hf.MAP,i)}_getLayerIdxByUID(e,t){return this._layerIndexByUid[e].get(t)}_dataMissing(e,t,i){const r=this._getLayerIdxByUID(t,i.uid);null!=r?e.dataMissing(r,t):d.Z.getLogger(this).warn("TerrainSurface: received data from unknown layer")}get performanceInfo(){const e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll((t=>{t.leaf&&e.numLeaves++;const i=t.level;t.renderData&&(e.numLoadedPerLevel[i]=(e.numLoadedPerLevel[i]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[i]=(e.numRenderedPerLevel[i]||0)+1,e.numRendered++))})),e}setMemoryDirty(){this._usedMemory=null}get usedMemory(){return this.tilingScheme?(null==this._usedMemory&&(this._usedMemory=this._recalculateUsedMemory()),this._usedMemory??0):0}_recalculateUsedMemory(){return this.tilingScheme?Math.round(this._allTiles.reduce(((e,t)=>e+t.usedMemory),0)):null}getUsedMemoryForLayerView(e){let t=0;const i=this._layerClassFromLayerView(e),r=this._getLayerIdxByUID(i,e.uid);return null!=r&&this._allTiles.forAll((e=>t+=e.getUsedMemoryForLayer(i,r))),t}get renderPatchBorders(){return this._renderer.renderPatchBorders}set renderPatchBorders(e){this._renderer.renderPatchBorders=e}get visualizeNormals(){return this._renderer.visualizeNormals}set visualizeNormals(e){this._renderer.visualizeNormals=e}get renderingDisabled(){return this._renderer.renderingDisabled}set renderingDisabled(e){this._renderer.renderingDisabled=e}get test(){}checkAllTilesWaterproofness(){if(!X_.V0)return;const e=this._rootTiles;if(null==e)return;const t=e=>e?.renderData?.geometry?.indices?.length>0,i=(e,i)=>{t(e)&&console.error("Tile[",e.lij,"] has geometry although parent[",i.lij,"] has geom")},r=e=>{if(e.intersectsClippingArea)if(e.renderData&&!e.renderData.geometryState&&console.error("Tile[",e.lij,"] has renderData but not geometryState"),e.renderData&&!e.renderData.geometry&&console.error("Tile[",e.lij,"] has renderData but not geometryInfo"),!e.renderData?.geometry||(e.renderData.geometry.indices?.length??0)>0||console.error("Tile[",e.lij,"] has renderData but no indices - geometryInfo: ",e.renderData.geometry),t(e)){e.checkGeometryWaterproofness();for(const t of e.children)i(t,e)}else if(e.leaf)console.error("Tile[",e.lij,"] has no geometry and no children, from root to leaf");else for(const t of e.children)r(t)},n=e=>{const t=e.parent?.visible??!0,i=e.visible;e.computeVisibility();const r=e.visible;if(i!==r&&t&&console.error(" Tile[",e.lij,"] has out of date visibility: ",i," instead of ",r),!e.leaf)for(const t of e.children)n(t)};for(const t of e)r(t),n(t)}get isGlobal(){return this._isGlobal}get isGeographic(){return this._isGeographic}get isWebMercator(){return this._isWebMercator}get isWebMercatorOnPlateCarree(){return this._isWebMercatorOnPlateCarree}isEastEndWrap(e){return this._isGlobal&&e[2]===this.lijEastEnd(e[0])-1}isWestEndWrap(e){return this._isGlobal&&0===e[2]}lijEastEnd(e){return 1<<e+(this._isGeographic?1:0)}wrapEastWest(e){const t=this.lijEastEnd(e[0]),i=e[2];if(0<=i&&i<t)return e;if(!this._isGlobal)return null;const r=(i+(i<0?t:0))%t;return[e[0],e[1],r]}enableInternalChecks(e){(0,X_.qA)(e)}enableWaterproofnessChecks(e){(0,X_.HK)(e)}};(0,r._)([(0,w.Cb)()],_w.prototype,"_renderer",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],_w.prototype,"_scaleRangeQueries",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],_w.prototype,"view",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],_w.prototype,"overlayManager",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],_w.prototype,"terrainTextureCompressionTracker",void 0),(0,r._)([(0,w.Cb)()],_w.prototype,"_hasPendingUpdates",void 0),(0,r._)([(0,w.Cb)()],_w.prototype,"_asyncWorkItems",void 0),(0,r._)([(0,w.Cb)()],_w.prototype,"_allTilesDirty",void 0),(0,r._)([(0,w.Cb)()],_w.prototype,"_allTilesSorted",void 0),(0,r._)([(0,w.Cb)()],_w.prototype,"_viewChanged",void 0),(0,r._)([(0,w.Cb)({type:Number})],_w.prototype,"heading",void 0),(0,r._)([(0,w.Cb)()],_w.prototype,"_splitLimits",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],_w.prototype,"_watchUpdatingTracking",void 0),(0,r._)([(0,w.Cb)()],_w.prototype,"_frameTask",void 0),(0,r._)([(0,w.Cb)()],_w.prototype,"demResolution",null),(0,r._)([(0,w.Cb)({readOnly:!0})],_w.prototype,"snapLevel",null),(0,r._)([(0,w.Cb)({readOnly:!0})],_w.prototype,"lodSnappingEnabled",null),(0,r._)([(0,w.Cb)()],_w.prototype,"_userClippingExtent",null),(0,r._)([(0,w.Cb)()],_w.prototype,"_rootTilesExtent",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],_w.prototype,"extent",null),(0,r._)([(0,w.Cb)({readOnly:!0})],_w.prototype,"groundExtent",null),(0,r._)([(0,w.Cb)({readOnly:!0})],_w.prototype,"_tilingSchemeExtent",null),(0,r._)([(0,w.Cb)({readOnly:!0})],_w.prototype,"updating",null),(0,r._)([(0,w.Cb)({readOnly:!0})],_w.prototype,"running",null),(0,r._)([(0,w.Cb)(G_.q)],_w.prototype,"updatingProgress",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],_w.prototype,"updatingProgressValue",null),(0,r._)([(0,w.Cb)()],_w.prototype,"_maxNumUpdating",void 0),(0,r._)([(0,w.Cb)()],_w.prototype,"baseOpacity",null),(0,r._)([(0,w.Cb)()],_w.prototype,"hasCompositeBlendMode",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],_w.prototype,"viewingMode",null),(0,r._)([(0,w.Cb)()],_w.prototype,"maxTextureScale",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],_w.prototype,"ready",null),(0,r._)([(0,w.Cb)({value:rv.z.FRONT_TO_BACK})],_w.prototype,"renderOrder",null),(0,r._)([(0,w.Cb)({readOnly:!0})],_w.prototype,"rootTiles",null),(0,r._)([(0,w.Cb)()],_w.prototype,"_rootTiles",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],_w.prototype,"spatialReference",null),(0,r._)([(0,w.Cb)({type:$e.Z})],_w.prototype,"backgroundColor",null),(0,r._)([(0,w.Cb)({value:!1})],_w.prototype,"slicePlaneEnabled",null),(0,r._)([(0,w.Cb)({readOnly:!0})],_w.prototype,"tilingScheme",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],_w.prototype,"tilingSchemeLocked",null),(0,r._)([(0,w.Cb)({readOnly:!0})],_w.prototype,"tilingSchemeLogic",void 0),(0,r._)([(0,w.Cb)()],_w.prototype,"wireframe",null),(0,r._)([(0,w.Cb)({value:!1})],_w.prototype,"suspended",null),(0,r._)([(0,w.Cb)()],_w.prototype,"fadeDuration",null),(0,r._)([(0,w.Cb)()],_w.prototype,"visibleElevationBounds",void 0),(0,r._)([(0,w.Cb)()],_w.prototype,"rootTileElevationBounds",void 0),(0,r._)([(0,w.Cb)()],_w.prototype,"_layerViewsDirty",void 0),(0,r._)([(0,w.Cb)()],_w.prototype,"renderPatchBorders",null),(0,r._)([(0,w.Cb)()],_w.prototype,"visualizeNormals",null),(0,r._)([(0,w.Cb)()],_w.prototype,"renderingDisabled",null),_w=pw=(0,r._)([(0,x.j)("esri.views.3d.terrain.TerrainSurface")],_w);const gw=_w,yw=(0,R.Ue)(),vw=(0,es.c)(),bw=(0,H.Ue)();new cd.Z;const ww=new z_.c("ground"),Cw={spatialReference:null,extent:null,scale:0};function xw(e,t,i){for(const r of e){if(!r.containsPointXY(t,i))continue;let e=r;for(;e&&!e.renderData;){const r=(t>e.extentMidX?1:0)+(i<e.extentMidY?2:0);e=e.children[r]}return $_(t,i,e?.renderData?.geometryState.samplerData??null)}return null}class Tw{constructor(e){this.capacity=e,this._head=0,this._tail=0,this._data=new Array(e)}push(e){const t=this._tail;if(!(t<this.capacity))throw new Error("Queue full");this._data[t]=e,this._tail=t+1}pushAll(e){const t=e.length;if(0===t)return;const i=this._tail;if(!(i+t<=this.capacity))throw new Error("Queue full");for(let r=0;r<t;++r)this._data[i+r]=e[r];this._tail=i+t}pop(){const e=this._head;if(e<this._tail){const t=this._data[e];return this._head=e+1,t}}get empty(){return this._head>=this._tail}get full(){return this._tail>=this._data.length}}function Sw(e,t){!e.leaf||e.level<ce.qC||Rw(e,(e=>{t&&Mw(e);const i=Pw(e);if(e.maxLevelDeltaNeighborCount++,i){let t=e.parent;for(;t;){const e=Pw(t);if(t.unmergableChildCount++,!e)break;t=t.parent}}}))}function Mw(e){if(e.hasPendingUpdate(ry.SPLIT))return;let t=e.parent;for(;t?.resetPendingUpdate(ry.MERGE);)t=t.parent;e.resetPendingUpdate(ry.MERGE),e.leaf&&e.setPendingUpdate(ry.SPLIT),e.level<ce.qC||Rw(e,(e=>{Mw(e)}))}function Ew(e){e.level<ce.qC||Rw(e,(e=>{if(e.maxLevelDeltaNeighborCount--,0===e.maxLevelDeltaNeighborCount&&0===e.unmergableChildCount){let t=e.parent;for(;t&&(t.unmergableChildCount--,Pw(t));)t=t.parent}}))}function Pw(e){return 0===e.maxLevelDeltaNeighborCount&&0===e.unmergableChildCount}function Rw(e,t){if(e.level<ce.qC)return;const i=e.level-ce.qC,r=e.lij[1]>>ce.qC,n=e.lij[2]>>ce.qC,s=e=>e.leaf||e.level===i;for(let a=0;a<4;++a){const o=e.findNeighborTile(X_.OC[a],s);if(!o||o.level!==i)continue;const l=o.lij;l[1]===r&&l[2]===n||t(o)}}var Aw=i(82915),Ow=i(94125),Dw=i(3648),Iw=i(61544),Lw=i(89341);class Nw{constructor(e,t,i,r){this.operation=e,this.geometry=t,this.states=i,this.sync=r}}let Fw=class extends S.Z{constructor(e){super(e),this._residentGeomRecords=new Iw.r,this._dirtyGeomRecords=new Iw.r,this._dirtyRecordCount=0}get dirty(){return this._dirtyRecordCount>0}commitLayer(e,t){const i=this._dirtyGeomRecords.getInner(e),r=this.model.getLayer(e);if(!i||!r)return;let n=0;i.forEach(((i,s)=>{const a=this._ensureGeomRecord(e,s);this._dirtyGeomRecords.delete(e,s),n+=i.size,i.forEach((({geometry:e,operation:i,states:n},o)=>{let l=!1;if(i===Lw.T.UPDATE){const i=a.get(o);if(i){if(n&Lw.$.TRANSFORMATION){const t=r.getObject(s);this.model.updateRenderGeometryTransformation(t,e,i)&&(l=!0)}l||t.updates.push({renderGeometry:i,updateType:n})}else(0,Mf.hu)(!1,"ModelDirtySet.commitLayer: invalid update")}if(i===Lw.T.REMOVE||l){const e=a.get(o);e?(t.removes.push(e),a.delete(o)):i===Lw.T.REMOVE&&(0,Mf.hu)(!1,"ModelDirtySet.commitLayer: invalid remove")}if(i===Lw.T.ADD||l){const i=r.getObject(s);if(null!=i){const r=this.model.getRenderGeometry(i,e);t.adds.push(r),a.set(o,r)}}})),0===a.size&&this._residentGeomRecords.delete(e,s)})),this._dirtyRecordCount-=n}commitSyncUpdates(e,t){const i=this._dirtyGeomRecords.getInner(e),r=this.model.getLayer(e);i&&r&&i.forEach(((i,n)=>{const s=this._ensureGeomRecord(e,n);i.forEach((({geometry:e,operation:i,states:a,sync:o},l)=>{let c=!1;if(i===Lw.T.UPDATE&&o){const i=s.get(l);if(i){if(a&Lw.$.TRANSFORMATION){const t=r.getObject(n);this.model.updateRenderGeometryTransformation(t,e,i)&&(c=!0)}c||t.updates.push({renderGeometry:i,updateType:a})}else(0,Mf.hu)(!1,"ModelDirtySet.commitSyncUpdates: invalid update")}}))}))}_objectStateChanged(e,t){for(const i of t.geometries)this._updateOrCreateDirtyRecord(t,i,Lw.T.UPDATE,e)}visibilityChanged(e){this._objectStateChanged(Lw.$.VISIBILITY,e)}highlightChanged(e){this._objectStateChanged(Lw.$.HIGHLIGHT,e)}occlusionChanged(e){this._objectStateChanged(Lw.$.OCCLUDEE,e)}attributesChanged({object:e,geometry:t,sync:i}){this._updateOrCreateDirtyRecord(e,t,Lw.T.UPDATE,Lw.$.GEOMETRY,i)}layerAdded(e){e.objects.forEach((e=>this.layerObjectAdded(e)))}layerRemoved(e){e.objects.forEach((e=>this.layerObjectRemoved(e)))}layerObjectAdded(e){for(const t of e.geometries)this._geometryAdded(e,t)}layerObjectRemoved(e){for(const t of e.geometries)this._geometryRemoved(e,t)}layerObjectsAdded(e){for(const t of e)this.layerObjectAdded(t)}layerObjectsRemoved(e){for(const t of e)this.layerObjectRemoved(t)}transformationChanged(e){const t=this._getLayerId(e),i=e.id;this._ensureGeomRecord(t,i).forEach((({geometry:t})=>this._updateOrCreateDirtyRecord(e,t,Lw.T.UPDATE,Lw.$.TRANSFORMATION)))}shaderTransformationChanged(e){const t=this._getLayerId(e),i=e.id;this._ensureGeomRecord(t,i).forEach((t=>t.objectShaderTransformationChanged(e.shaderTransformation)))}geometryAdded(e){this._geometryAdded(e.object,e.geometry)}_geometryAdded(e,t){this._updateOrCreateDirtyRecord(e,t,Lw.T.ADD)}geometryRemoved(e){this._geometryRemoved(e.object,e.geometry)}_geometryRemoved(e,t){this._updateOrCreateDirtyRecord(e,t,Lw.T.REMOVE)}_updateOrCreateDirtyRecord(e,t,i,r=Lw.$.NONE,n=!1){const s=this._getLayerId(e),a=e.id,o=t.id,l=this._ensureDirtyRecord(s,a),c=l.get(o);if(c){const e=c.operation;e===Lw.T.REMOVE&&i===Lw.T.ADD&&c.states!==Lw.$.NONE?c.operation=Lw.T.UPDATE:e===Lw.T.REMOVE&&i===Lw.T.ADD||e===Lw.T.ADD&&i===Lw.T.REMOVE?(l.delete(o),this._dirtyRecordCount--):e!==Lw.T.UPDATE||i!==Lw.T.REMOVE&&i!==Lw.T.UPDATE?((0,Mf.hu)((e===Lw.T.REMOVE||e===Lw.T.ADD)&&i===Lw.T.UPDATE,"ModelDirtySet.objectGeometryAdded: inconsistent state"),c.states|=r):(c.operation=i,c.states|=r),c.sync=c.sync||n}else l.set(o,new Nw(i,t,r,n)),this._dirtyRecordCount++}_ensureGeomRecord(e,t){let i=this._residentGeomRecords.get(e,t);return i||(i=new Map,this._residentGeomRecords.set(e,t,i)),i}assertLayerClean(e){(0,Mf.hu)(null==this._dirtyGeomRecords.getInner(e),"Dirty geometry records for removed layer")}_ensureDirtyRecord(e,t){const i=this.model.getLayer(e);(0,Mf.hu)(null!=i,"Updating geometry record for an unregistered layer");let r=this._dirtyGeomRecords.get(e,t);return r||(r=new Map,this._dirtyGeomRecords.set(e,t,r)),r}_getLayerId(e){return e.layer?.id??ap.J}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forAll(((i,r,n)=>{t.length>0&&(t+="\n"),t+=r+"."+n;const s=[];i.forEach((e=>{const t=e.operation;s[t]||(s[t]=[]),s[t].push(e.geometry.id)}));for(let i=0;i<s.length;i++)if(s[i]){t+=" "+e[i-1]+": ";for(let e=0;e<s[i].length;e++)t+=s[i][e]+", "}})),t}get test(){}};(0,r._)([(0,w.Cb)({constructOnly:!0})],Fw.prototype,"model",void 0),(0,r._)([(0,w.Cb)()],Fw.prototype,"_dirtyRecordCount",void 0),Fw=(0,r._)([(0,x.j)("esri.views.3d.webgl-engine.lib.ModelDirtySet")],Fw);const Uw=Fw;var Hw=i(14357);let kw=class extends S.Z{constructor(){super(...arguments),this.dirtySet=new Uw({model:this}),this._originFactory=new Dw.C(null),this._textures=new Map,this._layers=new Map}hasTexture(e){return this._textures.has(e.id)}getTexture(e){return null==e?null:this._textures.get(e)}addTexture(e){const t=e.id;(0,Mf.hu)(!this._textures.has(t),"Model/Stage already contains texture to be added"),this._textures.set(t,e)}removeTexture(e){return this._textures.delete(e.id)}addTextures(e){for(const t of e)t&&((0,Mf.hu)(!this._textures.has(t.id),"Model/Stage already contains object to be added"),this._textures.set(t.id,t))}removeTextures(e){for(const t of e)t&&((0,Mf.hu)(this._textures.has(t.id),"Model/Stage doesn't contain object to be removed"),this._textures.delete(t.id))}forEachTexture(e){this._textures.forEach((t=>e(t)))}hasLayer(e){return this._layers.has(e.id)}getLayer(e){return null==e?null:this._layers.get(e)}addLayer(e){const t=e.id;(0,Mf.hu)(!this._layers.has(t),"Model/Stage already contains layer to be added"),this._layers.set(t,e)}removeLayer(e){return this._layers.delete(e.id)}getRenderGeometry(e,t){const i=new Hw.z(t,{castShadow:e.castShadow,objectShaderTransformation:e.shaderTransformation}),r=t.localOrigin;return i.transformation=e.getCombinedStaticTransformation(t,Vw),i.localOrigin=r??this._originFactory.getOrigin((0,es.a)(i.boundingSphere)),i}updateRenderGeometryTransformation(e,t,i){if(null==e)return!1;i.transformation=e.getCombinedStaticTransformation(t,Vw);const r=this._originFactory.getOrigin((0,es.a)(i.boundingSphere));return i.localOrigin!==r}get test(){}};(0,r._)([(0,w.Cb)({constructOnly:!0})],kw.prototype,"dirtySet",void 0),kw=(0,r._)([(0,x.j)("esri.views.3d.webgl-engine.parts.Model")],kw);const Vw=(0,Bi.Ue)();var Bw=i(64497),zw=i(92643),Gw=i(78037),qw=i(37132),Zw=i(32667);class jw extends qw.o{constructor(){super(...arguments),this.innerFadeDistance=0,this.altitudeFade=0,this.backgroundColor=(0,R.Ue)()}}class Ww extends Wi.A{constructor(e,t){super(e,t,new ji.J(Zw.C,(()=>i.e(4780).then(i.bind(i,4780)))))}initializePipeline(e){return(0,Xi.sm)({blending:e.reduced?Xi.LW:(0,Xi.if)($i.zi.SRC_ALPHA,$i.zi.ONE_MINUS_SRC_ALPHA),depthTest:{func:e.reduced?$i.wb.ALWAYS:$i.wb.LEQUAL},colorWrite:Xi.gf})}}class $w extends tb.m{constructor(){super(...arguments),this.reduced=!1}}(0,r._)([(0,tb.o)()],$w.prototype,"reduced",void 0);var Xw=i(7332);class Yw extends Wi.A{constructor(e,t){super(e,t,new ji.J(Xw.a,(()=>i.e(92480).then(i.bind(i,92480)))))}initializePipeline(){return(0,Xi.sm)({blending:(0,Xi.if)($i.zi.SRC_ALPHA,$i.zi.ONE_MINUS_SRC_ALPHA),depthTest:{func:$i.wb.ALWAYS},colorWrite:Xi.gf})}}let Kw=class extends xr{constructor(){super(...arguments),this.requireGeometryDepth=!0,this._compositingPassParameters=new Xw.A,this._vao=null,this._passParameters=new jw,this._configuration=new $w}initialize(){this.techniques.precompile(Ww,this._configuration),this.techniques.precompile(Yw),this._configuration.reduced=!0,this.techniques.precompile(Ww,this._configuration),this._configuration.reduced=!1,this.addHandles([(0,_.YP)((()=>this.view.environment.background),(e=>{const t=e instanceof Vn?(0,zw.O)(e.color):tc.AG;(0,Pi.i)(this._passParameters.backgroundColor,t[0]*t[3],t[1]*t[3],t[2]*t[3])}),_.tX),(0,_.YP)((()=>this.view.stage?.renderer?.fullResolutionAtmosphere),(e=>this._configuration.reduced=!e),_.tX),(0,_.YP)((()=>this.view.environment.atmosphereEnabled),(e=>e?this._enable():this._disable()),_.tX)])}destroy(){this._vao=(0,p.M2)(this._vao)}render(e){const t=e.find((({name:e})=>e===dr.CM.OPAQUE_ENVIRONMENT));if(!this.bindParameters.mainDepth)return t;const i=this.renderingContext;this._vao??=(0,mb.ow)(i,mb.Ar.Pos2Tex);const r=t.getAttachment($i.Lu);this._update();const n=this.techniques.get(Ww,this._configuration);if(!n.compiled)return this.requestRender(Cr.Xx.UPDATE),t;if(!this._configuration.reduced)return t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(n,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays($i.MX.TRIANGLE_STRIP,0,4),t.attachDepth(r),t;const s=this.techniques.get(Yw);if(!s.compiled)return this.requestRender(Cr.Xx.UPDATE),t;const a=i.getViewport(),o=this.bindParameters.camera,l=(0,Pi.l)(o.eye)-_i.sv.radius;let c;const h=_i.sv.atmosphereHeight;if(l<h){const e=Math.min(1,Math.max(0,l/h));c=(0,st.t7)(.2,.3,e)}else{const e=Math.min(1,Math.max(0,(l-h)/(15*h)));c=(0,st.t7)(.3,.6,e)}const u=this.renderingContext.parameters.maxTextureSize,d=(0,sg.nq)(Math.round(c*o.fullViewport[2]),u),p=(0,sg.nq)(Math.round(c*o.fullViewport[3]),u);i.setViewport(0,0,d,p);const m=this.fboCache.acquire(d,p,"chapman",Td.qz.RGBA8UNORM);return i.bindFramebuffer(m.fbo),i.clearFramebuffer([0,0,0,1],!0,!0),i.bindTechnique(n,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays($i.MX.TRIANGLE_STRIP,0,4),i.setViewport(a.x,a.y,a.width,a.height),this._compositingPassParameters.color=m.getTexture(),t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(s,this.bindParameters,this._compositingPassParameters),i.screen.draw(),t.attachDepth(r),m.release(),t}_update(){const e=this.bindParameters.camera,t=(0,Pi.k)(e.eye),i=Math.sqrt(t),r=t-this._passParameters.radii[1]**2,n=(0,st.uZ)((i-this._passParameters.radii[0])/_i.sv.atmosphereHeight,0,1);(0,ec.s)(this._passParameters.heightParameters,i,t,r,n);const s=this.view.basemapTerrain?.getLowerBoundRadius()??0;(0,zi.t8)(this._passParameters.radii,s,s+_i.sv.atmosphereHeight),this._passParameters.innerFadeDistance=2*Math.sqrt((2*s-Gw.Tk)*Gw.Tk),this._passParameters.altitudeFade=(0,Gw.yx)(i-s)}};Kw=(0,r._)([(0,x.j)("esri.views.3d.environment.ChapmanAtmosphere")],Kw);var Qw=i(30418);class Jw extends Wi.A{constructor(e,t){super(e,t,new ji.J(Qw.C,(()=>i.e(56244).then(i.bind(i,56244)))))}initializePipeline(){return(0,Xi.sm)({blending:(0,Xi.wK)($i.zi.ONE,$i.zi.ZERO,$i.zi.SRC_ALPHA,$i.zi.ONE),depthTest:{func:$i.wb.LEQUAL},colorWrite:Xi.gf})}}let eC=class extends xr{constructor(e){super(e),this._planetRadius=(0,Ii.Iu)(e.view.spatialReference).radius}initialize(){this.techniques.precompile(Jw),this.addHandles([(0,_.YP)((()=>null!=this.view.environment.weather&&this.view.environment.atmosphereEnabled),(e=>e?this._enable():this._disable()),_.nn)])}destroy(){this._vao=(0,p.M2)(this._vao)}render(e){const t=e.find((({name:e})=>e===dr.CM.OPAQUE_ENVIRONMENT)),i=this.bindParameters.clouds;if(!i.data)return t;const r=this.techniques.get(Jw);if(!r.compiled)return this.requestRender(Cr.Xx.UPDATE),t;const n=this.renderingContext;this._vao??=(0,mb.ow)(n);const s=n.bindTechnique(r,this.bindParameters);return n.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao),n.drawArrays($i.MX.TRIANGLE_STRIP,0,4),i.isFading&&this.requestRender(Cr.Xx.UPDATE),t}};eC=(0,r._)([(0,x.j)("esri.views.3d.environment.CloudsComposition")],eC);var tC=i(16926);class iC extends Wi.A{constructor(e,t){super(e,t,new ji.J(tC.a,(()=>i.e(19479).then(i.bind(i,19479)))))}initializePipeline(){return(0,Xi.sm)({blending:(0,Xi.wK)($i.zi.SRC_ALPHA,$i.zi.ZERO,$i.zi.ONE_MINUS_SRC_ALPHA,$i.zi.ONE),colorWrite:Xi.gf})}}let rC=class extends Tr{constructor(e){super(e),this.requireGeometryDepth=!0,this._newParameters=new nC,this._oldParameters=new nC,this._fadedParameters=new nC,this._parameters=this._newParameters,this._passParameters=new tC.F;const t=(0,Ii.Iu)(e.view.spatialReference);this._planetRadius=t.radius,this._atmosphereRadius=t.radius+t.atmosphereHeight,e.view.stage?.renderView.techniques.precompile(iC)}toogle(){this.view.environment.atmosphereEnabled&&this.view.environment.weather?this._enable():this._disable()}initialize(){this.addHandles([(0,_.YP)((()=>this.view.environment.atmosphereEnabled),(()=>this.toogle()),_.tX),(0,_.YP)((()=>this.view.environment.weather),(()=>this.toogle()),_.tX),(0,_.YP)((()=>this._updateFogParameters()),(()=>{}),_.tX)]),this.addHandles((0,_.YP)((()=>this._fadeFactor),(e=>this._fade(e)),_.tX))}get _fadeFactor(){return this.view.stage?.renderer.renderContext.bind.clouds.fadeFactor??1}_fade(e){const{_newParameters:t,_oldParameters:i}=this;e>=1?(this._parameters=t,this._oldParameters.copyFrom(this._newParameters)):e<=0?this._parameters=i:(this._fadedParameters.lerp(i,t,e),this._parameters=this._fadedParameters)}_updateFogParameters(){const e=this.view.environment.weather,t="foggy"===e.type||"snowy"===e.type||"rainy"===e.type;this._newParameters.strength="foggy"===e.type?(0,st.t7)(3e-5,.005,e.fogStrength**3):"snowy"===e.type||"rainy"===e.type?(0,st.t7)(4e-6,2e-4,(e.precipitation??0)**3):0,this._newParameters.amount=t?1:0,"foggy"!==e.type&&"snowy"!==e.type||(0,Pi.c)(this._newParameters.color,lC),"rainy"===e.type&&(0,Pi.c)(this._newParameters.color,oC),this._fadeFactor>=1&&this._oldParameters.copyFrom(this._newParameters),this.requestRender(Cr.Xx.UPDATE)}render(e){const t=e.find((({name:e})=>e===dr.CM.TRANSPARENT_ENVIRONMENT));if(0===this._parameters.amount)return t;if(this._update(),this._passParameters.amount<=0)return t;const i=this.techniques.get(iC);if(!i.compiled)return this.requestRender(Cr.Xx.UPDATE),t;const r=this.renderingContext,n=t.getAttachment($i.Lu);return t.attachDepth(null),r.bindFramebuffer(t.fbo),r.bindTechnique(i,this.bindParameters,this._passParameters),r.screen.draw(),t.attachDepth(n),t}_update(){const e=this.bindParameters.camera;(0,Pi.n)(sC,e.eye);const t=Math.max(0,(0,Pi.e)(sC,this.bindParameters.lighting.mainLight.direction)),i=this._parameters.color;(0,Pi.g)(aC,i,.1),(0,Pi.m)(this._passParameters.color,aC,i,t);const r=(0,Pi.l)(e.eye);this._passParameters.atmosphereC=r**2-this._atmosphereRadius**2,this._passParameters.amount=(1-(0,st.CW)(.95*Dr.rm,1*Dr.rm,Math.abs(r-this._planetRadius)))*this._parameters.amount,this._passParameters.strength=this._parameters.strength}};rC=(0,r._)([(0,x.j)("esri.views.3d.environment.Fog")],rC);class nC{constructor(){this.color=(0,R.Ue)(),this.strength=0,this.amount=0}copyFrom(e){this.amount=e.amount,this.strength=e.strength,(0,Pi.c)(this.color,e.color)}lerp(e,t,i){this.amount=(0,st.t7)(e.amount,t.amount,i),this.strength=(0,st.t7)(e.strength,t.strength,i),(0,Pi.m)(this.color,e.color,t.color,i)}}const sC=(0,R.Ue)(),aC=(0,R.Ue)(),oC=(0,R.al)(.5,.5,.5),lC=(0,R.al)(1.5,1.5,1.5);var cC=i(66696),hC=i(35286);class uC extends Wi.A{constructor(e,t){super(e,t,new ji.J(cC.a,(()=>i.e(63495).then(i.bind(i,63495)))))}initializePipeline(e){const t=e.geometry===hC.n.Cylinder;return(0,Xi.sm)({blending:Xi.vf,culling:t?Xi.Rd:void 0,depthTest:{func:$i.wb.LEQUAL},colorWrite:Xi.gf})}}const dC=new Uint8ClampedArray([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,16,0,0,16,16,0,0,16,16,0,0,16,16,0,0,16,15,0,0,17,15,0,0,17,15,0,0,17,15,0,0,17,14,0,0,18,14,0,0,18,14,0,0,18,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,20,13,0,0,20,13,0,0,20,13,0,0,20,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,22,12,0,0,22,12,0,0,22,12,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,27,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,29,18,0,0,29,18,0,0,29,17,0,0,30,17,0,0,30,17,0,0,30,17,0,0,30,16,0,0,31,16,0,0,31,16,0,0,31,16,0,0,32,16,0,0,32,16,0,0,32,15,0,0,33,15,0,0,33,15,0,0,33,15,0,0,34,15,8,0,34,15,8,0,34,15,8,0,34,15,7,0,35,15,7,0,35,15,7,0,35,21,7,0,36,21,7,0,36,21,7,0,36,21,7,0,37,21,7,0,37,21,7,0,37,20,7,0,38,20,7,0,38,20,7,0,38,20,7,0,39,20,7,0,39,20,7,0,39,20,7,0,39,19,6,0,40,19,6,0,40,19,6,0,40,19,6,0,41,19,6,0,41,19,6,0,41,18,6,0,42,18,6,0,42,18,6,0,42,24,6,0,43,24,6,0,43,24,6,0,43,23,6,0,44,23,6,0,44,23,6,0,44,23,6,0,45,23,6,0,45,23,6,0,45,22,6,0,46,22,6,0,46,22,6,0,46,22,5,0,47,22,5,0,47,22,5,0,47,21,5,0,48,21,5,0,48,21,5,0,48,21,5,0,49,21,5,0,49,26,5,0,49,25,5,0,50,25,5,0,50,25,5,0,50,25,5,0,51,25,5,0,51,25,5,0,51,25,5,0,52,25,5,0,52,25,5,0,52,24,5,0,53,24,5,0,53,24,5,0,53,24,9,0,54,28,9,0,54,28,9,0,54,28,9,0,55,28,9,0,55,27,9,0,56,27,9,0,56,27,9,0,56,27,9,4,57,27,9,4,57,27,9,4,57,26,9,4,58,26,9,4,58,26,9,4,58,26,9,4,59,26,9,4,59,26,9,4,59,26,8,4,60,30,8,4,60,30,8,4,60,29,8,4,61,29,8,4,61,29,8,4,62,29,8,4,62,29,8,4,62,28,8,4,63,28,8,4,63,28,8,4,63,28,12,4,64,28,12,4,64,28,12,4,64,27,12,4,65,27,12,8,65,27,12,8,65,31,12,8,66,31,12,8,66,30,11,8,67,30,11,8,67,30,11,8,67,30,11,8,68,30,11,8,68,30,11,8,68,30,15,7,69,30,15,7,69,30,15,7,69,33,15,11,70,33,15,11,70,32,14,11,71,32,14,11,71,32,14,11,71,32,18,14,72,32,18,14,72,32,18,14,72,31,17,14,73,35,17,14,73,34,17,17,74,34,21,17,74,34,21,17,74,34,20,17,75,34,20,20,75,34,20,20,75,34,23,20,76,34,23,20,76,36,23,23,77,36,23,23,77,36,23,23,77,36,23,23,78,36,26,26,78,36,26,26,78,36,26,26,79,36,26,29,79,38,26,29,80,38,29,29,80,38,29,29,80,38,28,31,81,38,28,31,81,38,31,31,81,37,31,34,82,37,31,34,82,37,31,37,83,40,34,37,83,40,34,37,83,39,33,39,84,39,33,39,84,39,36,42,84,39,36,42,85,39,36,42,85,39,36,42,85,39,39,44,86,39,39,44,86,41,38,47,87,41,41,47,87,41,41,50,87,41,41,49,88,41,41,52,88,40,43,52,89,43,43,52,89,43,43,54,89,42,45,54,90,42,45,57,90,42,45,57,90,42,45,59,91,42,48,59,91,44,47,61,92,44,47,61,92,44,50,61,92,44,49,63,93,44,49,63,93,44,52,66,93,43,52,65,94,46,54,68,94,46,54,70,95,46,54,70,95,46,54,70,95,45,56,72,96,45,56,72,96,45,58,74,97,47,58,76,97,47,58,76,97,47,60,78,98,47,60,78,98,47,60,81,98,49,62,80,99,49,62,82,99,48,61,84,100,48,64,84,100,48,64,84,100,50,63,86,101,50,66,86,101,50,66,88,101,50,65,90,102,52,67,89,103,51,69,91,104,51,68,92,105,52,69,93,107,52,71,94,108,54,70,96,109,53,71,96,111,52,73,98,112,54,72,98,114,53,73,100,115,54,72,100,117,54,73,102,118,55,74,104,120,55,76,105,121,56,77,106,123,56,76,107,124,57,79,107,126,58,78,110,128,57,79,111,129,56,80,113,131,58,79,112,132,57,82,114,134,58,81,116,136,60,82,117,137,59,83,117,139,60,83,119,141,59,84,120,142,60,85,122,144,59,86,122,146,60,86,126,148,62,87,127,149,61,88,127,151,62,88,128,153,63,89,130,155,62,90,131,156,63,90,132,158,64,91,134,160,65,91,135,162,64,92,136,163,63,93,138,165,66,95,139,167,65,95,140,169,66,95,142,171,67,96,142,172,66,97,144,174,67,99,145,176,67,97,148,178,67,99,147,180,68,100,149,181,68,100,150,183,69,101,152,185,70,102,153,187,71,103,155,188,70,103,156,190,70,104,157,192,71,105,158,194,71,106,160,195,72,106,161,197,72,108,161,199,73,108,163,200,73,109,164,202,74,109,165,204,74,110,167,206,75,111,168,207,74,112,170,209,75,112,170,210,76,113,171,212,76,114,173,214,77,115,174,215,78,115,175,217,78,116,175,218,78,117,177,220,78,118,178,221,79,118,180,223,80,120,180,224,81,120,181,226,81,120,182,227,82,121,184,229,82,122,185,230,84,123,186,232,83,123,187,233,84,124,189,234,84,125,188,235,85,126,189,237,86,126,190,238,86,127,191,239,87,127,192,240,87,129,193,242,88,129,194,243,89,130,195,244,90,131,196,245,90,132,197,246,91,132,197,247,92,133,198,248,92,134,199,249,93,135,200,250,94,136,201,251,95,137,202,252,96,138,203,253,97,140,204,254,98,141,205,254,99,142,206,255,101,143,207,255,102,144,208,255,103,146,209,255,104,147,209,255,106,148,210,255,107,149,211,255,108,151,212,255,110,152,213,255,111,153,213,255,112,154,214,255,114,156,215,255,115,157,215,255,117,158,216,255,118,160,217,255,120,161,217,255,121,162,218,255,123,164,218,255,124,165,219,255,125,166,219,255,127,167,220,255,129,169,220,255,130,170,221,255,132,171,221,255,133,173,222,255,134,174,222,255,136,175,223,255,139,178,224,255,142,180,224,255,144,182,225,255,147,185,226,255,150,187,226,255,153,189,227,255,155,191,228,255,158,194,228,255,160,196,229,255,163,198,229,255,165,200,230,255,168,202,231,255,170,203,231,255,172,205,232,255,174,207,232,255,176,209,233,255,178,210,234,255,180,212,234,255,182,214,235,255,184,215,236,255,186,217,237,255,188,219,238,255,190,220,238,255,192,221,239,255,193,222,240,255,194,224,240,255,196,225,241,255,197,226,241,255,198,226,242,255,199,227,242,255,200,228,242,255,201,228,243,255,202,229,243,255,203,230,243,255,204,230,244,255,205,231,244,255,207,232,244,255,208,233,245,255,209,233,245,255,211,234,246,255,213,235,246,255,217,238,247,255,222,240,248,255,226,242,249,255,231,245,250,255,236,247,251,255,241,249,252,255,245,251,253,255,249,252,254,255,255,255,255,255]);var pC=i(86026);let mC=class extends xr{constructor(){super(...arguments),this._configuration=new hC.f,this._passParameters=new cC.S,this._vao=null,this._vaoCount=0}initialize(){this._configuration.geometry=hC.n.Cylinder,this.addHandles([(0,_.YP)((()=>this.view.environment.atmosphereEnabled),(e=>e?this._enable():this._disable()),_.nn)])}destroy(){this._passParameters.texture=(0,p.M2)(this._passParameters.texture),this._vao=(0,p.M2)(this._vao)}precompile(){this.techniques.precompile(uC,this._configuration)}render(e){const t=e.find((({name:e})=>e===dr.CM.OPAQUE_ENVIRONMENT)),i=this.techniques.get(uC,this._configuration);if(!i.compiled)return this.requestRender(Cr.Xx.UPDATE),t;const r=this.renderingContext;if(this._vao||(this._vao=function(e){const t=(0,pC.xu)(1,2,!1),{data:i,indices:r}=t[0][1],n=_C.createBuffer(r.length),s=n.position;for(let e=0;e<r.length;++e){const t=3*r[e%3==0?e+2:e%3==2?e-2:e];s.set(e,0,i[t]),s.set(e,1,i[t+1]),s.set(e,2,i[t+2])}return new Sr.U(e,Sd.i,new Map([["geometry",(0,vr.K)(_C)]]),new Map([["geometry",Mr.f.createVertex(e,$i.l1.STATIC_DRAW,n.buffer)]]))}(r),this._vaoCount=(0,Er._V)(this._vao,"geometry")),!this._passParameters.texture){const e=new ir.X;e.wrapMode=$i.e8.CLAMP_TO_EDGE,e.flipped=!0,e.width=1,e.height=512,this._passParameters.texture=new Ed.x(r,e,dC)}const n=r.bindTechnique(i,this.bindParameters,this._passParameters);return function(e,t){(0,Vi.JG)(e,t),e[12]=0,e[13]=0,e[14]=0,e[15]=1}(fC,this.bindParameters.camera.viewMatrix),n.setUniformMatrix4fv("view",fC),r.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao),r.drawArrays($i.MX.TRIANGLES,0,this._vaoCount),t}};mC=(0,r._)([(0,x.j)("esri.views.3d.environment.LocalAtmosphere")],mC);const fC=(0,Bi.Ue)(),_C=(0,br.U$)().vec3f(mr.T.POSITION);var gC=i(39909);const yC=new Uint8ClampedArray([0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,16,0,0,0,16,0,0,0,16,0,0,0,17,0,0,0,17,0,0,0,18,0,0,0,18,0,0,0,19,0,0,0,19,0,0,0,19,0,0,0,20,0,0,0,20,0,0,0,21,0,0,0,21,0,0,0,22,0,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,28,9,0,0,28,9,0,0,29,9,0,0,29,8,0,0,30,8,0,0,30,8,0,0,31,8,0,0,31,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,33,8,0,0,33,8,0,0,34,7,0,0,35,7,0,0,35,7,0,0,36,7,0,0,36,7,7,0,37,7,7,0,37,7,7,0,38,7,7,0,38,13,7,0,39,13,7,0,39,13,6,0,40,13,6,0,40,12,6,0,41,12,6,0,41,12,6,0,41,12,6,0,42,12,6,0,42,12,6,0,43,12,6,0,43,12,6,0,44,12,6,0,44,11,6,0,45,11,6,6,45,11,6,6,46,11,5,5,47,11,5,5,47,11,5,5,48,11,5,5,48,10,5,5,49,10,5,5,49,10,5,5,50,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,52,15,5,5,52,14,5,5,53,14,5,5,54,14,5,5,54,14,5,5,55,14,5,5,55,14,5,5,56,13,4,4,57,13,4,4,57,13,4,4,58,13,4,4,58,13,4,4,59,13,4,4,59,17,4,4,60,17,4,4,60,17,4,4,60,17,4,4,61,17,4,4,61,16,4,4,62,16,4,4,63,16,4,4,63,16,8,4,64,16,8,4,64,16,8,4,65,15,8,4,66,15,8,4,66,15,8,4,67,19,8,4,68,19,8,4,68,18,7,4,69,18,7,4,69,18,7,4,69,18,7,4,70,18,7,4,70,18,7,4,71,18,7,4,71,18,7,4,72,17,7,3,73,17,7,3,73,21,7,3,74,21,7,3,74,20,7,3,75,20,7,3,76,20,7,3,76,20,7,3,77,20,7,3,77,20,7,3,78,20,7,3,78,20,7,7,78,19,6,6,79,19,10,6,80,19,10,6,80,22,9,6,81,22,9,6,81,22,9,6,82,22,9,6,83,22,9,6,83,21,9,6,84,21,9,6,84,21,9,6,85,21,9,6,86,21,9,6,86,23,9,6,87,23,9,6,87,23,9,6,87,23,9,6,88,23,9,6,88,23,9,6,89,23,8,6,90,23,8,6,90,22,8,6,91,22,8,6,91,25,8,6,92,25,8,5,93,25,8,5,93,24,8,5,94,24,8,5,94,24,11,5,95,24,11,5,96,24,11,5,96,26,11,5,97,26,11,5,97,26,11,5,97,26,10,5,98,26,10,5,98,26,10,5,99,25,10,5,100,25,10,5,100,25,10,5,101,25,10,5,101,25,10,5,102,27,10,5,103,27,10,5,103,27,10,5,104,27,10,5,104,27,12,5,105,26,12,5,106,26,12,5,106,29,12,5,106,29,12,5,106,29,12,7,107,28,12,7,108,28,12,7,108,28,12,7,109,28,12,7,109,30,12,7,110,30,11,7,111,30,11,7,111,30,11,7,112,30,11,7,112,29,11,7,113,29,11,7,114,29,11,7,114,31,11,7,115,31,11,7,115,31,11,7,115,31,11,7,116,31,11,7,116,33,13,7,117,33,13,9,117,32,13,9,118,32,13,9,118,32,13,9,119,34,15,8,120,34,15,8,120,34,15,8,121,36,15,8,121,36,15,8,122,36,15,8,122,35,15,8,123,37,14,8,124,37,14,8,124,37,14,8,124,37,14,8,124,39,14,8,125,39,16,8,125,38,16,8,126,38,16,8,127,38,16,8,127,40,16,10,128,40,16,10,128,40,16,10,129,42,18,10,129,41,18,10,130,41,18,10,130,43,18,10,131,43,18,10,131,42,17,10,132,42,17,12,132,42,17,12,133,44,17,12,133,44,17,12,133,46,17,11,134,46,17,11,134,45,19,11,135,45,19,11,135,47,19,11,136,47,19,11,136,47,19,11,137,47,19,11,137,48,20,11,138,48,20,11,138,50,20,13,139,50,20,13,139,49,20,13,140,49,22,13,140,51,22,13,141,51,22,13,141,50,22,13,142,52,22,13,142,52,21,12,143,53,21,12,143,53,21,12,143,53,21,12,143,53,21,14,144,53,23,14,144,55,23,14,145,55,23,14,145,56,23,14,146,56,23,14,146,57,24,14,147,57,24,14,147,59,24,16,148,59,24,16,148,58,24,15,149,58,26,15,149,58,26,15,149,60,26,15,150,60,26,15,150,61,25,15,151,61,25,15,151,62,25,17,152,62,25,17,152,64,25,17,152,64,27,17,152,63,27,17,153,63,27,17,153,65,27,17,153,66,28,17,154,66,28,17,154,67,28,16,155,67,28,16,155,67,30,16,155,69,29,18,156,69,29,18,156,68,29,18,157,70,29,18,157,70,29,18,157,71,31,18,158,71,31,18,158,72,30,19,159,72,30,19,159,74,30,19,159,73,30,19,160,73,32,19,160,74,32,19,161,74,32,21,161,76,32,21,161,78,33,21,161,78,33,21,161,79,35,20,162,78,34,20,163,79,34,22,164,81,36,22,164,82,36,22,165,81,35,22,166,82,37,21,167,84,37,21,167,85,36,21,168,86,38,23,169,88,38,23,169,88,38,23,170,88,39,23,170,89,39,24,171,91,40,24,171,92,40,24,172,93,40,24,173,94,41,25,173,95,41,25,174,96,42,25,175,98,42,25,175,99,43,26,176,99,43,26,177,101,45,26,177,102,44,26,178,103,46,27,179,104,46,27,179,105,46,27,179,106,45,28,180,108,47,28,180,108,46,28,181,109,48,28,182,111,48,29,182,111,49,29,183,114,49,29,184,114,50,30,184,114,50,30,185,116,51,30,185,117,51,30,186,119,52,31,187,119,53,31,187,121,53,31,188,122,54,33,188,123,54,32,189,124,55,32,189,125,55,32,189,126,56,34,190,128,56,34,190,128,57,33,191,130,57,33,191,131,58,35,192,131,58,35,192,133,59,34,193,134,60,35,194,135,60,35,194,136,61,37,195,139,61,37,195,139,62,36,196,141,62,36,196,141,63,38,197,142,63,38,197,143,64,39,198,144,64,39,198,146,66,39,198,146,67,39,198,147,67,38,199,147,68,40,199,149,68,40,200,150,69,40,200,152,70,41,201,154,71,41,201,154,71,42,202,155,72,42,202,156,73,41,203,157,73,43,203,158,74,42,204,160,75,44,204,161,76,44,204,162,77,44,205,164,77,45,205,165,78,45,206,166,79,45,206,168,80,46,207,169,81,46,207,170,83,47,207,171,83,47,207,172,83,47,207,174,85,48,208,175,85,48,208,177,85,48,209,178,87,49,209,180,87,49,210,181,87,49,210,182,89,50,210,182,89,50,211,185,91,50,211,186,91,51,212,186,93,51,212,189,94,52,212,190,95,51,213,192,96,51,213,193,96,53,213,194,97,52,214,195,98,54,214,197,98,55,215,198,100,55,215,199,101,55,215,200,102,55,216,202,103,55,216,203,104,55,216,204,105,57,216,205,106,57,216,207,107,58,216,208,108,58,217,209,109,59,217,210,110,60,217,211,111,60,218,212,112,61,218,213,113,61,218,214,114,62,219,217,115,63,219,217,116,64,219,218,118,64,220,219,119,65,220,220,121,66,220,222,121,67,221,222,122,67,221,222,123,68,221,223,124,69,222,224,125,70,222,225,127,71,222,226,128,72,223,228,129,73,223,228,130,74,223,229,132,75,223,230,135,79,224,231,138,81,224,233,141,84,224,233,144,87,225,235,147,91,225,236,150,94,225,237,154,97,225,238,158,102,225,239,161,107,225,239,165,110,225,240,168,114,226,241,172,118,226,241,176,122,226,241,181,126,226,242,183,130,227,243,186,135,227,243,190,139,227,244,194,143,227,244,197,147,228,244,200,150,228,245,204,154,228,245,207,157,228,245,210,161,229,246,212,164,229,246,215,167,229,246,217,169,229,246,220,172,230,247,221,174,230]),vC=128,bC=-1e4,wC=(0,gi.uV)([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);let CC=class extends xr{constructor(e){super(e),this._passParameters=new cC.S,this._configuration=new hC.f,this._vao=null,this._vaoCount=0,this._fadeVao=null,this._fadeVaoCount=0,this._texV1=1;const t=e.view,i=(0,Ii.Iu)(t.spatialReference),{outerAtmosphereRimWidth:r,radius:n}=i;this._planetRadius=n,this._innerRimFactor=1+bC/n,this._middleRimFactor=1+0/n,this._outerRimFactor=1+r/n,this._texV0=0/r,this._texVScale=this._texV1-this._texV0;const s=t.stage.renderView.techniques;s.precompile(uC,this._configuration),this._configuration.geometry=hC.n.Underground,s.precompile(uC,this._configuration)}initialize(){this.addHandles((0,_.YP)((()=>this.view.environment.atmosphereEnabled),(e=>e?this._enable():this._disable()),_.nn))}destroy(){this._passParameters.texture=(0,p.M2)(this._passParameters.texture),this._fadeVao=(0,p.M2)(this._fadeVao),this._vao=(0,p.M2)(this._vao)}render(e){const t=e.find((({name:e})=>e===dr.CM.OPAQUE_ENVIRONMENT));this._update();const i=this.renderingContext;if(!this._passParameters.texture){const e=new ir.X;e.wrapMode=$i.e8.CLAMP_TO_EDGE,e.flipped=!0,e.width=1,e.height=512,this._passParameters.texture=new Ed.x(i,e,yC)}if(this._passParameters.undergroundFadeAlpha<1){this._vao||(this._vao=this._createRibbon(i),this._vaoCount=(0,Er._V)(this._vao,"geometry")),this._configuration.geometry=hC.n.Cone;const e=this.techniques.get(uC,this._configuration);if(!e.compiled)return this.requestRender(Cr.Xx.UPDATE),t;i.bindTechnique(e,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays($i.MX.TRIANGLES,0,this._vaoCount)}if(this._passParameters.undergroundFadeAlpha>0){this._fadeVao||(this._fadeVao=(0,mb.ow)(i),this._fadeVaoCount=(0,Er._V)(this._fadeVao,"geometry")),this._configuration.geometry=hC.n.Underground;const e=this.techniques.get(uC,this._configuration);if(!e.compiled)return this.requestRender(Cr.Xx.UPDATE),t;i.bindTechnique(e,this.bindParameters,this._passParameters),i.bindVAO(this._fadeVao),i.drawArrays($i.MX.TRIANGLE_STRIP,0,this._fadeVaoCount)}return t}_update(){const e=this.bindParameters.camera,t=(0,R.Ue)(),i=this._planetRadius,r=(0,Pi.l)(e.eye),n=r-i;if(n<0){const e=Math.min(-n/5e3,1);this._passParameters.undergroundFadeAlpha=e}else this._passParameters.undergroundFadeAlpha=0;const s=Math.max(50,n),a=i+bC;this._passParameters.innerScale=function(e,t,i){return e*e/(Math.sqrt(e*e-t*t)*Math.sqrt(e*e-i*i)+t*i)}(i+s,i,a)-1,this._passParameters.altitudeFade=(0,Gw.yx)(n),(0,Pi.g)(t,e.eye,(i+50)/r),xC(t,e.center,e.up,i,this._passParameters.silhouette);const o=this._computeScreenRimWidth(e,t,e.up,this._passParameters.silhouette),l=1-511/512,c=wC(n);let h=this._texV0+l*this._texVScale,u=this._texV0+o*c*this._texVScale;if(n>50){xC(e.eye,e.center,e.up,i,this._passParameters.silhouette);const t=this._computeScreenRimWidth(e,e.eye,e.up,this._passParameters.silhouette),r=(0,st.uZ)((t-1.5)/(o-1.5),0,1);h=this._texV0+r*l*this._texVScale,u=this._texV0+(0,st.t7)(this._texV1,o*c,r)*this._texVScale}(0,zi.t8)(this._passParameters.texV,h,u)}_createRibbon(e){const t=(0,gC.xx)(1155),i=new Uint32Array(1920);t[0]=0,t[1]=0,t[2]=-1;for(let e=0;e<vC;e++){const r=9*e+3;t[r]=e,t[r+1]=this._innerRimFactor,t[r+2]=-1,t[r+3]=e,t[r+4]=this._middleRimFactor,t[r+5]=0,t[r+6]=e,t[r+7]=this._outerRimFactor,t[r+8]=1;const n=3*e+1,s=127===e?1:n+3,a=15*e;i[a]=n,i[a+1]=n+1,i[a+2]=s+1,i[a+3]=s+1,i[a+4]=s,i[a+5]=n,i[a+6]=n+1,i[a+7]=n+2,i[a+8]=s+2,i[a+9]=s+2,i[a+10]=s+1,i[a+11]=n+1,i[a+12]=n,i[a+13]=s,i[a+14]=0}const r=EC.createBuffer(i.length),n=r.position;for(let e=0;e<i.length;++e){const r=3*i[e];n.set(e,0,t[r]),n.set(e,1,t[r+1]),n.set(e,2,t[r+2])}return new Sr.U(e,Sd.i,new Map([["geometry",(0,vr.K)(EC)]]),new Map([["geometry",Mr.f.createVertex(e,$i.l1.STATIC_DRAW,r.buffer)]]))}_computeScreenRimWidth(e,t,i,r){return(0,Pi.f)(SC,r.center,r.v2),(0,Pi.g)(MC,SC,this._outerRimFactor),(0,Vi.zB)(TC,t,SC,i),(0,Mf.iV)(SC,TC,e.projectionMatrix,e.viewport,SC),(0,Mf.iV)(MC,TC,e.projectionMatrix,e.viewport,MC),(0,Pi.j)(SC,MC)/e.height}};function xC(e,t,i,r,n){const s=(0,Pi.l)(e),a=r*Math.sqrt(s*s-r*r)/s,o=Math.sqrt(r*r-a*a),l=n.v1,c=n.v2;return(0,Pi.g)(n.center,e,o/s),(0,Pi.h)(l,e,t),(0,Pi.k)(l)<1&&(0,Pi.h)(l,e,i),(0,Pi.g)(l,l,a/(0,Pi.l)(l)),(0,Pi.h)(c,l,e),(0,Pi.g)(c,c,a/(0,Pi.l)(c)),a}CC=(0,r._)([(0,x.j)("esri.views.3d.environment.MarsAtmosphere")],CC);const TC=(0,Bi.Ue)(),SC=(0,R.Ue)(),MC=(0,R.Ue)();const EC=(0,br.U$)().vec3f(mr.T.POSITION),PC=CC;var RC=i(38766),AC=i(2875),OC=i(32222),DC=i(72432),IC=i(78986);class LC{constructor(e){this._totalCount=e,this._componentCountCache=-1,this._indexRanges=[0,e]}allVisible(){return this.componentCount===this._totalCount}allInvisible(){return 0===this._indexRanges.length}isVisible(e){if(e<0||e>=this._totalCount)return!1;if(this.allVisible())return!0;const t=this._indexRanges;let i=0,r=t.length/2;if(e<t[2*i]||e>t[2*r]+t[2*r+1])return!1;for(;r-i>0;){const n=Math.floor(.5*(i+r)),s=t[2*n];if(e<s){if(r-i==1)return!1;r=n}else{if(e<s+t[2*n+1])return!0;if(r-i==1)return!1;i=n+1}}return!1}get componentCount(){if(-1===this._componentCountCache){const e=this._indexRanges;let t=0;for(let i=0;i<e.length;i+=2)t+=e[i+1];this._componentCountCache=t}return this._componentCountCache}reset(e){"all"===e||e.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=function(e){const t=new Array;if(0===e.length)return t;let i=e[0],r=1;for(let n=1;n<e.length;n++){const s=e[n];i+r===s?r+=1:(t.push(i),t.push(r),i=s,r=1)}return t.push(i),t.push(r),t}(e),this._componentCountCache=-1}forEachComponent(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const r=t[i],n=r+t[i+1];for(let t=r;t<n;t++)if(!e(t))return!1}return!0}forEachComponentRange(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const r=t[i];if(!e(r,r+t[i+1]))return!1}return!0}computeOffsetRanges(e){const t=new Array(this._indexRanges.length),i=this._indexRanges;for(let r=0;r<i.length;r+=2){const n=i[r],s=n+i[r+1],a=e[n],o=e[s];t[r]=a,t[r+1]=o-a}return t}}class NC{constructor(e,t){this.offsets=t,this._highlightsInOrder=[],this.pickability=null,this.componentHighlights=new Map,this.verticalOffsets=null,this._cachedGeometryRanges=null,this._cachedHighlightRangesMap=null,this._cachedShadowmapRanges=null;const i=this.count;this.visibility=new LC(i),this.materialDataBuffer=e.getBuffer(i),this.materialDataIndices=new Uint16Array(i);for(let e=0;e<i;e++)this.materialDataIndices[e]=this.materialDataBuffer.acquireIndex()}destroy(){for(let e=0;e<this.count;e++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[e])}get count(){return this.offsets.length-1}get geometryRanges(){return null==this._cachedGeometryRanges&&(this._cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this._cachedGeometryRanges}get highlightRangesMap(){return 0===this.componentHighlights.size?null:(this._updateCachedHighlightRanges(),this._cachedHighlightRangesMap)}get shadowmapRanges(){return 0===this.componentHighlights.size?this.geometryRanges:(this._updateCachedHighlightRanges(),this._cachedShadowmapRanges)}markHighlightsDirty(){this._cachedHighlightRangesMap=null,this._cachedShadowmapRanges=null}markVisibilityDirty(){this._cachedGeometryRanges=null,this.markHighlightsDirty()}updateHighlights(e){this._updateHighlightOrder(e)&&(this.markHighlightsDirty(),this._updateCachedHighlightRanges())}_updateHighlightOrder(e){const{_highlightsInOrder:t}=this;let i=t.length!==e.length;t.length=Math.min(e.length,8);for(let r=0;r<e.length;++r){const n=e.at(r).name;t.length<r?(i=!0,t.push(n)):t[r]!==n&&(t[r]=n,i=!0)}return i}_updateCachedHighlightRanges(){if(null==this._cachedHighlightRangesMap||null==this._cachedShadowmapRanges){const{highlightRangesMap:e,shadowmapRangesMap:t}=function(e,t,i,r){const n=new Map,s=[];if(e.size>0){let a=i.length;t.forEachComponent((t=>{let o=!1;for(let s=r.length-1;s>=0;--s){const a=r[s];if((e.get(a)?.[t]??0)>0){const e=(0,Ue.s1)(n,a,(()=>[])),r=i[t],s=i[t+1];e.push(r),e.push(s-r),o||=a===gt.b;break}}return o||(a!==t-1&&(s.length>0&&s.push(i[a+1]-s[s.length-1]),s.push(i[t])),a=t),!0})),s.length>0&&s.push(i[a+1]-s[s.length-1])}return{highlightRangesMap:n,shadowmapRangesMap:s}}(this.componentHighlights,this.visibility,this.offsets,this._highlightsInOrder);this._cachedHighlightRangesMap=e,this._cachedShadowmapRanges=t}}}class FC{constructor(e,t,i,r,n,s){this.transform=e,this.toMapSpace=t,this.obb=i,this.componentData=r,this.renderable=n,this.intersectionGeometry=s,this.visible=!1,this.offsetObb=null}destroy(){this.intersectionGeometry=(0,p.SC)(this.intersectionGeometry),this.renderable=(0,p.SC)(this.renderable),this.componentData=(0,p.SC)(this.componentData)}}function UC(e,t){return new(function(e){return e<128?Uint8Array:e<32768?Uint16Array:e<1<<31?Uint32Array:Array}(e))(t)}class HC{constructor(e,t){this.elementCount=e,this.model=t,this._elementIndexMap=null,this._bspNodes=[],this._generatedBVH=!1,this.localMode=t.localMode,this.planetCenterZ=t.planetCenterZ,this.geometryMinZ=t.geometryMinZ,this.planetCenter=(0,R.al)(0,0,this.planetCenterZ),this.maxBspNodeDepth=t.maxBspNodeDepth??8,this.minElementCountForBVH=t.minElementCountForBVH??15,this.minBspNodeElementCount=t.minBspNodeElementCount??5}get elementIndexMap(){return this._ensureBVH(),this._elementIndexMap}get _skipBVH(){return this.elementCount<this.minElementCountForBVH||this.geometryMinZ<.5*this.planetCenterZ}_ensureBVH(){this._generatedBVH||this._skipBVH||0===this._bspNodes.length&&this._generateBsp()}intersectRay(e,t,i){this.elementCount<1||(this._skipBVH?this._intersectRayWithoutBVH(i):this._intersectRayWithBVH(e,t,i))}_intersectRayWithoutBVH(e){this._intersectRange(0,this.elementCount)}_intersectRange(e,t){this.model.intersectRange(e,t)}_intersectRayWithBVH(e,t,i){this._ensureBVH(),i?this._intersectGeometryWithBVHVerticalRay(e):this._intersectGeometryWithBVHGeneralRay(e,t)}_intersectGeometryWithBVHVerticalRay(e){let t=e[0],i=e[1];if(!this.localMode){const{geometryMinZ:r,planetCenterZ:n}=this,s=(r-n)/(e[2]-n);t=e[0]*s,i=e[1]*s}const{_bspNodes:r}=this;let n=0;for(;n>=0;){const e=r[n],{d:s,dim:a,minIndexIndex:o,minMidIndexIndex:l,maxMidIndexIndex:c,maxIndexIndex:h,aabb2D:u}=e;if(t<u[0]||t>u[2]||i<u[1]||i>u[3])break;if(-1===a||-1===e.child0&&-1===e.child1){this._intersectRange(o,h);break}{this._intersectRange(l,c);const r=(0===a?t:i)-s;if(r<0){if(-1===e.child0){this._intersectRange(o,l);break}n=e.child0}else{if(!(r>0))break;if(-1===e.child1){this._intersectRange(c,h);break}n=e.child1}}}}_intersectGeometryWithBVHGeneralRay(e,t){let i=e[0],r=e[1],n=t[0],s=t[1];const{geometryMinZ:a}=this;if(!this.localMode){let o=0,l=1;const c=Math.min(.5*this.planetCenterZ,a),h=e[2],u=t[2];if(h<c&&u<c)return;if(h<c&&(o=(c-h)/(u-h)),u<c&&(l=(c-h)/(u-h)),o>l)return;const d=(1-o)*e[0]+o*t[0],p=(1-o)*e[1]+o*t[1],m=(1-o)*e[2]+o*t[2],f=(1-l)*e[0]+l*t[0],_=(1-l)*e[1]+l*t[1],g=(1-l)*e[2]+l*t[2],{planetCenterZ:y}=this,v=a-y,b=v/(m-y);i=d*b,r=p*b;const w=v/(g-y);n=f*w,s=_*w}const o=n-i,l=s-r,c=this._bspNodes;let h=1;{const{aabb2D:e}=c[0],t=(e,t,i,r)=>{if(Math.abs(t)<1e-5*Math.max(r-i,1))return!1;const n=t>0,s=n?r:i,a=e+h*t;return(n?a<s:a>s)&&(h=Math.max((s-e)/t,h),!0)},n=()=>t(i,o,e[0],e[2]),s=()=>t(r,l,e[1],e[3]);Math.abs(o)>=Math.abs(l)?n()||s():s()||n()}const u=[0,0,h];let d=0;for(;d<u.length;){const e=u[d];let t=u[d+1],n=u[d+2];if(d+=3,t>n)continue;const s=c[e],{minIndexIndex:a,maxIndexIndex:p}=s,{child0:m,child1:f,minMidIndexIndex:_,maxMidIndexIndex:g,aabb2D:y,d:v,dim:b}=s;{const e=i+t*o,r=i+n*o,s=Math.min(e,r),a=Math.max(e,r),l=y[0],c=y[2];if(a<l||c<s)continue;if(s<l){const e=(l-i)/o;o>0?t=Math.max(t,e):n=Math.min(n,e)}if(c<a){const e=(c-i)/o;o>0?n=Math.min(n,e):t=Math.max(t,e)}}{const e=r+t*l,i=r+n*l,s=Math.min(e,i),a=Math.max(e,i),o=y[1],c=y[3];if(a<o||c<s)continue;if(s<o){const e=(o-r)/l;l>0?t=Math.max(t,e):n=Math.min(n,e)}if(c<a){const e=(c-r)/l;l>0?n=Math.min(n,e):t=Math.max(t,e)}}if(-1===m&&-1===f)this._intersectRange(a,p);else{const e=0===b?i:r,s=0===b?o:l,c=e+t*s,d=e+n*s,y=Math.min(c,d),w=Math.max(c,d),C=(0,st.uZ)((v-e)/s,0,h);a<_&&y<=v&&(-1!==m?(u.push(m),u.push(s>=0?t:Math.max(t,C)),u.push(s>=0?Math.min(n,C):n)):this._intersectRange(a,_)),this._intersectRange(_,g),g<p&&v<=w&&(-1!==f?(u.push(f),u.push(s>=0?Math.max(t,C):t),u.push(s>=0?n:Math.min(n,C))):this._intersectRange(g,p))}}}_generateBsp(){const{elementCount:e}=this;if(e<1)return;const t=UC(e,e);this._elementIndexMap=t;for(let i=0;i<e;++i)t[i]=i;const i=this.model.getAabbs2D();let r=0;const n=this._bspNodes;n.length=0;const{localMode:s}=this;let a=!1;if(!s){const{planetCenterZ:e,geometryMinZ:t}=this;a=e>=0||t<.5*e}const o=[],l=(e,t,i,r,n)=>{o.push(e),o.push(t),o.push(i),o.push(r<0?-1:(n?0:1)+2*r)},{maxBspNodeDepth:c,minBspNodeElementCount:h}=this,u=(e,r,o,u,d)=>{const p=n.length;if(p>0&&(a||o>=c||r-e<h))return;const m=(0,H.Ue)();!function(e,t,i,r,n){let s=1/0,a=1/0,o=-1/0,l=-1/0;for(let e=t;e<i;++e){const t=4*r[e];s=Math.min(s,n[t+0]),a=Math.min(a,n[t+1]),o=Math.max(o,n[t+2]),l=Math.max(l,n[t+3])}e[0]=s,e[1]=a,e[2]=o,e[3]=l}(m,e,r,t,i);const{d:f,dim:_}=s?function(e){const t=e[0],i=e[1],r=e[2],n=e[3];let s,a;return r-t>=n-i?(a=.5*(t+r),s=0):(a=.5*(i+n),s=1),{d:a,dim:s}}(m):function(e){const t=e[0],i=e[1],r=e[2],n=e[3];let s,a;return r-t>=n-i?(s=0,a=.5*(t+r)):(s=1,a=.5*(i+n)),{dim:s,d:a}}(m),{rangeMidStart:g,rangeMidEnd:y}=function(e,t,i,r,n,s){let a=e;{let e=t;for(;a<e;){const t=n[a];kC(t,i,r,s)<0?++a:(--e,n[a]=n[e],n[e]=t)}}const o=a;let l=a,c=t;for(;l<c;){const e=n[c-1];kC(e,i,r,s)>0?--c:(n[c-1]=n[l],n[l]=e,++l)}return{rangeMidStart:o,rangeMidEnd:c}}(e,r,_,f,t,i),v=o===c-1,b=!v&&g>=e+h,w=!v&&r>=y+h;if(b||w||0===p){const t=new VC(e,g,y,r,_,f,m);if(b&&l(e,g,o+1,p,!0),w&&l(y,r,o+1,p,!1),n.push(t),-1!==u){const e=n[u];d?e.child0=p:e.child1=p}}};for(l(0,e,0,-1,!1);r<o.length;){const e=o[r],t=o[r+1],i=o[r+2],n=o[r+3];r+=4;const s=n>>1;u(e,t,i,s,n-(s<<1)==0)}this._generatedBVH=!0}}function kC(e,t,i,r){const n=4*e,s=r[n+0+t];return r[n+2+t]<i?-1:s>i?1:0}class VC{constructor(e,t,i,r,n,s,a){this.minIndexIndex=e,this.minMidIndexIndex=t,this.maxMidIndexIndex=i,this.maxIndexIndex=r,this.dim=n,this.d=s,this.aabb2D=a,this.child0=-1,this.child1=-1}}class BC{constructor(e,t,i,r,n,s,a,o,l){this.componentIndex=e,this.vertexData=t,this.vertexStride=i,this.indexData=r,this.startTriangleNumber=n,this.endTriangleNumber=s,this.geometryMinZ=a,this.planetCenterZ=o,this.localMode=l,this.maxBspNodeDepth=8,this.minElementCountForBVH=20,this.minBspNodeElementCount=10,this.rayDirection=(0,R.Ue)(),this.ray0=(0,R.Ue)(),this.isVerticalRay=!1,this._triangleHitCallback=GC,this.totalElevationOffset=0,this.normalRequired=!1,this._bvh=new HC(s-n,this)}getAabbs2D(){return this.localMode?function(e,t,i,r,n){const s=t-e,a=new Float64Array(4*s);for(let t=0;t<s;++t){const s=3*(t+e),o=n*i[s+0],l=r[o+0],c=r[o+1],h=n*i[s+1],u=r[h+0],d=r[h+1],p=n*i[s+2],m=r[p+0],f=r[p+1],_=4*t;a[_+0]=Math.min(l,u,m),a[_+1]=Math.min(c,d,f),a[_+2]=Math.max(l,u,m),a[_+3]=Math.max(c,d,f)}return a}(this.startTriangleNumber,this.endTriangleNumber,this.indexData,this.vertexData,this.vertexStride):function(e,t,i,r,n,s,a){const o=s-a,l=t-e,c=new Float64Array(4*l);for(let t=0;t<l;++t){const s=3*(t+e),l=n*i[s+0],h=r[l+0],u=r[l+1],d=o/(r[l+2]-a),p=h*d,m=u*d,f=n*i[s+1],_=r[f+0],g=r[f+1],y=o/(r[f+2]-a),v=_*y,b=g*y,w=n*i[s+2],C=r[w+0],x=r[w+1],T=o/(r[w+2]-a),S=C*T,M=x*T,E=4*t;c[E+0]=Math.min(p,v,S),c[E+1]=Math.min(m,b,M),c[E+2]=Math.max(p,v,S),c[E+3]=Math.max(m,b,M)}return c}(this.startTriangleNumber,this.endTriangleNumber,this.indexData,this.vertexData,this.vertexStride,this.geometryMinZ,this.planetCenterZ)}get numTriangles(){return this.endTriangleNumber-this.startTriangleNumber}intersectRay(e,t,i,r,n,s){(0,Pi.c)(this.ray0,e),(0,Pi.a)(this.rayDirection,t,e),this.isVerticalRay=i,this.totalElevationOffset=r,this.normalRequired=s,this._triangleHitCallback=n,this._bvh.intersectRay(e,t,i),this._triangleHitCallback=GC}intersectRange(e,t){const i=this._bvh.elementIndexMap;zC(this.ray0,this.rayDirection,e,t,this.indexData,this.vertexData,this.vertexStride,this.totalElevationOffset,this.planetCenterZ,this.normalRequired,this._triangleHitCallback,i,this.startTriangleNumber)}getTriangleElevationOffset(e){return this.totalElevationOffset}}function zC(e,t,i,r,n,s,a,o,l,c,h,u=null,d=0){0!==o?(0,ev.ko)(e,t,i,r,n,s,a,o,l,c,h,u,d):(0,ev.ET)(e,t,i,r,n,s,a,c,h,u,d)}function GC(){}function qC(e,t,i){const r=e.count;if(t>=r)return;e.pickability??=new Uint32Array(0);let n=e.pickability;const s=jC(n),a=t/s|0,o=t-s*a,l=(r-1)/s|0,c=n;if(!(t<c.length*s||i)){const t=a+1,i=Math.ceil(c.length*Fe._x),r=l+1;let s=Math.max(t,i);s=Math.min(s,r),e.pickability=n=new Uint32Array(s),n.set(c)}a<n.length&&(n[a]=function(e,t,i){return e&~(1<<t)|(i?1:0)<<t}(n[a],o,!i))}function ZC(e,t){if(null==e)return!0;const i=jC(e);return!(t<e.length*i)||function(e,t,i){const r=t/i|0,n=t-r*i;return!function(e,t){return!!(e&1<<t)}(e[r],n)}(e,t,i)}function jC(e){return 8*e.BYTES_PER_ELEMENT}class WC{constructor(e,t,i,r,n,s,a,o){this.vertexData=e,this.vertexStride=t,this.indexData=i,this._components=r,this._componentAabbs3D=n,this.geometryMinZ=s,this.planetCenterZ=a,this.localMode=o,this.maxBspNodeDepth=6,this.minElementCountForBVH=10,this.minBspNodeElementCount=3,this._ray0=KC,this._ray1=QC,this._invDir=(0,R.Ue)(),this._componentVerticalOffsets=null,this._verticalOffset=null,this._tolerance=0,this._intersectionOptions=ex,this._callback=JC,this.rayDirectionC=(0,R.Ue)(),this._componentIndexMap=null,this._bvh=new HC(r.count,this),this.componentIntersectionData=new Array(r.count)}get numComponents(){return this._components.count}get minZGlobal(){return this.geometryMinZ-this.planetCenterZ}getAabbs2D(){return this.localMode?this.getAabbs2DLocal():this.getAabbs2DGlobal()}getAabbs2DGlobal(){const{numComponents:e,planetCenterZ:t,minZGlobal:i}=this,r=(0,av.bg)(4*e),n=this._componentAabbs3D;for(let s=0;s<e;++s){const e=6*s,a=n[e+0],o=n[e+1],l=n[e+2],c=n[e+3],h=n[e+4],u=i/(l-t),d=i/(n[e+5]-t),p=Math.min(a*u,a*d),m=Math.min(o*u,o*d),f=Math.max(c*u,c*d),_=Math.max(h*u,h*d),g=4*s;r[g+0]=p,r[g+1]=m,r[g+2]=f,r[g+3]=_}return r}getAabbs2DLocal(){const{numComponents:e}=this,t=(0,av.bg)(4*e),i=this._componentAabbs3D;for(let r=0;r<e;++r){const e=6*r,n=i[e+0],s=i[e+1],a=i[e+3],o=i[e+4],l=4*r;t[l+0]=n,t[l+1]=s,t[l+2]=a,t[l+3]=o}return t}intersectRay(e,t,i,r,n,s,a){const{isVerticalRay:o}=a;this._ray0=e,this._ray1=t,this._componentVerticalOffsets=i,this._verticalOffset=r,this._tolerance=s,this._intersectionOptions=a,this._componentIndexMap=this._bvh.elementIndexMap,(0,ev.Ue)(e,t,this._invDir),this._callback=n,this._bvh.intersectRay(e,t,o),this._callback=JC}intersectRange(e,t){const i=this._componentIndexMap,{pickability:r,visibility:n}=this._components;for(let s=e;s<t;++s){const e=i?i[s]:s;ZC(r,e)&&n.isVisible(e)&&this._intersectComponent(e)}}getComponentTriangleCount(e){const t=this._components.offsets,i=t[e]/3;return t[e+1]/3-i}getComponentAabb3D(e,t){const i=this._componentAabbs3D,r=6*e;return t[0]=i[r],t[1]=i[r+1],t[2]=i[r+2],t[3]=i[r+3],t[4]=i[r+4],t[5]=i[r+5],t}_intersectComponent(e){const t=this.getComponentAabb3D(e,$C);let i=!1;const{localMode:r,_componentVerticalOffsets:n,_verticalOffset:s,_ray0:a,_ray1:o,_invDir:l,planetCenterZ:c,_tolerance:h,rayDirectionC:u,componentIntersectionData:d}=this,{isVerticalRay:p}=this._intersectionOptions,m=this._components.offsets,f=(0,Pi.c)(XC,a),_=(0,Pi.c)(YC,o),g=n?.[e]??0,y=g+(s?.offset??0);if(0!==y&&(r?(f[2]=a[2]-y,_[2]=o[2]-y,i=!0):null!=s&&(s.componentOffset=g)),null==s||i||0===y||s.applyToAabb(t),!(0,ev.Tw)(t,f,l,h))return;(0,Pi.a)(u,_,f);const v=m[e]/3,b=m[e+1]/3,w=b-v,C=(t,i,r)=>{this._callback(t,i,e,r)},{vertexData:x,vertexStride:T,indexData:S,_intersectionOptions:M}=this,{normalRequired:E}=M;if(w>tx){let t=d[e];null==t&&(t=new BC(e,x,T,S,v,b,this.geometryMinZ,c,r),d[e]=t),t.intersectRay(f,_,p,i?0:y,C,E)}else zC(f,u,v,b,S,x,T,i?0:y,c,E,C)}}const $C=(0,fc.Ue)(),XC=(0,R.Ue)(),YC=(0,R.Ue)(),KC=(0,R.Ue)(),QC=(0,R.Ue)(),JC=()=>{},ex=new ev.sT,tx=40;class ix{constructor(e,t,i){this.viewingMode=e,this.positionData=t,this._components=i,this.verticalOffset=null,this.componentVerticalOffsets=null,this._planetCenter=(0,R.Ue)(),this._componentBvh=null,this._aabb=(0,fc.Ue)(),this._indices=t.indices?(0,RC.mi)(t.indices):(0,RC.KF)(t.positions.length/3),this._positions=t.positions}destroy(){this._positions=null,this._indices=null,this._perComponentAabbs=null,this._componentBvh=null}getComponentAabb(e,t){const i=this._ensureComponentAabbs(),r=6*e;return t[0]=i[r],t[1]=i[r+1],t[2]=i[r+2],t[3]=i[r+3],t[4]=i[r+4],t[5]=i[r+5],t}getComponentAabbs(){return this._ensureComponentAabbs()}_ensureComponentAabbs(){return this._perComponentAabbs||(this._perComponentAabbs=this._computePerComponentAabbs()),this._perComponentAabbs}getComponentPositions(e,t){t.indices=this._indices,t.data=this._positions,t.stride=3,t.startIndex=this._components.offsets[e],t.endIndex=this._components.offsets[e+1]}intersect(e,t,i,r,n,s,a,o){this.verticalOffset=r,this.componentVerticalOffsets=n;const{position:l}=s,c=(0,Pi.a)(rx,e,l),h=(0,Pi.a)(nx,t,l),u=(0,ki.U_)(sx,s.rotationScale);(0,Pi.o)(c,c,u),(0,Pi.o)(h,h,u);const d=(0,ki.p4)(ox,u);if(this.viewingMode===Ht.JY.Global){const e=this._planetCenter;(0,Pi.u)(e,l),(0,Pi.o)(e,e,u)}this._intersectComponents(c,h,n,r,((e,t,i,r)=>{o(i,e,r?(0,Pi.o)(ax,r,d):null,t)}),i,a)}_computePerComponentAabbs(){const e=this._aabb,t=.5*(e[0]+e[3]),i=.5*(e[1]+e[4]),r=.5*(e[2]+e[5]),n=this._components.count,s=(0,gC.xx)(6*n),a=this._indices,o=this._positions,l=this._components.offsets;let c=0,h=1/0,u=1/0,d=1/0,p=-1/0,m=-1/0,f=-1/0;for(let e=0;e<n;e++){const n=l[e],_=l[e+1];let g=1/0,y=1/0,v=1/0,b=-1/0,w=-1/0,C=-1/0;if(n<_)for(let e=n;e<_;e++){const t=3*a[e],i=o[t],r=o[t+1],n=o[t+2];g=Math.min(g,i),y=Math.min(y,r),v=Math.min(v,n),b=Math.max(b,i),w=Math.max(w,r),C=Math.max(C,n)}else g=t,y=i,v=r,b=t,w=i,C=r;s[c++]=g,s[c++]=y,s[c++]=v,s[c++]=b,s[c++]=w,s[c++]=C,h=Math.min(h,g),u=Math.min(u,y),d=Math.min(d,v),p=Math.max(p,b),m=Math.max(m,w),f=Math.max(f,C)}return this._aabb[0]=h,this._aabb[1]=u,this._aabb[2]=d,this._aabb[3]=p,this._aabb[4]=m,this._aabb[5]=f,s}_intersectComponents(e,t,i,r,n,s,a){let o=this._componentBvh;null==o&&(o=new WC(this._positions,3,this._indices,this._components,this._ensureComponentAabbs(),this.geometryMinZ,this.planetCenterZ,this.localMode),this._componentBvh=o),o.intersectRay(e,t,i,r,n,s,a)}get geometryMinZ(){return this._aabb[2]}get planetCenterZ(){return this._planetCenter[2]}get numTriangles(){return this._indices.length/3}get localMode(){return this.viewingMode===Ht.JY.Local}get positions(){return this._positions}get indices(){return this._indices}get aabb(){return this._ensureComponentAabbs(),this._aabb}}const rx=(0,R.Ue)(),nx=(0,R.Ue)(),sx=(0,Ea.Ue)(),ax=(0,R.Ue)(),ox=(0,Ea.Ue)();class lx{constructor(e,t,i){this.material=e,this.geometry=t,this.meta=i}destroy(){this.material.dispose(),this.geometry.dispose()}}class cx{constructor(e,t,i,r){this.vao=e,this.primitiveType=t,this.parameters=i,this.indexed=r}dispose(){this.vao.dispose()}}function hx(e,t){const i=new Pm.P,{eye:r,frustum:n,viewForward:s}=e;t.forAll((e=>{const t=null!=e.offsetObb?e.offsetObb:e.obb,a=(0,Pi.e)((0,Pi.a)(Sx,t.center,r),s),o=t.projectedRadius(s);if(i.within(a-o)&&i.within(a+o))return;const l=function(e,t){let i=0;for(let r=0;r<Cx;r++){const n=e.intersectPlane(t[r]);if(n>0)return-1;0===n&&(i|=1<<r)}return i}(t,n);if(-1===l)return;if(0===l)return dx.far=a+o,dx.near=a-o,void i.union(dx);const c=ux.pushNew();c.near=a-o,c.far=a+o,c.mask=l,c.object=e}));for(let e=0;e<ux.length;e++){const t=ux.data[e];if(i.within(t.near)&&i.within(t.far))continue;dx.far=t.far,dx.near=1/0;const a=bx(null!=t.object.offsetObb?t.object.offsetObb:t.object.obb,r,fx,(e=>{let i=_x;for(let r=0;r<Cx&&e.length>0;r++){if(!(t.mask&1<<r))continue;gx(n[r],e,i);const s=e;e=i,i=s}for(let t=0;t<e.length;t+=3){(0,Pi.i)(px,e.data[t],e.data[t+1],e.data[t+2]);const i=(0,Pi.e)((0,Pi.a)(px,px,r),s);dx.near=Math.min(dx.near,i)}}));0===a&&(dx.near=0),i.union(dx)}return ux.length=0,i}const ux=new cd.Z({allocator:e=>e||{near:1/0,far:-1/0,mask:0,object:null},deallocator:e=>(e.object=null,e)}),dx=new Pm.P,px=(0,R.Ue)(),mx=(0,R.Ue)(),fx=new cd.Z({deallocator:null}),_x=new cd.Z({deallocator:null});function gx(e,t,i){i.length=0;const r=t.length-3;yx(px,t,r);const n=(0,Ro.jH)(e,px);n<=0&&(i.push(px[0]),i.push(px[1]),i.push(px[2]));let s=0,a=n;for(;s<r;s+=3){yx(mx,t,s);const r=(0,Ro.jH)(e,mx);a*r<0&&((0,Pi.m)(px,mx,px,r/(r-a)),vx(i,px)),r<=0&&vx(i,mx),a=r,(0,Pi.c)(px,mx)}a*n<0&&(yx(mx,t,r),(0,Pi.m)(px,mx,px,n/(n-a)),vx(i,px))}function yx(e,t,i){return(0,Pi.i)(e,t.data[i],t.data[i+1],t.data[i+2])}function vx(e,t){e.push(t[0]),e.push(t[1]),e.push(t[2])}function bx(e,t,i,r){(0,bo.Kx)(Tx,e.quaternion),(0,Pi.a)(Sx,t,e.center),(0,Pi.v)(Sx,Sx,Tx);const n=e.halfSize,s=8*((Sx[0]<-n[0]?-1:Sx[0]>n[0]?1:0)+3*(Sx[1]<-n[1]?-1:Sx[1]>n[1]?1:0)+9*(Sx[2]<-n[2]?-1:Sx[2]>n[2]?1:0)+13),a=wx[s];if(0===a)return a;(0,ki.en)(xx,e.quaternion),(0,ki.bA)(xx,xx,e.halfSize);const o=(t,i)=>{const r=wx[s+i+1];return(0,Pi.i)(t,((1&r)<<1)-1,(2&r)-1,((4&r)>>1)-1),(0,Pi.o)(t,t,xx),(0,Pi.f)(t,e.center,t)};return i.length=0,vx(i,o(Mx,0)),vx(i,o(Ex,1)),vx(i,o(Sx,2)),vx(i,o(Px,3)),r(i),1===a||(i.length=0,vx(i,Mx),vx(i,Px),vx(i,o(Sx,4)),vx(i,o(Rx,5)),r(i),2===a||(i.length=0,vx(i,Mx),vx(i,Rx),vx(i,o(Sx,6)),vx(i,Ex),r(i))),a}const wx=(()=>{const e=new Array(216);let t=0;const i=i=>{for(let r=0;r<i.length;r++)e[t+r]=i[r];t+=8};return i([3,0,6,2,3,1,5,4]),i([2,0,2,3,1,5,4,0]),i([3,1,0,2,3,7,5,4]),i([2,0,1,3,2,6,4,0]),i([1,0,1,3,2,0,0,0]),i([2,1,5,7,3,2,0,0]),i([3,2,0,1,3,7,6,4]),i([2,2,0,1,3,7,6,0]),i([3,3,0,1,5,7,6,2]),i([2,0,1,5,4,6,2,0]),i([1,0,1,5,4,0,0,0]),i([2,1,3,7,5,4,0,0]),i([1,0,2,6,4,0,0,0]),i([0,0,0,0,0,0,0,0]),i([1,1,3,7,5,0,0,0]),i([2,2,3,7,6,4,0,0]),i([1,2,3,7,6,0,0,0]),i([2,3,1,5,7,6,2,0]),i([3,4,0,1,5,7,6,2]),i([2,5,7,6,4,0,1,0]),i([3,5,0,1,3,7,6,4]),i([2,4,5,7,6,2,0,0]),i([1,4,5,7,6,0,0,0]),i([2,5,1,3,7,6,4,0]),i([3,6,0,2,3,7,5,4]),i([2,6,2,3,7,5,4,0]),i([3,7,6,2,3,1,5,4]),e})(),Cx=4;const xx=(0,Ea.Ue)(),Tx=(0,wo.Ue)(),Sx=(0,R.Ue)(),Mx=(0,R.Ue)(),Ex=(0,R.Ue)(),Px=(0,R.Ue)(),Rx=(0,R.Ue)();class Ax{constructor(e){this._objects=e}submit(e,t){this._objects.preSubmit(t),this._objects.visibleObjects.forAll((i=>i.renderable.material.submit(e,t,i)))}queryDepthRange(e){return this._objects.visibleObjects.length?hx(e,this._objects.visibleObjects):null}get hasEmissions(){return this._objects.visibleObjects.some((e=>e.renderable.material.hasEmissions))}hasHighlight(e){return this._objects.hasHighlight(e)}}var Ox=i(91129);class Dx{constructor(){this.externalColor=(0,tc.Ue)(),this.externalColorMixMode=DC.a9.Multiply,this.castShadows=!0,this.pickable=!0,this.elevationOffset=0}}var Ix=i(44417),Lx=i(21184),Nx=i(54998),Fx=i(95285),Ux=i(13580),Hx=i(57945);const kx=()=>d.Z.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");class Vx{constructor(e,t){this._renderManager=e,this._viewingMode=t,this._elevationRangeCacheVerticalOffset=NaN,this._elevationRangeCacheMin=NaN,this._elevationRangeCacheMax=NaN,this._activeHighlightOptions=new Map,this._visible=new cd.Z,this._hidden=new cd.Z,this._renderSubmit=new Ax(this),this._renderManager.register(this._renderSubmit),this._componentBufferManager=new Ux.g(e.rctx,2+((0,Fx.B)()?1:0))}destroy(){(0,Mf.hu)(0===this._hidden.length&&0===this._visible.length,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy(),this._visible.forAll((e=>e.destroy())),this._visible.clear(),this._hidden.forAll((e=>e.destroy())),this._hidden.clear()}createObject(e){const t=e.geometry,i=new NC(this._componentBufferManager,(0,RC.mi)(t.componentOffsets)),r=this._createRenderable(e,i),n=new ix(this._viewingMode,t.positionData,i),s=new FC(e.transform,e.toMapSpace,e.obb.clone(),i,r,n);return(s.visible?this._visible:this._hidden).push(s),s}destroyObject(e){const t=e;(t.visible?this._visible:this._hidden).removeUnordered(t),t.destroy(),this._notifyDirty()}setObjectVisibility(e,t){const i=e;t!==i.visible&&(t?(this._hidden.removeUnordered(i),this._visible.push(i)):(this._visible.removeUnordered(i),this._hidden.push(i)),i.visible=t,this._notifyDirty())}preSubmit(e){const t=e.camera.eye;this.visibleObjects.forAll((e=>e.renderable.meta.cameraDepthSquared=(0,Pi.s)(t,e.obb.center)))}getMaterial(e){return e.renderable.material}updateMaterial(e,t){const i=e.renderable.material;t(i),i.dirty&&this._notifyDirty()}setAllComponentVisibilities(e,t){const i=e;i.componentData.visibility.reset(t),i.componentData.markVisibilityDirty(),this._notifyDirty()}forEachVisibleComponent(e,t){return e.componentData.visibility.forEachComponent(t)}getComponentCount(e){const t=e,i=t.componentData.visibility.componentCount;return{visible:i,invisible:t.componentData.count-i}}setComponentData(e,t){const i=e,{renderable:r,componentData:n}=i,s=r.material,a=n.materialDataBuffer,o=n.materialDataIndices,l=new Dx,c=a.textureBuffer,h=new Uint8Array(4),u=new Uint32Array(h.buffer);let d=0,p=0,m=0,f=n.verticalOffsets,_=1/0,g=-1/0,y=!1,v=!1,b=0;for(let e=0;e<n.count;e++){t(e,l),d+=+(l.externalColor[3]<1),p+=+(l.externalColorMixMode===DC.a9.Replace&&1===l.externalColor[3]),m+=+l.castShadows,(0,DC.HB)(l.externalColor,l.externalColorMixMode,h),h[2]=254&h[2]|+l.castShadows,c.setData(o[e],0,h[0],h[1],h[2],h[3]),y||=e>0&&b!==u[0],b=u[0],v||=0!==l.elevationOffset,v&&null==f&&(f=new Array(e).fill(0)),null!=f&&(f[e]=l.elevationOffset),_=Math.min(_,l.elevationOffset),g=Math.max(g,l.elevationOffset),(0,Nx.nO)(l.elevationOffset,h),c.setData(o[e],1,h[0],h[1],h[2],h[3]);const i=l.objectAndLayerIdColor;null!=i&&c.setData(o[e],2,i[0],i[1],i[2],i[3]),l.pickable!==ZC(n.pickability,e)&&qC(n,e,l.pickable)}n.verticalOffsets=v?f:null,i.offsetObb=v?(0,IC.gI)(i.obb,_,g,this._viewingMode,i.offsetObb??i.obb.clone()):null,y||v||(0,Fx.B)()?(s.componentParameters=new Ix.Qu,s.componentParameters.castShadows=zx(m,n.count),s.componentParameters.transparent=zx(d,n.count),s.componentParameters.opaqueOverride=zx(p,n.count),s.componentParameters.texture=c,c.updateTexture()):(s.componentParameters=new Ix.zO,s.componentParameters.castShadows=l.castShadows?Ix.ws.All:Ix.ws.None,s.componentParameters.externalColor=l.externalColor,s.componentParameters.externalColorMixMode=l.externalColorMixMode),this._elevationRangeCacheVerticalOffset=NaN,this._notifyDirty()}getComponentAabb(e,t,i,r=!1){e.intersectionGeometry.getComponentAabb(t,i);const n=e,s=n.componentData.verticalOffsets;if(r||null==s)return i;const a=s[t];if(this._viewingMode===Ht.JY.Local||0===a)return i[2]+=a,i[5]+=a,i;const o=(0,Lo.iO)(a);return o.localOrigin=n.transform.position,o.applyToAabb(i)}getComponentObb(e){return e.obb}getObjectTransform(e){return e.transform}getComponentPositions(e,t,i){return e.intersectionGeometry.getComponentPositions(t,i)}expandRangeWithComponentObjectElevationRange(e,t,i,r){Number.isNaN(this._elevationRangeCacheVerticalOffset)||this._elevationRangeCacheVerticalOffset!==t||r.expandElevationRangeValues(this._elevationRangeCacheMin,this._elevationRangeCacheMax);const n=e,s=n.componentData,a=s.count,o=s.verticalOffsets,l=n.intersectionGeometry,c=this._viewingMode===Ht.JY.Local,h=l.getComponentAabbs(),u=Gx;let d=1/0,p=-1/0;for(let e=0;e<a;e++){const s=6*e,a=o?.[e]??0;let l=1/0,m=-1/0;if(c)l=h[s+2]+a+t,m=h[s+5]+a+t;else{if(u[0]=h[s],u[1]=h[s+1],u[2]=h[s+2],u[3]=h[s+3],u[4]=h[s+4],u[5]=h[s+5],0!==a){const e=(0,Lo.iO)(a);e.localOrigin=n.transform.position,e.applyToAabb(u)}const e=Math.max(Math.abs(u[3]),Math.abs(u[0])),o=Math.max(Math.abs(u[4]),Math.abs(u[1])),l=t+u[5]+i;r.expandElevationRangeValues(t+u[2],Math.sqrt(e*e+o*o+l*l)-i)}r.expandElevationRangeValues(l,m),d=Math.min(d,l),p=Math.max(p,m)}this._elevationRangeCacheVerticalOffset=t,this._elevationRangeCacheMin=d,this._elevationRangeCacheMax=p}intersect(e,t,i,r,n,s,a){const o=e,{transform:l,componentData:c,intersectionGeometry:h}=o;return null!=n&&(n.localOrigin=l.position),h.intersect(t,i,r,n,c.verticalOffsets,l,s,a)}addEdges(e,t,i,r,n){const s=e,{indices:a,positions:o}=s.intersectionGeometry,l=s.componentData.offsets;return t.addComponentObject(s,o,a,l,i,r,n)}async extractEdgeInformation(e,t,r){const n=e,s=n.componentData.visibility;if(s.allInvisible()){const{extractComponentsEdgeLocationsLayout:e}=await i.e(20820).then(i.bind(i,20820));return{buffer:e.createBuffer(0),origin:[0,0,0]}}const{indices:a,positions:o}=n.intersectionGeometry,l=n.componentData.offsets,{EdgeInputBufferLayout:c}=await i.e(46551).then(i.bind(i,46551)),h=c.createBuffer(o.length/3);(0,OC.c)(h.position.typedBuffer,o,h.position.typedBufferStride,3),(0,AC.c)(h.position,h.position,n.transform.rotationScale),this._setComponentIndices(h.componentIndex,a,l);const u=h.count,d=this._computeVisibilityIndices(a,s,l,u);return{origin:(0,R.d9)(n.transform.position),buffer:await t.extractComponentsEdgeLocations({indices:d,indicesLength:d.length,skipDeduplicate:!0,data:h,writerSettings:{reducedPrecision:!1,variants:0}},r)}}_setComponentIndices(e,t,i){let r=0;for(let n=0;n<i.length-1;n++){const s=i[n],a=i[n+1];for(let i=s;i<a;i++){const n=t?t[i]:i;e.set(n,r)}r++}}_computeVisibilityIndices(e,t,i,r){if(e&&t.allVisible())return e;let n=0;t.forEachComponentRange(((e,t)=>(n+=i[t]-i[e],!0)));const s=(0,yg.fU)(e)?2===e?.BYTES_PER_ELEMENT||r<=65536?new Uint16Array(n):new Uint32Array(n):new Array(n);let a=0;return t.forEachComponentRange(((t,r)=>{const n=i[t],o=i[r];for(let t=n;t<o;t++)s[a++]=e?e[t]:t;return!0})),s}addComponentHighlight(e,t,i){const r=e.componentData,n=(0,Ue.s1)(r.componentHighlights,i,(()=>new Uint32Array(r.count+1)));{const e=this._activeHighlightOptions.get(i)??0;this._activeHighlightOptions.set(i,e+1)}0==n[t]++&&(r.markHighlightsDirty(),this._notifyDirty()),n[r.count]++}removeComponentHighlight(e,t,i){const{componentData:r}=e,n=r.componentHighlights.get(i);if(void 0===n)return void kx().warn("Removing non-existing highlight.");const s=n[t];if(0===s)return void kx().warn("Removing non-existing highlight.");this._removeActiveHighlight(i);const a=n[r.count];if(s>1)return n[t]=s-1,void(n[r.count]=a-1);n[t]=0,1===a?r.componentHighlights.delete(i):n[r.count]=a-1,r.markHighlightsDirty(),this._notifyDirty()}_removeActiveHighlight(e,t=1){const i=this._activeHighlightOptions.get(e);if(void 0===i)kx().warn("Removing non-existing highlight.");else{const r=i-t;r<0&&kx().warn("Removing non-existing highlight."),r<=0?this._activeHighlightOptions.delete(e):this._activeHighlightOptions.set(e,r)}}clearHighlights(e){const{componentData:t}=e,{componentHighlights:i}=t;if(i.size>0){for(const e of i)this._removeActiveHighlight(e[0],e[1][t.count]);i.clear(),t.markHighlightsDirty(),this._notifyDirty()}}hasHighlight(e){return this._activeHighlightOptions.has(e)}getObjectGPUMemoryUsage(e){return e.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._visible}_createRenderable(e,t){const i=this._renderManager.rctx,r=e.geometry,n=r.vertices.layoutParameters,s=Mr.f.createVertex(i,$i.l1.STATIC_DRAW,r.vertices.data),a=r.indices?Mr.f.createIndex(i,$i.l1.STATIC_DRAW,r.indices):null,o=(0,vr.K)((0,Ox.N)(n)),l=new Uint16Array(r.vertices.count);for(let e=0;e<t.count;e++){const i=t.offsets[e],n=t.offsets[e+1],s=t.materialDataIndices[e];if(null!=r.indices)for(let e=i;e<n;e++)l[r.indices[e]]=s;else for(let e=i;e<n;e++)l[e]=s}const c=Mr.f.createVertex(i,$i.l1.STATIC_DRAW,l.buffer),h=new Ix.Un(e.transform,e.toMapSpace),u=new Hx.U(i,Lx.k,new Map([["data",o],["componentIndices",Bx]]),new Map([["data",s],["componentIndices",c]]),a),d=new cx(u,$i.MX.TRIANGLES,n,null!=a),p={cameraDepthSquared:.5,gpuMemoryEstimate:s.usedMemory+c.usedMemory+(null!=a?a.usedMemory:0)};return new lx(h,d,p)}_notifyDirty(){this._renderManager.notifyDirty()}}const Bx=(0,vr.K)((0,br.U$)().u16(mr.T.COMPONENTINDEX));function zx(e,t){return e===t?Ix.ws.All:0===e?Ix.ws.None:Ix.ws.Some}const Gx=(0,fc.Ue)();class qx{constructor(e,t,i,r,n){this.rctx=e,this.viewingMode=t,this.stippleTextures=i,this.waterTextures=r,this.markerTextures=n}get spherical(){return this.viewingMode===Ht.JY.Global}}class Zx{constructor(e){this.context=e,this._debug=!1,this._precompiling=this._debug?0:1,this._cache=new Iw.r}get precompiling(){return this._precompiling}set precompiling(e){this._precompiling=e,0===e&&this.context.rctx.gl.flush()}get viewingMode(){return this.context.viewingMode}destroy(){this._cache.forAll((e=>e.destroy())),this._cache.clear()}precompile(e,t=jx){++this.precompiling,this.get(e,t),--this.precompiling}get(e,t=jx){const i=t.key.code;let r=this._cache.get(e,i);if(null==r){if(0===this._precompiling){let i=`Uncached shader compile in ${(new Error).stack}\n  for configuration\n${t.decode()}`;const r=this._cache.getInner(e);throw r?.size&&(i+="\n\n  cached configurations:\n",i+=Array.from(r.values()).map((e=>t.decode(e.key))).sort().join("\n\n")),console.log(i),new l.Z("shader:uncached-compile",i)}r=new e(this.context,t),this._cache.set(e,i,r)}return r}async reloadAll(){const e=new Array;this._cache.forEach((t=>e.push(async function(e){let t=!0;e.forEach((async e=>{await e.reload(t),t=!1}))}(t)))),await Promise.all(e)}}const jx=new tb.m;var Wx=i(666);class $x extends Wi.A{constructor(e,t){super(e,t,new ji.J(Wx.b,(()=>i.e(68651).then(i.bind(i,75206)))))}initializePipeline(){return(0,Xi.sm)({colorWrite:Xi.gf})}}class Xx extends tb.m{constructor(){super(...arguments),this.bloomStage=Wx.a.Horizontal}}(0,r._)([(0,tb.o)({count:Wx.a.COUNT})],Xx.prototype,"bloomStage",void 0);var Yx=i(60700);class Kx extends Wi.A{constructor(e,t){super(e,t,new ji.J(Yx.a,(()=>i.e(43076).then(i.bind(i,43076)))))}initializePipeline(){return(0,Xi.sm)({colorWrite:Xi.gf})}}var Qx=i(40673);let Jx=class extends Tr{constructor(e){super(e),this.consumes={required:[dr.CM.TRANSPARENT_ENVIRONMENT,"emissive"]},this._blurHorizontalConfiguration=new Xx,this._blurVerticalConfiguration=new Xx,this._compositionParameters=new Yx.B,this._blurParameters=new Wx.B,this._blurScale=3.06,this._bloomResults=new Array}initialize(){this.addHandles([(0,_.YP)((()=>this._updateFogParameters()),(()=>{}),_.tX),(0,_.YP)((()=>this.view.qualitySettings.bloom),(e=>{e?(this._enable(),this.precompile()):this._disable()}),_.tX)])}destroy(){}_updateFogParameters(){const e=this.view.environment.weather;if("sunny"===e.type||"cloudy"===e.type)this._blurParameters.blurRadius=Qx.L9[e.type];else{const t="foggy"===e.type?e.fogStrength:e.precipitation;this._blurParameters.blurRadius=(0,st.t7)(Qx.L9.cloudy,Qx.L9[e.type],t)}this._compositionParameters.lodFactors=Qx.Ml[e.type].far,this._compositionParameters.lodFactorsFront=Qx.Ml[e.type].near,this.requestRender(Cr.Xx.UPDATE)}precompile(){this.techniques.precompile($x,this._blurHorizontalConfiguration),this._blurVerticalConfiguration.bloomStage=Wx.a.Vertical,this.techniques.precompile($x,this._blurVerticalConfiguration),this.techniques.precompile(Kx)}render(e){const t=e.find((({name:e})=>e===dr.CM.TRANSPARENT_ENVIRONMENT)),i=t.getAttachment($i.Ml)?.attachment;if(!i)return t;const r=this.techniques.get($x,this._blurHorizontalConfiguration),n=this.techniques.get($x,this._blurVerticalConfiguration),s=this.techniques.get(Kx);if(!r.compiled||!n.compiled||!s.compiled)return this.requestRender(Cr.Xx.UPDATE),t;const a=t.getTexture(),o=this.fboCache,{fullWidth:l,fullHeight:c}=this.bindParameters.camera,h=this.renderingContext;let u=i,d=l/2,p=c/2;const m=this._blurParameters.blurRadius;for(let e=0;e<5;e++){const t=o.acquire(d,p,"bloomHorizontal",Td.qz.RGBA16FLOAT);this._blurParameters.color=u,this._prepareFBO(t,d,p),h.bindTechnique(r,this.bindParameters,this._blurParameters),h.screen.draw();const i=o.acquire(d,p,"bloomVertical",Td.qz.RGBA16FLOAT);this._blurParameters.color=t.getTexture(),this._prepareFBO(i,d,p),h.bindTechnique(n,this.bindParameters,this._blurParameters),h.screen.draw(),t.release(),this._bloomResults[e]=i,d=Math.ceil(d/2),p=Math.ceil(p/2),u=this._bloomResults[e].getTexture(),this._blurParameters.blurRadius*=this._blurScale}this._blurParameters.blurRadius=m,this._compositionParameters.color=a,this._compositionParameters.emission=i,this._compositionParameters.bloomTexture0=this._bloomResults[0].getTexture(),this._compositionParameters.bloomTexture1=this._bloomResults[1].getTexture(),this._compositionParameters.bloomTexture2=this._bloomResults[2].getTexture(),this._compositionParameters.bloomTexture3=this._bloomResults[3].getTexture(),this._compositionParameters.bloomTexture4=this._bloomResults[4].getTexture();const f=o.acquire(a.descriptor.width,a.descriptor.height,this.produces);return this._prepareFBO(f,l,c),h.bindTechnique(s,this.bindParameters,this._compositionParameters),h.screen.draw(),this._bloomResults.forEach((e=>e.release())),f.attachDepth(t.getAttachment($i.Lu)),f.attachColor(t.getAttachment($i.Ml),$i.Ml),f}_prepareFBO(e,t,i){const r=this.renderingContext;r.bindFramebuffer(e.fbo),r.setViewport(0,0,t,i),r.setClearColor(0,0,0,0),r.clear($i.Hf.COLOR)}get test(){return{compositionParameters:this._compositionParameters,blurParameters:this._blurParameters,setLodFactors:e=>{this._compositionParameters.lodFactors=(0,Qx.Su)(e)}}}};(0,r._)([(0,w.Cb)()],Jx.prototype,"consumes",void 0),Jx=(0,r._)([(0,x.j)("esri.views.3d.webgl-engine.effects.bloom.BloomRenderNode")],Jx);var eT=i(29158);let tT=class extends wr.Z{constructor(e){super(e),this.consumes={required:["olid"]},this.produces="olid"}destroy(){}render(e){const t=e.find((({name:e})=>"olid"===e)),i=this.renderingContext;return i.bindFramebuffer(t.fbo),i.clearFramebuffer(tc.AG,!0,!0),this.view.stage.renderer.renderAllGeometry(qb.H_.ObjectAndLayerIdColor),i.clear($i.Hf.DEPTH|$i.Hf.STENCIL),this.view.stage.renderer.renderHUD(eT.U.NotOccluded),t}};(0,r._)([(0,w.Cb)()],tT.prototype,"consumes",void 0),(0,r._)([(0,w.Cb)()],tT.prototype,"produces",void 0),tT=(0,r._)([(0,x.j)("esri.views.3d.webgl-engine.effects.geometry.ObjectAndLayerIDRenderNode")],tT);var iT=i(25631),rT=i(38419);let nT=class extends wr.Z{constructor(e){super(e),this.consumes={required:[dr.CM.OCCLUDED]},this.produces=dr.CM.OCCLUDED,this._blit=new iT.N(e.view.stage.renderView.techniques,rT.J.PremultipliedAlpha)}precompile(){const e=this.view.stage.renderer;e.plugins.plugins.forAll((t=>{e.precompileSlots(t,$b.r.OCCLUDED_GROUND,$b.r.TRANSPARENT_OCCLUDER_MATERIAL),t.material&&e.precompileOccludedSlots(t,aT)}))}render(e){const t=e.find((({name:e})=>e===this.produces));return this._renderOccludedAndTransparentStencil(t),this._renderOccludedComposite(t),t}_renderOccludedAndTransparentStencil(e){const t=this.view.stage.renderer,i=sT;i.clear();for(const e of t.plugins.plugins)e.renderOccludedFlags&Wb.yD.OccludeAndTransparentStencil&&i.push(e);0!==i.length&&(t.renderSlots(i,$b.r.OCCLUDER_MATERIAL),this._renderAndComposite(e,e.getAttachment($i.Lu),.5,(()=>t.renderSlots(i,$b.r.TRANSPARENT_OCCLUDER_MATERIAL)),!1,!1),i.clear())}_renderOccludedComposite(e){const t=this.view.stage.renderer,i=sT;i.clear();let r=0;for(const e of t.plugins.plugins){const t=e.renderOccludedFlags&oT;r|=t,t&&i.push(e)}if(!r)return void i.clear();const n=this._getDepthStencilAttachment(e);let s=n.clearStencil;for(const a of aT)r&a&&(this._renderAndComposite(e,n.depth,a===Wb.yD.Opaque?1:.5,(()=>t.renderOccludedSlots(i,a)),!0,s),s=!1);n.release(),i.clear()}_renderAndComposite(e,t,i,r,n,s){const a=this.renderingContext,{width:o,height:l}=e.fbo,c=this.fboCache.acquire(o,l,"tmp color");c.attachDepth(t),a.bindFramebuffer(c.fbo),a.clearFramebuffer(tc.AG,n,s),r(),c.detachDepth(),this._blit.blend(a,c,e,this.bindParameters,i),c.release()}_getDepthStencilAttachment(e){const{width:t,height:i}=e.fbo;if(!this.view.stage.renderer.occludedRequiresIntegratedMeshStencil){const e=this.fboCache.acquireDepth(Td.qk.DEPTH24_STENCIL8,t,i,"retained stencil");return{depth:e,release:()=>e.release(),clearStencil:!0}}const r=this.fboCache.acquire(t,i,"retained stencil",Td.qk.DEPTH24_STENCIL8);return this.renderingContext.blitFramebuffer(e.fbo,r.fbo,$i.Hf.STENCIL),{depth:r.getAttachment($i.Lu),release:()=>r.release(),clearStencil:!1}}};(0,r._)([(0,w.Cb)()],nT.prototype,"consumes",void 0),(0,r._)([(0,w.Cb)()],nT.prototype,"produces",void 0),nT=(0,r._)([(0,x.j)("esri.views.3d.webgl-engine.effects.geometry.RenderOccludedRenderNode")],nT);const sT=new cd.Z,aT=[Wb.yD.OccludeAndTransparent,Wb.yD.Transparent,Wb.yD.Opaque],oT=aT.reduce(((e,t)=>e|t),Wb.yD.None);var lT=i(41811);class cT extends Wi.A{constructor(e,t){super(e,t,new ji.J(lT.a,(()=>i.e(73034).then(i.bind(i,73034)))))}initializePipeline(){return(0,Xi.sm)({blending:(0,Xi.wK)($i.zi.ONE,$i.zi.ZERO,$i.zi.ONE_MINUS_SRC_COLOR,$i.zi.ONE),depthTest:{func:$i.wb.ALWAYS},colorWrite:Xi.gf})}}var hT=i(79626);class uT extends qw.o{constructor(){super(...arguments),this.hazeStrength=1}}class dT extends Wi.A{constructor(e,t){super(e,t,new ji.J(hT.H,(()=>i.e(37930).then(i.bind(i,37930)))))}initializePipeline(e){return e.reduced?(0,Xi.sm)({blending:Xi.LW,depthTest:{func:$i.wb.ALWAYS},colorWrite:Xi.gf}):(0,Xi.sm)({blending:(0,Xi.wK)($i.zi.ONE,$i.zi.ZERO,$i.zi.ONE_MINUS_SRC_COLOR,$i.zi.ONE),colorWrite:Xi.gf})}}class pT extends tb.m{constructor(){super(...arguments),this.reduced=!1}}(0,r._)([(0,tb.o)()],pT.prototype,"reduced",void 0);let mT=class extends Tr{constructor(e){super(e),this._compositingPassParameters=new lT.H,this._passParameters=new uT,this._hazeConfiguration=new pT,this._vao=null,this.requireGeometryDepth=!0,this._oldAmount=1,this._newAmount=1,this._amount=this._newAmount;const t=e.view.stage.renderView.techniques;t.precompile(dT,new pT);const i=new pT;i.reduced=!0,t.precompile(dT,i),t.precompile(cT)}initialize(){this.addHandles([(0,_.YP)((()=>this.view.environment.atmosphereEnabled),(e=>e?this._enable():this._disable()),_.tX),(0,_.YP)((()=>this.view.stage?.renderer.renderContext.bind.clouds.fadeFactor??1),(e=>this._fade(e)),_.tX),(0,_.YP)((()=>this.view.environment.weather.type),(e=>this._newAmount="rainy"===e?0:1),_.tX),(0,_.YP)((()=>this.view.stage.renderer?.fullResolutionAtmosphere),(e=>this._hazeConfiguration.reduced=!e),_.tX)])}_fade(e){e>=1?(this._amount=this._newAmount,this._oldAmount=this._newAmount):this._amount=e<=0?this._oldAmount:(0,st.t7)(this._oldAmount,this._newAmount,e)}destroy(){this._vao=(0,p.M2)(this._vao)}render(e){const t=e.find((({name:e})=>e===dr.CM.TRANSPARENT_ENVIRONMENT));if(!this.bindParameters.mainDepth)return t;const i=this.renderingContext;this._vao??=(0,mb.ow)(i,mb.Ar.Pos2Tex);const r=this.techniques.get(dT,this._hazeConfiguration);if(!r.compiled)return t;const n=t.getAttachment($i.Lu);if(this._update(),!this._hazeConfiguration.reduced)return t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(r,this.bindParameters,this._passParameters),this._renderCommon(i),t.attachDepth(n),t;const s=this.techniques.get(cT);if(!s.compiled)return t;const a=i.getViewport(),o=this.camera,l=(0,Pi.l)(o.eye)-_i.sv.radius;let c;const h=_i.sv.atmosphereHeight;if(l<h){const e=Math.min(1,Math.max(0,l/h));c=(0,st.t7)(.4,.5,e)}else{const e=Math.min(1,Math.max(0,(l-h)/(15*h)));c=(0,st.t7)(.5,1,e)}const u=this.renderingContext.parameters.maxTextureSize,d=(0,sg.nq)(Math.round(c*o.fullViewport[2]),u),p=(0,sg.nq)(Math.round(c*o.fullViewport[3]),u);i.setViewport(0,0,d,p);const m=this.fboCache.acquire(d,p,"haze",Td.qz.RGBA8UNORM);return i.bindFramebuffer(m.fbo),i.clearFramebuffer([0,0,0,1],!0,!0),i.bindTechnique(r,this.bindParameters,this._passParameters),this._renderCommon(i),i.setViewport(a.x,a.y,a.width,a.height),this._compositingPassParameters.color=m.getTexture(),t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(s,this.bindParameters,this._compositingPassParameters),i.screen.draw(),t.attachDepth(n),m.release(),t}_renderCommon(e){null!=this._vao&&(e.bindVAO(this._vao),e.drawArrays($i.MX.TRIANGLE_STRIP,0,4))}_update(){const e=this.bindParameters.camera,t=(0,Pi.k)(e.eye),i=Math.sqrt(t),r=t-this._passParameters.radii[1]*this._passParameters.radii[1],n=(0,st.uZ)((i-this._passParameters.radii[0])/_i.sv.atmosphereHeight,0,1);(0,ec.s)(this._passParameters.heightParameters,i,t,r,n);const s=this.view.basemapTerrain?.getLowerBoundRadius()??0;(0,zi.t8)(this._passParameters.radii,s,s+_i.sv.atmosphereHeight),this._passParameters.hazeStrength=(0,st.t7)((0,st.t7)(.6,1,(0,st.CW)(9500,10500,i-_i.sv.radius)),1,this._amount)}};mT=(0,r._)([(0,x.j)("esri.views.3d.webgl-engine.effects.haze.Haze")],mT);var fT=i(35285),_T=i(36351),gT=i(49790);class yT extends _T.nj{constructor(){super(...arguments),this.shadowColor=(0,tc.al)(1,0,1,1),this.shadowOpacity=.2,this.occludedShadowOpacity=.1,this.opacityElevation=1,this.dayNightTerminator=1}}class vT extends Wi.A{constructor(e,t){super(e,t,new ji.J(gT.S,(()=>i.e(44634).then(i.bind(i,44634))))),this.primitiveType=$i.MX.TRIANGLE_STRIP}initializePipeline(){return(0,Xi.sm)({blending:Xi.vf,colorWrite:Xi.gf,depthTest:null,depthWrite:null})}}let bT=class extends wr.Z{constructor(e){super(e),this.produces=dr.lu.COMPOSITE,this.consumes={required:[dr.lu.COMPOSITE,"highlights"]},this._passParameters=new yT,this._maxOpacity=1,this._shadowDifference=.2}initialize(){this.addHandles([(0,_.YP)((()=>this.view.highlightOptions.shadowOpacity),(e=>{this._passParameters.shadowOpacity=e??gt.CN,this._updateOccludedShadowOpacity(),this._ensureMaxOpacity()}),_.tX),(0,_.YP)((()=>this.view.highlightOptions.shadowDifference),(e=>{this._shadowDifference=e??gt.oH,this._updateOccludedShadowOpacity(),this._ensureMaxOpacity()}),_.tX),(0,_.YP)((()=>this.view.highlightOptions.shadowColor),(e=>{this._passParameters.shadowColor=(0,zw.O)(e??gt.NU),this._ensureMaxOpacity()}),_.tX)])}_updateOccludedShadowOpacity(){this._passParameters.occludedShadowOpacity=this._passParameters.shadowOpacity*(1-this._shadowDifference)}_ensureMaxOpacity(){const e=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=e*this._passParameters.shadowColor[3],this.requestRender(Cr.Xx.UPDATE)}precompile(){this.techniques.precompile(vT)}render(e){const t=e.find((({name:e})=>e===dr.lu.COMPOSITE)),i=this.bindParameters;if(!i.shadowHighlightsVisible||!i.depth||!this._ensureIfVisible(i.camera,i.lighting.mainLight.direction))return t;const r=this.techniques.get(vT);if(r.compiled){this._passParameters.highlightTexture=e.find((({name:e})=>"highlights"===e))?.getTexture(),this._passParameters.origin=i.camera.center;const n=this.renderingContext;n.bindFramebuffer(t.fbo),n.bindTechnique(r,i,this._passParameters),n.screen.draw()}else this.requestRender(Cr.Xx.UPDATE);return t}_ensureIfVisible(e,t){this._passParameters.opacityElevation=1-(0,st.CW)(4e4,5e4,e.relativeElevation);const i=this.viewingMode===Ht.JY.Global?(0,Pi.n)(wT,e.center):(0,Pi.i)(wT,0,0,1),r=(0,Pi.e)(i,t);return this._passParameters.dayNightTerminator=(0,st.CW)(0,1,(0,st.uZ)(30*r,0,1)),this._maxOpacity*this._passParameters.opacityElevation*this._passParameters.dayNightTerminator>=.001953125}};(0,r._)([(0,w.Cb)()],bT.prototype,"produces",void 0),(0,r._)([(0,w.Cb)()],bT.prototype,"consumes",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],bT.prototype,"viewingMode",void 0),bT=(0,r._)([(0,x.j)("esri.views.3d.webgl-engine.effects.highlight.ShadowHighlight")],bT);const wT=(0,R.Ue)();var CT=i(51880),xT=i(87619);class TT extends Wi.A{constructor(e,t){super(e,t,new ji.J(xT.a,(()=>i.e(14941).then(i.bind(i,14941)))))}initializePipeline(){return(0,Xi.sm)({blending:Xi.Zo,depthTest:null,depthWrite:null,colorWrite:Xi.gf})}}let ST=class extends wr.Z{constructor(){super(...arguments),this.produces=dr.CM.MAGNIFIER,this.consumes={required:[dr.CM.MAGNIFIER]},this._imageSources=null,this._imageLoadTask=null,this._passParameters=new xT.M,this._vao=null,this._magnifier=null,this._tmpScreenPoint=(0,y.s1)(),this._tmpRenderPoint=(0,y.gX)()}initialize(){this.addHandles([(0,_.YP)((()=>this.view.magnifier),(e=>this._update(e)),_.tX)])}_update(e){if(e===this._magnifier)return;this.removeAllHandles(),this._magnifier=e;const t=()=>{const e=this._validMagnifier;e?(this._loadResources(e),this.produces=dr.CM.MAGNIFIER):this.produces="disabled",this.requestRender()};this._magnifier&&this.addHandles((0,_.YP)((()=>this._magnifier?.version),t)),t()}get _validMagnifier(){return this._magnifier?.visible&&this._magnifier?.position&&this._magnifier?.size>0?this._magnifier:null}get _factor(){return this._magnifier?.factor||1}destroy(){this._magnifier=null,null!=this._imageLoadTask&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeTextures(),this._vao=(0,p.M2)(this._vao)}_disposeTextures(){this._passParameters.mask=(0,p.M2)(this._passParameters.mask),this._passParameters.overlay=(0,p.M2)(this._passParameters.overlay),this._passParameters.input=(0,p.M2)(this._passParameters.input)}precompile(){this._imageSources&&this.techniques.precompile(TT)}render(e){const t=this._validMagnifier,i=e.find((({name:e})=>e===dr.CM.MAGNIFIER));if(null==t)return i;if(null==this._imageSources)return this.requestRender(Cr.Xx.UPDATE),i;const r=this.renderingContext,n=this.camera.pixelRatio,s=Math.ceil(n*t.size);this._vao??=(0,mb.ow)(r,mb.Ar.Pos2,Sd.i,0,1);const a=this.techniques.get(TT);if(this._ensureTextureResources(r,s),!a.compiled||!this._passParameters.input)return this.requestRender(Cr.Xx.UPDATE),i;const o=Math.ceil(1/this._factor*s),l=this._passParameters.input;l.resize(o,o),(0,y.md)(t.position,this._tmpScreenPoint);const c=this.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),h=this.camera.fullWidth,u=this.camera.fullHeight,d=.5*o,p=.5*o;c[0]=(0,st.uZ)(c[0],d,h-d-1),c[1]=(0,st.uZ)(c[1],p,u-p-1);const m=Math.floor(c[0]-d),f=Math.floor(c[1]-p);return r.bindFramebuffer(i.fbo),a.program.bindTexture("textureInput",l),r.gl.copyTexImage2D(l.descriptor.target,0,l.descriptor.pixelFormat,m,f,o,o,0),this._passParameters.magnifier=t,r.bindTechnique(a,this.bindParameters,this._passParameters),r.bindVAO(this._vao),r.drawArrays($i.MX.TRIANGLE_STRIP,0,4),i}_loadResources(e){const{maskUrl:t,overlayUrl:r}=e;this._imageLoadTask?.maskUrl===t&&this._imageLoadTask?.overlayUrl===r||(this._imageLoadTask?.task.abort(),this._imageLoadTask=this._imageSources=null),this._imageSources||this._imageLoadTask||(this._imageLoadTask={maskUrl:t,overlayUrl:r,task:(0,me.vr)((async e=>{const n=null==t||null==r?async function(e){const t=i.e(83774).then(i.bind(i,83774)),r=i.e(41064).then(i.bind(i,41064)),n=(0,CT.t)((await t).default,{signal:e}),s=(0,CT.t)((await r).default,{signal:e}),a={mask:await n,overlay:await s};return(0,f.k_)(e),a}(e):null,s=null!=t?(0,CT.t)(t,{signal:e}):n.then((e=>e.mask)),a=null!=r?(0,CT.t)(r,{signal:e}):n.then((e=>e.overlay));this._imageSources={mask:await s,overlay:await a}}))})}_ensureTextureResources(e,t){null==this._imageSources||this._passParameters.size===t&&this._passParameters.input&&this._passParameters.mask&&this._passParameters.overlay||(this._disposeTextures(),this._imageSources.overlay.width=this._imageSources.mask.width=t,this._imageSources.overlay.height=this._imageSources.mask.height=t,this._passParameters.overlay=new Ed.x(e,this._createTextureDescriptor(t,$i.VI.RGBA,this._imageSources.overlay),this._imageSources.overlay),this._passParameters.mask=new Ed.x(e,this._createTextureDescriptor(t,$i.VI.ALPHA,this._imageSources.mask),this._imageSources.mask),this._passParameters.input=new Ed.x(e,this._createTextureDescriptor(t,$i.VI.RGBA,null)))}_createTextureDescriptor(e,t,i){const r=this.renderingContext,n=new ir.X(e,e);return n.pixelFormat=n.internalFormat=t,n.wrapMode=$i.e8.CLAMP_TO_EDGE,n.flipped=!!i,n.preMultiplyAlpha=!(t!==$i.VI.RGBA||!i||(0,Wf.zd)(i.src)&&r.driverTest.svgPremultipliesAlpha.result),n}};(0,r._)([(0,w.Cb)()],ST.prototype,"produces",void 0),(0,r._)([(0,w.Cb)()],ST.prototype,"consumes",void 0),(0,r._)([(0,w.Cb)()],ST.prototype,"_imageSources",void 0),(0,r._)([(0,w.Cb)()],ST.prototype,"_imageLoadTask",void 0),ST=(0,r._)([(0,x.j)("esri.views.3d.webgl-engine.effects.magnifier.Magnifier")],ST);var MT=i(5918);class ET extends Wi.A{constructor(e,t){super(e,t,new ji.J(MT.B,(()=>i.e(11798).then(i.bind(i,11798)))))}initializePipeline(){return(0,Xi.sm)({colorWrite:Xi.gf})}}var PT=i(57088);class RT extends Wi.A{constructor(e,t){super(e,t,new ji.J(PT.B,(()=>i.e(4e4).then(i.bind(i,4e4)))))}initializePipeline(){return(0,Xi.sm)({colorWrite:Xi.gf})}}var AT=i(47935);class OT extends Wi.A{constructor(e,t){super(e,t,new ji.J(AT.E,(()=>i.e(55428).then(i.bind(i,55428)))))}initializePipeline(){return(0,Xi.sm)({colorWrite:Xi.gf})}}class DT extends fr.K{}let IT=class extends wr.Z{constructor(e){super(e),this.produces="disabled",this.consumes={required:[dr.CM.ANTIALIASING],optional:[dr.lu.COMPOSITE]},this._areaTexture=null,this._searchTexture=null,this._smaaParameters=new DT}initialize(){this.addHandles([(0,_.YP)((()=>this.isEnabled()),(e=>e?this.enable():this.disable()),_.tX)])}async enable(){if(this.produces=dr.CM.ANTIALIASING,this._abortController||this._areaTexture&&this._searchTexture)return;this._abortController=new AbortController;const e=this._abortController.signal;try{const t=await i.e(49609).then(i.bind(i,34318));await this._loadTextures(t,e),this.requestRender(Cr.Xx.UPDATE)}catch{}this._abortController=null}async _loadTextures(e,t){(0,f.k_)(t);const[i,r]=await Promise.allSettled([(0,CT.t)(e.areaTexture,{signal:t}),(0,CT.t)(e.searchTexure,{signal:t})]);if((0,f.k_)(t),"fulfilled"!==i.status||"fulfilled"!==r.status)return;const n=this.renderingContext;this._areaTexture=LT(n,$i.cw.LINEAR,$i.VI.RGB,i.value),this._searchTexture=LT(n,$i.cw.NEAREST,$i.VI.LUMINANCE,r.value)}disable(){this.produces="disabled"}destroy(){this._searchTexture=(0,p.M2)(this._searchTexture),this._areaTexture=(0,p.M2)(this._areaTexture)}precompile(){this.techniques.precompile(OT),this.techniques.precompile(ET),this.techniques.precompile(RT)}render(e){const t=e.find((({name:e})=>e===dr.CM.ANTIALIASING));if(!this._areaTexture||!this._searchTexture)return this.requestRender(Cr.Xx.UPDATE),t;const i=this.techniques.get(OT),r=this.techniques.get(ET),n=this.techniques.get(RT);if(!i.compiled||!r.compiled||!n.compiled)return this.requestRender(Cr.Xx.UPDATE),t;const s=e.find((({name:e})=>e===dr.lu.COMPOSITE));if(!s)return t;const a=s.fbo.width,o=s.fbo.height,l=this.renderingContext;l.setViewport(0,0,a,o);const c=this.fboCache.acquire(a,o,"smaa edges",Td.qz.RG8UNORM);l.bindFramebuffer(c.fbo),l.setClearColor(0,0,0,1),l.clear($i.Hf.COLOR),this._smaaParameters.color=s.getTexture();const h=this.bindParameters;l.bindTechnique(i,h,this._smaaParameters),l.screen.draw();const u=this.fboCache.acquire(a,o,"smaa blend");return l.bindFramebuffer(u.fbo),l.setClearColor(0,0,1,1),l.clear($i.Hf.COLOR),this._smaaParameters.inputTexture=c.getTexture(),this._smaaParameters.areaTexture=this._areaTexture,this._smaaParameters.searchTexture=this._searchTexture,l.bindTechnique(r,h,this._smaaParameters),l.screen.draw(),c.release(),l.bindFramebuffer(t.fbo),l.setClearColor(0,1,0,1),l.clear($i.Hf.COLOR),this._smaaParameters.inputTexture=u.getTexture(),l.bindTechnique(n,h,this._smaaParameters),l.screen.draw(),u.release(),t}};function LT(e,t,i,r){const n=new ir.X;return n.pixelFormat=i,n.wrapMode=$i.e8.CLAMP_TO_EDGE,n.width=r.width,n.height=r.height,n.samplingMode=t,new Ed.x(e,n,r)}(0,r._)([(0,w.Cb)()],IT.prototype,"produces",void 0),(0,r._)([(0,w.Cb)()],IT.prototype,"consumes",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],IT.prototype,"isEnabled",void 0),(0,r._)([(0,w.Cb)()],IT.prototype,"_abortController",void 0),IT=(0,r._)([(0,x.j)("esri.views.3d.webgl-engine.effects.smaa.SMAA")],IT);var NT=i(46959),FT=i(1800),UT=i(92515);class HT extends fr.K{constructor(){super(...arguments),this.modelMatrix=(0,Bi.Ue)()}}class kT extends Wi.A{constructor(e,t){super(e,t,new ji.J(UT.S,(()=>i.e(3466).then(i.bind(i,3466)))))}initializePipeline(){return(0,Xi.sm)({blending:Xi.vf,depthTest:{func:$i.wb.LEQUAL},colorWrite:Xi.gf})}}let VT=class extends xr{constructor(){super(...arguments),this._starData=null,this._loadDataTask=null,this._numPoints=0,this._passParameters=new HT}initialize(){this.addHandles([(0,_.YP)((()=>this.view.environment.starsEnabled),(e=>e?this._enable():this._disable()),_.nn),(0,_.YP)((()=>"virtual"===this.view.environment.lighting.type?null:this.view.environment.lighting.date),(e=>this._update(e)),_.tX)])}_enable(){super._enable(),this._loadDataTask=this._createLoadDataTask()}get loading(){return!!this._loadDataTask&&!this._loadDataTask.finished}destroy(){this._loadDataTask=(0,p.IM)(this._loadDataTask),this._numPoints=0,this._vao=(0,p.M2)(this._vao),this._starData=null}precompile(){this.techniques.precompile(kT)}render(e){const t=e.find((({name:e})=>e===dr.CM.OPAQUE_ENVIRONMENT)),i=this.renderingContext;if(this.loading)return this.requestRender(Cr.Xx.UPDATE),t;if(!this._starData)return t;this._vao??=this._ensureResources(this._starData,i);const r=this.techniques.get(kT);return r.compiled?(i.bindTechnique(r,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays($i.MX.POINTS,0,this._numPoints),t):(this.requestRender(Cr.Xx.UPDATE),t)}_ensureResources(e,t){return this._numPoints=e.byteLength/jT,function(e,t,i,r){const n=WT.createBuffer(r),s=n.position,a=n.color,o=n.size;for(let e=0;e<r;e++){const r=t[2*e],n=t[2*e+1];s.set(e,0,-Math.cos(r)*Math.sin(n)),s.set(e,1,-Math.sin(r)*Math.sin(n)),s.set(e,2,-Math.cos(n));const l=zT(i[e]),c=BT(GT[l[1]]);a.set(e,0,255*c[0]),a.set(e,1,255*c[1]),a.set(e,2,255*c[2]),a.set(e,3,255),o.set(e,l[0])}return new Sr.U(e,Sd.i,new Map([["geometry",(0,vr.K)(WT)]]),new Map([["geometry",Mr.f.createVertex(e,$i.l1.STATIC_DRAW,n.buffer)]]))}(t,new Float32Array(e,0,2*this._numPoints),new Uint8Array(e,2*this._numPoints*4,this._numPoints),this._numPoints)}_update(e){if(!e)return;const t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,i=2*function(e){const t=e,i=new Date(e.getFullYear(),0,1,11,58,56);return(+t-+i)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+i)}(e),r=(0,Vi.JG)(this._passParameters.modelMatrix,ZT);(0,Vi.jI)(r,r,-i*Math.PI),(0,Vi.Jp)(r,qT,r),(0,Vi.jI)(r,r,-t*Math.PI),this.requestRender(Cr.Xx.UPDATE)}_createLoadDataTask(){if(this._starData)return null;const e=(0,me.vr)((async e=>{const{data:t}=await(0,FT.b)("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:e});(function(e){if(!e)throw new l.Z("stars:no-data-received","Failed to create stars because star catalogue is missing");const t=e.byteLength/jT;if(t%1!=0||t>5e4||t<5e3)throw new l.Z("stars:invalid-data","Failed to create stars because star catalogue data is invalid")})(t),this._starData=t}));return e.promise.catch((e=>{(0,f.D_)(e)||d.Z.getLogger(this).error(e)})).then((()=>{this.destroyed||this.requestRender(Cr.Xx.UPDATE)})),e}};function BT(e){return[parseInt(e.slice(0,2),16),parseInt(e.slice(2,4),16),parseInt(e.slice(4,6),16)]}function zT(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]}VT=(0,r._)([(0,x.j)("esri.views.3d.webgl-engine.effects.stars.Stars")],VT);const GT=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],qT=(0,Bi.al)(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),ZT=(0,Bi.al)(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),jT=9,WT=(0,br.U$)().vec3f(mr.T.POSITION).vec4u8(mr.T.COLOR).f32(mr.T.SIZE);var $T=i(65562),XT=i(25906),YT=i(93223);class KT extends Wi.A{constructor(e,t){super(e,t,new ji.J(YT.a,(()=>i.e(74498).then(i.bind(i,74498)))))}initializePipeline(){return(0,Xi.sm)({colorWrite:{r:!1,g:!0,b:!1,a:!1}})}}class QT{constructor(e,t){this._rctx=e,this._techniques=t,this._configuration=new rT.Z,this._passParameters=new $T.C,this._hudParameters=new YT.H,this._configuration.blitMode=rT.J.PremultipliedAlpha,this._techniques.precompile(XT.l,this._configuration),this._configuration.hasOpacityFactor=!0,this._techniques.precompile(XT.l,this._configuration),this._configuration.hasOpacityFactor=!1,this._configuration.blitMode=rT.J.Alpha,this._techniques.precompile(XT.l,this._configuration),this._configuration.blitMode=rT.J.Depth,this._techniques.precompile(XT.l,this._configuration),this._techniques.precompile(KT)}compositeHUD(e,t){this._hudParameters.texture=t;const i=this._techniques.get(KT);this._rctx.bindTechnique(i,e,this._hudParameters),this._rctx.screen.draw()}compositePreMultipliedAlpha(e,t,i=1){this._composite(e,t,rT.J.PremultipliedAlpha,i)}composite(e,t){this._composite(e,t,rT.J.Alpha,1)}blitDepthToLinearDepth(e,t){this._composite(e,t,rT.J.Depth,1)}_composite(e,t,i,r){this._configuration.blitMode=i,this._configuration.hasOpacityFactor=1!==r,this._passParameters.texture=t,this._passParameters.opacity=r;const n=this._techniques.get(XT.l,this._configuration);this._rctx.bindTechnique(n,e,this._passParameters),this._rctx.screen.draw()}}var JT=i(86236);class eS{constructor(){this.declaredClass="esri.views.3d.webgl-engine.lib.ObjectAndLayerIdRenderHelper",this.colorZero=new _v.mc(new ArrayBuffer(4)),this._layerToOidToColor=new Iw.r,this._colorToUID=new Map,this._layerViewUidToGraphicsUidToObjectId=new Iw.r,this._layerViewUidToLayerId=new Map,this._layerViewUidToPopupEnabled=new Map}setUidToObjectAndLayerId(e,t,i,r,n,s=null,a=null,o=null){e&&t&&i&&r&&(this._layerViewUidToLayerId.set(r,i),this._layerViewUidToPopupEnabled.set(r,n),n&&this._layerViewUidToGraphicsUidToObjectId.set(r,t,{objectId:e,attributeNodeId:s,attributeIndex:a,subLayerId:o}))}getObjectAndLayerIdColor(e){const t=this.getObjectAndLayerIdColorArray(e);return(0,tc.al)(t.get(0,1),t.get(0,2),t.get(0,3),255)}getObjectAndLayerIdColorArray(e){if(!e.layerViewUid||!e.graphicUid)return this.colorZero;const t=this._layerViewUidToPopupEnabled.get(e.layerViewUid);if(void 0===t)return this.colorZero;if(!1===t)return this.colorZero;const i=this._layerViewUidToGraphicsUidToObjectId.get(e.layerViewUid,e.graphicUid)?.objectId;if(!i)return this.colorZero;let r=this._layerToOidToColor.get(e.layerViewUid,i);if(!r){if((0,u.Z)("enable-feature:objectAndLayerId-screenshot-testing"))r=i;else for(;!r;){const e=Math.floor(16777214*Math.random())+1;this._colorToUID.has(e)||(r=e)}if(r>16777215)throw new Error("Object ID Overflow");this._layerToOidToColor.set(e.layerViewUid,i,r),this._colorToUID.set(r,e)}const n=new ArrayBuffer(4);return new DataView(n).setUint32(0,r,!1),new _v.mc(n)}getColorToObjectAndLayerIdMapping(){const e=new Map;for(const[t,i]of this._colorToUID.entries()){const r=this._layerViewUidToGraphicsUidToObjectId.get(i.layerViewUid,i.graphicUid),n=this._layerViewUidToLayerId.get(i.layerViewUid);r&&n&&e.set(t,r.attributeNodeId?{type:"object-and-layer-and-i3s-id",olid:r.objectId,lid:n,attrId:r.attributeNodeId,attrIdx:r.attributeIndex,subLayerId:r.subLayerId}:{type:"object-and-layer-id",olid:r.objectId,lid:n})}return e}}var tS,iS=i(43280);class rS{constructor(e,t){this.key=e,this._free=t,this.incarnation=0,this._refCount=1}retain(e=1){this._refCount+=e}release(){return 0===this._refCount?(console.log(`Releasing already released FBO attachment "${this.name}" in ${(new Error).stack}`),!0):(--this._refCount,0===this._refCount&&(this._free(),!0))}}!function(e){e[e.FBO=0]="FBO",e[e.DEPTH=1]="DEPTH",e[e.COLOR=2]="COLOR"}(tS||(tS={}));class nS extends rS{constructor(e,t,i){super(e,i),this.attachment=t,this.name=""}dispose(){this.attachment.dispose()}get cachedMemory(){return this.attachment.usedMemory}}class sS extends nS{constructor(e,t,i){super(e,t,i),this.attachment=t,this.type=tS.COLOR}}class aS extends nS{constructor(){super(...arguments),this.type=tS.DEPTH}}var oS=i(29870);class lS extends aS{constructor(e,t,i){super(e,t,i),this.attachment=t}}class cS extends rS{constructor(e,t,i,r,n,s){super(e,s),this.fbo=i,this.type=tS.FBO,this._colors=new Map,this._name=dr.lu.COMPOSITE,this.acquireColor=null,this.acquireDepth=null,this._name=t,this.acquireColor=r,this.acquireDepth=n}dispose(){this.fbo?.dispose()}get cachedMemory(){return this.fbo?.usedMemory||0}get numberOfColorAttachments(){return this._colors.size}get name(){return this._name}setName(e){this._name=e}getTexture(e=$i.Ii){return e===$i.Lu?this.fbo?.depthStencilTexture:this.fbo?.getColorTexture(e)}get depthTexture(){return this.getTexture($i.Lu)}getAttachment(e=$i.Ii){return e===$i.Lu?this._depth:this._colors.get(e)}hasAttachment(e){return(0,Ue.oE)(this._colors,(t=>t.name===e))}attachDepth(e){return e?.retain(),this.detachDepth(),e&&this.fbo?.attachDepthStencil(e.attachment),this._depth=e,this}detachDepth(){this.fbo?.detachDepthStencilTexture(),this.fbo?.detachDepthStencilBuffer(),this._depth=(0,p.RY)(this._depth)}obtainDepthTexture(){const e=this._depth;return function(e){return e?.attachment.type===oS.R.Texture}(e)?(this.fbo?.detachDepthStencilTexture(),this._depth=null,e):null}attachColor(e,t){return e.retain(),this.detachColor(t),this.fbo?.attachColorTexture(e.attachment,t),this._colors.set(t,e),this}detachColor(e){this.fbo?.detachColorTexture(e);const t=this._colors.get(e);this._colors.delete(e),t?.release()}detachAllColors(){this._colors.forEach(((e,t)=>this.detachColor(t)))}detachAll(){this.detachAllColors(),this.detachDepth()}detachAllColorsBut0(){this._colors.forEach(((e,t)=>{t!==$i.Ii&&this.detachColor(t)}))}detachAllButColor0(){this.detachAllColorsBut0(),this.detachDepth()}}class hS{constructor(e,t){this._last=new cd.Z,this._incarnation=0,this._cache=new H_(e,t)}destroy(){this._last?.forAll((e=>e.dispose())),this._last=null,this._cache.destroy()}set interactive(e){e&&!this._last?this._last=new cd.Z:e||(this._last?.forAll((e=>e.dispose())),this._last=null)}clean(){this._last?.filterInPlace((e=>!(e.incarnation<this._incarnation&&(this._cache.put(e.key,e),1))))}frame(){++this._incarnation}pop(e){if(this._last){const t=this._last.find((t=>t.key===e));if(t)return this._last.removeUnordered(t),t}return this._cache.pop(e)}put(e){e.incarnation=this._incarnation,this._last?this._last.push(e):this._cache.put(e.key,e)}get usedMemory(){return this._last?.reduce(((e,t)=>e+t.cachedMemory),0)??0}}class uS{constructor(e){this.rctx=e,this._interactive=!1,this._acquired=new Set,this._cache=new hS(e.newCache,"FBOCache"),this._depthCache=new hS(e.newCache,"DepthAttachmentCache"),this._colorCache=new hS(e.newCache,"ColorAttachmentCache")}destroy(){this._cache.destroy(),this._depthCache.destroy(),this._colorCache.destroy()}clean(){this._cache.clean(),this._colorCache.clean(),this._depthCache.clean()}frameStart(){this._cache.frame(),this._colorCache.frame(),this._depthCache.frame(),this.debugCallback?.()}frameEnd(){const{debugCallback:e}=this;e&&this._acquired.forEach((t=>e(t.name,t.fbo)))}get usedMemory(){return Array.from(this._acquired.values()).reduce(((e,t)=>e+t.cachedMemory),this._cache.usedMemory+this._colorCache.usedMemory+this._depthCache.usedMemory)}set interactive(e){this._cache.interactive=this._colorCache.interactive=this._depthCache.interactive=e,this._interactive=e}get interactive(){return this._interactive}acquire(e,t,i,r=Td.qz.RGBA8UNORM){const n=fS(r,e,t);let s=this._cache.pop(n);const{rctx:a}=this;if(s){s.retain(),s.setName(i);const e=s.getAttachment($i.Lu);e&&(e.name=pS(i));const t=s.getAttachment($i.Ii);t&&(t.name=dS(i,0));const{fbo:r}=s;if(!r)throw new l.Z("renderer","attempt to use a none existing framebuffer");a.temporaryBindFramebufferObject(r,(()=>{a.setDrawBuffers([$i.Ii]),a.unbindTexture(r.colorTexture)}))}else{const o=new tr.X(a),l=(i,r,n)=>{r??=Td.qz.RGBA8UNORM;const a=this._acquireColor(r,e,t,n??dS(s.name,i-$i.Ii));return this.rctx.unbindTexture(a.attachment),s.attachColor(a,i),a.release(),s},c=i=>{i??=Td.qk.DEPTH24_STENCIL8;const r=this.acquireDepth(i,e,t,pS(s.name));return s.attachDepth(r),r.release(),s},h=()=>{this.debugCallback?.(s.name,s.fbo),this._acquired.delete(s);const e=(0,Td.NY)(r);e&&null!=s?.getAttachment($i.Lu)||!e&&null!=s?.getAttachment($i.Ii)?(e?(s.fbo?.invalidateAttachments([$i.Lu]),s.detachAllColors()):(s.fbo?.invalidateAttachments([$i.Ii]),s.detachAllButColor0()),this._cache.put(s)):s?.dispose()};s=new cS(n,i,o,l,c,h),(0,Td.NY)(r)?s.acquireDepth(r):s.acquireColor($i.Ii,r,i)}return this._trackHandle(s)}acquireDepth(e,t,i,r){const n=fS(e,t,i);let s=this._depthCache.pop(n);if(s)s.retain(),s.attachment.setShadowFiltering(!1);else{const r=new Ed.x(this.rctx,{...Td.gg[e],width:t,height:i});s=new lS(n,r,(()=>this._depthCache.put(s)))}return s.name=r,s}_acquireColor(e,t,i,r){const n=fS(e,t,i);let s=this._colorCache.pop(n);if(s)s.retain();else{const r=new Ed.x(this.rctx,{...Td.cc[e],width:t,height:i});s=new sS(n,r,(()=>this._colorCache.put(s)))}return s.name=r,s}_trackHandle(e){return this._acquired.add(e),e}}function dS(e,t=0){return`${e}.color${t}`}function pS(e){return`${e}.depth`}const mS=new cS("default","default",null,(()=>mS),(()=>mS),(()=>{}));function fS(e,t,i){return`${t}x${i}:${e}`}mS.release=()=>!1;var _S,gS=i(74222),yS=i(33610);!function(e){e[e.FrontToBack=0]="FrontToBack",e[e.BackToFront=1]="BackToFront"}(_S||(_S={}));class vS{constructor(e,t,i=_S.FrontToBack){this._rctx=e,this._techniques=t,this._sorting=i,this._draws=new cd.Z({allocator:e=>e??{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._previouslyBoundDraw=new Map}submitDraw(e,t,i,r,n){const s=this._draws.pushNew();s.geometry=t,s.geometryRanges=i,s.material=e,s.depthSquaredHint=r,s.indexType=(t.indexed?t.vao.indexBuffer.indexType:null)??0,s.highlightName=n}acquire(e,t){return this._draws.map((i=>i.material.acquireTechnique(this._techniques,e,t,i.geometry.parameters)))}dispatch(e,t,i){const r=this._rctx;this._previouslyBoundDraw.clear();let n=null;const s=this._draws.length,a=t.highlight?.name;for(let o=0;o<s;o++){const s=this._draws.data[o];if(e.identifier===gS.o.Highlight){const e=s.highlightName;if(e){if(e!==a)continue}else if(!a||!t.overlay?.hasHighlight(a))continue}const l=i[o];l===n&&t.oitPass===yS.M.NONE||(r.bindTechnique(l,t,e),n=l);const{geometryRanges:c,indexType:h,geometry:u,material:d}=s;r.bindVAO(u.vao),this._previouslyBoundDraw.get(l)!==d&&(l.program.bindDraw(t,e,d),this._previouslyBoundDraw.set(l,d));const p=c.length,{primitiveType:m}=u;for(let e=0;e<p;e+=2){const t=c[e],i=c[e+1];if(0!==h){const e=bS.get(h);r.drawElements(m,i,h,t*e)}else r.drawArrays(m,t,i)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=this._sorting===_S.FrontToBack?1:-1;this._draws.sort(((t,i)=>e*(t.depthSquaredHint-i.depthSquaredHint)||t.geometry.vao.usedMemory-i.geometry.vao.usedMemory))}get count(){return this._draws.length}}const bS=new Map;bS.set($i.g.UNSIGNED_BYTE,1),bS.set($i.g.UNSIGNED_SHORT,2),bS.set($i.g.UNSIGNED_INT,4);var wS=i(48737);class CS{constructor(e){const t=e.renderContext.rctx,i=e.techniques;this.opaque=new vS(t,i),this.transparent=new vS(t,i,_S.BackToFront),this.integratedMesh=new vS(t,i),this.occludedGround=new vS(t,i),this.shadowMap=new vS(t,i),this.highlight=new vS(t,i),this.highlightIntegratedMesh=new vS(t,i),this.highlightShadowMap=new vS(t,i),this.viewshedShadowMap=new vS(t,i),this.defaultShadowMap=new vS(t,i)}}class xS extends wS.d4{constructor(){super(...arguments),this.slicePlaneLocalOrigin=(0,R.Ue)(),this.origin=this.slicePlaneLocalOrigin}}class TS extends xS{constructor(){super(...arguments),this.identifier=gS.o.Material,this.output=qb.H_.Color,this.transparent=!1,this.occludedGround=!1}}class SS extends xS{constructor(){super(...arguments),this.identifier=gS.o.ShadowMap}}class MS extends xS{constructor(){super(...arguments),this.identifier=gS.o.Highlight}}class ES extends xS{constructor(){super(...arguments),this.identifier=gS.o.ViewshedShadowMap}}var PS=i(20022);let RS=class extends Ir.tY{constructor(){super({}),this.produces=new Map([[$b.r.OPAQUE_MATERIAL,e=>this._produces(e,$b.r.OPAQUE_MATERIAL)],[$b.r.TRANSPARENT_MATERIAL,e=>this._produces(e,$b.r.TRANSPARENT_MATERIAL)],[$b.r.INTEGRATED_MESH,e=>this._produces(e,$b.r.INTEGRATED_MESH)],[$b.r.OCCLUDED_GROUND,e=>this._produces(e,$b.r.OCCLUDED_GROUND)]]),this._materialPassParameters=new TS,this._shadowPassParameters=new SS,this._highlightPassParameters=new MS,this._viewshedPassParameters=new ES,this._systems=new Set}initializeRenderContext(e){this._context=e,this._passes=new CS(e)}get rctx(){return this._context.renderContext.rctx}uninitializeRenderContext(){}dispose(){this._context=null,this._systems.clear()}register(e){this._systems.add(e)}_produces(e,t){return!!this._invoke(e,t,(e=>e.count>0))}prepareRender(e){const{_systems:t,_passes:i}=this;if(0!==t.size&&null!=i){for(const e of Object.values(i))e.prepareSubmit();t.forEach((t=>t.submit(i,e.bind)));for(const e of Object.values(i))e.finishSubmit()}}acquireTechniques(e){if(0===this._systems.size)return null;const t=e.output===qb.H_.Shadow||e.output===qb.H_.ShadowHighlight||e.output===qb.H_.ShadowExcludeHighlight?this._shadowPassParameters:e.output===qb.H_.ViewshedShadow?this._viewshedPassParameters:e.output===qb.H_.Highlight?this._highlightPassParameters:this._materialPassParameters,i=e.bind;return this._updateParameters(i.camera,t,i.slot),this._materialPassParameters.output=e.output,this._invoke(e.output,e.bind.slot,((t,i)=>t.acquire(i,e.bind)))}render(e,t){this._invoke(e.output,e.bind.slot,((i,r)=>i.dispatch(r,e.bind,t)))}_invoke(e,t,i){if(null==this._passes)return null;switch(t){case $b.r.OPAQUE_MATERIAL:switch(e){case qb.H_.Color:case qb.H_.ColorEmission:case qb.H_.Depth:case qb.H_.Normal:case qb.H_.ObjectAndLayerIdColor:return i(this._passes.opaque,this._materialPassParameters);case qb.H_.Highlight:return i(this._passes.highlight,this._highlightPassParameters);case qb.H_.Shadow:return i(this._passes.shadowMap,this._shadowPassParameters);case qb.H_.ShadowHighlight:return i(this._passes.highlightShadowMap,this._shadowPassParameters);case qb.H_.ShadowExcludeHighlight:return i(this._passes.defaultShadowMap,this._shadowPassParameters);case qb.H_.ViewshedShadow:return i(this._passes.viewshedShadowMap,this._viewshedPassParameters)}break;case $b.r.TRANSPARENT_MATERIAL:switch(e){case qb.H_.Color:case qb.H_.ColorEmission:case qb.H_.Depth:case qb.H_.Normal:case qb.H_.ObjectAndLayerIdColor:return i(this._passes.transparent,this._materialPassParameters)}break;case $b.r.INTEGRATED_MESH:switch(e){case qb.H_.Color:case qb.H_.ColorEmission:case qb.H_.Depth:case qb.H_.Normal:case qb.H_.ObjectAndLayerIdColor:return i(this._passes.integratedMesh,this._materialPassParameters);case qb.H_.Highlight:return i(this._passes.highlightIntegratedMesh,this._highlightPassParameters)}break;case $b.r.OCCLUDED_GROUND:switch(e){case qb.H_.Color:case qb.H_.ColorEmission:case qb.H_.Depth:case qb.H_.Normal:case qb.H_.ObjectAndLayerIdColor:return i(this._passes.occludedGround,this._materialPassParameters)}}return null}notifyDirty(){this._context.requestRender()}queryDepthRange(e){const t=new Pm.P;return this._systems.forEach((i=>t.union(i.queryDepthRange(e)))),t}get hasEmissions(){let e=!1;return this._systems.forEach((t=>e=t.hasEmissions||e)),e}_updateParameters(e,t,i){const r=e.viewInverseTransposeMatrix,n=i===$b.r.TRANSPARENT_MATERIAL,s=i===$b.r.OCCLUDED_GROUND;(0,Pi.i)(AS,r[3],r[7],r[11]),DS.set(AS),(0,Pi.c)(t.transformWorldFromViewTH,DS.high),(0,Pi.c)(t.transformWorldFromViewTL,DS.low),(0,Pi.c)(t.slicePlaneLocalOrigin,AS),(0,ki.xO)(t.transformViewFromCameraRelativeRS,e.viewMatrix),(0,Vi.JG)(t.transformProjFromView,e.projectionMatrix),t.identifier===gS.o.Material&&(this._materialPassParameters.transparent=n,this._materialPassParameters.occludedGround=s,(0,ki.p4)(OS,t.transformViewFromCameraRelativeRS),(0,ki.U_)(t.transformNormalViewFromGlobal,OS))}hasHighlight(e){for(const t of this._systems)if(t.hasHighlight(e))return!0;return!1}};RS=(0,r._)([(0,x.j)("esri.views.3d.webgl-engine.core.renderPasses.RenderPassManager")],RS);const AS=(0,R.Ue)(),OS=(0,Ea.Ue)(),DS=new PS.I;var IS=i(36553);var LS=i(13e3);class NS{constructor(e){this._context=e,this._nodes=new cd.Z}destroy(){this._nodes.forEach((e=>e.destroy())),this._nodes.clear()}add(e){this._nodes.push(e),LS.CM&&console.log(`Registered render nodes: ${this._nodes.map((({declaredClass:e})=>e)).join(", ")}`)}remove(e){this._nodes.remove(e),LS.CM&&console.log(`Registered render nodes: ${this._nodes.map((({declaredClass:e})=>e)).join(", ")}`)}produces(e){return this._nodes.some((({produces:t})=>t===e))}require(e,...t){const i=this._nodes,r=t=>i.reduce(((i,{consumes:r,produces:n})=>i+(!r.required.includes(e)||null!=t&&n!==t?0:1)),0);return 0===t.length?r():t.reduce(((e,t)=>e+r(t)),0)}optional(e,...t){const i=this._nodes,r=t=>i.reduce(((i,{consumes:r,produces:n})=>i+(!r.optional?.includes(e)||null!=t&&n!==t?0:1)),0);return 0===t.length?r():t.reduce(((e,t)=>e+r(t)),0)}updateAnimation(e){return this._nodes.reduce(((t,i)=>i.updateAnimation(e)||t),!1)}precompile(...e){++this._context.techniques.precompiling;for(const t of e)this._nodes.forEach((e=>{e.produces===t&&e.precompile()}));--this._context.techniques.precompiling}render(e,t,i=(()=>{})){return this._render(e,t,i)??(function(e){return e.name}(e)?e:mS)}produce(e,t,i=(()=>{})){return this._render(e,t,i)}_render(e,t,i=(()=>{})){const r="string"==typeof e?e:e.name,n=this._nodes.filter((({produces:e})=>e===r));if(0===n.length)return;let s="string"==typeof e?null:e;return n.some((e=>{const n=s?[s]:[],a=null==s;for(const s of e.consumes.required){if(s===r){if(a)return!1;continue}const e=t.get(s);if(e)n.push(e);else if("emissive"!==s||!t.get(r)?.hasAttachment(s))return i?.(n),!1}if(e.consumes.optional)for(const i of e.consumes.optional){if(i===r)continue;const e=t.get(i);e&&n.push(e)}try{const i=e.doRender(n);i&&i!==s&&(r!==i.name&&(d.Z.getLogger(e).errorOnce(`RenderNode produced ${i.name}, expected ${r}`),i.setName(r)),s?.release(),s=i,t.set(r,s))}catch(t){d.Z.getLogger(e).errorOnce(t)}return i?.(n),a&&null!=s})),this._context.rctx.enforceState(),s}requireGeometryDepth(){return this._nodes.some((e=>"disabled"!==e.produces&&e.requireGeometryDepth))}get test(){return{nodes:this._nodes}}}class FS{constructor(e){this.context=e,this._renderPlugins=new cd.Z,this._slots=new Array,this._version=(0,Di.t)(0);for(let e=0;e<$b.r.MAX_SLOTS;++e)this._slots[e]=[]}destroy(){this._renderPlugins.forEach((e=>e.destroy())),this._renderPlugins.clear()}get plugins(){return this._renderPlugins}add(e,t){const i=()=>{if(t?.aborted)throw e.uninitializeRenderContext(),(0,f.zE)();this._renderPlugins.push(e),e.produces.forEach(((t,i)=>this._slots[i].push(e))),this.context.requestRender(),this._version.value++},r=e.initializeRenderContext(this.context,t);if((0,f.y8)(r))return r.then(i);i()}remove(e){this._renderPlugins.removeUnordered(e),e.uninitializeRenderContext();for(let t=0;t<this._slots.length;++t)this._slots[t]=this._slots[t].filter((t=>t!==e));this.context.requestRender(),this._version.value++}prepareRender(){this._renderPlugins.forAll((e=>{e.prepareRender&&e.prepareRender(this.context.renderContext)}))}updateAnimation(e){let t=!1;return this._renderPlugins.forAll((i=>t=i.updateAnimation?.(e)||t)),t}precompile(...e){++this.context.techniques.precompiling;const t=this.context.renderContext.bind.slot;for(const t of e)this.context.renderContext.bind.slot=t,this._forEachRender((()=>{}));this.context.renderContext.bind.slot=t,--this.context.techniques.precompiling}render(...e){for(const t of e)this.context.renderContext.bind.slot=t,this._forEachRender(((e,t)=>e.render(this.context.renderContext,t)))}_forEachRender(e){const t=this.context.renderContext.bind.slot,i=this.context.renderContext.output;this._slots[t].forEach((r=>{if(!r.produces.get(t)?.(i)||r.isDecoration&&!this.context.renderContext.bind.decorations)return;const n=r.acquireTechniques(this.context.renderContext);n&&e(r,n)}))}queryDepthRange(e){const t=new Pm.P;return this._renderPlugins.forAll((i=>{const r=i.queryDepthRange?.(e);t.union(r)})),t}get updating(){return this._version.value>=0&&this._renderPlugins.some((e=>e.running))}produces(e,...t){return t.some((t=>this._slots[t].some((i=>{const r=i.produces.get(t);return!!r&&r(e)}))))}consumes(e){return this._renderPlugins.some((t=>t.consumes().required.includes(e)))}hasHighlight(e){return US.some((t=>this._slots[t].some((t=>t.hasHighlight(e)))))}get hasDecorations(){return this._renderPlugins.some((e=>e.isDecoration))}get hasOccludees(){return this._renderPlugins.some((e=>e.hasOccludees))}get hasEmissions(){return this._renderPlugins.some((e=>e.hasEmissions))}get renderOccludedFlags(){return this._renderPlugins.reduce(((e,t)=>e|(t.renderOccludedFlags??Wb.yD.None)),Wb.yD.None)}get usedMemory(){return this._renderPlugins.reduce(((e,t)=>t.material?e:e+(t.usedMemory??0)),0)}get test(){}}const US=[$b.r.OPAQUE_MATERIAL,$b.r.TRANSPARENT_MATERIAL,$b.r.DRAPED_MATERIAL,$b.r.HUD_MATERIAL,$b.r.LABEL_MATERIAL];var HS=i(3931);class kS extends Wi.A{constructor(e,t){super(e,t,new ji.J(HS.a,(()=>i.e(79490).then(i.bind(i,79490)))))}initializePipeline(e){return(0,Xi.sm)({blending:Xi.vf,colorWrite:Xi.gf,drawBuffers:e.hasEmission?{buffers:[$i.Ii,$i.Ml]}:{buffers:[$i.Ii]}})}}class VS extends tb.m{constructor(){super(...arguments),this.hasEmission=!1}}(0,r._)([(0,tb.o)()],VS.prototype,"hasEmission",void 0);class BS{constructor(e){this._techniques=e,this._parameters=new HS.O,this._configuration=new VS,e.precompile(kS,this._configuration),this._configuration.hasEmission=!0,e.precompile(kS,this._configuration)}blend(e,t,i,r,n){this._parameters.colorTexture=t.getTexture(),n&&(this._parameters.emissionTexture=t.getTexture($i.Ml),this._parameters.emissionFrontFaceTexture=i.getTexture($i.Ml)),this._parameters.alphaTexture=t.getTexture(n?$i.FF:$i.Ml),this._parameters.frontFaceTexture=i.getTexture(),this._configuration.hasEmission=n;const s=this._techniques.get(kS,this._configuration);e.bindTechnique(s,r,this._parameters),e.screen.draw()}}class zS{constructor(e,t){this._camera=e,this._dt=(0,ur.HA)(0),this._time=(0,ur.HA)(0),this._lastUpdate=(0,ur.HA)(0),this._lastUpdate=t,this._time=t}advance(e,t,i){const r=(0,ur.HA)(t-this._lastUpdate);this._dt=(0,ur.HA)(r/i),this._time=(0,ur.HA)(this._time+r),this._lastUpdate=t,this._camera=e}get camera(){return this._camera}get dt(){return this._dt}get time(){return this._time}}class GS{constructor(){this._step=XS,this._dilation=1,this._firstIdleTime=(0,ur.HA)(0)}frame(e,t){if(t?0===this._firstIdleTime&&(this._firstIdleTime=(0,ur.HA)(performance.now())):this._firstIdleTime=(0,ur.HA)(0),(0,u.Z)("disable-feature:high-quality-idle"))this._dilation=1;else{const e=t?performance.now()-this._firstIdleTime:0;if(e>=ZS+jS)return this._step=(0,ur.HA)(1/0),void(this._dilation=1);this._dilation=e>=ZS?WS:1}const i=(0,st.uZ)(e/qS,XS,YS);this._step===1/0?this._step=(0,ur.HA)(i):this._step=(0,ur.HA)(this._step*$S+i*(1-$S))}get value(){return this._step}get timeDilation(){return this._dilation}clear(){this._step=this._firstIdleTime=(0,ur.HA)(0)}}const qS=.5,ZS=(0,ur.HA)(12e4),jS=(0,ur.HA)(1e4),WS=10,$S=.9,XS=(0,ur.HA)(1e3),YS=(0,ur.HA)(1e3/30);var KS,QS=i(45953),JS=i(33641);!function(e){e[e.SHADOW_CASTERS=0]="SHADOW_CASTERS",e[e.FULL_SCENE=1]="FULL_SCENE"}(KS||(KS={}));function eM(e,t,i,r){let n=0;if(!t.some((e=>!!e.material&&(n+=e.numGeometries,n>=1e4))))return dM.compute(e,t,r);const s=new Pm.P;return i.forAll((t=>s.union(function(e,t){if(!t.visible)return;const i=new Pm.P,r=t.getSpatialQueryAccelerator();return r?function(e,t,i){const{eye:r,viewForward:n,frustum:s}=t,a=e=>e.visible,o=i.objectCount;if(o<500)hM.set(t.near,Math.min(e.near,t.far)),i.forEachInDepthRange(r,n,JS.Z.DepthOrder.FRONT_TO_BACK,hM,((i,r)=>{tM(e,t,i),hM.far=e.near,r.setRange(hM)}),s,a),hM.set(Math.max(e.far,t.near),t.far),i.forEachInDepthRange(r,n,JS.Z.DepthOrder.BACK_TO_FRONT,hM,((i,r)=>{tM(e,t,i),hM.near=e.far,r.setRange(hM)}),s,a);else{const r=Math.max(Math.min(o,500),Math.ceil(.1*o)),l=i.findClosest(n,JS.Z.DepthOrder.FRONT_TO_BACK,s,a,r),c=i.findClosest(n,JS.Z.DepthOrder.BACK_TO_FRONT,s,a,r);l&&c&&(rM(e,t,l.boundingVolumeWorldSpace.bounds),rM(e,t,c.boundingVolumeWorldSpace.bounds))}}(i,e,r):function(e,t,i){uM.clear(),i.forEach((e=>{e.visible&&0!==e.geometries.length&&uM.add(e)})),uM.empty||(uM.sort(t),hM.set(t.near,Math.min(e.near,t.far)),uM.forEachInDepthRange(hM,JS.Z.DepthOrder.FRONT_TO_BACK,((i,r)=>{r<e.near&&tM(e,t,i)})),hM.set(Math.max(e.far,t.near),t.far),uM.forEachInDepthRange(hM,JS.Z.DepthOrder.BACK_TO_FRONT,((t,i,r)=>{e.far=Math.max(e.far,r)})))}(i,e,t.objects),i}(e,t)))),s}function tM(e,t,i){if(!i.visible)return;if(!(0,_c.hr)(t.frustum,i.boundingVolumeWorldSpace.bounds))return;const r=i.transformation,n=cM;i.geometries.forEach((i=>{(0,Vi.Jp)(n,r,i.transformation);const s=(0,gi.u1)(n);iM(e,t,i.boundingInfo,n,s)}))}function iM(e,t,i,r,n){if(null==i)return;(0,Pi.t)((0,es.a)(lM),i.center,r);const{eye:s,viewForward:a}=t,o=a[0]*(lM[0]-s[0])+a[1]*(lM[1]-s[1])+a[2]*(lM[2]-s[2]);if(lM[3]=i.radius*n,!(o-lM[3]>e.near&&o+lM[3]<e.far)&&(0,_c.hr)(t.frustum,lM))if(i.radius>100&&i.getChildren())for(const s of i.getChildren())iM(e,t,s,r,n);else pM.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,r,i.bbMin,i.bbMax)}function rM(e,t,i){const r=t.eye,n=t.viewForward,s=(i[0]-r[0])*n[0]+(i[1]-r[1])*n[1]+(i[2]-r[2])*n[2];e.near=Math.min(e.near,s-i[3]),e.far=Math.max(e.far,s+i[3])}function nM(e,t,i){let r=[e,t,i];for(let e=0;e<4;++e){const t=r;r=[];for(let i=0;i<t.length;++i){const n=t[i],s=t[(i+1)%t.length];sM(s,e)?(sM(n,e)||r.push(aM(n,s,e)),r.push(s)):sM(n,e)&&r.push(aM(n,s,e))}}return r}function sM(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void(0,Mf.hu)(!1)}function aM(e,t,i){let r=0;return 0===i?r=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===i?r=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===i?r=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===i&&(r=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),(0,ec.l)((0,tc.Ue)(),e,t,r)}const oM=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],lM=(0,es.c)(),cM=(0,Bi.Ue)(),hM=new Pm.P,uM=new class{constructor(){this._items=new cd.Z({allocator:e=>e||{object:null,distance:0,near:0,far:0},deallocator:e=>(e.object=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return 0===this._items.length}clear(){this._items.clear()}add(e){this._items.pushNew().object=e}sort(e){const t=e.eye,i=e.viewForward;this._items.forAll((e=>{const r=e.object.boundingVolumeWorldSpace.bounds,n=(r[0]-t[0])*i[0]+(r[1]-t[1])*i[1]+(r[2]-t[2])*i[2];e.distance=n,e.near=n-r[3],e.far=n+r[3]})),this._items.sort(((e,t)=>e.distance-t.distance))}forEachInDepthRange(e,t,i){if(t===JS.Z.DepthOrder.FRONT_TO_BACK)for(let t=0;t<this._items.length;++t){const r=this._items.data[t];r.far<e.near||r.near>e.far||i(r.object,r.near,r.far)}else for(let t=this._items.length-1;t>=0;--t){const r=this._items.data[t];r.far<e.near||r.near>e.far||i(r.object,r.near,r.far)}}},dM=new class{constructor(){this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange=new Pm.P(0,0)}compute(e,t,i){this._reset();const{viewMatrix:r}=e;t.forAll((e=>{e.forEachGeometry((e=>{if(!e.visible||i===KS.SHADOW_CASTERS&&!e.castShadow)return;const t=e.boundingSphere,n=r[2]*t[0]+r[6]*t[1]+r[10]*t[2]+r[14],s=n-t[3],a=n+t[3];this._geometries.push(e),this._near.push(-a),this._far.push(-s)}))}));const n=new Pm.P;if(0===this._geometries.length)return n;for(let e=0;e<this._geometries.length;++e)this._near[e]>n.far&&(n.far=this._near[e]),this._near[e]>2&&this._far[e]<n.near&&(n.near=this._far[e]);const s=this._looseRange;s.near=Math.max(.5*n.near,2),s.far=2*n.far;let a=0,o=0;for(let e=0;e<this._geometries.length;++e)this._near[e]<n.near&&(this._near[e]>=s.near?n.near=this._near[e]:this._nearCandidates[a++]=e),this._far[e]>n.far&&(this._far[e]<=s.far?n.far=this._far[e]:this._farCandidates[o++]=e);if(0===this._nearCandidates.length&&0===this._farCandidates.length)return n;this._nearCandidates.sort(((e,t)=>this._near[e]<this._near[t]?-1:this._near[e]>this._near[t]?1:0)),this._farCandidates.sort(((e,t)=>this._far[e]<this._far[t]?1:this._far[e]>this._far[t]?-1:0));for(let t=0;t<this._nearCandidates.length;++t){const i=this._nearCandidates[t];if(this._near[i]<n.near){const t=this._geometries[i],{boundingInfo:r,shaderTransformation:s}=t;this._includeNearBoundingInfoRec(e,r,s,n)}}for(let t=0;t<this._farCandidates.length;++t){const i=this._farCandidates[t];if(this._far[i]>n.far){const t=this._geometries[i],{boundingInfo:r,shaderTransformation:s}=t;this._includeFarBoundingInfoRec(e,r,s,n)}}return this._reset(),n}_reset(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}_isOutsideSidePlanes(e,t){const i=(0,es.a)(e),r=(0,es.g)(e);return t[0][0]*i[0]+t[0][1]*i[1]+t[0][2]*i[2]+t[0][3]>r||t[1][0]*i[0]+t[1][1]*i[1]+t[1][2]*i[2]+t[1][3]>r||t[2][0]*i[0]+t[2][1]*i[1]+t[2][2]*i[2]+t[2][3]>r||t[3][0]*i[0]+t[3][1]*i[1]+t[3][2]*i[2]+t[3][3]>r}_includeNearBoundingInfoRec(e,t,i,r){if(null==t)return;const n=t.center;(0,Pi.t)((0,es.a)(lM),n,i),lM[3]=t.radius*(0,gi.u1)(i);const{frustum:s}=e;if(this._isOutsideSidePlanes(lM,s))return;const a=lM[0],o=lM[1],l=lM[2],c=lM[3],{viewMatrix:h}=e,u=h[2]*a+h[6]*o+h[10]*l+h[14],d=u+c;if(!(-(u-c)<2||-d>=r.near))if(-d>this._looseRange.near)r.near=-d;else{if(c>100){const n=t.getChildren();if(void 0!==n){for(const t of n)this._includeNearBoundingInfoRec(e,t,i,r);return}}pM.unionDepthRangeWithAABB(r,e.viewProjectionMatrix,i,t.bbMin,t.bbMax)}}_includeFarBoundingInfoRec(e,t,i,r){if(null==t)return;const n=t.center;(0,Pi.t)((0,es.a)(lM),n,i),lM[3]=t.radius*(0,gi.u1)(i);const{frustum:s}=e;if(this._isOutsideSidePlanes(lM,s))return;const[a,o,l,c]=lM,{viewMatrix:h}=e,u=h[2]*a+h[6]*o+h[10]*l+h[14]-c;if(!(-u<=r.far))if(-u<this._looseRange.far)r.far=-u;else{if(c>100){const n=t.getChildren();if(void 0!==n){for(const t of n)this._includeFarBoundingInfoRec(e,t,i,r);return}}pM.unionDepthRangeWithAABB(r,e.viewProjectionMatrix,i,t.bbMin,t.bbMax)}}},pM=new class{constructor(){this._modelViewProj=(0,Bi.Ue)(),this._clipPosition=[(0,tc.Ue)(),(0,tc.Ue)(),(0,tc.Ue)(),(0,tc.Ue)(),(0,tc.Ue)(),(0,tc.Ue)(),(0,tc.Ue)(),(0,tc.Ue)()]}unionDepthRangeWithAABB(e,t,i,r,n){const s=this._modelViewProj;(0,Vi.Jp)(s,t,i);let a=!1;for(let e=0;e<8;++e){const t=this._clipPosition[e],i=0===e||3===e||4===e||7===e?r[0]:n[0],a=0===e||1===e||4===e||5===e?r[1]:n[1],o=e<4?r[2]:n[2];t[0]=s[0]*i+s[4]*a+s[8]*o+s[12],t[1]=s[1]*i+s[5]*a+s[9]*o+s[13],t[2]=s[2]*i+s[6]*a+s[10]*o+s[14],t[3]=s[3]*i+s[7]*a+s[11]*o+s[15]}for(let t=0;t<12;++t){const i=nM(this._clipPosition[oM[t][0]],this._clipPosition[oM[t][1]],this._clipPosition[oM[t][2]]);let r=!0;for(let e=0;e<i.length;++e)if(i[e][3]>=2){r=!1;break}if(!r){a=!0;for(let t=0;t<i.length;++t){const r=i[t][3];Number.isFinite(r)&&(e.near=Math.min(r,e.near),e.far=Math.max(r,e.far))}}}return a}},mM={idleOpacity:.8,navigatingOpacity:.4,maxDelta:.1,tiltFadeStart:20,tiltFadeEnd:30,altitudeStart:1e4,altitudeEnd:2e4};class fM{constructor(e){this._fbos=e,this._requiresEmission=!1,this._size=new pb.Z(0,0),this._clearColor=(0,tc.Ue)()}dispose(){this._color=(0,p.RY)(this._color),this.releaseDepth()}initialize(e,t,i,r){this._size.width=e,this._size.height=t,(0,tr.d)(this._size,this._fbos.rctx.parameters.maxTextureSize);const n=this._color;return this._color=null,this.releaseDepth(),this._requiresEmission=r,(0,ec.c)(this._clearColor,i),n}releaseDepth(){this._color?.detachDepth(),this._depth=(0,p.RY)(this._depth)}update(e){const t=this._ensureColor();t.attachDepth(this.depth),this._color=e(t)}bind(){const{rctx:e}=this._fbos,t=null==this._color;this.color.attachDepth(this.depth),e.bindFramebuffer(this.color.fbo),t&&(e.setClearStencil(0),e.setClearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3]),e.clear($i.Hf.COLOR|$i.Hf.DEPTH|$i.Hf.STENCIL),this._requiresEmission&&e.clearBuffer(1,iS.AG))}_acquireColor(){return this._requiresEmission?this._fbos.acquire(this._size.width,this._size.height,"acquired-color").acquireColor($i.Ml,Td.qz.RGBA16FLOAT,"emissive"):this._fbos.acquire(this._size.width,this._size.height,"acquired-color")}_acquireDepth(){return this._fbos.acquireDepth(Td.qk.DEPTH24_STENCIL8,this._size.width,this._size.height,"depth")}get size(){return this._size}get color(){return this._ensureColor()}get depth(){return this._depth??=this._acquireDepth(),this._depth}_ensureColor(){return this._color??=this._acquireColor(),this._color}}var _M=i(73267),gM=i(47718);class yM{constructor(){this._inputs=new Map}set(e,t){this._inputs.set(e,t)}get(e){return this._inputs.get(e)}has(e){return this._inputs.has(e)}release(e){this._inputs.get(e)?.release()&&this._inputs.delete(e)}}var vM=i(89145);class bM extends Wi.A{constructor(e,t){super(e,t,new ji.J(vM.a,(()=>i.e(4238).then(i.bind(i,4238))))),this.primitiveType=$i.MX.TRIANGLE_STRIP}initializePipeline(){return(0,Xi.sm)({blending:Xi.Zo,colorWrite:Xi.gf,depthTest:null,depthWrite:null})}}var wM=i(65718);const CM=1/512;let xM=class extends S.Z{constructor(e,t,i,r){super({}),this._techniques=e,this._rctx=t,this._data=i,this._requestRender=r,this._passParameters=new vM.S(this._data),this._configuration=new wM.l,this._enabled=!1,this._vao=(0,mb.ow)(t)}dispose(){this._stop(),this._vao=(0,p.M2)(this._vao)}precompile(){this._showVisualization&&this._techniques.precompile(bM,this._configuration)}render(e){if(!this._showVisualization)return;const[t,i]=this._data.computedSamples;this._passParameters.sampleScale=[t?1/t:0,i?1/i:0];const r=this._techniques.get(bM,this._configuration);this._rctx.bindVAO(this._vao),this._rctx.bindTechnique(r,e,this._passParameters),this._rctx.drawArrays(r.primitiveType,0,(0,Er._V)(this._vao,"geometry"))}setOptions(e){void 0!==e.enabled&&this._setEnabled(e.enabled),void 0!==e.thresholdColor&&this._setThresholdColor(e.thresholdColor),void 0!==e.gradientColor&&this._setGradientColor(e.gradientColor),void 0!==e.bandedGradientColor&&this._setBandedGradientColor(e.bandedGradientColor),void 0!==e.threshold&&(this._threshold=e.threshold),void 0!==e.visualization&&(this._visualization=e.visualization),void 0!==e.bandSize&&(this._bandSize=e.bandSize)}get opacityFromElevation(){return this._passParameters.opacityFromElevation}set opacityFromElevation(e){this._passParameters.opacityFromElevation!==e&&(this._passParameters.opacityFromElevation=e,this.notifyChange("opacityFromElevation"))}get _showVisualization(){return this._enabled&&(this._data.computedSamples[0]>0||this._data.computedSamples[1]>0)&&this.opacityFromElevation>CM}get _threshold(){return this._passParameters.threshold}set _threshold(e){this._threshold!==e&&(this._passParameters.threshold=e,this._requestRenderIfEnabled())}get _visualization(){return this._configuration.visualization}set _visualization(e){e!==this._visualization&&(this._configuration.visualization=e,this._requestRenderIfEnabled())}get _bandSize(){return this._passParameters.bandSize}set _bandSize(e){e!==this._bandSize&&(this._passParameters.bandSize=e,this._requestRenderIfEnabled())}_setThresholdColor(e){const t=this._passParameters.thresholdColor;(0,ec.a)(e,t)||((0,ec.c)(this._passParameters.thresholdColor,e),this._requestRenderIfEnabled())}_setGradientColor(e){const t=this._passParameters.gradientColor;(0,ec.a)(e,t)||((0,ec.c)(this._passParameters.gradientColor,e),this._requestRenderIfEnabled())}_setBandedGradientColor(e){const t=this._passParameters.bandedGradientColor;(0,ec.a)(e,t)||((0,ec.c)(this._passParameters.bandedGradientColor,e),this._requestRenderIfEnabled())}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfEnabled(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}};(0,r._)([(0,w.Cb)()],xM.prototype,"opacityFromElevation",null),xM=(0,r._)([(0,x.j)("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],xM);var TM=i(79262),SM=i(55244),MM=i(80518);class EM extends Wi.A{constructor(e,t){super(e,t,new ji.J(SM.a,(()=>i.e(15230).then(i.bind(i,15230))))),this.primitiveType=$i.MX.TRIANGLE_STRIP}initializePipeline(e){const t={r:e.index===MM.j.PRIMARY,g:e.index===MM.j.CONTEXT,b:!1,a:!1};return(0,Xi.sm)({blending:Xi.IH,colorWrite:t,depthTest:null,depthWrite:null})}}var PM=i(33011);class RM extends Wi.A{constructor(e,t){super(e,t,new ji.J(PM.S,(()=>i.e(19086).then(i.bind(i,19086))))),this.primitiveType=$i.MX.TRIANGLE_STRIP}initializePipeline(e){const t={r:e.index===MM.j.PRIMARY,g:e.index===MM.j.CONTEXT,b:!1,a:!1};return(0,Xi.sm)({blending:null,colorWrite:t,depthTest:null,depthWrite:null})}}let AM=class extends S.Z{updateDepthRange(e){this._depthRange.equals(e)||(this._depthRange=e)}constructor(e,t,i,r,n,s){super({}),this.fbos=e,this._techniques=t,this._stage=i,this._prepareForShadowMapPass=r,this._renderToShadowMap=n,this._requestRender=s,this._primarySet=new LM(new MM.i(MM.j.PRIMARY),(()=>this._requestRenderIfEnabled())),this._contextSet=new LM(new MM.i(MM.j.CONTEXT),(()=>this._requestRenderIfEnabled())),this._passParameters=new _T.nj,this._depthRange=Pm.P.zero,this._previewing=!1,this._cameraForcedForScreenshot=!1,this._shadowAccumulatorKey=Symbol("shadowAccumulator"),this._rctx=e.rctx,this._bindParameters=new pb.p(new TM.l(e,i.viewingMode)),this._bindParameters.shadowMap.enabled=!0,this._vao=(0,mb.ow)(this._rctx),this._accumulationRenderer=new xM(t,this._rctx,this,s);const a=this._stage.view.resourceController.scheduler;this.addHandles([a.registerTask(nr.T8.SHADOW_ACCUMULATOR,this),(0,_.YP)((()=>i.renderView),(e=>{this.removeHandles(DM),null!=e&&this.addHandles(e.events.on("force-camera-for-screenshot",(()=>this._cameraForcedForScreenshot=!0)),DM)}),_.tX),(0,_.YP)((()=>this._previewing),(()=>this._requestRenderIfEnabled()),_.Z_),(0,_.YP)((()=>2===this._numActive),(()=>this._numActiveChanged()),_.Z_),(0,_.YP)((()=>this._depthRange),(()=>this._invalidateAccumulationSets()),_.Z_)],this._shadowAccumulatorKey);for(const e of this._accumulationSets())e.precompile(t)}*_accumulationSets(){yield this._primarySet,yield this._contextSet}normalizeCtorArgs(){return{}}dispose(){this._disable(),this.removeHandles(this._shadowAccumulatorKey),this._accumulationRenderer=(0,p.M2)(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=(0,p.M2)(this._fbo),this._vao=(0,p.M2)(this._vao);for(const e of this._accumulationSets())e.destroy()}get computedSamples(){return[this._primarySet.progress,this._contextSet.progress]}get shadowCastTexture(){return this._fbo?.colorTexture}get accumulating(){return this.active&&this._previewing||this._refining}get _refining(){return this.active&&!this._doneAccumulating&&!this._previewing}get active(){return null!=this._fbo&&[...this._accumulationSets()].some((e=>e.active))}get canAccumulate(){return null!=this._bindParameters.depth&&this._depthRange!==Pm.P.zero&&this._opacityFromElevation>CM}get _doneAccumulating(){return[...this._accumulationSets()].every((e=>e.doneAccumulating))}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(e){this._accumulationRenderer.opacityFromElevation=e}get _numActive(){return[...this._accumulationSets()].reduce(((e,t)=>e+(t.active?1:0)),0)}get _pixelFormat(){return 2===this._numActive?{pixelFormat:$i.VI.RG,internalFormat:$i.lP.RG8}:{pixelFormat:$i.VI.RED,internalFormat:$i.lP.R8}}get running(){return this._refining&&this.canAccumulate&&[...this._accumulationSets()].some((e=>e.running))}runTask(e){this._clearBuffersOnAccumulationStart(),this._prepareForShadowMapPass(this._bindParameters);let t=!1;for(const i of this._accumulationSets())this._runTaskForSet(i,e)&&(t=!0);t&&this._requestRender()}_runTaskForSet(e,t){let i=!1;for(;!t.done&&!e.doneAccumulating;)this._accumulateShadow(e),t.madeProgress(),i=!0;return i}renderAccumulation(e,t,i){if(this._updateCamera(t),this._bindParameters.contentCamera=i,this._bindParameters.depth=e,this._passParameters.origin=this._bindParameters.camera.center,this.notifyChange("canAccumulate"),!this.accumulating||!this.canAccumulate)return!1;this._previewing||this._cameraForcedForScreenshot?(this._clearFramebuffer(),this._reset()):this._clearBuffersOnAccumulationStart();const r=this._accumulateSetsForRenderFrame();return this._cameraForcedForScreenshot=!1,r}_clearBuffersOnAccumulationStart(){if([...this._accumulationSets()].every((e=>0===e.progress)))this._clearFramebuffer();else for(const e of this._accumulationSets())0===e.progress&&this._clearFramebufferForSet(this._fbo,e)}_accumulateSetsForRenderFrame(){let e=!1;for(const t of this._accumulationSets())this._accumulateSetForRenderFrame(t)&&(e=!0);return e&&this._requestRender(),e}_accumulateSetForRenderFrame(e){let t=this._cameraForcedForScreenshot?e.sampleCount:Math.min(OM,e.sampleCount);t-=e.progress;for(let i=0;i<t;++i)this._accumulateShadow(e);return t>0}precompile(){this._accumulationRenderer.precompile()}render(e){this._accumulationRenderer.render(e)}setOptions(e){void 0!==e.previewing&&(this._previewing=e.previewing),void 0!==e.lightDirections&&(this._primarySet.lightDirections=e.lightDirections),void 0!==e.lightDirectionsContext&&(this._contextSet.lightDirections=e.lightDirectionsContext),!0===e.enabled?this._enable():!1===e.enabled&&this._disable(),this._accumulationRenderer.setOptions(e)}readAccumulatedShadow(e,t){const i=this._primarySet.progress;return!this.active||!this._fbo||i<1||e<0||e>=this._fbo.width||t<0||t>=this._fbo.height?0:(this._fbo.readPixels(e,t,1,1,$i.VI.RGBA,$i.Br.UNSIGNED_BYTE,IM),IM[MM.j.PRIMARY]/i)}_numActiveChanged(){if(!this._fbo)return;const e=2===this._numActive,t=this._createFBO();t.resize(this._fbo.width,this._fbo.height),e&&(this._clearFramebuffer(t),this._contextSet.reset()),this._fbo.width&&this._fbo.height&&this._rctx.blitFramebuffer(this._fbo,t),this._fbo.dispose(),this._fbo=t,this._requestRender()}_enable(){this._fbo||(this._fbo=this._createFBO(),this._invalidateAccumulationSets())}_createFBO(){const{pixelFormat:e,internalFormat:t}=this._pixelFormat,i=new ir.X;return i.pixelFormat=e,i.internalFormat=t,i.wrapMode=$i.e8.CLAMP_TO_EDGE,new tr.X(this._rctx,i)}_invalidateAccumulationSets(){for(const e of this._accumulationSets())e.reset();this._requestRenderIfEnabled()}_disable(){this._fbo&&(this._fbo=(0,p.M2)(this._fbo),this._requestRender())}_reset(){for(const e of this._accumulationSets())e.reset()}_clearFramebuffer(e=this._fbo){e&&e.width&&e.height&&(this._rctx.bindFramebuffer(e),this._rctx.setClearColor(0,0,0,0),this._rctx.clear($i.Hf.COLOR))}_clearFramebufferForSet(e,t){if(!e)return;const i=this._techniques.get(RM,t.configuration);this._rctx.bindFramebuffer(e),this._rctx.bindTechnique(i,this._bindParameters,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(i.primitiveType,0,(0,Er._V)(this._vao,"geometry"))}_accumulateShadow(e){this._renderToShadowMap(this._bindParameters,e.lightDirections[e.progress++],this._depthRange);const t=this._techniques.get(EM,e.configuration);this._rctx.bindFramebuffer(this._fbo),this._rctx.bindTechnique(t,this._bindParameters,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(t.primitiveType,0,(0,Er._V)(this._vao,"geometry"))}_updateCamera(e){const t=this._fbo;if(null==t)return;const i=this._bindParameters.camera;e.equals(i)||i.copyFrom(e),t.resize(e.fullWidth,e.fullHeight),this._opacityFromElevation=1-(0,st.CW)(4e4,5e4,e.relativeElevation)}_requestRenderIfEnabled(){this._fbo&&this._requestRender()}get test(){}};(0,r._)([(0,w.Cb)()],AM.prototype,"_fbo",void 0),(0,r._)([(0,w.Cb)()],AM.prototype,"_depthRange",void 0),(0,r._)([(0,w.Cb)()],AM.prototype,"_previewing",void 0),(0,r._)([(0,w.Cb)()],AM.prototype,"_accumulationRenderer",void 0),(0,r._)([(0,w.Cb)()],AM.prototype,"_refining",null),(0,r._)([(0,w.Cb)()],AM.prototype,"active",null),(0,r._)([(0,w.Cb)()],AM.prototype,"canAccumulate",null),(0,r._)([(0,w.Cb)()],AM.prototype,"_doneAccumulating",null),(0,r._)([(0,w.Cb)()],AM.prototype,"_opacityFromElevation",null),(0,r._)([(0,w.Cb)()],AM.prototype,"_numActive",null),(0,r._)([(0,w.Cb)()],AM.prototype,"_pixelFormat",null),(0,r._)([(0,w.Cb)()],AM.prototype,"running",null),AM=(0,r._)([(0,x.j)("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],AM);const OM=6,DM="renderView",IM=new Uint8Array(4);class LM{constructor(e,t){this.configuration=e,this._notifyChange=t,this._cachedLightDirections=[],this._progress=(0,Di.t)(0),this._sampleCount=(0,Di.t)(0)}get progress(){return this._progress.value}set progress(e){this._progress.value=e}get sampleCount(){return this._sampleCount.value}get doneAccumulating(){return this.progress>=this.sampleCount}get running(){return this.progress>0}get active(){return this.sampleCount>0}get lightDirections(){return this._cachedLightDirections}set lightDirections(e){const t=this._cachedLightDirections,i=Math.min(SM.S,e.length);if(!(0,Fe.P$)(t,0,t.length,e,0,i,Pi.G)){t.length=i,this._sampleCount.value=i;for(let r=0;r<i;++r)t[r]=(0,Pi.c)(t[r]??(0,R.Ue)(),e[r]);this.reset(),this._notifyChange()}}destroy(){this._cachedLightDirections.length=0,this._sampleCount.value=0}reset(){this.progress=0}precompile(e){e.precompile(EM,this.configuration),e.precompile(RM,this.configuration)}}const NM=(0,od.d)();class FM{constructor(){this._plane=(0,od.d)(),this._isDecoration=!0}get plane(){return this._plane}get isDecoration(){return this._isDecoration}update({plane:e,isDecoration:t}){let i=!1;return this._isDecoration!==t&&(this._isDecoration=t,i=!0),e??=NM,(0,od.g)(e,this._plane)?i:((0,od.a)(e,this._plane),!0)}}var UM=i(57225),HM=i(27076),kM=i(24498);class VM{constructor(e,t,i,r,n,s,a,o,l){this.createQuery=e,this.deleteQuery=t,this.resultAvailable=i,this.getResult=r,this.disjoint=n,this.beginTimeElapsed=s,this.endTimeElapsed=a,this.createTimestamp=o,this.timestampBits=l}}let BM=!1;class zM{constructor(e,t){this._timer=e,this._queryPool=new Array,this._queryResults=new Map,this._currentQuery=null,t.forEach((e=>{const t=this._timer.createQuery(),i=this._timer.createQuery();this._queryPool.push(t,i),this._queryResults.set(e,null)}))}start(){BM||(this._currentQuery=this._queryPool.pop(),null!=this._currentQuery&&(this._timer.disjoint(),this._timer.beginTimeElapsed(this._currentQuery)))}stop(e){if(this._timer.disjoint()||null==this._currentQuery||!this._queryResults.has(e))return this.abort(),null;this._timer.endTimeElapsed();const t=this._queryResults.get(e);if(null==t)return this._queryResults.set(e,this._currentQuery),this._currentQuery=null,null;if(!this._timer.resultAvailable(t))return this._queryPool.unshift(this._currentQuery),this._currentQuery=null,null;const i=this._timer.getResult(t)/1e6;return this._queryPool.unshift(t),this._queryResults.set(e,this._currentQuery),this._currentQuery=null,i}abort(){null!=this._currentQuery&&(this._timer.deleteQuery(this._currentQuery),this._queryPool.unshift(this._timer.createQuery()),this._currentQuery=null)}dispose(){null!=this._currentQuery&&this._timer.deleteQuery(this._currentQuery),this._queryPool.forEach((e=>{this._timer.deleteQuery(e)})),this._queryResults.forEach((e=>{null!=e&&this._timer.deleteQuery(e)}))}}var GM;!function(e){e.OVERLAY="overlay",e.PREPARE="prepare",e.SHADOW_MAP="shadow map",e.DEPTH="depth",e.ACCUMULATED_SHADOWS="accumulated shadows",e.APPLY_ACCUMULATED_SHADOWS="apply accumulated shadows",e.OBJECT_AND_LAYER_ID_COLOR="object/layer id color",e.NORMALS="normals",e.SSAO="SSAO",e.HIGHLIGHTS="highlights",e.OPAQUE_EDGES="opaque edges",e.VOXEL="voxel",e.TRANSPARENT="transparent",e.TRANSPARENT_EDGES="transparent edges",e.HUD_VISIBILITY="HUD visibility",e.TRANSPARENT_TERRAIN="transparent terrain",e.TRANSPARENT_MATERIAL_WITHOUT_DEPTH="transparent material without depth",e.OPAQUE_ENVIRONMENT="opaque environment",e.TRANSPARENT_ENVIRONMENT="transparent environment",e.OCCLUDED="occluded",e.HUD="HUD",e.HUD_OCCLUDED="HUD occluded",e.FINISH="finish",e.FOCUS_AREA_MASK="focus area mask"}(GM||(GM={}));const qM=Object.values(dr.lu).concat(Object.values(dr.CM)).concat(Object.values(GM)),ZM="Total";class jM{constructor(e){this._rctx=e,this._startTimeStampCPU=(0,ur.HA)(0),this._lastTimeStampCPU=(0,ur.HA)(0),this._totalCPUTime=new kM.Z(ZM),this._cpuTimeSamplers=new Map(qM.map((e=>[e,new kM.Z(e)]))),this._enableGPUTimer=0,this._totalGPUTime=new kM.Z("GPU"),this._gpuTimeSamplers=new Map(qM.map((e=>[e,new kM.Z(e)]))),this._totalTime=(0,ur.HA)(0),this._totalFrameCount=0}get totalCPUTimeSampler(){return this._totalCPUTime}get cpuTimeSamplers(){return Array.from(this._cpuTimeSamplers.values())}get totalGPUTimeSampler(){return this._totalGPUTime}get gpuTimeSamplers(){return Array.from(this._gpuTimeSamplers.values())}get gpuSamplingEnabled(){return null!=this._gpuTimerPool}get totalTime(){return this._totalTime}get totalFrameCount(){return this._totalFrameCount}get elapsedTime(){return(0,ur.HA)(performance.now()-this._startTimeStampCPU)}enableGPUPerformanceInfo(){if(null==this._gpuTimerPool){const e=[...qM,ZM];this._gpuTimerPool=function(e,t){const i=e.capabilities.disjointTimerQuery;return null==i?null:new zM(i,t)}(this._rctx,e)}if(null==this._gpuTimerPool)return{hasGPUTimerSupport:!1,remove:()=>{}};++this._enableGPUTimer;let e=!1;return{hasGPUTimerSupport:!0,remove:()=>{e||(e=!0,--this._enableGPUTimer,0===this._enableGPUTimer&&(this._gpuTimerPool=(0,p.M2)(this._gpuTimerPool)))}}}startFrame(){this._startTimeStampCPU=this._lastTimeStampCPU=(0,ur.HA)(performance.now()),this._gpuTimerPool&&(this._gpuTimeSamplers.forEach((e=>e.push(0))),this._gpuTimerPool.start())}advance(e){const t=(0,ur.HA)(performance.now());if(this._cpuTimeSamplers.get(e).push(t-this._lastTimeStampCPU),this._lastTimeStampCPU=t,this._gpuTimerPool){const t=this._gpuTimerPool.stop(e);this._gpuTimeSamplers.get(e).set(t),this._gpuTimerPool.start()}}finishFrame(){if(this._gpuTimerPool){const e=this._gpuTimerPool.stop(GM.FINISH);this._gpuTimeSamplers.get(GM.FINISH).set(e),this._rctx.gl.flush()}const e=(0,ur.HA)(performance.now()-this._startTimeStampCPU);this._totalTime=(0,ur.HA)(this._totalTime+e),this._totalCPUTime.push(e),this._gpuTimerPool&&this._totalGPUTime.push(this.gpuTimeSamplers.reduce(((e,t)=>e+(t.last||0)),0)),++this._totalFrameCount}}let WM=class extends gM.F{constructor(e,t,i,r,n,s){super({stage:e}),this._techniques=i,this._rctx=r,this._compositingHelper=n,this._requestRender=s,this._pluginsHas={hudElements:!1,water:!1},this.renderPassManager=new RS,this._isRendering=!1,this._inGlobeView=!1,this._backgroundColor=(0,tc.al)(0,0,0,1),this._sliceHelper=new FM,this._blit=null,this._oitblend=null,this.sceneDepthRange=(0,Di.t)(Pm.P.infinite),this._state=(0,Di.t)($c.n.IDLE),this._highQualityTransparencyEnabled=!0,this._ssrEnabled=!1,this._hasAnimations=!1,this._animationTimestep=new GS,this._loadEdgeViewTask=null,this._edgeViewCallbacks=[],this._reprojectionMatrixVersion=(0,Di.t)(0),this._lastFrameTime=(0,ur.HA)(0),this._renderHiddenTransparentEdges=()=>{},this._pluginInput=new yM,this._releaseNormals=e=>{e.some((({name:e})=>"normals"===e))&&this._pluginInput.release("normals")},this._debugNeedsDepth=!1,this.fboCache=new uS(r),this._renderStateFeatures=(0,Di.t)((0,jc.n)(!(0,u.Z)("disable-feature:high-quality-idle"),e.view.qualityProfile)),this._framebuffer=new fM(this.fboCache),this.performanceInfo=new jM(this._rctx),this._shadowMap=new TM.l(this.fboCache,e.viewingMode),this._shadowAccumulator=new AM(this.fboCache,i,e,(e=>{const t=this.shadowsEnabled;this._shadowMap.enabled=!0,this._ensureBindParametersCamera(e.camera,e.contentCamera),this._plugins.prepareRender(),this._shadowMap.enabled=t}),((t,i,r)=>{const n=e.view.qualitySettings.maximumPixelRatio;t.shadowMap.start(t.camera,i,r,!0,n),this._renderShadowCascades(qb.H_.Shadow,t.shadowMap),t.shadowMap.finish(),t.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(t.camera,t.contentCamera)}),s),this._renderContext=new _M.V(this._rctx,this._shadowMap,i),this._nodes=new NS(this._renderContext),this._plugins=new FS({renderContext:this._renderContext,techniques:i,materials:t,requestRender:s,controller:e,fbos:this.fboCache,isFeatureEnabled:e=>this.isFeatureEnabled(e)}),this._plugins.add(this.renderPassManager),this.addHandles([(0,_.YP)((()=>e.view.state.camera),(()=>s()),_.tX),(0,_.YP)((()=>hd.h.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES),(e=>{this._renderHiddenTransparentEdges=e?()=>this._renderEdges(UM.i.TRANSPARENT):()=>{},s()}),_.nn),(0,_.YP)((()=>e.view.environment.background?.color),(e=>{const t=e?(0,zw.O)(e):tc.AG;(0,ec.s)(this._backgroundColor,t[0]*t[3],t[1]*t[3],t[2]*t[3],t[3]),s()}),_.tX),(0,_.YP)((()=>e.view.state.camera.relativeElevation),(e=>this._inGlobeView=(e??1/0)>=IS.o),_.tX),(0,_.YP)((()=>this._bindParameters.clouds.fadeFactor),(()=>this._bindParameters.fadeLighting()),_.Z_),(0,_.YP)((()=>this._bindParameters.clouds.data?.state),(()=>s()),_.Z_),(0,_.YP)((()=>e.view.state.highlights),(e=>{this._bindParameters.highlights=e,s()}),_.nn)])}destroy(){this._gpuTimerHandle=(0,p.hw)(this._gpuTimerHandle),this._nodes.destroy(),this._framebuffer.dispose(),this._shadowMap.dispose(),this._shadowAccumulator.dispose(),this._loadEdgeViewTask=(0,p.IM)(this._loadEdgeViewTask),this._edgeView=(0,p.SC)(this._edgeView),this.renderPassManager.dispose(),this._releaseFBOs(),this._disposeOffscreenBuffers(),this.fboCache.destroy(),this._plugins.destroy(),this._blit=null,this._oitblend=null,QS.j.prune(),HM.A.prune(),(0,RC.WV)()}get renderContext(){return this._renderContext}get _bindParameters(){return this._renderContext.bind}get _framebufferSize(){return this._framebuffer.size}updateRenderFeatures(e=null,t=!(0,u.Z)("disable-feature:high-quality-idle")){this._renderStateFeatures.value=(0,jc.n)(t,e),this._requestRender()}isFeatureEnabled(e,t=this._state.value){return this._renderStateFeatures.value.get(t,e)??!1}setFeatureEnabled(e,t,i){this._renderStateFeatures.mutate((r=>r.set(t,e,i))),this._requestRender()}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(jc.Y.HighQualityTransparency)}get hasReflections(){return this._pluginsHas.water&&(this._ssrEnabled||this.isFeatureEnabled(jc.Y.WaterReflection))}get _hasHighlights(){return this._plugins.produces(qb.H_.Highlight,$b.r.OPAQUE_MATERIAL,$b.r.TRANSPARENT_MATERIAL,$b.r.DRAPED_MATERIAL,$b.r.HUD_MATERIAL,$b.r.LABEL_MATERIAL)}hasHighlight(e){return this._plugins.hasHighlight(e)}get _hasHUDHighlights(){return this._plugins.produces(qb.H_.Highlight,$b.r.HUD_MATERIAL,$b.r.LABEL_MATERIAL)}get hasSSAO(){return(this.stage.view.qualitySettings.ambientOcclusion||this.isFeatureEnabled(jc.Y.SSAO))&&!this._inGlobeView}get hasSMAA(){return this.stage.view.qualitySettings.antialiasingEnabled||this.isFeatureEnabled(jc.Y.Antialiasing)}get fullResolutionAtmosphere(){return this.stage.view.qualitySettings.highResolutionAtmosphere||this.isFeatureEnabled(jc.Y.HighResolutionAtmosphere)}_releaseFBOs(){this._bindParameters.ssr.lastFrameColor=(0,p.RY)(this._bindParameters.ssr.lastFrameColor),this._bindParameters.terrainDepth=(0,p.RY)(this._bindParameters.terrainDepth),this._bindParameters.geometryDepth=(0,p.RY)(this._bindParameters.geometryDepth)}_disposeOffscreenBuffers(){this._framebuffer.dispose(),this._disposeBindBuffers()}_disposeBindBuffers(){this._shadowMap.disposeOffscreenBuffers(),this._bindParameters.depth=(0,p.RY)(this._bindParameters.depth),this._bindParameters.hudVisibility=(0,p.RY)(this._bindParameters.hudVisibility)}get updating(){return this._loadEdgeViewTask&&!this._loadEdgeViewTask.finished||this._edgeView?.updating||this._shadowAccumulator.running||this._plugins.updating||!this.isCameraFinal}loadEdgeView(){return this._loadEdgeViewTask||(this._loadEdgeViewTask=(0,me.vr)((async e=>{const{EdgeView:t}=await i.e(84678).then(i.bind(i,84678));(0,f.k_)(e);const r=this._edgeView=new t({rctx:this._rctx,renderSR:this.stage.view.renderSpatialReference,viewingMode:this.stage.view.stage.viewingMode,techniques:this._techniques,setNeedsRender:()=>this._requestRender(),schedule:sE(this.stage.view.resourceController)});return this.addHandles((0,_.YP)((()=>r.updating),(()=>this._requestRender()),_.Z_)),this._requestRender(),this._edgeViewCallbacks.forEach((e=>e(r))),this._edgeViewCallbacks.length=0,r}))),this._loadEdgeViewTask.promise}withEdgeView(e){this.loadEdgeView(),null==this._edgeView?this._edgeViewCallbacks.push(e):e(this._edgeView)}get edgeView(){return this._edgeView}get isCameraFinal(){return this._reprojectionMatrixVersion.value>=0&&(0,Vi.fS)(this._bindParameters.ssr.reprojectionMatrix,Bi.Wd)}set _reprojectionMatrix(e){(0,Fe.Vx)(this._bindParameters.ssr.reprojectionMatrix,e)&&this._reprojectionMatrixVersion.value++}get shadowsEnabled(){return!!this._shadowMap?.enabled}setParameters(e){const{_shadowMap:t,_bindParameters:i}=this;if(void 0!==e.qualitySettings?.reflections&&this._ssrEnabled!==e.qualitySettings.reflections&&(this._ssrEnabled=e.qualitySettings.reflections,this._requestRender()),void 0!==e.shadowMap&&this._shadowMap.enabled!==e.shadowMap&&(this._shadowMap.enabled=e.shadowMap,this._requestRender()),void 0!==e.shadowMapMaxCascades&&t.maxCascades!==e.shadowMapMaxCascades&&(t.maxCascades=e.shadowMapMaxCascades,this._requestRender()),null!=e.environment){if(null!=e.environment.weather){const t=e.environment.weather;this._bindParameters.weather=t,this._bindParameters.snowCover=!!e.weatherVisible&&null!=t&&"snowy"===t.type&&"enabled"===t.snowCover}const t="virtual"!==e.environment.lighting.type;i.enableFillLights!==t&&(i.enableFillLights=t,this._requestRender())}void 0!==e.highQualityTransparency&&this._highQualityTransparencyEnabled!==e.highQualityTransparency&&(this._highQualityTransparencyEnabled=e.highQualityTransparency,this._requestRender()),void 0!==e.shadowCast&&this._shadowAccumulator.setOptions(e.shadowCast)}set slice(e){this._sliceHelper.update(e)&&this._requestRender()}get plugins(){return this._plugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}commit(e,t){return this._isRendering&&console.warn("Renderer.modify called while rendering"),!!super.commit(e,t,this._plugins.context)&&(this.updateHasFlags(),!0)}rendererAdded(e){this._plugins.add(e)}rendererRemoved(e){this._plugins.remove(e)}get occludedRequiresStencil(){return this.occludedRequiresOccludeeStencil||this.occludedRequiresIntegratedMeshStencil}get occludedRequiresOccludeeStencil(){return this._bindParameters.hasOccludees&&0!=(this.plugins.renderOccludedFlags&Wb.yD.OccludeAndTransparentStencil)}get occludedRequiresIntegratedMeshStencil(){return this._plugins.produces(qb.H_.Color,$b.r.INTEGRATED_MESH)&&this._plugins.produces(qb.H_.Color,$b.r.OCCLUDED_GROUND)}updateHasFlags(){const e=this._pluginsHas;e.hudElements=this._plugins.produces(qb.H_.Color,...eE),e.water=this._plugins.produces(qb.H_.Normal,$b.r.DRAPED_WATER),this._bindParameters.hasOccludees=this._plugins.hasOccludees,this._requestRender()}updateAnimation(e,t){this._animationTimer??=new zS(e.camera,t),this._animationTimer.advance(e.camera,t,this._animationTimeDilation);const i=this._hasAnimations;return this._hasAnimations=this._plugins.updateAnimation(this._animationTimer),this._hasAnimations=this._nodes.updateAnimation(this._animationTimer)||this._hasAnimations,this._hasAnimations!==i&&(this._gpuTimerHandle=i?(0,p.hw)(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get _animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}tick(){this.fboCache.clean()}render(e,t,i=Zc.YE.Default,r=!1){try{return this._isRendering=!0,this._render(e,t,i,r)}catch(e){console.error(`Exception during rendering: ${e}`)}finally{this._isRendering=!1}return new og(this._pluginInput.get(dr.lu.FINAL),null)}_updateHUDOccludedFragmentOpacity(e,t){const{idleOpacity:i,navigatingOpacity:r,maxDelta:n,tiltFadeStart:s,tiltFadeEnd:a,altitudeStart:o,altitudeEnd:l}=mM,c=this.stage.view,h=c.stateManager.camera,u=c.qualitySettings.fadeDuration,d=e===$c.n.IDLE?i:r,p=(0,st.uZ)((h.tilt-s)/(a-s),0,1),m=(0,st.uZ)(((h.position.z??0)-o)/(l-o),0,1),f=(0,st.t7)((0,st.t7)(1,d,p),1,m),_=this._bindParameters.hudOccludedFragmentOpacity;if(u<=0||_===f||0===this._lastFrameTime||this._lastFrameTime>t)return this._bindParameters.hudOccludedFragmentOpacity=f,void(this._lastFrameTime=t);const g=t-this._lastFrameTime;this._lastFrameTime=t;const y=Math.max(1-i,Math.abs(i-r)),v=Math.min(y*g/u,n);v>=Math.abs(f-_)?this._bindParameters.hudOccludedFragmentOpacity=f:(this._bindParameters.hudOccludedFragmentOpacity=_+Math.sign(f-_)*v,this._requestRender())}_render(e,t,i=Zc.YE.Default,r){this.performanceInfo.startFrame(),this.fboCache.frameStart(),this.fboCache.interactive=i===Zc.YE.Default,this._disposeBindBuffers();const{camera:n,contentCamera:s,mode:a,alignPixelEnabled:o}=e;this._state.value=a;const l=this._nodes.produces("magnifier-color"),c=this._nodes.produces(dr.lu.FINAL),h=this._nodes.require("emissive",dr.CM.TRANSPARENT_ENVIRONMENT,dr.lu.COMPOSITE,dr.lu.FINAL)>0&&this._plugins.hasEmissions,u=h?qb.H_.ColorEmission:qb.H_.Color;this._renderContext.time=t,this._renderContext.output=u,this._bindParameters.oitPass=yS.M.NONE,this._bindParameters.alignPixelEnabled=o,this._bindParameters.decorations=!r,this._bindParameters.mainDepth=null;const d=!r||!this._sliceHelper.isDecoration;this._bindParameters.slicePlane=d?this._sliceHelper.plane:null,this._bindParameters.viewshedEnabled=this._nodes.produces(dr.CM.VIEWSHED),this._renderOverlay(t),n.setGLViewport(this._rctx);const p=this._framebuffer,m=p.initialize(n.fullWidth,n.fullHeight,this._backgroundColor,h);this.hasReflections?(m?.setName("last frame color"),this._bindParameters.ssr.lastFrameColor=m):m?.release(),this._ensureBindParametersCamera(n,s),this._updateHUDOccludedFragmentOpacity(a,t),this._plugins.prepareRender(),this._bindParameters.shadowHighlightsVisible=this._needsShadowHighlight&&!r;const f=this._highQualityTransparency&&this._hasTransparentTerrain,_=this._plugins.produces(qb.H_.Color,...QM);this._precompilePrepasses(),this.performanceInfo.advance(GM.PREPARE);const g=this._computeShadowDepthRange(n);this._renderShadowMap(n,this._bindParameters.lighting.mainLight.direction,g),this._pluginInput.set("normals",this._renderNormals()),this._renderRemainingGeometryDepth(),this._renderShadowAccumulation(g,n,s),this._ensureBindParametersSSR(t),this._precompileShaders(f,_,u),this._renderContext.output=u,p.bind(),this._bindParameters.mainDepth=p.depth.attachment,this._renderOpaque(f),this._renderTransparent(_,f,u),this._shadowMap.disposeMainBuffer(),this._pluginInput.set(dr.CM.FOCUSAREA,this._renderFocusAreaGeometry()),p.update((e=>this._renderNodes(dr.CM.TRANSPARENT_ENVIRONMENT,e))),p.update((e=>this._renderNodes(dr.CM.VIEWSHED,e))),p.update((e=>this._renderNodes(dr.CM.LASERLINES,e))),p.update((e=>this._renderNodes(dr.CM.FOCUSAREA_COLOR,e))),this._pluginInput.release(dr.CM.FOCUSAREA),p.update((e=>this._renderNodes(dr.CM.OCCLUDED,e))),this._pluginInput.set("highlights",this._renderHighlightPrepass()),this._renderHighlightShadowMap(n,this._bindParameters.lighting.mainLight.direction,g);const y=i===Zc.YE.ObjectAndLayerID?this._renderObjectAndLayerIdColor():null;p.update((e=>this._renderNodes(dr.lu.COMPOSITE,e))),this._shadowMap.disposeOffscreenBuffers();const v=!(i!==Zc.YE.Default||c||l&&!r),b=this._pluginInput.get(dr.lu.COMPOSITE),w=v?mS:this.fboCache.acquire(b.fbo.width,b.fbo.height,dr.CM.ANTIALIASING),C=this._nodes.produces(dr.CM.ANTIALIASING)?this._renderNodes(dr.CM.ANTIALIASING,w):this._blitFBO(b,w,!1);let x;this._pluginInput.set(dr.CM.ANTIALIASING,C),this._hasHUDHighlights?(this._renderHUD(eT.U.NotOccluded,C,u),x=this._renderNodes(dr.CM.HIGHLIGHTS,C)):(x=this._renderNodes(dr.CM.HIGHLIGHTS,C),this._renderHUD(eT.U.NotOccluded,x,u));const T=this._renderNodes(dr.CM.MAGNIFIER,x);return l&&!r&&i===Zc.YE.Default&&!c&&this._blitFBO(T),c?(T.attachDepth(p.depth),this._blitFBO(this._renderNodes(dr.lu.FINAL,T)),T.detachDepth()):this._pluginInput.set(dr.lu.FINAL,T),this._pluginInput.release("highlights"),this.onPostRender&&this.onPostRender(),this._releaseFBOs(),p.releaseDepth(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this.fboCache.frameEnd(),this.performanceInfo.finishFrame(),i!==Zc.YE.Default&&(this._releaseFBOs(),this._disposeOffscreenBuffers()),new og(this._pluginInput.get(dr.lu.FINAL),y)}_precompileShaders(e,t,i){++this._plugins.context.techniques.precompiling,this._renderContext.output=i,this._precompileOpaqueGeometry(),this._nodes.precompile(dr.CM.OPAQUE_ENVIRONMENT),this._bindParameters.terrainDepthTest=e,this._bindParameters.cullAboveTerrain=e,this._renderContext.output=qb.H_.Depth,this._plugins.precompile($b.r.TRANSPARENT_TERRAIN),e&&(this._precompileOpaqueGeometry(),this._precompileTransparentGeometry()),this._renderContext.output=i,this._plugins.precompile($b.r.TRANSPARENT_TERRAIN),t&&(this._precompileTransparentGeometry(),this._hasTransparentTerrain&&(this._bindParameters.cullAboveTerrain=!1,this._precompileTransparentGeometry(),this._bindParameters.cullAboveTerrain=e)),this._nodes.precompile(dr.CM.FOCUSAREA),this._needsHUDVisibility&&this._plugins.precompile($b.r.OCCLUSION_PIXELS),this._plugins.precompile($b.r.LINE_CALLOUTS),this._precompileHUD(eT.U.Occluded),this._bindParameters.terrainDepthTest=!1,this._bindParameters.cullAboveTerrain=!1,this._nodes.precompile(dr.CM.VIEWSHED,dr.CM.LASERLINES,dr.CM.FOCUSAREA_COLOR,dr.CM.OCCLUDED,dr.CM.ANTIALIASING,dr.CM.HIGHLIGHTS);const r=this._bindParameters;r.highlightMixTexture=r.highlights.length>1?this._rctx.emptyTexture:null,this._precompileHUD(eT.U.NotOccluded),this._hasHighlights&&(r.highlights.forEach(((e,t)=>{r.highlightLevel=t,this._precompileAllGeometry(qb.H_.Highlight)})),r.highlightLevel=null),r.highlightMixTexture=null,this._nodes.precompile(dr.lu.COMPOSITE,dr.CM.MAGNIFIER),this._shadowAccumulator.precompile(),this._plugins.precompile($b.r.TRANSPARENT_MATERIAL_WITHOUT_DEPTH),--this._plugins.context.techniques.precompiling}_renderFocusAreaGeometry(){const e=this._nodes.produce(dr.CM.FOCUSAREA,this._pluginInput);return e&&this.performanceInfo.advance(GM.FOCUS_AREA_MASK),e}_renderObjectAndLayerIdColor(){if(!this._nodes.produces("olid"))return null;const e=this._renderContext.output;++this._techniques.precompiling;const t=this._framebufferSize;let i=this.fboCache.acquire(t.width,t.height,"olid");return i.acquireDepth(Td.qk.DEPTH24_STENCIL8),i=this._nodes.render(i,this._pluginInput),--this._techniques.precompiling,this.performanceInfo.advance(GM.OBJECT_AND_LAYER_ID_COLOR),this._renderContext.output=e,i}finish(e){this._hasAnimations||this._animationTimestep.clear();const t=this.performanceInfo.gpuSamplingEnabled,i=e===Cr.Xx.BACKGROUND;if(i||t){const e=i?this.performanceInfo.elapsedTime:0;let r=0;t?r=this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.finish();const n=Math.max(e,r);this._animationTimestep.frame(n,i)}}readMainDepth(e,t){const{mainDepth:i,camera:r}=this._bindParameters;if(!i)return;const n=this.fboCache.acquire(this._framebufferSize.width,this._framebufferSize.height,"linear-depth");this._rctx.bindFramebuffer(n.fbo),r.setGLViewport(this._rctx),this._rctx.setScissorRect(e[0],e[1],e[2],e[3]),this._rctx.setScissorTestEnabled(!0),this._rctx.clearFramebuffer(tc.AG),this._compositingHelper.blitDepthToLinearDepth(this._bindParameters,i),this._rctx.setScissorTestEnabled(!1),this._rctx.setScissorRect(0,0,this._rctx.gl.canvas.width,this._rctx.gl.canvas.width),n.fbo?.readPixels(e[0],e[1],e[2],e[3],$i.VI.RGBA,$i.Br.UNSIGNED_BYTE,t),n.release()}readHUDVisibility(e,t,i,r,n){this._bindParameters.hudVisibility?.fbo?.readPixels(e,t,i,r,$i.VI.RGBA,$i.Br.UNSIGNED_BYTE,n)}readAccumulatedShadow(e){return this._shadowAccumulator.readAccumulatedShadow(e[0],e[1])}_renderEdges(e){const t=this._edgeView;if(!t?.shouldRender())return;const i=this._framebufferSize,r=this.fboCache.acquire(i.width,i.height,"edges"),n=this._bindParameters.geometryDepth;this.renderToTargets((()=>t.render(this._bindParameters,e)),r,n??this._framebuffer.depth,tc.AG),this._framebuffer.bind(),this._compositingHelper.composite(this._bindParameters,r.getTexture()),r.release(),this.performanceInfo.advance(e===UM.i.OPAQUE?GM.OPAQUE_EDGES:GM.TRANSPARENT_EDGES)}_renderOverlay(e){this._bindParameters.overlay=this.overlay?.render(e),this._bindParameters.overlay&&this.performanceInfo.advance(GM.OVERLAY)}_renderShadowMap(e,t,i){if(!this.shadowsEnabled)return;const{contentCamera:r}=this._bindParameters,n=this._shadowMap;n.start(e,t,i,this.isFeatureEnabled(jc.Y.HighResolutionShadows),this.stage.view.qualitySettings.maximumPixelRatio),this._needsShadowHighlight?(this._renderShadowCascades(qb.H_.ShadowExcludeHighlight,this._shadowMap),n.copySnapshot(TM.i.ExcludeHighlight),this._renderShadowCascades(qb.H_.ShadowHighlight,this._shadowMap)):this._renderShadowCascades(qb.H_.Shadow),n.finish(),e.setGLViewport(this._rctx),this._ensureBindParametersCamera(e,r),this.performanceInfo.advance(GM.SHADOW_MAP)}_renderHighlightShadowMap(e,t,i){if(!this.shadowsEnabled||!this._needsShadowHighlight)return;const{contentCamera:r}=this._bindParameters,n=this._shadowMap;n.start(e,t,i,this.isFeatureEnabled(jc.Y.HighResolutionShadows),this.stage.view.qualitySettings.maximumPixelRatio),this._renderShadowCascades(qb.H_.ShadowHighlight,this._shadowMap),n.moveSnapshot(TM.i.Highlight),n.finish(),e.setGLViewport(this._rctx),this._ensureBindParametersCamera(e,r),this.performanceInfo.advance(GM.SHADOW_MAP)}_precompileShadowCascades(e){for(const t of this._shadowMap.cascades)t.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(t.camera,t.camera),this._precompileAllGeometry(e)}_renderShadowCascades(e,t=this._shadowMap){t.bindFbo();for(const i of t.cascades)i.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(i.camera,i.camera),this.renderAllGeometry(e)}get _needsDepth(){return this._plugins.consumes(qb.H_.Depth)||this._nodes.requireGeometryDepth()||this.hasReflections||this._needsShadowHighlight||this._shadowAccumulator.active||this._debugNeedsDepth}_renderRemainingGeometryDepth(){const e=this._pluginInput.get("normals");e?(this._pluginInput.set(dr.CM.SSAO,this._renderSSAO()),this._needsDepth?(this._rctx.bindFramebuffer(e.fbo),this._rctx.clear($i.Hf.STENCIL),this._renderGeometryWithoutNormals(qb.H_.Depth),(0,p.RY)(this._bindParameters.depth),this._bindParameters.depth=e.obtainDepthTexture(),this.performanceInfo.advance(GM.DEPTH)):(e.detachDepth(),this._bindParameters.depth=(0,p.RY)(this._bindParameters.depth)),this.hasSSAO&&this._pluginInput.release("normals")):this._renderAllGeometryDepth()}_renderAllGeometryDepth(){if(!this._needsDepth)return void(this._bindParameters.depth=(0,p.RY)(this._bindParameters.depth));const e=this._framebufferSize,t=this.fboCache.acquire(e.width,e.height,"depth",Td.qk.DEPTH24_STENCIL8);this._rctx.bindFramebuffer(t.fbo),this._rctx.clear($i.Hf.DEPTH|$i.Hf.STENCIL),this.renderAllGeometry(qb.H_.Depth),(0,p.RY)(this._bindParameters.depth),this._bindParameters.depth=t.obtainDepthTexture(),t.release(),this.performanceInfo.advance(GM.DEPTH)}_renderTerrainDepth(e){if(this._bindParameters.terrainDepthTest=e,this._bindParameters.cullAboveTerrain=e,!e)return void(this._bindParameters.terrainDepth=(0,p.RY)(this._bindParameters.terrainDepth));const t=this._renderContext.output;this._renderContext.output=qb.H_.Depth;const i=this._framebufferSize,r=this.fboCache.acquire(i.width,i.height,"terrain depth",Td.qk.DEPTH24_STENCIL8);this._rctx.bindFramebuffer(r.fbo),this._rctx.clear($i.Hf.DEPTH|$i.Hf.STENCIL),this._renderTransparentTerrain(),(0,p.RY)(this._bindParameters.terrainDepth),this._bindParameters.terrainDepth=r.obtainDepthTexture(),this._renderContext.output=t,r.release()}_renderGeometryDepth(e){if(!e)return void(this._bindParameters.geometryDepth=(0,p.RY)(this._bindParameters.geometryDepth));const t=this._renderContext.output,{width:i,height:r}=this._framebufferSize,n=this.fboCache.acquire(i,r,"geometry depth",Td.qk.DEPTH24_STENCIL8);this._rctx.bindFramebuffer(n.fbo),this._rctx.clear($i.Hf.DEPTH|$i.Hf.STENCIL),this._renderOpaqueAndTransparentGeometry(qb.H_.Depth),this._renderContext.output=t,(0,p.RY)(this._bindParameters.geometryDepth),this._bindParameters.geometryDepth=n.obtainDepthTexture(),n.release()}get _needsShadowDepthRange(){return this._shadowMap.enabled||this._shadowAccumulator.active}_computeShadowDepthRange(e){if(!this._needsShadowDepthRange)return Pm.P.zero;const t=eM(e,this._plugins.plugins,this.stage.layers,KS.SHADOW_CASTERS);return t.union(this._plugins.queryDepthRange(e)),t.near=Math.max(e.near,t.near),t.far=Math.min(e.far,t.far),t}updateSceneDepthRange(e){if(!this.stage.view.state.isGlobal)return void(this.sceneDepthRange.value=Pm.P.infinite);if((this.stage.view.renderCoordsHelper?.getAltitude(e.eye)??0)<Gw.mP)return void(this.sceneDepthRange.value=Pm.P.infinite);const t=e.clone();t.near=rc.Z,t.far=1e10;const i=eM(t,this._plugins.plugins,this.stage.layers,KS.FULL_SCENE);i.union(this._plugins.queryDepthRange(t)),this.sceneDepthRange.value.far===i.far&&this.sceneDepthRange.value.near===i.near||(this.sceneDepthRange.value=i)}get _normalsRequired(){const e=this._nodes.require("normals",dr.lu.FINAL,dr.lu.COMPOSITE,dr.lu.OPAQUE,dr.lu.TRANSPARENT,dr.CM.VIEWSHED,dr.CM.LASERLINES);return(this.hasSSAO?1:0)+e}_precompilePrepasses(){this._normalsRequired&&this._precompileAllGeometry(qb.H_.Normal),this._needsDepth&&this._precompileAllGeometry(qb.H_.Depth),this.shadowsEnabled&&(this._needsShadowHighlight?(this._precompileShadowCascades(qb.H_.ShadowHighlight),this._precompileShadowCascades(qb.H_.ShadowExcludeHighlight),this._precompileShadowCascades(qb.H_.ShadowHighlight)):this._precompileShadowCascades(qb.H_.Shadow)),this._shadowAccumulator.active&&this._precompileAllGeometry(qb.H_.Shadow)}_renderNormals(){const e=this._normalsRequired;if(0===e)return;const t=this._framebufferSize,i=this.fboCache.acquire(t.width,t.height,"normals",Td.qz.RGBA8UNORM);i.acquireDepth(Td.qk.DEPTH24_STENCIL8),this._rctx.bindFramebuffer(i.fbo),this._rctx.clearFramebuffer(tc.AG,!0,!0),this._renderGeometryWithNormals(qb.H_.Normal);const r=this._nodes.optional("normals",dr.lu.FINAL,dr.lu.COMPOSITE,dr.lu.OPAQUE,dr.lu.TRANSPARENT,dr.CM.VIEWSHED);return i.retain(e+r-1),this.performanceInfo.advance(GM.NORMALS),i}_renderSSAO(){const e=this._pluginInput.get("normals");if(!this.hasSSAO||!e)return;const t=this._nodes.produce(dr.CM.SSAO,this._pluginInput);return this._bindParameters.ssao=t,t&&this.performanceInfo.advance(GM.SSAO),t}_precompileAllGeometry(e){const t=this._renderContext.output;this._renderContext.output=e,this._precompileOpaqueGeometry(),this._precompileTransparentGeometry(),this._plugins.precompile($b.r.TRANSPARENT_TERRAIN),this._renderContext.output=t}renderAllGeometry(e){this._renderContext.output=e,this._renderOpaqueAndTransparentGeometry(e),this._renderTransparentTerrain()}precompileSlots(e,...t){for(const i of t)this._bindParameters.slot=i,e.precompile(this._renderContext)}precompileOccludedSlots(e,t){for(const i of t)this._renderContext.renderOccludedMask=i,this.precompileSlots(e,...JM);this._renderContext.renderOccludedMask=_M.C}renderSlots(e,...t){for(const i of t)this._bindParameters.slot=i,e.forAll((e=>{const t=e.acquireTechniques(this._renderContext);t&&e.render(this._renderContext,t)}))}renderOccludedSlots(e,t){this._renderContext.renderOccludedMask=t,this.plugins.renderOccludedFlags>Wb.yD.Occlude&&this._plugins.render($b.r.OCCLUDED_GROUND),this.renderSlots(e,...JM),this._renderContext.renderOccludedMask=_M.C}renderHUD(e){this._bindParameters.hudRenderStyle=e,this._plugins.render($b.r.HUD_MATERIAL)}precompileViewshedShadowMap(){this._precompileAllGeometry(qb.H_.ViewshedShadow)}renderViewshedShadowMap(e){const{camera:t,contentCamera:i}=this._bindParameters,r=this._renderContext.output;e.setGLViewport(this._rctx),this._ensureBindParametersCamera(e,e),this.renderAllGeometry(qb.H_.ViewshedShadow),this._ensureBindParametersCamera(t,i),this._bindParameters.camera.setGLViewport(this._rctx),this._renderContext.output=r}_renderOpaqueAndTransparentGeometry(e){this._renderContext.output=e,this._renderOpaqueGeometry(),this._renderTransparentGeometry()}_renderGeometryWithNormals(e){this._renderContext.output=e,this._plugins.render(...XM),this._renderTransparentTerrain()}_renderGeometryWithoutNormals(e){this._renderContext.output=e,this._plugins.render(...YM)}_precompileOpaqueGeometry(){this._plugins.precompile(...KM)}_renderOpaqueGeometry(){this._plugins.render(...KM)}_renderTransparentGeometry(){this._plugins.render(...QM)}get _hasTransparentTerrain(){return this._plugins.produces(qb.H_.Color,$b.r.TRANSPARENT_TERRAIN)}_renderTransparentTerrain(){const e=()=>this._plugins.render($b.r.TRANSPARENT_TERRAIN);if(!(0,qb.c1)(this._renderContext.output))return void e();const t=this._framebufferSize,i=this.fboCache.acquire(t.width,t.height,"transparent terrain");return this.renderToTargets(e,i,this._framebuffer.depth,tc.AG),i}get _needsHUDVisibility(){return this._plugins.produces(this._renderContext.output,$b.r.OCCLUSION_PIXELS)}_renderHUDVisibility(){if(!this._needsHUDVisibility)return void(this._bindParameters.hudVisibility=(0,p.RY)(this._bindParameters.hudVisibility));const{width:e,height:t}=this._framebufferSize;let i=this._bindParameters.hudVisibility;i?.fbo?.width===e&&i?.fbo?.height===t||(i?.release(),i=this.fboCache.acquire(e,t,"hud visibility",Td.qz.RGBA4UNORM),this._bindParameters.hudVisibility=i);const r=this._bindParameters.geometryDepth;i.attachDepth(r||this._framebuffer.depth),this._rctx.bindFramebuffer(i.fbo),this._rctx.clearFramebuffer([0,1,0,1]),this._plugins.render($b.r.OCCLUSION_PIXELS),i.detachDepth(),this._framebuffer.bind(),this.performanceInfo.advance(GM.HUD_VISIBILITY)}_renderLineCallouts(e){if(this._bindParameters.hudRenderStyle=e,e===eT.U.Occluded){const e=()=>this._plugins.render($b.r.LINE_CALLOUTS),t=this._framebufferSize,i=this.fboCache.acquireDepth(Td.qk.DEPTH16,t.width,t.height,"line callouts");this.renderToTargets(e,this._framebuffer.color,i,void 0,!0,!0),i.release()}else this._plugins.render($b.r.LINE_CALLOUTS)}_precompileHUD(e){if(this._precompileHUDOutput(e),this._hasHighlights){const t=this._renderContext.output;this._renderContext.output=qb.H_.Highlight,this._precompileHUDOutput(e),this._renderContext.output=t}}_precompileHUDOutput(e){const t=this._bindParameters.hudRenderStyle;this._bindParameters.hudRenderStyle=e,this._oitEnabled&&(0,qb.c1)(this._renderContext.output)?(this._bindParameters.oitPass=yS.M.ColorAlpha,this._plugins.precompile(...eE),this._bindParameters.oitPass=yS.M.FrontFace,this._plugins.precompile(...eE),this._bindParameters.oitPass=yS.M.NONE):this._plugins.precompile(...eE),this._bindParameters.hudRenderStyle=t}_renderHUD(e,t,i){if(this._pluginsHas.hudElements){if(this._oitEnabled){const r=this._renderOIT($M.HUD,i,e);this._rctx.bindFramebuffer(t.fbo),this._compositingHelper.compositePreMultipliedAlpha(this._bindParameters,r.getTexture()),r.release()}else if(this._renderContext.output=i,e===eT.U.Occluded){const t=()=>this._renderHUDElements(e),i=this._framebufferSize,r=this.fboCache.acquireDepth(Td.qk.DEPTH16,i.width,i.height,"hud");this.renderToTargets(t,this._framebuffer.color,r,void 0,!0,!0),r.release()}else t.acquireDepth(Td.qk.DEPTH16),this._rctx.bindFramebuffer(t.fbo),this._renderHUDElements(e),t.detachDepth();this.performanceInfo.advance(e===eT.U.Occluded?GM.HUD_OCCLUDED:GM.HUD)}}_renderHUDElements(e){this._bindParameters.hudRenderStyle=e,this._plugins.render(...eE)}get _needsShadowHighlight(){return this.shadowsEnabled&&this._plugins.produces(qb.H_.ShadowHighlight,$b.r.OPAQUE_MATERIAL)}_renderHighlightPrepass(){if(!this._hasHighlights)return;const{fboCache:e,_rctx:t,_bindParameters:i}=this,r=this._framebufferSize,{highlights:n}=i,s=e.acquire(r.width,r.height,"highlights",n.length>fT.d1?Td.qz.RG8UINT:Td.qz.R8UINT);s.acquireDepth(Td.qk.DEPTH24_STENCIL8),t.bindFramebuffer(s.fbo);const{gl:a}=t;return a.clearBufferuiv(a.COLOR,0,[0,0,0,0]),this._renderContext.output=qb.H_.Highlight,t.bindFramebuffer(s.fbo),(0,fT.m7)(t,e,r,i,(()=>this._renderHighlightGeometries())),this.performanceInfo.advance(GM.HIGHLIGHTS),s}_renderHighlightGeometries(){this._plugins.render(...tE),this._rctx.clear($i.Hf.DEPTH),this._renderHUDElements(eT.U.Both)}_renderShadowAccumulation(e,t,i){this._shadowAccumulator.updateDepthRange(e),this._shadowAccumulator.accumulating&&this._bindParameters.depth&&this._shadowAccumulator.renderAccumulation(this._bindParameters.depth,t,i)&&this.performanceInfo.advance(GM.ACCUMULATED_SHADOWS)}_precompileTransparentGeometry(){this._oitEnabled&&(0,qb.c1)(this._renderContext.output)?(this._bindParameters.oitPass=yS.M.ColorAlpha,this._plugins.precompile(...QM),this._bindParameters.oitPass=yS.M.FrontFace,this._plugins.precompile(...QM),this._bindParameters.oitPass=yS.M.NONE):this._plugins.precompile(...QM)}_renderOIT(e,t,i=eT.U.Both){const r=e===$M.HUD,n=this._framebufferSize,s=r?this.fboCache.acquire(n.width,n.height,"oit hud composite"):null,a=r?()=>this._renderHUDElements(i):()=>this._renderTransparentGeometry(),o=this._bindParameters,l=this._renderContext.output;this._renderContext.output=t,o.oitPass=yS.M.ColorAlpha;const c=s?"oit hud color+alpha":"oit color+alpha",h=this.fboCache.acquire(n.width,n.height,c,Td.qz.RGBA16FLOAT),u=t===qb.H_.ColorEmission;u&&h.acquireColor($i.Ml,Td.qz.RGBA16FLOAT,"emissive"),h.acquireColor(u?$i.FF:$i.Ml,Td.qz.R16FLOAT),s||h.attachDepth(this._framebuffer.depth),this._rctx.bindFramebuffer(h.fbo),this._rctx.clearFramebuffer([0,0,0,1]),u&&this._rctx.clearBuffer(1,iS.AG),a(),h.detachDepth(),o.oitPass=yS.M.FrontFace;const d=this.fboCache.acquire(n.width,n.height,s?"oit hud front":"oit front");return u&&d.acquireColor($i.Ml,Td.qz.RGBA16FLOAT,"emissive"),s?d.acquireDepth(Td.qk.DEPTH16):d.attachDepth(this._framebuffer.depth),this._rctx.bindFramebuffer(d.fbo),this._rctx.clearFramebuffer(tc.AG,!!s),a(),d.detachDepth(),o.oitPass=yS.M.NONE,s?(this._rctx.bindFramebuffer(s.fbo),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clear($i.Hf.COLOR)):this._framebuffer.bind(),this._oitblend??=new BS(this._techniques),this._oitblend.blend(this._rctx,h,d,o,u),s?.detachDepth(),d.release(),h.release(),this._renderContext.output=l,s}_renderOpaque(e){const t=this.plugins.produces(qb.H_.Color,...KM);if(t){this._plugins.render($b.r.INTEGRATED_MESH,$b.r.OPAQUE_TERRAIN);const e=this._framebuffer;e.update((e=>this._renderNodes(dr.CM.OPAQUE_TERRAIN,e))),e.bind(),this._plugins.render($b.r.OPAQUE_MATERIAL,$b.r.OPAQUE_MATERIAL_WITHOUT_NORMALS)}const i=this._framebuffer;i.update((e=>this._renderNodes(dr.lu.OPAQUE,e,t))),this.fboCache.debugCallback?.(dr.lu.OPAQUE,i.color.fbo),i.update((e=>this._renderNodes(dr.CM.OPAQUE_ENVIRONMENT,e))),this.fboCache.debugCallback?.(dr.CM.OPAQUE_ENVIRONMENT,i.color.fbo),this._renderTerrainDepth(e),this._renderEdges(UM.i.OPAQUE)}_renderTransparent(e,t,i){const r=this._framebuffer;r.bind(),this._renderPlugins($b.r.VOXEL,GM.VOXEL),this._renderHiddenTransparentEdges(),e&&(this._oitEnabled?this._renderOIT($M.Geometry,i):this._renderTransparentGeometry()),r.update((t=>this._renderNodes(dr.lu.TRANSPARENT,t,e))),this.fboCache.debugCallback?.(dr.lu.TRANSPARENT,r.color.fbo),this._renderGeometryDepth(t),this._renderHUDVisibility(),t||this._plugins.render($b.r.LINE_CALLOUTS),this._renderEdges(UM.i.TRANSPARENT);const n=this._hasTransparentTerrain?this._renderTransparentTerrain():null;n&&(this.performanceInfo.advance(GM.TRANSPARENT_TERRAIN),this._bindParameters.hudVisibility&&(t?this._renderLineCallouts(eT.U.Occluded):(this._rctx.bindFramebuffer(this._bindParameters.hudVisibility?.fbo),this._compositingHelper.compositeHUD(this._bindParameters,n.getTexture())),this._renderHUD(eT.U.Occluded,r.color,i))),this._bindParameters.cullAboveTerrain=!1,n&&(r.bind(),this._compositingHelper.compositePreMultipliedAlpha(this._bindParameters,n.getTexture()),n.release(),t&&(this._renderEdges(UM.i.OPAQUE),e&&(this._oitEnabled?this._renderOIT($M.Geometry,i):this._renderTransparentGeometry(),this.performanceInfo.advance(GM.TRANSPARENT)),this._renderEdges(UM.i.TRANSPARENT))),this._bindParameters.ssao=(0,p.RY)(this._bindParameters.ssao),t&&this._renderLineCallouts(eT.U.NotOccluded),this._bindParameters.terrainDepthTest=!1,this._renderTransparentEnvironment()}_renderTransparentEnvironment(){this._shadowAccumulator.render(this._bindParameters),this.performanceInfo.advance(GM.APPLY_ACCUMULATED_SHADOWS),this._framebuffer.bind(),this._plugins.render($b.r.TRANSPARENT_MATERIAL_WITHOUT_DEPTH),this.performanceInfo.advance(GM.TRANSPARENT_MATERIAL_WITHOUT_DEPTH)}_renderPlugins(e,t){this._plugins.produces(this._renderContext.output,e)&&(this._plugins.render(e),this.performanceInfo.advance(t))}_renderNodes(e,t,i=!1){if(t.setName(e),this._pluginInput.set(e,t),!this._nodes.produces(e))return i&&this.performanceInfo.advance(e),t;const r=this._nodes.render(t,this._pluginInput,this._releaseNormals);return this.performanceInfo.advance(e),r}_blitFBO(e,t=mS,i=!0){return this._blit??=new iT.N(this._techniques),this._blit.blit(this._rctx,e,t,this._bindParameters),this._pluginInput.set(e.name,t),i&&e.release(),t}_ensureBindParametersCamera(e,t){this._bindParameters.camera=e,this._bindParameters.contentCamera=t}_ensureBindParametersSSR(e){if(this._bindParameters.ssr.lastFrameColor){null==this._ssrEnableTime&&(this._ssrEnableTime=e),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=Bi.Wd:((0,Vi.U_)(rE,this._bindParameters.camera.viewMatrix),(0,Vi.U_)(iE,this._bindParameters.camera.projectionMatrix),(0,Vi.Jp)(nE,rE,iE),(0,Vi.Jp)(nE,this._renderContext.lastFrameCamera.viewMatrix,nE),(0,Vi.Jp)(nE,this._renderContext.lastFrameCamera.projectionMatrix,nE),this._reprojectionMatrix=nE);const t=this.stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=t>0?Math.min(t,e-this._ssrEnableTime)/t:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._reprojectionMatrix=Bi.Wd,this._ssrEnableTime=null}addRenderNode(e){this._nodes.add(e),this._requestRender()}removeRenderNode(e){this._nodes.remove(e),this._requestRender()}updateLighting(e,t,i,r){this._bindParameters.updateLighting(e,t,i,r),this._requestRender(Cr.Xx.UPDATE)}get usedMemory(){return{fbos:this.fboCache.usedMemory,plugins:this._plugins.usedMemory,edges:this.edgeView?.usedMemory??0}}renderToTargets(e,t,i,r,n=!1,s=!1){t.attachDepth(i),this._rctx.bindFramebuffer(t.fbo),this._rctx.clearFramebuffer(r,n,s),e(),t.detachDepth()}get test(){}};var $M;(0,r._)([(0,w.Cb)({readOnly:!0})],WM.prototype,"fullResolutionAtmosphere",null),(0,r._)([(0,w.Cb)()],WM.prototype,"_edgeView",void 0),(0,r._)([(0,w.Cb)()],WM.prototype,"updating",null),WM=(0,r._)([(0,x.j)("esri.views.3d.webgl-engine.lib.Renderer")],WM),function(e){e[e.Geometry=0]="Geometry",e[e.HUD=1]="HUD"}($M||($M={}));const XM=[$b.r.INTEGRATED_MESH,$b.r.OPAQUE_TERRAIN,$b.r.OPAQUE_MATERIAL,$b.r.TRANSPARENT_MATERIAL],YM=[$b.r.OPAQUE_MATERIAL_WITHOUT_NORMALS,$b.r.TRANSPARENT_MATERIAL_WITHOUT_NORMALS],KM=[$b.r.INTEGRATED_MESH,$b.r.OPAQUE_TERRAIN,$b.r.OPAQUE_MATERIAL,$b.r.OPAQUE_MATERIAL_WITHOUT_NORMALS],QM=[$b.r.TRANSPARENT_MATERIAL,$b.r.TRANSPARENT_MATERIAL_WITHOUT_NORMALS],JM=[$b.r.OPAQUE_MATERIAL,$b.r.TRANSPARENT_MATERIAL,$b.r.TRANSPARENT_MATERIAL_WITHOUT_DEPTH],eE=[$b.r.LINE_CALLOUTS_HUD_DEPTH,$b.r.HUD_MATERIAL,$b.r.LABEL_MATERIAL],tE=[$b.r.TRANSPARENT_MATERIAL,$b.r.TRANSPARENT_MATERIAL_WITHOUT_NORMALS,$b.r.OPAQUE_MATERIAL,$b.r.OPAQUE_MATERIAL_WITHOUT_NORMALS,$b.r.TRANSPARENT_TERRAIN,$b.r.INTEGRATED_MESH,$b.r.OPAQUE_TERRAIN],iE=(0,Bi.Ue)(),rE=(0,Bi.Ue)(),nE=(0,Bi.Ue)();function sE(e){return t=>e.immediate.schedule(t)}var aE=i(31214);class oE{constructor(e){this._rctx=e,this._vao=function(e,t=aE.QI,i=Sd.i){const r=new Float32Array([-1,-1,3,-1,-1,3]);return new Sr.U(e,i,new Map([["geometry",t]]),new Map([["geometry",Mr.f.createVertex(e,$i.l1.STATIC_DRAW,r)]]))}(e)}destroy(){this._vao=(0,p.M2)(this._vao)}draw(){null!=this._vao&&(this._rctx.bindVAO(this._vao),this._rctx.drawArrays($i.MX.TRIANGLES,0,3))}get test(){}}class lE{constructor(e,t,i){this._rctx=e,this._locations=t,this._layout=i,this._cache=new H_(e.newCache,"VAOCache")}dispose(){this._cache.destroy()}newVao(e){const t=e.toString();let i=this._cache.pop(t);return i||(i=new Sr.U(this._rctx,this._locations,new Map([["geometry",this._layout]]),new Map([["geometry",Mr.f.createVertex(this._rctx,$i.l1.STATIC_DRAW)]])),i.vertexBuffers.get("geometry")?.setSize(e),i)}deleteVao(e){if(null==e)return;const t=e.getByteLength("geometry").toString();this._cache.put(t,e)}}class cE{constructor(e){this._rctx=e,this._indexBuffer=this._createIndexbuffer(),this._program=this._createHelperProgram()}static getShaderSources(){return{vertex:"#version 300 es\n    precision highp float;\n\n    void main(void) {\n      gl_Position = vec4(0.0, 0.0, float(gl_VertexID)-2.0, 1.0);\n    }",fragment:"#version 300 es\n    precision highp float;\n\n    out vec4 fragColor;\n\n    void main(void) {\n      fragColor = vec4(0.0, 0.0, 0.0, 1.0);\n    }"}}_createHelperProgram(){const e=cE.getShaderSources();return this._rctx.programCache.acquire(e.vertex,e.fragment,new Map([]))}_createIndexbuffer(){return Mr.f.createIndex(this._rctx,$i.l1.STATIC_DRAW,new Uint32Array([0]))}run(){this._program.compiled&&this._indexBuffer&&(this._rctx.bindVAO(null),this._rctx.useProgram(this._program),this._rctx.bindBuffer(this._indexBuffer,$i.w0.ELEMENT_ARRAY_BUFFER),this._rctx.drawElements($i.MX.POINTS,1,$i.g.UNSIGNED_INT,0))}dispose(){this._program.dispose(),this._indexBuffer.dispose()}get test(){}}class hE{constructor(){this.blend=!1,this.blendColor={r:0,g:0,b:0,a:0},this.blendFunction={srcRGB:$i.zi.ONE,dstRGB:$i.zi.ZERO,srcAlpha:$i.zi.ONE,dstAlpha:$i.zi.ZERO},this.blendEquation={mode:$i.db.ADD,modeAlpha:$i.db.ADD},this.colorMask={r:!0,g:!0,b:!0,a:!0},this.faceCulling=!1,this.cullFace=$i.LR.BACK,this.frontFace=$i.Wf.CCW,this.scissorTest=!1,this.scissorRect={x:0,y:0,width:0,height:0},this.depthTest=!1,this.depthFunction=$i.wb.LESS,this.clearDepth=1,this.depthWrite=!0,this.depthRange={zNear:0,zFar:1},this.viewport=null,this.stencilTest=!1,this.polygonOffsetFill=!1,this.polygonOffset=[0,0],this.stencilFunction={face:$i.LR.FRONT_AND_BACK,func:$i.wb.ALWAYS,ref:0,mask:1},this.clearStencil=0,this.stencilWriteMask=1,this.stencilOperation={face:$i.LR.FRONT_AND_BACK,fail:$i.xS.KEEP,zFail:$i.xS.KEEP,zPass:$i.xS.KEEP},this.clearColor={r:0,g:0,b:0,a:0},this.program=null,this.vertexBuffer=null,this.indexBuffer=null,this.uniformBuffer=null,this.pixelPackBuffer=null,this.pixelUnpackBuffer=null,this.copyReadBuffer=null,this.copyWriteBuffer=null,this.transformFeedbackBuffer=null,this.uniformBufferBindingPoints=new Array,this.transformBufferBindingPoints=new Array,this.readFramebuffer=null,this.drawFramebuffer=null,this.drawBuffers={defaultFramebuffer:[$i.Xg.BACK],fbos:new WeakMap},this.renderbuffer=null,this.activeTexture=0,this.textureUnitMap=new Array,this.vertexArrayObject=null}}class uE{constructor(e){this._objectType=e,this._active=new Map}get _stack(){const e=(new Error).stack.split("\n");return e.shift(),e.shift(),e.shift(),e.join("\n")}add(e){this._active.set(e,new dE(this._stack))}remove(e){this._active.delete(e)}addReference(e){const t=this._active.get(e);t&&t.retains.push(this._stack)}removeReference(e){const t=this._active.get(e);t&&t.releases.push(this._stack)}resetLog(){const e=new Map;let t="";this._active.forEach(((i,{usedMemory:r})=>{e.has(i.from)||(e.set(i.from,new Map),i.retains.length>0&&(t+=`  First reference count mismatch:\n  Retain:\n    ${i.retains.join("\n\n    ")}\n\n  Release:    ${i.releases.join("\n\n    ")}\n`));const n=e.get(i.from);n.set(r??0,n.get(r??0)??1)})),this._active.clear();let i=0;const r=new Array;return e.forEach(((e,t)=>{let n=0;e.forEach(((e,t)=>n+=e*t)),e.set(-1,n),i+=n,r.push([t,e])})),e.clear(),r.sort(((e,t)=>t[1].get(-1)-e[1].get(-1))),r.reduce(((e,[t,i])=>{const r=Math.round(i.get(-1)/1024);return i.delete(-1),e+`  ${r}KB from ${Array.from(i.values()).reduce(((e,t)=>e+t),0)} allocations at ${t}\n`}),`Total ${this._objectType} memory: ${Math.round(i/1024)}KB\n${t}`)}}class dE{constructor(e){this.from=e,this.retains=new Array,this.releases=new Array}}const pE=!1;class mE{constructor(){for(this._current=new Array,this._allocations=pE?new uE("WebGLObject"):null;this._current.length<$i._g.COUNT;)this._current.push(0)}increment(e,t,i=1){this._current[e]+=i,this._allocations?.add(t)}decrement(e,t,i=1){this._current[e]-=i,this._allocations?.remove(t)}get current(){return this._current}get total(){return this.current.reduce(((e,t,i)=>e+(i<$i._g.UNCOUNTED?t:0)),0)}get resourceInformation(){let e="";if(this.total>0){e+="Live objects:\n";for(let t=0;t<$i._g.COUNT;++t){const i=this._current[t];i>0&&(e+=`${$i._g[t]}: ${i}\n`)}}return e+=this._allocations?.resetLog(),e}}class fE{constructor(e,t,i){const r=t.textureFilterAnisotropic;this.versionString=e.getParameter(e.VERSION),this.maxVertexTextureImageUnits=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.maxVertexAttributes=e.getParameter(e.MAX_VERTEX_ATTRIBS);const n=i.maxAnisotropy??1/0;this.maxMaxAnisotropy=r?Math.min(e.getParameter(r.MAX_TEXTURE_MAX_ANISOTROPY),n):1,this.maxTextureImageUnits=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.maxPreferredTexturePixels=i.maxPreferredTexturePixels??1/0,this.maxRenderbufferSize=e.getParameter(e.MAX_RENDERBUFFER_SIZE),this.maxViewportDims=e.getParameter(e.MAX_VIEWPORT_DIMS),this.maxUniformBufferBindings=e.getParameter(e.MAX_UNIFORM_BUFFER_BINDINGS),this.maxVertexUniformBlocks=e.getParameter(e.MAX_VERTEX_UNIFORM_BLOCKS),this.maxFragmentUniformBlocks=e.getParameter(e.MAX_FRAGMENT_UNIFORM_BLOCKS),this.maxUniformBlockSize=e.getParameter(e.MAX_UNIFORM_BLOCK_SIZE),this.uniformBufferOffsetAlignment=e.getParameter(e.UNIFORM_BUFFER_OFFSET_ALIGNMENT),this.maxArrayTextureLayers=e.getParameter(e.MAX_ARRAY_TEXTURE_LAYERS),this.maxSamples=e.getParameter(e.MAX_SAMPLES),this.maxDrawBuffers=e.getParameter(e.MAX_DRAW_BUFFERS)}}const _E=["layout","centroid","smooth","case","mat2x2","mat2x3","mat2x4","mat3x2","mat3x3","mat3x4","mat4x2","mat4x3","mat4x4","uint","uvec2","uvec3","uvec4","samplerCubeShadow","sampler2DArray","sampler2DArrayShadow","isampler2D","isampler3D","isamplerCube","isampler2DArray","usampler2D","usampler3D","usamplerCube","usampler2DArray","coherent","restrict","readonly","writeonly","resource","atomic_uint","noperspective","patch","sample","subroutine","common","partition","active","filter","image1D","image2D","image3D","imageCube","iimage1D","iimage2D","iimage3D","iimageCube","uimage1D","uimage2D","uimage3D","uimageCube","image1DArray","image2DArray","iimage1DArray","iimage2DArray","uimage1DArray","uimage2DArray","image1DShadow","image2DShadow","image1DArrayShadow","image2DArrayShadow","imageBuffer","iimageBuffer","uimageBuffer","sampler1DArray","sampler1DArrayShadow","isampler1D","isampler1DArray","usampler1D","usampler1DArray","isampler2DRect","usampler2DRect","samplerBuffer","isamplerBuffer","usamplerBuffer","sampler2DMS","isampler2DMS","usampler2DMS","sampler2DMSArray","isampler2DMSArray","usampler2DMSArray","trunc","round","roundEven","isnan","isinf","floatBitsToInt","floatBitsToUint","intBitsToFloat","uintBitsToFloat","packSnorm2x16","unpackSnorm2x16","packUnorm2x16","unpackUnorm2x16","packHalf2x16","unpackHalf2x16","outerProduct","transpose","determinant","inverse","texture","textureSize","textureProj","textureLod","textureOffset","texelFetch","texelFetchOffset","textureProjOffset","textureLodOffset","textureProjLod","textureProjLodOffset","textureGrad","textureGradOffset","textureProjGrad","textureProjGradOffset"],gE=!1,yE=["precision","highp","mediump","lowp","attribute","const","uniform","varying","break","continue","do","for","while","if","else","in","out","inout","float","int","void","bool","true","false","discard","return","mat2","mat3","mat4","vec2","vec3","vec4","ivec2","ivec3","ivec4","uvec2","uvec3","uvec4","bvec2","bvec3","bvec4","sampler1D","sampler2D","sampler3D","usampler1D","usampler2D","usampler3D","samplerCube","sampler1DShadow","sampler2DShadow","struct","asm","class","union","enum","typedef","template","this","packed","goto","switch","default","inline","noinline","volatile","public","static","extern","external","interface","long","short","double","half","fixed","unsigned","input","output","hvec2","hvec3","hvec4","dvec2","dvec3","dvec4","fvec2","fvec3","fvec4","sampler2DRect","sampler3DRect","sampler2DRectShadow","sizeof","cast","namespace","using"],vE=["<<=",">>=","++","--","<<",">>","<=",">=","==","!=","&&","||","+=","-=","*=","/=","%=","&=","^^","^=","|=","(",")","[","]",".","!","~","*","/","%","+","-","<",">","&","^","|","?",":","=",",",";","{","}"],bE=["abs","acos","all","any","asin","atan","ceil","clamp","cos","cross","dFdx","dFdy","degrees","distance","dot","equal","exp","exp2","faceforward","floor","fract","gl_BackColor","gl_BackLightModelProduct","gl_BackLightProduct","gl_BackMaterial","gl_BackSecondaryColor","gl_ClipPlane","gl_ClipVertex","gl_Color","gl_DepthRange","gl_DepthRangeParameters","gl_EyePlaneQ","gl_EyePlaneR","gl_EyePlaneS","gl_EyePlaneT","gl_Fog","gl_FogCoord","gl_FogFragCoord","gl_FogParameters","gl_FragColor","gl_FragCoord","gl_FragData","gl_FragDepth","gl_FragDepthEXT","gl_FrontColor","gl_FrontFacing","gl_FrontLightModelProduct","gl_FrontLightProduct","gl_FrontMaterial","gl_FrontSecondaryColor","gl_LightModel","gl_LightModelParameters","gl_LightModelProducts","gl_LightProducts","gl_LightSource","gl_LightSourceParameters","gl_MaterialParameters","gl_MaxClipPlanes","gl_MaxCombinedTextureImageUnits","gl_MaxDrawBuffers","gl_MaxFragmentUniformComponents","gl_MaxLights","gl_MaxTextureCoords","gl_MaxTextureImageUnits","gl_MaxTextureUnits","gl_MaxVaryingFloats","gl_MaxVertexAttribs","gl_MaxVertexTextureImageUnits","gl_MaxVertexUniformComponents","gl_ModelViewMatrix","gl_ModelViewMatrixInverse","gl_ModelViewMatrixInverseTranspose","gl_ModelViewMatrixTranspose","gl_ModelViewProjectionMatrix","gl_ModelViewProjectionMatrixInverse","gl_ModelViewProjectionMatrixInverseTranspose","gl_ModelViewProjectionMatrixTranspose","gl_MultiTexCoord0","gl_MultiTexCoord1","gl_MultiTexCoord2","gl_MultiTexCoord3","gl_MultiTexCoord4","gl_MultiTexCoord5","gl_MultiTexCoord6","gl_MultiTexCoord7","gl_Normal","gl_NormalMatrix","gl_NormalScale","gl_ObjectPlaneQ","gl_ObjectPlaneR","gl_ObjectPlaneS","gl_ObjectPlaneT","gl_Point","gl_PointCoord","gl_PointParameters","gl_PointSize","gl_Position","gl_ProjectionMatrix","gl_ProjectionMatrixInverse","gl_ProjectionMatrixInverseTranspose","gl_ProjectionMatrixTranspose","gl_SecondaryColor","gl_TexCoord","gl_TextureEnvColor","gl_TextureMatrix","gl_TextureMatrixInverse","gl_TextureMatrixInverseTranspose","gl_TextureMatrixTranspose","gl_Vertex","greaterThan","greaterThanEqual","inversesqrt","length","lessThan","lessThanEqual","log","log2","matrixCompMult","max","min","mix","mod","normalize","not","notEqual","pow","radians","reflect","refract","sign","sin","smoothstep","sqrt","step","tan","texture2D","texture2DLod","texture2DProj","texture2DProjLod","textureCube","textureCubeLod","texture2DLodEXT","texture2DProjLodEXT","textureCubeLodEXT","texture2DGradEXT","texture2DProjGradEXT","textureCubeGradEXT","textureSize","texelFetch"];var wE=999,CE=["block-comment","line-comment","preprocessor","operator","integer","float","ident","builtin","keyword","whitespace","eof","integer"];function xE(){var e,t,i,r=0,n=0,s=wE,a=[],o=[],l=1,c=0,h=0,u=!1,d=!1,p="";return function(e){return o=[],null!==e?f(e.replace?e.replace(/\r\n/g,"\n"):e):(a.length&&m(a.join("")),s=10,m("(eof)"),o)};function m(e){e.length&&o.push({type:CE[s],data:e,position:h,line:l,column:c})}function f(t){var a;for(r=0,i=(p+=t).length;e=p[r],r<i;){switch(a=r,s){case 0:r=v();break;case 1:case 2:r=y();break;case 3:r=b();break;case 4:r=x();break;case 11:r=C();break;case 5:r=T();break;case 9999:r=S();break;case 9:r=g();break;case wE:r=_()}a!==r&&("\n"===p[a]?(c=0,++l):++c)}return n+=r,p=p.slice(r),o}function _(){return a=a.length?[]:a,"/"===t&&"*"===e?(h=n+r-1,s=0,t=e,r+1):"/"===t&&"/"===e?(h=n+r-1,s=1,t=e,r+1):"#"===e?(s=2,h=n+r,r):/\s/.test(e)?(s=9,h=n+r,r):(u=/\d/.test(e),d=/[^\w_]/.test(e),h=n+r,s=u?4:d?3:9999,r)}function g(){return/[^\s]/g.test(e)?(m(a.join("")),s=wE,r):(a.push(e),t=e,r+1)}function y(){return"\r"!==e&&"\n"!==e||"\\"===t?(a.push(e),t=e,r+1):(m(a.join("")),s=wE,r)}function v(){return"/"===e&&"*"===t?(a.push(e),m(a.join("")),s=wE,r+1):(a.push(e),t=e,r+1)}function b(){if("."===t&&/\d/.test(e))return s=5,r;if("/"===t&&"*"===e)return s=0,r;if("/"===t&&"/"===e)return s=1,r;if("."===e&&a.length){for(;w(a););return s=5,r}if(";"===e||")"===e||"("===e){if(a.length)for(;w(a););return m(e),s=wE,r+1}var i=2===a.length&&"="!==e;if(/[\w_\d\s]/.test(e)||i){for(;w(a););return s=wE,r}return a.push(e),t=e,r+1}function w(e){for(var t,i,r=0;;){if(t=vE.indexOf(e.slice(0,e.length+r).join("")),i=vE[t],-1===t){if(r--+e.length>0)continue;i=e.slice(0,1).join("")}return m(i),h+=i.length,(a=a.slice(i.length)).length}}function C(){return/[^a-fA-F0-9]/.test(e)?(m(a.join("")),s=wE,r):(a.push(e),t=e,r+1)}function x(){return"."===e||/[eE]/.test(e)?(a.push(e),s=5,t=e,r+1):"x"===e&&1===a.length&&"0"===a[0]?(s=11,a.push(e),t=e,r+1):/[^\d]/.test(e)?(m(a.join("")),s=wE,r):(a.push(e),t=e,r+1)}function T(){return"f"===e&&(a.push(e),t=e,r+=1),/[eE]/.test(e)||"-"===e&&/[eE]/.test(t)?(a.push(e),t=e,r+1):/[^\d]/.test(e)?(m(a.join("")),s=wE,r):(a.push(e),t=e,r+1)}function S(){if(/[^\d\w_]/.test(e)){var i=a.join("");return s=yE.indexOf(i)>-1?8:bE.indexOf(i)>-1?7:6,m(a.join("")),s=wE,r}return a.push(e),t=e,r+1}}function TE(e){return function(e){var t=xE(),i=[];return(i=i.concat(t(e))).concat(t(null))}(e)}const SE=new Set(["GL_OES_standard_derivatives","GL_EXT_frag_depth","GL_EXT_draw_buffers","GL_EXT_shader_texture_lod"]);function ME(e,t){for(let i=t-1;i>=0;i--){const t=e[i];if("whitespace"!==t.type&&"block-comment"!==t.type){if("keyword"!==t.type)break;if("attribute"===t.data||"in"===t.data)return!0}}return!1}function EE(e,t,i,r){r=r||i;for(const n of e)if("ident"===n.type&&n.data===i)return r in t?t[r]++:t[r]=0,EE(e,t,r+"_"+t[r],r);return i}function PE(e,t,i="afterVersion"){function r(e,t){for(let i=t;i<e.length;i++){const t=e[i];if("operator"===t.type&&";"===t.data)return i}return null}const n={data:"\n",type:"whitespace"},s=t=>t<e.length&&/[^\r\n]$/.test(e[t].data);let a=function(e){let t=-1,n=0,s=-1;for(let a=0;a<e.length;a++){const o=e[a];if("preprocessor"===o.type&&(/#(if|ifdef|ifndef)\s+.+/.test(o.data)?++n:/#endif\s*.*/.test(o.data)&&--n),"afterVersion"!==i&&"afterPrecision"!==i||"preprocessor"===o.type&&o.data.startsWith("#version")&&(s=Math.max(s,a)),"afterPrecision"===i&&"keyword"===o.type&&"precision"===o.data){const t=r(e,a);if(null===t)throw new Error("precision statement not followed by any semicolons!");s=Math.max(s,t)}t<s&&0===n&&(t=a)}return t+1}(e);s(a-1)&&e.splice(a++,0,n);for(const i of t)e.splice(a++,0,i);s(a-1)&&s(a)&&e.splice(a,0,n)}function RE(e,t,i,r="lowp"){PE(e,[{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:r},{type:"whitespace",data:" "},{type:"keyword",data:i},{type:"whitespace",data:" "},{type:"ident",data:t},{type:"operator",data:";"}],"afterPrecision")}function AE(e,t,i,r,n="lowp"){PE(e,[{type:"keyword",data:"layout"},{type:"operator",data:"("},{type:"keyword",data:"location"},{type:"whitespace",data:" "},{type:"operator",data:"="},{type:"whitespace",data:" "},{type:"integer",data:r.toString()},{type:"operator",data:")"},{type:"whitespace",data:" "},{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:n},{type:"whitespace",data:" "},{type:"keyword",data:i},{type:"whitespace",data:" "},{type:"ident",data:t},{type:"operator",data:";"}],"afterPrecision")}function OE(e,t){let i,r,n=-1;for(let s=t;s<e.length;s++){const t=e[s];if("operator"===t.type&&("["===t.data&&(i=s),"]"===t.data)){r=s;break}"integer"===t.type&&(n=parseInt(t.data,10))}return i&&r&&e.splice(i,r-i+1),n}function DE(e,t){if(e.startsWith("#version 300"))return e;const i=function(e){return gE?IE.get(e):null}(e);if(null!=i)return i;const r=TE(e);if("300 es"===function(e,t="100",i="300 es"){const r=/^\s*#version\s+([0-9]+(\s+[a-zA-Z]+)?)\s*/;for(const n of e)if("preprocessor"===n.type){const e=r.exec(n.data);if(e){const r=e[1].replaceAll(/\s{2,}/g," ");if(r===i)return r;if(r===t)return n.data="#version "+i,t;throw new Error("unknown glsl version: "+r)}}return e.splice(0,0,{type:"preprocessor",data:"#version "+i},{type:"whitespace",data:"\n"}),null}(r,"100","300 es"))return e;let n=null,s=null;const a={},o={};for(let e=0;e<r.length;++e){const i=r[e];switch(i.type){case"keyword":t===$i.Ho.VERTEX_SHADER&&"attribute"===i.data?i.data="in":"varying"===i.data&&(i.data=t===$i.Ho.VERTEX_SHADER?"out":"in");break;case"builtin":if(/^texture(2D|Cube)(Proj)?(Lod|Grad)?(EXT)?$/.test(i.data.trim())&&(i.data=i.data.replaceAll(/(2D|Cube|EXT)/g,"")),t===$i.Ho.FRAGMENT_SHADER&&"gl_FragColor"===i.data&&(n||(n=EE(r,a,"fragColor"),RE(r,n,"vec4")),i.data=n),t===$i.Ho.FRAGMENT_SHADER&&"gl_FragData"===i.data){const t=OE(r,e+1),n=EE(r,a,"fragData");AE(r,n,"vec4",t,"mediump"),i.data=n}else t===$i.Ho.FRAGMENT_SHADER&&"gl_FragDepthEXT"===i.data&&(s||(s=EE(r,a,"gl_FragDepth")),i.data=s);break;case"ident":if(_E.includes(i.data)){if(t===$i.Ho.VERTEX_SHADER&&ME(r,e))throw new Error("attribute in vertex shader uses a name that is a reserved word in glsl 300 es");i.data in o||(o[i.data]=EE(r,a,i.data)),i.data=o[i.data]}}}for(let e=r.length-1;e>=0;--e){const t=r[e];if("preprocessor"===t.type){const i=t.data.match(/#extension\s+(.*):/);if(i?.[1]&&SE.has(i[1].trim())){const t=r[e+1];r.splice(e,t&&"whitespace"===t.type?2:1)}const n=t.data.match(/#ifdef\s+(.*)/);n?.[1]&&SE.has(n[1].trim())&&(t.data="#if 1");const s=t.data.match(/#ifndef\s+(.*)/);s?.[1]&&SE.has(s[1].trim())&&(t.data="#if 0")}}return function(e,t){return gE&&IE.set(e,t),t}(e,function(e){return e.map((e=>"eof"!==e.type?e.data:"")).join("")}(r))}const IE=new Map;class LE{constructor(e,t,i,r,n=new Map,s=[]){this._context=e,this._locations=r,this._uniformBlockBindings=n,this._transformFeedbackVaryings=s,this._refCount=1,this._compiled=!1,this._linesOfCode=0,this._nameToUniformLocation=new Map,this._nameToUniform1=new Map,this._nameToUniform1v=new Map,this._nameToUniform2=new Map,this._nameToUniform3=new Map,this._nameToUniform4=new Map,this._nameToUniformMatrix3=new Map,this._nameToUniformMatrix4=new Map,e||console.error("RenderingContext isn't initialized!"),0===t.length&&console.error("Shaders source should not be empty!"),t=DE(t,$i.Ho.VERTEX_SHADER),i=DE(i,$i.Ho.FRAGMENT_SHADER),this._vShader=NE(this._context,$i.Ho.VERTEX_SHADER,t),this._fShader=NE(this._context,$i.Ho.FRAGMENT_SHADER,i),UE.enabled&&(this._linesOfCode=t.match(/\n/g).length+i.match(/\n/g).length+2,this._context.instanceCounter.increment($i._g.LinesOfCode,this._vShader,this._linesOfCode)),this._vShader&&this._fShader||console.error("Error loading shaders!"),this._context.instanceCounter.increment($i._g.Shader,this),(0,LS.CG)()&&(this.vertexShader=t,this.fragmentShader=i),this.usedMemory=t.length+i.length;const a=this._context.gl,o=a.createProgram();a.attachShader(o,this._vShader),a.attachShader(o,this._fShader),this._locations.forEach(((e,t)=>a.bindAttribLocation(o,e,t))),this._transformFeedbackVaryings?.length&&a.transformFeedbackVaryings(o,this._transformFeedbackVaryings,a.SEPARATE_ATTRIBS),a.linkProgram(o),(0,LS.CG)()&&!a.getProgramParameter(o,a.LINK_STATUS)&&console.error(`Could not link shader\nvalidated: ${a.getProgramParameter(o,a.VALIDATE_STATUS)}, gl error ${a.getError()}, vertex: ${a.getShaderParameter(this._vShader,a.COMPILE_STATUS)}, fragment: ${a.getShaderParameter(this._fShader,a.COMPILE_STATUS)}, info log: ${a.getProgramInfoLog(o)}, vertex source: ${this.vertexShader}, fragment source: ${this.fragmentShader}`);for(const[e,t]of this._uniformBlockBindings){const i=a.getUniformBlockIndex(o,e);i<4294967295&&a.uniformBlockBinding(o,i,t)}this._glName=o,this._context.instanceCounter.increment($i._g.Program,this)}get glName(){return this._glName}get hasGLName(){return null!=this._glName}get hasTransformFeedbackVaryings(){return!!this._transformFeedbackVaryings?.length}get compiled(){return!!this._compiled||(this._context.capabilities.parallelShaderCompile&&null!=this.glName?(this._compiled=!!this._context.gl.getProgramParameter(this.glName,$i.hj.COMPLETION_STATUS_KHR),this._compiled):(this._compiled=!0,!0))}dispose(){if(--this._refCount>0)return;const e=this._context.gl,t=this._context.instanceCounter;this._nameToUniformLocation.forEach((e=>e&&t.decrement($i._g.Uniform,e))),this._nameToUniformLocation.clear(),this._vShader&&(this._linesOfCode>0&&(t.decrement($i._g.LinesOfCode,this._vShader,this._linesOfCode),this._linesOfCode=0),e.deleteShader(this._vShader),this._vShader=null,t.decrement($i._g.Shader,this)),this._fShader&&(e.deleteShader(this._fShader),this._fShader=null),this._glName&&(e.deleteProgram(this._glName),this._glName=null,t.decrement($i._g.Program,this))}ref(){++this._refCount}_getUniformLocation(e){const t=this._nameToUniformLocation.get(e);if(void 0!==t)return t;if(this.glName){const t=this._context.gl.getUniformLocation(this.glName,e);return this._nameToUniformLocation.set(e,t),t&&this._context.instanceCounter.increment($i._g.Uniform,t),t}return null}hasUniform(e){return null!=this._getUniformLocation(e)}setUniform1i(e,t){HE(t);const i=this._nameToUniform1.get(e);void 0!==i&&t===i||(this._context.gl.uniform1i(this._getUniformLocation(e),t),this._nameToUniform1.set(e,t))}setUniform1iv(e,t){kE(t),FE(this._nameToUniform1v,e,t)&&this._context.gl.uniform1iv(this._getUniformLocation(e),t)}setUniform2iv(e,t){kE(t),FE(this._nameToUniform2,e,t)&&this._context.gl.uniform2iv(this._getUniformLocation(e),t)}setUniform3iv(e,t){kE(t),FE(this._nameToUniform3,e,t)&&this._context.gl.uniform3iv(this._getUniformLocation(e),t)}setUniform4iv(e,t){kE(t),FE(this._nameToUniform4,e,t)&&this._context.gl.uniform4iv(this._getUniformLocation(e),t)}setUniform1f(e,t){HE(t);const i=this._nameToUniform1.get(e);void 0!==i&&t===i||(this._context.gl.uniform1f(this._getUniformLocation(e),t),this._nameToUniform1.set(e,t))}setUniform1fv(e,t){kE(t),FE(this._nameToUniform1v,e,t)&&this._context.gl.uniform1fv(this._getUniformLocation(e),t)}setUniform2f(e,t,i){HE(t,i);const r=this._nameToUniform2.get(e);void 0===r?(this._context.gl.uniform2f(this._getUniformLocation(e),t,i),this._nameToUniform2.set(e,[t,i])):t===r[0]&&i===r[1]||(this._context.gl.uniform2f(this._getUniformLocation(e),t,i),r[0]=t,r[1]=i)}setUniform2fv(e,t){kE(t),FE(this._nameToUniform2,e,t)&&this._context.gl.uniform2fv(this._getUniformLocation(e),t)}setUniform3f(e,t,i,r){HE(t,i,r);const n=this._nameToUniform3.get(e);void 0===n?(this._context.gl.uniform3f(this._getUniformLocation(e),t,i,r),this._nameToUniform3.set(e,[t,i,r])):t===n[0]&&i===n[1]&&r===n[2]||(this._context.gl.uniform3f(this._getUniformLocation(e),t,i,r),n[0]=t,n[1]=i,n[2]=r)}setUniform3fv(e,t){kE(t);const i=this._getUniformLocation(e);null!=i&&FE(this._nameToUniform3,e,t)&&this._context.gl.uniform3fv(i,t)}setUniform4f(e,t,i,r,n){HE(t,i,r,n);const s=this._nameToUniform4.get(e);void 0===s?(this._context.gl.uniform4f(this._getUniformLocation(e),t,i,r,n),this._nameToUniform4.set(e,[t,i,r,n])):void 0!==s&&t===s[0]&&i===s[1]&&r===s[2]&&n===s[3]||(this._context.gl.uniform4f(this._getUniformLocation(e),t,i,r,n),s[0]=t,s[1]=i,s[2]=r,s[3]=n)}setUniform4fv(e,t){kE(t);const i=this._getUniformLocation(e);null!=i&&FE(this._nameToUniform4,e,t)&&this._context.gl.uniform4fv(i,t)}setUniformMatrix3fv(e,t,i=!1){kE(t);const r=this._getUniformLocation(e);null!=r&&FE(this._nameToUniformMatrix3,e,t)&&this._context.gl.uniformMatrix3fv(r,i,t)}setUniformMatrix4fv(e,t,i=!1){kE(t);const r=this._getUniformLocation(e);null!=r&&FE(this._nameToUniformMatrix4,e,t)&&this._context.gl.uniformMatrix4fv(r,i,t)}stop(){}}function NE(e,t,i){const r=e.gl,n=r.createShader(t);return r.shaderSource(n,i),r.compileShader(n),(0,LS.CG)()&&!r.getShaderParameter(n,r.COMPILE_STATUS)&&(console.error("Compile error in ".concat(t===$i.Ho.VERTEX_SHADER?"vertex":"fragment"," shader")),console.error(r.getShaderInfoLog(n)),console.error(function(e){let t=2;return e.replaceAll("\n",(()=>"\n"+function(e){return e>=1e3?e.toString():("  "+e).slice(-3)}(t++)+":"))}(i))),n}function FE(e,t,i){const r=e.get(t);if(!r)return e.set(t,Array.from(i)),!0;const n=i.length;if(r.length!==n)return e.set(t,Array.from(i)),!0;for(let e=0;e<n;++e){const t=i[e];if(r[e]!==t){for(r[e]=t;e<n;++e)r[e]=i[e];return!0}}return!1}const UE={enabled:!1},HE=(0,LS.hZ)()?(...e)=>kE(e):()=>{},kE=(0,LS.hZ)()?e=>{const t=e.length;for(let i=0;i<t;++i){const t=e[i];Number.isNaN(t)&&console.error(`Got ${t} as uniform value from ${(new Error).stack}`)}}:()=>{};class VE{constructor(e){this._rctx=e,this._store=new Iw.r}dispose(){this._store.forAll((e=>e.dispose())),this._store.clear()}acquire(e,t,i,r){const n=this._store.get(e,t);if(null!=n)return n.ref(),n;const s=new LE(this._rctx,e,t,i,r);return s.ref(),this._store.set(e,t,s),s}get test(){}}var BE=i(48857);class zE{constructor(){this._result=!1}dispose(){this._program=(0,p.M2)(this._program)}get result(){return null!=this._program&&(this._result=this._test(this._program),this.dispose()),this._result}}class GE extends zE{constructor(e){super(),this._rctx=e,this._helperProgram=null,(0,u.Z)("mac")&&(0,u.Z)("chrome")&&(this._program=this._prepareProgram(),this._helperProgram=this._prepareHelperProgram())}dispose(){super.dispose(),this._helperProgram?.dispose(),this._helperProgram=null}_test(e){const t=this._rctx,i=t.getBoundFramebufferObject(),{x:r,y:n,width:s,height:a}=t.getViewport();t.resetState();const o=new ir.X(1);o.wrapMode=$i.e8.CLAMP_TO_EDGE,o.samplingMode=$i.cw.NEAREST;const l=new tr.X(t,o),c=Mr.f.createIndex(this._rctx,$i.l1.STATIC_DRAW,new Uint8Array([0]));t.bindFramebuffer(l),t.setViewport(0,0,1,1),t.useProgram(this._helperProgram),t.bindBuffer(c,$i.w0.ELEMENT_ARRAY_BUFFER),t.drawElements($i.MX.POINTS,1,$i.g.UNSIGNED_BYTE,0),t.useProgram(e),t.bindVAO(null),t.drawArrays($i.MX.TRIANGLES,0,258);const h=new Uint8Array(4);return l.readPixels(0,0,1,1,$i.VI.RGBA,$i.Br.UNSIGNED_BYTE,h),t.setViewport(r,n,s,a),t.bindFramebuffer(i),l.dispose(),c.dispose(),255===h[0]}_prepareProgram(){const e=`#version 300 es\n    precision highp float;\n\n    out float triangleId;\n\n    const vec3 triangleVertices[3] = vec3[3](vec3(-0.5, -0.5, 0.0), vec3(0.5, -0.5, 0.0), vec3(0.0, 0.5, 0.0));\n\n    void main(void) {\n      triangleId = floor(float(gl_VertexID)/3.0);\n\n      vec3 position = triangleVertices[gl_VertexID % 3];\n      float offset = triangleId / ${BE.H.float(85)};\n      position.z = 0.5 - offset;\n\n      gl_Position = vec4(position, 1.0);\n    }\n    `,t=`#version 300 es\n    precision highp float;\n\n    in float triangleId;\n\n    out vec4 fragColor;\n\n    void main(void) {\n      fragColor = triangleId == ${BE.H.float(85)} ? vec4(0.0, 1.0, 0.0, 1.0) : vec4(1.0, 0.0, 0.0, 1.0);\n    }\n    `;return this._rctx.programCache.acquire(e,t,new Map([]))}_prepareHelperProgram(){const e=cE.getShaderSources();return this._rctx.programCache.acquire(e.vertex,e.fragment,new Map([]))}}var qE=i(31442);class ZE extends zE{constructor(e){if(super(),this._rctx=e,!e.gl)return;if(!e.capabilities.colorBufferFloat?.textureFloat||!e.capabilities.colorBufferFloat?.floatBlend)return;this._program=e.programCache.acquire("\n    precision highp float;\n    attribute vec2 a_pos;\n\n    void main() {\n      gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);\n    }\n    ","\n     precision highp float;\n\n     void main() {\n      gl_FragColor = vec4(0.5, 0.5, 0.5, 0.5);\n     }\n    ",new Map([["a_pos",0]]))}_test(e){const t=this._rctx,i=new ir.X(1);i.wrapMode=$i.e8.CLAMP_TO_EDGE,i.dataType=$i.Br.FLOAT,i.internalFormat=$i.lP.RGBA32F,i.samplingMode=$i.cw.NEAREST;const r=new tr.X(t,i),n=Mr.f.createVertex(t,$i.l1.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),s=new Hx.U(t,new Map([["a_pos",0]]),new Map([["geometry",[new qE.G("a_pos",2,$i.g.UNSIGNED_SHORT,0,4)]]]),new Map([["geometry",n]]));t.gl.getError(),t.useProgram(e);const a=t.getBoundFramebufferObject(),{x:o,y:l,width:c,height:h}=t.getViewport();t.bindFramebuffer(r),t.setViewport(0,0,1,1),t.bindVAO(s),t.drawArrays($i.MX.TRIANGLE_STRIP,0,4);const u=(0,Xi.sm)({blending:Xi._x});t.setPipelineState(u),t.drawArrays($i.MX.TRIANGLE_STRIP,0,4);const d=t.gl.getError();return t.setViewport(o,l,c,h),t.bindFramebuffer(a),s.dispose(),r.dispose(),d!==$i.mA.INVALID_OPERATION||(console.warn("Device claims support for WebGL extension EXT_float_blend but does not support it. Using fall back."),!1)}}new Map([["geometry",[new qE.G("a_pos",2,$i.g.BYTE,0,2)]]]),new Map([["geometry",[new qE.G("a_pos",2,$i.g.BYTE,0,4),new qE.G("a_tex",2,$i.g.BYTE,2,4)]]]);const jE=new Map([["geometry",[new qE.G("a_pos",2,$i.g.UNSIGNED_SHORT,0,4)]]]);class WE extends zE{constructor(e){super(),this._rctx=e;this._program=e.programCache.acquire("\n    precision highp float;\n\n    attribute vec2 a_pos;\n    varying vec2 v_uv;\n\n    void main() {\n      v_uv = a_pos;\n      gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);\n    }\n    ","\n    precision highp float;\n\n    varying vec2 v_uv;\n\n    uniform sampler2D u_texture;\n\n    void main() {\n      gl_FragColor = texture2D(u_texture, v_uv);\n    }\n    ",new Map([["a_pos",0]]))}dispose(){super.dispose()}_test(e){const t=this._rctx;if(!t.gl)return e.dispose(),!0;const i=new ir.X(1);i.wrapMode=$i.e8.CLAMP_TO_EDGE,i.samplingMode=$i.cw.NEAREST;const r=new tr.X(t,i),n=Mr.f.createVertex(t,$i.l1.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),s=new Hx.U(t,new Map([["a_pos",0]]),jE,new Map([["geometry",n]])),a=new ir.X;a.samplingMode=$i.cw.LINEAR,a.wrapMode=$i.e8.CLAMP_TO_EDGE;const o=new Ed.x(t,a,$E);t.useProgram(e),t.bindTexture(o,0),e.setUniform1i("u_texture",0);const l=t.getBoundFramebufferObject(),{x:c,y:h,width:u,height:d}=t.getViewport();t.bindFramebuffer(r),t.setViewport(0,0,1,1),t.setClearColor(0,0,0,0),t.setBlendingEnabled(!1),t.clear($i.Hf.COLOR),t.bindVAO(s),t.drawArrays($i.MX.TRIANGLE_STRIP,0,4);const p=new Uint8Array(4);return r.readPixels(0,0,1,1,$i.VI.RGBA,$i.Br.UNSIGNED_BYTE,p),s.dispose(),r.dispose(),o.dispose(),t.setViewport(c,h,u,d),t.bindFramebuffer(l),255!==p[0]}}const $E=new Image;$E.src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='5' height='5' version='1.1' viewBox='0 0 5 5' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='5' height='5' fill='%23f00' fill-opacity='.5'/%3E%3C/svg%3E%0A",$E.width=5,$E.height=5,$E.decode();class XE{constructor(e){this.rctx=e,this.floatBufferBlend=new ZE(e),this.svgPremultipliesAlpha=new WE(e),this.drawArraysRequiresIndicesTypeReset=new GE(e)}dispose(){this.svgPremultipliesAlpha.dispose(),this.floatBufferBlend.dispose(),this.drawArraysRequiresIndicesTypeReset.dispose()}}var YE=i(80290);function KE(e,t,i,r,n){if(r)return!0;if(t[i])return!1;for(const t of n)if(e.getExtension(t))return!0;return!1}class QE{constructor(e,t){this._gl=e,this._compressedTextureETC=null,this._compressedTextureS3TC=null,this._textureFilterAnisotropic=null,this._colorBufferFloat=null,this._loseContext=null,this._textureNorm16=null,this._textureFloatLinear=null,this._parallelShaderCompile=null,this._rendererInfo=null,this._disabledExtensions=t.disabledExtensions||{},this._debugWebGLExtensions=t.debugWebGLExtensions||{}}get compressedTextureETC(){return this._compressedTextureETC??=function(e,t){if(t.compressedTextureETC)return null;const i=e.getExtension("WEBGL_compressed_texture_etc");return i?{COMPRESSED_R11_EAC:i.COMPRESSED_R11_EAC,COMPRESSED_SIGNED_R11_EAC:i.COMPRESSED_SIGNED_R11_EAC,COMPRESSED_RG11_EAC:i.COMPRESSED_RG11_EAC,COMPRESSED_SIGNED_RG11_EAC:i.COMPRESSED_SIGNED_RG11_EAC,COMPRESSED_RGB8_ETC2:i.COMPRESSED_RGB8_ETC2,COMPRESSED_SRGB8_ETC2:i.COMPRESSED_SRGB8_ETC2,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:i.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:i.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_RGBA8_ETC2_EAC:i.COMPRESSED_RGBA8_ETC2_EAC,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:i.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC}:null}(this._gl,this._disabledExtensions),this._compressedTextureETC}get compressedTextureS3TC(){return this._compressedTextureS3TC??=function(e,t){if(t.compressedTextureS3TC)return null;const i=e.getExtension("WEBGL_compressed_texture_s3tc");return i?{COMPRESSED_RGB_S3TC_DXT1:i.COMPRESSED_RGB_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT1:i.COMPRESSED_RGBA_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT3:i.COMPRESSED_RGBA_S3TC_DXT3_EXT,COMPRESSED_RGBA_S3TC_DXT5:i.COMPRESSED_RGBA_S3TC_DXT5_EXT}:null}(this._gl,this._disabledExtensions),this._compressedTextureS3TC}get textureFilterAnisotropic(){return this._textureFilterAnisotropic??=function(e,t){if(t.textureFilterAnisotropic)return null;const i=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");return i?{MAX_TEXTURE_MAX_ANISOTROPY:i.MAX_TEXTURE_MAX_ANISOTROPY_EXT,TEXTURE_MAX_ANISOTROPY:i.TEXTURE_MAX_ANISOTROPY_EXT}:null}(this._gl,this._disabledExtensions),this._textureFilterAnisotropic}get disjointTimerQuery(){return this._disjointTimerQuery??=function(e,t){if(t.disjointTimerQuery)return null;let i=e.getExtension("EXT_disjoint_timer_query_webgl2");return i?new VM((()=>e.createQuery()),(t=>{e.deleteQuery(t),BM=!1}),(t=>e.getQueryParameter(t,e.QUERY_RESULT_AVAILABLE)),(t=>e.getQueryParameter(t,e.QUERY_RESULT)),(()=>e.getParameter(i.GPU_DISJOINT_EXT)),(t=>{BM||(BM=!0,e.beginQuery(i.TIME_ELAPSED_EXT,t))}),(()=>{e.endQuery(i.TIME_ELAPSED_EXT),BM=!1}),(e=>i.queryCounterEXT(e,i.TIMESTAMP_EXT)),(()=>e.getQuery(i.TIMESTAMP_EXT,i.QUERY_COUNTER_BITS_EXT))):(i=e.getExtension("EXT_disjoint_timer_query"),i?new VM((()=>i.createQueryEXT()),(e=>{i.deleteQueryEXT(e),BM=!1}),(e=>i.getQueryObjectEXT(e,i.QUERY_RESULT_AVAILABLE_EXT)),(e=>i.getQueryObjectEXT(e,i.QUERY_RESULT_EXT)),(()=>e.getParameter(i.GPU_DISJOINT_EXT)),(e=>{BM||(BM=!0,i.beginQueryEXT(i.TIME_ELAPSED_EXT,e))}),(()=>{i.endQueryEXT(i.TIME_ELAPSED_EXT),BM=!1}),(e=>i.queryCounterEXT(e,i.TIMESTAMP_EXT)),(()=>i.getQueryEXT(i.TIMESTAMP_EXT,i.QUERY_COUNTER_BITS_EXT))):null)}(this._gl,this._disabledExtensions),this._disjointTimerQuery}get colorBufferFloat(){return this._colorBufferFloat??=function(e,t){const i=!t.colorBufferHalfFloat&&e.getExtension("EXT_color_buffer_half_float")||!t.colorBufferFloat&&e.getExtension("EXT_color_buffer_float"),r=!t.colorBufferFloat&&e.getExtension("EXT_color_buffer_float"),n=!t.floatBlend&&!t.colorBufferFloat&&e.getExtension("EXT_float_blend");return i||r||n?{textureFloat:!!r,textureHalfFloat:!!i,floatBlend:!!n,R16F:e.R16F,RG16F:e.RG16F,RGBA16F:e.RGBA16F,R32F:e.R32F,RG32F:e.RG32F,RGBA32F:e.RGBA32F,R11F_G11F_B10F:e.R11F_G11F_B10F,RGB16F:e.RGB16F}:null}(this._gl,this._disabledExtensions),this._colorBufferFloat}get textureNorm16(){return this._textureNorm16??=function(e,t){if(t.textureNorm16)return null;const i=e.getExtension("EXT_texture_norm16");return i?{R16:i.R16_EXT,RG16:i.RG16_EXT,RGB16:i.RGB16_EXT,RGBA16:i.RGBA16_EXT,R16_SNORM:i.R16_SNORM_EXT,RG16_SNORM:i.RG16_SNORM_EXT,RGB16_SNORM:i.RGB16_SNORM_EXT,RGBA16_SNORM:i.RGBA16_SNORM_EXT}:null}(this._gl,this._disabledExtensions),this._textureNorm16}get textureFloatLinear(){return this._textureFloatLinear??=KE(this._gl,this._disabledExtensions,"textureFloatLinear",!1,["OES_texture_float_linear"]),this._textureFloatLinear}get parallelShaderCompile(){return this._parallelShaderCompile??=KE(this._gl,this._disabledExtensions,"parallelShaderCompile",!1,["KHR_parallel_shader_compile"]),this._parallelShaderCompile}get loseContext(){return this._loseContext??=function(e,t){const i=t.loseContext&&e.getExtension("WEBGL_lose_context");return i?{loseRenderingContext:()=>i.loseContext()}:null}(this._gl,this._debugWebGLExtensions),this._loseContext}get rendererInfo(){return this._rendererInfo??=(0,YE.z)(this._gl),this._rendererInfo}enable(e){return this[e]}}let JE=class{constructor(e,t){this.gl=e,this.instanceCounter=new mE,this.programCache=new VE(this),this._transformFeedbackRequestInfo=null,this._state=new hE,this._numOfDrawCalls=0,this._numOfTriangles=0,this.configure(t)}configure(e){this._capabilities=new QE(this.gl,e),this._parameters=new fE(this.gl,this._capabilities,e),Ed.x.TEXTURE_UNIT_FOR_UPDATES=this._parameters.maxTextureImageUnits-1;const t=this.gl.getParameter(this.gl.VIEWPORT);this._state=new hE,this._state.viewport={x:t[0],y:t[1],width:t[2],height:t[3]},this._stateTracker=new Xi.jp({setBlending:e=>{if(e){this.setBlendingEnabled(!0),this.setBlendEquationSeparate(e.opRgb,e.opAlpha),this.setBlendFunctionSeparate(e.srcRgb,e.dstRgb,e.srcAlpha,e.dstAlpha);const t=e.color;this.setBlendColor(t.r,t.g,t.b,t.a)}else this.setBlendingEnabled(!1)},setCulling:e=>{e?(this.setFaceCullingEnabled(!0),this.setCullFace(e.face),this.setFrontFace(e.mode)):this.setFaceCullingEnabled(!1)},setPolygonOffset:e=>{e?(this.setPolygonOffsetFillEnabled(!0),this.setPolygonOffset(e.factor,e.units)):this.setPolygonOffsetFillEnabled(!1)},setDepthTest:e=>{e?(this.setDepthTestEnabled(!0),this.setDepthFunction(e.func)):this.setDepthTestEnabled(!1)},setStencilTest:e=>{if(e){this.setStencilTestEnabled(!0);const t=e.function;this.setStencilFunction(t.func,t.ref,t.mask);const i=e.operation;this.setStencilOp(i.fail,i.zFail,i.zPass)}else this.setStencilTestEnabled(!1)},setDepthWrite:e=>{e?(this.setDepthWriteEnabled(!0),this.setDepthRange(e.zNear,e.zFar)):this.setDepthWriteEnabled(!1)},setColorWrite:e=>{e?this.setColorMask(e.r,e.g,e.b,e.a):this.setColorMask(!1,!1,!1,!1)},setStencilWrite:e=>{e?this.setStencilWriteMask(e.mask):this.setStencilWriteMask(0)},setDrawBuffers:e=>{if(e)this.setDrawBuffers(e.buffers);else{const{drawFramebuffer:e}=this._state;null===e?this.setDrawBuffers([$i.Xg.BACK]):0===e.colorAttachments.length?this.setDrawBuffers([$i.Xg.NONE]):this.setDrawBuffers([$i.Ii])}}}),this.enforceState(),(0,p.M2)(this._driverTest),this._driverTest=new XE(this)}updateOptions(e){this._parameters=new fE(this.gl,this._capabilities,e)}dispose(){(0,p.M2)(this._driverTest),this.programCache.dispose(),this.bindVAO(null),this.unbindBuffer($i.w0.ARRAY_BUFFER),this.unbindBuffer($i.w0.ELEMENT_ARRAY_BUFFER),this.unbindBuffer($i.w0.UNIFORM_BUFFER),this._state.uniformBufferBindingPoints.length=0,this.unbindBuffer($i.w0.PIXEL_PACK_BUFFER),this.unbindBuffer($i.w0.PIXEL_UNPACK_BUFFER),this.unbindBuffer($i.w0.COPY_READ_BUFFER),this.unbindBuffer($i.w0.COPY_WRITE_BUFFER),this._state.textureUnitMap.length=0,(0,LS.hZ)()&&console.log(this.instanceCounter.resourceInformation)}get driverTest(){return this._driverTest}get contextAttributes(){return this.gl.getContextAttributes()}get parameters(){return this._parameters}setPipelineState(e){this._stateTracker.setPipeline(e)}setBlendingEnabled(e){this._state.blend!==e&&(!0===e?this.gl.enable(this.gl.BLEND):this.gl.disable(this.gl.BLEND),this._state.blend=e,this._stateTracker.invalidateBlending())}externalProgramUpdate(){this._state.program?.stop(),this._state.program=null}externalTextureUnitUpdate(e,t){for(let t=0;t<e.length;++t)this._state.textureUnitMap[e[t]]=null;t>=0&&(this._state.activeTexture=t)}externalVertexArrayObjectUpdate(){this.gl.bindVertexArray(null),this._state.vertexArrayObject=null,this._state.vertexBuffer=null,this._state.indexBuffer=null}externalVertexBufferUpdate(){this._state.vertexBuffer=null}externalIndexBufferUpdate(){this._state.indexBuffer=null}setBlendColor(e,t,i,r){e===this._state.blendColor.r&&t===this._state.blendColor.g&&i===this._state.blendColor.b&&r===this._state.blendColor.a||(this.gl.blendColor(e,t,i,r),this._state.blendColor.r=e,this._state.blendColor.g=t,this._state.blendColor.b=i,this._state.blendColor.a=r,this._stateTracker.invalidateBlending())}setBlendFunction(e,t){e===this._state.blendFunction.srcRGB&&t===this._state.blendFunction.dstRGB||(this.gl.blendFunc(e,t),this._state.blendFunction.srcRGB=e,this._state.blendFunction.srcAlpha=e,this._state.blendFunction.dstRGB=t,this._state.blendFunction.dstAlpha=t,this._stateTracker.invalidateBlending())}setBlendFunctionSeparate(e,t,i,r){this._state.blendFunction.srcRGB===e&&this._state.blendFunction.srcAlpha===i&&this._state.blendFunction.dstRGB===t&&this._state.blendFunction.dstAlpha===r||(this.gl.blendFuncSeparate(e,t,i,r),this._state.blendFunction.srcRGB=e,this._state.blendFunction.srcAlpha=i,this._state.blendFunction.dstRGB=t,this._state.blendFunction.dstAlpha=r,this._stateTracker.invalidateBlending())}setBlendEquation(e){this._state.blendEquation.mode!==e&&(this.gl.blendEquation(e),this._state.blendEquation.mode=e,this._state.blendEquation.modeAlpha=e,this._stateTracker.invalidateBlending())}setBlendEquationSeparate(e,t){this._state.blendEquation.mode===e&&this._state.blendEquation.modeAlpha===t||(this.gl.blendEquationSeparate(e,t),this._state.blendEquation.mode=e,this._state.blendEquation.modeAlpha=t,this._stateTracker.invalidateBlending())}setColorMask(e,t,i,r){this._state.colorMask.r===e&&this._state.colorMask.g===t&&this._state.colorMask.b===i&&this._state.colorMask.a===r||(this.gl.colorMask(e,t,i,r),this._state.colorMask.r=e,this._state.colorMask.g=t,this._state.colorMask.b=i,this._state.colorMask.a=r,this._stateTracker.invalidateColorWrite())}setClearColor(e,t,i,r){this._state.clearColor.r===e&&this._state.clearColor.g===t&&this._state.clearColor.b===i&&this._state.clearColor.a===r||(this.gl.clearColor(e,t,i,r),this._state.clearColor.r=e,this._state.clearColor.g=t,this._state.clearColor.b=i,this._state.clearColor.a=r)}setFaceCullingEnabled(e){this._state.faceCulling!==e&&(!0===e?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this._state.faceCulling=e,this._stateTracker.invalidateCulling())}setPolygonOffsetFillEnabled(e){this._state.polygonOffsetFill!==e&&(!0===e?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL),this._state.polygonOffsetFill=e,this._stateTracker.invalidatePolygonOffset())}setPolygonOffset(e,t){this._state.polygonOffset[0]===e&&this._state.polygonOffset[1]===t||(this._state.polygonOffset[0]=e,this._state.polygonOffset[1]=t,this.gl.polygonOffset(e,t),this._stateTracker.invalidatePolygonOffset())}setCullFace(e){this._state.cullFace!==e&&(this.gl.cullFace(e),this._state.cullFace=e,this._stateTracker.invalidateCulling())}setFrontFace(e){this._state.frontFace!==e&&(this.gl.frontFace(e),this._state.frontFace=e,this._stateTracker.invalidateCulling())}setScissorTestEnabled(e){this._state.scissorTest!==e&&(!0===e?this.gl.enable(this.gl.SCISSOR_TEST):this.gl.disable(this.gl.SCISSOR_TEST),this._state.scissorTest=e)}setScissorRect(e,t,i,r){this._state.scissorRect.x===e&&this._state.scissorRect.y===t&&this._state.scissorRect.width===i&&this._state.scissorRect.height===r||(this.gl.scissor(e,t,i,r),this._state.scissorRect.x=e,this._state.scissorRect.y=t,this._state.scissorRect.width=i,this._state.scissorRect.height=r)}setDepthTestEnabled(e){this._state.depthTest!==e&&(!0===e?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST),this._state.depthTest=e,this._stateTracker.invalidateDepthTest())}setClearDepth(e){this._state.clearDepth!==e&&(this.gl.clearDepth(e),this._state.clearDepth=e)}setDepthFunction(e){this._state.depthFunction!==e&&(this.gl.depthFunc(e),this._state.depthFunction=e,this._stateTracker.invalidateDepthTest())}setDepthWriteEnabled(e){this._state.depthWrite!==e&&(this.gl.depthMask(e),this._state.depthWrite=e,this._stateTracker.invalidateDepthWrite())}setDepthRange(e,t){this._state.depthRange.zNear===e&&this._state.depthRange.zFar===t||(this.gl.depthRange(e,t),this._state.depthRange.zNear=e,this._state.depthRange.zFar=t,this._stateTracker.invalidateDepthWrite())}setStencilTestEnabled(e){this._state.stencilTest!==e&&(!0===e?this.gl.enable(this.gl.STENCIL_TEST):this.gl.disable(this.gl.STENCIL_TEST),this._state.stencilTest=e,this._stateTracker.invalidateStencilTest())}setClearStencil(e){e!==this._state.clearStencil&&(this.gl.clearStencil(e),this._state.clearStencil=e)}setStencilFunction(e,t,i){this._state.stencilFunction.func===e&&this._state.stencilFunction.ref===t&&this._state.stencilFunction.mask===i||(this.gl.stencilFunc(e,t,i),this._state.stencilFunction.face=$i.LR.FRONT_AND_BACK,this._state.stencilFunction.func=e,this._state.stencilFunction.ref=t,this._state.stencilFunction.mask=i,this._stateTracker.invalidateStencilTest())}setStencilFunctionSeparate(e,t,i,r){this._state.stencilFunction.face===e&&this._state.stencilFunction.func===t&&this._state.stencilFunction.ref===i&&this._state.stencilFunction.mask===r||(this.gl.stencilFuncSeparate(e,t,i,r),this._state.stencilFunction.face=e,this._state.stencilFunction.func=t,this._state.stencilFunction.ref=i,this._state.stencilFunction.mask=r,this._stateTracker.invalidateStencilTest())}setStencilWriteMask(e){this._state.stencilWriteMask!==e&&(this.gl.stencilMask(e),this._state.stencilWriteMask=e,this._stateTracker.invalidateStencilWrite())}setStencilOp(e,t,i){this._state.stencilOperation.face===$i.LR.FRONT_AND_BACK&&this._state.stencilOperation.fail===e&&this._state.stencilOperation.zFail===t&&this._state.stencilOperation.zPass===i||(this.gl.stencilOp(e,t,i),this._state.stencilOperation.face=$i.LR.FRONT_AND_BACK,this._state.stencilOperation.fail=e,this._state.stencilOperation.zFail=t,this._state.stencilOperation.zPass=i,this._stateTracker.invalidateStencilTest())}setStencilOpSeparate(e,t,i,r){this._state.stencilOperation.face===e&&this._state.stencilOperation.fail===t&&this._state.stencilOperation.zFail===i&&this._state.stencilOperation.zPass===r||(this.gl.stencilOpSeparate(e,t,i,r),this._state.stencilOperation.face=e,this._state.stencilOperation.fail=t,this._state.stencilOperation.zFail=i,this._state.stencilOperation.zPass=r,this._stateTracker.invalidateStencilTest())}setActiveTexture(e,t=!1){const i=this._state.activeTexture;return e>=0&&(t||e!==this._state.activeTexture)&&(this.gl.activeTexture($i.V1+e),this._state.activeTexture=e),i}setDrawBuffers(e){const{drawFramebuffer:t}=this._state,i=null===t,r=i?this._state.drawBuffers.defaultFramebuffer:this._state.drawBuffers.fbos.get(t);if(r?.length!==e.length||!r.every(((t,i)=>t===e[i])))if(e.length>this.parameters.maxDrawBuffers)console.error("Setting more active draw buffers than GL.MAX_DRAW_BUFFERS allows.");else{if(i){if(e.length>1)return void console.error("The default framebuffer can only have one active draw buffer.");if(e[0]!==$i.Xg.BACK&&e[0]!==$i.Xg.NONE)return void console.error("The default framebuffer can only use the constants GL.BACK or GL.NONE as draw buffers.")}i||!e.includes($i.Xg.BACK)?(this.gl.drawBuffers(e),i?this._state.drawBuffers.defaultFramebuffer=e:this._state.drawBuffers.fbos.set(t,e),this._stateTracker.invalidateDrawBuffers()):console.error("A framebuffer object can only use the constants GL.COLOR_ATTACHMENTi or GL.NONE as draw buffers.")}}clear(e,t=255){if(e){if(e&$i.Hf.COLOR){const e=this._state.drawFramebuffer?.colorAttachments;e&&this.setDrawBuffers(e),this.setColorMask(!0,!0,!0,!0)}e&$i.Hf.DEPTH&&this.setDepthWriteEnabled(!0),e&$i.Hf.STENCIL&&this.setStencilWriteMask(t),this.gl.clear(e)}}clearFramebuffer(e,t=!1,i=!1){let r=0;if(e){const t=1e-13,i=Math.max(t,e[3]);this.setClearColor(e[0],e[1],e[2],i),r|=$i.Hf.COLOR}t&&(r|=$i.Hf.DEPTH),!1===i?i=0:(!0===i&&(i=255),r|=$i.Hf.STENCIL),r&&this.clear(r,i)}clearBuffer(e,t,i=$i.i5.COLOR,r){this.gl.clearBufferfv(i,e,t,r)}clearBufferInteger(e,t,i=$i.i5.COLOR,r){this.gl.clearBufferiv(i,e,t,r)}clearBufferUnsignedInteger(e,t,i=$i.i5.COLOR,r){this.gl.clearBufferuiv(i,e,t,r)}drawArrays(e,t,i){if(this._transformFeedbackRequestInfo){if(e!==this._transformFeedbackRequestInfo.primitiveType)throw new Error("DrawArrays called during transform feedback, but primitiveType does not match that of the current transform feedback request");if(null==this._state.program?.hasTransformFeedbackVaryings)throw new Error("DrawArrays called during transform feedback, but the shader program was not linked with a transform feedback varying")}if((0,LS.hZ)()&&(this._numOfDrawCalls++,this._numOfTriangles+=tP(e,i),(0,u.Z)("enable-feature:webgl-debug:textureReadWrite"))){const e=this._state.textureUnitMap;for(let t=0;t<e.length;t++){const i=e[t];if(null!=i&&i===this._state.drawFramebuffer?.colorTexture)throw new Error(`Detected readWrite. Texture already bound at index ${t}`)}}this.gl.drawArrays(e,t,i),(0,LS.zu)(this.gl)}drawArraysInstanced(e,t,i,r){this.gl.drawArraysInstanced(e,t,i,r),(0,LS.zu)(this.gl)}drawElements(e,t,i,r){if(this._transformFeedbackRequestInfo)throw new Error("Cannot called drawElements during a transform feedback request");if((0,LS.hZ)()&&(this._numOfDrawCalls++,this._numOfTriangles+=tP(e,t)),this.gl.drawElements(e,t,i,r),(0,LS.hZ)()){const n=(0,Er.HH)(this);if(n){const s=this.getBoundVAO(),a=s?.indexBuffer,o=s?.vertexBuffers,l={indexBuffer:a,vertexBuffers:o},c={mode:e,count:t,type:i,offset:r},h=a?.size??0,u=r+t,d=h<u?`. Buffer is too small. Attempted to draw index ${u} of ${h}`:"";console.error(`drawElements: ${n}${d}`,{args:c,vao:l})}}}drawElementsInstanced(e,t,i,r,n){this.gl.drawElementsInstanced(e,t,i,r,n),(0,LS.zu)(this.gl)}logInfo(){(0,LS.hZ)()&&console.log(`DrawCalls: ${this._numOfDrawCalls}, Triangles: ${this._numOfTriangles}`)}resetInfo(){(0,LS.hZ)()&&(this._numOfDrawCalls=0,this._numOfTriangles=0)}get capabilities(){return this._capabilities}setViewport(e,t,i,r){i=Math.max(Math.round(i),1),r=Math.max(Math.round(r),1);const n=this._state.viewport;n.x===e&&n.y===t&&n.width===i&&n.height===r||(n.x=e,n.y=t,n.width=i,n.height=r,this.gl.viewport(e,t,i,r))}setViewport4fv(e){this.setViewport(e[0],e[1],e[2],e[3])}restoreViewport({x:e,y:t,width:i,height:r}){this.setViewport(e,t,i,r)}getViewport(){const e=this._state.viewport;return{x:e.x,y:e.y,width:e.width,height:e.height}}useProgram(e){this._state.program!==e&&(this._state.program?.stop(),this._state.program=e,this.gl.useProgram(e?.glName??null))}bindTexture(e,t,i=!1){(t>=this.parameters.maxTextureImageUnits||t<0)&&console.error("Input texture unit is out of range of available units!");const r=this._state.textureUnitMap[t];return null==e?.glName?(null!=r&&(this.setActiveTexture(t,i),this.gl.bindTexture(r.descriptor.target,null)),this._state.textureUnitMap[t]=null,r):i||r!==e?(this.setActiveTexture(t,i),this.gl.bindTexture(e.descriptor.target,e.glName),e.applyChanges(),this._state.textureUnitMap[t]=e,r):(e.isDirty&&(this.setActiveTexture(t,i),e.applyChanges()),r)}unbindTexture(e){if(null!=e)for(let t=0;t<this.parameters.maxTextureImageUnits;t++)this._state.textureUnitMap[t]===e&&(this.bindTexture(null,t),this._state.textureUnitMap[t]=null)}bindFramebuffer(e,t=!1){if(t||this._state.readFramebuffer!==e||this._state.drawFramebuffer!==e){if(this._stateTracker.invalidateDrawBuffers(),null==e)return this.gl.bindFramebuffer($i.qi.FRAMEBUFFER,null),void(this._state.readFramebuffer=this._state.drawFramebuffer=null);e.initializeAndBind($i.qi.FRAMEBUFFER),this._state.readFramebuffer=e,this._state.drawFramebuffer=e}}bindFramebufferSeparate(e,t,i=!1){const r=t===$i.qi.READ_FRAMEBUFFER,n=r?this._state.readFramebuffer:this._state.drawFramebuffer;(i||n!==e)&&(null==e?this.gl.bindFramebuffer(t,null):e.initializeAndBind(t),r?this._state.readFramebuffer=e??null:(this._stateTracker.invalidateDrawBuffers(),this._state.drawFramebuffer=e??null))}blitFramebuffer(e,t,i=$i.Hf.COLOR,r=$i.cw.NEAREST,n=0,s=0,a=e.width,o=e.height,l=0,c=0,h=t.width,u=t.height){this.bindFramebufferSeparate(e,$i.qi.READ_FRAMEBUFFER,!0),this.bindFramebufferSeparate(t,$i.qi.DRAW_FRAMEBUFFER,!0),this.gl.blitFramebuffer(n,s,a,o,l,c,h,u,i,r)}bindBuffer(e,t){if(e)switch(t??=e.bufferType,t){case $i.w0.ARRAY_BUFFER:this._state.vertexBuffer=eP(this.gl,e,t,this._state.vertexBuffer);break;case $i.w0.ELEMENT_ARRAY_BUFFER:this._state.indexBuffer=eP(this.gl,e,t,this._state.indexBuffer);break;case $i.w0.UNIFORM_BUFFER:this._state.uniformBuffer=eP(this.gl,e,t,this._state.uniformBuffer);break;case $i.w0.PIXEL_PACK_BUFFER:this._state.pixelPackBuffer=eP(this.gl,e,t,this._state.pixelPackBuffer);break;case $i.w0.PIXEL_UNPACK_BUFFER:this._state.pixelUnpackBuffer=eP(this.gl,e,t,this._state.pixelUnpackBuffer);break;case $i.w0.COPY_READ_BUFFER:this._state.copyReadBuffer=eP(this.gl,e,t,this._state.copyReadBuffer);break;case $i.w0.COPY_WRITE_BUFFER:this._state.copyWriteBuffer=eP(this.gl,e,t,this._state.copyWriteBuffer);break;case $i.w0.TRANSFORM_FEEDBACK_BUFFER:this._state.transformFeedbackBuffer=eP(this.gl,e,t,this._state.transformFeedbackBuffer)}}bindRenderbuffer(e){const t=this.gl;e||(t.bindRenderbuffer(t.RENDERBUFFER,null),this._state.renderbuffer=null),this._state.renderbuffer!==e&&(t.bindRenderbuffer(t.RENDERBUFFER,e.glName),this._state.renderbuffer=e)}_getBufferBinding(e,t){if(t>=this.parameters.maxUniformBufferBindings||t<0)return console.error("Uniform buffer binding point is out of range!"),null;const i=e===$i.w0.UNIFORM_BUFFER?this._state.uniformBufferBindingPoints:this._state.transformBufferBindingPoints;let r=i[t];return null==r&&(r={buffer:null,offset:0,size:0},i[t]=r),r}bindBufferBase(e,t,i){const r=this._getBufferBinding(e,t);null!=r&&(r.buffer===i&&0===r.offset&&0===r.size||(this.gl.bindBufferBase(e,t,i?i.glName:null),r.buffer=i,r.offset=0,r.size=0))}bindBufferRange(e,t,i,r,n){const s=this._getBufferBinding(e,t);null!=s&&(s.buffer===i&&s.offset===r&&s.size===n||(r%this._parameters.uniformBufferOffsetAlignment==0?(this.gl.bindBufferRange(e,t,i.glName,r,n),s.buffer=i,s.offset=r,s.size=n):console.error("Uniform buffer binding offset is not a multiple of the context offset alignment")))}bindUBO(e,t,i,r){null!=t?((0,LS.hZ)()&&(r??t.byteLength)>this._parameters.maxUniformBlockSize&&console.error("Attempting to bind more data than the maximum uniform block size"),t.initialize(),void 0!==i&&void 0!==r?this.bindBufferRange($i.w0.UNIFORM_BUFFER,e,t.buffer,i,r):this.bindBufferBase($i.w0.UNIFORM_BUFFER,e,t.buffer)):this.bindBufferBase($i.w0.UNIFORM_BUFFER,e,null)}unbindUBO(e){for(let t=0,i=this._state.uniformBufferBindingPoints.length;t<i;t++){const i=this._state.uniformBufferBindingPoints[t];null!=i&&i.buffer===e.buffer&&this.bindBufferBase($i.w0.UNIFORM_BUFFER,t,null)}}unbindBuffer(e){switch(e){case $i.w0.ARRAY_BUFFER:this._state.vertexBuffer=eP(this.gl,null,e,this._state.vertexBuffer);break;case $i.w0.ELEMENT_ARRAY_BUFFER:this._state.indexBuffer=eP(this.gl,null,e,this._state.indexBuffer);break;case $i.w0.UNIFORM_BUFFER:this._state.uniformBuffer=eP(this.gl,null,e,this._state.uniformBuffer);break;case $i.w0.PIXEL_PACK_BUFFER:this._state.pixelPackBuffer=eP(this.gl,null,e,this._state.pixelPackBuffer);break;case $i.w0.PIXEL_UNPACK_BUFFER:this._state.pixelUnpackBuffer=eP(this.gl,null,e,this._state.pixelUnpackBuffer);break;case $i.w0.COPY_READ_BUFFER:this._state.copyReadBuffer=eP(this.gl,null,e,this._state.copyReadBuffer);break;case $i.w0.COPY_WRITE_BUFFER:this._state.copyWriteBuffer=eP(this.gl,null,e,this._state.copyWriteBuffer)}}bindVAO(e=null){null!=e?this._state.vertexArrayObject!==e&&(e.bind(),this._state.vertexArrayObject=e):this._state.vertexArrayObject&&(this._state.vertexArrayObject.unbind(),this._state.vertexArrayObject=null)}bindTransformFeedback(e){const{gl:t}=this;t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,e.glName)}beginTransformFeedback(e,t){if(this._transformFeedbackRequestInfo)throw new Error("Already in a transform feedback request");const{gl:i}=this;i.bindTransformFeedback(i.TRANSFORM_FEEDBACK,e.glName),i.beginTransformFeedback(t),this._transformFeedbackRequestInfo={primitiveType:t}}endTransformFeedback(){if(!this._transformFeedbackRequestInfo)throw new Error("Not in a transform feedback request");const{gl:e}=this;e.endTransformFeedback(),e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,null),this._transformFeedbackRequestInfo=null}async clientWaitAsync(e=(0,ur.HA)(10)){const{gl:t}=this,i=t.fenceSync($i.V7.SYNC_GPU_COMMANDS_COMPLETE,0);if(!i)throw new Error("Client wait failed, could not create sync object");let r;this.instanceCounter.increment($i._g.Sync,i),t.flush();do{await(0,f.e4)(e),r=t.clientWaitSync(i,0,0)}while(r===$i.Y5.TIMEOUT_EXPIRED);if(this.instanceCounter.decrement($i._g.Sync,i),t.deleteSync(i),r===$i.Y5.WAIT_FAILED)throw new Error("Client wait failed")}getBoundFramebufferObject(e=$i.qi.FRAMEBUFFER){return e===$i.qi.READ_FRAMEBUFFER?this._state.readFramebuffer:this._state.drawFramebuffer}temporaryBindFramebufferObject(e,t,i=!1){const r=this.getBoundFramebufferObject();try{this.bindFramebuffer(e,i),t()}finally{this.bindFramebuffer(r,i)}}getBoundVAO(){return this._state.vertexArrayObject}resetState(){this.useProgram(null),this.bindVAO(null),this.bindFramebuffer(null,!0),this.unbindBuffer($i.w0.ARRAY_BUFFER),this.unbindBuffer($i.w0.ELEMENT_ARRAY_BUFFER),this.unbindBuffer($i.w0.UNIFORM_BUFFER),this._state.uniformBufferBindingPoints.length=0,this.unbindBuffer($i.w0.PIXEL_PACK_BUFFER),this.unbindBuffer($i.w0.PIXEL_UNPACK_BUFFER),this.unbindBuffer($i.w0.COPY_READ_BUFFER),this.unbindBuffer($i.w0.COPY_WRITE_BUFFER);for(let e=0;e<this.parameters.maxTextureImageUnits;++e)this.bindTexture(null,e);this.setBlendingEnabled(!1),this.setBlendFunction($i.zi.ONE,$i.zi.ZERO),this.setBlendEquation($i.db.ADD),this.setBlendColor(0,0,0,0),this.setFaceCullingEnabled(!1),this.setCullFace($i.LR.BACK),this.setFrontFace($i.Wf.CCW),this.setPolygonOffsetFillEnabled(!1),this.setPolygonOffset(0,0),this.setScissorTestEnabled(!1),this.setScissorRect(0,0,this.gl.canvas.width,this.gl.canvas.height),this.setDepthTestEnabled(!1),this.setDepthFunction($i.wb.LESS),this.setDepthRange(0,1),this.setStencilTestEnabled(!1),this.setStencilFunction($i.wb.ALWAYS,0,0),this.setStencilOp($i.xS.KEEP,$i.xS.KEEP,$i.xS.KEEP),this.setClearColor(0,0,0,0),this.setClearDepth(1),this.setClearStencil(0),this.setColorMask(!0,!0,!0,!0),this.setStencilWriteMask(4294967295),this.setDepthWriteEnabled(!0),this.setDrawBuffers([$i.Xg.BACK]),this.setViewport(0,0,this.gl.canvas.width,this.gl.canvas.height)}enforceState(){const{gl:e}=this;e.bindVertexArray(null);for(let t=0;t<this.parameters.maxVertexAttributes;t++)e.disableVertexAttribArray(t);this._state.vertexBuffer?e.bindBuffer(this._state.vertexBuffer.bufferType,this._state.vertexBuffer.glName):e.bindBuffer($i.w0.ARRAY_BUFFER,null),this._state.indexBuffer?e.bindBuffer(this._state.indexBuffer.bufferType,this._state.indexBuffer.glName):e.bindBuffer($i.w0.ELEMENT_ARRAY_BUFFER,null),this._state.uniformBuffer?e.bindBuffer(this._state.uniformBuffer.bufferType,this._state.uniformBuffer.glName):e.bindBuffer($i.w0.UNIFORM_BUFFER,null);for(let t=0;t<this._parameters.maxUniformBufferBindings;t++){const i=this._state.uniformBufferBindingPoints[t];if(null!=i){const{buffer:r,offset:n,size:s}=i;null!==r?0===n&&0===s?e.bindBufferBase($i.w0.UNIFORM_BUFFER,t,r.glName):e.bindBufferRange($i.w0.UNIFORM_BUFFER,t,r.glName,n,s):e.bindBufferBase($i.w0.UNIFORM_BUFFER,t,null)}}if(this._state.pixelPackBuffer?e.bindBuffer(this._state.pixelPackBuffer.bufferType,this._state.pixelPackBuffer.glName):e.bindBuffer($i.w0.PIXEL_PACK_BUFFER,null),this._state.pixelUnpackBuffer?e.bindBuffer(this._state.pixelUnpackBuffer.bufferType,this._state.pixelUnpackBuffer.glName):e.bindBuffer($i.w0.PIXEL_UNPACK_BUFFER,null),this._state.copyReadBuffer?e.bindBuffer(this._state.copyReadBuffer.bufferType,this._state.copyReadBuffer.glName):e.bindBuffer($i.w0.COPY_READ_BUFFER,null),this._state.copyWriteBuffer?e.bindBuffer(this._state.copyWriteBuffer.bufferType,this._state.copyWriteBuffer.glName):e.bindBuffer($i.w0.COPY_WRITE_BUFFER,null),e.bindFramebuffer($i.qi.READ_FRAMEBUFFER,null),e.readBuffer(e.BACK),this._state.readFramebuffer&&(e.bindFramebuffer($i.qi.READ_FRAMEBUFFER,this._state.readFramebuffer.glName),e.readBuffer($i.Ii)),e.bindFramebuffer($i.qi.DRAW_FRAMEBUFFER,this._state.drawFramebuffer?.glName??null),null===this._state.drawFramebuffer){const t=this._state.drawBuffers.defaultFramebuffer;e.drawBuffers(t??[$i.Xg.BACK])}else{const t=this._state.drawBuffers.fbos.get(this._state.drawFramebuffer);e.drawBuffers(t??[$i.Ii])}if(this._state.vertexArrayObject){const e=this._state.vertexArrayObject;this._state.vertexArrayObject&&(this._state.vertexArrayObject.unbind(),this._state.vertexArrayObject=null),this.bindVAO(e)}e.useProgram(this._state.program?.glName??null),e.blendColor(this._state.blendColor.r,this._state.blendColor.g,this._state.blendColor.b,this._state.blendColor.a),e.bindRenderbuffer(e.RENDERBUFFER,this._state.renderbuffer?.glName??null),!0===this._state.blend?e.enable(this.gl.BLEND):e.disable(this.gl.BLEND),e.blendEquationSeparate(this._state.blendEquation.mode,this._state.blendEquation.modeAlpha),e.blendFuncSeparate(this._state.blendFunction.srcRGB,this._state.blendFunction.dstRGB,this._state.blendFunction.srcAlpha,this._state.blendFunction.dstAlpha),e.clearColor(this._state.clearColor.r,this._state.clearColor.g,this._state.clearColor.b,this._state.clearColor.a),e.clearDepth(this._state.clearDepth),e.clearStencil(this._state.clearStencil),e.colorMask(this._state.colorMask.r,this._state.colorMask.g,this._state.colorMask.b,this._state.colorMask.a),e.cullFace(this._state.cullFace),e.depthFunc(this._state.depthFunction),e.depthRange(this._state.depthRange.zNear,this._state.depthRange.zFar),!0===this._state.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),e.depthMask(this._state.depthWrite),e.frontFace(this._state.frontFace),e.lineWidth(1),!0===this._state.faceCulling?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),e.polygonOffset(this._state.polygonOffset[0],this._state.polygonOffset[1]),!0===this._state.polygonOffsetFill?e.enable(e.POLYGON_OFFSET_FILL):e.disable(e.POLYGON_OFFSET_FILL),e.scissor(this._state.scissorRect.x,this._state.scissorRect.y,this._state.scissorRect.width,this._state.scissorRect.height),!0===this._state.scissorTest?e.enable(e.SCISSOR_TEST):e.disable(e.SCISSOR_TEST),e.stencilFunc(this._state.stencilFunction.func,this._state.stencilFunction.ref,this._state.stencilFunction.mask),e.stencilOpSeparate(this._state.stencilOperation.face,this._state.stencilOperation.fail,this._state.stencilOperation.zFail,this._state.stencilOperation.zPass),!0===this._state.stencilTest?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),e.stencilMask(this._state.stencilWriteMask);for(let t=0;t<this.parameters.maxTextureImageUnits;t++){e.activeTexture($i.V1+t),e.bindTexture($i.No.TEXTURE_2D,null),e.bindTexture($i.No.TEXTURE_CUBE_MAP,null),e.bindTexture($i.No.TEXTURE_3D,null),e.bindTexture($i.No.TEXTURE_2D_ARRAY,null);const i=this._state.textureUnitMap[t];null!=i&&e.bindTexture(i.descriptor.target,i.glName)}e.activeTexture($i.V1+this._state.activeTexture);const t=this._state.viewport;e.viewport(t.x,t.y,t.width,t.height),this.resetInfo()}};function eP(e,t,i,r){return t?r!==t&&e.bindBuffer(i,t.glName):e.bindBuffer(i,null),t}function tP(e,t){switch(e){case $i.MX.POINTS:return 2*t;case $i.MX.TRIANGLES:return t/3;case $i.MX.TRIANGLE_STRIP:case $i.MX.TRIANGLE_FAN:return t-2;default:return 0}}class iP extends JE{constructor(e,t){super(e,t),this.emptyTexture=(0,mb.l_)(this),this._vaoCaches=new Iw.r,this._appleAmdDriverHelper=null,this._refCount=1,this._newCache=t.newCache,this.screen=new oE(this)}configure(e){super.configure(e),this._newCache=e.newCache}destroy(){this._vaoCaches?.forAll((e=>e.dispose())),this._vaoCaches?.clear(),--this._refCount>0||this.dispose()}ref(){++this._refCount}dispose(){this.emptyTexture.dispose(),this.screen.destroy(),super.dispose(),this._appleAmdDriverHelper?.dispose(),this._vaoCaches.forAll((e=>e.dispose())),this._vaoCaches.clear()}get newCache(){return this._newCache}getVaoCache(e,t){const i=Array.from(e).join("."),r=JSON.stringify(t),n=this._vaoCaches.get(i,r);if(n)return n;const s=new lE(this,e,t);return this._vaoCaches.set(i,r,s),s}bindTechnique(e,t,i,r){return this.useProgram(e.program),this.setPipelineState(e.getPipeline()),e.program.bind(t),i&&(e.program.bindPass(i,t),r&&e.program.bindDraw(t,i,r)),e.program}runAppleAmdDriverHelper(){this.driverTest.drawArraysRequiresIndicesTypeReset.result&&(this._appleAmdDriverHelper??=new cE(this),this._appleAmdDriverHelper.run())}get isAssumedMetalDriver(){if(null==this._isAssumedMetalDriver&&(this._isAssumedMetalDriver=!!(0,u.Z)("ios")||!!(0,u.Z)("safari"),!this._isAssumedMetalDriver&&(0,u.Z)("mac")&&(0,u.Z)("chrome"))){const e=this.capabilities.rendererInfo?.getUnmaskedRenderer().toLowerCase(),t=e?.includes("apple")&&e?.includes("angle")&&e?.includes("metal");this._isAssumedMetalDriver=t??!0}return this._isAssumedMetalDriver}get test(){}}var rP=i(71356);class nP{constructor(){this._updating=new Map}add(e){this._updating.set(e.id,new sP(e))}remove(e){this._updating.delete(e.id)}run(){let e=!1;return this._updating.forEach((t=>{const i=t.texture.update(t.previousToken);i>=0&&i!==t.previousToken&&(t.previousToken=i,e=!0)})),e}}class sP{constructor(e){this.texture=e,this.previousToken=-1}}let aP=class extends S.Z{constructor(e){super({}),this._stage=e,this._textures=new Map,this._loadingCount=0,this.events=new ae.Z,this.updater=new nP,this._frameTask=e.view.resourceController.scheduler.registerTask(nr.T8.TEXTURE_UNLOAD)}normalizeCtorArgs(){return{}}destroy(){this._frameTask.remove(),this._stage.forEachTexture((e=>e.unload()))}get updating(){return this._loadingCount>0||this._frameTask.updating}acquire(e){const t=this._textures.get(e);return t?(t.ref(),t.loadingPromise??t):this._createNewRef(e)}update(){this.updater.run()&&this.events.emit("changed",Cr.Xx.BACKGROUND)}_createNewRef(e){const t=this._stage.getTexture(e);if(null==t)return null;const i=t.events.on("unloaded",(()=>{i.remove(),this._onTextureUnloaded(t)})),r=new oP(e,(()=>{this._frameTask.schedule((()=>{r.isUnreferenced&&t.unload()}))}));return this._textures.set(e,r),r.ref(),t.loaded?(this._updateGLTexture(r,t.glTexture),(0,rP.f)(t)&&this.updater.add(t),r):(this._loadingCount++,r.loadingPromise=this._stage.schedule((()=>{const e=t.load(this._stage.renderView.renderingContext),i=e=>(this._loadingCount--,r.loadingPromise=null,this._updateGLTexture(r,e),(0,rP.f)(t)&&this.updater.add(t),r);return(0,f.y8)(e)?e.then(i,(e=>(this._loadingCount--,r.loadingPromise=null,(0,f.D_)(e)||d.Z.getLogger(this).error(e),null))):i(e)})),r.loadingPromise)}_updateGLTexture(e,t){e.glTexture=t,this.events.emit("changed",Cr.Xx.UPDATE)}_onTextureUnloaded(e){this._textures.delete(e.id),this.updater.remove(e)}};(0,r._)([(0,w.Cb)()],aP.prototype,"_loadingCount",void 0),(0,r._)([(0,w.Cb)()],aP.prototype,"_frameTask",void 0),(0,r._)([(0,w.Cb)()],aP.prototype,"updating",null),aP=(0,r._)([(0,x.j)("esri.views.3d.webgl-engine.lib.TextureRepository")],aP);class oP{constructor(e,t){this.id=e,this._release=t,this._refCount=0}get isUnreferenced(){return 0===this._refCount}ref(){++this._refCount}release(){--this._refCount,this._refCount>0||(0!==this._refCount?(d.Z.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository.RefCountedTextureImpl").error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}}var lP=i(35567),cP=i(42131);var hP=i(41830);let uP=class extends S.Z{constructor(){super(...arguments),this._passParameters=new dP,this._resourcesTask=null}get passParameters(){return this._passParameters}destroy(){this._resourcesTask=(0,p.IM)(this._resourcesTask),this._passParameters.waveNormal=(0,p.M2)(this._passParameters.waveNormal),this._passParameters.wavePerturbation=(0,p.M2)(this._passParameters.wavePerturbation)}get updating(){return!!this._resourcesTask&&!this._resourcesTask.finished}ensureResources(e){return this._resourcesTask||(this._resourcesTask=(0,me.vr)((async t=>{await Promise.allSettled([this._loadImageResource(e,(0,FT.V)("esri/images/materials/water/normals.jpg"),(e=>this._passParameters.waveNormal=e),t),this._loadImageResource(e,(0,FT.V)("esri/images/materials/water/perturbation.jpg"),(e=>this._passParameters.wavePerturbation=e),t)])}))),this._resourcesTask.finished?Cr.Rw.LOADED:Cr.Rw.LOADING}async _loadImageResource(e,t,i,r){try{const n=await(0,CT.t)(t,{signal:r});(0,f.k_)(r);const s=new ir.X(n.width,n.height);s.pixelFormat=$i.VI.RGB,s.samplingMode=$i.cw.LINEAR_MIPMAP_LINEAR,s.hasMipmap=!0,s.maxAnisotropy=8,i(new Ed.x(e,s,n))}catch(e){d.Z.getLogger(this).error("Failed to load water material normal texture.",e)}}};(0,r._)([(0,w.Cb)()],uP.prototype,"_resourcesTask",void 0),(0,r._)([(0,w.Cb)({type:Boolean,readOnly:!0})],uP.prototype,"updating",null),uP=(0,r._)([(0,x.j)("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],uP);class dP extends fr.K{}const pP=new Map;function mP(){return pP}var fP=i(53433),_P=i(35236);class gP{constructor(e,t){this.parameters=e,this.fbos=t}}class yP{constructor(e,t,i){this._rctx=e,this._renderFunctions=t,this._forceCameraHook=i,this.supersample=!0,this._screenshotQueue=new Array}destroy(){this._rctx=null}async takeScreenshot(e){await this._renderFunctions.prepareOverlay(),this._renderFunctions.requestRenderScene(Cr.Xx.BACKGROUND);const t=(0,f.hh)();return this._screenshotQueue.push({settings:e,resolver:t}),t.promise}update(e,t){for(const i of this._screenshotQueue){if(null==this._rctx){i.resolver.reject();continue}const r={...i.settings,pixelRatio:i.settings.pixelRatio*e.parameters.camera.pixelRatio},n=this._renderScreenshot(e,r,t);i.resolver(n)}this._screenshotQueue.length=0}_renderScreenshotOverlay(e,t,i){e.width=t.width,e.height=t.height;const r=e.getContext("2d",{willReadFrequently:!0}),n=i.pixelRatio;return r.save(),r.translate(0,t.height),r.scale(1,-1),i.region&&r.translate(-i.region.x,-i.region.y),r.scale(n,n),t=this._renderFunctions.renderOverlay(e,i.disableDecorations,t),r.restore(),t}_readbackScreenshot(e,t){return e.resample?this._readbackScreenshotResampled({...e,resample:e.resample},t):this._readbackScreenshotImmediate(e,t)}_readbackScreenshotResampled(e,t){const{framebufferWidth:i,framebufferHeight:r,region:n,resample:s}=e,a=this._ensureScreenshotEncodeCanvas();let o=(0,_P.r7)(i,r,a);this._rctx.gl.readPixels(0,0,i,r,$i.VI.RGBA,$i.g.UNSIGNED_BYTE,new Uint8Array(o.data.buffer)),t(),o=this._renderScreenshotOverlay(a,o,{...e,region:void 0});const l=(0,_P.r7)(n.width,n.height,a);return(0,fP.resampleHermite)(o,l,!0,s.region.x,r-(s.region.y+s.region.height),s.region.width,s.region.height)}_readbackScreenshotImmediate(e,t){const{framebufferHeight:i,region:r}=e,n=this._ensureScreenshotEncodeCanvas(),s=(0,_P.r7)(r.width,r.height,n);return this._rctx.gl.readPixels(r.x,i-(r.y+r.height),r.width,r.height,$i.VI.RGBA,$i.g.UNSIGNED_BYTE,new Uint8Array(s.data.buffer)),t(),this._renderScreenshotOverlay(n,s,e)}_renderScreenshot(e,t,i){const r=e.parameters.camera,n={width:t.framebufferWidth,height:t.framebufferHeight};(0,tr.d)(n,Math.min(this._rctx.parameters.maxTextureSize,this._rctx.parameters.maxRenderbufferSize));let s=!1;const a=n.width!==r.fullWidth||n.height!==r.fullHeight,o=t.ignorePadding&&r.pixelRatio!==t.pixelRatio,l=a||t.disableDecorations||o||t.objectAndLayerIdColor;let c=null,h=null;if(l){const e=r.clone();if(t.ignorePadding){const i=(0,tc.d9)(e.padding);for(let r=0;r<4;r++)i[r]=Math.round(i[r]/e.pixelRatio*t.pixelRatio);e.padding=i}e.fullWidth=n.width,e.fullHeight=n.height,e.pixelRatio=t.pixelRatio;const a=r.fovX-e.fovX,o=r.fovY-e.fovY;a<0&&a<o?e.fovX=r.fovX:o<0&&o<a&&(e.fovY=r.fovY);const l={camera:e,contentCamera:e,mode:$c.n.IDLE,alignPixelEnabled:!0,contentPixelRatio:e.pixelRatio};this._forceCameraHook(l),s=!0;const u=this._renderFunctions.renderScene(l,i,t.objectAndLayerIdColor?Zc.YE.ObjectAndLayerID:Zc.YE.Screenshot,t.disableDecorations);h=u.screen,c=u.olid}this._rctx.bindFramebuffer(h?.fbo);const u=this._readbackScreenshot(t,(()=>{this._rctx.bindFramebuffer(null),h?.release()}));let d=null;if(t.objectAndLayerIdColor){const e=()=>{this._rctx.bindFramebuffer(null),c?.release()};this._rctx.bindFramebuffer(c?.fbo),d=this._readbackScreenshot(t,e),this._rctx.bindFramebuffer(null)}if(l&&!this._rctx.contextAttributes.alpha)for(let e=3;e<u.data.length;e+=4)u.data[e]=255;if(d&&!this._rctx.contextAttributes.alpha)for(let e=3;e<d.data.length;e+=4)d.data[e]=255;return s&&this._forceCameraHook(e.parameters),[u,d]}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas??=document.createElement("canvas"),this._screenshotEncodeCanvas}}const vP=!1;let bP=class extends S.Z{constructor(e){super(e),this.events=new ae.Z,this.waterTextures=new uP,this.olidRenderHelper=(0,Fx.B)()?new eS:null,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._lastAnimationUpdate=0,this.bloom=null,this.test=null;const t=e.stage;try{this._initializeContext(t)}catch(e){return void console.error("Failed to initialize context",e)}const{memoryController:i}=t.view.resourceController;this.stippleTextures=(0,hP.kW)(this._rctx,i),this.markerTextures=function(e,t){return new cP.t((t=>(0,lP.LM)(t,e)),(e=>e),t)}(this._rctx,i),this._techniques=new Zx(new qx(this._rctx,t.viewingMode,this.stippleTextures,this.waterTextures,this.markerTextures)),this._textures=new aP(t),this.addHandles(this._textures.events.on("changed",(e=>this.requestRender(e))));const r=new JT.h(this._textures,this._techniques,(()=>this.requestRender()),(()=>this.requestRender()));this._compositingHelper=new QT(this._rctx,this._techniques),this.renderer=new WM(t,r,this._techniques,this._rctx,this._compositingHelper,(e=>this.requestRender(e))),this.addHandles([(0,_.YP)((()=>t.view.ready),(e=>{e&&this._createRenderNodes()}),_.nn),(0,_.YP)((()=>this.waterTextures?.updating),(()=>this.requestRender()),_.nn),(0,_.YP)((()=>t.view.qualityProfile),(e=>this.renderer?.updateRenderFeatures(e)),_.tX)]);const n={renderScene:(e,t,i,r)=>this.renderer.render(e,t,i,r),requestRenderScene:e=>this.requestRender(e),prepareOverlay:()=>t.options.screenshot.prepareOverlay(),renderOverlay:(e,i,r)=>t.options.screenshot.renderOverlay(e,i,r)};this._screenshotManager=new yP(this._rctx,n,(e=>this.events.emit("force-camera-for-screenshot",e))),this._registerFrameTask(t)}destroy(){const e=this.stage?.container;e?.contains(this._canvas)&&e.removeChild(this._canvas),this._frameTask=(0,p.hw)(this._frameTask),this._techniques=(0,p.SC)(this._techniques),this._componentObjects=(0,p.SC)(this._componentObjects),this._screenshotManager=(0,p.SC)(this._screenshotManager),(0,p.SC)(this.renderer),this._textures=(0,p.SC)(this._textures),(0,p.SC)(this.waterTextures),(0,p.SC)(this.markerTextures),(0,p.SC)(this.stippleTextures),this._canvas=null,this._rctx=(0,p.SC)(this._rctx)}_createRenderNodes(){const{view:e,viewingMode:t}=this.stage;new VT({view:e}),(0,Ee.V2)(e.spatialReference)||(t===Ht.JY.Local?(new mC({view:e}),this.bloom=new Jx({view:e})):(0,Ee.BZ)(e.spatialReference)?(new PC({view:e}),this.bloom=new Jx({view:e})):(new Kw({view:e}),new eC({view:e}),this.bloom=new Jx({view:e}),new mT({view:e}),new rC({view:e}))),new NT.K({view:e,isEnabled:()=>this.renderer.hasSSAO}),new IT({view:e,isEnabled:()=>this.renderer.hasSMAA}),new ST({view:e}),new fT.y$({view:e}),new bT({view:e,viewingMode:t}),new nT({view:e}),(0,Fx.B)()&&new tT({view:e})}requestRender(e=Cr.Xx.UPDATE){this._needsRender=!0,e===Cr.Xx.UPDATE&&(this._needsUpdate=!0)}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this.renderer.updating||this._textures.updating||this.waterTextures.updating}get textures(){return this._textures}get techniques(){return this._techniques}get compositingHelper(){return this._compositingHelper}setIdleSuspend(e){this._idleSuspend!==e&&(this._idleSuspend=e,this.requestRender())}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}get canvas(){return this._canvas}takeScreenshot(e){return this._screenshotManager.takeScreenshot(e).then((e=>e[0]))}takeScreenshotWithOID(e){return e.objectAndLayerIdColor=!0,this._screenshotManager.takeScreenshot(e)}getAlpha(){return!!this._rctx.contextAttributes.alpha}getMinimalDepthForArea(e,t,i,r,n,s=n){const a=r.constrainWindowSize(t,i,n*r.pixelRatio,s*r.pixelRatio),o=this._ensureLinearDepthArrayBuffer(a);this.renderer.readMainDepth(a,o);const l=(e,t,i)=>(0,Bw.v)(t,e)*(i[1]-i[0])+i[0];let c=Number.MAX_VALUE;for(let e=0;e<a[2]*a[3];e++){const t=l(4*e,o,r.nearFar);c>t&&t!==r.nearFar[0]&&t!==r.nearFar[1]&&(c=t)}if(e){const n=e.pickDepth(t*r.pixelRatio,i*r.pixelRatio,r);null!=n&&c>n&&n!==r.nearFar[0]&&n!==r.nearFar[1]&&(c=n)}return c===Number.MAX_VALUE?void 0:c}_ensureLinearDepthArrayBuffer(e){const t=4*e[2]*e[3];return(null==this._tmpDepthBuffer||this._tmpDepthBuffer.byteLength<t)&&(this._tmpDepthBuffer=new Uint8Array(t)),this._tmpDepthBuffer}async reloadShaders(){ag(),await this._techniques.reloadAll(),this.renderer.overlay?.reloadShaders(),this.requestRender()}_registerFrameTask(e){const t=e.view.state;let i=!1,r=Cr.Xx.BACKGROUND,n=!1;const s={preRender:({time:n})=>{i=this.updating,r=this._needsUpdate?Cr.Xx.UPDATE:Cr.Xx.BACKGROUND,this._needsRender&&this.renderer.updateSceneDepthRange(t.camera),e.commitSyncLayers(),n=this.test?.time??n,((0,ur.HA)(n-this._lastAnimationUpdate)>this.renderer.animationTimestep||i||this._needsRender)&&(this.renderer.updateAnimation(t,n)&&this.requestRender(Cr.Xx.BACKGROUND),this._lastAnimationUpdate=n)},render:({time:e})=>{if((this._needsRender||!this._idleSuspend||!this.renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&t.camera.fullWidth>0&&t.camera.fullHeight>0){const i=this._needsUpdate&&this._idleSuspend&&this.renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,e=this.test?.time??e,this.renderer.render(t,e),n=!0,i&&this.renderer.hasReflections&&(this.requestRender(Cr.Xx.BACKGROUND),this._needsWaterReflectionUpdate=!0)}},update:({time:e})=>{this._textures.update();const i=new gP(t,this.renderer.fboCache);e=this.test?.time??e,this._screenshotManager.update(i,e)},finish:()=>{n&&(this.renderer.finish(t.mode===$c.n.IDLE?r:Cr.Xx.UPDATE),n=!1)}};this._frameTask=(0,g.A)(s)}_initializeContext(e){const{options:t}=e,i=t.canvas??document.createElement("canvas");i.setAttribute("style","width: 100%; height:100%; display:block;"),this._canvas=i;const r={alpha:t.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:t.stencil??!0,powerPreference:"high-performance",preserveDrawingBuffer:t.preserveDrawingBuffer??!1},n=i.getContext("webgl2",r);if(null==n)return void d.Z.getLogger(this).error("A WebGL2 context could not be created.");(0,LS.zu)(n,!0),this._rctx=function(e,t){const i=(e,i)=>t.view.resourceController.memoryController.newCache(e,i),r={disabledExtensions:t.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:t.options.debugWebGLExtensions||{},maxAnisotropy:8,maxPreferredTexturePixels:t.view.qualitySettings.maxTexturePixels,newCache:i};if(vP){let t=wP.get(e);return t?(t.configure(r),t.ref(),t):(t=new iP(e,r),wP.set(e,t),t.ref(),t)}return new iP(e,r)}(n,e),this._loadShaderOnlyExtensions(),!t.alpha&&this._rctx.contextAttributes.alpha&&d.Z.getLogger(this).error("WebGL context has alpha channel even though no alpha channel was requested");const{container:s}=e;!this._rctx.contextAttributes.alpha&&(0,u.Z)("safari")>=11&&(s.style.backgroundColor="black"),s.contains(i)||s.appendChild(i)}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("textureFloatLinear")}get _viewingMode(){return this.stage.viewingMode}getObjectAndLayerIdColor(e){return this.olidRenderHelper?.getObjectAndLayerIdColor(e)}get componentObjectCollection(){return null==this._componentObjects&&(this._componentObjects=new Vx(this.renderer.renderPassManager,this._viewingMode)),this._componentObjects}set componentObjectCollection(e){this._componentObjects=e}updateQualitySettings(e){this.test&&null!=this.test.time&&(this.test.savedFadeDuration=e.fadeDuration,e.fadeDuration=(0,ur.HA)(0)),this._rctx.updateOptions({maxPreferredTexturePixels:this.stage.view.qualitySettings.maxTexturePixels})}};(0,r._)([(0,w.Cb)({type:Boolean,readOnly:!0})],bP.prototype,"updating",null),(0,r._)([(0,w.Cb)({constructOnly:!0})],bP.prototype,"stage",void 0),(0,r._)([(0,w.Cb)()],bP.prototype,"_rctx",void 0),(0,r._)([(0,w.Cb)()],bP.prototype,"_canvas",void 0),(0,r._)([(0,w.Cb)()],bP.prototype,"stippleTextures",void 0),(0,r._)([(0,w.Cb)()],bP.prototype,"markerTextures",void 0),(0,r._)([(0,w.Cb)()],bP.prototype,"waterTextures",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],bP.prototype,"olidRenderHelper",void 0),(0,r._)([(0,w.Cb)()],bP.prototype,"_textures",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],bP.prototype,"renderer",void 0),(0,r._)([(0,w.Cb)()],bP.prototype,"_screenshotManager",void 0),(0,r._)([(0,w.Cb)()],bP.prototype,"componentObjectCollection",null),(0,r._)([(0,w.Cb)()],bP.prototype,"_componentObjects",void 0),(0,r._)([(0,w.Cb)()],bP.prototype,"_needsUpdate",void 0),(0,r._)([(0,w.Cb)()],bP.prototype,"_needsWaterReflectionUpdate",void 0),bP=(0,r._)([(0,x.j)("esri.views.3d.webgl-engine.parts.RenderView")],bP);const wP=mP();let CP=class extends S.Z{constructor(e){super(e),this._model=new kw,this._canCompact=(0,Di.t)(!1),this._layers=new cd.Z,this._asyncChangeSet=new Aw.as,this._syncChangeSet=new Aw.as,this._layerSyncSet=new Set,this.textures=new $f(this,e.view.resourceController.scheduler),this._frameTask=e.view.resourceController.scheduler.registerTask(nr.T8.STAGE,this),this.addHandles(this._frameTask)}initialize(){this._renderView=new bP({stage:this})}destroy(){this.textures.destroy(),this.renderView.destroy()}get viewingMode(){return this.view.state.viewingMode}get updating(){return this.running||this.renderView.updating||this._frameTask.updating||this.textures.updating}get renderView(){return this._renderView}get renderer(){return this.renderView.renderer}addTexture(e){this._model.addTexture(e),this.renderView.requestRender()}removeTexture(e){null!=e&&!this.destroyed&&this._model.hasTexture(e)&&(this._model.removeTexture(e),this.renderView.requestRender())}addTextures(e){null!=e&&(this._model.addTextures(e),this.renderView.requestRender())}removeTextures(e){null!=e&&(this._model?.removeTextures(e),this.renderView.requestRender())}forEachTexture(e){this._model.forEachTexture(e)}getTexture(e){return this._model.getTexture(e)}addLayer(e){this._layers.includes(e)||(this._model.addLayer(e),this._layers.push(e),this._model.dirtySet.layerAdded(e),this.renderView.requestRender())}removeLayer(e){null!=e&&!this.destroyed&&this._model.hasLayer((0,Hi.CY)(e))&&(this._model.dirtySet.layerRemoved(e),this._commitLayer(e),this._layers.removeUnordered(e),this._model.dirtySet.assertLayerClean(e.id),this._model.removeLayer(e),this.renderView.requestRender())}getLayer(e){return this._model.getLayer(e)}handleEvent(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.requestRender())}get running(){return this._model.dirtySet.dirty||!this._asyncChangeSet.empty||this._canCompact.value}runTask(e){if(this._frameTask.processQueue(e),this._commit(e),this.renderer.compact(e),this._canCompact.value=this.renderer.canCompact,!e.hasProgressed)return sr.J}compact(e){return this._canCompact.value=!1,this.renderer.compact(e)}_commit(e){const t=this._model.dirtySet;this._asyncChangeSet.empty||e.done||(this.renderer.commit(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()),this._layers.forAll((i=>{if(e.done)return;const r=this._layerSyncSet.has(i.id)||i.updatePolicy===Ow.j.SYNC,n=r?this._syncChangeSet:this._asyncChangeSet;t.commitLayer(i.id,n),this._layerSyncSet.delete(i.id),n.empty||(this.renderer.commit(n,r?nr.G5:e),this.renderView.requestRender(),e.madeProgress())})),this._syncChangeSet.empty||(this.renderer.commit(this._syncChangeSet,nr.G5),this.renderView.requestRender(),e.madeProgress()),this._layers.forAll((i=>{e.done||this._layerSyncSet.has(i.id)||i.updatePolicy!==Ow.j.ASYNC||(t.commitLayer(i.id,this._asyncChangeSet),this._asyncChangeSet.empty||(this.renderer.commit(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()))})),this._layerSyncSet.clear(),this.notifyChange("running")}commitSyncLayers(){const e=this._model.dirtySet;this._layers.forAll((t=>{this._layerSyncSet.has(t.id)||t.updatePolicy===Ow.j.SYNC?(e.commitLayer(t.id,this._syncChangeSet),this._layerSyncSet.delete(t.id)):e.commitSyncUpdates(t.id,this._syncChangeSet)}));for(const t of this._layerSyncSet)e.commitLayer(t,this._syncChangeSet);this._layerSyncSet.clear(),this._syncChangeSet.empty||(this.renderer.commit(this._syncChangeSet,nr.G5),this.renderView.requestRender())}_commitLayer(e){this._model.dirtySet.commitLayer(e.id,this._syncChangeSet),this._layerSyncSet.delete(e.id),this._syncChangeSet.empty||(this.renderer.commit(this._syncChangeSet,nr.G5),this.renderView.requestRender())}schedule(e,t){return this._frameTask.schedule(e,t)}reschedule(e,t){return this._frameTask.reschedule(e,t)}syncLayer(e){this._layerSyncSet.add(e),this.renderView.requestRender()}get layers(){return this._layers}addRenderPlugin(e,t){const i=this.renderer.plugins.add(e,t),r=()=>{Wm(e)&&this.view.sceneIntersectionHelper.addIntersectionHandler(e)};if((0,f.y8)(i))return i.then(r);r()}removeRenderPlugin(e){this.destroyed||(Wm(e)&&this.view.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderer.plugins.remove(e))}get test(){}};(0,r._)([(0,w.Cb)({constructOnly:!0})],CP.prototype,"view",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],CP.prototype,"options",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],CP.prototype,"viewingMode",null),(0,r._)([(0,w.Cb)({constructOnly:!0})],CP.prototype,"container",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],CP.prototype,"updating",null),(0,r._)([(0,w.Cb)({constructOnly:!0})],CP.prototype,"_model",void 0),(0,r._)([(0,w.Cb)()],CP.prototype,"_renderView",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],CP.prototype,"renderer",null),(0,r._)([(0,w.Cb)()],CP.prototype,"textures",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],CP.prototype,"running",null),CP=(0,r._)([(0,x.j)("esri.views.3d.webgl-engine.Stage")],CP);var xP=i(45391),TP=i(63510);const SP=new Set,MP=()=>d.Z.getLogger("esri/views/support/TextureCompressionHelper");var EP=i(33776);i(55214);var PP=i(48207),RP=i(74765);const AP={left:0,top:0,bottom:0,right:0},OP={bottom:30,top:15,right:15,left:15},DP="esri-ui",IP={ui:DP,corner:`${DP}-corner`,innerContainer:`${DP}-inner-container`,manualContainer:`${DP}-manual-container`,cornerContainer:`${DP}-corner-container`,topLeft:`${DP}-top-left`,topRight:`${DP}-top-right`,bottomLeft:`${DP}-bottom-left`,bottomRight:`${DP}-bottom-right`};function LP(e){return 0===e?"0":`${e}px`}function NP(e){const t="object"==typeof e&&null!==e&&Object.getPrototypeOf(e);return null!==t&&t!==Object.prototype||!("component"in e||"index"in e||"position"in e)?null:e}function FP(e,{top:t,bottom:i,left:r,right:n}){e.style.top=t,e.style.bottom=i,e.style.left=r,e.style.right=n}let UP=class extends ae.Z.EventedAccessor{constructor(e){super(e),this._cornerNameToContainerLookup={},this._positionNameToContainerLookup={},this._components=new Array,this._componentMap=new Map,this._removeWidgetHandleKey=Symbol("componentOnRemoveSymbol"),this._locale=(0,RP.Kd)(),this.view=null,this._applyViewPadding=()=>{const e=this.container;e&&FP(e,this._toPixelPosition(this._getViewPadding()))},this._applyUIPadding=()=>{const e=this._innerContainer;e&&FP(e,this._toPixelPosition(this.padding))},this._initContainers()}initialize(){this.addHandles([(0,_.YP)((()=>[this.view?.padding,this.container]),this._applyViewPadding,_.nn),(0,_.YP)((()=>this.padding),this._applyUIPadding,_.nn),(0,_.YP)((()=>[this.container,this._locale]),(([e,t])=>{e&&e.setAttribute("lang",t)}),_.nn),(0,RP.qe)((e=>{this._locale=e}))])}destroy(){this.container=null;for(const e of this._components)e.destroy();this._components.length=0,this._componentMap.clear()}set container(e){const t=this._get("container");e!==t&&(e&&(e.classList.add(IP.ui),(0,PP.LO)(e),this._attachContainers(e)),t&&(t.classList.remove(IP.ui),FP(t,{top:"",bottom:"",left:"",right:""}),t.textContent=""),this._set("container",e))}get height(){const e=this.view?.height??0;if(0===e)return e;const t=this._getViewPadding(),{top:i,bottom:r}=t;return Math.max(e-i-r,0)}get padding(){return this._get("padding")}set padding(e){this._overrideIfSome("padding",e)}castPadding(e){return"number"==typeof e?{bottom:e,top:e,right:e,left:e}:{...OP,...e}}get width(){const e=this.view?.width??0;if(0===e)return e;const t=this._getViewPadding(),{left:i,right:r}=t;return Math.max(e-i-r,0)}add(e,t){let i,r,n;if(Array.isArray(e))return void e.forEach((e=>this.add(e,t)));const s=NP(e);s&&({index:i,position:t,component:e,key:r}=s),t&&"object"==typeof t&&({index:i,key:r,position:t,internal:n}=t),!e||t&&!this._isValidPosition(t)||this._add(e,t,i??this._getNumComponentsAtPosition(t),r,n)}remove(e,t){if(!e)return;if(Array.isArray(e))return e.map((e=>this.remove(e,t)));const i=this._find(e);if(i){const e=this._componentMap.get(i);if(!e||e.key!==t)return;const r=this._components.indexOf(i);return i.node.parentNode?.removeChild(i.node),this._componentMap.delete(i),i.widget?.removeHandlesReference(this._removeWidgetHandleKey),this._components.forEach((t=>{const i=this._componentMap.get(t);i&&i.position===e.position&&i.index>e.index&&i.index--})),this._components.splice(r,1)[0]}}empty(e,t={removeInternal:!1}){if(Array.isArray(e)){for(const i of e)this.empty(i,t);return}const i=this._positionNameToContainerLookup[e??"manual"],r=Array.prototype.slice.call(i.children).map((e=>this._findByNode(e))).filter((e=>null!=e&&(!this._componentMap.get(e)?.internal||t.removeInternal)));for(const e of r)this.remove(e)}move(e,t){if(Array.isArray(e)&&e.forEach((e=>this.move(e,t))),!e)return;let i;const r=NP(e)||NP(t);if(r&&(i=r.index,t=r.position,e=r.component||e),t&&!this._isValidPosition(t))return;const n=this.remove(e);n&&this.add(n,{position:t,index:i})}find(e){if(!e)return null;const t=this._findById(e);return t&&(t.widget||t.node)}getComponents(e,t={includeInternal:!1}){return e?Array.isArray(e)?e.flatMap((e=>this._getComponentsAtPosition(e,t))):this._getComponentsAtPosition(e,t):this._components.filter((e=>t.includeInternal||!this._componentMap.get(e)?.internal)).map((({widget:e,node:t})=>e??t))}getPosition(e){for(const t in this._positionNameToContainerLookup)if(this._positionNameToContainerLookup[t].contains(e))return t;return null}_add(e,t,i,r,n){e instanceof mh||(e=new mh({node:e}));const{widget:s}=e;null!=s&&s instanceof S.Z&&s.addHandles((0,h.kB)((()=>{queueMicrotask((()=>this.remove(e)))})),this._removeWidgetHandleKey),this._components.some((e=>this._componentMap.get(e)?.position===t&&this._componentMap.get(e)?.index===i))&&this._components.forEach((e=>{const r=this._componentMap.get(e);r&&r.position===t&&r.index>=i&&r.index++})),this._place({component:e,position:t,index:i}),this._components.push(e),this._componentMap.set(e,{key:r,position:t,internal:n,index:i})}_find(e){return e?e instanceof mh?this._findByComponent(e):"string"==typeof e?this._findById(e):"domNode"in e?this._findByNode(e.domNode):this._findByNode(e):null}_getViewPadding(){return this.view?.padding??AP}_attachContainers(e){e.appendChild(this._innerContainer),e.appendChild(this._manualContainer)}_initContainers(){const e=document.createElement("div");e.classList.add(IP.innerContainer,IP.cornerContainer);const t=document.createElement("div");t.classList.add(IP.innerContainer,IP.manualContainer);const i=document.createElement("div");i.classList.add(IP.topLeft,IP.corner),e.appendChild(i);const r=document.createElement("div");r.classList.add(IP.topRight,IP.corner),e.appendChild(r);const n=document.createElement("div");n.classList.add(IP.bottomLeft,IP.corner),e.appendChild(n);const s=document.createElement("div");s.classList.add(IP.bottomRight,IP.corner),e.appendChild(s),this._innerContainer=e,this._manualContainer=t;const a=(0,gh.dZ)();this._cornerNameToContainerLookup={"top-left":i,"top-right":r,"bottom-left":n,"bottom-right":s,"top-leading":a?r:i,"top-trailing":a?i:r,"bottom-leading":a?s:n,"bottom-trailing":a?n:s},this._positionNameToContainerLookup={manual:t,...this._cornerNameToContainerLookup}}_isValidPosition(e){return!!this._positionNameToContainerLookup[e]}_place(e){const t=e.position??"manual",{component:i,index:r}=e,n=this._positionNameToContainerLookup[t],s=null!=r&&r>-1;if(function(e){return e&&!e._started&&"function"==typeof e.postMixInProperties&&"function"==typeof e.buildRendering&&"function"==typeof e.postCreate&&"function"==typeof e.startup}(i.widget)&&i.widget.startup(),!s)return void n.appendChild(i.node);const a=Array.from(n.children);if(0!==a.length){for(const e of a){const t=this._findByNode(e);if(t&&r<(this._componentMap.get(t)?.index??0))return void e.parentNode?.insertBefore(i.node,e)}n.appendChild(i.node)}else n.appendChild(i.node)}_toPixelPosition(e){return{top:LP(e.top),left:LP(e.left),right:LP(e.right),bottom:LP(e.bottom)}}_findByComponent(e){return this._components.find((t=>t===e))??null}_findById(e){return this._components.find((({id:t})=>t===e))??null}_findByNode(e){return e?this._components.find((({node:t})=>t===e)):null}_getComponentsAtPosition(e,t){const i=this._positionNameToContainerLookup[e];return Array.prototype.slice.call(i.children).map((e=>this._findByNode(e))).filter(Fe.pC).filter((e=>t.includeInternal||!this._componentMap.get(e)?.internal)).map((({widget:e,node:t})=>e??t))}_getNumComponentsAtPosition(e){return this._positionNameToContainerLookup[e]?.children.length??0}};(0,r._)([(0,w.Cb)()],UP.prototype,"_locale",void 0),(0,r._)([(0,w.Cb)()],UP.prototype,"container",null),(0,r._)([(0,w.Cb)()],UP.prototype,"height",null),(0,r._)([(0,w.Cb)({value:OP})],UP.prototype,"padding",null),(0,r._)([(0,C.p)("padding")],UP.prototype,"castPadding",null),(0,r._)([(0,w.Cb)()],UP.prototype,"view",void 0),(0,r._)([(0,w.Cb)()],UP.prototype,"width",null),UP=(0,r._)([(0,x.j)("esri.views.ui.UI")],UP);const HP=UP;var kP=i(23195);function VP(e,t){return e&&"copyright"in e&&(!t||"function"==typeof e.originOf&&"user"===e.originOf("copyright"))}function BP(e,t,i){i&&t&&(e.find((e=>e.layerView===t&&e.text===i))||e.push({text:i,layerView:t}))}const zP=[];let GP=class extends S.Z{constructor(e){super(e),this._clear=()=>{this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.removeHandles("suspension"),this.notifyChange("state")},this._pendingAttributions=new Set,this._fetchedAttributionData=new Map,this.items=new a.Z,this.view=null,this._allLayerViewsChange=e=>{this.removeHandles("suspension"),this.removeHandles("visible-geometry-changed");const t=this.view?.allLayerViews;t&&(this.addHandles(t.map((e=>(0,_.YP)((()=>[e.suspended,e.layer?.attributionVisible]),(()=>this._updateAttributionItems())))).toArray(),"suspension"),t.forEach((e=>{"esri.views.3d.layers.Tiles3DLayerView3D"===e.declaredClass&&this.addHandles(e.on("visible-geometry-changed",(()=>this._updateAttributionItems())),"visible-geometry-changed")}))),e?.removed&&e.removed.forEach((e=>{this._pendingAttributions.delete(e),this._fetchedAttributionData.delete(e)})),this._updateAttributionItems()},this.addHandles([(0,_.on)((()=>this.view?.allLayerViews),"change",(e=>this._allLayerViewsChange(e)),{onListenerAdd:()=>this._allLayerViewsChange(),onListenerRemove:this._clear}),(0,_.gx)((()=>!0===this.view?.stationary),(()=>this._updateAttributionItems()))])}destroy(){this.view=null,this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.items.removeAll()}get state(){return this.view?.ready?this._pendingAttributions.size>0?"loading":"ready":"disabled"}_updateAttributionItems(){const e=this.view,t=e?.allLayerViews;if(zP.length=0,!e||!t)return void this._clear();t.forEach((t=>{if(t.suspended||!t.layer?.attributionVisible)return;const i=t.layer;if(VP(i,"user"))return void BP(zP,t,i.copyright);if(i.hasAttributionData){if(this._fetchedAttributionData.has(t)){const r=this._fetchedAttributionData.get(t);return void(r?BP(zP,t,this._getDynamicAttribution(r,e,i)):VP(i)&&BP(zP,t,i.copyright))}return void this._fetchAttributionData(t)}const r="portalItem"in i?i.portalItem?.accessInformation:void 0;BP(zP,t,r||i.copyright)}));const i=t.find((e=>"integrated-mesh-3dtiles"===e.layer?.type));if(this.view&&i){const e=(0,kP.WM)(this.view);if(e){const t=e.getAttributionText();for(let e=0;e<t.length;++e)BP(zP,i,t[e])}}(function(e,t){return e.length!==t.length||e.some(((e,i)=>e.text!==t[i].text))})(this.items,zP)&&(this.items.removeAll(),this.items.addMany(zP)),zP.length=0,this.notifyChange("state")}async _fetchAttributionData(e){if(this._pendingAttributions.has(e))return;this._pendingAttributions.add(e);const t=await(0,me.q6)(e.layer.fetchAttributionData());if(this._pendingAttributions.has(e)){const i=t.ok?this._createContributionIndex(t.value,function(e){return"bing-maps"===e.type}(e.layer)):null;this._pendingAttributions.delete(e),this._fetchedAttributionData.set(e,i)}this._updateAttributionItems()}_createContributionIndex(e,t){const i=e.contributors,r={};if(!i)return r;for(let e=0;e<i.length;e++){const n=i[e],s=n.coverageAreas;if(!s)return;for(const i of s){const s=i.bbox,a=i.zoomMin-(t&&i.zoomMin?1:0),o=i.zoomMax-(t&&i.zoomMax?1:0),l=new O.Z({xmin:s[1],ymin:s[0],xmax:s[3],ymax:s[2],spatialReference:N.Z.WGS84}),c={extent:(0,tg.$)(l),attribution:n.attribution||"",score:null!=i.score?i.score:100,id:e};for(let e=a;e<=o;e++)r[e]??=[],r[e].push(c)}}return r.maxKey=Math.max.apply(null,Object.keys(r)),r}_getDynamicAttribution(e,t,i){const{extent:r,scale:n}=t;let s=i.tileInfo?.scaleToZoom(n)??0;if(s=Math.min(e.maxKey??0,Math.round(s)),!r||null==s||s<=-1)return"";const a=e[s],o=(0,tg.iV)(r.center.clone().normalize(),N.Z.WebMercator),l=new Set;return a?a.filter((e=>{const t=e.id,i=!l.has(t)&&o&&e.extent&&(0,oe.aV)(e.extent,o);return i&&l.add(t),i})).sort(((e,t)=>t.score-e.score||e.objectId-t.objectId)).map((e=>e.attribution)).join(", "):""}};(0,r._)([(0,w.Cb)({readOnly:!0,type:a.Z})],GP.prototype,"items",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],GP.prototype,"state",null),(0,r._)([(0,w.Cb)()],GP.prototype,"view",void 0),GP=(0,r._)([(0,x.j)("esri.widgets.Attribution.AttributionViewModel")],GP);const qP=GP;var ZP=i(46512),jP=i(80079);const WP="esri-attribution",$P={base:WP,poweredBy:`${WP}__powered-by`,sources:`${WP}__sources`,open:`${WP}--open`,sourcesOpen:`${WP}__sources--open`,link:`${WP}__link`};let XP=class extends _h.Z{constructor(e,t){super(e,t),this._isOpen=!1,this._attributionTextOverflowed=!1,this._prevSourceNodeHeight=0,this._resizeObserver=new ResizeObserver((e=>e.forEach((({target:e})=>this._checkSourceTextOverflow(e))))),this.itemDelimiter=" | ",this.messages=null,this.viewModel=new qP}initialize(){this.addHandles((0,_.on)((()=>this.viewModel?.items),"change",(()=>this.scheduleRender())))}destroy(){this._resizeObserver?.disconnect()}get _isInteractive(){return this._isOpen||this._attributionTextOverflowed}get attributionText(){return this.viewModel.items.reduce(((e,t)=>(e.includes(t.text)||e.push(t.text),e)),[]).join(this.itemDelimiter)}get icon(){return"description"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}render(){const e={[$P.open]:this._isOpen};return(0,vh.u)("div",{bind:this,class:this.classes($P.base,ZP.z.widget,e),dir:"ltr",onclick:this._toggleState,onkeydown:this._toggleState},this._renderSourcesNode(),this._renderPoweredBy())}_renderPoweredBy(){return(0,vh.u)("div",{class:$P.poweredBy},"Powered by"," ",(0,vh.u)("a",{class:$P.link,href:"https://www.esri.com/",rel:"noreferrer",target:"_blank"},"Esri"))}_renderSourcesNode(){const e=this._isOpen,t=this._isInteractive,i=t?0:void 0,{attributionText:r}=this,n={[$P.sourcesOpen]:e,[ZP.z.interactive]:t};return(0,vh.u)("div",{afterCreate:this._afterSourcesNodeCreate,bind:this,class:this.classes($P.sources,n),innerHTML:r,tabIndex:i})}_afterSourcesNodeCreate(e){this._prevSourceNodeHeight=e.clientWidth,this._resizeObserver.observe(e)}_checkSourceTextOverflow(e){let t=!1;const{clientHeight:i,clientWidth:r,scrollWidth:n}=e,s=n>r,a=this._attributionTextOverflowed!==s;if(this._attributionTextOverflowed=s,a&&(t=!0),this._isOpen){const e=i<this._prevSourceNodeHeight;this._prevSourceNodeHeight=i,e&&(this._isOpen=!1,t=!0)}t&&this.scheduleRender()}_toggleState(){this._isInteractive&&(this._isOpen=!this._isOpen)}};(0,r._)([(0,w.Cb)()],XP.prototype,"_isOpen",void 0),(0,r._)([(0,w.Cb)()],XP.prototype,"_isInteractive",null),(0,r._)([(0,w.Cb)()],XP.prototype,"_attributionTextOverflowed",void 0),(0,r._)([(0,w.Cb)()],XP.prototype,"_prevSourceNodeHeight",void 0),(0,r._)([(0,w.Cb)({readOnly:!0,dependsOn:["viewModel.items.length","itemDelimiter"]})],XP.prototype,"attributionText",null),(0,r._)([(0,w.Cb)()],XP.prototype,"icon",null),(0,r._)([(0,w.Cb)()],XP.prototype,"itemDelimiter",void 0),(0,r._)([(0,w.Cb)()],XP.prototype,"label",null),(0,r._)([(0,w.Cb)(),(0,yh.H)("esri/widgets/Attribution/t9n/Attribution")],XP.prototype,"messages",void 0),(0,r._)([(0,w.Cb)()],XP.prototype,"view",null),(0,r._)([(0,w.Cb)({type:qP})],XP.prototype,"viewModel",void 0),(0,r._)([(0,jP.h)()],XP.prototype,"_toggleState",null),XP=(0,r._)([(0,x.j)("esri.widgets.Attribution")],XP);const YP=XP;function KP(){const e=(0,u.Z)("mapview-essential-goto-duration");return null==e?e:(0,ur.HA)(e)}var QP=i(63712);let JP=class extends((0,QP.Z)(S.Z)){constructor(e){super(e),this.orientation={x:0,y:0,z:0},this.view=null,this._updateForCamera=this._updateForCamera.bind(this),this._updateForRotation=this._updateForRotation.bind(this),this._updateRotationWatcher=this._updateRotationWatcher.bind(this)}initialize(){this._watchForView(_.nn)}destroy(){this.view=null}get canShowNorth(){return function(e){return e?.spatialReference?.isWebMercator||e?.spatialReference?.isGeographic||!1}(this.view)}get state(){return!this.view?.ready||"2d"===this.view.type&&!this.view.constraints.rotationEnabled?"disabled":this.canShowNorth?"compass":"rotation"}reset(){this.view?.ready&&("2d"===this.view?.type?this.callGoTo({target:{rotation:0},options:{animationMode:"always",duration:KP()}}):this.callGoTo({target:{heading:0}}))}_updateForRotation(e){null!=e&&this._set("orientation",{z:e})}_updateForCamera(e){if(!e)return;const t=-e.heading;this._set("orientation",{x:0,y:0,z:t})}_updateRotationWatcher(e){this.removeAllHandles(),this._watchForView(),e&&this.addHandles("2d"===e.type?(0,_.YP)((()=>e?.rotation),this._updateForRotation,_.nn):(0,_.YP)((()=>e?.camera),this._updateForCamera,_.nn))}_watchForView(e){this.addHandles((0,_.YP)((()=>this.view),this._updateRotationWatcher,e))}};(0,r._)([(0,w.Cb)({readOnly:!0})],JP.prototype,"canShowNorth",null),(0,r._)([(0,w.Cb)({readOnly:!0})],JP.prototype,"orientation",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],JP.prototype,"state",null),(0,r._)([(0,w.Cb)()],JP.prototype,"view",void 0),JP=(0,r._)([(0,x.j)("esri.widgets.Compass.CompassViewModel")],JP);const eR=JP,tR="esri-compass",iR={base:tR,iconContainer:`${tR}__icon-container`};var rR=i(84644);let nR=class extends _h.Z{constructor(e,t){super(e,t),this.messages=null,this.viewModel=new eR,this._reset=()=>{this.viewModel.reset()},this._toRotationTransform=e=>({transform:`rotateZ(${e.z}deg)`})}loadDependencies(){return(0,rR.h)({button:()=>Promise.resolve().then(i.bind(i,61637)),icon:()=>Promise.resolve().then(i.bind(i,4204))})}get goToOverride(){return this.viewModel.goToOverride}set goToOverride(e){this.viewModel.goToOverride=e}get icon(){return"rotation"===this.viewModel.state?"arrow-up":"compass-needle"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}reset(){return this.viewModel.reset()}render(){const{orientation:e,state:t}=this.viewModel,{messages:i}=this;return(0,vh.u)("div",{class:this.classes(iR.base,ZP.z.widget)},(0,vh.u)("calcite-button",{class:ZP.z.widgetButton,disabled:"disabled"===t,kind:"neutral",label:i.reset,onclick:this._reset,round:!0,scale:"s",title:i.reset},(0,vh.u)("div",{"aria-hidden":"true",class:iR.iconContainer,title:i.reset},(0,vh.u)("calcite-icon",{icon:this.icon,styles:this._toRotationTransform(e)}))))}};(0,r._)([(0,w.Cb)()],nR.prototype,"goToOverride",null),(0,r._)([(0,w.Cb)()],nR.prototype,"icon",null),(0,r._)([(0,w.Cb)()],nR.prototype,"label",null),(0,r._)([(0,w.Cb)(),(0,yh.H)("esri/widgets/Compass/t9n/Compass")],nR.prototype,"messages",void 0),(0,r._)([(0,w.Cb)()],nR.prototype,"view",null),(0,r._)([(0,w.Cb)({type:eR})],nR.prototype,"viewModel",void 0),nR=(0,r._)([(0,x.j)("esri.widgets.Compass")],nR);const sR=nR,aR="esri-navigation-toggle",oR=aR,lR=`${aR}--horizontal`;let cR=class extends S.Z{constructor(e){super(e),this._navigationMode="pan",this.view=null,e?.isDefaultViewModel||(0,Rt._O)(d.Z.getLogger(this),"Navigation Toggle","arcgis-navigation-toggle",{version:"4.33"})}normalizeCtorArgs(e={}){const{isDefaultViewModel:t,...i}=e;return i}initialize(){this.addHandles((0,_.gx)((()=>this.view?.navigation?.actionMap),(()=>this._updateNavigationActionMap())))}destroy(){this.view=null}get state(){return this.view?.ready&&"3d"===this.view?.type?"ready":"disabled"}get navigationMode(){return this._navigationMode}set navigationMode(e){this._navigationMode=e,this._updateNavigationActionMap()}toggle(){"disabled"!==this.state&&(this.navigationMode="pan"!==this.navigationMode?"pan":"rotate")}_updateNavigationActionMap(){const e=this.view?.navigation?.actionMap;if(!e)return;const t="pan"===this._navigationMode;e.dragPrimary=t?"pan":"rotate",e.dragSecondary=t?"rotate":"pan"}};(0,r._)([(0,w.Cb)({readOnly:!0})],cR.prototype,"state",null),(0,r._)([(0,w.Cb)()],cR.prototype,"_navigationMode",void 0),(0,r._)([(0,w.Cb)()],cR.prototype,"view",void 0),cR=(0,r._)([(0,x.j)("esri.widgets.NavigationToggle.NavigationToggleViewModel")],cR);const hR=cR;let uR=class extends _h.Z{constructor(e,t){super(e,t),this.messages=null,this.viewModel=new hR({isDefaultViewModel:!0}),this.toggle=()=>this.viewModel.toggle(),this._panButton=null,this._rotateButton=null,this._toggle=()=>{const e="pan"===this.viewModel?.navigationMode?this._rotateButton:this._panButton;(0,gh.kW)(e),this.toggle()},e?.isDefaultUI||(0,Rt.Pq)(d.Z.getLogger(this),"Navigation Toggle","arcgis-navigation-toggle",{version:"4.32"})}normalizeCtorArgs(e={}){const{isDefaultUI:t,...i}=e;return i}loadDependencies(){return(0,rR.h)({button:()=>Promise.resolve().then(i.bind(i,61637))})}get icon(){return"move"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}set layout(e){"horizontal"!==e&&(e="vertical"),this._set("layout",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}render(){const e="disabled"===this.viewModel?.state,t="pan"===this.viewModel?.navigationMode,i=this.messages.toggle;return(0,vh.u)("div",{class:this.classes(oR,ZP.z.widget,{[lR]:"horizontal"===this.layout})},(0,vh.u)("calcite-button",{afterCreate:e=>{this._panButton=e},appearance:t?"outline-fill":"solid",class:ZP.z.widgetButton,disabled:e,iconStart:"move",kind:"neutral",label:i,onclick:this._toggle,tabIndex:t?void 0:-1,title:i}),(0,vh.u)("calcite-button",{afterCreate:e=>{this._rotateButton=e},appearance:t?"solid":"outline-fill",class:ZP.z.widgetButton,disabled:e,iconStart:"rotate",kind:"neutral",label:i,onclick:this._toggle,tabIndex:t?-1:void 0,title:i}))}};(0,r._)([(0,w.Cb)()],uR.prototype,"icon",null),(0,r._)([(0,w.Cb)()],uR.prototype,"label",null),(0,r._)([(0,w.Cb)({value:"vertical"})],uR.prototype,"layout",null),(0,r._)([(0,w.Cb)(),(0,yh.H)("esri/widgets/NavigationToggle/t9n/NavigationToggle")],uR.prototype,"messages",void 0),(0,r._)([(0,w.Cb)()],uR.prototype,"view",null),(0,r._)([(0,w.Cb)({type:hR})],uR.prototype,"viewModel",void 0),uR=(0,r._)([(0,x.j)("esri.widgets.NavigationToggle")],uR);const dR=uR;var pR=i(93427);const mR="esri-zoom",fR="esri-zoom--horizontal";let _R=class extends _h.Z{constructor(e,t){super(e,t),this.messages=null,this.viewModel=new pR.Z,this.zoomIn=()=>this.viewModel.zoomIn(),this.zoomOut=()=>this.viewModel.zoomOut()}loadDependencies(){return(0,rR.h)({button:()=>Promise.resolve().then(i.bind(i,61637))})}get icon(){return"magnifying-glass-plus"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}set layout(e){"horizontal"!==e&&(e="vertical"),this._set("layout",e)}set view(e){this.viewModel.view=e}get view(){return this.viewModel.view}render(){const e={[fR]:"horizontal"===this.layout},{canZoomIn:t,canZoomOut:i}=this.viewModel,{zoomIn:r,zoomOut:n}=this.messages;return(0,vh.u)("div",{class:this.classes(mR,ZP.z.widget,e)},(0,vh.u)("calcite-button",{class:ZP.z.widgetButton,disabled:!t,iconStart:"plus",kind:"neutral",label:r,onclick:this.zoomIn,title:r}),(0,vh.u)("calcite-button",{class:ZP.z.widgetButton,disabled:!i,iconStart:"minus",kind:"neutral",label:n,onclick:this.zoomOut,title:n}))}};(0,r._)([(0,w.Cb)()],_R.prototype,"icon",null),(0,r._)([(0,w.Cb)()],_R.prototype,"label",null),(0,r._)([(0,w.Cb)({value:"vertical"})],_R.prototype,"layout",null),(0,r._)([(0,w.Cb)(),(0,yh.H)("esri/widgets/Zoom/t9n/Zoom")],_R.prototype,"messages",void 0),(0,r._)([(0,w.Cb)()],_R.prototype,"view",null),(0,r._)([(0,w.Cb)({type:pR.Z})],_R.prototype,"viewModel",void 0),_R=(0,r._)([(0,x.j)("esri.widgets.Zoom")],_R);const gR=_R;let yR=class extends HP{constructor(e){super(e),this._defaultPositionLookup={attribution:"manual",compass:"top-left","navigation-toggle":"top-left",zoom:"top-left"},this.components=[],this._updateViewAwareWidgets=e=>{this.components.forEach((t=>{const i=this._find(t)?.widget;(function(e){return void 0!==e?.view})(i)&&(i.view=e)}))},this._componentsWatcher=(e,t)=>{this._removeComponents(t),this._addComponents(e),this._adjustPadding(e)}}initialize(){this.addHandles([(0,_.YP)((()=>this.components),this._componentsWatcher,_.nn),(0,_.YP)((()=>this.view),this._updateViewAwareWidgets,_.nn)])}_add(e,t,i,r,n){let s=e;if("string"==typeof e&&this._defaultPositionLookup[e]){if(this._find(e))return;s=this._createComponent(e)}super._add(s,t,i,r,n)}_removeComponents(e){e.forEach((e=>{const t=this._find(e);t&&(this.remove(t),t.destroy())}))}_adjustPadding(e){if(!e.includes("attribution")&&!this._isOverridden("padding")){const{top:e}=this.padding;this.padding=e}}_addComponents(e){this.constructed&&e.forEach((e=>this.add(this._createComponent(e),this._defaultPositionLookup[e])))}_createComponent(e){const t=this._createWidget(e);return new mh({id:e,node:t})}_createWidget(e){const t=this.view;switch(e){case"attribution":return new YP({view:t});case"compass":return new sR({view:t});case"navigation-toggle":return new dR({view:t,isDefaultUI:!0});case"zoom":return new gR({view:t})}}};(0,r._)([(0,w.Cb)()],yR.prototype,"components",void 0),yR=(0,r._)([(0,x.j)("esri.views.ui.DefaultUI")],yR);const vR=yR;let bR=class extends vR{constructor(e){super(e),this.components=["attribution","zoom","navigation-toggle","compass"]}};(0,r._)([(0,w.Cb)()],bR.prototype,"components",void 0),bR=(0,r._)([(0,x.j)("esri.views.ui.3d.DefaultUI3D")],bR);const wR=bR;let CR=class extends($(ye(ne(ti)))){constructor(e){super(e),this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._overrideDefaultEnvironmentOnly=!0,this._resolveWhenReady=[],this._resourceController=function(e){return new Hf({view:e})}(this),this.deconflictor=new rp({view:this}),this.labeler=new sp.S({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.analyses=new z,this.basemapTerrain=null,this.elevationProvider=null,this.canvas=null,this.constraints=new Ei,this.environment=new Xn,this.environmentManager=new wn,this.floors=new a.Z,this.fullOpacity=1,this.graphicsView=null,this.analysisViewManager=new fi({view:this}),this.groundView=null,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new Am({view:this}),this.slice=new t_,this.spatialReference=null,this.alphaCompositingEnabled=!1,this.preserveDrawingBufferEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new wR,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this._importControllers=new Map,(0,b.j2)();const t=(e=null)=>{null!=e&&e.type===m.y.MOVE||(this._updatingChanged(),this.map?.allLayers.forEach((async e=>{try{await e.when()}catch{}this._updatingChanged()})))};this.addHandles([(0,_.on)((()=>this.map?.allLayers),"after-changes",(e=>t(e)),{onListenerAdd:()=>t(),onListenerRemove:()=>t(),sync:!0}),this.allLayerViews.on("after-changes",(e=>this._updateUpdatingMonitors(e))),(0,_.YP)((()=>this.scene),(e=>e?.load().catch((()=>{}))))]),this.inputManager=new ad({view:this}),this.stateManager=new Xc({view:this})}initialize(){if((0,u.Z)("enable-feature:esri-compress-textures")&&(0,u.Z)("wasm-simd")){const e=function(e,t){return Ed.x.compressionWorkerHandle??=new Cb((0,TP.H)(t)),SP.has(e)?MP().warn("Repeated texture compression worker initialization by the same view."):SP.add(e),Ed.x.compressionWorkerHandle}(this,this.resourceController);this.addResolvingPromise(e.promise)}this.groundView=new pe({view:this}),this._updateUpdatingMonitors(),this.updatingHandles.add((()=>this.qualitySettings.memoryLimit),(e=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=e)}),_.nn),this.updatingHandles.add((()=>this.qualitySettings.additionalCacheMemory),(e=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=e)}),_.nn),this.updatingHandles.add((()=>this.qualitySettings.frameRate??0),(e=>(0,g.bP)(e>0?1e3/Math.ceil(e):0)),_.nn),this.addHandles([(0,_.YP)((()=>this.spatialReference),(()=>this.notifyChange("clippingArea")),_.Z_),(0,_.YP)((()=>({plane:this.slice.plane,isDecoration:this.slice.isDecoration})),(()=>this._updateSlice()),_.Z_)])}destroy(){this.destroyed||(function(e){Ed.x.compressionWorkerHandle&&(SP.delete(e)||MP().warn("Unknown view attempted to destroy the texture compression worker."),SP.size||((0,p.SC)(Ed.x.compressionWorkerHandle),Ed.x.compressionWorkerHandle=null))}(this),this.updatingHandles.removeAll(),this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._set("analysisViewManager",(0,p.SC)(this.analysisViewManager)),this._exitSurface(),this._disposeGraphicsView(),this._disposeFocusAreasView(),this.sharedSymbolResources=(0,p.SC)(this.sharedSymbolResources),this._set("labeler",(0,p.SC)(this.labeler)),this._set("deconflictor",(0,p.SC)(this.deconflictor)),this._resourceController=(0,p.SC)(this._resourceController),this._set("stateManager",(0,p.SC)(this.stateManager)),this._set("inputManager",(0,p.SC)(this.inputManager)),this.state.destroy(),this.highlights.destroy(),this.removeHandles("updatingMonitors"),this._set("environmentManager",(0,p.SC)(this.environmentManager)),this._set("environment",(0,p.SC)(this.environment)),this.groundView=(0,p.SC)(this.groundView),this._exitBasemapTerrain(),this.stage?.destroy(),this.slice.destroy())}get stage(){return this._stage}get renderSpatialReference(){return this.renderCoordsHelper?.spatialReference}get basemapSpatialReference(){return this.basemapTerrain?.spatialReference}get animation(){return this.state?.animation}get camera(){return this.stateManager?.camera}set camera(e){this.stateManager&&(this.stateManager.camera=e)}get contentCamera(){return this.stateManager?.contentCamera}set contentCamera(e){this.stateManager&&(this.stateManager.contentCamera=e)}installContentCameraReset(e={sticky:!1}){return this.stateManager.installContentCameraReset(e)}get center(){return this.stateManager?.center}set center(e){this.stateManager&&(this.stateManager.center=e)}get clippingArea(){if("global"===this.viewingMode)return null;const e=this.map;let t=this._userClippingArea||(0,p.aF)(e,"clippingArea");return!this._userClippingArea&&!(0,p.aF)(e,"clippingEnabled")||null==t?(this._clippingArea=null,null):t instanceof O.Z?this.spatialReference&&(t=xR(t,this.spatialReference),null==t)?(d.Z.getLogger(this).error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(t=t.clone(),null==t.intersection(this._groundAndLayersExtent)&&(t.xmin=t.xmax,t.ymin=t.ymax),t.zmin=void 0,t.zmax=void 0,t.equals(this._clippingArea)||(this._clippingArea=t),this._clippingArea):(d.Z.getLogger(this).error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(e){this.ready&&"global"===this.viewingMode&&null!=e?d.Z.getLogger(this).error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=e}get renderDataExtent(){if(this.state.viewingMode===Ht.JY.Global)return null;const e=this.renderSpatialReference,t=this.dataExtent;return null==t||null==e||t.spatialReference.equals(e)?t:xR(t,e)}get tileInfo(){return this.basemapTerrain?.tilingScheme?.toTileInfo()}get dataExtent(){let e=this._groundAndLayersExtent;const t=this.spatialReference||N.Z.WGS84,i=xR(this.clippingArea,t);null!=i&&(e=null!=e?e.intersection(i):i);const r=this._get("dataExtent");return null!=e&&e.equals(r)?r:e}get _groundAndLayersExtent(){const e=this.spatialReference||N.Z.WGS84;let t;const i=i=>{const r=xR(i,e);null!=r&&(null!=t?t.union(r):t=r.clone())},r=this.basemapTerrain;if(r?.spatialReference){const e=r.groundExtent;i(new O.Z({xmin:e[0],ymin:e[1],zmin:0,xmax:e[2],ymax:e[3],zmax:0,spatialReference:r.spatialReference}))}if(this.map?.allLayers.forEach((e=>(e=>{null==e.fullExtent||"graphics"===e.type&&e.internal||i(e.fullExtent)})(e))),null==t)return null;t.hasZ?(t.zmin=Math.min(0,t.zmin??0),t.zmax=Math.max(0,t.zmax??0)):(t.zmin=0,t.zmax=0);const n=this._get("_groundAndLayersExtent");return t.equals(n)?n:t}castEnvironment(e){return e?e instanceof Xn?e:e instanceof jn?this.environment?.cloneWithWebsceneEnvironment(e)??Xn.fromWebsceneEnvironment(e):(0,T.se)(Xn,e):new Xn}get extent(){return this.stateManager?.extent}set extent(e){this.stateManager&&(this.stateManager.extent=e)}get screenCenter(){return this.stateManager?.screenCenter}get frustum(){return this.stateManager?.frustum}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get defaultsFromMapSettings(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}get interacting(){return this.navigating||(this.toolViewManager?.interacting??!1)}get stationary(){return!this.animation&&!this.resizing&&(this.state?.stationary??!0)}get navigating(){return this.state?.navigating??!1}get scene(){return this.map&&G.x in this.map?this.map:null}get padding(){return this.stateManager?.padding}set padding(e){this.stateManager&&(this.stateManager.padding=e)}set qualityProfile(e){cf.isValidProfile(e)&&(cf.apply(e,this.qualitySettings),this.stage?.renderView.updateQualitySettings(this.qualitySettings),this._set("qualityProfile",e))}get qualityProfile(){return this._get("qualityProfile")||cf.getDefaultProfile()}_updateSlice(){null!=this.stage&&(this.stage.renderer.slice=this.slice)}get typeSpecificPreconditionsReady(){return!!this.viewingMode&&!!this.stateManager?.preinit(this.spatialReference)}get resolution(){return null!=this.spatialReference?(0,V.dp)(this.scale,this.spatialReference):0}get scale(){return this.stateManager?.scale}set scale(e){this.stateManager&&(this.stateManager.scale=e)}get heightModelInfo(){const e=this.getDefaultHeightModelInfo();return null!=e?D.Z.deriveUnitFromSR(e,this.spatialReference):null}get updating(){if(this.destroying||this.destroyed)return!1;let e=0,t=this.layerViewManager.updating,i=t?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach((r=>{if(r.isFulfilled()){if(r.updating){if(t=!0,r.suspended||(0,X_.wP)(r))return;++i,e+=r.updatingProgress}}else++i}));for(const t of this._updatingObjects)if(null!=t&&t.updating){const t=.1;i+=t,e+=.5*t}for(const t of this._updatingObjectsWithProgress)null!=t&&t.updating&&(++i,e+=t.updatingProgress);const r=!this.stateManager.test.updatingIgnoreRenderState&&this.state.updating;if(t=!!(t||i>0||this.updatingHandles.updating||!this.ready||!this.stationary||r||this._importControllers.size>0||this.inputManager?.updating||this.map?.allLayers?.some((e=>!e.isFulfilled()))),t?(this._numUpdating=Math.max(i,this._numUpdating),e+=this._numUpdating-i):this._numUpdating=0,this._numUpdating>0?e/=this._numUpdating:e=t?0:1,this._get("updatingProgress")!==e){const i=performance.now();if(e<1){const t=Math.min((i-this._lastUpdateTime)/2e3,1);e=this.updatingProgress*(1-t)+e*t}this._set("updatingProgress",e),this._lastUpdateTime=t&&e<1?i:0}return t}get _updatingObjects(){return[this.graphicsView,this.basemapView,this._resourceController,this.stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this._featureTreeDebugger,this.toolViewManager,this.analysisViewManager]}get _updatingObjectsWithProgress(){return[this.deconflictor,this.labeler,this.basemapTerrain]}get viewingMode(){const e=this._predeterminedViewingMode;if(null!=e)return(0,Ht.M7)(e);const t=this.spatialReference;return t?null!=this.defaultsFromMap?.viewingMode&&t.equals(this.defaultsFromMap.spatialReference)?(0,Ht.M7)(this.defaultsFromMap.viewingMode):(0,xP.D)(t,Ht.JY.Global)?"global":"local":"global"}set viewingMode(e){this.ready?d.Z.getLogger(this).error("#viewingMode","viewingMode cannot be set once view is ready"):this._overrideIfSome("viewingMode",e)}get viewpoint(){return this.stateManager?.viewpoint}set viewpoint(e){this.stateManager&&(this.stateManager.viewpoint=e)}get visibleArea(){return this.stateManager?.visibleArea}get zoom(){return this.stateManager.zoom}set zoom(e){this.stateManager&&(this.stateManager.zoom=e)}get highlightOptions(){return this.highlights.find((({name:e})=>e===gt.b))??new vt}set highlightOptions(e){for(let t=0;t<this.highlights.length;++t)if(this.highlights.at(t).name===gt.b)return void this.highlights.items[t].assignFrom(e)}get resourceController(){return this._resourceController}get quality(){return this._resourceController?.memoryController?.memoryFactor??1}get resolutionScale(){return Math.sqrt(Math.min(1,this.quality/.75))}get performanceInfo(){return new zf(this)}on(e,t,i,r){return this.viewEvents.on(e,t,i,r)||super.on(e,t)}hasEventListener(e){return super.hasEventListener(e)||this.viewEvents.hasHandler(e)}toMap(e,t){if(!this.ready)return d.Z.getLogger(this).error("#toMap()","Scene view cannot be used before it is ready"),null;const i=(0,at.Rw)(e)?(0,at.s6)(this,e):e;return(0,Lm.qL)(this,i,t,this._defaultToMapOptions)}toScreen(e){if(!this.ready)return d.Z.getLogger(this).error("#toScreen()","Scene view cannot be used before it is ready"),null;const t=(null==e.z?(0,gc.KO)(this.elevationProvider,e):null)??0;return(0,U.K)(e,TR,this.renderSpatialReference,t),this.state.camera.projectToScreen(TR,SR),(0,y.vW)(SR[0],SR[1])}pixelSizeAt(e,t){if(!this.ready)return d.Z.getLogger(this).error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null;if(!e)return 0;const i=this.renderSpatialReference;(0,U.K)(e,TR,i);const r=this.state.camera.computeScreenPixelSizeAt(TR);return t&&i!==t?r*(0,v.c9)(i)/(0,v.c9)(t):r}overlayPixelSizeInMapUnits(e){const t=this.basemapTerrain.overlayManager;return t?t.overlayPixelSizeInMapUnits(e,(()=>this.pixelSizeAt(e))):1}hitTest(e,t){if(!this.ready)return d.Z.getLogger(this).error("#hitTest()","Scene view cannot be used before it is ready"),null;const i=(0,at.Rw)(e)?(0,at.s6)(this,e):e;return(0,Lm.wX)(this,i,t,this._defaultHitTestOptions)}async popupHitTest(e){return pf(this,e)}goTo(e,t){return this.updatingHandles.addPromise(this.stateManager.goTo(e,t))}async whenAnalysisView(e){if(null==e.parent)throw new l.Z("view:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});switch(e.parent.type){case"line-of-sight":case"dimension":case"viewshed":return(await this.whenLayerView(e.parent)).whenAnalysisView();default:return this.analysisViewManager.whenAnalysisView(e)}}whenLayerView(e){return super.whenLayerView(e)}async takeScreenshot(e){const t=await this._completeSettings(e);await this.whenReady();const r=await this.stage.renderView.takeScreenshot(t);return(await Promise.resolve().then(i.bind(i,53433))).encode(r,t,this._pixelFormat())}async _takeScreenshot(e){const t=await this._completeSettings(e);await this.whenReady();const r=await this.stage.renderView.takeScreenshot(t);return(await Promise.resolve().then(i.bind(i,53433))).encodeData(r,this._pixelFormat())}async _takeScreenshotWithObjectAndLayerId(e){const t=await this._completeSettings(e);await this.whenReady();const r=await this.stage.renderView.takeScreenshotWithOID(t),{encodeData:n}=await Promise.resolve().then(i.bind(i,53433));return[n(r[0],this._pixelFormat()),n(r[1],this._pixelFormat())]}async _completeSettings(e){const{toRenderSettings:t,screenshotSuperSampleSettings:r}=await Promise.resolve().then(i.bind(i,53433)),n=t(e,this);return n.pixelRatio/=this.state.pixelRatio,r(n,this.supersampleScreenshotsEnabled,this.padding)}_pixelFormat(){return{flipY:!0,premultipliedAlpha:this.stage?.renderView.getAlpha()??!1}}get test(){}async takeScreenshotWithObjectAndLayerId(e){if(!(0,Fx.B)())throw new l.Z("360vr:objectAndLayerId-rendering-disabled","has enable-feature:objectAndLayerId-rendering must be true");const{encode:t}=await Promise.resolve().then(i.bind(i,53433)),r=await this._completeSettings(e);await this.whenReady();const n=await this.stage.renderView.takeScreenshotWithOID(r),s=t(n[0],r,this._pixelFormat()),a=await this._completeSettings(e);return a.format="png",[s,t(n[1],a,this._pixelFormat())]}getColorToObjectAndLayerIdMapping(){const e=this.stage.renderView.olidRenderHelper;if(e)return e.getColorToObjectAndLayerIdMapping();throw new l.Z("360vr:objectAndLayerId-rendering-disabled","has enable-feature:objectAndLayerId-rendering must be true")}addUpdatingPromise(e){return this.updatingHandles.addPromise(e)}importLayerView(e){return ci(e)}hasLayerViewModule(e){return li(e)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){return this.scene?.initialViewProperties?.spatialReference||this.defaultsFromMap?.spatialReference||this.defaultsFromMap?.ready&&this._initialDefaultSpatialReference||null}async validate(){let e=function(e){const t=(0,EP.h)();return t.available?"3d"===e&&t.majorPerformanceCaveat?new l.Z("webgl:major-performance-caveat-detected",`Your WebGL implementation (${t.unmaskedRenderer}) doesn't seem to support hardware accelerated rendering. Check your browser settings or if your GPU is in a blocklist.`):t.supportsHighPrecisionFragment?t.supportsVertexShaderSamplers?null:new l.Z("webgl:vertex-shader-samplers-required","WebGL support for vertex shader samplers is required but not supported."):new l.Z("webgl:high-precision-fragment-required","WebGL support for high precision fragment shaders is required but not supported."):new l.Z("webgl:required","WebGL2 is required but not supported.",(new Error).stack)}(this.type);const t=(0,u.Z)("safari");if(t&&t<9&&(e=new l.Z("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:t})),null!=e)throw d.Z.getLogger(this).warn("#validate()",e.message),e}get _predeterminedViewingMode(){const e=this._isOverridden("viewingMode")?this._get("viewingMode"):this.scene?.initialViewProperties?.viewingMode;return null!=e?(0,Ht.wg)(e):null}getSpatialReferenceSupport(e,t){const i=this._predeterminedViewingMode;if(null!=i)return this._validateSpatialReferenceForViewingMode(e,t,i)?{constraints:this._makeSpatialReferenceConstraints(e,t,i)}:null;const r=this._validateSpatialReferenceForViewingMode(e,t,Ht.JY.Local),n=this._validateSpatialReferenceForViewingMode(e,t,Ht.JY.Global);return r||n?r&&n?{constraints:this._makeSpatialReferenceConstraints(e,t,null)}:r?{constraints:this._makeSpatialReferenceConstraints(e,t,Ht.JY.Local)}:{constraints:this._makeSpatialReferenceConstraints(e,t,Ht.JY.Global)}:null}_validateSpatialReferenceForViewingMode(e,t,i){return!(!(0,xP.D)(e,i)||null!=t&&!(0,B.Am)(t)&&((0,B.iC)(t)&&null==(0,X_.E_)(t,e,i)||(0,B.Tv)(t)&&i===Ht.JY.Global))}_makeSpatialReferenceConstraints(e,t,i){if(null==t)return[{spatialReference:e,viewingMode:i}];const{isWebMercator:r,isWGS84:n}=e;return(0,B.Am)(t)&&(r||n)?n&&i!==Ht.JY.Local&&null!==(0,X_.er)(t.tileInfo,t.fullExtent,e,Ht.JY.Global)?[{spatialReference:r?N.Z.WGS84:N.Z.WebMercator,viewingMode:i}]:[{spatialReference:e,viewingMode:i},{spatialReference:N.Z.WebMercator,viewingMode:i}]:(0,B.iC)(t)||(0,B.Tv)(t)||!r&&!n?(0,B.iC)(t)&&r&&i!==Ht.JY.Global?[{spatialReference:e,viewingMode:i},{spatialReference:N.Z.WGS84,viewingMode:Ht.JY.Local}]:[{spatialReference:e,viewingMode:i}]:[{spatialReference:e,viewingMode:i},{spatialReference:r?N.Z.WGS84:N.Z.WebMercator,viewingMode:i}]}_validateSpatialReference(e){const t=null!=this.getSpatialReferenceSupport(e),i=this._predeterminedViewingMode;return t||(null!=i?d.Z.getLogger(this).warnOnce(`Spatial reference defined on view not supported in ${(0,Ht.M7)(i)} viewing mode.`):e.isGeographic&&d.Z.getLogger(this).warnOnce("Spatial reference is geographic but not supported.")),t}whenReady(){return new Promise((e=>{this.ready?e(this):this._resolveWhenReady.push(e)}))}trackGraphicState(e){if(!e.graphic)return d.Z.getLogger(this).error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const t=this.getViewForGraphic(e.graphic);let i=null,r=!1;const n=t=>{!r&&null!=t&&"processor"in t&&"graphics-3d"===t.processor?.type&&t.processor.graphicsCore&&(i=t.processor.graphicsCore.trackGraphicState(e))};return null!=t?n(t):this.whenViewForGraphic(e.graphic,{waitForLayer:!0}).then((e=>n(e)),(()=>{})).catch((()=>{})),(0,h.kB)((()=>{r=!0,null!=i&&(i.remove(),i=null)}))}maskOccludee(e){if(!e)return d.Z.getLogger(this).error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const t=this.getViewForGraphic(e);let i=null,r=!1;const n=t=>{!r&&null!=t&&(0,mw._1)(t)&&(i=t.maskOccludee(e))};return null!=t?n(t):this.whenViewForGraphic(e,{waitForLayer:!0}).then((e=>n(e)),(()=>{})).catch((()=>{})),(0,h.kB)((()=>{r=!0,null!=i&&(i.remove(),i=null)}))}getViewForGraphic(e){return e.layer===this?this.graphicsView:e.layer?this.allLayerViews.filter((e=>"media-3d"!==e.type)).find((t=>t.layer===e.layer)):null}graphicChanged(e){null!=this.graphicsView&&this.graphicsView.graphicChanged(e)}async whenViewForGraphic(e,t){return e.layer===this?(await(0,_.N1)((()=>this.graphicsView)),this.graphicsView):e.layer&&this.map?t&&t.waitForLayer&&!this.map.allLayers.includes(e.layer)?new Promise(((t,i)=>{const r=this.map.allLayers.on("change",(n=>{n.added.includes(e.layer)&&(r.remove(),this.whenLayerView(e.layer).then(t,i))}))})):this.whenLayerView(e.layer):null}async _importModule(e,t){const i=new AbortController;this._importControllers.set(e,i),this._updatingChanged();try{const r=await ER[e]();return t&&((0,f.k_)(i.signal),await t(i.signal)),(0,f.k_)(i.signal),this._importControllers.delete(e),r}catch{this._importControllers.delete(e)}return null}_abortImport(e){this._importControllers.get(e)?.abort(),this._importControllers.delete(e),this._updatingChanged()}_initBasemapTerrain(){this._set("basemapTerrain",new gw({view:this})),this._set("elevationProvider",new Jm({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){const e=this.basemapTerrain,t=this.elevationProvider;e&&(this._set("basemapTerrain",null),this._set("elevationProvider",null),t.unregister(e),t.destroy(),e.destroy())}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new D_({view:this})),this._set("featureTiles",new Sm({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.cameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));const e=()=>{const e=this.basemapTerrain?.extent;if(this.clippingArea||e)if(e&&this.basemapTerrain.spatialReference){const e=null!=this.basemapTerrain.extent&&null!=this.basemapTerrain.spatialReference?(0,L.project)((0,H.HH)(this.basemapTerrain.extent,this.basemapTerrain.spatialReference),this.spatialReference):null;this.clippingArea?this.featureTiles.filterExtent=this.clippingArea.intersection(e):this.featureTiles.filterExtent=e}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null};this.addHandles([this.updatingHandles.add((()=>hd.h.FEATURE_TILE_TREE_SHOW_TILES),(e=>{e&&this.featureTiles&&!this._featureTreeDebugger?this.updatingHandles.addPromise(i.e(59519).then(i.bind(i,59519))).then((({FeatureTileTree3DDebugger:e})=>{!this._featureTreeDebugger&&hd.h.FEATURE_TILE_TREE_SHOW_TILES&&(this._featureTreeDebugger=new e({view:this}))})):e||!this._featureTreeDebugger||hd.h.FEATURE_TILE_TREE_SHOW_TILES||(this._featureTreeDebugger.destroy(),this._featureTreeDebugger=null)}),_.tX),this.updatingHandles.add((()=>this.clippingArea),e,_.tX),this.updatingHandles.add((()=>this.basemapTerrain.extent),e,_.tX)],"feature-tiles"),this.stateManager.init()}_exitGlobe(){this.featureTiles&&(this.stateManager.exit(),this.removeHandles("render-coords-helper"),this.removeHandles("feature-tiles"),this._set("featureTiles",(0,p.SC)(this.featureTiles)),this._set("pointsOfInterest",(0,p.SC)(this.pointsOfInterest)),this._exitBasemapTerrain(),this.state.reset(),this._exitCoordinateSystem())}_initCoordinateSystem(){if(this.spatialReference){const e=this.spatialReference,t=this.state.isGlobal,i=(0,k.E2)(t,e);i!==this.renderSpatialReference&&(this._set("renderCoordsHelper",Cf.Z.create(this.state.viewingMode,i)),t||this.addHandles((0,_.YP)((()=>this.basemapTerrain?.extent),(e=>{const t=this.renderCoordsHelper.spatialReference;null==e||0===e[0]&&0===e[1]&&0===e[2]&&0===e[3]||!(0,F.d)(e,this.basemapTerrain.spatialReference,MR,t)||(this.renderCoordsHelper.extent=MR)}),_.Z_),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(mo.j/this.renderCoordsHelper.unitInMeters))}else this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.removeHandles("render-coords-helper"),this._set("renderCoordsHelper",null)}_updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(e=null){null!=e&&e.type===m.y.MOVE||(this.removeHandles("updatingMonitors"),this.allLayerViews.forEach((e=>{e.destroyed||(this.addHandles((0,_.YP)((()=>[e.updating,e.updatingProgress]),(()=>this._updatingChanged()),_.Z_),"updatingMonitors"),e.when((()=>this._updatingChanged()),(()=>this._updatingChanged())))})),this._updatingChanged())}async _prepareScreenshotOverlay(){this.overlay&&await this.overlay.prepare()}_renderScreenshotOverlay(e,t,i){if(!this.overlay||!this.overlay.hasVisibleItems)return i;const r=e.getContext("2d",{willReadFrequently:!0});return r.putImageData(i,0,0),this.overlay.renderCanvas(e,{disableDecorations:t}),r.getImageData(0,0,i.width,i.height)}_initStage(){const e={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,preserveDrawingBuffer:this.preserveDrawingBufferEnabled,canvas:this.renderCanvas,screenshot:{prepareOverlay:()=>this._prepareScreenshotOverlay(),renderOverlay:(e,t,i)=>this._renderScreenshotOverlay(e,t,i)}},t=new Vm(this.state.viewingMode,(e=>this.stage.layers.forAll(e)),this);this._set("sceneIntersectionHelper",t);const i=(0,o.L)(this.surface);this._stage=new CP({view:this,options:e,container:i}),this._updateSlice(),this.addHandles([this.updatingHandles.add((()=>this.qualitySettings.highQualityTransparency),(e=>this.stage.renderer.setParameters({highQualityTransparency:e})),_.nn),this.on("pointer-move",(()=>this.stage?.renderer.resetAnimation())),(0,c.on)(this.stage.renderView.canvas,"webglcontextlost",(e=>{this.fatalError=new l.Z("webgl-context-lost",e.statusMessage)}))],"stage"),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(mo.j/this.renderCoordsHelper.unitInMeters),this._set("canvas",this.stage.renderView.canvas)}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage=(0,p.SC)(this.stage),this.removeHandles("stage"),this._set("canvas",null)}_initSurface(e){this._exitSurface(),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new Jf({view:this,viewingMode:e,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}async _ensureGraphicsView(){if(this.graphicsView||this._importControllers.has("GraphicsView3D")||0===this.graphics.length)return;this.removeHandles("GraphicsView3D");const e=(await this._importModule("GraphicsView3D",(e=>(0,_.N1)((()=>this.basemapTerrain?.ready),e))))?.default;e&&this._set("graphicsView",new e({view:this,getGraphics:()=>this.graphics})),this._updatingChanged()}_disposeGraphicsView(){this._abortImport("GraphicsView3D"),this.removeHandles("GraphicsView3D"),this.graphicsView&&(this.removeHandles(this.graphicsView.processor.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_disposeFocusAreasView(){this._abortImport("FocusAreasView"),this.removeHandles("FocusAreasView"),this.focusAreasView=(0,p.SC)(this.focusAreasView)}async _ensureFocusAreasView(e){if(this.focusAreasView||this._importControllers.has("FocusAreasView")||0===e)return;this.removeHandles("FocusAreasView");const t=(await this._importModule("FocusAreasView"))?.FocusAreasView;t&&(this.focusAreasView=new t({view:this})),this._updatingChanged()}_startup(){const e=(0,Ht.wg)(this.viewingMode);e===Ht.JY.Global&&(this._clippingArea=null),this._initSurface(e),this._set("ready",!0),this.addHandles((0,_.on)((()=>this.graphics),"after-changes",(()=>this._ensureGraphicsView())),"GraphicsView3D"),this._ensureGraphicsView(),this.addHandles((0,_.YP)((()=>this.map?.focusAreas?.areas.length??0),(e=>this._ensureFocusAreasView(e)),{initial:!0}),"FocusAreasView");const t=this.scene?.initialViewProperties??null,i=t?.environment;i&&(this._overrideDefaultEnvironmentOnly?P(this.environment,i):this.environment=this.environment.cloneWithWebsceneEnvironment(i)),this.timeExtent=t?.timeExtent,t?.analyses.applyTo(this),this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect();const r=this._resolveWhenReady;this._resolveWhenReady=[],r.forEach((e=>e(this)))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this._overrideDefaultEnvironmentOnly=!1,this.labeler.dispose(),this._disposeGraphicsView(),this._disposeFocusAreasView(),this._exitSurface(),this._set("ready",!1)}get _defaultToMapOptions(){const e={include:new Set};if(!this.map)return e;this.map.ground&&e.include.add(Lo.xX);for(const t of this.allLayerViews)(0,B.nx)(t.layer.type)&&e.include.add(t.uid);return e}get _defaultHitTestOptions(){const e={exclude:new Set};if(!this.map)return e;this.map.ground&&this.map.ground.opacity<1&&e.exclude.add(Lo.xX);for(const t of this.allLayerViews)(0,B.nx)(t.layer.type)&&t.layer.opacity<1&&e.exclude.add(t.uid);return e}static{this.type="3d"}};function xR(e,t){return null!=e&&(0,L.canProjectWithoutEngine)(e.spatialReference,t)?(0,L.project)(e,t):null}(0,r._)([(0,w.Cb)()],CR.prototype,"_userClippingArea",void 0),(0,r._)([(0,w.Cb)()],CR.prototype,"_resourceController",void 0),(0,r._)([(0,w.Cb)()],CR.prototype,"_stage",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],CR.prototype,"deconflictor",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],CR.prototype,"labeler",void 0),(0,r._)([(0,w.Cb)((0,A.z)(z,"analyses"))],CR.prototype,"analyses",void 0),(0,r._)([(0,w.Cb)({type:ni,readOnly:!0})],CR.prototype,"animation",null),(0,r._)([(0,w.Cb)({readOnly:!0})],CR.prototype,"basemapTerrain",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],CR.prototype,"elevationProvider",void 0),(0,r._)([(0,w.Cb)()],CR.prototype,"camera",null),(0,r._)([(0,w.Cb)({type:n.Z})],CR.prototype,"contentCamera",null),(0,r._)([(0,w.Cb)({readOnly:!0})],CR.prototype,"canvas",void 0),(0,r._)([(0,w.Cb)({type:I.Z})],CR.prototype,"center",null),(0,r._)([(0,w.Cb)({type:O.Z})],CR.prototype,"clippingArea",null),(0,r._)([(0,w.Cb)({type:Ei})],CR.prototype,"constraints",void 0),(0,r._)([(0,w.Cb)({type:O.Z,readOnly:!0})],CR.prototype,"renderDataExtent",null),(0,r._)([(0,w.Cb)({readOnly:!0})],CR.prototype,"tileInfo",null),(0,r._)([(0,w.Cb)({type:O.Z,readOnly:!0})],CR.prototype,"dataExtent",null),(0,r._)([(0,w.Cb)({type:O.Z,readOnly:!0})],CR.prototype,"_groundAndLayersExtent",null),(0,r._)([(0,w.Cb)({type:Xn})],CR.prototype,"environment",void 0),(0,r._)([(0,C.p)("environment")],CR.prototype,"castEnvironment",null),(0,r._)([(0,w.Cb)({readOnly:!0})],CR.prototype,"environmentManager",void 0),(0,r._)([(0,w.Cb)({type:O.Z})],CR.prototype,"extent",null),(0,r._)([(0,w.Cb)({type:a.Z})],CR.prototype,"floors",void 0),(0,r._)([(0,w.Cb)()],CR.prototype,"screenCenter",null),(0,r._)([(0,w.Cb)()],CR.prototype,"frustum",null),(0,r._)([(0,w.Cb)({type:Number,readOnly:!0})],CR.prototype,"fullOpacity",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],CR.prototype,"graphicsView",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],CR.prototype,"analysisViewManager",void 0),(0,r._)([(0,w.Cb)()],CR.prototype,"groundView",void 0),(0,r._)([(0,w.Cb)({type:Boolean})],CR.prototype,"initialExtentRequired",null),(0,r._)([(0,w.Cb)()],CR.prototype,"defaultsFromMapSettings",null),(0,r._)([(0,w.Cb)()],CR.prototype,"interacting",null),(0,r._)([(0,w.Cb)()],CR.prototype,"stationary",null),(0,r._)([(0,w.Cb)()],CR.prototype,"navigating",null),(0,r._)([(0,w.Cb)()],CR.prototype,"map",void 0),(0,r._)([(0,w.Cb)()],CR.prototype,"padding",null),(0,r._)([(0,w.Cb)({type:D_,readOnly:!0})],CR.prototype,"pointsOfInterest",void 0),(0,r._)([(0,w.Cb)({type:Sm,readOnly:!0})],CR.prototype,"featureTiles",void 0),(0,r._)([(0,w.Cb)()],CR.prototype,"_featureTreeDebugger",void 0),(0,r._)([(0,w.Cb)({type:Boolean})],CR.prototype,"screenSizePerspectiveEnabled",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],CR.prototype,"deactivatedWebGLExtensions",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],CR.prototype,"debugWebGLExtensions",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],CR.prototype,"renderCanvas",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],CR.prototype,"state",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],CR.prototype,"inputManager",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],CR.prototype,"stateManager",void 0),(0,r._)([(0,w.Cb)({type:["low","medium","high"]})],CR.prototype,"qualityProfile",null),(0,r._)([(0,w.Cb)({type:wf,get(){let e=this._get("qualitySettings");return e||(e=new wf,cf.apply(this.qualityProfile,e)),e}})],CR.prototype,"qualitySettings",void 0),(0,r._)([(0,w.Cb)()],CR.prototype,"slice",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],CR.prototype,"typeSpecificPreconditionsReady",null),(0,r._)([(0,w.Cb)({readOnly:!0})],CR.prototype,"renderCoordsHelper",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],CR.prototype,"sceneIntersectionHelper",void 0),(0,r._)([(0,w.Cb)({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],CR.prototype,"resolution",null),(0,r._)([(0,w.Cb)({type:Number})],CR.prototype,"scale",null),(0,r._)([(0,w.Cb)()],CR.prototype,"heightModelInfo",null),(0,r._)([(0,w.Cb)()],CR.prototype,"spatialReference",void 0),(0,r._)([(0,w.Cb)({type:Boolean,constructOnly:!0})],CR.prototype,"alphaCompositingEnabled",void 0),(0,r._)([(0,w.Cb)({constructOnly:!0})],CR.prototype,"preserveDrawingBufferEnabled",void 0),(0,r._)([(0,w.Cb)({type:Boolean})],CR.prototype,"supersampleScreenshotsEnabled",void 0),(0,r._)([(0,w.Cb)({readOnly:!0})],CR.prototype,"type",void 0),(0,r._)([(0,w.Cb)(),(0,C.p)((e=>e instanceof vR?e:(0,T.TJ)(wR,e)))],CR.prototype,"ui",void 0),(0,r._)([(0,w.Cb)({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.updating","toolViewManager.updating","analysisViewManager.updating","state.updating","textures.updating"]})],CR.prototype,"updating",null),(0,r._)([(0,w.Cb)()],CR.prototype,"_updatingObjects",null),(0,r._)([(0,w.Cb)()],CR.prototype,"_updatingObjectsWithProgress",null),(0,r._)([(0,w.Cb)({type:Number,readOnly:!0,dependsOn:["updating"]})],CR.prototype,"updatingProgress",void 0),(0,r._)([(0,w.Cb)({type:["global","local"]})],CR.prototype,"viewingMode",null),(0,r._)([(0,w.Cb)({type:s.Z})],CR.prototype,"viewpoint",null),(0,r._)([(0,w.Cb)({readOnly:!0})],CR.prototype,"visibleArea",null),(0,r._)([(0,w.Cb)({type:Number})],CR.prototype,"zoom",null),(0,r._)([(0,w.Cb)({type:vt})],CR.prototype,"highlightOptions",null),(0,r._)([(0,w.Cb)({readOnly:!0})],CR.prototype,"quality",null),(0,r._)([(0,w.Cb)({readOnly:!0})],CR.prototype,"resolutionScale",null),(0,r._)([(0,w.Cb)()],CR.prototype,"focusAreasView",void 0),(0,r._)([(0,w.Cb)()],CR.prototype,"_defaultToMapOptions",null),(0,r._)([(0,w.Cb)()],CR.prototype,"_defaultHitTestOptions",null),CR=(0,r._)([(0,x.j)("esri.views.SceneView")],CR);const TR=(0,R.Ue)(),SR=(0,y.s1)(),MR=(0,H.Ue)(),ER={GraphicsView3D:()=>Promise.all([i.e(55105),i.e(88534),i.e(15034)]).then(i.bind(i,17617)),FocusAreasView:()=>Promise.all([i.e(9519),i.e(66288),i.e(65513),i.e(56870),i.e(92273),i.e(10511),i.e(79693)]).then(i.bind(i,27447))},PR=CR},50670:function(e,t,i){var r;i.d(t,{t:function(){return r}}),function(e){e[e.Left=0]="Left",e[e.Middle=1]="Middle",e[e.Right=2]="Right"}(r||(r={}))},42527:function(e,t,i){i.d(t,{a:function(){return n}});i(61432),i(96711);class r{constructor(e,t=[]){this.eventType=e,this.keyModifiers=t}matches(e){if(e.type!==this.eventType)return!1;if(0===this.keyModifiers.length)return!0;const t=e.modifiers;for(const e of this.keyModifiers)if(!t.has(e))return!1;return!0}}class n{constructor(e){this._manager=null,this._incoming={},this._outgoing={},this._incomingEventMatches=null,this._incomingEventTypes=null,this._outgoingEventTypes=null,this._hasSideEffects=e}get incomingEventMatches(){if(!this._incomingEventMatches){this._incomingEventMatches=[];for(const e in this._incoming){const t=this._incoming[e];for(const e of t)this._incomingEventMatches.push(e.match)}}return this._incomingEventMatches}get incomingEventTypes(){return this._incomingEventTypes||(this._incomingEventTypes=this.incomingEventMatches.map((e=>e.eventType))),this._incomingEventTypes}get outgoingEventTypes(){return this._outgoingEventTypes||(this._outgoingEventTypes=Object.keys(this._outgoing)),this._outgoingEventTypes}get hasSideEffects(){return this._hasSideEffects}get hasPendingInputs(){return!1}onInstall(e){this._manager||(e.setEventCallback((e=>this._handleEvent(e))),e.setUninstallCallback((()=>this._onUninstall())),this._manager=e)}onUninstall(){}registerIncoming(e,t,i){let n;"function"==typeof t?(i=t,n=[]):n=t||[];const a="string"==typeof e?new r(e,n):e,o=()=>{this._incomingEventTypes=null,this._incomingEventMatches=null},l=e=>{const t=this._incoming[e.match.eventType];if(t){const i=t.indexOf(e);t.splice(i,1),o(),this._manager&&this._manager.updateDependencies()}},c=new s(a,i,{onPause:l,onRemove:l,onResume:e=>{const t=this._incoming[e.match.eventType];t&&!t.includes(e)&&(t.push(e),o(),this._manager&&this._manager.updateDependencies())}});let h=this._incoming[a.eventType];return h||(h=[],this._incoming[a.eventType]=h),h.push(c),o(),this._manager&&this._manager.updateDependencies(),c}registerOutgoing(e){if(this._outgoing[e])throw new Error("There is already a callback registered for this outgoing InputEvent: "+e);const t=new a(e,{onEmit:(e,t,i,r)=>{this._manager?.emit(e.eventType,t,i,r)},onRemove:e=>{delete this._outgoing[e.eventType],this._manager?.updateDependencies()}});return this._outgoing[e]=t,this._outgoingEventTypes=null,this._manager&&this._manager.updateDependencies(),t}startCapturingPointer(e){this._manager?.setPointerCapture(e,!0)}stopCapturingPointer(e){this._manager?.setPointerCapture(e,!1)}refreshHasPendingInputs(){this._manager?.refreshHasPendingInputs()}_onUninstall(){this._manager&&(this.onUninstall(),this._manager=null)}_handleEvent(e){const t=this._incoming[e.type];if(t)for(const i of t)if(i.match.matches(e)&&(i.callback?.(e),e.shouldStopPropagation()))break}}class s{constructor(e,t,i){this.match=e,this._callback=t,this._handler=i}pause(){this._handler.onPause(this)}resume(){this._handler.onResume(this)}remove(){this._handler.onRemove(this)}get callback(){return this._callback}}class a{constructor(e,t){this.eventType=e,this._removed=!1,this._handler=t}emit(e,t,i){this._removed||this._handler.onEmit(this,e,t,i)}remove(){this._removed=!0,this._handler.onRemove(this)}}},96620:function(e,t,i){i.d(t,{$:function(){return f},f:function(){return y}});var r=i(73440),n=i(70880),s=(i(61432),i(96711)),a=i(92462),o=i(17155),l=(i(83850),i(48023)),c=i(42458),h=i(42527);class u extends h.a{constructor(e){super(!0),this._onChange=e,this._value="mouse",this._x=null,this._y=null,this.registerIncoming("pointer-move",(e=>this._update(e.data)))}_update(e){const t="touch"===e.native.pointerType?"touch":"mouse",{x:i,y:r}=e;t===this._value&&this._x===i&&this._y===r||(this._value=t,this._x=i,this._y=r,this._onChange(t,i,r))}}var d=i(39355);class p extends h.a{get multiTouchActive(){return this._multiTouchActive.value}constructor(){super(!0),this._activeTouchPointerIds=new Set,this._multiTouchActive=(0,d.t)(!1),this._onPointerAdd=({data:e})=>{"touch"===e.pointerType&&(this._activeTouchPointerIds.add(e.native.pointerId),this._update())},this._onPointerRemove=({data:e})=>{"touch"===e.pointerType&&(this._activeTouchPointerIds.delete(e.native.pointerId),this._update())},this.registerIncoming("pointer-down",this._onPointerAdd),this.registerIncoming("pointer-up",this._onPointerRemove),this.registerIncoming("pointer-capture-lost",this._onPointerRemove),this.registerIncoming("pointer-cancel",this._onPointerRemove)}_update(){this._multiTouchActive.value=this._activeTouchPointerIds.size>1}}var m=i(96571);let f=class extends n.Z{constructor(e){super(e),this._pointerCaptures=new Map,this._nameToGroup={},this._handlers=[],this._handlersPriority=[],this._currentPropagation=null,this._updateDependenciesAfterPropagation=!1,this._sourceEvents=new Set,this._keyModifiers=new Set,this._activeKeyModifiers=new Set,this._stoppedPropagationEventIds=new Set,this.primaryKey=c.C,this._latestPointerType="mouse",this._propertiesPool=new m.L({latestPointerLocation:v},this),this.latestPointerLocation=null,this._paused=!1,this.test={timestamp:void 0,hasCurrentPropagation:()=>!!this._currentPropagation}}initialize(){this.eventSource.onEventReceived=this._onEventReceived.bind(this),this._installRecognizers()}destroy(){const e=Object.keys(this._nameToGroup);for(const t of e)this.uninstallHandlers(t);this.eventSource.destroy(),this._currentPropagation=null,this._propertiesPool.destroy()}get hasPendingInputs(){return this._handlers.some((e=>e.handler.hasPendingInputs))}get latestPointerType(){return this._latestPointerType}get multiTouchActive(){return this._multiTouchHandler.multiTouchActive}get updating(){return this.hasPendingInputs||this._paused}installHandlers(e,t,i=y.INTERNAL){if(this._nameToGroup[e])return;if(0===t.length)return;const r={name:e,handlers:t.map((e=>({handler:e,active:!0,removed:!1,priorityIndex:0,groupPriority:i,eventCallback:null,uninstallCallback:null})))};this._nameToGroup[e]=r;for(let e=r.handlers.length-1;e>=0;e--){const t=r.handlers[e];this._handlers.push(t),t.handler.onInstall({updateDependencies:()=>{this.updateDependencies()},emit:(e,i,r,n,s)=>{this._emitInputEvent(t.priorityIndex+1,e,i,r,s,n)},setPointerCapture:(e,i)=>{this._setPointerCapture(r,t,e,i)},setEventCallback:e=>{t.eventCallback=e},setUninstallCallback:e=>{t.uninstallCallback=e},refreshHasPendingInputs:()=>{this.notifyChange("hasPendingInputs")}})}this.updateDependencies()}uninstallHandlers(e){const t=this._nameToGroup[e];t?(t.handlers.forEach((e=>{e.removed=!0,e.uninstallCallback?.()})),delete this._nameToGroup[e],this._currentPropagation?this._currentPropagation.needsHandlerGarbageCollect=!0:this._garbageCollectRemovedHandlers()):s.Z.getLogger(this).error("There is no InputHandler group registered under the name `"+e+"`")}hasHandlers(e){return void 0!==this._nameToGroup[e]}isModifierKeyDown(e){return this._activeKeyModifiers.has(e)}updateDependencies(){if(this._currentPropagation)return void(this._updateDependenciesAfterPropagation=!0);this._updateDependenciesAfterPropagation=!1;const e=new Set,t=new Set;this._handlersPriority=[];for(let e=this._handlers.length-1;e>=0;e--){const t=this._handlers[e];t.priorityIndex=e,this._handlersPriority.push(t)}this._handlersPriority=this._sortHandlersPriority(this._handlersPriority);for(let i=this._handlersPriority.length-1;i>=0;i--){const r=this._handlersPriority[i];r.priorityIndex=i;let n=r.handler.hasSideEffects;if(!n)for(const t of r.handler.outgoingEventTypes)if(e.has(t)){n=!0;break}if(n)for(const i of r.handler.incomingEventMatches){e.add(i.eventType);for(const e of i.keyModifiers)(0,c.w)(e)||t.add(e)}r.active=n}this._sourceEvents=e,this._keyModifiers=t,this._pointerCaptures.size>0&&this._sourceEvents.add("pointer-capture-lost"),this._keyModifiers.size>0&&(this._sourceEvents.add("key-down"),this._sourceEvents.add("key-up")),this.eventSource&&(this.eventSource.activeEvents=this._sourceEvents)}_setLatestPointer(e,t,i){this._latestPointerType=e;const r=this._get("latestPointerLocation");if(null==r||r.x!==t||r.y!==i){const e=this._propertiesPool.get("latestPointerLocation");e.x=t,e.y=i,this._set("latestPointerLocation",e)}}_onEventReceived(e,t){if("pointer-capture-lost"===e){const e=t;this._pointerCaptures.delete(e.native.pointerId)}this._updateKeyModifiers(e,t);const i=null!=this.test.timestamp?this.test.timestamp:t.native?t.native.timestamp:void 0,r=t.native?t.native.cancelable:void 0;this._emitInputEventFromSource(e,t,i,r)}_updateKeyModifiers(e,t){if(!t)return;let i=!1;const r=()=>{i||(this._activeKeyModifiers=new Set(this._activeKeyModifiers),i=!0)},n=(e,t)=>{t&&!this._activeKeyModifiers.has(e)?(r(),this._activeKeyModifiers.add(e)):!t&&this._activeKeyModifiers.has(e)&&(r(),this._activeKeyModifiers.delete(e))};if("key-down"===e||"key-up"===e){const i=t.key;this._keyModifiers.has(i)&&n(i,"key-down"===e)}const s=t.native;n("Alt",!!s?.altKey),n("Control",!!s?.ctrlKey),n("Ctrl",!!s?.ctrlKey),n("Shift",!!s?.shiftKey),n("Meta",!!s?.metaKey),n("Primary",this._activeKeyModifiers.has(this.primaryKey))}_installRecognizers(){this._latestPointerHandler=new u(((e,t,i)=>this._setLatestPointer(e,t,i))),this._multiTouchHandler=new p,this.installHandlers("input-manager-logic",[this._latestPointerHandler,this._multiTouchHandler],y.ALWAYS),this.recognizers.length>0&&this.installHandlers("default",this.recognizers,y.INTERNAL)}_setPointerCapture(e,t,i,r){const n=e.name+"-"+t.priorityIndex,s=this._pointerCaptures.get(i.pointerId)||new Set;this._pointerCaptures.set(i.pointerId,s),r?(s.add(n),1===s.size&&this.eventSource&&this.eventSource.setPointerCapture(i,!0)):s.has(n)&&(s.delete(n),0===s.size&&(this._pointerCaptures.delete(i.pointerId),this.eventSource&&this.eventSource.setPointerCapture(i,!1)))}_garbageCollectRemovedHandlers(){this._handlers=this._handlers.filter((e=>!e.removed)),this.updateDependencies()}_emitInputEventFromSource(e,t,i,r){this._emitInputEvent(0,e,t,i,r)}_emitInputEvent(e,t,i,r,n,s){const a=void 0!==r?r:this._currentPropagation?this._currentPropagation.timestamp:performance.now(),o=void 0!==n&&n,l={event:new _(t,i,a,s||this._activeKeyModifiers,o),priorityIndex:e};this._currentPropagation?this._currentPropagation.events.push(l):this._doNewPropagation(l)}_doNewPropagation(e){this._currentPropagation={events:new a.Z,currentHandler:null,needsHandlerGarbageCollect:!1,timestamp:e.event.timestamp},this._currentPropagation.events.push(e),this._continuePropagation()}_continuePropagation(){this._paused=!1;const e=this._currentPropagation;if(e){for(;e.events.length>0;){const{event:t,priorityIndex:i}=e.events.pop(),r=t.data?.eventId;if(null==r||!this._stoppedPropagationEventIds.has(r))for(e.currentHandler=this._handlersPriority[i];e.currentHandler;){if(e.currentHandler.removed)e.needsHandlerGarbageCollect=!0;else{if(e.currentHandler.active&&!t.shouldStopPropagation()&&e.currentHandler.eventCallback?.(t),t.shouldStopPropagation()){null!=r&&this._stoppedPropagationEventIds.add(r);break}if(t.shouldPausePropagation((()=>this._continuePropagation())))return void this._pausePropagation({event:t,priorityIndex:e.currentHandler.priorityIndex+1})}e.currentHandler=this._handlersPriority[e.currentHandler.priorityIndex+1]}}e.needsHandlerGarbageCollect&&this._garbageCollectRemovedHandlers(),this.hasPendingInputs||this._stoppedPropagationEventIds.clear(),this._currentPropagation=null,this._updateDependenciesAfterPropagation&&this.updateDependencies()}}_pausePropagation(e){const t=new a.Z;t.push(e);const i=this._currentPropagation;if(i){for(;i.events.length;)t.push(i.events.pop());i.events=t,i.currentHandler=null,this._paused=!0}}_compareHandlerPriority(e,t){if(e.handler.hasSideEffects!==t.handler.hasSideEffects)return e.handler.hasSideEffects?1:-1;if(e.groupPriority!==t.groupPriority)return e.groupPriority>t.groupPriority?-1:1;for(const i of e.handler.incomingEventMatches)for(const e of t.handler.incomingEventMatches){if(i.eventType!==e.eventType)continue;const t=i.keyModifiers.filter((t=>e.keyModifiers.includes(t)));if(t.length===i.keyModifiers.length!=(t.length===e.keyModifiers.length))return i.keyModifiers.length>e.keyModifiers.length?-1:1}return e.priorityIndex>t.priorityIndex?-1:1}_sortHandlersPriority(e){const t=[];for(const i of e){let e=0;for(;e<t.length&&this._compareHandlerPriority(i,t[e])>=0;)e++;t.splice(e,0,i)}return t}get debug(){const e=e=>{const t=this._setPointerCapture;this._setPointerCapture=()=>{},e(),this._setPointerCapture=t};return{injectEvent:(t,i)=>{e((()=>this._onEventReceived(t,i)))},disablePointerCapture:e}}};(0,r._)([(0,o.Cb)({readOnly:!0})],f.prototype,"hasPendingInputs",null),(0,r._)([(0,o.Cb)({constructOnly:!0})],f.prototype,"eventSource",void 0),(0,r._)([(0,o.Cb)({constructOnly:!0})],f.prototype,"recognizers",void 0),(0,r._)([(0,o.Cb)()],f.prototype,"_latestPointerType",void 0),(0,r._)([(0,o.Cb)()],f.prototype,"latestPointerType",null),(0,r._)([(0,o.Cb)()],f.prototype,"multiTouchActive",null),(0,r._)([(0,o.Cb)({readOnly:!0})],f.prototype,"latestPointerLocation",void 0),(0,r._)([(0,o.Cb)()],f.prototype,"_paused",void 0),(0,r._)([(0,o.Cb)({readOnly:!0})],f.prototype,"updating",null),f=(0,r._)([(0,l.j)("esri.views.input.InputManager")],f);class _{constructor(e,t,i,r,n){this.type=e,this.data=t,this.timestamp=i,this.modifiers=r,this.cancelable=n,this._propagationState=g.NONE,this._resumeCallback=null}stopPropagation(){this._propagationState|=g.STOPPED}shouldStopPropagation(){return 0!=(this._propagationState&g.STOPPED)}defer(e){this._propagationState|=g.PAUSED;const t=(e,t)=>{this._propagationState&=~g.PAUSED;const i=this._resumeCallback;if(this._resumeCallback=null,i&&i(),t)throw e;return e};return("function"==typeof e?e():e).then((e=>t(e,!1)),(e=>t(e,!0)))}shouldPausePropagation(e){return!!(this._propagationState&g.PAUSED)&&(this._resumeCallback=e,!0)}preventDefault(){this.data.native.preventDefault()}}var g;!function(e){e[e.NONE=0]="NONE",e[e.STOPPED=1]="STOPPED",e[e.PAUSED=2]="PAUSED"}(g||(g={}));const y={ALWAYS:1,DEFAULT:0,TOOL:-1,WIDGET:-2,INTERNAL:-3};const v=class{}},26124:function(e,t,i){i.d(t,{CE:function(){return u},uS:function(){return l}});i(61432);var r=i(50702),n=i(99574),s=i(96094),a=i(42527),o=i(96620);i(50670);const l=["click","double-click","immediate-click","immediate-double-click","hold","drag","key-down","key-up","pointer-down","pointer-move","pointer-up","pointer-drag","mouse-wheel","pointer-enter","pointer-leave","gamepad","focus","blur"],c={};function h(e){return!!c[e]}l.forEach((e=>{c[e]=!0}));class u{constructor(e){this._handlers=new Map,this._counter=0,this._handlerCounts=new Map,this.view=e,this.inputManager=null}connect(e){e&&this.disconnect(),this.inputManager=e,this._handlers.forEach((({handler:e,priority:t},i)=>this.inputManager?.installHandlers(i,[e],t)))}disconnect(){this.inputManager&&this._handlers.forEach(((e,t)=>this.inputManager?.uninstallHandlers(t))),this.inputManager=null}destroy(){this.disconnect(),this._handlers.clear(),this.view=null}on(e,t,i,n){const s=Array.isArray(e)?e:e.split(",");if(!function(e){for(const t of e)if(!h(t))return!1;return!0}(s))return s.some(h)&&console.error("Error: registering input events and other events on the view at the same time is not supported."),null;let a,l;Array.isArray(t)?l=t:(a=t,l=[]),"function"==typeof i?a=i:n=i,n=null!=n?n:o.f.DEFAULT;const c=this._createUniqueGroupName(),u=new d(this.view,s,l,a);this._handlers.set(c,{handler:u,priority:n});for(const e of s){const t=this._handlerCounts.get(e)||0;this._handlerCounts.set(e,t+1)}return this.inputManager&&this.inputManager.installHandlers(c,[u],n),(0,r.kB)((()=>this._removeHandler(c,s)))}hasHandler(e){return!!this._handlerCounts.get(e)}_removeHandler(e,t){if(this._handlers.has(e)){this._handlers.delete(e);for(const e of t){const t=this._handlerCounts.get(e);void 0===t||(1===t?this._handlerCounts.delete(e):this._handlerCounts.set(e,t-1))}}this.inputManager&&this.inputManager.uninstallHandlers(e)}_createUniqueGroupName(){return this._counter+=1,`viewEvents_${this._counter}`}}class d extends a.a{constructor(e,t,i,r){super(!0),this._latestDragStart=void 0,this.view=e;for(const n of t)switch(n){case"click":this.registerIncoming("click",i,(t=>r(f(e,t))));break;case"double-click":this.registerIncoming("double-click",i,(t=>r(_(e,t))));break;case"immediate-click":this.registerIncoming("immediate-click",i,(t=>r(g(e,t))));break;case"immediate-double-click":this.registerIncoming("immediate-double-click",i,(t=>r(y(e,t))));break;case"hold":this.registerIncoming("hold",i,(t=>r(v(e,t))));break;case"drag":this.registerIncoming("drag",i,(e=>{const t=this._wrapDrag(e);t&&r(t)}));break;case"key-down":this.registerIncoming("key-down",i,(e=>r(w(e))));break;case"key-up":this.registerIncoming("key-up",i,(e=>r(C(e))));break;case"pointer-down":this.registerIncoming("pointer-down",i,(e=>r(x(e,"pointer-down"))));break;case"pointer-move":this.registerIncoming("pointer-move",i,(e=>r(x(e,"pointer-move"))));break;case"pointer-up":this.registerIncoming("pointer-up",i,(e=>r(x(e,"pointer-up"))));break;case"pointer-drag":this.registerIncoming("pointer-drag",i,(e=>r(T(e))));break;case"mouse-wheel":this.registerIncoming("mouse-wheel",i,(e=>r(S(e))));break;case"pointer-enter":this.registerIncoming("pointer-enter",i,(e=>r(x(e,"pointer-enter"))));break;case"pointer-leave":this.registerIncoming("pointer-leave",i,(e=>r(x(e,"pointer-leave"))));break;case"gamepad":this.registerIncoming("gamepad",i,(e=>{r(M(e))}));break;case"focus":this.registerIncoming("focus",i,(e=>{r(p(e))}));break;case"blur":this.registerIncoming("blur",i,(e=>{r(m(e))}))}}_wrapDrag(e){const t=e.data,{x:i,y:r}=t.center,{action:s,pointerType:a,button:o}=t;if("start"===s&&(this._latestDragStart=t),!this._latestDragStart)return;const l=t.pointer.native,c=t.buttons,{cancelable:h,timestamp:u}=e,d={x:this._latestDragStart.center.x,y:this._latestDragStart.center.y};return"end"===s&&(this._latestDragStart=void 0),{type:"drag",action:s,x:i,y:r,origin:d,pointerType:a,button:o,buttons:c,radius:t.radius,angle:(0,n.BV)(t.angle),native:l,timestamp:u,cancelable:h,stopPropagation:()=>e.stopPropagation(),defer:t=>e.defer(t),preventDefault:()=>e.preventDefault()}}}function p(e){return{type:"focus",timestamp:e.timestamp,native:e.data.native,cancelable:e.cancelable,stopPropagation:()=>e.stopPropagation(),defer:t=>e.defer(t),preventDefault:()=>e.preventDefault()}}function m(e){return{type:"blur",timestamp:e.timestamp,native:e.data.native,cancelable:e.cancelable,stopPropagation:()=>e.stopPropagation(),defer:t=>e.defer(t),preventDefault:()=>e.preventDefault()}}function f(e,t){const{pointerType:i,button:r,buttons:n,x:a,y:o,native:l,eventId:c}=t.data,{cancelable:h,timestamp:u}=t;return{type:"click",pointerType:i,button:r,buttons:n,x:a,y:o,native:l,timestamp:u,screenPoint:(0,s.vW)(a,o),mapPoint:b(e,a,o),eventId:c,cancelable:h,stopPropagation:()=>t.stopPropagation(),defer:e=>t.defer(e),preventDefault:()=>t.preventDefault()}}function _(e,t){const{pointerType:i,button:r,buttons:n,x:s,y:a,native:o,eventId:l}=t.data,{cancelable:c,timestamp:h}=t;return{type:"double-click",pointerType:i,button:r,buttons:n,x:s,y:a,native:o,timestamp:h,mapPoint:b(e,s,a),eventId:l,cancelable:c,stopPropagation:()=>t.stopPropagation(),defer:e=>t.defer(e),preventDefault:()=>t.preventDefault()}}function g(e,t){const{pointerType:i,button:r,buttons:n,x:s,y:a,native:o,eventId:l}=t.data,c=o.pointerId,{cancelable:h,timestamp:u}=t;return{type:"immediate-click",pointerId:c,pointerType:i,button:r,buttons:n,x:s,y:a,native:o,timestamp:u,mapPoint:b(e,s,a),eventId:l,cancelable:h,stopPropagation:()=>t.stopPropagation(),defer:e=>t.defer(e),preventDefault:()=>t.preventDefault()}}function y(e,t){const{pointerType:i,button:r,buttons:n,x:s,y:a,native:o,eventId:l}=t.data,c=o.pointerId,{cancelable:h,timestamp:u}=t;return{type:"immediate-double-click",pointerId:c,pointerType:i,button:r,buttons:n,x:s,y:a,native:o,timestamp:u,mapPoint:b(e,s,a),eventId:l,cancelable:h,stopPropagation:()=>t.stopPropagation(),defer:e=>t.defer(e),preventDefault:()=>t.preventDefault()}}function v(e,t){const{pointerType:i,button:r,buttons:n,x:s,y:a,native:o}=t.data,{cancelable:l,timestamp:c}=t;return{type:"hold",pointerType:i,button:r,buttons:n,x:s,y:a,native:o,timestamp:c,mapPoint:b(e,s,a),cancelable:l,stopPropagation:()=>t.stopPropagation(),defer:e=>t.defer(e),preventDefault:()=>t.preventDefault()}}function b(e,t,i){return e.toMap((0,s.vW)(t,i),{exclude:[]})}function w(e){const{key:t,repeat:i,native:r}=e.data,{cancelable:n,timestamp:s}=e;return{type:"key-down",key:t,repeat:i,native:r,timestamp:s,cancelable:n,stopPropagation:()=>e.stopPropagation(),defer:t=>e.defer(t),preventDefault:()=>e.preventDefault()}}function C(e){const{key:t,native:i}=e.data,{cancelable:r,timestamp:n}=e;return{type:"key-up",key:t,native:i,timestamp:n,cancelable:r,stopPropagation:()=>e.stopPropagation(),defer:t=>e.defer(t),preventDefault:()=>e.preventDefault()}}function x(e,t){const{x:i,y:r,button:n,buttons:s,native:a,eventId:o}=e.data,l=a.pointerId,c=a.pointerType,{cancelable:h,timestamp:u}=e;return{type:t,x:i,y:r,pointerId:l,pointerType:c,button:n,buttons:s,native:a,timestamp:u,eventId:o,cancelable:h,stopPropagation:()=>e.stopPropagation(),defer:t=>e.defer(t),preventDefault:()=>e.preventDefault()}}function T(e){const{x:t,y:i,buttons:r,native:n,eventId:s}=e.data.currentEvent,{button:a}=e.data.startEvent,o=e.data.startEvent.native.pointerId,l=e.data.startEvent.native.pointerType,c=e.data.action,h={x:e.data.startEvent.x,y:e.data.startEvent.y},{cancelable:u,timestamp:d}=e;return{type:"pointer-drag",x:t,y:i,pointerId:o,pointerType:l,button:a,buttons:r,action:c,origin:h,native:n,timestamp:d,eventId:s,cancelable:u,stopPropagation:()=>e.stopPropagation(),defer:t=>e.defer(t),preventDefault:()=>e.preventDefault()}}function S(e){const{cancelable:t,data:i,timestamp:r}=e,{x:n,y:s,deltaY:a,native:o}=i;return{type:"mouse-wheel",x:n,y:s,deltaY:a,native:o,timestamp:r,cancelable:t,stopPropagation:()=>e.stopPropagation(),defer:t=>e.defer(t),preventDefault:()=>e.preventDefault()}}function M(e){const{action:t,state:i,device:r}=e.data,{cancelable:n,timestamp:s}=e,{buttons:a,axes:o}=i;return{type:"gamepad",device:r,timestamp:s,action:t,buttons:a,axes:o,cancelable:n,stopPropagation:()=>e.stopPropagation(),defer:t=>e.defer(t),preventDefault:()=>e.preventDefault()}}},42458:function(e,t,i){i.d(t,{C:function(){return r},w:function(){return s}});const r=(0,i(61432).Z)("mac")?"Meta":"Control",n=new Set(["Alt","Control","Meta","Shift","Ctrl","Primary"]),s=e=>n.has(e)},18753:function(e,t,i){i.d(t,{G7:function(){return m},Kj:function(){return h},Lk:function(){return d},NG:function(){return l},Sn:function(){return c},T6:function(){return u},a8:function(){return p}});var r=i(3480),n=i(50702),s=i(79577),a=i(96620),o=i(42458);const l={cancel:"Escape",complete:"Enter"},c={...l,redo:"r",undo:"z",center:"Alt",constraint:"Shift",delete:["Backspace","Delete"],vertexAdd:"f",pan:" "},h={toggle:"Control"},u={enterInputMode:"Tab",commit:"Enter",discard:"Escape",next:"Tab"},d={moveUp:{key:"ArrowUp",modifier:"Shift",repeats:!0},moveDown:{key:"ArrowDown",modifier:"Shift",repeats:!0},moveLeft:{key:"ArrowLeft",modifier:"Shift",repeats:!0},moveRight:{key:"ArrowRight",modifier:"Shift",repeats:!0},scaleUp:{key:"+",modifier:"Shift"},scaleDown:{key:"-",modifier:"Shift"},factorModifier:{key:o.C,continuePropagation:!0},toggleOpacity:"t",preserveAspectRatio:{key:"Shift",continuePropagation:!0},rotateIncrements:{key:"Shift",continuePropagation:!0},editSourcePoints:{key:"Alt",continuePropagation:!0},undo:"z",redo:"r"},p={invertType:["Control","Meta"]};class m{constructor(){this._bindings=new Map}add(e,t){return this.addToggle(e,(e=>{"key-down"===e.type&&t(e)}))}addToggle(e,t){const i=f.fromDefinition(e,t),a=(0,s.s1)(this._bindings,i.key,(()=>[]));return a.push(i),(0,n.kB)((()=>(0,r.Od)(a,i)))}register(e,t=a.f.WIDGET){return(0,n.AL)([e.on("key-down",(t=>this.dispatch(e.inputManager,t)),t),e.on("key-up",(t=>this.dispatch(e.inputManager,t)),t)])}dispatch(e,t){const i=t.key,r=this._bindings.get(i);if(r)for(const i of r)i.process(e,t)}}class f{constructor(e,t,i,r,n){this.key=e,this.modifiers=t,this.repeats=i,this.continuePropagation=r,this.callback=n}process(e,t){if(!(t.key!==this.key||"repeat"in t&&t.repeat&&!this.repeats)){for(const t of this.modifiers)if(!e.isModifierKeyDown(t))return;this.continuePropagation||t.stopPropagation(),this.callback(t)}}static fromDefinition(e,t){if("string"==typeof e)return new f(e,[],!1,!1,t);const{key:i,modifier:r,repeats:n,continuePropagation:s}=e;return new f(i,r?Array.isArray(r)?r:[r]:[],!!n,!!s,t)}}},43295:function(e,t,i){i.d(t,{Ac:function(){return a},CN:function(){return l},En:function(){return h},Ke:function(){return m},NU:function(){return o},SQ:function(){return n},b:function(){return u},hG:function(){return p},j2:function(){return s},oH:function(){return c},x:function(){return d}});var r=i(53147);const n=new r.Z("cyan"),s=1,a=.25,o=new r.Z("black"),l=.4,c=.2,h=.25,u="default",d="temporary",p=new r.Z("yellow"),m=8},96571:function(e,t,i){i.d(t,{L:function(){return s}});var r=i(74978),n=i(79860);class s{constructor(e,t){this._owner=t,this._properties={},this._afterDispatchHandle=null;for(const t in e){const i=e[t],n=new r.e(i,void 0,void 0,2,2);this._properties[t]={pool:n,acquired:[]}}this._afterDispatchHandle=(0,n.Fs)((()=>this._release()))}destroy(){this._afterDispatchHandle&&(this._afterDispatchHandle.remove(),this._afterDispatchHandle=null);for(const e in this._properties){const t=this._properties[e];for(const e of t.acquired)(0,n.NC)(e)||t.pool.release(e);t.pool.destroy(),t.pool=null,t.acquired=null}this._properties=null,this._owner=null}get(e){const t=this._owner._get(e),i=this._properties[e];let r=i.pool.acquire();for(i.acquired.push(r);r===t;)i.acquired.push(r),r=i.pool.acquire();return r}_release(){for(const e in this._properties){const t=this._properties[e];let i=0;for(const e of t.acquired)(0,n.NC)(e)?t.acquired[i++]=e:t.pool.release(e);t.acquired.length=i}}}},75015:function(e,t,i){i.d(t,{c:function(){return h}});i(61432);var r=i(61100),n=i(93568),s=i(92462),a=i(87422),o=i(99153),l=i(39355);class c{constructor(e,t){this.item=e,this.controller=t,this.promise=null}}class h{constructor(e){this._schedule=null,this._task=null,this._deferreds=new a.Z,this._controllers=new a.Z,this._processingItems=new a.Z,this._pausedSignal=(0,l.t)(!1),this.concurrency=1,e.concurrency&&(this.concurrency=e.concurrency),this._queue=new s.Z(e.peeker),this.process=e.process;const t=e.scheduler;e.priority&&t&&(this._task=t.registerTask(e.priority,this))}destroy(){this.clear(),this._schedule=(0,r.hw)(this._schedule),this._task=(0,r.hw)(this._task)}get updating(){return!!this._task?.updating||this.running}get length(){return this._processingItems.size+this._queue.length}abort(e){const t=this._controllers.get(e);t&&t.abort()}clear(){this._queue.clear();const e=[];this._controllers.forEach((t=>e.push(t))),this._controllers.clear(),e.forEach((e=>e.abort())),this._processingItems.clear(),this._cancelNext()}forEach(e){this._deferreds.forEach(((t,i)=>e(i)))}get(e){const t=this._deferreds.get(e);return t?t.promise:void 0}isOngoing(e){return this._processingItems.has(e)}has(e){return this._deferreds.has(e)}pause(){this._pausedSignal.value||(this._pausedSignal.value=!0,this._cancelNext())}push(e,t){const i=this.get(e);if(i)return i;const r=new AbortController;let s=null;t&&(s=(0,n.fu)(t,(()=>r.abort())));const a=()=>{o.remove(),null!=s&&s.remove(),this._removeItem(e),this._queue.remove(e),this._scheduleNext()},o=(0,n.$F)(r.signal,(()=>{const t=this._processingItems.get(e);t&&t.controller.abort(),a(),l.reject((0,n.zE)())})),l=(0,n.hh)();return this._deferreds.set(e,l),this._controllers.set(e,r),l.promise.then(a,a),this._queue.push(e),this._scheduleNext(),l.promise}last(){return this._queue.last()}lastPromise(){const e=this.last();return e?this.get(e):null}peek(){return this._queue.peek()}popLast(){const e=this._queue.popLast();return e&&(this._deferreds.get(e)?.reject((0,n.zE)()),this._removeItem(e)),e}reset(){const e=Array.from(this._processingItems.values());this._processingItems.clear();for(const t of e)this._queue.push(t.item),t.controller.abort();this._scheduleNext()}resume(){this._pausedSignal.value&&(this._pausedSignal.value=!1,this._scheduleNext())}takeAll(){const e=[];for(;this._queue.length;)e.push(this._queue.pop());return this.clear(),e}get running(){return!this._pausedSignal.value&&this._queue.length>0&&this._processingItems.size<this.concurrency}runTask(e){for(;!e.done&&this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),e.madeProgress()}_removeItem(e){this._deferreds.delete(e),this._controllers.delete(e),this._processingItems.delete(e)}_scheduleNext(){this._task||this._pausedSignal.value||this._schedule||(this._schedule=(0,o.Os)((()=>{this._schedule=null,this._next()})))}_next(){for(;this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())}_cancelNext(){this._schedule&&(this._schedule.remove(),this._schedule=null)}_processResult(e,t){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).resolve(t))}_processError(e,t){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).reject(t))}_canProcessFulfillment(e){return!!this._deferreds.get(e.item)&&this._processingItems.get(e.item)===e}_process(e){if(null==e)return;let t;const i=new AbortController,r=new c(e,i);this._processingItems.set(e,r);try{t=this.process(e,i.signal)}catch(e){this._processError(r,e)}(0,n.y8)(t)?(r.promise=t,t.then((e=>this._processResult(r,e)),(e=>this._processError(r,e)))):this._processResult(r,t)}get test(){}}},22455:function(e,t,i){async function r(e,t){if("2d"===e.type)return e.hitTest(t);const i=await e.hitTest(t);if(0===i.results.length)return i;const r=i.results[0],s=(r.distance??0)*(1+n),a=i.results.findIndex((e=>(e.distance??0)>s));return-1!==a&&(i.results=i.results.slice(0,a)),r&&i.ground.distance>s&&(i.ground.mapPoint=null),i}i.d(t,{ZV:function(){return r},qm:function(){return a}});const n=.05;function s(e){return"graphic"===e?.type}function a(e){return e.find(s)??null}},27546:function(e,t,i){i.d(t,{Av:function(){return c},Cy:function(){return h},Dc:function(){return u},GB:function(){return l},Xi:function(){return d},_1:function(){return a},lE:function(){return p},rs:function(){return o},tl:function(){return s}});var r=i(88194),n=i(61432);function s(e){return e&&"function"==typeof e.highlight}function a(e){return e&&"function"==typeof e.maskOccludee}function o(e,t,i){return null==e||e>=i&&(0===t||e<=t)}function l(e,t){if(t&&e){const{minScale:i,maxScale:r}=e;if(c(i,r))return o(t,i,r)}return!0}function c(e,t){return null!=e&&e>0||null!=t&&t>0}function h(e){return!e?.minScale||!e.maxScale||e.minScale>=e.maxScale}const u=()=>!(0,n.Z)("disable-feature:layer-based-scale-visibility");function d(e){return null!=e&&"object"==typeof e&&"createQuery"in e&&"queryFeatures"in e&&"layer"in e&&"view"in e}function p(e,t,i){return new r.Z("layerview:spatial-reference-incompatible",`The spatial reference of this ${e}${t?`(wkid:${t})`:""} is incompatible with the spatial reference of the view${i?`(wkid:${i})`:""}.`,{})}},70134:function(e,t,i){i.d(t,{Eu:function(){return a},Rw:function(){return l},Sj:function(){return s},s6:function(){return o},vT:function(){return n}});i(61432);var r=i(96094);function n(e){return(0,r.vW)(e.x,e.y)}function s(e){return(0,r.s1)(e.x,e.y)}function a(e,t){const i=(e instanceof HTMLElement?e:e.surface)?.getBoundingClientRect();return i?(0,r.vW)(t.clientX-i.left,t.clientY-i.top):(0,r.vW)(0,0)}function o(e,t){return t instanceof Event?a(e,t):n(t)}function l(e){if(e instanceof Event)return!0;if("object"==typeof e&&"type"in e)switch(e.type){case"click":case"double-click":case"pointer-down":case"pointer-drag":case"pointer-enter":case"pointer-leave":case"pointer-up":case"pointer-move":case"immediate-click":case"immediate-double-click":case"hold":case"drag":case"mouse-wheel":return!0;default:return!1}return!1}},53433:function(e,t,i){i.r(t),i.d(t,{completeUserSettings:function(){return s},createEmptyImageData:function(){return n.r7},encode:function(){return o},encodeData:function(){return l},getFormatAndQuality:function(){return p},getMaximumResolutionScale:function(){return m},resampleHermite:function(){return f},screenshotSuperSampleSettings:function(){return _},toDataUrl:function(){return d},toRenderSettings:function(){return a}});i(61432);var r=i(99574),n=i(35236);function s(e,t){const{format:i,quality:n,rotation:s,disableDecorations:a}=e||{},o=g(e,t.padding),l=function(e,t){const i={x:0,y:0,width:t.width,height:t.height};if(e?.area){null!=e.area.x&&(i.x=Math.floor(e.area.x)),null!=e.area.y&&(i.y=Math.floor(e.area.y));const r=null!=e.area.width?Math.floor(e.area.width):null,n=null!=e.area.height?Math.floor(e.area.height):null;if(i.width=t.width-i.x,i.height=t.height-i.y,null!=r&&null!=n)i.width=Math.min(i.width,r),i.height=Math.min(i.height,n);else if(null==r&&null!=n){const e=Math.min(i.width,r);i.height=e/i.width*i.height,i.width=e}else if(null!=r&&null==n){const e=Math.min(i.height,n);i.width=e/i.height*i.width,i.height=e}}return function(e,t){const i=Math.floor(Math.max(e.x,0)),r=Math.floor(Math.max(e.y,0)),n={x:i,y:r,width:Math.floor(Math.min(e.width,t.width-i)),height:Math.floor(Math.min(e.height,t.height-r))},s=n.width/n.height,a=e.width/e.height;if(a===s)return n;if(a>s){const e=Math.floor(n.width/a),t=n.height-e;return{x:n.x,y:Math.floor(n.y+t/2),width:n.width,height:e}}const o=Math.floor(n.height*a),l=n.width-o;return{x:Math.floor(n.x+l/2),y:n.y,width:o,height:n.height}}(function(e,t){if(null==t?.width||null==t.height)return e;const i=t.width/t.height,r=e.width/e.height;if(r===i)return e;if(r<i){const t=Math.floor(e.height*i);return e.x-=(t-e.width)/2,e.width=t,e}const n=Math.floor(e.width/i);return e.y-=(n-e.height)/2,e.height=n,e}(i,e),t)}(e,{width:t.width-o.left-o.right,height:t.height-o.top-o.bottom}),{width:c,height:h}=function(e,t){if(!e)return t;const i=e.width,r=e.height;if(null!=i&&null!=r)return{width:Math.floor(i),height:Math.floor(r)};if(null==i&&null==r)return t;const n=t.width/t.height;return null==r?{width:Math.floor(i),height:Math.floor(i/n)}:{width:Math.floor(r*n),height:Math.floor(r)}}(e,l),u=y(i),d=w[u];return{format:u,quality:(0,r.uZ)(null!=n?n:d,0,100),area:l,width:c,height:h,rotation:s,disableDecorations:!!a,ignoreBackground:!!e?.ignoreBackground,ignorePadding:!!e?.ignorePadding}}function a(e,t){const i=s(e,t),r=i.area,n=i.width/r.width,a=g(i,t.padding),o=a.left+a.right,l=a.top+a.bottom,c=t.width-o,h=t.height-l,u=Math.floor(c*n+o),d=Math.floor(h*n+l),p=e?.layers??[],m=i.ignoreBackground,f=i.ignorePadding;return{framebufferWidth:u,framebufferHeight:d,region:{x:Math.floor(r.x*n)+a.left,y:Math.floor(r.y*n)+a.top,width:i.width,height:i.height},format:i.format,quality:i.quality,rotation:i.rotation,pixelRatio:n,layers:p,disableDecorations:i.disableDecorations,ignoreBackground:m,ignorePadding:f,objectAndLayerIdColor:!1}}function o(e,t,i){const{ctx:r,canvas:n}=c(e,i),s=r.getImageData(0,0,e.width,e.height),a=d(n,t);return h(n),{dataUrl:a,data:s}}function l(e,t){const{ctx:i,canvas:r}=c(e,t),n=i.getImageData(0,0,e.width,e.height);return h(r),n}function c(e,t){const i=(null==u&&(u=document.createElement("canvas")),u);t.premultipliedAlpha&&function(e){const t=e.data,i=t.length;for(let e=0;e<i;e+=4){const i=t[e+3];if(255!==i&&i>0){const r=255/i;t[e]=t[e]*r,t[e+1]=t[e+1]*r,t[e+2]=t[e+2]*r}}}(e),i.width=e.width,i.height=e.height;const r=i.getContext("2d",{willReadFrequently:!0});return r.putImageData(e,0,0),t.flipY&&function(e){e.save(),e.globalCompositeOperation="copy",e.scale(1,-1),e.translate(0,-e.canvas.height),e.drawImage(e.canvas,0,0),e.restore()}(r),{ctx:r,canvas:i}}function h(e){e.width=0,e.height=0}let u=null;function d(e,t){const i=v[t.format],r=t.quality/100;return e.toDataURL(i,r)}function p(e,t){const i=y(e),n=w[i];return{format:i,quality:(0,r.uZ)(null!=t?t:n,0,100)}}function m(e,t){return t/Math.max(e[0],e[1])}function f(e,t,i,r=0,n=0,s=e.width-r,a=e.height-n,o=!1){const{data:l}=e,{width:c,height:h,data:u}=t,d=s/c,p=a/h,m=Math.ceil(d/2),f=Math.ceil(p/2),_=e.width;for(let e=0;e<h;e++)for(let t=0;t<c;t++){const s=4*(t+(o?h-e-1:e)*c);let a=0,g=0,y=0,v=0,b=0,w=0;const C=(e+.5)*p;for(let s=Math.floor(e*p);s<(e+1)*p;s++){const e=Math.abs(C-(s+.5))/f,o=(t+.5)*d,c=e*e;for(let e=Math.floor(t*d);e<(t+1)*d;e++){const t=Math.abs(o-(e+.5))/m,h=Math.sqrt(c+t*t);if(h>=1)continue;let u=2*h*h*h-3*h*h+1;const d=4*(r+e+(n+s)*_);w+=u*l[d+3],g+=u,!i&&l[d+3]<255&&(u=u*l[d+3]/255),y+=u*l[d],v+=u*l[d+1],b+=u*l[d+2],a+=u}}u[s]=y/a,u[s+1]=v/a,u[s+2]=b/a,u[s+3]=w/g}return t}function _(e,t,i){if(!t)return e;const{framebufferWidth:r,framebufferHeight:n,pixelRatio:s,region:a}=e,o=g(e,i),l=o.left+o.right,c=o.top+o.bottom,h=r-l,u=n-c,d=Math.min(8,Math.min((2048-l)/h,(2048-c)/u));return d<1.5?e:{...e,framebufferWidth:Math.round(h*d)+l,framebufferHeight:Math.round(u*d)+c,pixelRatio:s*d,resample:{region:{x:Math.round((a.x-o.left)*d)+o.left,y:Math.round((a.y-o.top)*d)+o.top,width:Math.round(a.width*d),height:Math.round(a.height*d)},width:r,height:n}}}function g(e,t){return!t||e?.ignorePadding?C:t}function y(e){switch(e){case"png":case"jpg":case"jpeg":return e;default:return b}}const v={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"},b="png",w={png:100,jpg:98,jpeg:98},C={top:0,right:0,bottom:0,left:0}},45391:function(e,t,i){i.d(t,{D:function(){return s}});var r=i(5052),n=i(56172);function s(e,t){return null!=e&&(null==t||(t===n.JY.Local?!e.isGeographic||e.isWGS84||e.wkid===r.W.CGCS2000:e.isWebMercator||e.isWGS84||e.wkid===r.W.CGCS2000||e.wkid===r.W.GCSMARS2000||e.wkid===r.W.GCSMARS2000_SPHERE||e.wkid===r.W.GCSMOON2000))}},31454:function(e,t,i){i.d(t,{X:function(){return d},d:function(){return f}});i(61432);var r=i(96711),n=i(61100),s=i(92761),a=i(13e3),o=i(65650),l=i(29870),c=i(54704);class h{constructor(e,t){this._context=e,this._descriptor=t,this.type=l.R.Renderbuffer,this._context.instanceCounter.increment(o._g.Renderbuffer,this);const i=this._context.gl;this.glName=i.createRenderbuffer(),this._context.bindRenderbuffer(this);const{width:r,height:n,internalFormat:s,multisampled:a}=t;a?i.renderbufferStorageMultisample(i.RENDERBUFFER,this.samples,s,r,n):i.renderbufferStorage(i.RENDERBUFFER,s,r,n),this._context.bindRenderbuffer(null)}get descriptor(){return this._descriptor}get samples(){const e=this._descriptor.samples,t=this._context.parameters.maxSamples;return e?Math.min(e,t):t}get usedMemory(){return(0,c.G)(this._descriptor)}resize(e,t){const i=this._descriptor;if(i.width===e&&i.height===t)return;i.width=e,i.height=t;const r=this._context.gl;this._context.bindRenderbuffer(this),i.multisampled?r.renderbufferStorageMultisample(r.RENDERBUFFER,this.samples,i.internalFormat,i.width,i.height):r.renderbufferStorage(r.RENDERBUFFER,i.internalFormat,i.width,i.height),this._context.bindRenderbuffer(null)}dispose(){this._context&&(this._context.gl.deleteRenderbuffer(this.glName),this._context.instanceCounter.decrement(o._g.Renderbuffer,this),this._context=null)}}var u=i(8158);class d{constructor(e,t,i){if(this._context=e,this._glName=null,this._colorAttachments=new Map,this._depthStencilBuffer=null,this._depthStencilTexture=null,this._initialized=!1,e.instanceCounter.increment(o._g.FramebufferObject,this),null!=t){const i=p(t)?t:new u.x(e,t);this._colorAttachments.set(o.Ii,i),this._validateTextureDescriptor(i.descriptor),this._validateColorAttachmentPoint(o.Ii)}if(null!=i)if(function(e){return p(e)||function(e){return m(e)===l.R.TextureDescriptor}(e)}(i))this._depthStencilTexture=p(i)?i:new u.x(e,i),this._validateTextureDescriptor(this._depthStencilTexture.descriptor);else{const t=function(e){return m(e)===l.R.Renderbuffer}(i)?i:new h(e,i);this._depthStencilBuffer=t,this._validateRenderbufferDescriptor(t.descriptor)}}dispose(){const{_colorAttachments:e,_glName:t}=this;if(0===e.size&&!this._depthStencilBuffer&&!this._depthStencilTexture&&!t)return;const{_context:i}=this,r=i.getBoundFramebufferObject();e.forEach(((e,t)=>this.detachColorTexture(t)?.dispose())),this.detachDepthStencilBuffer()?.dispose(),this.detachDepthStencilTexture()?.dispose(),i.gl.deleteFramebuffer(t),this._glName=null,i.bindFramebuffer(r===this?null:r),i.instanceCounter.decrement(o._g.FramebufferObject,this)}get glName(){return this._glName}get colorTexture(){return this._colorAttachments.get(o.Ii)}get depthStencil(){return this._depthStencilTexture||this._depthStencilBuffer}get depthStencilTexture(){return this._depthStencilTexture}get width(){return(this._colorAttachments.get(o.Ii)??this._depthStencilTexture??this._depthStencilBuffer)?.descriptor?.width??0}get height(){return(this._colorAttachments.get(o.Ii)??this._depthStencilTexture??this._depthStencilBuffer)?.descriptor?.height??0}get usedMemory(){return[...this._colorAttachments].reduce(((e,[t,i])=>e+i.usedMemory),this.depthStencil?.usedMemory??0)}static{this._MAX_COLOR_ATTACHMENTS=-1}getColorTexture(e){const t=this._colorAttachments.get(e);return t&&p(t)?t:null}get colorAttachments(){return[...this._colorAttachments.keys()]}attachColorTexture(e,t=o.Ii){if(!e)return;this._validateColorAttachmentPoint(t);const{descriptor:i}=e;this._validateTextureDescriptor(i),this.detachColorTexture(t)?.dispose(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(e.glName,t)),this._colorAttachments.set(t,e)}detachColorTexture(e=o.Ii){const t=this._colorAttachments.get(e);if(t)return this._initialized&&this._context.temporaryBindFramebufferObject(this,(()=>{this._framebufferTexture2D(null,e)})),this._colorAttachments.delete(e),t}setColorTextureTarget(e,t=o.Ii,i=0){const r=this._colorAttachments.get(t);r&&(e===o.No.TEXTURE_2D_ARRAY?this._framebufferTextureLayer(r.glName,t,o.qi.FRAMEBUFFER,0,i):this._framebufferTexture2D(r.glName,t,e,o.qi.FRAMEBUFFER,0))}attachDepthStencil(e){if(e)switch(e.type){case l.R.Texture:return this._attachDepthStencilTexture(e);case l.R.Renderbuffer:return this._attachDepthStencilBuffer(e)}}_attachDepthStencilTexture(e){if(null==e)return;const{descriptor:t}=e,{pixelFormat:i,dataType:r}=t;i===o.N2.DEPTH_STENCIL||i===o.N2.DEPTH_COMPONENT?i!==o.N2.DEPTH_STENCIL||r===o.Br.UNSIGNED_INT_24_8?i!==o.N2.DEPTH_COMPONENT||r===o.Br.UNSIGNED_INT||r===o.Br.UNSIGNED_SHORT?(this._validateTextureDescriptor(t),this._disposeDepthStencilAttachments(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(e.glName,g(i))),this._depthStencilTexture?.dispose(),this._depthStencilTexture=e):console.error("Depth texture must have data type of UNSIGNED_INT or UNSIGNED_SHORT!"):console.error("Depth/Stencil texture must have data type of UNSIGNED_INT_24_8!"):console.error("Depth/Stencil texture must have a pixel type of DEPTH_STENCIL!")}detachDepthStencilTexture(){const e=this._depthStencilTexture;return e&&this._initialized&&this._context.temporaryBindFramebufferObject(this,(()=>{this._framebufferTexture2D(null,g(e.descriptor.pixelFormat))})),this._depthStencilTexture=null,e}_attachDepthStencilBuffer(e){if(null==e)return;const t=e.descriptor;if(this._validateRenderbufferDescriptor(t),this._disposeDepthStencilAttachments(),this._initialized){this._context.bindFramebuffer(this);const{gl:i}=this._context,r=this._getGLAttachmentPoint(t);i.framebufferRenderbuffer(o.qi.FRAMEBUFFER,r,i.RENDERBUFFER,e.glName)}this._depthStencilBuffer=e}detachDepthStencilBuffer(){const e=this._depthStencilBuffer;if(e&&this._initialized){const{_context:t}=this,i=t.getBoundFramebufferObject();t.bindFramebuffer(this);const{gl:r}=t,n=this._getGLAttachmentPoint(e.descriptor);r.framebufferRenderbuffer(o.qi.FRAMEBUFFER,n,r.RENDERBUFFER,null),t.bindFramebuffer(i)}return this._depthStencilBuffer=null,e}invalidateAttachments(e){const{_context:t}=this;t.temporaryBindFramebufferObject(this,(()=>t.gl.invalidateFramebuffer(o.qi.FRAMEBUFFER,e)),!0)}copyToTexture(e,t,i,r,n,s,a){(e<0||t<0||n<0||s<0)&&console.error("Offsets cannot be negative!"),(i<=0||r<=0)&&console.error("Copy width and height must be greater than zero!");const l=a.descriptor;a.descriptor.target!==o.No.TEXTURE_2D&&console.error("Texture target must be TEXTURE_2D!"),(null==l?.width||null==l?.height||e+i>this.width||t+r>this.height||n+i>l.width||s+r>l.height)&&console.error("Bad dimensions, the current input values will attempt to read or copy out of bounds!");const c=this._context,h=c.bindTexture(a,u.x.TEXTURE_UNIT_FOR_UPDATES);c.setActiveTexture(u.x.TEXTURE_UNIT_FOR_UPDATES),c.bindFramebuffer(this),c.gl.copyTexSubImage2D(o.No.TEXTURE_2D,0,n,s,e,t,i,r),c.bindTexture(h,u.x.TEXTURE_UNIT_FOR_UPDATES)}readPixels(e,t,i,r,n,s,a){(i<=0||r<=0)&&console.error("Copy width and height must be greater than zero!"),a||console.error("Target memory is not initialized!"),this._context.bindFramebuffer(this),this._context.gl.readPixels(e,t,i,r,n,s,a)}async readPixelsAsync(e,t,i,r,n,a,l){const{gl:c}=this._context,h=s.f.createPixelPack(this._context,o.l1.STREAM_READ,l.byteLength);this._context.bindBuffer(h);const u=this._context.getBoundFramebufferObject();this._context.bindFramebuffer(this),c.readPixels(e,t,i,r,n,a,0),this._context.unbindBuffer(o.w0.PIXEL_PACK_BUFFER),this._context.bindFramebuffer(u),await h.getSubDataAsync(l),h.dispose()}resize(e,t){if(this.width===e&&this.height===t)return;const i={width:e,height:t};f(i,this._context.parameters.maxTextureSize),this._colorAttachments.forEach((e=>e.resize(i.width,i.height))),this._depthStencilTexture?.resize(i.width,i.height),this._initialized&&(f(i,this._context.parameters.maxRenderbufferSize),this._depthStencilBuffer?.resize(i.width,i.height),this._context.getBoundFramebufferObject()===this&&this._context.bindFramebuffer(null),this._initialized=!1)}initializeAndBind(e=o.qi.FRAMEBUFFER){const{gl:t}=this._context;if(this._initialized)return void t.bindFramebuffer(e,this.glName);this._glName&&t.deleteFramebuffer(this._glName);const i=t.createFramebuffer();if(t.bindFramebuffer(e,i),this._colorAttachments.forEach(((t,i)=>{const r=_(t);r===o.No.TEXTURE_2D_ARRAY?this._framebufferTextureLayer(t.glName,i,e,0,0):this._framebufferTexture2D(t.glName,i,r,e)})),this._depthStencilBuffer){const i=this._getGLAttachmentPoint(this._depthStencilBuffer.descriptor);t.framebufferRenderbuffer(e,i,t.RENDERBUFFER,this._depthStencilBuffer.glName)}else if(this._depthStencilTexture){const t=g(this._depthStencilTexture.descriptor.pixelFormat);this._framebufferTexture2D(this._depthStencilTexture.glName,t,_(this._depthStencilTexture),e)}(0,a.hZ)()&&t.checkFramebufferStatus(e)!==t.FRAMEBUFFER_COMPLETE&&console.error("Framebuffer is incomplete!"),this._glName=i,this._initialized=!0}_framebufferTexture2D(e,t=o.Ii,i=o.No.TEXTURE_2D,r=o.qi.FRAMEBUFFER,n=0){this._context.gl.framebufferTexture2D(r,t,i,e,n)}_framebufferTextureLayer(e,t=o.Ii,i=o.qi.FRAMEBUFFER,r=0,n=0){this._context.gl.framebufferTextureLayer(i,t,e,r,n)}_disposeDepthStencilAttachments(){const e=this._context.gl;if(this._depthStencilBuffer){if(this._initialized){this._context.bindFramebuffer(this);const t=this._getGLAttachmentPoint(this._depthStencilBuffer.descriptor);e.framebufferRenderbuffer(o.qi.FRAMEBUFFER,t,e.RENDERBUFFER,null)}this._depthStencilBuffer=(0,n.M2)(this._depthStencilBuffer)}this._depthStencilTexture&&(this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,g(this._depthStencilTexture.descriptor.pixelFormat))),this._depthStencilTexture=(0,n.M2)(this._depthStencilTexture))}_validateTextureDescriptor(e){e.target!==o.No.TEXTURE_2D&&e.target!==o.No.TEXTURE_CUBE_MAP&&e.target!==o.No.TEXTURE_2D_ARRAY&&console.error("Texture type must be TEXTURE_2D, TEXTURE_2D_ARRAY or TEXTURE_CUBE_MAP!"),f(e,this._context.parameters.maxTextureSize),this._validateBufferDimensions(e)}_validateRenderbufferDescriptor(e){f(e,this._context.parameters.maxRenderbufferSize),this._validateBufferDimensions(e)}_validateBufferDimensions(e){e.width<=0&&(e.width=this.width),e.height<=0&&(e.height=this.height),this.width>0&&this.height>0&&(this.width===e.width&&this.height===e.height||console.error("Attachment size must match framebuffer size!"))}_getGLAttachmentPoint(e){switch(e.internalFormat){case o.DM.DEPTH_COMPONENT16:case o.DM.DEPTH_COMPONENT24:case o.DM.DEPTH_COMPONENT32F:return o._L;case o.wo.DEPTH24_STENCIL8:case o.wo.DEPTH32F_STENCIL8:return o.Lu;case o.YM.STENCIL_INDEX8:return o.sQ}}_validateColorAttachmentPoint(e){if(-1===d._MAX_COLOR_ATTACHMENTS){const{gl:e}=this._context;d._MAX_COLOR_ATTACHMENTS=e.getParameter(e.MAX_COLOR_ATTACHMENTS)}const t=e-o.Ii;t+1>d._MAX_COLOR_ATTACHMENTS&&r.Z.getLogger("esri.views.webgl.FrameBufferObject").error("esri.FrameBufferObject",`illegal attachment point for color attachment: ${t+1}. Implementation supports up to ${d._MAX_COLOR_ATTACHMENTS} color attachments`)}}function p(e){return m(e)===l.R.Texture}function m(e){return null!=e&&"type"in e?e.type:null}function f(e,t){const i=Math.max(e.width,e.height);if(i>t){r.Z.getLogger("esri.views.webgl.FramebufferObject").warnOnce(`Resizing FBO attachment size ${e.width}x${e.height} to device limit ${t}`);const n=t/i;return e.width=Math.round(e.width*n),e.height=Math.round(e.height*n),!1}return!0}function _(e){return e.descriptor.target===o.No.TEXTURE_CUBE_MAP?o.No.TEXTURE_CUBE_MAP_POSITIVE_X:e.descriptor.target===o.No.TEXTURE_2D_ARRAY?o.No.TEXTURE_2D_ARRAY:o.No.TEXTURE_2D}function g(e){return e===o.N2.DEPTH_COMPONENT?o._L:o.Lu}},54704:function(e,t,i){i.d(t,{G:function(){return s},Y:function(){return n}});var r=i(15483);class n{constructor(e,t=0,i=t){this.internalFormat=e,this.width=t,this.height=i,this.multisampled=!1,this.samples=1}}function s(e){return e.width<=0||e.height<=0||null==e.internalFormat?0:e.width*e.height*(0,r.RG)(e.internalFormat)}},33776:function(e,t,i){i.d(t,{h:function(){return s}});var r=i(80290);let n;function s(){return n??=function(){const e=new a,t=function(e){if("undefined"==typeof WebGL2RenderingContext)return null;const t=document.createElement("canvas");if(!t)return null;let i=t.getContext("webgl2",{failIfMajorPerformanceCaveat:!0});if(null==i&&(i=t.getContext("webgl2"),null!=i&&(e.majorPerformanceCaveat=!0,e.unmaskedRenderer=(0,r.z)(i)?.getUnmaskedRenderer()??"unknown")),null==i)return i;e.available=!0,e.maxTextureSize=i.getParameter(i.MAX_TEXTURE_SIZE),e.supportsVertexShaderSamplers=i.getParameter(i.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0;const n=i.getShaderPrecisionFormat(i.FRAGMENT_SHADER,i.HIGH_FLOAT);return n&&(e.supportsHighPrecisionFragment=n.precision>0),i}(e);return null==t||(e.supportsColorBufferFloat=null!==t.getExtension("EXT_color_buffer_float"),e.supportsColorBufferFloatBlend=null!==t.getExtension("EXT_float_blend"),e.supportsColorBufferHalfFloat=e.supportsColorBufferFloat||null!==t.getExtension("EXT_color_buffer_half_float")),e}(),n}class a{constructor(){this.available=!1,this.majorPerformanceCaveat=!1,this.maxTextureSize=0,this.supportsVertexShaderSamplers=!1,this.supportsHighPrecisionFragment=!1,this.supportsColorBufferFloat=!1,this.supportsColorBufferFloatBlend=!1,this.supportsColorBufferHalfFloat=!1,this.unmaskedRenderer="unloaded"}}},80290:function(e,t,i){i.d(t,{z:function(){return n}});class r{constructor(e){this.getUnmaskedRenderer=e}}function n(e){const t=e.getExtension("WEBGL_debug_renderer_info");return t?new r((()=>e.getParameter(t.UNMASKED_RENDERER_WEBGL))):null}},49675:function(e,t,i){i.d(t,{Nw:function(){return m}});var r=i(88194),n=i(28947),s=i(60123),a=i(42146),o=i(75428);const l=new Set(["bing-maps","imagery","imagery-tile","map-image","open-street-map","tile","unknown","unsupported","vector-tile","web-tile","wcs","wms","wmts"]),c=new Set(["catalog","csv","feature","geo-rss","geojson","group","imagery","imagery-tile","kml","knowledge-graph","map-image","map-notes","media","ogc-feature","oriented-imagery","route","stream","subtype-group","tile","unknown","unsupported","vector-tile","video","web-tile","wcs","wfs","wms","wmts"]),h=new Set([...c,"link-chart"]);function u(e,t){if(t.restrictedWebMapWriting){const i=function(e){switch(e.layerContainerType){case"basemap":return l;case"operational-layers":return"link-chart"===e.origin?h:c;default:return null}}(t);return null==i||i.has(e.type)&&!(0,o.rQ)(e)}return!0}function d(e,t){"maxScale"in e&&(t.maxScale=(0,a.k)(e.maxScale)??void 0),"minScale"in e&&(t.minScale=(0,a.k)(e.minScale)??void 0)}function p(e,t){if(function(e,t){if(t)if((0,o.rQ)(e)){const i=(0,s.hS)("featureCollection.layers",t)?.[0]?.layerDefinition;i&&d(e,i)}else"group"!==e.type&&d(e,t)}(e,t),t&&(t.id=e.id,"blendMode"in e&&(t.blendMode=e.blendMode,"normal"===t.blendMode&&delete t.blendMode),t.opacity=(0,a.k)(e.opacity)??void 0,t.title=e.title||"Layer",t.visibility=e.visible,"legendEnabled"in e&&"wmts"!==e.type))if((0,o.rQ)(e)){const i=t.featureCollection;i&&(i.showLegend=e.legendEnabled)}else t.showLegend=e.legendEnabled}function m(e,t,i){if(!e.persistenceEnabled)return null;if(!("write"in e)||!e.write)return i?.messages&&i.messages.push(new r.Z("layer:unsupported",`Layers (${e.title}, ${e.id}) of type '${e.declaredClass}' cannot be persisted`,{layer:e})),null;if((0,o.rQ)(e)&&!e.isTable)t=e.resourceInfo;else if(u(e,i)){const t={};return e.write(t,i)?t:null}return null!=t&&p(e,t=(0,n.d9)(t)),t}},17733:function(e,t,i){i.d(t,{Z:function(){return u}});var r,n=i(73440),s=i(63255),a=i(17155),o=(i(61432),i(96711),i(83850),i(1194)),l=i(48023),c=i(29884);let h=class extends s.Z{static{r=this}constructor(e){super(e),this.type="sun",this.date=null,this.directShadowsEnabled=!1,this.displayUTCOffset=null}readDate(e,t){return null!=t.datetime&&new Date(t.datetime)||null}writeDate(e,t,i){t[i]=e.getTime()}readDirectShadowsEnabled(e,t){return!!t.directShadows}writedirectShadowsEnabled(e,t,i){e&&(t[i]=e)}writeDisplayUTCOffset(e,t){null!=e&&(t.displayUTCOffset=e)}clone(){return new r(this.cloneConstructProperties())}cloneConstructProperties(){const e={directShadowsEnabled:this.directShadowsEnabled,displayUTCOffset:null!=this.displayUTCOffset?this.displayUTCOffset:null};return null!=this.date&&(e.date=new Date(this.date.getTime())),e}};(0,n._)([(0,a.Cb)({readOnly:!0,type:["sun"],json:{write:!0}})],h.prototype,"type",void 0),(0,n._)([(0,a.Cb)({type:Date,json:{type:Number,write:{target:"datetime"}}})],h.prototype,"date",void 0),(0,n._)([(0,o.r)("date",["datetime"])],h.prototype,"readDate",null),(0,n._)([(0,c.c)("date")],h.prototype,"writeDate",null),(0,n._)([(0,a.Cb)({type:Boolean,json:{default:!1,write:{target:"directShadows"}}})],h.prototype,"directShadowsEnabled",void 0),(0,n._)([(0,o.r)("directShadowsEnabled",["directShadows"])],h.prototype,"readDirectShadowsEnabled",null),(0,n._)([(0,c.c)("directShadowsEnabled")],h.prototype,"writedirectShadowsEnabled",null),(0,n._)([(0,a.Cb)({type:Number,json:{write:!0}})],h.prototype,"displayUTCOffset",void 0),(0,n._)([(0,c.c)("displayUTCOffset")],h.prototype,"writeDisplayUTCOffset",null),h=r=(0,n._)([(0,l.j)("esri.webscene.SunLighting")],h);const u=h},83946:function(e,t,i){i.d(t,{Z:function(){return c}});var r,n=i(73440),s=i(63255),a=i(17155),o=(i(61432),i(96711),i(83850),i(48023));let l=class extends s.Z{static{r=this}constructor(e){super(e),this.type="virtual",this.directShadowsEnabled=!1}clone(){return new r(this.cloneConstructProperties())}cloneConstructProperties(){return{directShadowsEnabled:this.directShadowsEnabled}}};(0,n._)([(0,a.Cb)({readOnly:!0,type:["virtual"],json:{write:{isRequired:!0}}})],l.prototype,"type",void 0),(0,n._)([(0,a.Cb)({type:Boolean,json:{default:!1,name:"directShadows",write:!0}})],l.prototype,"directShadowsEnabled",void 0),l=r=(0,n._)([(0,o.j)("esri.webscene.VirtualLighting")],l);const c=l},93427:function(e,t,i){i.d(t,{Z:function(){return p}});var r=i(73440),n=i(70880),s=i(93568),a=i(17155),o=(i(61432),i(96711),i(83850),i(48023));let l=class extends n.Z{get canZoomIn(){const e=this.view?.ready;if(!e)return!1;const t=this.view?.constraints?.effectiveMaxScale;return 0===t||this._scale>t}get canZoomOut(){const{view:e}=this,t=e?.ready;if(!t)return!1;const i=e.constraints?.effectiveMinScale;return 0===i||this._scale<i}get _scale(){const e=this.view?.animation?.target;return(e&&"then"in e?void 0:e?.scale)??this.view?.scale??0}};(0,r._)([(0,a.Cb)({readOnly:!0})],l.prototype,"canZoomIn",null),(0,r._)([(0,a.Cb)({readOnly:!0})],l.prototype,"canZoomOut",null),(0,r._)([(0,a.Cb)()],l.prototype,"view",void 0),(0,r._)([(0,a.Cb)()],l.prototype,"_scale",null),l=(0,r._)([(0,o.j)("esri.widgets.Zoom.ZoomConditions2D")],l);const c=l;let h=class extends n.Z{get canZoomIn(){return!!this.view.ready}get canZoomOut(){return!!this.view.ready}};(0,r._)([(0,a.Cb)({readOnly:!0})],h.prototype,"canZoomIn",null),(0,r._)([(0,a.Cb)({readOnly:!0})],h.prototype,"canZoomOut",null),(0,r._)([(0,a.Cb)()],h.prototype,"view",void 0),h=(0,r._)([(0,o.j)("esri.widgets.Zoom.ZoomConditions3D")],h);const u=h;let d=class extends n.Z{constructor(e){super(e)}destroy(){this.view=null}get canZoomIn(){return null!=this._zoomConditions&&this._zoomConditions.canZoomIn}get canZoomOut(){return null!=this._zoomConditions&&this._zoomConditions?.canZoomOut}get state(){return this.view?.ready?"ready":"disabled"}set view(e){e?"2d"===e.type?this._zoomConditions=new c({view:e}):"3d"===e.type&&(this._zoomConditions=new u({view:e})):this._zoomConditions=null,this._set("view",e)}zoomIn(){const e=this.view;this.canZoomIn&&e&&("2d"===e.type?e.mapViewNavigation.zoomIn():(0,s.R8)(e.goTo({zoomFactor:2})))}zoomOut(){const e=this.view;this.canZoomOut&&e&&("2d"===e.type?e.mapViewNavigation.zoomOut():(0,s.R8)(e.goTo({zoomFactor:.5})))}};(0,r._)([(0,a.Cb)()],d.prototype,"_zoomConditions",void 0),(0,r._)([(0,a.Cb)()],d.prototype,"canZoomIn",null),(0,r._)([(0,a.Cb)()],d.prototype,"canZoomOut",null),(0,r._)([(0,a.Cb)({readOnly:!0})],d.prototype,"state",null),(0,r._)([(0,a.Cb)()],d.prototype,"view",null),d=(0,r._)([(0,o.j)("esri.widgets.Zoom.ZoomViewModel")],d);const p=d},63712:function(e,t,i){i.d(t,{Z:function(){return o}});var r=i(73440),n=i(61100),s=i(17155),a=(i(61432),i(96711),i(83850),i(48023));const o=e=>{let t=class extends e{constructor(...e){super(...e),this.goToOverride=null,this.view=null}callGoTo(e){const{view:t}=this;return(0,n.O3)(t),this.goToOverride?this.goToOverride(t,e):function(e,t,i){return e.goTo(t,i)}(t,e.target,e.options)}};return(0,r._)([(0,s.Cb)()],t.prototype,"goToOverride",void 0),(0,r._)([(0,s.Cb)()],t.prototype,"view",void 0),t=(0,r._)([(0,a.j)("esri.widgets.support.GoTo")],t),t}},29359:function(e,t,i){i.d(t,{g:function(){return r}});const r={disabled:"esri-disabled",empty:"esri-widget__content--empty",heading:"esri-widget__heading",loaderAnimation:"esri-widget__loader-animation",panel:"esri-widget--panel",widget:"esri-widget esri-component",widgetButton:"esri-widget--button",widgetDisabled:"esri-widget--disabled"}},41203:function(e,t,i){i.d(t,{u:function(){return s}});var r=i(20803),n=i(64297);const s=(0,r.qK)(n.g)},97237:function(e,t,i){i.d(t,{m:function(){return o}});var r=i(20803),n=i(46789),s=i(89273),a=i(90403);const o=(e,t)=>t=>c(t,e);class l extends n.lZ{#e=void 0;constructor(e,t){super(e,t),new s.V(this.component)}hostLoad(){this.#e=(0,a.YP)((()=>this.component.el.view),(e=>{this.instance.view=e,this.instance.map=e?.map}),{sync:!0,initial:!0})}hostDestroy(){this.#e?.remove(),super.hostDestroy()}}const c=(0,r.j8)(l)},15191:function(e,t,i){i(26059),i(4204),i(61637);var r=i(64297),n=i(15294),s=i(20803),a=i(21042),o=i(18177);var l=i(73440),c=i(70880),h=i(90403),u=i(17155),d=i(90775),p=(i(61432),i(83850),i(48023)),m=i(13132),f=i(8554),_=i(13141);let g=class extends c.Z{constructor(e){super(e),this._basemapCache={},this._loadingProjectionEngine=!1,this.nextBasemap=(0,_.fF)("hybrid",this._basemapCache),this.view=null}initialize(){(0,h.YP)((()=>this.nextBasemap),(e=>{e&&!e.loaded&&e.load().catch((()=>{}))}),h.nn)}destroy(){this.view=null,(0,_.Bf)(this._basemapCache),this._basemapCache=null}get _nextBasemapSpatialReferenceTask(){return(0,o.Us)(this.view,this.nextBasemap)}get _viewSpatialReferenceLocked(){const{view:e}=this;return!e||!("spatialReferenceLocked"in e)||e.spatialReferenceLocked}get activeBasemap(){return(0,_.fF)(this.view?.map?.basemap??"topo-vector",this._basemapCache)}castNextBasemap(e){return(0,_.fF)(e,this._basemapCache)}get state(){const{view:e}=this;if(!e?.ready)return"disabled";if(this._nextBasemapSpatialReferenceTask.updating)return"disabled";const{spatialReference:t}=this._nextBasemapSpatialReferenceTask;return this._viewSpatialReferenceLocked&&null!=t&&!e.spatialReference.equals(t)?"incompatible-next-basemap":this._loadingProjectionEngine?"loading":"ready"}async toggle(){const{activeBasemap:e,nextBasemap:t,state:i,view:r}=this;if(!r||"disabled"===i||"incompatible-next-basemap"===i)return;const n=this._viewSpatialReferenceLocked;if(!n){if(await(0,h.N1)((()=>!this._nextBasemapSpatialReferenceTask.updating)),t!==this.nextBasemap||e!==this.activeBasemap)return;const{spatialReference:i}=this._nextBasemapSpatialReferenceTask;if(null==i||(0,f.fS)(r.spatialReference,i)||(0,m.isLoaded)()||(0,m.canProjectWithoutEngine)(r.spatialReference,i)||(this._loadingProjectionEngine=!0,await(0,m.load)(),this._loadingProjectionEngine=!1),t!==this.nextBasemap||e!==this.activeBasemap)return}r.map.basemap=t,n||null==this._nextBasemapSpatialReferenceTask.spatialReference||(0,f.fS)(r.spatialReference,this._nextBasemapSpatialReferenceTask.spatialReference)||(r.spatialReference=this._nextBasemapSpatialReferenceTask.spatialReference),this.nextBasemap=e}static getThumbnailUrl(e){return(0,o.Qs)(e)}};(0,l._)([(0,u.Cb)()],g.prototype,"_loadingProjectionEngine",void 0),(0,l._)([(0,u.Cb)({readOnly:!0})],g.prototype,"_nextBasemapSpatialReferenceTask",null),(0,l._)([(0,u.Cb)({readOnly:!0})],g.prototype,"_viewSpatialReferenceLocked",null),(0,l._)([(0,u.Cb)({readOnly:!0})],g.prototype,"activeBasemap",null),(0,l._)([(0,u.Cb)()],g.prototype,"nextBasemap",void 0),(0,l._)([(0,d.p)("nextBasemap")],g.prototype,"castNextBasemap",null),(0,l._)([(0,u.Cb)({readOnly:!0})],g.prototype,"state",null),(0,l._)([(0,u.Cb)()],g.prototype,"view",void 0),(0,l._)([(0,u.Cb)()],g.prototype,"toggle",null),g=(0,l._)([(0,p.j)("esri.widgets.BasemapToggle.BasemapToggleViewModel")],g);const y=g;var v=i(54503),b=i(41203),w=i(97237),C=i(29359);const x=i(49006).iv`@layer{arcgis-basemap-toggle{display:block}.esri-basemap-toggle__title-wrap{text-wrap:wrap}}`,T="esri-basemap-toggle",S="esri-basemap-thumbnail",M={base:T,secondaryBasemapImage:`${T}__image--secondary`,container:`${S} ${T}__container`,image:`${S}__image ${T}__image`,imageLoading:`${T}__image--loading`,overlay:`${S}__overlay ${T}__image-overlay`,title:`${S}__title ${T}__title`,titleWrap:`${T}__title-wrap`,overlayScrim:`${S}__overlay-scrim`},E=(0,w.m)(y);class P extends v.oi{constructor(){super(...arguments),this.messages=(0,b.u)(),this.viewModel=E(this),this.activeBasemap=this.viewModel.activeBasemap,this.autoDestroyDisabled=!1,this.icon="layer-basemap",this.nextBasemap=this.viewModel.nextBasemap,this.position="top-left",this.showTitle=!1,this.state=this.viewModel.state,this.arcgisPropertyChange=(0,s.OR)()("activeBasemap","nextBasemap","state"),this.arcgisReady=(0,v.yM)()}static{this.properties={activeBasemap:0,autoDestroyDisabled:5,icon:1,label:1,messageOverrides:0,nextBasemap:1,position:3,referenceElement:1,showTitle:5,state:3}}static{this.shadowRootOptions=v.hZ}static{this.styles=x}async destroy(){await this.manager.destroy()}async toggle(){return await this.viewModel.toggle()}_getThumbnailStyles(e){const t=function(e){return(0,o.Qs)(e)}(e);return t?{backgroundImage:`url(${t})`}:{backgroundImage:""}}render(){const e=this.viewModel,t="disabled"===e.state?null:e.activeBasemap,i="disabled"===e.state?null:e.nextBasemap,r="loading"===e.state,s="incompatible-next-basemap"===e.state,o=i?.title??"",l=i&&"loaded"!==i.loadStatus;let c;const h=this.showTitle&&o,u=s,d=h||u,p=this._getThumbnailStyles(t),m=this._getThumbnailStyles(i);return d&&(c=n.dy`<div class=${(0,v.Vp)(M.overlay)}>${h?n.dy`<span class=${(0,v.Vp)((0,a.Sh)(M.title,M.titleWrap))} title=${o??v.Ld}>${o}</span>`:null}${u?n.dy`<calcite-scrim class=${(0,v.Vp)(M.overlayScrim)} title=${this.messages.incompatibleSpatialReference??v.Ld}><calcite-icon icon=exclamation-mark-triangle></calcite-icon></calcite-scrim>`:null}</div>`),n.dy`<div class=${(0,v.Vp)((0,a.Sh)(M.base,C.g.widget))}><calcite-button appearance=transparent data-basemap-id=${(i?i.id:"")??v.Ld} .disabled=${s} kind=neutral .label=${this.label??void 0} @click=${()=>{this.toggle()}} title=${this.label??void 0??v.Ld}><div class=${(0,v.Vp)((0,a.Sh)(M.container,M.secondaryBasemapImage))}><div class=${(0,v.Vp)(M.image)} style=${(0,v.kA)(p)}></div></div><div class=${(0,v.Vp)(M.container)}><div class=${(0,v.Vp)((0,a.Sh)(M.image,l?M.imageLoading:null))} style=${(0,v.kA)(m)}>${l||r?n.dy`<calcite-scrim><span aria-hidden=true class=${(0,v.Vp)(C.g.loaderAnimation)} role=presentation></span></calcite-scrim>`:null}</div>${c}</div></calcite-button></div>`}}(0,r.c)("arcgis-basemap-toggle",P)},26059:function(e,t,i){i(55001);var r=i(43625),n=i(81879),s=i(15294),a=i(23230),o=i(52642),l=i(58268),c=i(76299),h=i(49006);const u="scrim",d="content",p=72,m=480,f=h.iv`:host{position:absolute;inset:0;z-index:var(--calcite-z-index-overlay);display:flex;block-size:100%;inline-size:100%;flex-direction:column;align-items:stretch}@keyframes calcite-scrim-fade-in{0%{--tw-bg-opacity: 0 }to{--tw-text-opacity: 1 }}.scrim{position:absolute;inset:0;display:flex;flex-direction:column;align-content:center;align-items:center;justify-content:center;overflow:hidden;animation:calcite-scrim-fade-in var(--calcite-internal-animation-timing-medium) ease-in-out;background-color:var(--calcite-scrim-background, var(--calcite-color-transparent-scrim))}.content{padding:1rem}:host([hidden]){display:none}[hidden]{display:none}`;class _ extends a.oi{constructor(){super(...arguments),this.resizeObserver=(0,o.c)("resize",(()=>this.handleResize())),this.messages=(0,c.u)(),this.hasContent=!1,this.loading=!1}static{this.properties={hasContent:[16,{},{state:!0}],loaderScale:[16,{},{state:!0}],loading:[7,{},{reflect:!0,type:Boolean}],messageOverrides:[0,{},{attribute:!1}]}}static{this.styles=f}connectedCallback(){super.connectedCallback(),this.resizeObserver?.observe(this.el)}disconnectedCallback(){super.disconnectedCallback(),this.resizeObserver?.disconnect()}handleDefaultSlotChange(e){this.hasContent=(0,l.r)(e)}storeLoaderEl(e){this.loaderEl=e,this.handleResize()}getScale(e){return e<p?"s":e>=m?"l":"m"}handleResize(){const{loaderEl:e,el:t}=this;e&&(this.loaderScale=this.getScale(Math.min(t.clientHeight,t.clientWidth)??0))}render(){const{hasContent:e,loading:t,messages:i}=this;return s.dy`<div class=${(0,a.Vp)(u)}>${t?s.dy`<calcite-loader .label=${i.loading} .scale=${this.loaderScale} ${(0,n.i)(this.storeLoaderEl)}></calcite-loader>`:null}<div class=${(0,a.Vp)(d)} .hidden=${!e}><slot @slotchange=${this.handleDefaultSlotChange}></slot></div></div>`}}(0,r.c)("calcite-scrim",_)},70728:function(e,t,i){i.d(t,{Z:function(){return m}});var r=i(12744);function n(e,t){return function(){return t.call(this,e.apply(this,arguments))}}var s=i(56943),a=i(75940);function o(e,t){return function(){var i=arguments.length;if(0===i)return t();var r=arguments[i-1];return(0,a.Z)(r)||"function"!=typeof r[e]?t.apply(this,arguments):r[e].apply(r,Array.prototype.slice.call(arguments,0,i-1))}}var l=i(95598),c=(0,i(52859).Z)(o("slice",(function(e,t,i){return Array.prototype.slice.call(i,e,t)}))),h=(0,l.Z)(o("tail",c(1,1/0)));function u(){if(0===arguments.length)throw new Error("pipe requires at least one argument");return(0,r.Z)(arguments[0].length,(0,s.Z)(n,arguments[0],h(arguments)))}var d=i(55753),p=(0,l.Z)((function(e){return(0,d.Z)(e)?e.split("").reverse().join(""):Array.prototype.slice.call(e,0).reverse()}));function m(){if(0===arguments.length)throw new Error("compose requires at least one argument");return u.apply(this,p(arguments))}},12744:function(e,t,i){function r(e,t){switch(e){case 0:return function(){return t.apply(this,arguments)};case 1:return function(e){return t.apply(this,arguments)};case 2:return function(e,i){return t.apply(this,arguments)};case 3:return function(e,i,r){return t.apply(this,arguments)};case 4:return function(e,i,r,n){return t.apply(this,arguments)};case 5:return function(e,i,r,n,s){return t.apply(this,arguments)};case 6:return function(e,i,r,n,s,a){return t.apply(this,arguments)};case 7:return function(e,i,r,n,s,a,o){return t.apply(this,arguments)};case 8:return function(e,i,r,n,s,a,o,l){return t.apply(this,arguments)};case 9:return function(e,i,r,n,s,a,o,l,c){return t.apply(this,arguments)};case 10:return function(e,i,r,n,s,a,o,l,c,h){return t.apply(this,arguments)};default:throw new Error("First argument to _arity must be a non-negative integer no greater than ten")}}i.d(t,{Z:function(){return r}})},71082:function(e,t,i){function r(e,t){for(var i=0,r=t.length,n=Array(r);i<r;)n[i]=e(t[i]),i+=1;return n}i.d(t,{Z:function(){return r}})},11285:function(e,t,i){i.d(t,{Z:function(){return g}});var r=i(18362),n=i(5393),s=i(39556),a=i(71082),o=i(44969),l=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=o.Z.init,e.prototype["@@transducer/result"]=o.Z.result,e.prototype["@@transducer/step"]=function(e,t){return this.xf["@@transducer/step"](e,this.f(t))},e}(),c=function(e){return function(t){return new l(e,t)}},h=i(12744),u=i(95598),d=i(13415);function p(e,t,i){return function(){for(var r=[],n=0,s=e,a=0,o=!1;a<t.length||n<arguments.length;){var l;a<t.length&&(!(0,d.Z)(t[a])||n>=arguments.length)?l=t[a]:(l=arguments[n],n+=1),r[a]=l,(0,d.Z)(l)?o=!0:s-=1,a+=1}return!o&&s<=0?i.apply(this,r):(0,h.Z)(Math.max(0,s),p(e,r,i))}}var m=(0,n.Z)((function(e,t){return 1===e?(0,u.Z)(t):(0,h.Z)(e,p(e,[],t))})),f=i(33598),_=(0,n.Z)((0,s.Z)(["fantasy-land/map","map"],c,(function(e,t){switch(Object.prototype.toString.call(t)){case"[object Function]":return m(t.length,(function(){return e.call(this,t.apply(this,arguments))}));case"[object Object]":return(0,r.Z)((function(i,r){return i[r]=e(t[r]),i}),{},(0,f.Z)(t));default:return(0,a.Z)(e,t)}}))),g=_},56943:function(e,t,i){i.d(t,{Z:function(){return y}});var r=i(52859),n=i(95598),s=i(75940),a=i(55753),o=(0,n.Z)((function(e){return!!(0,s.Z)(e)||!!e&&("object"==typeof e&&(!(0,a.Z)(e)&&(0===e.length||e.length>0&&(e.hasOwnProperty(0)&&e.hasOwnProperty(e.length-1)))))})),l="undefined"!=typeof Symbol?Symbol.iterator:"@@iterator";function c(e,t,i){return function(r,n,s){if(o(s))return e(r,n,s);if(null==s)return n;if("function"==typeof s["fantasy-land/reduce"])return t(r,n,s,"fantasy-land/reduce");if(null!=s[l])return i(r,n,s[l]());if("function"==typeof s.next)return i(r,n,s);if("function"==typeof s.reduce)return t(r,n,s,"reduce");throw new TypeError("reduce: list must be array or iterable")}}function h(e,t,i){for(var r=0,n=i.length;r<n;){if((t=e["@@transducer/step"](t,i[r]))&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}r+=1}return e["@@transducer/result"](t)}var u=i(12744),d=(0,i(5393).Z)((function(e,t){return(0,u.Z)(e.length,(function(){return e.apply(t,arguments)}))})),p=d;function m(e,t,i){for(var r=i.next();!r.done;){if((t=e["@@transducer/step"](t,r.value))&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}r=i.next()}return e["@@transducer/result"](t)}function f(e,t,i,r){return e["@@transducer/result"](i[r](p(e["@@transducer/step"],e),t))}var _=c(h,f,m),g=function(){function e(e){this.f=e}return e.prototype["@@transducer/init"]=function(){throw new Error("init not implemented on XWrap")},e.prototype["@@transducer/result"]=function(e){return e},e.prototype["@@transducer/step"]=function(e,t){return this.f(e,t)},e}();var y=(0,r.Z)((function(e,t,i){return _("function"==typeof e?new g(e):e,t,i)}))},8131:function(e,t,i){var r=i(95598),n=i(33598),s=(0,r.Z)((function(e){for(var t=(0,n.Z)(e),i=t.length,r=[],s=0;s<i;)r[s]=e[t[s]],s+=1;return r}));t.Z=s}}]);