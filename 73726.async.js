"use strict";(self.webpackChunkscene_pro=self.webpackChunkscene_pro||[]).push([[73726],{49052:function(e,t,i){i.d(t,{Z:function(){return g}});var n=i(73440),r=i(37877),o=i(70880),s=i(89314),a=i(63255),l=i(61100),u=i(17155),c=(i(61432),i(96711),i(83850),i(48023)),d=i(75432),p=i(60508),h=i(13689);let v=class extends(a.Z.JSONSupportMixin(s.Z.ClonableMixin(o.Z))){constructor(e){super(e),this.position=null,this.elevationInfo=null,this.feature=null}equals(e){return(0,l._W)(this.position,e.position)&&(0,l._W)(this.elevationInfo,e.elevationInfo)&&(0,r.kk)(this.feature,e.feature)}};(0,n._)([(0,u.Cb)({type:p.Z,json:{write:{isRequired:!0}}})],v.prototype,"position",void 0),(0,n._)([(0,u.Cb)({type:h.Z}),(0,d.B)()],v.prototype,"elevationInfo",void 0),(0,n._)([(0,u.Cb)(r.rX)],v.prototype,"feature",void 0),v=(0,n._)([(0,c.j)("esri.analysis.LineOfSightAnalysisObserver")],v);const g=v},99965:function(e,t,i){i.d(t,{Z:function(){return h}});var n=i(73440),r=i(37877),o=i(89314),s=i(63255),a=i(61100),l=i(17155),u=(i(61432),i(96711),i(83850),i(48023)),c=i(75432),d=i(60508),p=i(13689);let h=class extends(s.Z.JSONSupportMixin(o.Z)){constructor(e){super(e),this.position=null,this.elevationInfo=null,this.feature=null}equals(e){return(0,a._W)(this.position,e.position)&&(0,a._W)(this.elevationInfo,e.elevationInfo)&&(0,r.kk)(this.feature,e.feature)}};(0,n._)([(0,l.Cb)({type:d.Z,json:{write:!0,origins:{"web-scene":{write:{isRequired:!0}}}}}),(0,c.B)()],h.prototype,"position",void 0),(0,n._)([(0,l.Cb)({type:p.Z}),(0,c.B)()],h.prototype,"elevationInfo",void 0),(0,n._)([(0,l.Cb)(r.rX)],h.prototype,"feature",void 0),h=(0,n._)([(0,u.j)("esri.analysis.LineOfSightAnalysisTarget")],h)},37877:function(e,t,i){i.d(t,{NS:function(){return d},kk:function(){return l},pD:function(){return u},rX:function(){return c}});var n=i(24910),r=i(82846),o=i(12659),s=i(61442),a=i(90189);function l(e,t){return u(e)===u(t)}function u(e){if(null==e)return null;const t=null!=e.layer?e.layer.id:"";let i=null;return i=null!=e.objectId?e.objectId:null!=e.layer&&"objectIdField"in e.layer&&null!=e.layer.objectIdField&&null!=e.attributes?e.attributes[e.layer.objectIdField]:e.uid,null==i?null:`o-${t}-${i}`}const c={json:{write:{writer:function(e,t){null!=e?.layer?.objectIdField&&null!=e.attributes&&(t.feature={layerId:e.layer.id,objectId:e.attributes[e.layer.objectIdField]})},target:{"feature.layerId":{type:[Number,String],isRequired:!0},"feature.objectId":{type:[Number,String],isRequired:!0}}},origins:{"web-scene":{read:function(e){if(null!=e.layerId&&null!=e.objectId)return{uid:null,layer:{id:e.layerId,objectIdField:"ObjectId"},attributes:{ObjectId:e.objectId}}}}}}};function d(e,t,i,l){const{sceneIntersectionHelper:c}=e,{observer:d,observerFeatureId:h,targetFeatureId:_,target:f}=i;if(null==h&&null==_)return;l||(l=e=>e),(0,n.a)(g,d,f);const b=(0,n.l)(g);(0,n.b)(g,d,g,1/b);const y=(0,o.zk)(g,f,v);t.options.store=s.e.ALL,c.intersectToolIntersectorRay(y,t);let m=null,C=null,w=null,I=null;for(const i of t.results.all){const t=(0,a.tB)(i,e);if(null==t||null==i.distanceInRenderSpace)continue;const n=u(t);null!=n&&(null!=h&&n===h&&(m??=l(p(i,e,b)),i.distanceInRenderSpace-1<m&&(w=i)),null!=_&&n===_&&(C??=l(p(i,e,b)),null==I&&i.distanceInRenderSpace-1<b&&b-i.distanceInRenderSpace+1<C&&(I=i)))}const{observerAdjusted:O,targetAdjusted:T}=i;w?.getIntersectionPoint(O)?i.observerSurfaceNormal=w.getTransformedNormal((0,r.Ue)()):i.observerSurfaceNormal=null,I?.getIntersectionPoint(T)?i.targetSurfaceNormal=I.getTransformedNormal((0,r.Ue)()):i.targetSurfaceNormal=null}function p(e,t,i){if((0,a._s)(e)){const n=(0,a.VB)(e,t);if(null!=n)return Math.min(n*h,i)}return 1e-5*i}const h=.05,v=(0,o.Ue)(),g=(0,r.Ue)()},13689:function(e,t,i){i.d(t,{Z:function(){return y}});var n,r=i(73440),o=i(41773),s=i(63255),a=i(61100),l=i(17155),u=(i(61432),i(96711),i(83850),i(1194)),c=i(48023),d=i(29884),p=i(76554);let h=n=class extends s.Z{constructor(e){super(e)}async collectRequiredFields(e,t){return(0,p.io)(e,t,this.expression)}clone(){return new n({expression:this.expression,title:this.title})}equals(e){return this.expression===e.expression&&this.title===e.title}};(0,r._)([(0,l.Cb)({type:String,json:{write:{isRequired:!0}}})],h.prototype,"expression",void 0),(0,r._)([(0,l.Cb)({type:String,json:{write:!0}})],h.prototype,"title",void 0),h=n=(0,r._)([(0,c.j)("esri.symbols.support.FeatureExpressionInfo")],h);const v=h;var g,_=i(46368);const f=(0,o.w)()({onTheGround:"on-the-ground",relativeToGround:"relative-to-ground",relativeToScene:"relative-to-scene",absoluteHeight:"absolute-height"}),b=new o.X({foot:"feet",kilometer:"kilometers",meter:"meters",mile:"miles","us-foot":"us-feet",yard:"yards"});let y=class extends s.Z{static{g=this}constructor(e){super(e),this.featureExpressionInfo=void 0,this.offset=null}readFeatureExpressionInfo(e,t){return null!=e?e.expression?e:void 0:t.featureExpression&&0===t.featureExpression.value?{expression:"0"}:void 0}writeFeatureExpressionInfo(e,t,i,n){t[i]=e.write({},n),"0"===e.expression&&(t.featureExpression={value:0})}get mode(){const{offset:e,featureExpressionInfo:t}=this;return this._isOverridden("mode")?this._get("mode"):null!=e||t?"relative-to-ground":"on-the-ground"}set mode(e){this._override("mode",e)}set unit(e){this._set("unit",e)}write(e,t){return this.offset||this.mode||this.featureExpressionInfo||this.unit?super.write(e,t):null}clone(){return new g({mode:this.mode,offset:this.offset,featureExpressionInfo:this.featureExpressionInfo?this.featureExpressionInfo.clone():void 0,unit:this.unit})}equals(e){return this.mode===e.mode&&this.offset===e.offset&&this.unit===e.unit&&(0,a._W)(this.featureExpressionInfo,e.featureExpressionInfo)}};(0,r._)([(0,l.Cb)({type:v,json:{write:!0}})],y.prototype,"featureExpressionInfo",void 0),(0,r._)([(0,u.r)("featureExpressionInfo",["featureExpressionInfo","featureExpression"])],y.prototype,"readFeatureExpressionInfo",null),(0,r._)([(0,d.c)("featureExpressionInfo",{featureExpressionInfo:{type:v},"featureExpression.value":{type:[0]}})],y.prototype,"writeFeatureExpressionInfo",null),(0,r._)([(0,l.Cb)({type:f.apiValues,nonNullable:!0,json:{type:f.jsonValues,read:f.read,write:{writer:f.write,isRequired:!0}}})],y.prototype,"mode",null),(0,r._)([(0,l.Cb)({type:Number,json:{write:!0}})],y.prototype,"offset",void 0),(0,r._)([(0,l.Cb)({type:_.f9,json:{type:String,read:b.read,write:b.write}})],y.prototype,"unit",null),y=g=(0,r._)([(0,c.j)("esri.symbols.support.ElevationInfo")],y)},11674:function(e,t,i){i.d(t,{p:function(){return l}});var n=i(73440),r=i(50702),o=i(76329),s=i(17155),a=(i(61432),i(96711),i(83850),i(48023));const l=e=>{let t=class extends(o.Z.EsriPromiseMixin(e)){constructor(){super(...arguments),this.parent=null,this._userInteractive=!1,this._interactiveViewModelCount=0}get interactive(){return this._interactiveViewModelCount>0||this._userInteractive}set interactive(e){this._userInteractive=e}get updating(){return!1}get visible(){return null==this.parent||this.parent.visible&&!this.parent.suspended}set visible(e){this._overrideIfSome("visible",e)}forceInteractive(){return this._interactiveViewModelCount++,(0,r.kB)((()=>this._interactiveViewModelCount--))}};return(0,n._)([(0,s.Cb)({constructOnly:!0})],t.prototype,"parent",void 0),(0,n._)([(0,s.Cb)({constructOnly:!0})],t.prototype,"view",void 0),(0,n._)([(0,s.Cb)({type:Boolean})],t.prototype,"interactive",null),(0,n._)([(0,s.Cb)()],t.prototype,"_userInteractive",void 0),(0,n._)([(0,s.Cb)({readOnly:!0})],t.prototype,"updating",null),(0,n._)([(0,s.Cb)()],t.prototype,"visible",null),(0,n._)([(0,s.Cb)()],t.prototype,"_interactiveViewModelCount",void 0),t=(0,n._)([(0,a.j)("esri.views.3d.analysis.AnalysisView3D")],t),t}},34794:function(e,t,i){i.r(t),i.d(t,{default:function(){return Ge}});var n=i(73440),r=i(70880),o=i(43254),s=i(87833),a=(i(61432),i(61100)),l=i(17155),u=i(96711),c=(i(83850),i(48023)),d=i(82846),p=i(11674),h=i(37877),v=i(29292),g=i(12818),_=i(50702),f=i(93568),b=i(90403),y=i(24910),m=i(60147),C=i(60508),w=i(13132),I=i(774),O=i(16447),T=i(47566),S=i(12659),L=i(51870);let P=class extends r.Z{constructor(e){super(e),this.target=null,this.intersectedGraphic=null,this.intersectedLocation=null,this.elevationAlignedTargetLocation=null,this.visible=void 0}};(0,n._)([(0,l.Cb)()],P.prototype,"target",void 0),(0,n._)([(0,l.Cb)()],P.prototype,"intersectedGraphic",void 0),(0,n._)([(0,l.Cb)()],P.prototype,"intersectedLocation",void 0),(0,n._)([(0,l.Cb)()],P.prototype,"elevationAlignedTargetLocation",void 0),(0,n._)([(0,l.Cb)({type:Boolean})],P.prototype,"visible",void 0),P=(0,n._)([(0,c.j)("esri.views.3d.analysis.LineOfSightAnalysisResult")],P);let E=class extends r.Z{constructor(e){super(e),this.elevationAlignedTargetLocation=null,this.inputPoints={isValid:!1,observer:(0,d.Ue)(),observerSurfaceNormal:null,observerFeatureId:null,target:(0,d.Ue)(),targetSurfaceNormal:null,targetFeatureId:null,observerAdjusted:(0,d.Ue)(),targetAdjusted:(0,d.Ue)()},this.computationResult={start:(0,d.Ue)(),end:(0,d.Ue)(),intersection:(0,d.Ue)(),isValid:!1,isTargetVisible:!1},this.result=null}notifyResultChanged(){this.notifyChange("computationResult")}notifyInputPointsChanged(){this.notifyChange("inputPoints")}};(0,n._)([(0,l.Cb)()],E.prototype,"target",void 0),(0,n._)([(0,l.Cb)()],E.prototype,"elevationAlignedTargetLocation",void 0),(0,n._)([(0,l.Cb)()],E.prototype,"inputPoints",void 0),(0,n._)([(0,l.Cb)()],E.prototype,"computationResult",void 0),(0,n._)([(0,l.Cb)()],E.prototype,"result",void 0),E=(0,n._)([(0,c.j)("esri.views.3d.analysis.LineOfSight.LineOfSightComputation")],E);var R,V=i(96094),x=i(69811),A=i(49211),M=i(3480),H=i(28947);let D=R=class extends r.Z{constructor(e){super(e)}clone(){return new R({type:this.type,id:(0,H.d9)(this.id),mapPoint:(0,H.d9)(this.mapPoint),renderPoint:(0,d.d9)(this.renderPoint),normal:(0,H.d9)(this.normal),ray:(0,H.d9)(this.ray),graphic:this.graphic})}equals(e){return this.type===e.type&&this.id===e.id&&(0,a._W)(this.mapPoint,e.mapPoint)&&(0,y.G)(this.renderPoint,e.renderPoint)&&(0,M.fS)(this.normal,e.normal)&&(0,S.fS)(this.ray,e.ray)&&this.graphic===e.graphic}};(0,n._)([(0,l.Cb)()],D.prototype,"type",void 0),(0,n._)([(0,l.Cb)({constructOnly:!0})],D.prototype,"id",void 0),(0,n._)([(0,l.Cb)({constructOnly:!0})],D.prototype,"mapPoint",void 0),(0,n._)([(0,l.Cb)({constructOnly:!0})],D.prototype,"renderPoint",void 0),(0,n._)([(0,l.Cb)({constructOnly:!0})],D.prototype,"normal",void 0),(0,n._)([(0,l.Cb)({constructOnly:!0})],D.prototype,"graphic",void 0),(0,n._)([(0,l.Cb)({constructOnly:!0})],D.prototype,"ray",void 0),D=R=(0,n._)([(0,c.j)("esri.views.3d.analysis.LineOfSight.LineOfSightIntersectionResult")],D);var k=i(13445),j=i(38142),Z=i(92490),z=i(61442),F=i(19821),U=i(90189);let G=class extends r.Z{constructor(e){super(e),this._terrainIntersectionOptionsLayerUids=new Set(["terrain"])}initialize(){this.intersector=new Z.r(this.view.state.viewingMode),this.intersector.options.hud=!1,this.intersector.options.store=z.e.MIN}getScreenPointIntersection(e){const t=(0,V.md)(e,x.qW.get()),i=(0,k.u4)(this.view.state.camera,t,X);return this._getRayIntersection(i)}_getRayIntersection(e,t){const{view:i,intersector:n}=this;if(null==e||null==i.sceneIntersectionHelper)return null;n.options.store=z.e.MIN,i.sceneIntersectionHelper.intersectToolIntersectorRay(e,n,t);const r=n.results.min;if(null==r.target)return null;const o=(0,d.Ue)();if(!r.getIntersectionPoint(o))return null;if(null!=t?.maxDistance&&!r.withinDistance(t.maxDistance))return null;const s=i.renderCoordsHelper.fromRenderCoords(o,new C.Z({spatialReference:i.spatialReference})),a=(0,d.d9)(r.normal);if((0,j.TX)(r))return new D({type:F.q.TERRAIN,id:r.target.lij.slice(),mapPoint:s,renderPoint:o,normal:a,ray:(0,S.JG)(e),graphic:null});const l=(0,U.tB)(r,i);if(null==l)return null;const{layer:u,sourceLayer:c}=l,p="scene"===c?.type?(0,A.MS)(l,c.objectIdField):l.uid;return new D({type:F.q.OBJECT,id:`${u?.uid}/${p}`,mapPoint:s,renderPoint:o,normal:a,ray:(0,S.JG)(e),graphic:l})}updateFromGroundIntersection(e,t,i){const n=N,r=B,o=q,s=W;(0,y.c)(r,e),this.view.renderCoordsHelper.worldUpAtPosition(r,o),(0,y.n)(o,o);const a=this.view.basemapTerrain.visibleElevationBounds,l=(t>=0?1:-1)*((a?Math.abs(a.max-a.min):100)+Math.abs(t));(0,y.g)(s,o,l),(0,y.f)(n,r,s),(0,S.zk)(n,r,X);const u=this._getRayIntersection(X,{include:this._terrainIntersectionOptionsLayerUids,maxDistance:l});if(null!=u){const e=W;return(0,y.g)(e,o,t),(0,y.f)(i,u.renderPoint,e),(0,d.d9)(u.normal)}return(0,y.c)(i,e),null}};(0,n._)([(0,l.Cb)()],G.prototype,"view",void 0),(0,n._)([(0,l.Cb)()],G.prototype,"intersector",void 0),G=(0,n._)([(0,c.j)("esri.views.3d.analysis.LineOfSight.LineOfSightRayIntersector")],G);const N=(0,d.Ue)(),B=(0,d.Ue)(),q=(0,d.Ue)(),W=(0,d.Ue)(),X=(0,S.Ue)();var $=i(1505),Y=i(50399);let J=class extends(s.Z.EventedMixin(r.Z)){constructor(e){super(e),this.updateOnCameraChange=!0,this._observerGroundOffsetRenderSpace=0,this._effectiveObserverElevationMode="absolute-height",this._observerFeatureId=null,this._updatingHandles=new m.R,this._frameTask=Y.sq,this._computationHandles=new g.Z,this._externalObserverUpdate=!0}initialize(){const e=this.view.resourceController?.scheduler;this._frameTask=e?e.registerTask(Y.T8.LINE_OF_SIGHT_TOOL):Y.sq,this._intersector=new G({view:this.view}),this.addHandles([this._connectObserver(),this._connectComputations(),this._connectTargets()])}destroy(){this._computationHandles.destroy(),this._computations.removeAll(),this._updatingHandles.destroy()}get updating(){return this._frameTask.updating||this._updatingHandles.updating}get priority(){return this._frameTask.priority}set priority(e){this._frameTask.priority=e}get _computations(){return this.analysisViewData.computations}get _elevationAlignedObserverPositionRenderSpace(){return this.analysisViewData.observerEngineLocation}set _elevationAlignedObserverPositionRenderSpace(e){this.analysisViewData.observerEngineLocation=e}get _screenPixelSize(){return this.view.state.camera.computeScreenPixelSizeAt(this._elevationAlignedObserverPositionRenderSpace)}_computeResult(e){const t=e.computation,{inputPoints:i,computationResult:n}=t,{observerAdjusted:r,targetAdjusted:o}=i,{start:s,end:a}=n;(0,y.c)(s,r),(0,y.c)(a,o),this._canCompute(t)?this._computeIntersection(e):function({computation:e,interpolationInfo:t}){const{computationResult:i,inputPoints:n}=e,{start:r,end:o,intersection:s}=i,{originalIntersection:a,originalObserver:l,originalTarget:u}=t;if((0,y.c)(s,a),n.isValid){const e=ee,t=(0,y.F)(l,a)/(0,y.F)(l,u);(0,y.a)(e,r,l),(0,y.g)(e,e,1-t),(0,y.f)(s,s,e),(0,y.a)(e,o,u),(0,y.g)(e,e,t),(0,y.f)(s,s,e),i.isValid=!0}else e.result=null,i.isValid=!1,i.isTargetVisible=!1}(e),t.notifyResultChanged(),this.emit("result-changed",{target:e.computation.target,result:t.result})}_adjustStartEndPositions(e){const{view:t}=this,{inputPoints:i}=e,{observer:n,target:r,observerAdjusted:o,targetAdjusted:s}=i;(0,y.c)(o,n),(0,y.c)(s,r),(0,h.NS)(t,this._intersector.intersector,i);const{observerSurfaceNormal:a,targetSurfaceNormal:l}=i,u=this._screenPixelSize,c=ee;null!=a?(0,y.c)(c,a):(0,y.d)(c,s,o);const d=u;(0,y.n)(c,c),(0,y.g)(c,c,Math.min(d,1)),(0,y.f)(o,o,c),null!=l?(0,y.c)(c,l):(0,y.d)(c,o,s);const p=t.state.camera.computeScreenPixelSizeAt(s);(0,y.n)(c,c),(0,y.g)(c,c,Math.min(p,1)),(0,y.f)(s,s,c)}_computeIntersection({computation:e,interpolationInfo:t}){const{view:i}=this,{sceneIntersectionHelper:n,renderCoordsHelper:r}=i;if(null==n)return;const o=this._intersector.intersector,{computationResult:s,inputPoints:a}=e,{observer:l,target:u}=a,{start:c,end:d}=s,p=(0,S.zk)(c,d,te);o.options.store=z.e.MIN,n.intersectToolIntersectorRay(p,o);const h=o.results.min,v=s.intersection,g=ee;let _=!0;if(null!=h&&h.getIntersectionPoint(v)){(0,y.c)(t.originalIntersection,v),(0,y.c)(t.originalObserver,c),(0,y.c)(t.originalTarget,d),r.fromRenderCoords(v,g,i.spatialReference);const e=1-(0,y.F)(d,u)/(0,y.F)(c,u);_=(0,y.F)(l,v)>=e*(0,y.F)(l,u)}const f=new C.Z(g,i.spatialReference);{const{result:t,target:n}=e;null!=t?(t.target=n,t.intersectedGraphic=_?null:(0,U.tB)(h,i),t.intersectedLocation=_?null:f,t.visible=_):e.result=new P({target:n,elevationAlignedTargetLocation:e.elevationAlignedTargetLocation,intersectedGraphic:_?null:(0,U.tB)(h,i),intersectedLocation:_?null:f,visible:_})}s.isValid=a.isValid=!0,s.isTargetVisible=_}_canCompute(e){const t=this.analysisViewData.elevationAlignedObserver,i=this.view.frustum;if(null==t||null==e.elevationAlignedTargetLocation||null==i)return!1;const{observerAdjusted:n,targetAdjusted:r}=e.inputPoints,o=i.intersectsPoint(n),s=i.intersectsPoint(r);return o&&s}_onObserverPositionChange(e,t,i,n,r){if(this._externalObserverUpdate=r,null==e)return this.analysisViewData.elevationAlignedObserver=null,void(this._observerFeatureId=null);if(null==t)return(0,$.e)(this.analysis,e.spatialReference,u.Z.getLogger(this)),void(this.analysisViewData.elevationAlignedObserver=null);const o=Q(t,i),{absoluteZ:s,elevation:a}=(0,L.tq)(t.x,t.y,t.z,this.view.spatialReference,this.view,o),l=t.clone();l.z=s,this._effectiveObserverElevationMode=o.mode,this.analysisViewData.elevationAlignedObserver=l;const c=(0,d.Ue)();this.view.renderCoordsHelper.toRenderCoords(l,c),this._elevationAlignedObserverPositionRenderSpace=c,this._observerGroundOffsetRenderSpace=s-a,this._observerFeatureId=(0,h.pD)(n),this.priority=Y.T8.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onObserverRenderSpacePositionChangeForComputation(e,t,i,n,r){const{inputPoints:o}=e;switch((0,y.c)(o.observer,t),o.observerFeatureId=r,o.observerSurfaceNormal=null,n){case"on-the-ground":case"relative-to-ground":{const e=this._intersector.updateFromGroundIntersection(o.observer,i,o.observer);null==o.observerFeatureId&&(o.observerSurfaceNormal=e)}}this._adjustStartEndPositions(e),e.notifyInputPointsChanged(),this.priority=Y.T8.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onTargetPositionChange(e,t,i,n,r,o=!0){const s=e.inputPoints;if(o&&(s.isValid=!1),null==i)return null!=t&&(0,$.e)(this.analysis,t.spatialReference,u.Z.getLogger(this)),e.elevationAlignedTargetLocation=null,void e.notifyInputPointsChanged();const a=Q(i,n),{absoluteZ:l,elevation:c}=(0,L.tq)(i.x,i.y,i.z,this.view.spatialReference,this.view,a),d=i.clone();switch(d.z=l,e.elevationAlignedTargetLocation=d,this.view.renderCoordsHelper.toRenderCoords(e.elevationAlignedTargetLocation,s.target),s.targetFeatureId=(0,h.pD)(r),s.targetSurfaceNormal=null,a.mode){case"on-the-ground":case"relative-to-ground":{const e=this._intersector.updateFromGroundIntersection(s.target,l-c,s.target);null==s.targetFeatureId&&(s.targetSurfaceNormal=e)}}this._adjustStartEndPositions(e),e.notifyInputPointsChanged(),this.priority=Y.T8.LINE_OF_SIGHT_TOOL_INTERACTIVE}_connectComputationToTarget(e){return(0,_.AL)([this._updatingHandles.add((()=>({computation:e,targetPosition:e.target.position,targetElevationInfo:e.target.elevationInfo,targetFeatureInfo:e.target.feature,projectedTargetPosition:(0,w.projectOrLoad)(e.target.position,this.view.spatialReference)})),(({computation:e,targetPosition:t,targetElevationInfo:i,targetFeatureInfo:n,projectedTargetPosition:r})=>{null==r.pending?this._onTargetPositionChange(e,t,r.geometry,i,n):this._updatingHandles.addPromise(r.pending)}),b.nn)])}_connectComputationToObserver(e){return this._updatingHandles.add((()=>({computation:e,observer:this.analysisViewData.elevationAlignedObserver})),(({computation:e})=>{this._externalObserverUpdate&&(e.inputPoints.isValid=!1,e.notifyInputPointsChanged())}),b.nn)}_connectComputationToRenderSpaceObserver(e){return this._updatingHandles.add((()=>({computation:e,observer:this._elevationAlignedObserverPositionRenderSpace,observerGroundOffset:this._observerGroundOffsetRenderSpace,observerElevationMode:this._effectiveObserverElevationMode,observerFeatureId:this._observerFeatureId})),(({computation:e,observer:t,observerGroundOffset:i,observerElevationMode:n,observerFeatureId:r})=>{this._onObserverRenderSpacePositionChangeForComputation(e,t,i,n,r)}),b.nn)}_connectComputationToCamera(e){return this._updatingHandles.add((()=>({camera:this.view.state.camera,isDirty:this._isCameraDirty})),(({isDirty:t})=>{!this.updateOnCameraChange||e.inputPoints.isValid&&!t||e.notifyInputPointsChanged()}))}_connectComputationToSlicePlane(e){return this._updatingHandles.add((()=>this.view.slice.plane),(()=>{e.inputPoints.isValid=!1,e.notifyInputPointsChanged()}))}_connectComputationToElevation(e){const t=(i,n)=>{const r=this.analysis.observer,o=e.target;let s=null,a=null,l=null,u=null,c=null,d=null;if(null!=r?.position){const e=(0,w.projectOrLoad)(r.position,this.view.spatialReference);if(null!=e.pending)return this._updatingHandles.addPromise(e.pending),void e.pending.finally((()=>t(i,n)));s=e.geometry,a=r.elevationInfo,l=r.feature}if(null!=o.position){const e=(0,w.projectOrLoad)(o.position,this.view.spatialReference);if(null!=e.pending)return this._updatingHandles.addPromise(e.pending),void e.pending.finally((()=>t(i,n)));u=e.geometry,c=o.elevationInfo,d=o.feature}null==s&&null==u||((0,I.d)(i,n,ie,this.view.spatialReference),null!=s&&(0,T.Qn)(ie,s)&&this._onObserverPositionChange(null!=r?r.position:null,s,a,l,!1),null!=u&&(0,T.Qn)(ie,u)&&this._onTargetPositionChange(e,o.position,u,c,d,!1),null!=s&&null!=u&&(0,T.I7)(ie,s,u)&&e.notifyInputPointsChanged())};return this.view.elevationProvider.on("elevation-change",(({extent:e,spatialReference:i})=>t(e,i)))}_connectComputationToTask(e){let t=null;const i={computation:e,interpolationInfo:{originalIntersection:(0,d.Ue)(),originalObserver:(0,d.Ue)(),originalTarget:(0,d.Ue)()}};return(0,_.AL)([this._updatingHandles.add((()=>e.inputPoints),(()=>{t=(0,a.IM)(t),t=(0,v.vr)((async e=>{await(0,f.R8)(this._frameTask.schedule((()=>this._computeResult(i)),e))}))}),{initial:!0,equals:()=>!1}),(0,_.kB)((()=>t=(0,a.IM)(t)))])}_connectComputationToContent(e){return(0,b.on)((()=>this.view.pointsOfInterest?.contentGeometryUpdates.events),"request-update",(t=>{const i=t?.renderBounds,{observerAdjusted:n,targetAdjusted:r}=e.inputPoints;(null==i||(0,O.I7)(i,n,r))&&(e.inputPoints.isValid=!1,e.notifyInputPointsChanged())}))}_connectComputation(e){const t=this._computationHandles;t.has(e)||t.add([this._connectComputationToTarget(e),this._connectComputationToObserver(e),this._connectComputationToRenderSpaceObserver(e),this._connectComputationToCamera(e),this._connectComputationToSlicePlane(e),this._connectComputationToElevation(e),this._connectComputationToTask(e),this._connectComputationToContent(e)],e)}_disconnectComputation(e){this._computationHandles.remove(e)}_onComputationCollectionChange({added:e,removed:t}){for(const e of t)this._disconnectComputation(e);for(const t of e)this._connectComputation(t)}_onTargetCollectionChange({added:e,removed:t}){for(const e of t)this._removeTarget(e);for(const t of e)this._addTarget(t)}_onCursorTargetChange(e,t){null!=t&&this._removeTarget(t),null!=e&&this._addTarget(e)}_addTarget(e){this._computations.some((t=>t.target===e))||this._computations.add(new E({target:e}))}_removeTarget(e){const t=this._computations.findIndex((t=>t.target===e));this._computations.removeAt(t)}_connectObserver(){return(0,_.AL)([this._updatingHandles.add((()=>({observerPosition:null!=this.analysis.observer?this.analysis.observer.position:null,projectedObserverPosition:(0,w.projectOrLoad)(null!=this.analysis.observer?this.analysis.observer.position:null,this.view.spatialReference),observerElevationInfo:null!=this.analysis.observer?this.analysis.observer.elevationInfo:null,observerFeatureInfo:null!=this.analysis.observer?this.analysis.observer.feature:null})),(({observerPosition:e,projectedObserverPosition:t,observerElevationInfo:i,observerFeatureInfo:n})=>{null==t.pending?this._onObserverPositionChange(e,t.geometry,i,n,!0):this._updatingHandles.addPromise(t.pending)}),b.nn)])}_connectComputations(){return this._updatingHandles.addOnCollectionChange((()=>this._computations),(e=>this._onComputationCollectionChange(e)),{initial:!0,final:!0})}_connectTargets(){return(0,_.AL)([this._updatingHandles.addOnCollectionChange((()=>this.analysis.targets),(e=>this._onTargetCollectionChange(e)),{initial:!0,final:!0}),this._updatingHandles.add((()=>this.analysisViewData.cursorTarget),((e,t)=>{this._onCursorTargetChange(e,t)}))])}get _isCameraDirty(){const e=this.analysisViewData.elevationAlignedObserver,{view:t}=this,{renderCoordsHelper:i}=t;if(null==e||null==i)return!1;const n=ee;i.toRenderCoords(e,n);const r=t.state.camera.computeScreenPixelSizeAt(n);return Math.abs((r-this._screenPixelSize)/this._screenPixelSize)>K}};function Q(e,t){return e.hasZ?t??{mode:"absolute-height",offset:0}:{mode:"on-the-ground",offset:0}}(0,n._)([(0,l.Cb)({constructOnly:!0})],J.prototype,"analysis",void 0),(0,n._)([(0,l.Cb)({constructOnly:!0})],J.prototype,"analysisViewData",void 0),(0,n._)([(0,l.Cb)({constructOnly:!0})],J.prototype,"view",void 0),(0,n._)([(0,l.Cb)()],J.prototype,"updating",null),(0,n._)([(0,l.Cb)()],J.prototype,"priority",null),(0,n._)([(0,l.Cb)()],J.prototype,"updateOnCameraChange",void 0),(0,n._)([(0,l.Cb)()],J.prototype,"_computations",null),(0,n._)([(0,l.Cb)()],J.prototype,"_elevationAlignedObserverPositionRenderSpace",null),(0,n._)([(0,l.Cb)()],J.prototype,"_observerGroundOffsetRenderSpace",void 0),(0,n._)([(0,l.Cb)()],J.prototype,"_effectiveObserverElevationMode",void 0),(0,n._)([(0,l.Cb)()],J.prototype,"_observerFeatureId",void 0),(0,n._)([(0,l.Cb)()],J.prototype,"_screenPixelSize",null),(0,n._)([(0,l.Cb)({readOnly:!0})],J.prototype,"_updatingHandles",void 0),(0,n._)([(0,l.Cb)()],J.prototype,"_frameTask",void 0),(0,n._)([(0,l.Cb)()],J.prototype,"_isCameraDirty",null),J=(0,n._)([(0,c.j)("esri.views.3d.analysis.LineOfSight.LineOfSightController")],J);const K=.1,ee=(0,d.Ue)(),te=(0,S.Ue)(),ie=(0,T.cS)();var ne=i(53147),re=i(49052),oe=i(99965),se=i(88970),ae=i(13689),le=i(92643);const ue=new class{constructor(){this.glowWidth=8,this.innerWidth=.75}};const ce=new class{constructor(){this.size=.5}};function de(e){return(0,le.Ch)(e.accentColor,.75)}const pe=new class{constructor(){this.size=.5,this.visibleColor=new ne.Z([3,252,111,.75]),this.occludedColor=new ne.Z([252,3,69,.75]),this.undefinedColor=new ne.Z([127,127,127,.75])}};const he=new class{constructor(){this.innerWidth=2,this.outerWidth=8,this.visibleInnerColor=new ne.Z([3,252,111,1]),this.visibleOuterColor=new ne.Z([3,252,111,.15]),this.occludedInnerColor=new ne.Z([252,3,69,1]),this.occludedOuterColor=new ne.Z([252,3,69,.1]),this.undefinedInnerColor=new ne.Z([255,255,255,1]),this.undefinedOuterColor=new ne.Z([127,127,127,.2])}};var ve=i(3682),ge=i(77811),_e=i(23496),fe=i(27032),be=i(86026),ye=i(55541);class me extends ve.Z{constructor(e,t){const i=(0,ge.EA)(de(e.effectiveTheme)),n=(0,be.PI)(i,ce.size,32,32),r=new _e.r(n);super({view:e,renderObjects:[r],metadata:t,elevationInfo:{mode:"absolute-height",offset:0}}),(0,fe.c)(this),this.themeHandle=(0,b.YP)((()=>({color:de(e.effectiveTheme)})),(e=>{i.setParameters(e)}))}destroy(){this.themeHandle.remove(),super.destroy()}}class Ce extends ve.Z{constructor(e,t){const{size:i,visibleColor:n,occludedColor:r,undefinedColor:o}=pe;super({view:e,renderObjects:[we(i,n,ye.jg.Custom1),we(i,r,ye.jg.Custom2),we(i,o,ye.jg.Custom3)],metadata:t,elevationInfo:{mode:"absolute-height",offset:0}}),(0,fe.c)(this)}}function we(e,t,i){return new _e.r((0,be.PI)((0,ge.EA)(ne.Z.toUnitRGBA(t)),e,32,32),i)}var Ie,Oe=i(82845),Te=(i(26124),i(86227)),Se=i(69880),Le=i(70134),Pe=i(50670);!function(e){e.Ready="ready",e.Creating="creating",e.Created="created"}(Ie||(Ie={}));let Ee=class extends Te.f{constructor(e){super(e),this._creationMode=!1,this.removeIncompleteOnCancel=!1,this.analysisViewData=null,this._latestPointerMovePointerType=null,this._laserlineVisualElement=null,this._grabbedManipulator=null,this._analysisHandles=new g.Z,this._updatingHandles=new m.R,this._manipulatorHandles=new g.Z,this._targetTrackerManipulator=null}initialize(){this._intersector=new G({view:this.view}),this.addHandles((0,b.gx)((()=>this.state===Ie.Created),(()=>this.finishToolCreation()),b.tX)),this._observerManipulator=this._createObserverManipulator(),this._createLaserLine(),this.addHandles([this._updatingHandles.add((()=>this.analysisViewData?.elevationAlignedObserver),(e=>this._onObserverLocationChange(e)),b.nn),this._updatingHandles.add((()=>function(e){const t=e.accentColor;return{glowColor:t,innerColor:(0,le.mj)(t),globalAlpha:.75*t.a}}(this.view.effectiveTheme)),(({glowColor:e,innerColor:t,globalAlpha:i})=>this._updateLaserLineStyle(e,t,i)),b.nn),this._updatingHandles.add((()=>this._laserLineRendererDependencies()),(e=>this._updateLaserLineRenderer(e))),this._connectComputations(),this._updatingHandles.addWhen((()=>!this._shouldRenderTracker),(()=>this._clearCursorTracker()),b.nn),this._updatingHandles.add((()=>({active:this.active,hasGrabbedManipulators:this.hasGrabbedManipulators})),(({active:e,hasGrabbedManipulators:t})=>{this._creationMode=!!e&&(this._creationMode||!t)}),b.nn)])}destroy(){this._updatingHandles=(0,a.SC)(this._updatingHandles),this._manipulatorHandles=(0,a.SC)(this._manipulatorHandles),this._analysisHandles=(0,a.SC)(this._analysisHandles),this._observerManipulator=null,this._clearCursorTracker(),this._removeLaserLine(),this._intersector=null,this._set("analysis",null)}get state(){return this.active?!this.hasGrabbedManipulators||this._creationMode?Ie.Creating:Ie.Created:null!=this.analysis.observer?.position?Ie.Created:Ie.Ready}get cursor(){return this.active&&this._showTracker?"crosshair":null}get updating(){return null!=this.analysisViewData&&this.analysisViewData.updating||this._updatingHandles.updating}get _showTracker(){return this.active&&"mouse"===this._latestPointerMovePointerType}get _shouldRenderTracker(){return this._showTracker&&null!=this.analysis.observer?.position&&!this.hasGrabbedManipulators}continue(){this.view.activeTool=this}stop(){this.view.activeTool=null}onEditableChange(){this.analysisViewData.editable=this.internallyEditable}onInputEvent(e){switch(e.type){case"immediate-double-click":this._doubleClickHandler(e);break;case"pointer-move":this._pointerMoveHandler(e)}}onInputEventAfter(e){"immediate-click"===e.type&&this._clickHandler(e)}onShow(){}onHide(){}onDeactivate(){this._clearCursorTracker()}_connectComputations(){return this._updatingHandles.addOnCollectionChange((()=>this.analysisViewData.computations),(e=>this._onComputationsCollectionChange(e)),{initial:!0,final:!0})}_onComputationsCollectionChange({added:e,removed:t}){for(const e of t)this._disconnectComputation(e);for(const t of e)this._connectComputation(t)}_connectComputation(e){if(this.destroyed)return void u.Z.getLogger(this).warn("Attempting to connect an analysis to a destroyed LineOfSight tool. Ignoring.");const t=this._analysisHandles;if(t.has(e))return;const i=this._createTargetManipulator(e.target);null==this._targetTrackerManipulator&&i.metadata.target===this.analysisViewData.cursorTarget&&(this._targetTrackerManipulator=i,this._targetTrackerManipulator.available=!1,this._targetTrackerManipulator.interactive=!1,this._updateLaserLineRenderer()),t.add([this._updatingHandles.add((()=>function(e){const{isValid:t,isTargetVisible:i}=e.computationResult;return{isValid:t,isTargetVisible:i}}(e)),(()=>function(e,t){const{isValid:i,isTargetVisible:n}=t.computationResult;e.state=i?n?ye.jg.Custom1:ye.jg.Custom2:ye.jg.Custom3}(i,e)),b.nn),this._updatingHandles.add((()=>e.elevationAlignedTargetLocation),(e=>this._onTargetLocationChange(e,i)),b.nn)],e)}_disconnectComputation(e){if(this.destroyed)return void u.Z.getLogger(this).warn("Attempting to disconnect an analysis from a destroyed LineOfSight tool. Ignoring.");this._analysisHandles.remove(e);const t=this._getTargetManipulator(e.target);null!=t&&(this.manipulators.remove(t),this._manipulatorHandles.remove(t),null!=this._targetTrackerManipulator&&this._targetTrackerManipulator===t&&(this._targetTrackerManipulator=null))}_clearCursorTracker(){this.analysisViewData.cursorTarget=(0,a.SC)(this.analysisViewData.cursorTarget)}_createTargetManipulator(e){const t={target:e,type:"target"},i=new Ce(this.view,t);return this._manipulatorHandles.add([this._createTargetManipulatorDragPipeline(i),i.events.on("grab-changed",(e=>this._manipulatorGrabChanged(i,e))),i.events.on("immediate-click",(e=>this._manipulatorClick(i,e)))],i),this.manipulators.add(i),null!=e.position?i.elevationAlignedLocation=e.position:i.available=!1,i}_getTargetManipulator(e){let t=null;return this.manipulators.forEach((i=>{const n=i.manipulator;null==t&&"target"===n.metadata.type&&n.metadata.target===e&&(t=n)})),t}_createObserverManipulator(){const e=new me(this.view,{type:"observer",intersection:null});return this._manipulatorHandles.add([this._createObserverManipulatorDragPipeline(e),e.events.on("grab-changed",(t=>this._manipulatorGrabChanged(e,t))),e.events.on("immediate-click",(t=>this._manipulatorClick(e,t)))],e),this.manipulators.add(e),e}_screenToIntersection(){return e=>{const t=this._intersector.getScreenPointIntersection(e.screenEnd);return null==t?null:{...e,intersection:t}}}_createTargetManipulatorDragPipeline(e){return(0,Se.Xd)(e,((t,i,n)=>{i.next(this._screenToIntersection()).next(this._updateTargetDragStep(e)).next((()=>this._updateLaserLineRenderer())),n.next(function(e){const t=e.position?.clone();return i=>(e.position=t,i)}(e.metadata.target)).next((()=>this._updateLaserLineRenderer()))}))}_createObserverManipulatorDragPipeline(e){return(0,Se.Xd)(e,((e,t,i)=>{t.next(this._screenToIntersection()).next(this._updateObserverDragStep()).next((()=>this._updateLaserLineRenderer())),i.next(this._cancelObserverDragStep()).next((()=>this._updateLaserLineRenderer()))}))}_updateObserverDragStep(){return e=>(null!=e.intersection.mapPoint?(null==this.analysis.observer&&(this.analysis.observer=new re.Z),this._updateFromIntersection(this.analysis.observer,e.intersection)):this.analysis.observer=null,e)}_cancelObserverDragStep(){const e=null!=this.analysis.observer?.position?this.analysis.observer.clone():null;return t=>(this.analysis.observer=e,t)}_updateTargetDragStep(e){return t=>{this._updateFromIntersection(e.metadata.target,t.intersection);const i=t.intersection.mapPoint;return null!=i&&(e.elevationAlignedLocation=i),t}}_manipulatorGrabChanged(e,t){switch(t.action){case"start":this._grabbedManipulator=e;break;case"end":this._grabbedManipulator===e&&(this._grabbedManipulator=null)}}_laserLineRendererDependencies(){return{laserlineVisualElement:this._laserlineVisualElement,grabbedManipulator:this._grabbedManipulator,shouldRenderTracker:this._shouldRenderTracker,observerPosition:null!=this.analysis.observer?this.analysis.observer.position:null,visible:this.visible}}_updateLaserLineRenderer(e=this._laserLineRendererDependencies()){const{laserlineVisualElement:t,grabbedManipulator:i,shouldRenderTracker:n,observerPosition:r,visible:o}=e;if(null==t)return;const s=null!=i?i:n&&null!=r?this._targetTrackerManipulator:null;null!=s&&o?(t.visible=!0,t.heightManifoldTarget=s.renderLocation,s!==this._observerManipulator?t.lineVerticalPlaneSegment=(0,se.zk)(this._observerManipulator.renderLocation,s.renderLocation,Re):t.lineVerticalPlaneSegment=null):(t.visible=!1,t.heightManifoldTarget=null,t.lineVerticalPlaneSegment=null)}_createLaserLine(){this._removeLaserLine();const{glowWidth:e,innerWidth:t}=ue;this._laserlineVisualElement=new Oe.W({view:this.view,attached:!0,visible:this.visible,style:{glowWidth:e,innerWidth:t},isDecoration:!0})}_removeLaserLine(){null!=this._laserlineVisualElement&&(this._laserlineVisualElement.destroy(),this._laserlineVisualElement=null)}_updateLaserLineStyle(e,t,i){const n=this._laserlineVisualElement;if(null==n)return;const r=n.style;n.style={...r,glowColor:ne.Z.toUnitRGB(e),innerColor:ne.Z.toUnitRGB(t),globalAlpha:i}}_onObserverLocationChange(e){null!=e?(this._observerManipulator.metadata.intersection=null,this._observerManipulator.available=!0,this._observerManipulator.elevationAlignedLocation=e):this._observerManipulator.available=!1}_onTargetLocationChange(e,t){null!=e?(t.elevationAlignedLocation=e,t!==this._targetTrackerManipulator&&(t.available=!0)):t.available=!1}_addPointFromClickEvent(e){const t=this._intersector.getScreenPointIntersection(e);if(null!=t?.mapPoint)if(null!=this.analysis.observer?.position){this._clearCursorTracker();const e=new oe.Z;this._updateFromIntersection(e,t),this.analysis.targets.add(e)}else{const e=new re.Z;this._updateFromIntersection(e,t),this.analysis.observer=e}}_clickHandler(e){this.active&&e.button!==Pe.t.Right&&(this._addPointFromClickEvent((0,Le.vT)(e)),e.stopPropagation())}_doubleClickHandler(e){this.active&&e.button!==Pe.t.Right&&(this.stop(),e.stopPropagation())}_pointerMoveHandler(e){if(this.hasGrabbedManipulators)return;if(this._latestPointerMovePointerType=e.pointerType,this._updateLaserLineRenderer(),!this._showTracker||null==this.analysis.observer?.position)return;const t=(0,Le.vT)(e),i=this._intersector.getScreenPointIntersection(t);null!=i?.mapPoint&&(null==this.analysisViewData.cursorTarget&&(this.analysisViewData.cursorTarget=new oe.Z),this._updateFromIntersection(this.analysisViewData.cursorTarget,i),this._updateLaserLineRenderer())}_updateFromIntersection(e,t){if(null==t.mapPoint)return e.position=null,e.elevationInfo=null,void(e.feature=null);switch(t.type){case F.q.OBJECT:if(null!=t.graphic){const i=t.graphic,n=(0,L.RL)(i);"on-the-ground"===n.mode&&(n.mode="relative-to-ground",n.offset=0),e.elevationInfo=new ae.Z(n),e.feature=i}else e.elevationInfo=null,e.feature=null;break;case F.q.TERRAIN:e.elevationInfo=new ae.Z({mode:"on-the-ground"}),e.feature=null;break;default:e.elevationInfo=null,e.feature=null}const i=t.mapPoint.clone();i.z=(0,L.vQ)(this.view,i,{mode:"absolute-height",offset:0},e.elevationInfo),e.position=i}_manipulatorClick(e,t){if("observer"===e.metadata.type||e.grabbing||e.dragging||t.button!==Pe.t.Right||this.analysis.targets.length<=1)return;const{target:i}=e.metadata;this.analysis.targets.remove(i),t.stopPropagation()}get testInfo(){}};(0,n._)([(0,l.Cb)({constructOnly:!0})],Ee.prototype,"view",void 0),(0,n._)([(0,l.Cb)({constructOnly:!0})],Ee.prototype,"analysis",void 0),(0,n._)([(0,l.Cb)()],Ee.prototype,"_creationMode",void 0),(0,n._)([(0,l.Cb)({readOnly:!0})],Ee.prototype,"state",null),(0,n._)([(0,l.Cb)({readOnly:!0})],Ee.prototype,"cursor",null),(0,n._)([(0,l.Cb)()],Ee.prototype,"removeIncompleteOnCancel",void 0),(0,n._)([(0,l.Cb)({readOnly:!0})],Ee.prototype,"updating",null),(0,n._)([(0,l.Cb)({constructOnly:!0})],Ee.prototype,"analysisViewData",void 0),(0,n._)([(0,l.Cb)({readOnly:!0})],Ee.prototype,"_showTracker",null),(0,n._)([(0,l.Cb)()],Ee.prototype,"_latestPointerMovePointerType",void 0),(0,n._)([(0,l.Cb)()],Ee.prototype,"_shouldRenderTracker",null),(0,n._)([(0,l.Cb)()],Ee.prototype,"_laserlineVisualElement",void 0),(0,n._)([(0,l.Cb)()],Ee.prototype,"_grabbedManipulator",void 0),Ee=(0,n._)([(0,c.j)("esri.views.3d.analysis.LineOfSight.LineOfSightTool")],Ee);const Re=(0,se.Ue)();var Ve=i(10934);class xe{constructor(e,t,i,n){this.visibleLineVisualElement=e,this.occludedLineVisualElement=t,this.undefinedLineVisualElement=i,this.targetVisualElement=n}destroy(){this.visibleLineVisualElement.destroy(),this.occludedLineVisualElement.destroy(),this.undefinedLineVisualElement.destroy(),this.targetVisualElement.destroy()}}var Ae=i(80075),Me=i(68830);i(19596);let He=class extends r.Z{constructor(e){super(e),this._lineOfSightVisualElements=new Array,this._computationHandles=new g.Z,this._updatingHandles=new m.R}initialize(){this.addHandles(this._connectComputations()),this._createObserverVisualization()}destroy(){this._updatingHandles=(0,a.SC)(this._updatingHandles),this._computationHandles=(0,a.SC)(this._computationHandles),this._observerVisualElement=(0,a.SC)(this._observerVisualElement)}get visible(){return this.analysisViewData.visible}get updating(){return this._updatingHandles.updating}get interactiveAndEditable(){return this.analysisViewData.interactive&&this.analysisViewData.editable}get test(){}_createLineOfSightVisualization(){const e=he,t=this.view,i=this.isDecoration,n={view:t,attached:!0,width:e.outerWidth,innerWidth:e.innerWidth,isDecoration:i},r=ne.Z.toUnitRGBA(e.visibleOuterColor),o=ne.Z.toUnitRGBA(e.visibleInnerColor),s=ne.Z.toUnitRGBA(e.occludedOuterColor),a=ne.Z.toUnitRGBA(e.occludedInnerColor),l=ne.Z.toUnitRGBA(e.undefinedOuterColor),u=ne.Z.toUnitRGBA(e.undefinedInnerColor),c=new Ae.r({...n,color:r,innerColor:o}),d=new Ae.r({...n,color:s,innerColor:a}),p=new Ae.r({...n,color:l,innerColor:u}),h=new Me.L({view:t,attached:!0,...De,size:8,isDecoration:i}),v=new xe(c,d,p,h);return this._lineOfSightVisualElements.push(v),v}_destroyLineOfSightVisualization(e){e.destroy(),this._lineOfSightVisualElements.splice(this._lineOfSightVisualElements.indexOf(e),1)}_updateLineOfSightVisualization(e,t,i){const n=he,{computationResult:r,inputPoints:o}=e,{start:s,end:a,intersection:l,isValid:u,isTargetVisible:c}=r,{observer:p}=o,h=ze;h[12]=p[0],h[13]=p[1],h[14]=p[2];const v=(0,y.d)(ke,s,p),g=(0,y.d)(je,a,p),_=(0,y.d)(Ze,l,p),{visibleLineVisualElement:f,occludedLineVisualElement:b,undefinedLineVisualElement:m,targetVisualElement:C}=t,w=null==this.analysisViewData.elevationAlignedObserver||null==e.elevationAlignedTargetLocation,I=this.visible&&!w;f.visible=I,b.visible=I,m.visible=I,C.visible=I,C.attached=!i.interactiveAndEditable,I&&(f.geometry=null,b.geometry=null,m.geometry=null,C.geometry=e.elevationAlignedTargetLocation,u?c?(f.geometry=[[(0,d.nI)(v),(0,d.nI)(g)]],f.transform=h,f.color=ne.Z.toUnitRGBA(n.visibleOuterColor),C.color=ne.Z.toUnitRGBA(n.visibleInnerColor)):(f.geometry=[[(0,d.nI)(v),(0,d.nI)(_)]],f.transform=h,f.color=ne.Z.toUnitRGBA(n.occludedOuterColor),b.geometry=[[(0,d.nI)(_),(0,d.nI)(g)]],b.transform=h,C.color=ne.Z.toUnitRGBA(n.occludedInnerColor)):(m.geometry=[[(0,d.nI)(v),(0,d.nI)(g)]],m.transform=h,C.color=ne.Z.toUnitRGBA(n.undefinedInnerColor)))}_getLineOfSightVisualizationDependencies(e){const{computationResult:t}=e,{occludedOuterColor:i,visibleOuterColor:n}=he;return{computationResult:t,occludedOuterColor:i,visibleOuterColor:n,visible:this.visible,interactiveAndEditable:this.interactiveAndEditable}}_connectComputation(e){const t=this._computationHandles;if(t.has(e))return;const i=this._createLineOfSightVisualization();t.add([this._updatingHandles.add((()=>this._getLineOfSightVisualizationDependencies(e)),(t=>this._updateLineOfSightVisualization(e,i,t)),{initial:!0,equals:()=>!1}),(0,_.kB)((()=>this._destroyLineOfSightVisualization(i)))],e)}_disconnectComputation(e){this._computationHandles.remove(e)}_connectComputations(){return this._updatingHandles.addOnCollectionChange((()=>this.analysisViewData.computations),(e=>this._onComputationsCollectionChange(e)),{initial:!0,final:!0})}_onComputationsCollectionChange({added:e,removed:t}){for(const e of t)this._disconnectComputation(e);for(const t of e)this._connectComputation(t)}_createObserverVisualization(){const e=ne.Z.toUnitRGBA(he.visibleInnerColor),t=new Me.L({view:this.view,color:e,...De,isDecoration:this.isDecoration});this._observerVisualElement=t,this.addHandles(this._updatingHandles.add((()=>({observer:this.analysisViewData.elevationAlignedObserver,interactiveAndEditable:this.interactiveAndEditable,visible:this.visible})),(({observer:e,interactiveAndEditable:i,visible:n})=>{null!=e&&!i&&n?(t.geometry=e,this._observerVisualElement.attached=!0):t.attached=!1}),b.nn))}};(0,n._)([(0,l.Cb)({constructOnly:!0})],He.prototype,"analysis",void 0),(0,n._)([(0,l.Cb)({constructOnly:!0})],He.prototype,"analysisViewData",void 0),(0,n._)([(0,l.Cb)({constructOnly:!0})],He.prototype,"view",void 0),(0,n._)([(0,l.Cb)({readOnly:!0})],He.prototype,"visible",null),(0,n._)([(0,l.Cb)({constructOnly:!0})],He.prototype,"isDecoration",void 0),(0,n._)([(0,l.Cb)()],He.prototype,"updating",null),(0,n._)([(0,l.Cb)()],He.prototype,"interactiveAndEditable",null),(0,n._)([(0,l.Cb)()],He.prototype,"test",null),He=(0,n._)([(0,c.j)("esri.views.3d.analysis.LineOfSight.LineOfSightVisualization")],He);const De={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0},ke=(0,d.Ue)(),je=(0,d.Ue)(),Ze=(0,d.Ue)(),ze=(0,Ve.Ue)();var Fe=i(24468);let Ue=class extends((0,p.p)(s.Z.EventedMixin(r.Z))){constructor(e){super(e),this.type="line-of-sight-view-3d",this.analysis=null,this.tool=null,this.computations=new o.Z,this.cursorTarget=null,this.editable=!0,this.elevationAlignedObserver=null,this.observerEngineLocation=(0,d.Ue)(),this.userOperation=null}initialize(){const e=this.view,t=this.analysis;this._analysisController=new J({analysis:t,analysisViewData:this,view:e}),this._analysisVisualization=new He({analysis:t,analysisViewData:this,view:e,isDecoration:!this.parent}),this.addHandles([this._analysisController.on("result-changed",(e=>{e.target!==this.cursorTarget&&this.emit("result-changed",e)})),(0,Fe.Lp)(this,Ee)])}destroy(){(0,Fe.Yq)(this),this.userOperation=(0,a.IM)(this.userOperation),this._analysisController=(0,a.SC)(this._analysisController),this._analysisVisualization=(0,a.SC)(this._analysisVisualization)}get results(){return this.computations.map((e=>e.result))}get priority(){return this._analysisController.priority}set priority(e){this._analysisController.priority=e}get updating(){return null!=this._analysisController&&this._analysisController.updating||null!=this._analysisVisualization&&this._analysisVisualization.updating}place(e){return(0,Fe.tq)(this,{placementOptions:e})}getResultForTarget(e){return this.computations.find((t=>t.target===e))?.result}get testInfo(){}};(0,n._)([(0,l.Cb)({readOnly:!0})],Ue.prototype,"type",void 0),(0,n._)([(0,l.Cb)({constructOnly:!0,nonNullable:!0})],Ue.prototype,"analysis",void 0),(0,n._)([(0,l.Cb)()],Ue.prototype,"tool",void 0),(0,n._)([(0,l.Cb)({readOnly:!0})],Ue.prototype,"results",null),(0,n._)([(0,l.Cb)()],Ue.prototype,"priority",null),(0,n._)([(0,l.Cb)()],Ue.prototype,"computations",void 0),(0,n._)([(0,l.Cb)()],Ue.prototype,"cursorTarget",void 0),(0,n._)([(0,l.Cb)()],Ue.prototype,"editable",void 0),(0,n._)([(0,l.Cb)()],Ue.prototype,"elevationAlignedObserver",void 0),(0,n._)([(0,l.Cb)()],Ue.prototype,"observerEngineLocation",void 0),(0,n._)([(0,l.Cb)()],Ue.prototype,"updating",null),(0,n._)([(0,l.Cb)()],Ue.prototype,"userOperation",void 0),(0,n._)([(0,l.Cb)()],Ue.prototype,"_analysisController",void 0),(0,n._)([(0,l.Cb)()],Ue.prototype,"_analysisVisualization",void 0),Ue=(0,n._)([(0,c.j)("esri.views.3d.analysis.LineOfSightAnalysisView3D")],Ue);const Ge=Ue},27032:function(e,t,i){i.d(t,{I:function(){return o},c:function(){return s}});var n=i(50702),r=i(51870);function o(e,t){return function(e,t){return!!e&&"on-the-ground"!==t.mode&&!(0,r.fl)(t)}(e?.data.coordinateHelper.hasZ(),t)}function s(e,t){let i=null;const r=e.events.on("grab-changed",(n=>{null!=i&&(i.remove(),i=null),"start"===n.action?(i=e.disableDisplay(),t&&t(n)):t&&t(n)}));return(0,n.kB)((()=>{i?.remove(),r.remove()}))}},68830:function(e,t,i){i.d(t,{L:function(){return y}});var n=i(99574),r=i(24910),o=i(82846),s=i(73749),a=i(27583),l=i(2051),u=i(16447),c=i(69811),d=i(56172),p=i(49102),h=i(90210),v=i(94290),g=i(78560),_=i(86026),f=i(52061),b=i(3970);class y extends p._{constructor(e){super(e),this._material=null,this._texture=null,this._geometry=null,this._size=3,this._color=(0,a.al)(1,0,1,1),this._pixelSnappingEnabled=!0,this._primitive="square",this._outlineSize=1,this._outlineColor=(0,a.al)(1,1,1,1),this._elevationInfo=null,this.applyProperties(e)}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get size(){return this._size}set size(e){if(e!==this._size){const t=this._preferredTextureSize;this._size=e,t<this._preferredTextureSize?this.recreate():this._updateSizeAttribute()}}get color(){return this._color}set color(e){(0,s.a)(e,this._color)||((0,s.c)(this._color,e),this._updateMaterial())}get pixelSnappingEnabled(){return this._pixelSnappingEnabled}set pixelSnappingEnabled(e){this._pixelSnappingEnabled!==e&&(this._pixelSnappingEnabled=e,this._updateMaterial())}get primitive(){return this._primitive}set primitive(e){this._primitive!==e&&(this._primitive=e,this.recreate())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){(0,s.a)(e,this._outlineColor)||((0,s.c)(this._outlineColor,e),this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}_updateMaterial(){this._material?.setParameters(this._materialParameters)}_updateSizeAttribute(){const e=this.object;if(null==e)return;const t=e.geometries[0];if(null==t)return;const i=t.getMutableAttribute(f.T.SIZE).data,n=this._geometrySize;i[0]=n,i[1]=n,e.geometryVertexAttributeUpdated(e.geometries[0],f.T.SIZE)}get _materialParameters(){return{color:this._color,textureIsSignedDistanceField:!0,sampleSignedDistanceFieldTexelCenter:(0,g.Rg)(this._primitive),distanceFieldBoundingBox:g.ER,occlusionTest:!1,outlineColor:this._outlineColor,outlineSize:this._outlineSize,textureId:this._texture?.id,polygonOffset:!1,shaderPolygonOffset:0,drawAsLabel:!0,depthEnabled:!1,pixelSnappingEnabled:this.pixelSnappingEnabled,isDecoration:this.isDecoration}}get _geometrySize(){return this._size/g.hy}createExternalResources(){this._texture=(0,g.cU)(this._primitive,this._preferredTextureSize),this._material=new b.A(this._materialParameters,this.view.state.viewingMode===d.JY.Global);const e=this.view.stage;this._texture.load(e.renderView.renderingContext),e.addTexture(this._texture)}destroyExternalResources(){this._texture&&(this.view.stage.removeTexture(this._texture),this._texture.dispose(),this._texture=null),this._material=null}createGeometries(e){const t=this._createRenderGeometry();null!=t&&e.addGeometry(t)}forEachMaterial(e){e(this._material)}get _preferredTextureSize(){return(0,n.uZ)(2*this._geometrySize,16,128)}calculateMapBounds(e){const t=this.object?.geometries[0];if(!t)return!1;const i=t.attributes.get(f.T.POSITION).data;return(0,l.S)(i,this.view.renderCoordsHelper.spatialReference,m,this.view.spatialReference),(0,u.G1)(e,m),!0}_createRenderGeometry(){const{geometry:e,_material:t}=this;if(null==e||null==t)return null;const{renderCoordsHelper:i,elevationProvider:n}=this.view,o=(0,h.w7)(e,n,v.o.fromElevationInfo(this.elevationInfo),i),s=(0,r.i)(c.WM.get(),e.x,e.y,o),a=c.WM.get();(0,l.S)(s,e.spatialReference,a,i.spatialReference);const u=this._geometrySize;return(0,_.dV)(t,{position:a,size:[u,u],centerOffsetAndDistance:[0,0,0,1]})}}const m=(0,o.Ue)()},42266:function(e,t,i){i.d(t,{c:function(){return s}});var n=i(82846),r=i(19596),o=i(87807);class s extends r.F5{constructor(){super(...arguments),this._pp0=(0,n.al)(0,0,1),this._pp1=(0,n.al)(0,0,0)}intersect(e,t,i,n,r,s){return(0,o.Bw)(e,i,n,r,void 0,s)}intersectDraped(e,t,i,n){return this._pp0[0]=this._pp1[0]=i[0],this._pp0[1]=this._pp1[1]=i[1],(0,o.Bw)(e,t,this._pp0,this._pp1,void 0,n)}}},24468:function(e,t,i){i.d(t,{Av:function(){return c},Lp:function(){return l},Yq:function(){return u},tq:function(){return d}});var n=i(29292),r=i(50702),o=i(61100),s=i(93568),a=i(90403);function l(e,t){return(0,a.YP)((()=>e.interactive),(()=>function(e,t){e.interactive?function(e,t){u(e);const{view:i,analysis:n}=e,r=new t({view:i,analysis:n,analysisViewData:e});e.tool=r,i.tools.add(r)}(e,t):u(e)}(e,t)),a.tX)}function u(e){const{view:t,tool:i}=e;null!=i&&(t.tools.remove(i),e.tool=null)}function c(e,t){const i=e.userOperation,l=(0,n.vr)((async l=>{if(i){const e=i.promise.catch((()=>{}));i?.abort(),await e,(0,s.k_)(l)}const u=function(e,t){e.interactive=!0;const{tool:i,view:r}=e;r.activeTool=i;let l=(0,s.fu)(t,(()=>{r.activeTool===i&&(r.activeTool=null)}));return(0,n.vr)((async t=>{await(0,a.N1)((()=>!e.tool?.active),t),l=(0,o.hw)(l)}),t)}(e,{signal:l}),c=t?.shouldRejectOnCancel??(()=>!0),d=(0,r.AL)([(0,a.on)((()=>e.tool),"cancel",(()=>{c()&&u.abort()}))]),{tool:p}=e;try{p&&(p.resetCreated(),t?.onToolActivated?.(p)),await u.promise,(0,s.k_)(l)}catch(e){if(l.aborted||!(0,s.D_)(e)||c())throw e}finally{d?.remove()}}),{signal:t?.abortOptions?.signal});return e.userOperation=l,l.promise.finally((()=>{e.userOperation===l&&(e.userOperation=null)}))}async function d(e,t){const i=e.analysis.clone();return await c(e,{abortOptions:t?.placementOptions,onToolActivated:t?.onToolActivated,shouldRejectOnCancel:()=>{const{analysis:t}=e;return!t.valid||t.equals(i)}}),{}}},86227:function(e,t,i){i.d(t,{f:function(){return a}});var n=i(73440),r=i(90403),o=(i(96711),i(61432),i(83850),i(88194),i(48023)),s=i(56128);let a=class extends s.m{constructor(e){super(e)}initialize(){this.addHandles((0,r.YP)((()=>this.analysisViewData.visible),(e=>this.visible=e),r.tX))}deactivate(){this.onDeactivate(),this.created||this.analysis.clear()}resetCreated(){this._set("created",!1)}};a=(0,n._)([(0,o.j)("esri.views.interactive.AnalysisToolBase")],a)},11465:function(e,t,i){i.d(t,{SP:function(){return n},UG:function(){return c},dU:function(){return u},k0:function(){return a},xO:function(){return l}});i(99574);var n,r=i(26821),o=i(41788);function s(e,t){return e[0]*t[1]-e[1]*t[0]}function a(e,t,i,n,o=i){return(0,r.$X)(p,n,i),(0,r.$X)(v,t,o),function(e,t,i){const n=(0,r.AK)(i,t)/(0,r.we)(i);(0,r.bA)(e,i,n)}(g,v,p),(0,r.IH)(e,o,g)}function l(e,t,i,n){(0,r.$X)(p,t,i);const o=n/(0,r.kE)(p);return(0,r.od)(e,i,p,o)}function u(e,t){const i=e.start,o=e.end,a=t.start,l=t.end,u=(0,r.$X)(p,o,i),c=(0,r.$X)(h,l,a),_=s(u,c);if(Math.abs(_)<=d)return[];const f=(0,r.$X)(v,i,a),b=s(c,f)/_,y=s(u,f)/_;if(b>=0){if(y>=0||t.type===n.LINE)return[(0,r.od)(g,i,u,b)]}else if(e.type===n.LINE&&(y>=0||t.type===n.LINE))return[(0,r.od)(g,i,u,b)];return[]}function c(e,t,i){const o=[],s=(0,r.$X)(p,e.end,e.start),a=(0,r.$X)(h,e.start,t),l=(0,r.we)(s),u=2*(0,r.AK)(s,a),c=u*u-4*l*((0,r.we)(a)-i*i);if(0===c){const t=-u/(2*l);(e.type===n.LINE||t>=0)&&o.push((0,r.od)(g,e.start,s,t))}else if(c>0){const t=Math.sqrt(c),i=(-u+t)/(2*l);(e.type===n.LINE||i>=0)&&o.push((0,r.od)(g,e.start,s,i));const a=(-u-t)/(2*l);(e.type===n.LINE||a>=0)&&o.push((0,r.od)(v,e.start,s,a))}return o}!function(e){e[e.RAY=0]="RAY",e[e.LINE=1]="LINE"}(n||(n={}));const d=1e-6,p=(0,o.Ue)(),h=(0,o.Ue)(),v=(0,o.Ue)(),g=(0,o.Ue)()}}]);