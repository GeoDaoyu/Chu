"use strict";(self.webpackChunkscene_pro=self.webpackChunkscene_pro||[]).push([[34267],{28371:function(e,t,n){n.d(t,{h:function(){return s}});n(3480),n(28947);var r=n(92161),i=n(85913);n(62052),n(72728);function s(e,t,n){if(null==e?.timeInfo)return null;const{datesInUnknownTimezone:s=!1,timeOffset:o,useViewTime:a}=e;let l=e.timeExtent;s&&(l=function(e){if(!e)return e;const{start:t,end:n}=e;return new i.T({start:null!=t?(0,r.Nm)(t,t.getTimezoneOffset(),"minutes"):t,end:null!=n?(0,r.Nm)(n,n.getTimezoneOffset(),"minutes"):n})}(l));let u=a?t&&l?t.intersection(l):t||l:l;return!u||u.isEmpty||u.isAllTime?u:(o&&(u=u.offset(-o.value,o.unit)),s&&(u=function(e){if(!e)return e;const{start:t,end:n}=e;return new i.T({start:null!=t?(0,r.Nm)(t,-t.getTimezoneOffset(),"minutes"):t,end:null!=n?(0,r.Nm)(n,-n.getTimezoneOffset(),"minutes"):n})}(u)),u.equals(n)?n:u)}},28866:function(e,t,n){n.d(t,{z:function(){return j}});var r=n(73440),i=n(70880),s=n(3480),o=n(96711),a=n(99574),l=n(88058),u=n(90403),c=n(26636),d=n(17155),y=(n(61432),n(48023)),p=n(24910),h=n(82846),f=n(50718),g=n(47925),m=n(13132),b=n(45213),_=n(40897),w=n(2051),E=n(16447),S=n(47566),I=n(60199),v=n(21414),R=n(8554),C=n(69055),F=n(97290),x=n(58174),O=n(52695);let j=class extends i.Z{constructor(e){super(e),this._projectionEngineLoaded=!1}initialize(){(0,u.N1)((()=>this.viewFilter?.geometry||null!=this.layerFilter)).then((()=>this.loadAsyncModule(Promise.all([n.e(27093),n.e(13746)]).then(n.bind(n,13746)).then((e=>{this.destroyed||(this._geometryEngine=e)})))))}get sortedObjectIds(){if(null==this.viewFilter?.objectIds)return null;const e=(0,I.QZ)(this.viewFilter.objectIds);return e.sort(),e}get parsedWhereClause(){const e=this.viewFilter?.where;if(null==e||!e)return null;try{return f.default.create(e,{fieldsIndex:this.layerFieldsIndex})}catch(e){o.Z.getLogger(this).error(`Failed to parse filter where clause: ${e}`)}return null}addFilters(e,t,n,r){const i=this.sortedObjectIds;null!=i&&e.push((e=>(0,O.Yb)(i,!0,e))),this.addSqlFilter(e,this.parsedWhereClause),this.addTimeFilter(e,this.viewFilter?.timeExtent);const s=(0,l.lK)(this._layerMaskGeometries),a=this._geometryEngine,u=()=>o.Z.getLogger(this);if(null!=s&&null!=this.layerFilter&&null!=a){const i=this.layerFilter.spatialRelationship;e.push(((e,o)=>N(u,a,e,o,r,t,n,s,i)))}const c=(0,l.lK)(this._viewMaskGeometries);if(null!=c&&null!=this.viewFilter&&null!=a){const i=this.viewFilter.spatialRelationship;e.push(((e,s)=>N(u,a,e,s,r,t,n,c,i)))}}isMBSGeometryVisible(e,t,n){const r=(0,l.lK)(this._layerMaskGeometries),i=this._geometryEngine;if(null!=r&&null!=this.layerFilter&&null!=i){const s=this.layerFilter.spatialRelationship,a=r[0].spatialReference||t;return(0,_.s)(e,n,G,a)?M(i,G,r,a,s):(o.Z.getLogger(this).warnOnce("SceneLayer.mask geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0)}const s=(0,l.lK)(this._viewMaskGeometries);if(null!=s&&null!=this.viewFilter&&null!=i){const r=this.viewFilter.spatialRelationship,a=s[0].spatialReference||t;return(0,_.s)(e,n,G,a)?M(i,G,s,a,r):(o.Z.getLogger(this).warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0)}return!0}get parsedGeometry(){const e=(0,l.lK)(this._viewMaskGeometries),t=(0,l.lK)(this._layerMaskGeometries);return null==e||null==t?e||t:t.concat(e)}get _layerMaskGeometries(){const e=this.layerFilter;return null==e?null:null==this._geometryEngine?l.cn:"disjoint"===e.spatialRelationship?e.geometries.map((e=>({type:"polygon",rings:e.rings,spatialReference:e.spatialReference,cache:{}}))):[e.geometries.reduce(((e,t)=>(e.rings=[...e.rings,...t.rings],e)),{type:"polygon",rings:[],spatialReference:e.geometries[0].spatialReference,cache:{}})]}get _viewMaskGeometries(){if(null==this.viewFilter)return null;const{geometry:e}=this.viewFilter;if(null==e)return null;if(null==this.viewFilter||null==this._geometryEngine)return l.cn;const{distance:t,units:n}=this.viewFilter,r=this.viewFilter.spatialRelationship,i="mesh"===e.type?e.extent:e;if(null==t||0===t)return Q(this._geometryEngine,i,r);const s=n||(0,c.qE)(i.spatialReference);if(i.spatialReference.isWGS84){const e=this._geometryEngine.geodesicBuffer(i,t,s);return Q(this._geometryEngine,e,r)}const a=(0,F.iV)(i,b.Z.WGS84);if(null!=a){const e=(0,F.iV)(this._geometryEngine.geodesicBuffer(a,t,s),i.spatialReference);return Q(this._geometryEngine,e,r)}if(!this._projectionEngineLoaded&&(this.loadAsyncModule((0,m.load)().then((()=>this._projectionEngineLoaded=!0))),!this._projectionEngineLoaded))return null;let u=null;try{u=(0,m.project)(i,b.Z.WGS84)}catch(e){}if(u)try{u=(0,m.project)(this._geometryEngine.geodesicBuffer(u,t,s),i.spatialReference)}catch(e){u=null}return u||o.Z.getLogger(this).error(`Filter by geodesic buffer (distance) unsupported, failed to project input geometry (${i.spatialReference.wkid}) to WGS84.`),Q(this._geometryEngine,u,r)}get updating(){return(0,l.j)(this._layerMaskGeometries)||(0,l.j)(this._viewMaskGeometries)}static checkSupport(e){return!(null==e||!function(e){return null!=e&&T.includes(e)}(e.spatialRelationship)&&(o.Z.getLogger(this.prototype).warn(`Filters with spatialRelationship other than ${T.join(", ")} are not supported for mesh scene layers`),1))}};(0,r._)([(0,d.Cb)()],j.prototype,"layerFilter",void 0),(0,r._)([(0,d.Cb)({type:x.Z})],j.prototype,"viewFilter",void 0),(0,r._)([(0,d.Cb)()],j.prototype,"layerFieldsIndex",void 0),(0,r._)([(0,d.Cb)()],j.prototype,"loadAsyncModule",void 0),(0,r._)([(0,d.Cb)()],j.prototype,"addSqlFilter",void 0),(0,r._)([(0,d.Cb)()],j.prototype,"addTimeFilter",void 0),(0,r._)([(0,d.Cb)({readOnly:!0})],j.prototype,"sortedObjectIds",null),(0,r._)([(0,d.Cb)({readOnly:!0})],j.prototype,"parsedWhereClause",null),(0,r._)([(0,d.Cb)({readOnly:!0})],j.prototype,"parsedGeometry",null),(0,r._)([(0,d.Cb)({readOnly:!0})],j.prototype,"_layerMaskGeometries",null),(0,r._)([(0,d.Cb)({readOnly:!0})],j.prototype,"_viewMaskGeometries",null),(0,r._)([(0,d.Cb)()],j.prototype,"updating",null),(0,r._)([(0,d.Cb)()],j.prototype,"_projectionEngineLoaded",void 0),(0,r._)([(0,d.Cb)()],j.prototype,"_geometryEngine",void 0),j=(0,r._)([(0,y.j)("esri.views.3d.layers.i3s.I3SMeshViewFilter")],j);const T=["contains","intersects","disjoint"];var k;function Q(e,t,n){if(null==t)return null;if("disjoint"===n&&"polygon"===t.type){const n=t.rings.length,r=t.spatialReference,i=new Array(n);for(let e=0;e<n;++e){const n=(0,S.al)(1/0,1/0,-1/0,-1/0);(0,S.Wi)(n,t.rings[e]),i[e]={type:"polygon",rings:[t.rings[e]],spatialReference:r,cache:{},aabr:n}}i.sort(((e,t)=>e.aabr[0]-t.aabr[0]));const o=new Set,a=new s.SO;for(let t=0;t<i.length;++t){const n=i[t],r=n.aabr[0];o.forEach((t=>{if(r>=t.aabr[2])return void o.delete(t);if(n.aabr[1]>t.aabr[3]||n.aabr[3]<t.aabr[1]||!e.intersects(n,t))return;n.rings=n.rings.concat(t.rings),(0,S.jn)(n.aabr,t.aabr,n.aabr),n.cache={},o.delete(t);const l=(0,s.cq)(i,t,i.length,a);i.splice(l,1)})),o.add(n)}for(const e of i)e.aabr=void 0;return i}return[t]}function M(e,t,n,r,i){if(t[3]>=.5*(t[2]+(0,g.Iu)(r).radius))return!0;const s=Z(e,t,r);return n.every((t=>D(e,t,s,i)!==k.DISCARD))}function N(e,t,n,r,i,s,o,a,l){const u=a[0].spatialReference||s.spatialReference;if(!(0,_.s)(r.node.serviceMbsInIndexSR,o,G,u))return void e().warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter");const c=Z(t,G,u),d=function(e,t,n,r,i){const s=t.renderSpatialReference,o=new Map,a={type:"polygon",rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],spatialReference:n};a.rings[0][3]=a.rings[0][0];const l={indices:null,data:null,stride:0,startIndex:0,endIndex:0};let u,c;switch(e){case"intersects":u=(e,t,n)=>e.intersects(t,n)?k.KEEP:k.TEST,c=A;break;case"contains":u=(e,t,n)=>e.contains(t,n)?k.TEST:k.DISCARD,c=A;break;default:u=(e,t,n)=>e.disjoint(t,n)?k.TEST:k.DISCARD,c=K}return{collection:r,object:i,type:e,maskSR:n,renderSR:s,aabbCache:o,triangle:a,positions:l,triangleTest:u,geometryTest:c}}(l,s,u,i,r.objectHandle),y="intersects"===l;let p=null;for(const e of a){if(0===n.length)return;switch(D(t,e,c,l)){case k.DISCARD:return y&&(r.weaklyRemovedIds=r.weaklyRemovedIds?.concat(n)??n.slice()),void(n.length=0);case k.KEEP:continue}(0,O.hv)(n,r.featureIds,(n=>!!J(t,e,n,d)||(y&&(p||=[],p.push(r.featureIds[n])),!1)))}p&&(r.weaklyRemovedIds=r.weaklyRemovedIds?.concat(p)??p)}!function(e){e[e.KEEP=0]="KEEP",e[e.DISCARD=1]="DISCARD",e[e.TEST=2]="TEST"}(k||(k={}));const G=(0,C.f)(0,0,0,0);function Z(e,t,n){const r={type:"point",x:t[0],y:t[1],hasZ:!1,hasM:!1,spatialReference:n},i=!(0,R.oR)(n)&&!(0,R.sS)(n),s=Number.isNaN(t[3])?0:(0,a.uZ)(t[3],0,2*v.sv.radius),o=i?e.buffer(r,s,1):e.geodesicBuffer(r,s,1);return o.type="polygon",o}function D(e,t,n,r){switch(r){case"intersects":case"contains":return A(e,t,n);case"disjoint":return K(e,t,n)}}function A(e,t,n){return e.intersects(t,n)?e.contains(t,n)?k.KEEP:k.TEST:k.DISCARD}function K(e,t,n){return e.intersects(t,n)?e.contains(t,n)?k.DISCARD:k.TEST:k.KEEP}function J(e,t,n,r){const{collection:i,object:s,renderSR:o,maskSR:a,geometryTest:l,aabbCache:u}=r;let c=u.get(n);if(!c){const e=i.getObjectTransform(s);i.getComponentAabb(s,n,L);const t=[(0,h.al)(L[0],L[1],0),(0,h.al)(L[0],L[4],0),(0,h.al)(L[3],L[4],0),(0,h.al)(L[3],L[1],0)];for(let n=0;n<4;++n)(0,p.o)(t[n],t[n],e.rotationScale),(0,p.f)(t[n],t[n],e.position),(0,w.S)(t[n],o,t[n],a);c={type:"polygon",rings:[t],spatialReference:a,cache:{}},c.rings[0][4]=c.rings[0][0],u.set(n,c)}switch(l(e,t,c)){case k.DISCARD:return!1;case k.KEEP:return!0}const{triangle:d,triangleTest:y,positions:f}=r,g=d.rings[0][0],m=d.rings[0][1],b=d.rings[0][2],_=i.getObjectTransform(s);i.getComponentPositions(s,n,f);const{indices:E,data:S,stride:I,startIndex:v,endIndex:R}=f;for(let n=v;n<R;n+=3){const r=I*E[n],i=I*E[n+1],s=I*E[n+2];switch((0,p.i)(g,S[r],S[r+1],S[r+2]),(0,p.i)(m,S[i],S[i+1],S[i+2]),(0,p.i)(b,S[s],S[s+1],S[s+2]),(0,p.o)(g,g,_.rotationScale),(0,p.o)(m,m,_.rotationScale),(0,p.o)(b,b,_.rotationScale),(0,p.f)(g,g,_.position),(0,p.f)(m,m,_.position),(0,p.f)(b,b,_.position),(0,w.S)(g,o,g,a),(0,w.S)(m,o,m,a),(0,w.S)(b,o,b,a),y(e,t,d)){case k.DISCARD:return!1;case k.KEEP:return!0}}return"intersects"!==r.type}const L=(0,E.Ue)()},25624:function(e,t,n){n.d(t,{u:function(){return f}});var r=n(73440),i=n(70880),s=n(61100),o=n(17155),a=(n(61432),n(96711),n(83850),n(48023)),l=n(71354),u=n(78646),c=n(33235),d=n(299),y=n(13878),p=n(29191);const h=c.qq;let f=class extends i.Z{constructor(e){super(e)}initialize(){this.addHandles(this.layerView.on("visible-geometry-changed",(()=>this.spatialIndex.events.emit("changed"))))}destroy(){this._dataQueryEngineInstance=(0,s.SC)(this._dataQueryEngineInstance),this._set("layerView",null)}get spatialReference(){return this.layerView.view.spatialReference}get layer(){return this.layerView.i3slayer}get defaultQueryJSON(){return new p.Z({outSpatialReference:this.spatialReference}).toJSON()}get _dataQueryEngine(){return this._ensureDataQueryEngine()}async executeQueryForCount(e,t){return this._dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),t)}async executeQueryForExtent(e,t){const{count:n,extent:r}=await this._dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),t);return{count:n,extent:l.Z.fromJSON(r)}}async executeQueryForIds(e,t){return this._dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),t)}async executeQuery(e,t){const r=this._ensureQueryJSON(e),i=await this._dataQueryEngine.executeQuery(r,t);if(e?.returnGeometry){const{processQueryGeometries:e}=await Promise.all([n.e(65344),n.e(29097),n.e(3849)]).then(n.bind(n,61204));return e(this.layerView,i)}return y.Z.fromJSON(i)}_ensureQueryJSON(e){return null==e?this.defaultQueryJSON:e.toJSON()}_ensureDataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const e=this.layer.objectIdField||u.d,t=this.layer.fieldsIndex?.toJSON()||new d.Z([]),n=this.layerView.view.resourceController.scheduler,r=this.spatialReference.toJSON(),i=this.priority,s=this.spatialIndex;return this._dataQueryEngineInstance=new h({hasZ:!0,hasM:!1,geometryType:"esriGeometryPolygon",fieldsIndex:t,timeInfo:null,spatialReference:r,featureIdInfo:{type:"object-id",fieldName:e},featureStore:s,scheduler:n,priority:i}),this._dataQueryEngineInstance}};(0,r._)([(0,o.Cb)({constructOnly:!0})],f.prototype,"layerView",void 0),(0,r._)([(0,o.Cb)({constructOnly:!0})],f.prototype,"priority",void 0),(0,r._)([(0,o.Cb)({constructOnly:!0})],f.prototype,"spatialIndex",void 0),(0,r._)([(0,o.Cb)()],f.prototype,"spatialReference",null),(0,r._)([(0,o.Cb)()],f.prototype,"layer",null),(0,r._)([(0,o.Cb)()],f.prototype,"defaultQueryJSON",null),f=(0,r._)([(0,a.j)("esri.views.3d.layers.i3s.I3SQueryEngine")],f)},417:function(e,t,n){n.d(t,{u:function(){return a},w:function(){return l}});var r=n(16447),i=n(73975),s=n(20722),o=n(68901);class a{constructor(e){this._objectIdField=e.objectIdField,this._getFeatureExtent=e.getFeatureExtent}getObjectId(e){return e.id}getAttributes(e){const{meta:t,index:n}=e,r={};this._objectIdField&&(r[this._objectIdField]=e.id);const i=t.attributeInfo?.attributeData;if(null!=i)for(const e of Object.keys(i))r[e]=(0,o.Jx)(i[e],n);return r}getAttribute(e,t){if(t===this._objectIdField)return e.id;const{meta:n,index:r}=e,i=n.attributeInfo?.attributeData;return null!=i?(0,o.Jx)(i[t],r):null}getGeometry(e){if(e.geometry)return e.geometry;const[t,n,r,i,o,a]=this._getFeatureExtent(e,u);return new s.Z([5,5],[t,n,r,i,n,r,i,o,r,t,o,r,t,n,r,t,n,a,i,n,a,i,o,a,t,o,a,t,n,a])}getCentroid(e,t){if(e.geometry)return(0,i.Y)(new s.Z,e.geometry,t.hasZ,t.hasM);const[n,r,o,a,l,c]=this._getFeatureExtent(e,u);return new s.Z([0],[(n+a)/2,(r+l)/2,(o+c)/2])}cloneWithGeometry(e,t){const{id:n,index:r,meta:i}=e;return new l(n,r,i,t)}getMetadata(e){return e}}class l{constructor(e,t,n,r){this.id=e,this.index=t,this.meta=n,this.geometry=r}get usedMemory(){return 32+(this.geometry?.usedMemory??0)}}const u=(0,r.Ue)()},71457:function(e,t,n){n.d(t,{I:function(){return f}});var r=n(73440),i=n(70880),s=n(79487),o=n(87833),a=n(17155),l=(n(96711),n(83850),n(48023)),u=n(40897),c=n(16447),d=n(47566),y=n(69055),p=n(52192);const h=(0,c.Ue)();let f=class extends i.Z{constructor(e){super(e),this.events=new o.Z}forEach(e){this.forAllFeatures((t=>(e(t),p.Ku.CONTINUE)))}forEachBounds(e,t){for(const n of e)t(this.getFeatureExtent(n,h))}forEachInBounds(e,t){this.forAllFeatures((n=>{const r=this.getFeatureExtent((0,s.CY)(n),m);return(0,d.kK)(e,(0,c.y8)(r,b))&&t((0,s.CY)(n)),p.Ku.CONTINUE}),(t=>{if((0,u.s)(t,this.sourceSpatialReference,g,this.viewSpatialReference),g[0]>=e[0]&&g[2]<=e[2]&&g[1]>=e[1]&&g[3]<=e[3])return p.Ku.CONTINUE;const n=Math.max(e[0],Math.min(g[0],e[2])),r=Math.max(e[1],Math.min(g[1],e[3])),i=g[0]-n,s=g[1]-r;return i*i+s*s<=g[3]*g[3]?p.Ku.CONTINUE:p.Ku.SKIP}))}};(0,r._)([(0,a.Cb)({constructOnly:!0})],f.prototype,"featureAdapter",void 0),(0,r._)([(0,a.Cb)({constructOnly:!0})],f.prototype,"forAllFeatures",void 0),(0,r._)([(0,a.Cb)({constructOnly:!0})],f.prototype,"getFeatureExtent",void 0),(0,r._)([(0,a.Cb)({constructOnly:!0})],f.prototype,"sourceSpatialReference",void 0),(0,r._)([(0,a.Cb)({constructOnly:!0})],f.prototype,"viewSpatialReference",void 0),f=(0,r._)([(0,l.j)("esri.views.3d.layers.i3s.I3SQueryFeatureStore")],f);const g=(0,y.f)(0,0,0,0),m=(0,c.Ue)(),b=(0,d.Ue)()},62052:function(e,t,n){n.d(t,{s:function(){return s}});var r=n(15322);class i extends r.G{constructor(e,t){super(e,t,"webmap")}}function s(e){return null!=e&&"object"==typeof e&&"declaredClass"in e&&"esri.WebMap"===e.declaredClass}new i(2,34)}}]);