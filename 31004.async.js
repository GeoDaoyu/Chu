"use strict";(self.webpackChunkscene_pro=self.webpackChunkscene_pro||[]).push([[31004],{31004:function(e,t,n){n.r(t),n.d(t,{ManipulatedObject3DMediaElement:function(){return R}});var o=n(73440),i=n(87833),r=n(50702),s=n(90403),l=n(17155),a=(n(61432),n(96711),n(83850),n(48023)),d=n(70880),p=n(3480),c=n(60147),h=n(60508),u=n(67764),_=n(13132),y=n(77523),m=n(61722);let g=class extends d.Z{get operations(){return this._operations}get updating(){return this._updatingHandles.updating}constructor(e){super(e),this._updatingHandles=new c.R}initialize(){this.addHandles([(0,r.ed)(this._updatingHandles),this._updatingHandles.add((()=>{const e=this.element.georeference;return"control-points"===e?.type?e.controlPoints:null}),(e=>this._elementControlPointsChanged(e)),s.nn)])}_elementControlPointsChanged(e){const t=e?.map((({mapPoint:e})=>e)).filter(p.pC),n=this.view.spatialReference;this._updatingHandles.addPromise(this._whenProjected(t,n,(e=>{if(!e)return void this._replaceOperations(null);const{_operations:t}=this,o=e.map((({x:e,y:t})=>[e,t]));o.push(o[0].slice());const i=new u.Z({rings:[o],spatialReference:n});if(t?.trySetGeometry(i))return void this.onModifiedExternally();const r=this.view.state.viewingMode;this._replaceOperations(new y.X(m.XE.fromGeometry(i,r),r,(e=>this._operationsGeometryChanged(e))))})))}_operationsGeometryChanged(e){const{element:{georeference:t},_operations:n}=this;if(!n||!t||"control-points"!==t.type||!t.controlPoints)return;const o=n.data.geometry,i=t.controlPoints.map((({mapPoint:e})=>e)).filter(p.pC),r=n.data.components[0].isClosed()?1:0;if(o.rings[0]?.length-r!==i.length)return;const s=o.rings[0].map((([e,t])=>new h.Z({x:e,y:t,spatialReference:o.spatialReference})));s.length-=r;const l=i.map((({spatialReference:e})=>e));this._updatingHandles.addPromise(this._whenProjected(s,l,(t=>this._updateElementControlPoints(t,e))))}_updateElementControlPoints(e,t){const{georeference:n}=this.element;if(!n||!e||"control-points"!==n.type||n.controlPoints?.length!==e?.length)return;const o=n.controlPoints;if(o?.length===e.length)for(let i=0;i<o.length;i++)t&&(o[i].sourcePoint=n.toSource(e[i])),o[i].mapPoint=e[i]}async _whenProjected(e,t,n){if(!e)return void n(e);const{_operations:o,element:{georeference:i}}=this,r=e.map((({spatialReference:e})=>e)),s=Array.isArray(t)?t:new Array(r.length).fill(t);await(0,_.initializeProjection)(Array.from(r).map(((e,t)=>({source:e,dest:s[t]}))));const l=e.map(((e,t)=>(0,_.project)(e,s[t])));o===this._operations&&i===this.element.georeference&&n(l)}_replaceOperations(e){this._operations&&(this.removeHandles(this._operations),this._operations.destroy()),this._operations=e}};(0,o._)([(0,l.Cb)({constructOnly:!0})],g.prototype,"view",void 0),(0,o._)([(0,l.Cb)({constructOnly:!0})],g.prototype,"layer",void 0),(0,o._)([(0,l.Cb)({constructOnly:!0})],g.prototype,"element",void 0),(0,o._)([(0,l.Cb)({constructOnly:!0})],g.prototype,"onModifiedExternally",void 0),(0,o._)([(0,l.Cb)()],g.prototype,"_operations",void 0),(0,o._)([(0,l.Cb)()],g.prototype,"operations",null),(0,o._)([(0,l.Cb)()],g.prototype,"updating",null),g=(0,o._)([(0,a.j)("esri.views.3d.interactive.editingTools.media.MediaElementControllerControlPoints")],g);var v=n(18208);let C=class extends d.Z{get operations(){return this._operations}get updating(){return this._updatingHandles.updating}constructor(e){super(e),this._updatingHandles=new c.R}initialize(){this.addHandles([(0,r.ed)(this._updatingHandles),this._updatingHandles.add((()=>this.element.georeference?.coords),(e=>this._elementCoordinatesChanged(e)),s.nn)])}_elementCoordinatesChanged(e){this._updatedElementCoordinates!==e&&this._updatingHandles.addPromise(this._whenProjected(e,this.view.spatialReference,(e=>{if(!e)return void this._replaceOperations(null);const{_operations:t}=this;t?.trySetGeometry(e)?this.onModifiedExternally():this._replaceOperations(v.c.fromGeometry(e,this.view.state.viewingMode))})))}_operationsGeometryChanged(){const{element:{georeference:e},_operations:t}=this;if(!t||!e)return;const n=t.data.geometry;if(!e.coords)return void this._updateElementCoordinates(n);const o=e.coords.spatialReference;this._updatingHandles.addPromise(this._whenProjected(n,o,(e=>this._updateElementCoordinates(e))))}_updateElementCoordinates(e){const{georeference:t}=this.element;t&&(t.coords=e,this._updatedElementCoordinates=t.coords)}async _whenProjected(e,t,n){if(!e)return void n(e);const{_operations:o,element:{georeference:i}}=this,r=await(0,_.projectWithZConversion)(e,t);o===this._operations&&i===this.element.georeference&&n(r)}_replaceOperations(e){this._operations&&(this.removeHandles(this._operations),this._operations.destroy()),this._operations=e,e&&this.addHandles(e.data.on("change",(()=>this._operationsGeometryChanged())),e),this.onModifiedExternally()}};(0,o._)([(0,l.Cb)({constructOnly:!0})],C.prototype,"view",void 0),(0,o._)([(0,l.Cb)({constructOnly:!0})],C.prototype,"layer",void 0),(0,o._)([(0,l.Cb)({constructOnly:!0})],C.prototype,"element",void 0),(0,o._)([(0,l.Cb)({constructOnly:!0})],C.prototype,"onModifiedExternally",void 0),(0,o._)([(0,l.Cb)()],C.prototype,"_operations",void 0),(0,o._)([(0,l.Cb)()],C.prototype,"operations",null),(0,o._)([(0,l.Cb)()],C.prototype,"updating",null),C=(0,o._)([(0,a.j)("esri.views.3d.interactive.editingTools.media.MediaElementControllerShape")],C);var f=n(24910),b=n(82846),w=n(6961),P=n(96928),E=n(67118);function O(e,t,n){return H(e.allLayerViews.find((e=>e.layer===t)),n)}function H(e,t){if(!e||"media-3d"!==e.type||e.suspended)return!1;const n=e.layer.source;return!!n&&(n instanceof P.Z||n instanceof E.Z?n===t:"hasElement"in n&&n.hasElement(t))}let M=class extends d.Z{grabbableForEvent(){return!0}constructor(e){super(e),this.interactive=!0,this.selectable=!1,this.grabbable=!0,this.grabbing=!1,this.dragging=!1,this.hovering=!0,this.selected=!1,this.cursor=null,this.consumesClicks=!0,this.events=new i.Z.EventEmitter,this.addHandles((0,s.YP)((()=>this.selected),(e=>this.events.emit("select-changed",{action:e?"select":"deselect"})),s.Z_))}destroy(){this._set("view",null)}intersectionDistance(e){const{view:t,layer:n,element:o}=this;if(!O(t,n,o))return null;const i=t.toMap(e,{include:{layer:n,element:o}});return i&&(0,w.K)(i,j,t.renderSpatialReference)?(0,f.j)(j,t.state.camera.eye):null}onElevationChange(){}onViewChange(){}};(0,o._)([(0,l.Cb)({constructOnly:!0,nonNullable:!0})],M.prototype,"element",void 0),(0,o._)([(0,l.Cb)({constructOnly:!0,nonNullable:!0})],M.prototype,"layer",void 0),(0,o._)([(0,l.Cb)({constructOnly:!0,nonNullable:!0})],M.prototype,"view",void 0),(0,o._)([(0,l.Cb)()],M.prototype,"interactive",void 0),(0,o._)([(0,l.Cb)()],M.prototype,"selectable",void 0),(0,o._)([(0,l.Cb)()],M.prototype,"grabbable",void 0),(0,o._)([(0,l.Cb)()],M.prototype,"grabbing",void 0),(0,o._)([(0,l.Cb)()],M.prototype,"dragging",void 0),(0,o._)([(0,l.Cb)()],M.prototype,"hovering",void 0),(0,o._)([(0,l.Cb)()],M.prototype,"selected",void 0),(0,o._)([(0,l.Cb)()],M.prototype,"cursor",void 0),M=(0,o._)([(0,a.j)("esri.views.3d.interactive.editingTools.media.MediaElementManipulator3D")],M);const j=(0,b.Ue)(),x=Symbol();let R=class extends i.Z.EventedAccessor{get operations(){return this._controller?.operations}get elevationInfo(){return{mode:"on-the-ground",offset:0}}get _layerView(){const e=this.view.allLayerViews.find((e=>e.layer===this.layer));return"media-3d"===e?.type?e:null}get visible(){return H(this._layerView,this.element)}get isDraped(){return!0}get origin(){return null}get updating(){return!!this._controller?.updating}get _controllerClass(){return"transform"===this.tool||"control-points"!==this.element.georeference?.type?C:g}constructor(e){super(e),this.tool="transform"}initialize(){this.addHandles([(0,s.YP)((()=>this._controllerClass),(e=>this._updateController(e)),s.tX),(0,s.on)((()=>this._layerView),"element-render-changed",(({element:e})=>{this.element===e&&this.emit("committed")}))])}toMap(e){const{layer:t,element:n}=this;return this.view.toMap(e,{include:{layer:t,element:n}})}createManipulator(e){const{view:t,layer:n,element:o}=this;return new M({view:t,layer:n,element:o,...e})}_updateController(e){if(this._controller&&this._controller instanceof e)return;this.removeHandles(x);const{view:t,layer:n,element:o}=this,i=()=>{this.emit("modified-externally")};this._controller=new e({view:t,layer:n,element:o,onModifiedExternally:i}),i(),this.addHandles((0,r.ed)(this._controller),x)}};(0,o._)([(0,l.Cb)({constructOnly:!0})],R.prototype,"view",void 0),(0,o._)([(0,l.Cb)({constructOnly:!0})],R.prototype,"layer",void 0),(0,o._)([(0,l.Cb)({constructOnly:!0})],R.prototype,"element",void 0),(0,o._)([(0,l.Cb)()],R.prototype,"tool",void 0),(0,o._)([(0,l.Cb)()],R.prototype,"_controller",void 0),(0,o._)([(0,l.Cb)()],R.prototype,"elevationInfo",null),(0,o._)([(0,l.Cb)()],R.prototype,"_layerView",null),(0,o._)([(0,l.Cb)()],R.prototype,"visible",null),(0,o._)([(0,l.Cb)()],R.prototype,"updating",null),(0,o._)([(0,l.Cb)()],R.prototype,"_controllerClass",null),R=(0,o._)([(0,a.j)("esri.views.3d.interactive.editingTools.ManipulatedObject3DMediaElement")],R)}}]);