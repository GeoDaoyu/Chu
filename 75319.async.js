"use strict";(self.webpackChunkscene_pro=self.webpackChunkscene_pro||[]).push([[75319],{75319:function(e,t,i){i.r(t),i.d(t,{SelfSnappingEngine:function(){return B}});var n=i(73440),r=i(70880),s=i(43254),o=i(17155),a=(i(61432),i(96711),i(83850),i(48023)),c=i(95437),h=i(1925),l=i(82846),d=i(51870),u=i(17609),p=i(26636),g=i(26821),f=i(22590),x=i(29668),v=i(87778);class R{constructor(e,t){this.view=e,this.options=t,this.squaredShortLineThreshold=f.c.shortLineThreshold*f.c.shortLineThreshold}snap(e,t){return null!=t.vertexHandle?"vertex"!==t.vertexHandle.type?[]:this.snapExistingVertex(e,t):this.snapNewVertex(e,t)}edgeExceedsShortLineThreshold(e,t){return this.exceedsShortLineThreshold((0,u.j7)(e.leftVertex.pos,this.view,t),(0,u.j7)(e.rightVertex.pos,this.view,t),t)}exceedsShortLineThreshold(e,t,{spatialReference:i}){return 0===this.squaredShortLineThreshold||(0,x.Bb)((0,v.R)(t,i,d.jG,this.view),(0,v.R)(e,i,d.jG,this.view))>this.squaredShortLineThreshold}isVertical(e,t,{spatialReference:i}){const n=(0,p.c9)(i);return(0,g.TE)((0,u.eR)(e),(0,u.eR)(t))*n<f.c.verticalLineThresholdMeters}squaredProximityThreshold(e){return"touch"===e?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,i=e*t;return i*i}}var E=i(80677),w=i(53257),m=i(7012),_=i(11465);class L extends R{constructor(e,t,i){super(e,t),this._geodesicLengthMeasurementUtils=i}snapNewVertex(e,t){const i=t.editGeometryOperations.data.components[0],n=i.edges.length,r=[];if(n<1)return r;const{spatialReference:s}=t,o=(0,v.R)(e,s,d.jG,this.view),{view:a}=this,c=i.edges[n-1];let h=c;do{if(this.edgeExceedsShortLineThreshold(h,t)){const i=(0,x._j)(h,a,t);this._processCandidateProposal(i.left,i.right,e,o,t,r)}h=h.leftVertex.leftEdge}while(h&&h!==c);return r}snapExistingVertex(e,t){const i=[],n=t.vertexHandle,r=n.component;if(r.edges.length<2)return i;const{view:s}=this,{spatialReference:o}=t,a=(0,v.R)(e,o,d.jG,s),c=n.leftEdge,h=n.rightEdge;c&&h&&this.edgeExceedsShortLineThreshold(c,t)&&this.edgeExceedsShortLineThreshold(h,t)&&this._processCandidateProposal((0,u.j7)(c.leftVertex.pos,s,t),(0,u.j7)(h.rightVertex.pos,s,t),e,a,t,i);const l=r.edges[0];let p=l;do{if(p!==n.leftEdge&&p!==n.rightEdge&&this.edgeExceedsShortLineThreshold(p,t)){const n=(0,x._j)(p,s,t);this._processCandidateProposal(n.left,n.right,e,a,t,i)}p=p.rightVertex.rightEdge}while(p&&p!==l);return i}_processCandidateProposal(e,t,i,n,r,s){const{spatialReference:o,pointer:a}=r,p=(0,l.Ue)();!function(e,t,i,n,r,s){(function(e,t,i,n,{spatialReference:r},s){const o=(0,w.n6)(t,i,r,r);if(null==o)return!1;const a=(0,w.n6)(i,n,r,r);if(null==a)return!1;const l=s.geodesicDistance(i,n,r);if(null==l)return!1;const d=Math.abs(c.Q4.shortestSignedDiff(o,a))>Math.PI/2?c.c5.normalize(o+Math.PI):o;return(0,w.LH)(e,i,r,(0,h.mE)(l,"meters"),(0,h.GJ)(d,"radians","geographic"),"geodesic"),e[2]=n[2],!0})(e,t,i,n,r,s)||function(e,t,i,n){(0,m.ZE)(t,{start:i,end:n,type:_.SP.LINE},e),e[2]=t[2]}(e,n,t,i)}(p,e,t,i,r,this._geodesicLengthMeasurementUtils);const g=(0,u.s)((0,u.uo)(p));(0,x.Bb)(n,(0,v.R)(g,o,d.jG,this.view))<this.squaredProximityThreshold(a)&&s.push(new E.u({lineStart:e,lineEnd:t,targetPoint:g,isDraped:"on-the-ground"===r.elevationInfo?.mode}))}}var V=i(41788),S=i(28917);class y extends R{snapNewVertex(e,t){const i=t.editGeometryOperations.data.components[0],n=i.edges.length,r=i.vertices.length,s=[];if(n<2)return s;const{view:o}=this,a=(0,v.R)(e,t.spatialReference,d.jG,o),c=(0,u.j7)(i.vertices[r-1].pos,o,t),h=(0,u.j7)(i.vertices[0].pos,o,t),l=i.edges[n-1];let p=l;do{if(this.edgeExceedsShortLineThreshold(p,t)){const i=(0,x._j)(p,o,t);this._checkEdgeForParallelLines(i,c,e,a,t,s),this._checkEdgeForParallelLines(i,h,e,a,t,s)}p=p.leftVertex.leftEdge}while(p&&p!==l);return s}snapExistingVertex(e,t){const i=[],n=t.vertexHandle,r=n.component;if(r.edges.length<3)return i;const{view:s}=this,o=(0,v.R)(e,t.spatialReference,d.jG,s),a=n.leftEdge,c=n.rightEdge,h=r.vertices[0],l=(0,u.j7)(h.pos,s,t),p=r.vertices.length,g=r.vertices[p-1],f=(0,u.j7)(g.pos,s,t),R=r.edges[0];let E=R;do{if(E!==a&&E!==c&&this.edgeExceedsShortLineThreshold(E,t)){const r=(0,x._j)(E,s,t);a&&this._checkEdgeForParallelLines(r,(0,u.j7)(a.leftVertex.pos,s,t),e,o,t,i),c&&this._checkEdgeForParallelLines(r,(0,u.j7)(c.rightVertex.pos,s,t),e,o,t,i),n===h?this._checkEdgeForParallelLines(r,f,e,o,t,i):n===g&&this._checkEdgeForParallelLines(r,l,e,o,t,i)}E=E.rightVertex.rightEdge}while(E&&E!==R);return i}_checkEdgeForParallelLines(e,t,i,n,r,s){const o=e.left,a=e.right;if((0,_.k0)(T,(0,u.eR)(t),(0,u.eR)(o),(0,u.eR)(a)),(0,g.bI)(T,(0,u.eR)(t))<f.c.parallelLineThreshold)return;(0,_.k0)(T,(0,u.eR)(i),(0,u.eR)(o),(0,u.eR)(a),(0,u.eR)(t));const{spatialReference:c,pointer:h}=r,l=(0,u.s)((0,u.al)(T[0],T[1],i[2]));if((0,x.Bb)(n,(0,v.R)(l,c,d.jG,this.view))<this.squaredProximityThreshold(h)){if(this.isVertical(l,t,r)||this.isVertical(o,a,r))return;if(function(e,t){const i=e.left,n=e.right;for(const r of t)if((0,_.k0)(T,(0,u.eR)(n),(0,u.eR)(r.constraint.start),(0,u.eR)(r.constraint.end),(0,u.eR)(i)),(0,g.bI)(T,(0,u.eR)(n))<f.c.parallelLineThreshold)return r.addReferenceLine(e),!0;return!1}(e,s))return;s.push(new S.n({referenceLine:e,lineStart:t,targetPoint:l,isDraped:"on-the-ground"===r.elevationInfo?.mode}))}}}const T=(0,V.Ue)();var j=i(24910),P=i(88190),G=i(29453);class b extends R{constructor(e,t,i){super(e,t),this._geodesicLengthMeasurementUtils=i}snapNewVertex(e,t){const i=t.editGeometryOperations.data.components[0],n=[];if(i.vertices.length<2)return n;const{view:r}=this,s=(0,v.R)(e,t.spatialReference,d.jG,r),o=i.vertices.at(-1);this._checkForSnappingCandidate(G.dq.LastVertex,n,o.leftEdge,o,o.leftEdge.leftVertex,e,s,t);const a=i.vertices[0];return this._checkForSnappingCandidate(G.dq.FirstVertex,n,a.rightEdge,a,a.rightEdge.rightVertex,e,s,t),n}snapExistingVertex(e,t){const i=[],n=t.vertexHandle;if(n.component.vertices.length<3)return i;const{view:r}=this,s=(0,v.R)(e,t.spatialReference,d.jG,r),o=n.leftEdge,a=n.rightEdge;if(o?.leftVertex.leftEdge){const n=o.leftVertex.leftEdge;this._checkForSnappingCandidate(G.dq.ExistingEdge,i,n,n.rightVertex,n.leftVertex,e,s,t)}if(a?.rightVertex.rightEdge){const n=a.rightVertex.rightEdge;this._checkForSnappingCandidate(G.dq.ExistingEdge,i,n,n.leftVertex,n.rightVertex,e,s,t)}return i}_checkForSnappingCandidate(e,t,i,n,r,s,o,a){if(!this.edgeExceedsShortLineThreshold(i,a))return;const d=this.view,p=(0,u.j7)(n.pos,d,a),f=(0,u.j7)(r.pos,d,a);(function(e,t,i,n,r,s){(function(e,t,i,n,{spatialReference:r},s){const o=(0,w.n6)(t,i,r,r);if(null==o)return!1;const a=(0,w.n6)(i,n,r,r);if(null==a)return!1;const d=Math.sign(c.c5.shortestSignedDiff(o,a))*Math.PI*.5,u=(0,h.GJ)(o+d,"radians","geographic"),p=(0,l.Ue)(),g=s.geodesicDistance(i,n,r);return null!=g&&((0,w.LH)(p,i,r,(0,h.mE)(g,"meters"),u,"geodesic"),(0,j.d)(e,p,i),!0)})(e,t,i,n,r,s)||function(e,t,i){const n=(0,g.$X)(C,(0,u.eR)(i),(0,u.eR)(t));(0,j.i)(e,n[1],-n[0],0)}(e,t,i)})(U,f,p,s,a,this._geodesicLengthMeasurementUtils),this._checkForSnappingCandidateAlongProjectedRay(e,t,f,p,U,s,o,a)}_checkForSnappingCandidateAlongProjectedRay(e,t,i,n,r,s,o,a){const{spatialReference:c,pointer:h}=a,p=(0,g.$X)(C,(0,u.eR)(s),(0,u.eR)(n)),f=(0,g.AK)(r,p)/(0,g.we)(r),R=(0,g.od)(C,(0,u.eR)(n),r,f),E=(0,u.s)((0,u.al)(R[0],R[1],s[2]));if((0,x.Bb)(o,(0,v.R)(E,c,d.jG,this.view))>this.squaredProximityThreshold(h)||this.isVertical(E,n,a)||this.isVertical(n,i,a))return;const w=(0,j.b)((0,l.Ue)(),n,r,Math.sign(f));t.push(new G.A1({targetPoint:E,constraint:new P.aU(n,(0,u.uo)(w)),previousVertex:i,otherVertex:n,otherVertexType:G.YJ.CENTER,selfSnappingType:e,isDraped:"on-the-ground"===a.elevationInfo?.mode}))}}const C=(0,V.Ue)(),U=(0,l.Ue)();var k=i(66445);class M extends R{snapNewVertex(e,t){const i=t.editGeometryOperations.data.components[0],n=[],r=i.vertices.length;if("polygon"!==t.editGeometryOperations.data.type||r<2)return n;const{view:s}=this,o=i.vertices[0],a=i.vertices[r-1],c=(0,u.j7)(o.pos,s,t),h=(0,u.j7)(a.pos,s,t);return this._processCandidateProposal(c,h,e,t,n),n}snapExistingVertex(e,t){const i=[],n=t.vertexHandle,r=n.component;if(r.edges.length<2)return i;if("polyline"===t.editGeometryOperations.data.type&&(0===n.index||n.index===r.vertices.length-1))return i;const{view:s}=this,o=(0,u.j7)(n.leftEdge.leftVertex.pos,s,t),a=(0,u.j7)(n.rightEdge.rightVertex.pos,s,t);return this._processCandidateProposal(o,a,e,t,i),i}_processCandidateProposal(e,t,i,n,r){if(!this.exceedsShortLineThreshold(e,t,n))return;const s=(0,g.t7)(q,(0,u.eR)(e),(0,u.eR)(t),.5),o=.5*(0,g.TE)((0,u.eR)(e),(0,u.eR)(t)),a=(0,_.xO)(q,(0,u.eR)(i),s,o),c=(0,u.s)((0,u.al)(a[0],a[1],i[2])),{spatialReference:h,pointer:l}=n,p=(0,v.R)(i,h,d.jG,this.view);if((0,x.Bb)(p,(0,v.R)(c,h,d.jG,this.view))<this.squaredProximityThreshold(l)){if(this.isVertical(e,c,n)||this.isVertical(c,t,n))return;r.push(new k.K({targetPoint:c,point1:e,point2:t,isDraped:"on-the-ground"===n.elevationInfo?.mode}))}}}const q=(0,V.Ue)();var F=i(13707);let B=class extends r.Z{constructor(e){super(e),this.updating=!1,this._snappers=new s.Z,this._domain=F.B.SELF}initialize(){this._snappers.push(new y(this.view,this.options),new L(this.view,this.options,this.geodesicLengthMeasurementUtils),new b(this.view,this.options,this.geodesicLengthMeasurementUtils),new M(this.view,this.options))}set options(e){this._set("options",e);for(const t of this._snappers)t.options=e}async fetchCandidates(e,t,i){if(!(t&this._domain&&this.options.effectiveSelfEnabled))return[];const n=[];for(const t of this._snappers.items)for(const r of t.snap(e,i))n.push(r);return(0,x.lQ)(e,n),n}};(0,n._)([(0,o.Cb)({readOnly:!0})],B.prototype,"updating",void 0),(0,n._)([(0,o.Cb)({constructOnly:!0})],B.prototype,"view",void 0),(0,n._)([(0,o.Cb)({constructOnly:!0})],B.prototype,"geodesicLengthMeasurementUtils",void 0),(0,n._)([(0,o.Cb)()],B.prototype,"options",null),B=(0,n._)([(0,a.j)("esri.views.interactive.snapping.SelfSnappingEngine")],B)},53257:function(e,t,i){i.d(t,{Ci:function(){return w},LH:function(){return _},Lm:function(){return f},d3:function(){return m},ib:function(){return V},n6:function(){return v},uE:function(){return n},yd:function(){return L},zS:function(){return R}});var n,r,s=i(95437),o=i(1925),a=i(26636),c=i(26821),h=i(41788),l=i(24910),d=i(82846),u=i(2051),p=i(95872),g=i(8554);function f(e,t){if(null==e||null==t)return;const i=x(e,t);return null!=i?(0,o.GJ)(i,"radians","geographic"):void 0}(r=n||(n={})).Absolute="absolute",r.Relative="relative",r.RelativeBilateral="relative-bilateral";const x=(()=>{const e=(0,d.Ue)(),t=(0,d.Ue)();return(i,n)=>((0,l.i)(e,i.x,i.y,i.z??0),(0,l.i)(t,n.x,n.y,n.z??0),v(e,t,i.spatialReference,n.spatialReference))})(),v=(()=>{const e=(0,h.Ue)(),t=(0,d.Ue)(),i=(0,d.Ue)();return(n,r,s,o)=>{if((0,l.q)(n,r))return;const d=(0,p.Lc)(s),f=(0,p.Lc)(o);if(d&&f&&(0,g.fS)(d,f)&&(0,u.S)(n,s,t,d)&&(0,u.S)(r,o,i,f)){const{azimuth:e}=(0,p.cA)(y,t,i,d);return null!=e?(0,a.En)(e,"degrees","radians"):void 0}e[0]=r[0]-n[0],e[1]=r[1]-n[1];let x=(0,c.EU)(h.IO,e);return e[0]<0&&(x=T-x),x}})();function R(e,t,i,r=n.Absolute){if(t&&i)switch(r){case n.Absolute:return f(t,i);case n.Relative:return w(E(e,t,i),n.Relative);case n.RelativeBilateral:return w(E(e,t,i),n.RelativeBilateral)}}function E(e,t,i){if(!e||!t||!i)return;const n=x(e,t),r=x(t,i);return null!=n&&null!=r?(0,o.GJ)(r-n,"radians","geographic"):void 0}function w(e,t){if(null!=e)switch(t){case n.Absolute:return m(e);case n.Relative:{const t=L(e);let i=P.normalize(t,0,!0);return-180===i&&(i=180),(0,o.GJ)(i,"degrees","geographic")}case n.RelativeBilateral:{const t=L(e),i=Math.abs(P.normalize(t,0,!0));return(0,o.GJ)(i,"degrees","geographic")}}}function m(e){const t=L(e),i=j.normalize(t,0,!0);return(0,o.GJ)(i,"degrees","geographic")}const _=(()=>{const e=(0,d.Ue)();return(t,i,n,r,s,c="geodesic")=>{(0,l.c)(e,i);const h=L(s);if("geodesic"===c){const s=(0,p.Lc)(n);if(s&&(0,u.S)(e,n,e,s))return(0,p.TB)(t,e,h,r,s),t[2]=i[2],!!(0,u.S)(t,s,t,n)}const d=(0,o.hw)(h,"geographic","arithmetic"),g=(0,a.En)(d,"degrees","radians"),f=i[0]+r*Math.cos(g),x=i[1]+r*Math.sin(g),v=i[2];return(0,l.i)(t,f,x,v),!0}})();function L(e){if(null!=e)return(0,o.hw)(S(e),e.rotationType,"geographic")}function V(e){if(null!=e)return(0,o.hw)(S(e),e.rotationType,"arithmetic")}function S(e){return(0,a.En)(e.value,e.unit,"degrees")}const y=new p._q,T=2*Math.PI,j=s.BV,P=new s.pE(-180,180)}}]);