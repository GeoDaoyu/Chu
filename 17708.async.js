"use strict";(self.webpackChunkscene_pro=self.webpackChunkscene_pro||[]).push([[17708],{87422:function(e,t,s){s.d(t,{Z:function(){return o}});var r=s(53227),i=s(18002);class o{constructor(e){this._observable=new i.s,this._map=new Map(e)}get size(){return(0,r.it)(this._observable),this._map.size}clear(){this._map.size>0&&(this._map.clear(),this._observable.notify())}delete(e){const t=this._map.delete(e);return t&&this._observable.notify(),t}entries(){return(0,r.it)(this._observable),this._map.entries()}forEach(e,t){(0,r.it)(this._observable),this._map.forEach(((s,r)=>e.call(t,s,r,this)),t)}get(e){return(0,r.it)(this._observable),this._map.get(e)}has(e){return(0,r.it)(this._observable),this._map.has(e)}keys(){return(0,r.it)(this._observable),this._map.keys()}set(e,t){return this._map.set(e,t),this._observable.notify(),this}values(){return(0,r.it)(this._observable),this._map.values()}[Symbol.iterator](){return(0,r.it)(this._observable),this._map[Symbol.iterator]()}[Symbol.dispose](){this._observable.destroy()}get[Symbol.toStringTag](){return this._map[Symbol.toStringTag]}}},60147:function(e,t,s){s.d(t,{R:function(){return c}});var r=s(73440),i=s(70880),o=s(50702),n=s(90403),l=s(99153),a=s(17155),h=s(48023);let c=class extends i.Z{constructor(){super(...arguments),this.updating=!1,this._handleId=0,this._scheduleHandleId=0,this._pendingPromises=new Set}destroy(){this.removeAll()}add(e,t,s={}){return this._installWatch(e,t,s,n.YP)}addWhen(e,t,s={}){return this._installWatch(e,t,s,n.gx)}addOnCollectionChange(e,t,{initial:s=!1,final:r=!1}={}){const i=++this._handleId;return this.addHandles([(0,n.on)(e,"after-changes",this._createSyncUpdatingCallback(),n.Z_),(0,n.on)(e,"change",t,{onListenerAdd:s?e=>t({added:e.toArray(),removed:[]}):void 0,onListenerRemove:r?e=>t({added:[],removed:e.toArray()}):void 0})],i),(0,o.kB)((()=>this.removeHandles(i)))}addPromise(e){if(null==e)return e;const t=++this._handleId;this.addHandles((0,o.kB)((()=>{this._pendingPromises.delete(e)&&(0!==this._pendingPromises.size||this.hasHandles(u)||this._set("updating",!1))})),t),this._pendingPromises.add(e),this._set("updating",!0);const s=()=>this.removeHandles(t);return e.then(s,s),e}removeAll(){this._pendingPromises.clear(),this.removeAllHandles(),this._set("updating",!1)}_installWatch(e,t,s={},r){const i=++this._handleId;s.sync||this._installSyncUpdatingWatch(e,i);const n=r(e,t,s);return this.addHandles(n,i),(0,o.kB)((()=>this.removeHandles(i)))}_installSyncUpdatingWatch(e,t){const s=this._createSyncUpdatingCallback(),r=(0,n.YP)(e,s,{sync:!0,equals:()=>!1});return this.addHandles(r,t),r}_createSyncUpdatingCallback(){return()=>{this.removeHandles(u),++this._scheduleHandleId;const e=this._scheduleHandleId;this._get("updating")||this._set("updating",!0),this.addHandles((0,l.Os)((()=>{e===this._scheduleHandleId&&(this._set("updating",this._pendingPromises.size>0),this.removeHandles(u))})),u)}}};(0,r._)([(0,a.Cb)({readOnly:!0})],c.prototype,"updating",void 0),c=(0,r._)([(0,h.j)("esri.core.support.UpdatingHandles")],c);const u=-42},10813:function(e,t,s){s.d(t,{B:function(){return m},J:function(){return g}});var r=s(88194),i=s(96711),o=s(48797),n=s(60646),l=s(40030),a=s(56575),h=s(76554),c=s(48837),u=s(15065),d=s(82377);const f=()=>i.Z.getLogger("esri.layers.support.labelFormatUtils"),_={type:"simple",evaluate:()=>null},p={getAttribute:(e,t)=>e.field(t)};async function g(e,t,s){if(!e||!e.symbol||!t)return _;const i=e.where,n=(0,c.hV)(e);let l;if("arcade"===n.type){const e=(0,d.b)(n.expression),i=t.get(e);if(i&&((0,h.Vo)(i)||(0,h.H7)(i)||(0,h.qN)(i)))l={type:"simple",evaluate(e){const t="attributes"in e?e.attributes?.[i.name]:e.field(i.name);return null==t?"":t.toString()}};else{const e=await(0,u.WW)(n.expression,s);if(null==e)return _;l={type:"arcade",evaluate(s,i){try{const r="attributes"in s?e.repurposeFeature(s,t):s;r.contextTimeZone=i??null;const o=e.evaluate(r,{$view:{timeZone:i}});if(null!=o)return o.toString()}catch(e){f().error(new r.Z("arcade-expression-error","Encountered an error when evaluating label expression for feature",{error:e,feature:s,expression:n}))}return null},needsHydrationToEvaluate:()=>null==(0,c.el)(n.expression)}}}else l={type:"simple",evaluate:e=>n.expression.replaceAll(/{[^}]*}/g,(s=>{const r=s.slice(1,-1),i=t.get(r);if(!i)return s;let o=null;return o="attributes"in e?e?.attributes?.[i.name]:e.field(i.name),null==o?"":m(o,i)}))};if(i){let e;try{e=await(0,o.EP)(i,t)}catch(e){return f().error(new r.Z("bad-where-clause","Encountered an error when evaluating where clause, ignoring",{where:i,error:e})),_}const s=l.evaluate;l.evaluate=(t,o)=>{const n="attributes"in t?void 0:p;try{if(e.testFeature(t,n))return s(t,o)}catch(e){f().error(new r.Z("bad-where-clause","Encountered an error when evaluating where clause for feature",{where:i,feature:t,error:e}))}return null}}return l}function m(e,t){if(null==e)return"";const s=t.domain;if(s)if("codedValue"===s.type||"coded-value"===s.type){const t=e;for(const e of s.codedValues)if(e.code===t)return e.name}else if("range"===s.type){const{max:r,min:i}=(0,a.D3)(t),o=+e;if(null!=i&&null!=r&&i<=o&&o<=r)return s.name}let r=e;return(0,h.y2)(t)?r=(0,n.p6)(r,(0,n.Ze)("short-date")):(0,h.H7)(t)&&(r=(0,l.uf)(+r)),r||""}},93333:function(e,t,s){s.d(t,{F:function(){return i},o:function(){return o}});var r=s(90756);function i(e){return{geometryType:(0,r.Ji)(e[0]),geometries:e.map((e=>e.toJSON()))}}function o(e,t,s){const i=(0,r.q9)(t);return e.map((e=>{const t=i.fromJSON(e);return t.spatialReference=s,t}))}},56545:function(e,t,s){s.d(t,{LP:function(){return u},cv:function(){return c},en:function(){return h},lA:function(){return a}});var r=s(81001),i=s(10218),o=s(28947),n=s(95490),l=s(82674);function a(e,t){return t?{...t,query:{...e??{},...t.query}}:{query:e}}function h(e){return"string"==typeof e?(0,n.mN)(e):(0,o.d9)(e)}function c(e,t,s){const r={};for(const i in e){if("declaredClass"===i)continue;const o=e[i];if(null!=o&&"function"!=typeof o)if(Array.isArray(o))r[i]=o.map((e=>c(e)));else if("object"==typeof o)if(o.toJSON){const e=o.toJSON(s?.[i]);r[i]=t?e:JSON.stringify(e)}else r[i]=t?o:JSON.stringify(o);else r[i]=o}return r}async function u(e,t,o){const n=function(e,t){return e?t&&(0,l.rU)(e)?t:(0,l.Pi)(e)??i.id?.findCredential(e)?.token:null}(e,t);if(n)return n;!i.id&&r.default.request.useIdentity&&await s.e(39428).then(s.bind(s,39428));return(await i.id.getCredential(e,o))?.token}},65244:function(e,t,s){s.d(t,{Z:function(){return o}});var r=s(77450),i=s(64544);class o{constructor(){this.spans=[]}static{this.pool=new r.Z(o)}acquire(e){this.lodInfo=e}release(){this.lodInfo=null,this.spans.length=0}*keys(){const e=this.lodInfo;for(const{row:t,colFrom:s,colTo:r}of this.spans)for(let o=s;o<=r;o++){const s=e.getWorldForColumn(o);yield new i.Z(e.level,t,e.normalizeCol(o),s)}}forEach(e,t){const{spans:s,lodInfo:r}=this,{level:i}=r;if(0!==s.length)for(const{row:o,colFrom:n,colTo:l}of s)for(let s=n;s<=l;s++)e.call(t,i,o,r.normalizeCol(s),r.getWorldForColumn(s))}}},71090:function(e,t,s){s.d(t,{Z:function(){return _}});var r=s(8554),i=s(64544);function o(e,t){return[e,t]}function n(e,t,s){return e[0]=t,e[1]=s,e}const l=new i.Z("0/0/0/0");class a{static create(e,t,s=null){const i=(0,r.C5)(e.spatialReference),l=t.origin||o(e.origin.x,e.origin.y),h=o(e.size[0]*t.resolution,e.size[1]*t.resolution),c=o(-1/0,-1/0),u=o(1/0,1/0),d=o(1/0,1/0);null!=s&&(n(c,Math.max(0,Math.floor((s.xmin-l[0])/h[0])),Math.max(0,Math.floor((l[1]-s.ymax)/h[1]))),n(u,Math.max(0,Math.floor((s.xmax-l[0])/h[0])),Math.max(0,Math.floor((l[1]-s.ymin)/h[1]))),n(d,u[0]-c[0]+1,u[1]-c[1]+1));const{cols:f,rows:_}=t;let p,g,m,y;return!s&&f&&_&&(n(c,f[0],_[0]),n(u,f[1],_[1]),n(d,f[1]-f[0]+1,_[1]-_[0]+1)),e.isWrappable?(p=o(Math.ceil(Math.round((i.valid[1]-i.valid[0])/t.resolution)/e.size[0]),d[1]),g=!0,m=i.origin,y=i.valid):(p=d,g=!1),new a(t.level,t.resolution,t.scale,l,c,u,d,h,p,g,m,y)}constructor(e,t,s,r,i,o,n,l,a,h,c,u){this.level=e,this.resolution=t,this.scale=s,this.origin=r,this.first=i,this.last=o,this.size=n,this.norm=l,this.worldSize=a,this.wrap=h,this._spatialReferenceOrigin=c,this._spatialReferenceValid=u}normalizeCol(e){if(!this.wrap)return e;const t=this.worldSize[0];return e<0?t-1-Math.abs((e+1)%t):e%t}normalizeKey(e){if(!this.wrap)return;const t=this.worldSize[0],s=e.col;s<0?(e.col=s+t,e.world-=1):s>=t&&(e.col=s-t,e.world+=1)}denormalizeCol(e,t){return this.wrap?this.worldSize[0]*t+e:e}getWorldForColumn(e){return this.wrap?Math.floor(e/this.worldSize[0]):0}getFirstColumnForWorld(e){return e*this.worldSize[0]+this.first[0]}getLastColumnForWorld(e){return e*this.worldSize[0]+this.first[0]+this.size[0]-1}getColumnForX(e){return(e-this.origin[0])/this.norm[0]}getXForColumn(e){const t=this.origin[0]+e*this.norm[0],s=this._spatialReferenceOrigin,r=this._spatialReferenceValid;return this.wrap&&s&&r?t===s[0]?r[0]:this.origin[0]===s[0]&&e===this.worldSize[0]?r[1]:t:t}getRowForY(e){return(this.origin[1]-e)/this.norm[1]}getYForRow(e){return this.origin[1]-e*this.norm[1]}getTileBounds(e,t,s=!1){l.set(t);const r=s?l.col:this.denormalizeCol(l.col,l.world),i=l.row;return function(e,t,s,r,i){e[0]=t,e[1]=s,e[2]=r,e[3]=i}(e,this.getXForColumn(r),this.getYForRow(i+1),this.getXForColumn(r+1),this.getYForRow(i)),e}getTileCoords(e,t,s=!1){l.set(t);const r=s?l.col:this.denormalizeCol(l.col,l.world);return Array.isArray(e)?n(e,this.getXForColumn(r),this.getYForRow(l.row)):(e.x=this.getXForColumn(r),e.y=this.getYForRow(l.row)),e}}var h=s(65244);class c{constructor(e,t,s){this.row=e,this.colFrom=t,this.colTo=s}}const u=new i.Z("0/0/0/0");class d{static create(e,t){e[1]>t[1]&&([e,t]=[t,e]);const[s,r]=e,[i,o]=t,n=i-s,l=o-r,a=0!==l?n/l:0,h=(Math.ceil(r)-r)*a,c=(Math.floor(r)-r)*a;return new d(s,Math.floor(r),Math.ceil(o),a,n<0?h:c,n<0?c:h,n<0?i:s,n<0?s:i)}constructor(e,t,s,r,i,o,n,l){this.x=e,this.ymin=t,this.ymax=s,this.invM=r,this.leftAdjust=i,this.rightAdjust=o,this.leftBound=n,this.rightBound=l}incrRow(){this.x+=this.invM}getLeftCol(){return Math.max(this.x+this.leftAdjust,this.leftBound)}getRightCol(){return Math.min(this.x+this.rightAdjust,this.rightBound)}}const f=[[0,0],[0,0],[0,0],[0,0]];class _{constructor(e,t=null,s=e.lods[0].level,r=e.lods[e.lods.length-1].level){this.tileInfo=e,this.fullExtent=t,this.scales=[],this._infoByScale={},this._infoByLevel={};const i=e.lods.filter((e=>e.level>=s&&e.level<=r));this.minScale=i[0].scale,this.maxScale=i[i.length-1].scale;const o=this._lodInfos=i.map((s=>a.create(e,s,t)));i.forEach(((e,t)=>{this._infoByLevel[e.level]=o[t],this._infoByScale[e.scale]=o[t],this.scales[t]=e.scale}),this),this._wrap=e.isWrappable}get spatialReference(){return this.tileInfo.spatialReference}getLODInfoAt(e){return this._infoByLevel["number"==typeof e?e:e.level]}getTileBounds(e,t,s=!1){u.set(t);const r=this._infoByLevel[u.level];return r?r.getTileBounds(e,u,s):e}getTileCoords(e,t,s=!1){u.set(t);const r=this._infoByLevel[u.level];return r?r.getTileCoords(e,u,s):e}getTileCoverage(e,t=192,s=!0,r="closest"){if(!s&&(e.scale>this.minScale||e.scale<this.maxScale))return null;const i="closest"===r?this.getClosestInfoForScale(e.scale):this.getSmallestInfoForScale(e.scale),o=h.Z.pool.acquire(i),n=this._wrap;let l,a,u,_=1/0,p=-1/0;const g=o.spans;f[0][0]=f[0][1]=f[1][1]=f[3][0]=-t,f[1][0]=f[2][0]=e.size[0]+t,f[2][1]=f[3][1]=e.size[1]+t;for(const t of f)e.toMap(t,t),t[0]=i.getColumnForX(t[0]),t[1]=i.getRowForY(t[1]);const m=[];let y=3;for(let e=0;e<4;e++){if(f[e][1]===f[y][1]){y=e;continue}const t=d.create(f[e],f[y]);_=Math.min(t.ymin,_),p=Math.max(t.ymax,p),void 0===m[t.ymin]&&(m[t.ymin]=[]),m[t.ymin].push(t),y=e}if(null==_||null==p||p-_>100)return null;let v=[];for(l=_;l<p;){null!=m[l]&&(v=v.concat(m[l])),a=1/0,u=-1/0;for(let e=v.length-1;e>=0;e--){const t=v[e];a=Math.min(a,t.getLeftCol()),u=Math.max(u,t.getRightCol())}if(a=Math.floor(a),u=Math.floor(u),l>=i.first[1]&&l<=i.last[1])if(n)if(i.size[0]<i.worldSize[0]){const e=Math.floor(u/i.worldSize[0]);for(let t=Math.floor(a/i.worldSize[0]);t<=e;t++)g.push(new c(l,Math.max(i.getFirstColumnForWorld(t),a),Math.min(i.getLastColumnForWorld(t),u)))}else g.push(new c(l,a,u));else a>i.last[0]||u<i.first[0]||(a=Math.max(a,i.first[0]),u=Math.min(u,i.last[0]),g.push(new c(l,a,u)));l+=1;for(let e=v.length-1;e>=0;e--){const t=v[e];t.ymax>=l?t.incrRow():v.splice(e,1)}}return o}getTileParentId(e){u.set(e);const t=this._infoByLevel[u.level],s=this._lodInfos.indexOf(t)-1;return s<0?null:(this._getTileIdAtLOD(u,this._lodInfos[s],u),u.id)}getTileResolution(e){const t=this._infoByLevel["object"==typeof e?e.level:e];return t?t.resolution:-1}getTileScale(e){const t=this._infoByLevel[e.level];return t?t.scale:-1}intersects(e,t){u.set(t);const s=this._infoByLevel[u.level],r=e.lodInfo;if(r.resolution>s.resolution){this._getTileIdAtLOD(u,r,u);const t=r.denormalizeCol(u.col,u.world);for(const s of e.spans)if(s.row===u.row&&s.colFrom<=t&&s.colTo>=t)return!0}if(r.resolution<s.resolution){const[t,i,o,n]=e.spans.reduce(((e,t)=>(e[0]=Math.min(e[0],t.row),e[1]=Math.max(e[1],t.row),e[2]=Math.min(e[2],t.colFrom),e[3]=Math.max(e[3],t.colTo),e)),[1/0,-1/0,1/0,-1/0]),l=s.denormalizeCol(u.col,u.world),a=r.getColumnForX(s.getXForColumn(l)),h=r.getRowForY(s.getYForRow(u.row)),c=r.getColumnForX(s.getXForColumn(l+1))-1,d=r.getRowForY(s.getYForRow(u.row+1))-1;return!(a>n||c<o||h>i||d<t)}const i=r.denormalizeCol(u.col,u.world);return e.spans.some((e=>e.row===u.row&&e.colFrom<=i&&e.colTo>=i))}normalizeBounds(e,t,s){if(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],this._wrap){const t=(0,r.C5)(this.tileInfo.spatialReference),i=-s*(t.valid[1]-t.valid[0]);e[0]+=i,e[2]+=i}return e}getSmallestInfoForScale(e){const t=this.scales;if(this._infoByScale[e])return this._infoByScale[e];if(e>t[0])return this._infoByScale[t[0]];for(let s=1;s<t.length-1;s++)if(e>t[s]+1e-6)return this._infoByScale[t[s-1]];return this._infoByScale[t[t.length-1]]}getClosestInfoForScale(e){const t=this.scales;return this._infoByScale[e]||(e=t.reduce(((t,s)=>Math.abs(s-e)<Math.abs(t-e)?s:t),t[0])),this._infoByScale[e]}scaleToLevel(e){const t=this.scales;if(this._infoByScale[e])return this._infoByScale[e].level;for(let s=t.length-1;s>=0;s--)if(e<t[s])return s===t.length-1?this._infoByScale[t[t.length-1]].level:this._infoByScale[t[s]].level+(t[s]-e)/(t[s]-t[s+1]);return this._infoByScale[t[0]].level}scaleToZoom(e){return this.tileInfo.scaleToZoom(e)}zoomToScale(e){return this.tileInfo.zoomToScale(e)}_getTileIdAtLOD(e,t,s){const r=this._infoByLevel[s.level];return e.set(s),t.resolution<r.resolution?null:(t.resolution===r.resolution||(e.level=t.level,e.col=Math.floor(s.col*r.resolution/t.resolution+.01),e.row=Math.floor(s.row*r.resolution/t.resolution+.01)),e)}}},85600:function(e,t,s){var r=s(73440),i=s(70880),o=s(79577),n=s(61100),l=s(74355),a=s(17155),h=(s(61432),s(96711),s(83850),s(48023)),c=s(26821),u=s(75015);const d=[0,0];let f=class extends i.Z{constructor(e){super(e),this._keyToItem=new Map,this._tilesByScale=new Map,this.concurrency=6}initialize(){const{concurrency:e,process:t,scheduler:s,priority:r}=this;this._queue=new u.c({concurrency:e,scheduler:s,priority:r,process:(e,s)=>{const r=this._keyToItem.get(e);return t(r,{signal:s})},peeker:e=>this._peek(e)})}destroy(){this.clear(),this._queue=(0,n.SC)(this._queue)}get length(){return this._queue?this._queue.length:0}abort(e){const t="string"==typeof e?e:e.id;this._queue.abort(t)}clear(){this._queue.clear(),this._keyToItem.clear(),this._tilesByScale.clear()}has(e){return"string"==typeof e?this._keyToItem.has(e):this._keyToItem.has(e.id)}pause(){this._queue.pause()}push(e){const t=e.key.id;if(this._queue.has(t))return this._queue.get(t);const s=this._queue.push(t),r=this.tileInfoView.getTileScale(e.key),i=(0,o.s1)(this._tilesByScale,r,(()=>new Set)),n=()=>{i.delete(e.key),0===i.size&&this._tilesByScale.delete(r),this._keyToItem.delete(t)};return i.add(e.key),this._keyToItem.set(t,e),s.then(n,n),s}reset(){this._queue.reset()}resume(){this._queue.resume()}_peek(e){if(!this.state)return e.values().next().value;const t=new Set;for(const s of e)t.add(this._keyToItem.get(s).key);const s=this.state.scale;let r,i=Number.POSITIVE_INFINITY;for(const[e,o]of this._tilesByScale)if((0,l.fn)(o,(e=>t.has(e)))){const t=Math.abs(e-s);t<i&&(r=o,i=t)}return this._getClosestTileKey(r,e).id}_getClosestTileKey(e,t){const s=this.tileInfoView,r=this.state.center;let i,o=Number.POSITIVE_INFINITY;for(const n of e)if(t.has(n.id)){s.getTileCoords(d,n);const e=(0,c.TE)(d,r);e<o&&(o=e,i=n)}return i}};(0,r._)([(0,a.Cb)({constructOnly:!0})],f.prototype,"concurrency",void 0),(0,r._)([(0,a.Cb)({constructOnly:!0})],f.prototype,"priority",void 0),(0,r._)([(0,a.Cb)({constructOnly:!0})],f.prototype,"process",void 0),(0,r._)([(0,a.Cb)({constructOnly:!0})],f.prototype,"scheduler",void 0),(0,r._)([(0,a.Cb)()],f.prototype,"state",void 0),(0,r._)([(0,a.Cb)({constructOnly:!0})],f.prototype,"tileInfoView",void 0),f=(0,r._)([(0,h.j)("esri.views.2d.tiling.TileQueue")],f)},13772:function(e,t,s){s(47566),s(26821);s(65244);new(s(64544).Z)(0,0,0,0),new Map},75015:function(e,t,s){s.d(t,{c:function(){return c}});s(61432);var r=s(61100),i=s(93568),o=s(92462),n=s(87422),l=s(99153),a=s(39355);class h{constructor(e,t){this.item=e,this.controller=t,this.promise=null}}class c{constructor(e){this._schedule=null,this._task=null,this._deferreds=new n.Z,this._controllers=new n.Z,this._processingItems=new n.Z,this._pausedSignal=(0,a.t)(!1),this.concurrency=1,e.concurrency&&(this.concurrency=e.concurrency),this._queue=new o.Z(e.peeker),this.process=e.process;const t=e.scheduler;e.priority&&t&&(this._task=t.registerTask(e.priority,this))}destroy(){this.clear(),this._schedule=(0,r.hw)(this._schedule),this._task=(0,r.hw)(this._task)}get updating(){return!!this._task?.updating||this.running}get length(){return this._processingItems.size+this._queue.length}abort(e){const t=this._controllers.get(e);t&&t.abort()}clear(){this._queue.clear();const e=[];this._controllers.forEach((t=>e.push(t))),this._controllers.clear(),e.forEach((e=>e.abort())),this._processingItems.clear(),this._cancelNext()}forEach(e){this._deferreds.forEach(((t,s)=>e(s)))}get(e){const t=this._deferreds.get(e);return t?t.promise:void 0}isOngoing(e){return this._processingItems.has(e)}has(e){return this._deferreds.has(e)}pause(){this._pausedSignal.value||(this._pausedSignal.value=!0,this._cancelNext())}push(e,t){const s=this.get(e);if(s)return s;const r=new AbortController;let o=null;t&&(o=(0,i.fu)(t,(()=>r.abort())));const n=()=>{l.remove(),null!=o&&o.remove(),this._removeItem(e),this._queue.remove(e),this._scheduleNext()},l=(0,i.$F)(r.signal,(()=>{const t=this._processingItems.get(e);t&&t.controller.abort(),n(),a.reject((0,i.zE)())})),a=(0,i.hh)();return this._deferreds.set(e,a),this._controllers.set(e,r),a.promise.then(n,n),this._queue.push(e),this._scheduleNext(),a.promise}last(){return this._queue.last()}lastPromise(){const e=this.last();return e?this.get(e):null}peek(){return this._queue.peek()}popLast(){const e=this._queue.popLast();return e&&(this._deferreds.get(e)?.reject((0,i.zE)()),this._removeItem(e)),e}reset(){const e=Array.from(this._processingItems.values());this._processingItems.clear();for(const t of e)this._queue.push(t.item),t.controller.abort();this._scheduleNext()}resume(){this._pausedSignal.value&&(this._pausedSignal.value=!1,this._scheduleNext())}takeAll(){const e=[];for(;this._queue.length;)e.push(this._queue.pop());return this.clear(),e}get running(){return!this._pausedSignal.value&&this._queue.length>0&&this._processingItems.size<this.concurrency}runTask(e){for(;!e.done&&this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),e.madeProgress()}_removeItem(e){this._deferreds.delete(e),this._controllers.delete(e),this._processingItems.delete(e)}_scheduleNext(){this._task||this._pausedSignal.value||this._schedule||(this._schedule=(0,l.Os)((()=>{this._schedule=null,this._next()})))}_next(){for(;this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())}_cancelNext(){this._schedule&&(this._schedule.remove(),this._schedule=null)}_processResult(e,t){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).resolve(t))}_processError(e,t){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).reject(t))}_canProcessFulfillment(e){return!!this._deferreds.get(e.item)&&this._processingItems.get(e.item)===e}_process(e){if(null==e)return;let t;const s=new AbortController,r=new h(e,s);this._processingItems.set(e,r);try{t=this.process(e,s.signal)}catch(e){this._processError(r,e)}(0,i.y8)(t)?(r.promise=t,t.then((e=>this._processResult(r,e)),(e=>this._processError(r,e)))):this._processResult(r,t)}get test(){}}}}]);