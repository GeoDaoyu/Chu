"use strict";(self.webpackChunkscene_pro=self.webpackChunkscene_pro||[]).push([[80326],{12853:function(e,t,n){n.d(t,{z:function(){return r}});var i=n(69071);class r{constructor(e,t){this.removeFunc=t,this._storage=new i.WJ,this.id="",this.name="",this.size=0,this._storage.maxSize=e,this._storage.register(this)}destroy(){this._storage.deregister(this),this._storage.destroy()}put(e,t,n=1){this._storage.put(this,e,t,n,1)}pop(e){return this._storage.pop(this,e)}get(e){return this._storage.get(this,e)}clear(){this._storage.clearAll()}get maxSize(){return this._storage.maxSize}set maxSize(e){this._storage.maxSize=e}resetHitRate(){}}},30062:function(e,t,n){function i(e){let t,n,i=[],r=!1;return function(...s){return r&&t===this&&function(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0}(s,i)||(n=e.apply(this,s),t=this,i=s,r=!0),n}}n.d(t,{H:function(){return i}})},51429:function(e,t,n){n.d(t,{x:function(){return o}});var i=n(88190),r=n(42022),s=n(60162);class o extends r.a{constructor(e){super({...e,constraint:new i.Hk(e.targetPoint)})}get hints(){return[new s.n(this.targetPoint,this.isDraped,this.domain)]}}},80326:function(e,t,n){n.r(t),n.d(t,{FeatureCollectionSnappingSource:function(){return _}});var i=n(73440),r=n(70880),s=n(30062),o=n(93568),a=n(90403),c=n(48797),u=n(17155),l=(n(61432),n(96711),n(83850),n(48023)),h=n(51870),p=n(29668),d=n(23989),g=n(18012),y=n(6733),f=n(46264);let _=class extends r.Z{get availability(){return 1}get _snappingElevationAligner(){const{view:e}=this,{layer:t}=this.layerSource,n=null!=e&&"3d"===e.type;if(!n||"subtype-group"===t.type)return(0,g.p)();return(0,g.p)(n,{elevationInfo:t.elevationInfo,alignPointsInFeatures:async(n,i)=>(await(0,o.Hl)(e.whenLayerView(t),i)).elevationAlignPointsInFeatures(n,i)})}get _snappingElevationFilter(){const{view:e}=this,t=null!=e&&"3d"===e.type&&"subtype-group"!==this.layerSource.layer.type;return(0,y.c)(t)}get _symbologySnappingFetcher(){const{view:e}=this,{layer:t}=this.layerSource;return null!=e&&"3d"===e.type&&"subtype-group"!==t.type?(0,f.k)(this._symbologySnappingSupported,(async(n,i)=>{const r=await e.whenLayerView(t);return(0,o.k_)(i),r.queryForSymbologySnapping({candidates:n,spatialReference:e.spatialReference},i)})):(0,f.k)()}get _layerView(){const{view:e}=this;if(null==e)return null;const{layer:t}=this.layerSource;return e.allLayerViews.find((e=>e.layer===t))}get _layerView3D(){const{view:e}=this;return null==e||"2d"===e.type?null:this._layerView}get _symbologySnappingSupported(){return null!=this._layerView3D&&this._layerView3D.symbologySnappingSupported}initialize(){const{view:e}=this,{layer:t}=this.layerSource;null!=e&&"3d"===e.type&&"subtype-group"!==t.type&&this.addHandles([e.elevationProvider.on("elevation-change",(({context:e})=>{const{elevationInfo:n}=t;(0,h.W_)(e,n)&&this._snappingElevationAligner.notifyElevationSourceChange()})),(0,a.YP)((()=>t.elevationInfo),(()=>this._snappingElevationAligner.notifyElevationSourceChange()),a.nn),(0,a.YP)((()=>null!=this._layerView3D?this._layerView3D.layer?.renderer:null),(()=>this._symbologySnappingFetcher.notifySymbologyChange()),a.nn),(0,a.on)((()=>this._layerView3D?.layer),["edits","apply-edits","graphic-update"],(()=>this._symbologySnappingFetcher.notifySymbologyChange()))])}constructor(e){super(e),this.view=null,this.updating=!1,this._memoizedMakeGetGroundElevation=(0,s.H)(d.g)}refresh(){}async fetchCandidates(e,t){const{layer:n}=this.layerSource,{source:i}=n;if(!i?.querySnapping)return[];const r=n.createQuery();this._layerView&&"effectiveDisplayFilter"in this._layerView&&(r.where=(0,c._$)(r.where,this._layerView.effectiveDisplayFilter?.where));const s="returnZ"in n?n.returnZ:void 0,a=(0,p.rh)({parameters:e,mode:this.view?.type??"2d",returnZ:s,filter:r}),u=await i.querySnapping(a,{signal:t});(0,o.k_)(t);const l=e.coordinateHelper.spatialReference,h=await this._snappingElevationAligner.alignCandidates(u.candidates,l,t);(0,o.k_)(t);const g=await this._symbologySnappingFetcher.fetch(h,t);(0,o.k_)(t);const y=0===g.length?h:[...h,...g],f=this._snappingElevationFilter.filter(a,y),_=this._memoizedMakeGetGroundElevation(this.view,l);return f.map((e=>(0,d.X)(e,_)))}};(0,i._)([(0,u.Cb)({constructOnly:!0})],_.prototype,"layerSource",void 0),(0,i._)([(0,u.Cb)({constructOnly:!0})],_.prototype,"view",void 0),(0,i._)([(0,u.Cb)()],_.prototype,"_snappingElevationAligner",null),(0,i._)([(0,u.Cb)()],_.prototype,"_snappingElevationFilter",null),(0,i._)([(0,u.Cb)()],_.prototype,"_symbologySnappingFetcher",null),(0,i._)([(0,u.Cb)()],_.prototype,"_layerView",null),(0,i._)([(0,u.Cb)()],_.prototype,"_layerView3D",null),(0,i._)([(0,u.Cb)()],_.prototype,"_symbologySnappingSupported",null),_=(0,i._)([(0,l.j)("esri.views.interactive.snapping.featureSources.FeatureCollectionSnappingSource")],_)},23989:function(e,t,n){n.d(t,{X:function(){return c},g:function(){return u}});var i=n(17609),r=n(24218),s=n(45712),o=n(51429);function a({x:e,y:t,z:n}){return(0,i.al)(e,t,n??0)}function c(e,t){switch(e.type){case"edge":return e.draped?new r.k({edgeStart:a(e.start),edgeEnd:a(e.end),targetPoint:(0,i.s)(a(e.target)),objectId:e.objectId,getGroundElevation:t}):new s.L({edgeStart:a(e.start),edgeEnd:a(e.end),targetPoint:(0,i.s)(a(e.target)),objectId:e.objectId,isDraped:!1});case"vertex":return new o.x({targetPoint:(0,i.s)(a(e.target)),objectId:e.objectId,isDraped:!1})}}function u(e,t){return null!=e&&"3d"===e.type?(n,i)=>e.elevationProvider.getElevation(n,i,0,t,"ground"):()=>null}},18012:function(e,t,n){n.d(t,{p:function(){return c}});n(61432);var i=n(12853),r=n(79577),s=n(93568),o=n(26636),a=n(46368);function c(e=!1,t){if(e){const{elevationInfo:e,alignPointsInFeatures:n}=t;return new l(e,n)}return new u}class u{async alignCandidates(e,t,n){return e}notifyElevationSourceChange(){}}class l{constructor(e,t){this._elevationInfo=e,this._alignPointsInFeatures=t,this._alignmentsCache=new i.z(1024),this._cacheVersion=0}async alignCandidates(e,t,n){const i=this._elevationInfo;return null==i||"absolute-height"!==i.mode||i.featureExpressionInfo?this._alignComputedElevationCandidates(e,t,n):(function(e,t,n){const{offset:i,unit:r}=n;if(null==i)return;const s=(0,o._R)(t),c=i*((0,a.Z7)(r??"meters")/s);for(const t of e)switch(t.type){case"edge":t.start.z+=c,t.end.z+=c;continue;case"vertex":t.target.z+=c;continue}}(e,t,i),e)}notifyElevationSourceChange(){this._alignmentsCache.clear(),this._cacheVersion++}async _alignComputedElevationCandidates(e,t,n){const i=new Map;for(const t of e)(0,r.s1)(i,t.objectId,d).push(t);const[o,a,c]=this._prepareQuery(i,t),u=await this._alignPointsInFeatures(o,n);if((0,s.k_)(n),c!==this._cacheVersion)return this._alignComputedElevationCandidates(e,t,n);this._applyCacheAndResponse(o,u,a);const{drapedObjectIds:l,failedObjectIds:h}=u,p=[];for(const t of e){const{objectId:e}=t;l.has(e)&&"edge"===t.type&&(t.draped=!0),h.has(e)||p.push(t)}return p}_prepareQuery(e,t){const n=[],i=[];for(const[t,r]of e){const e=[];for(const n of r)this._addToQueriesOrCachedResult(t,n.target,e,i),"edge"===n.type&&(this._addToQueriesOrCachedResult(t,n.start,e,i),this._addToQueriesOrCachedResult(t,n.end,e,i));0!==e.length&&n.push({objectId:t,points:e})}return[{spatialReference:t.toJSON(),pointsInFeatures:n},i,this._cacheVersion]}_addToQueriesOrCachedResult(e,t,n,i){const r=p(e,t),s=this._alignmentsCache.get(r);null==s?n.push(t):i.push(new h(t,s))}_applyCacheAndResponse(e,{elevations:t,drapedObjectIds:n,failedObjectIds:i},r){for(const e of r)e.apply();let s=0;const o=this._alignmentsCache;for(const{objectId:r,points:a}of e.pointsInFeatures){if(i.has(r)){s+=a.length;continue}const e=!n.has(r);for(const n of a){const i=p(r,n),a=t[s++];n.z=a,e&&o.put(i,a,1)}}}}class h{constructor(e,t){this.point=e,this.z=t}apply(){this.point.z=this.z}}function p(e,{x:t,y:n,z:i,spatialReference:r}){return`${e}-${t}-${n}-${i??0}}-wkid:${r?.wkid}`}function d(){return[]}},6733:function(e,t,n){n.d(t,{c:function(){return o}});n(61432);class i{filter(e,t){return t}notifyElevationSourceChange(){}}class r{filter(e,t){const{point:n,distance:i}=e,{z:r}=n;if(null==r)return t;if(0===t.length)return t;const o=function(e){return"number"==typeof e?{x:e,y:e,z:e}:e}(i),a=this._updateCandidatesTo3D(t,n,o).filter(s);return a.sort(u),a}_updateCandidatesTo3D(e,t,n){for(const i of e)switch(i.type){case"edge":a(i,t,n);continue;case"vertex":c(i,t,n);continue}return e}}function s(e){return e.distance<=1}function o(e=!1){return e?new r:new i}function a(e,t,{x:n,y:i,z:r}){const{start:s,end:o,target:a}=e;e.draped||function(e,t,n,i){const r=i.x-n.x,s=i.y-n.y,o=i.z-n.z,a=r*r+s*s+o*o,c=(t.x-n.x)*r+(t.y-n.y)*s+o*(t.z-n.z),u=Math.min(1,Math.max(0,c/a)),l=n.x+r*u,h=n.y+s*u,p=n.z+o*u;e.x=l,e.y=h,e.z=p}(a,t,s,o);const c=(t.x-a.x)/n,u=(t.y-a.y)/i,l=(t.z-a.z)/r;e.distance=Math.sqrt(c*c+u*u+l*l)}function c(e,t,{x:n,y:i,z:r}){const{target:s}=e,o=(t.x-s.x)/n,a=(t.y-s.y)/i,c=(t.z-s.z)/r,u=Math.sqrt(o*o+a*a+c*c);e.distance=u}function u(e,t){return e.distance-t.distance}},46264:function(e,t,n){n.d(t,{k:function(){return a}});n(61432);var i=n(28947),r=n(12853),s=n(93568),o=n(29138);function a(e=!1,t){return e?new u(t):new c}class c{async fetch(){return[]}notifySymbologyChange(){}}class u{constructor(e){this._getSymbologyCandidates=e,this._candidatesCache=new r.z(1024),this._cacheVersion=0}async fetch(e,t){if(0===e.length)return[];const n=[],r=[],o=this._candidatesCache;for(const t of e){const e=l(t),s=o.get(e);if(s)for(const e of s)r.push((0,i.d9)(e));else n.push(t),o.put(e,[],1)}if(0===n.length)return r;const a=this._cacheVersion,{candidates:c,sourceCandidateIndices:u}=await this._getSymbologyCandidates(n,t);if((0,s.k_)(t),a!==this._cacheVersion)return this.fetch(e,t);const h=[],{length:p}=c;for(let e=0;e<p;++e){const t=c[e],r=l(n[u[e]]),s=o.get(r);s.push(t),o.put(r,s,s.length),h.push((0,i.d9)(t))}return r.concat(h)}notifySymbologyChange(){this._candidatesCache.clear(),this._cacheVersion++}}function l(e){switch(e.type){case"vertex":{const{objectId:t,target:n}=e,i=`${t}-vertex-${n.x}-${n.y}-${n.z??0}`;return(0,o.hP)(i).toString()}case"edge":{const{objectId:t,start:n,end:i}=e,r=`${t}-edge-${n.x}-${n.y}-${n.z??0}-to-${i.x}-${i.y}-${i.z??0}`;return(0,o.hP)(r).toString()}default:return""}}},60162:function(e,t,n){n.d(t,{n:function(){return s}});var i=n(24910),r=n(10690);class s extends r.r{constructor(e,t,n){super(t,n),this.point=e}equals(e){return e instanceof s&&(0,i.q)(this.point,e.point)}}}}]);