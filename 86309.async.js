"use strict";(self.webpackChunkscene_pro=self.webpackChunkscene_pro||[]).push([[86309],{56425:function(e,t,i){i.d(t,{X:function(){return a}});var s=i(24910),n=i(8008),r=i(21414),o=i(8554);function a(e,t,i,a){const l=(0,n.E2)(t,a);if(null==l)return!1;const c=l.source.spatialReferenceId,u=l.dest.spatialReferenceId;if(c===u&&c!==n.Ej.UNKNOWN||(0,o.fS)(t,a))return i[0]=1,i[1]=1,i[2]=1,!0;if(c===n.Ej.SPHERICAL_ECEF){const t=(0,s.l)(e),o=t/Math.sqrt(e[0]*e[0]+e[1]*e[1]),a=t/r.sv.radius;if(u===n.Ej.WEB_MERCATOR)return i[0]=o*a,i[1]=o*a,i[2]=1,!0;if(u===n.Ej.WGS84||u===n.Ej.CGCS2000){const e=n.Ms;return i[0]=e*o*a,i[1]=e*a,i[2]=1,!0}}else if(c===n.Ej.PLATE_CARREE){if(u===n.Ej.WGS84||u===n.Ej.CGCS2000)return i[0]=n.Ms,i[1]=n.Ms,i[2]=1,!0;if(u===n.Ej.WEB_MERCATOR){const t=e[1]/r.sv.radius;return i[0]=1,i[1]=1/Math.cos(t),i[2]=1,!0}}return!1}},40897:function(e,t,i){i.d(t,{s:function(){return a}});var s=i(99574),n=i(82846),r=i(8008),o=i(21414);function a(e,t,i,s){if(null==t||null==s)return!1;const n=(0,r.E2)(t,s);if(null==n?.projector)return!1;if(n.projector===r.iq)return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],!0;const{source:a,dest:u,projector:d}=n;if(u.spatialReferenceId===r.Ej.WEB_MERCATOR){const t=r.rf[a.spatialReferenceId][r.Ej.WGS84];return null!=t&&(t(e,0,c,0),(0,r.uT)(c,0,i,0),i[3]=l(c[1],e[2],e[3],o.sv.radius),!0)}if(a.spatialReferenceId!==r.Ej.WGS84&&a.spatialReferenceId!==r.Ej.CGCS2000||u.spatialReferenceId!==r.Ej.PLATE_CARREE){d(e,0,i,0);const t=a.metersPerUnit??1,s=u.metersPerUnit??1;i[3]=e[3]*t/s}else{const t=r.rf[a.spatialReferenceId][r.Ej.SPHERICAL_ECEF],s=r.rf[r.Ej.SPHERICAL_ECEF][r.Ej.PLATE_CARREE];let n=e[3];null!=t&&null!=s&&(n=l(e[1],e[2],e[3],o.sv.radius)),d(e,0,i,0),i[3]=n}return!0}function l(e,t,i,s){const n=s+t;if(n<s/2||i>n)return Number.MAX_VALUE;const r=Math.abs(u*e)+Math.asin(i/n);return r>=Math.PI/2?Number.MAX_VALUE:i/Math.cos(r)}const c=(0,n.Ue)(),u=(0,s.Vl)(1)},49076:function(e,t,i){i.d(t,{Z:function(){return m}});var s,n=i(73440),r=i(63255),o=i(28947),a=i(8914),l=i(17155),c=(i(61432),i(96711),i(48023)),u=i(29884),d=i(75432),h=i(67764),p=i(13132);let m=s=class extends r.Z{constructor(e){super(e),this.geometry=null,this.type="clip"}writeGeometry(e,t,i,s){if(s.layer?.spatialReference&&!s.layer.spatialReference.equals(this.geometry.spatialReference)){if(!(0,p.canProjectWithoutEngine)(e.spatialReference,s.layer.spatialReference))return void(s?.messages&&s.messages.push(new a.Z("scenemodification:unsupported","Scene modifications with incompatible spatial references are not supported",{modification:this,spatialReference:s.layer.spatialReference,context:s})));const n=new h.Z;(0,p.projectPolygon)(e,n,s.layer.spatialReference),t[i]=n.toJSON(s)}else t[i]=e.toJSON(s);delete t[i].spatialReference}clone(){return new s({geometry:(0,o.d9)(this.geometry),type:this.type})}};(0,n._)([(0,l.Cb)({type:h.Z}),(0,d.B)()],m.prototype,"geometry",void 0),(0,n._)([(0,u.c)(["web-scene","portal-item"],"geometry")],m.prototype,"writeGeometry",null),(0,n._)([(0,l.Cb)({type:["clip","mask","replace"],nonNullable:!0}),(0,d.B)()],m.prototype,"type",void 0),m=s=(0,n._)([(0,c.j)("esri.layers.support.SceneModification")],m)},94701:function(e,t,i){var s,n;i.d(t,{B:function(){return n},P:function(){return s}}),function(e){e[e.None=0]="None",e[e.Int16=1]="Int16",e[e.Int32=2]="Int32"}(s||(s={})),function(e){e[e.Replace=0]="Replace",e[e.Outside=1]="Outside",e[e.Inside=2]="Inside",e[e.Finished=3]="Finished"}(n||(n={}))},55656:function(e,t,i){i.d(t,{OV:function(){return h},S9:function(){return f},YQ:function(){return u},yF:function(){return d}});var s=i(96711),n=i(63974),r=i(82846),o=i(37580),a=i(13132),l=i(2051),c=i(94701);class u{constructor(e,t,i,s,n,r){this.layout=e,this.interleavedVertexData=t,this.indices=i,this.hasColors=s,this.hasModifications=n,this.positionData=r}}class d{constructor(e,t,i,s,n,r,o){this.componentOffsets=e,this.featureIds=t,this.anchorIds=i,this.anchors=s,this.transformedGeometry=n,this.globalTrafo=r,this.obb=o}}class h extends o.q{constructor(e){super("SceneLayerWorker","process",{process:e=>[e.geometryBuffer],project:e=>[e.positions.buffer],transformNormals:e=>[e.normals.buffer]},e,{hasInitialize:!0})}setModifications(e,t,i,s){const n={context:e,modifications:f(t,i,s),isGeodetic:s.isGeographic};this.broadcast(n,"setModifications")}setLegacySchema(e,t){const i=JSON.stringify(t);return this.broadcast({context:e,jsonSchema:i},"setLegacySchema")}destroyContext(e){return this.broadcast(e,"destroyContext")}project(e,t){return this.invokeMethod("project",e,t)}transformNormals(e,t){return this.invokeMethod("transformNormals",e,t)}}const p=new n.Z({deallocator:null}),m=(0,r.Ue)();function f(e,t,i){p.clear();let n=1/0,r=1/0,o=-1/0,u=-1/0,d=!1;for(const e of t){const t="clip"===e.type?c.B.Inside:"mask"===e.type?c.B.Outside:c.B.Replace,h=e.geometry;let f=e=>e;if(h.spatialReference){if(!(0,a.canProjectWithoutEngine)(h.spatialReference,i)){s.Z.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle").warn("Can't project modification polygon into layer spatial reference, ignoring modification");continue}f=e=>((0,l.S)(e,h.spatialReference,m,i),m)}else h.hasZ||(m[2]=0,f=e=>(m[0]=e[0],m[1]=e[1],m));d=d||t===c.B.Outside,p.push(t),p.push(h.rings.length);for(const e of h.rings){p.push(e.length);for(const t of e){const e=f(t);p.push(e[0]),p.push(e[1]),p.push(e[2]),n=Math.min(n,e[0]),r=Math.min(r,e[1]),o=Math.max(o,e[0]),u=Math.max(u,e[1])}}}if(null!=e)if(d){const t=1e-4;p.push(c.B.Inside),p.push(2),p.push(4),p.push(n-t),p.push(r-t),p.push(0),p.push(o+t),p.push(r-t),p.push(0),p.push(o+t),p.push(u+t),p.push(0),p.push(n-t),p.push(u+t),p.push(0),p.push(4),p.push(e[0]),p.push(e[1]),p.push(0),p.push(e[2]),p.push(e[1]),p.push(0),p.push(e[2]),p.push(e[3]),p.push(0),p.push(e[0]),p.push(e[3]),p.push(0)}else p.push(c.B.Outside),p.push(1),p.push(4),p.push(e[0]),p.push(e[1]),p.push(0),p.push(e[2]),p.push(e[1]),p.push(0),p.push(e[2]),p.push(e[3]),p.push(0),p.push(e[0]),p.push(e[3]),p.push(0);p.push(c.B.Finished);const h=new Float64Array(p.length);for(let e=0;e<p.length;++e)h[e]=p.at(e);return h}},86309:function(e,t,i){i.r(t),i.d(t,{default:function(){return we}});var s=i(73440),n=i(88194),r=i(61432),o=i(96711),a=i(61100),l=i(90403),c=i(99153),u=i(17155),d=(i(83850),i(48023)),h=i(96373),p=i(30748),m=i(31865),f=i(10934),y=i(21117),g=i(24910),b=i(82846),_=i(27583),v=i(47925),w=i(74238),C=i(56425),E=i(2051),x=i(47566),M=i(81342),R=i(38700),T=i(49076),O=i(51870),S=i(56172),P=i(55656),A=i(15165);class I extends A.W{constructor(e,t,i,s,n,r,o){super(e,0,0,0,t),this.nodesCached=i,this.vboMB=s,this.textureMB=n,this.vboMBCached=r,this.textureMBCached=o}}var U=i(94808),j=i(24381),B=i(23195),H=i(99457),F=i(32420),L=i(65650);const V={[R.AQ.Points]:null,[R.AQ.Lines]:null,[R.AQ.LineStrip]:null,[R.AQ.Triangles]:L.MX.TRIANGLES,[R.AQ.TriangleStrip]:L.MX.TRIANGLE_STRIP,[R.AQ.NotSet]:null},N={[R.xL.Opaque]:F.JJ.Opaque,[R.xL.Mask]:F.JJ.Mask,[R.xL.Blend]:F.JJ.Blend},k={[R.Qd.Back]:F.Vr.Back,[R.Qd.Front]:F.Vr.Front,[R.Qd.None]:F.Vr.None,[R.Qd.NotSet]:F.Vr.Back},G={[R.$1.WrapYBit]:{s:L.e8.CLAMP_TO_EDGE,t:L.e8.REPEAT},[R.$1.WrapXBit]:{s:L.e8.REPEAT,t:L.e8.CLAMP_TO_EDGE},[R.$1.WrapXy]:{s:L.e8.REPEAT,t:L.e8.REPEAT},[R.$1.None]:{s:L.e8.CLAMP_TO_EDGE,t:L.e8.CLAMP_TO_EDGE},[R.$1.NotSet]:{s:L.e8.CLAMP_TO_EDGE,t:L.e8.CLAMP_TO_EDGE}},D={[R.MB.U8]:1,[R.MB.I8]:1,[R.MB.U16]:2,[R.MB.I16]:2,[R.MB.U32]:4,[R.MB.I32]:4,[R.MB.F32]:4,[R.MB.F64]:8,[R.MB.Utf8String]:1,[R.MB.NotSet]:1};var W=i(46451),Z=i(94744),z=i(61442),J=i(32033),q=i(19821),$=i(87807);class Q{constructor(e){this.type=q.q.TILES3D,this.slicePlaneEnabled=!1,this.isGround=!0,this.layerView=e,this.layerViewUid=e.uid}intersect(e,t,i,s,n,r){if(e.options.filteredLayerViewUids.includes(this.layerView.uid))return;const o=e.results,a=e.options.store===z.e.ALL,l=this.layerView.view.stage.renderView.componentObjectCollection,c=new $.sT(r,e.options.normalRequired);this.layerView.objects.forEach((n=>{n.visible&&n.intersectionGeometry&&l.intersect(n,i,s,e.tolerance,null,c,((n,r,l,c)=>{if(r>=0){if(null!=t&&!t(i,s,r))return;const n=e=>{const t=new Z.lt(this.layerView.layer.uid,(()=>this._createTiles3DGraphic(this.layerView.layer,{})));e.set(this.type,t,r,l)};if(this.isGround&&(null==o.ground.distance||r<o.ground.distance)&&n(o.ground),e.options.isFiltered)return;if((null==o.min.distance||r<o.min.distance)&&n(o.min),(null==o.max.distance||r>o.max.distance)&&n(o.max),a){const t=new J.x(e.ray);n(t),e.results.all.push(t)}}}))}))}_createTiles3DGraphic(e,t){return new W.Z({layer:e,sourceLayer:e,attributes:t})}}var X,Y,K=i(71298),ee=i(58300),te=i(78986),ie=i(90166),se=i(91129),ne=i(40206),re=i(44417),oe=i(50866),ae=i(31839),le=i(93270),ce=i(81749),ue=i(72913),de=i(28751),he=i(52061),pe=i(92991),me=i(5527),fe=i(27546),ye=i(17426),ge=i(64801);(Y=X||(X={}))[Y.API=1]="API",Y[Y.VerboseAPI=2]="VerboseAPI",Y[Y.Error=3]="Error";class be{constructor(){this.handle=0,this.isVisible=!1,this.components=[],this.textureMemoryUsage=0,this.vboMemoryUsage=0,this.cpuMemoryUsage=0,this.textures=[]}get usedMemory(){return this.textureMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage}get cachedMemory(){return this.usedMemory}}function _e(e){return Math.round(e/1048.576)/1e3}let ve=class extends((0,j.A)(me.Z)){constructor(){super(...arguments),this.type="integrated-mesh-3dtiles",this._compressionTracker=new ye.x,this._modifications=new Array,this._visibleGeometryChangedSchedulerHandle=null,this._wasmLayerId=-1,this.ignoresMemoryFactor=!1,this.drapeTargetType=U.al.WithoutRasterImage,this._applySSAO=!(0,r.Z)("disable-feature:im-ssao"),this._shadeNormals=!!(0,r.Z)("enable-feature:im-shading"),this._lyrHandleToObjects=new Map,this._initialCullFace=new Map,this._suspendedHandle=null,this._dbgFlags=new Set}get hasModifications(){return this._modifications&&this._modifications.length>0}initialize(){if(this._dbgFlags.add(X.Error),this._dbg(X.VerboseAPI,"Tiles3DLayerView3D initialize() called"),this._updatingHandles.add((()=>this.layer.modifications),(()=>this._loadModifications()),l.nn),!this._canProjectWithoutEngine())throw new n.Z("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});const e=(0,B.JF)(this).then((e=>{this._wasmLayerId=e,this._intersectionHandler=new Q(this),this.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler),this._updatingHandles.add((()=>this.slicePlaneEnabled),(e=>this._slicePlaneEnabledChange(e))),this._updatingHandles.add((()=>this._modifications),(()=>this._modificationsChanged()),l.nn),this._updatingHandles.add((()=>this.view.clippingArea),(()=>this._clippingAreaChanged()),l.nn),this._elevationProvider=new H.u({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this.view.elevationProvider.register("im",this._elevationProvider),this.view.basemapTerrain.overlayManager.registerDrapeTarget(this);const t=this.view.resourceController.memoryController.newCache(`t3d-${this.uid}`,(e=>this._onRemoveFromCache(e)));this._memCache=t,this.addHandles([(0,l.YP)((()=>this.layer.elevationInfo),(e=>this._elevationInfoChanged(e)))]),this._suspendedHandle=(0,l.YP)((()=>this.suspended),(e=>this._wasm?.setEnabled(this,!e)),l.nn)}));this.addResolvingPromise(e)}destroy(){this._dbg(X.VerboseAPI,"Tiles3DLayerView3D destroy() called"),(0,B.mq)(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null),this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._elevationProvider&&(this._elevationProvider.objectsChanged(this._obbs),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this.view.basemapTerrain.overlayManager.unregisterDrapeTarget(this),this._lyrHandleToObjects.forEach((e=>this.freeObject(e))),this._lyrHandleToObjects.clear(),this._initialCullFace.clear(),this._memCache=(0,a.SC)(this._memCache),this._updatingHandles=(0,a.SC)(this._updatingHandles),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}_modificationsChanged(){const e=this.layer.spatialReference,t=(0,P.S9)(this._layerClippingArea,this._modifications,e);this._wasm?.setMeshModifications(this,t,e.wkid)}_clippingAreaChanged(){const e=this.layer.spatialReference,t=(0,x.Ue)();this._layerClippingArea=(0,ee.G)(this.view.clippingArea,t,e)?t:null,this._modificationsChanged()}_visibleGeometryChanged(){this._visibleGeometryChangedSchedulerHandle??=(0,c.Os)((()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null}))}_slicePlaneEnabledChange(e){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=e),this.objects.forEach((t=>{const i=this._collection.getMaterial(t);i.commonMaterialParameters.hasSlicePlane=e,i.commonMaterialParameters.cullFace=e?F.Vr.None:this._initialCullFace.get(t)}))}_elevationInfoChanged(e){this._wasm?.setLayerOffset(this,(0,O.fm)(e))}get _obbs(){return this.objects.map((e=>this._collection.getComponentObb(e)))}get _wasm(){return(0,B.WM)(this.view)}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){let e=0;return this._lyrHandleToObjects.forEach((t=>{t.isVisible&&(e+=t.usedMemory)})),e}get unloadedMemory(){return 0}get cachedMemory(){let e=0;return this._lyrHandleToObjects.forEach((t=>{t.isVisible||(e+=t.usedMemory)})),e}get visibleAtCurrentScale(){return(0,fe.GB)(this.layer.effectiveScaleRange,this.view.scale)}get performanceInfo(){let e=0,t=0,i=0,s=0,n=0,r=0;return this._lyrHandleToObjects.forEach((o=>{o.isVisible?(e+=o.textureMemoryUsage,t+=o.vboMemoryUsage,n++):(i+=o.textureMemoryUsage,s+=o.vboMemoryUsage,r++)})),new I(this.usedMemory,n,r,_e(t),_e(e),_e(s),_e(i))}_canProjectWithoutEngine(){if(this.view.state.viewingMode===S.JY.Local){const e=this.view.renderSpatialReference?.isWebMercator?3857:this.view.renderSpatialReference?.wkid??-1;if(3857!==e&&32662!==e)return!1}return!0}get _stage(){return this.view.stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationOffset(){return(0,O.fm)(this.layer.elevationInfo)}get elevationRange(){const e=this.fullExtent;return e?.zmin&&e?.zmax?new K.r(e.zmin,e.zmax):null}getElevationRange(e){return null}get fullExtent(){return this.layer.fullExtent}get objects(){return Array.from(this._lyrHandleToObjects.values()).reduce(((e,t)=>e.concat(t.components)),new Array)}isUpdating(){const e=this._wasm;return!(this._wasmLayerId<0||null==e)&&(e.isUpdating(this._wasmLayerId)||this._compressionTracker.compressing)}updatingFlagChanged(){this.notifyChange("updating")}async createRenderable(e){const t=e.meshData;if(null==t.data)throw new Error("meshData.data undefined");if(t.desc=JSON.parse(t.desc),null==t.desc)throw new Error("meshData.desc undefined");const i=(0,b.nI)(t.desc.origin),s=new Array,n=new Map,r=new be;r.handle=e.handle,this._lyrHandleToObjects.set(e.handle,r);const o=this.view.basemapTerrain.spatialReference;let a,l;if("global"===this.view.viewingMode){const e=(0,f.Ue)();(0,w.B)(v.kU,i,e,o),a=(0,h.xO)((0,p.Ue)(),e),l=(0,h.U_)((0,p.Ue)(),a)}else a=p.Wd,l=p.Wd;const c=(0,f.Ue)();(0,m.Iu)(c,c,i);const u=(0,m.i0)((0,b.Ue)(),c);let d=null;const x=(0,b.Ue)();if(t.desc.obb){const e=t.desc.obb.quaternion;d=new te.Oo(t.desc.obb.center,t.desc.obb.halfSize,(0,y.al)(e[0],e[1],e[2],e[3]))}for(let e=0;e<t.desc.prims.length;e++){const c=t.desc.prims[e];if(this._dbg(X.VerboseAPI,JSON.stringify(c)),null==V[c.ptype]||null==t.data){this._dbg(X.VerboseAPI,"[Unsupported Feature] Unsupported primitive mode ("+c.ptype+"). Skipping primitive.");continue}const h=t.desc?.materials&&null!=c.materialId?t.desc.materials[c.materialId]:null,m=null!=h?h.lightingModel:R.jE.Unlit,{positionView:f,positionAttr:y,normalsView:v,normalsAttr:w,colorAttr:T,texCoord0Attr:O,indicesView:S}=this.getBufferViews(c,t.data.buffer,a);if(null==y||null==f||null==S)continue;const P=new se.h(null!=T,O?ae.I.Default:ae.I.None,null!=v,this._shadeNormals,this._applySSAO),A=y.data.length/y.size,I=(e,t)=>!e||e.data.length/e.size===A||(this._dbg(X.Error,`${t} !== numPos. Skipping primitive.`),!1);if(!I(O,"numTexcoord")||!I(T,"numColors")||!I(w,"normals"))continue;const U=(0,se.N)(P);if(null!=d?d=d.clone():(d=(0,te.Qb)(y),(0,g.f)(x,d.center,i),d.center=x),a!==p.Wd)for(let e=0;e<f.count;e++)f.getVec(e,x),(0,g.o)(x,x,a),f.setVec(e,x);const j=U.createBuffer(y.data.length);if((0,pe.i9)(he.T.POSITION,y,null,null,j,0),null!=O){const e=j.getField(he.T.UV0,M.Eu);(0,pe.WA)(O,e,0)}null!=T&&(0,pe.i9)(he.T.COLOR,y,null,null,j,0),null!=w&&(0,pe.i9)(he.T.NORMALCOMPRESSED,w,null,null,j,0);const B=new Uint32Array([0,S.typedBuffer.length]),H={vertices:{data:j.buffer,count:j.byteLength/U.stride,layoutParameters:P},positionData:{positions:f.typedBuffer,indices:S.typedBuffer},indices:S.typedBuffer,componentOffsets:B};r.cpuMemoryUsage+=f.count,r.cpuMemoryUsage+=S.count;const L=this.view.renderSpatialReference,G=(0,b.Ue)(),D=[1,1,1];(0,C.X)(u,L,D,o)||this._dbg(X.Error,"Unsupported coordinate system for IM overlay"),(0,E.S)(u,L,G,o);const W=this._collection.createObject(new ie.G((0,_.al)(G[0],G[1],D[0],D[1]),new ne.w(u,l),d,H));h&&this._collection.updateMaterial(W,(e=>{e.baseColor=h.baseColorFactor,e.usePBR=m===R.jE.Pbr,e.hasParametersFromSource=!1,e.baseColorTexture=this._getTexture(h.baseColorTex,t,n,r),e.usePBR&&(e.mrrFactors=[h.metallicFactor,h.roughnessFactor,0],e.emissiveBaseColor=h.emissiveFactor??[0,0,0],e.metallicRoughnessTexture=this._getTexture(h.metalTex,t,n,r),e.emissionTexture=this._getTexture(h.emissiveTex,t,n,r),e.occlusionTexture=this._getTexture(h.occlusionTex,t,n,r),e.normalTexture=this._getTexture(h.normalTex,t,n,r)),e.objectOpacity=0,e.alphaDiscardMode=F.JJ.Mask;const i=[];e.baseColorTexture&&i.push(e.baseColorTexture.loadPromise),e.usePBR&&e.metallicRoughnessTexture&&i.push(e.metallicRoughnessTexture.loadPromise),e.usePBR&&e.emissionTexture&&i.push(e.emissionTexture.loadPromise),e.usePBR&&e.occlusionTexture&&i.push(e.occlusionTexture.loadPromise),e.usePBR&&e.normalTexture&&i.push(e.normalTexture.loadPromise);const o=Promise.all(i);s.push(o),o.then((()=>{e.alphaDiscardMode=N[h.alphaMode],e.objectOpacity=1,r.textureMemoryUsage+=e.baseColorTexture?.glTexture?.usedMemory||0,e.usePBR&&(r.textureMemoryUsage+=e.metallicRoughnessTexture?.glTexture?.usedMemory||0,r.textureMemoryUsage+=e.emissionTexture?.glTexture?.usedMemory||0,r.textureMemoryUsage+=e.occlusionTexture?.glTexture?.usedMemory||0,r.textureMemoryUsage+=e.normalTexture?.glTexture?.usedMemory||0)})),e.commonMaterialParameters.doubleSided=h.isDoubleSided,e.commonMaterialParameters.cullFace=h.faceCulling?k[h.faceCulling]:F.Vr.Back,this._initialCullFace.set(W,e.commonMaterialParameters.cullFace),e.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,e.componentParameters.castShadows=re.ws.All,e.textureAlphaCutoff=h.alphaCutoff??ge.e,e.alphaDiscardMode=N[h.alphaMode],e.isIntegratedMesh=!0,e.polygonOffsetEnabled=!1,e.hasOccludees=!1,e.ellipsoidMode=(0,le.j)(this.view.spatialReference)})),r.components.push(W),r.vboMemoryUsage+=this._collection.getObjectGPUMemoryUsage(W)}if(await Promise.all(s),n.forEach((e=>{r.textures.push(e)})),!this._memCache)throw new Error("no memCache");return this._memCache.put(`${r.handle}`,r),{memUsageBytes:r.usedMemory}}freeRenderable(e){const t=this._lyrHandleToObjects.get(e);t&&(this.freeObject(t),this._lyrHandleToObjects.delete(e))}freeObject(e){this._memCache&&this._memCache.pop(`${e.handle}`),e.components.forEach((t=>{e.textures.forEach((e=>{this._stage.removeTexture(e)})),this._collection.destroyObject(t),this._initialCullFace.delete(t)}))}setRenderableVisibility(e,t,i){if(this._memCache){for(let s=0;s<i;++s){const i=e[s],n=t[s];if(!n)continue;const r=this._lyrHandleToObjects.get(i);r&&(this._visibleGeometryChanged(),r.isVisible=n,r.components.forEach((e=>{this._collection.setObjectVisibility(e,n),this._elevationProvider.objectChanged(this._collection.getComponentObb(e))})),this._memCache.pop(`${i}`))}for(let s=0;s<i;++s){const i=e[s],n=t[s];if(n)continue;const r=this._lyrHandleToObjects.get(i);r&&(this._visibleGeometryChanged(),r.isVisible=n,r.components.forEach((e=>{this._collection.setObjectVisibility(e,n),this._elevationProvider.objectChanged(this._collection.getComponentObb(e))})),this._memCache.put(`${i}`,r))}}}_getTexture(e,t,i,s){let n=null;if(e&&t.desc?.images&&t.data?.buffer){const o=t.desc.images[e?.imageId];if(n=i.get(o),!n&&o){const a=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,l=!!o.mipCount||a>1,c=G[e.wrapMode??R.$1.None];let u=o.alpha?4:3;const d=new Uint8Array(t.data.buffer,o.data.byteOffset,o.data.byteCount);let h=null,p=null,m=null;switch(o.format){case R.l7.Raw:o.pixelFormat===R.aw.R8?(h=d,u=1,p=""):o.pixelFormat===R.aw.Rgb8?(h=d,u=3,p=""):o.pixelFormat===R.aw.Rgba8&&(h=d,u=4,p="");break;case R.l7.Dxt1:h=d,u=3,p=F.Ti.DDS_ENCODING;break;case R.l7.Dxt5:h=d,u=4,p=F.Ti.DDS_ENCODING;break;case R.l7.Basis:h=d,u=3,p=F.Ti.KTX2_ENCODING;break;case R.l7.Png:p="image/png",m=document.createElement("img");break;case R.l7.Jpeg:p="image/jpeg",m=document.createElement("img");break;case R.l7.Etc2:p="image/ktx",m=document.createElement("img");break;case R.l7.Astc:this._dbg(X.Error,"Astc texture not supported");break;case R.l7.Pvrtc:this._dbg(X.Error,"Pvrtc texture not supported")}if(m&&p){const e=new Blob([d],{type:p});m.src=URL.createObjectURL(e),h=m}if(h&&null!=p){const e=(0,r.Z)("enable-feature:esri-compress-IM-textures")?{compressionTracker:this._compressionTracker,compressionCallback:e=>{e&&e>0&&(s.textureMemoryUsage-=e)}}:void 0;n=new de.x(h,{mipmap:l,maxAnisotropy:a,encoding:p,wrap:c,components:u,compressionOptions:e,noUnpackFlip:!0,width:o.mip0Width,height:o.mip0Height}),this._stage.addTexture(n),i.set(o,n)}}}return n?new oe.T(this.view.stage.renderView.textures,n.id):null}getBufferViews(e,t,i){let s,n,r,o,a,l,c,u=null;for(let c=0;c<e.atrbs.length;c++){const d=e.atrbs[c],h=d.view,p=void 0,m=h.byteOffset+h.byteCount,f=h.byteCount/D[h.type],y=[...Array(f).keys()].map((e=>e));try{switch(d.sem){case R.Lz.Position:3!==h.ncomp||h.type!==R.MB.F32?this._dbg(X.Error,"[Unsupported Feature] Unsupported view for Position ("+h+")"):(s=new M.ct(t,h.byteOffset,p,m),n=new ce.a(s.typedBuffer,y,3));break;case R.Lz.Normal:if(3!==h.ncomp||h.type!==R.MB.F32)this._dbg(X.Error,"[Unsupported Feature] Unsupported view for Normal ("+h+")");else{const e=new M.ct(t,h.byteOffset,p,m),s=(0,ue.Pj)(e.typedBuffer,i);a=new M.o7(s),l=new ce.a(a.typedBuffer,y,2)}break;case R.Lz.TexCoord:2!==h.ncomp||h.type!==R.MB.F32?this._dbg(X.Error,"[Unsupported Feature] Unsupported view for Texcoord ("+h+")"):void 0===o&&(o=new ce.a(new M.Eu(t,h.byteOffset,p,m).typedBuffer,y,2));break;case R.Lz.Color:4===h.ncomp?(h.type===R.MB.F32&&(u=new M.ek(t,h.byteOffset,p,m)),h.type===R.MB.U8&&(u=new M.mc(t,h.byteOffset,p,m)),h.type===R.MB.U16&&(u=new M.v6(t,h.byteOffset,p,m))):3===h.ncomp&&(h.type===R.MB.F32&&(u=new M.ct(t,h.byteOffset,p,m)),h.type===R.MB.U8&&(u=new M.ne(t,h.byteOffset,p,m)),h.type===R.MB.U16&&(u=new M.mw(t,h.byteOffset,p,m))),null==u?this._dbg(X.VerboseAPI,"[Unsupported Feature] Unsupported view for Color ("+h+")"):r=new ce.a(u.typedBuffer,y,h.ncomp);break;case R.Lz.FeatureIndex:break;default:this._dbg(X.VerboseAPI,"[Unsupported Feature] Unsupported semantic ("+d.sem+"). Skipping vertex attribute.")}}catch(e){this._dbg(X.VerboseAPI,"Error Creating buffer ("+e+"). Skipping vertex attribute.")}}if(e.index){const i=e.index.view,s=void 0,n=i.byteOffset+i.byteCount;switch(e.index.view.type){case R.MB.U16:c=new M.av(t,i.byteOffset,s,n);break;case R.MB.U32:c=new M.Nu(t,i.byteOffset,s,n);break;case R.MB.U8:default:this._dbg(X.Error,"[Unsupported Feature] index type not supported ("+i.type+").")}}if(null==c&&null!=s){const e=s.count;if(e<65535){const t=new Uint16Array(e);c=new M.av(t)}else{const t=new Uint32Array(e);c=new M.Nu(t)}for(let t=0;t<e;t++)c.set(t,t)}return{positionView:s,positionAttr:n,colorAttr:r,texCoord0Attr:o,indicesView:c,normalsView:a,normalsAttr:l}}_loadModifications(){if(this.removeHandles("modifications"),null==this.layer.modifications)return void(this._modifications=[]);const e=this.layer.modifications;this.addHandles(this._updatingHandles.addOnCollectionChange((()=>e),(()=>this._modifications=e.toArray()),l.nn),"modifications")}_onRemoveFromCache(e){this._wasm?.onRenderableEvicted(this,e.handle,e.usedMemory),this.freeRenderable(e.handle)}_dbg(e,t){this._dbgFlags.has(e)&&(e===X.Error?o.Z.getLogger(this).error(t):o.Z.getLogger(this).warn(t))}};(0,s._)([(0,u.Cb)({type:[T.Z]})],ve.prototype,"_modifications",void 0),(0,s._)([(0,u.Cb)()],ve.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),(0,s._)([(0,u.Cb)()],ve.prototype,"layer",void 0),(0,s._)([(0,u.Cb)({readOnly:!0})],ve.prototype,"visibleAtCurrentScale",null),(0,s._)([(0,u.Cb)()],ve.prototype,"elevationOffset",null),ve=(0,s._)([(0,d.j)("esri.views.3d.layers.IntegratedMesh3DTilesLayerView3D")],ve);const we=ve},24381:function(e,t,i){i.d(t,{A:function(){return u}});var s=i(73440),n=i(50702),r=i(93568),o=i(90403),a=i(17155),l=(i(61432),i(96711),i(83850),i(48023)),c=i(73584);const u=e=>{let t=class extends e{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(){super.postscript(),(0,c.qC)(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}async _validateHeightModelInfo(){const e=new AbortController,t=e.signal;this.addHandles((0,n.kB)((()=>e.abort()))),await(0,o.N1)((()=>this.view.defaultsFromMap?.heightModelInfoReady),t),(0,r.k_)(t);const i=(0,c.Wt)(this.layer,this.view.heightModelInfo,this.supportsHeightUnitConversion);if(i)throw i}};return(0,s._)([(0,a.Cb)()],t.prototype,"view",void 0),(0,s._)([(0,a.Cb)()],t.prototype,"slicePlaneEnabled",void 0),t=(0,s._)([(0,l.j)("esri.views.3d.layers.LayerView3D")],t),t}},99457:function(e,t,i){i.d(t,{u:function(){return v}});var s=i(73440),n=i(70880),r=i(87833),o=i(96711),a=i(17155),l=(i(61432),i(83850),i(48023)),c=i(31865),u=i(10934),d=i(24910),h=i(82846),p=i(40897),m=i(47566),f=i(69055),y=i(71298),g=i(38600),b=i(92490),_=i(61442);let v=class extends(r.Z.EventedMixin(n.Z)){constructor(e){super(e),this._tmpEvent=new g.c,this._renderCoordsHelper=e.view.renderCoordsHelper,this._renderSR=this._renderCoordsHelper.spatialReference,this._layerElevationSource=e.layerElevationSource}initialize(){this._intersector=new b.r(this.view.state.viewingMode),this._intersector.options.store=_.e.MIN,this._intersector.options.normalRequired=!1,this._tmpEvent.context=this.intersectionHandler.isGround?"ground":"scene"}get spatialReference(){return this.view?.elevationProvider?.spatialReference}getElevation(e,t,i,s){const n=this._renderCoordsHelper,r=(0,d.i)(E,e,t,i);if(!n.toRenderCoords(r,s,r))return o.Z.getLogger(this).error("could not project point to compute elevation"),null;const{layerElevationSource:a,_intersector:l,intersectionHandler:c}=this,u=a.fullExtent,h=null!=u&&Number.isFinite(u.xmin)&&Number.isFinite(u.xmax)&&Number.isFinite(u.ymin)&&Number.isFinite(u.ymax)&&Number.isFinite(u.zmin)&&Number.isFinite(u.zmax)?new y.r(u.zmin,u.zmax):a.elevationRange;if(null==h)return null;const p=a.elevationOffset,m=h.elevationRangeMin+p,f=h.elevationRangeMax+p,g=n.setAltitude(x,f,r),b=n.setAltitude(M,m,r);return l.reset(g,b,this.view.state.camera),c.intersect(l,null,g,b,null,!0),l.results.min.getIntersectionPoint(r)?n.getAltitude(r):null}getSphereElevationBounds(e,t){return(0,p.s)(e,t,C,this._renderSR),this._layerElevationSource.getElevationRange(C)}getRootElevationBounds(){const e=this.layerElevationSource.fullExtent;return e?.hasZ?new y.r(e.zmin,e.zmax):null}objectsChanged(e){this.spatialReference&&(this._computeLayerExtent(e,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}objectChanged(e){this.spatialReference&&(this._computeObjectExtent(e,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}_computeObjectExtent(e,t){(0,m.cS)(t),this._expandExtent(e,t)}_computeLayerExtent(e,t){(0,m.cS)(t);for(const i of e)this._expandExtent(i,t)}_expandExtent(e,t){const i=this.spatialReference;if(null==i)return;if(null==e)return;(0,c.en)(w,e.quaternion),w[12]=e.center[0],w[13]=e.center[1],w[14]=e.center[2];const s=e.halfSize;for(let e=0;e<8;++e)E[0]=1&e?s[0]:-s[0],E[1]=2&e?s[1]:-s[1],E[2]=4&e?s[2]:-s[2],(0,d.t)(E,E,w),this._renderCoordsHelper.fromRenderCoords(E,E,i),(0,m.jn)(t,E,t)}};(0,s._)([(0,a.Cb)({constructOnly:!0})],v.prototype,"layerElevationSource",void 0),(0,s._)([(0,a.Cb)({constructOnly:!0})],v.prototype,"intersectionHandler",void 0),(0,s._)([(0,a.Cb)({constructOnly:!0})],v.prototype,"view",void 0),(0,s._)([(0,a.Cb)()],v.prototype,"spatialReference",null),v=(0,s._)([(0,l.j)("esri.views.3d.layers.i3s.LayerElevationProvider")],v);const w=(0,u.Ue)(),C=(0,f.f)(0,0,0,0),E=(0,h.Ue)(),x=(0,h.Ue)(),M=(0,h.Ue)()},90166:function(e,t,i){i.d(t,{G:function(){return s}});class s{constructor(e,t,i,s){this.toMapSpace=e,this.transform=t,this.obb=i,this.geometry=s}}},40206:function(e,t,i){i.d(t,{w:function(){return s}});class s{constructor(e,t){this.position=e,this.rotationScale=t,this.origin=void 0}}},50866:function(e,t,i){i.d(t,{T:function(){return r}});var s=i(61100),n=i(93568);class r{constructor(e,t){this._textures=e,this.loadPromise=null,this._disposed=!1;const i=this._textures.acquire(t);(0,n.y8)(i)?(i.then((e=>{this._disposed?(0,s.RY)(e):this._textureRef=e})),this.loadPromise=i):this._textureRef=i}dispose(){this._textureRef=(0,s.RY)(this._textureRef),this._disposed=!0}get glTexture(){return null!=this._textureRef?this._textureRef.glTexture:null}}},5527:function(e,t,i){i.d(t,{Z:function(){return m}});var s=i(73440),n=i(70880),r=i(87833),o=i(15894),a=i(96711),l=i(61100),c=i(76329),u=i(17155),d=(i(61432),i(83850),i(48023)),h=i(60147),p=i(27546);let m=class extends(o.Z.IdentifiableMixin(c.Z.EsriPromiseMixin(r.Z.EventedMixin(n.Z)))){get spatialReferenceSupported(){return!0}constructor(e){super(e),this._updatingHandles=new h.R,this.layer=null,this.parent=null}initialize(){this.when().catch((e=>{if("layerview:create-error"!==e.name){const t=this.layer&&this.layer.id||"no id",i=this.layer?.title||"no title";a.Z.getLogger(this).error("#resolve()",`Failed to resolve layer view (layer title: '${i}', id: '${t}')`,e)}}))}destroy(){this._updatingHandles=(0,l.SC)(this._updatingHandles)}get fullOpacity(){return(this.layer?.opacity??1)*(this.parent?.fullOpacity??1)}get suspended(){return this.destroyed||!this.canResume()}get suspendInfo(){return this.getSuspendInfo()}get legendEnabled(){return!this.suspended&&!0===this.layer?.legendEnabled}get updating(){return!(!this._updatingHandles?.updating&&!this.isUpdating())}get updatingProgress(){return this.updating?0:1}get updateSuspended(){return this.suspended}get visible(){return!0===this.layer?.visible}set visible(e){this._overrideIfSome("visible",e)}get visibleAtCurrentScale(){return!0}get visibleAtCurrentTimeExtent(){const e=this.view.timeExtent,t=this.layer?.visibilityTimeExtent;return!e||!t||!e.intersection(t).isEmpty}canResume(){const e=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return this.visible&&this.layer?.loaded&&this.parent&&!this.parent.suspended&&this.view?.ready&&(0,p.Cy)(e)&&this.visibleAtCurrentScale&&this.visibleAtCurrentTimeExtent||!1}getSuspendInfo(){const e=this.parent?.suspended?this.parent.suspendInfo:{};this.view?.ready||(e.viewNotReady=!0),this.layer&&this.layer.loaded||(e.layerNotLoaded=!0);const t=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return(0,p.Cy)(t)&&this.visibleAtCurrentScale||(e.outsideScaleRange=!0),this.visibleAtCurrentTimeExtent||(e.outsideVisibilityTimeExtent=!0),this.visible||(e.layerInvisible=!0),e}isUpdating(){return!1}};(0,s._)([(0,u.Cb)({readOnly:!0})],m.prototype,"spatialReferenceSupported",null),(0,s._)([(0,u.Cb)()],m.prototype,"view",void 0),(0,s._)([(0,u.Cb)()],m.prototype,"fullOpacity",null),(0,s._)([(0,u.Cb)()],m.prototype,"layer",void 0),(0,s._)([(0,u.Cb)()],m.prototype,"parent",void 0),(0,s._)([(0,u.Cb)({readOnly:!0})],m.prototype,"suspended",null),(0,s._)([(0,u.Cb)({readOnly:!0})],m.prototype,"suspendInfo",null),(0,s._)([(0,u.Cb)({readOnly:!0})],m.prototype,"legendEnabled",null),(0,s._)([(0,u.Cb)({type:Boolean,readOnly:!0})],m.prototype,"updating",null),(0,s._)([(0,u.Cb)({readOnly:!0})],m.prototype,"updatingProgress",null),(0,s._)([(0,u.Cb)()],m.prototype,"updateSuspended",null),(0,s._)([(0,u.Cb)()],m.prototype,"visible",null),(0,s._)([(0,u.Cb)({readOnly:!0})],m.prototype,"visibleAtCurrentScale",null),(0,s._)([(0,u.Cb)({readOnly:!0})],m.prototype,"visibleAtCurrentTimeExtent",null),m=(0,s._)([(0,d.j)("esri.views.layers.LayerView")],m)}}]);