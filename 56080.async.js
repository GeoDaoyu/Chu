"use strict";(self.webpackChunkscene_pro=self.webpackChunkscene_pro||[]).push([[56080],{34753:function(e,t,i){i.d(t,{Z:function(){return _}});var s=i(73440),r=i(37877),n=i(89314),a=i(95437),o=i(63255),l=i(61100),c=i(17155),d=i(90775),h=(i(61432),i(83850),i(48023)),u=i(95226),p=i(60508);let _=class extends(o.Z.JSONSupportMixin(n.Z)){constructor(e){super(e),this.observer=null,this.farDistance=1e3,this.heading=0,this.tilt=90,this.horizontalFieldOfView=45,this.verticalFieldOfView=45,this.feature=null}get valid(){return null!=this.observer&&this.farDistance>0}equals(e){return(0,l._W)(this.observer,e.observer)&&this.farDistance===e.farDistance&&this.heading===e.heading&&this.tilt===e.tilt&&this.horizontalFieldOfView===e.horizontalFieldOfView&&this.verticalFieldOfView===e.verticalFieldOfView&&(0,r.kk)(this.feature,e.feature)}};(0,s._)([(0,c.Cb)({type:p.Z,json:{write:{isRequired:!0}}})],_.prototype,"observer",void 0),(0,s._)([(0,c.Cb)({type:Number,nonNullable:!0,range:{min:0},json:{write:{isRequired:!0}}})],_.prototype,"farDistance",void 0),(0,s._)([(0,c.Cb)({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),(0,d.p)((e=>a.BV.normalize((0,u.q9)(e),void 0,!0)))],_.prototype,"heading",void 0),(0,s._)([(0,c.Cb)({type:Number,nonNullable:!0,range:{min:0,max:180},json:{write:{isRequired:!0}}})],_.prototype,"tilt",void 0),(0,s._)([(0,c.Cb)({type:Number,nonNullable:!0,range:{min:0,max:360},json:{write:{isRequired:!0}}})],_.prototype,"horizontalFieldOfView",void 0),(0,s._)([(0,c.Cb)({type:Number,nonNullable:!0,range:{min:0,max:180},json:{write:{isRequired:!0}}})],_.prototype,"verticalFieldOfView",void 0),(0,s._)([(0,c.Cb)(r.rX)],_.prototype,"feature",void 0),(0,s._)([(0,c.Cb)({readOnly:!0,json:{read:!1}})],_.prototype,"valid",null),_=(0,s._)([(0,h.j)("esri.analysis.Viewshed")],_)},37877:function(e,t,i){i.d(t,{NS:function(){return h},kk:function(){return l},pD:function(){return c},rX:function(){return d}});var s=i(24910),r=i(82846),n=i(12659),a=i(61442),o=i(90189);function l(e,t){return c(e)===c(t)}function c(e){if(null==e)return null;const t=null!=e.layer?e.layer.id:"";let i=null;return i=null!=e.objectId?e.objectId:null!=e.layer&&"objectIdField"in e.layer&&null!=e.layer.objectIdField&&null!=e.attributes?e.attributes[e.layer.objectIdField]:e.uid,null==i?null:`o-${t}-${i}`}const d={json:{write:{writer:function(e,t){null!=e?.layer?.objectIdField&&null!=e.attributes&&(t.feature={layerId:e.layer.id,objectId:e.attributes[e.layer.objectIdField]})},target:{"feature.layerId":{type:[Number,String],isRequired:!0},"feature.objectId":{type:[Number,String],isRequired:!0}}},origins:{"web-scene":{read:function(e){if(null!=e.layerId&&null!=e.objectId)return{uid:null,layer:{id:e.layerId,objectIdField:"ObjectId"},attributes:{ObjectId:e.objectId}}}}}}};function h(e,t,i,l){const{sceneIntersectionHelper:d}=e,{observer:h,observerFeatureId:p,targetFeatureId:f,target:w}=i;if(null==p&&null==f)return;l||(l=e=>e),(0,s.a)(v,h,w);const m=(0,s.l)(v);(0,s.b)(v,h,v,1/m);const g=(0,n.zk)(v,w,_);t.options.store=a.e.ALL,d.intersectToolIntersectorRay(g,t);let b=null,y=null,V=null,S=null;for(const i of t.results.all){const t=(0,o.tB)(i,e);if(null==t||null==i.distanceInRenderSpace)continue;const s=c(t);null!=s&&(null!=p&&s===p&&(b??=l(u(i,e,m)),i.distanceInRenderSpace-1<b&&(V=i)),null!=f&&s===f&&(y??=l(u(i,e,m)),null==S&&i.distanceInRenderSpace-1<m&&m-i.distanceInRenderSpace+1<y&&(S=i)))}const{observerAdjusted:M,targetAdjusted:C}=i;V?.getIntersectionPoint(M)?i.observerSurfaceNormal=V.getTransformedNormal((0,r.Ue)()):i.observerSurfaceNormal=null,S?.getIntersectionPoint(C)?i.targetSurfaceNormal=S.getTransformedNormal((0,r.Ue)()):i.targetSurfaceNormal=null}function u(e,t,i){if((0,o._s)(e)){const s=(0,o.VB)(e,t);if(null!=s)return Math.min(s*p,i)}return 1e-5*i}const p=.05,_=(0,n.Ue)(),v=(0,r.Ue)()},54050:function(e,t,i){i.d(t,{V:function(){return b},a:function(){return S},b:function(){return y}});var s=i(31865),r=i(10934),n=i(17904),a=i(20638),o=i(28262),l=i(32386),c=i(19155),d=i(9535),h=i(85119),u=i(39163),p=i(48857),_=i(20431),v=i(18489),f=i(78631),w=i(71063),m=i(34709),g=i(15150);class b extends l.c{constructor(){super(...arguments),this.shadowMap={depthTexture:null,nearFar:[1,100],numActiveFaces:1,atlasRegions:[[0,0,1,1]]},this.targetVector=[1,0,0],this.upVector=[0,0,1],this.fovs=[45,45],this.headingAndTilt=[0,0],this.observerOffset=[0,0,0],this.projectionMatrices=r.Wd.flat(),this.viewMatrices=r.Wd.flat(),this.volumeOffset=0}}function y(){const e=new g.kG,t=e.fragment;return e.include(n.k),e.include(l.u),t.include(a.K),t.include(o.e),t.uniforms.add(new w.e("depthTexture",(e=>e.depth?.attachment)),new v.C("inverseProjectionMatrix",(e=>e.camera.inverseProjectionMatrix)),new v.C("inverseViewNormalMatrix",(({camera:e})=>(0,s.iS)(V,e.viewInverseTransposeMatrix))),new d.J("viewshedObserverOffset",(e=>e.observerOffset)),new d.J("viewshedTargetVector",(e=>e.targetVector)),new d.J("viewshedUpVector",(e=>e.upVector)),new c.A("viewshedFOVs",(e=>e.fovs)),new c.A("viewshedHeadingAndTilt",(e=>e.headingAndTilt)),new c.A("viewshedNearFar",(e=>e.shadowMap.nearFar??[1,100])),new h.p("viewshedVolumeOffset",(e=>e.volumeOffset)),new m.A("viewshedShadowMap",(e=>e.shadowMap.depthTexture)),new f.G("viewshedProjectionMatrices",(e=>e.projectionMatrices),6),new f.G("viewshedViewMatrices",(e=>e.viewMatrices),6),new _._("viewshedNumFaces",(e=>e.shadowMap.numActiveFaces)),new u.O("viewshedAtlasRegions",(e=>e.shadowMap.atlasRegions.flat()),24),new m.A("normalMap",(e=>e.normals))),t.constants.add("visibleColor","vec4",[0,1,0,.5]),t.constants.add("occludedColor","vec4",[1,0,0,.5]),t.code.add(p.H`vec2 getViewshedUv(vec4 worldPosition, int face) {
mat4 viewshedMatrix = viewshedProjectionMatrices[face];
vec4 viewshedUv4 = viewshedMatrix * worldPosition;
vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;
return viewshedUv.xy;
}
float viewshedDepthToFloat(float depth) {
return (depth - viewshedNearFar[0]) / (viewshedNearFar[1] - viewshedNearFar[0]);
}
float getOrthographicDepthToViewshed(vec4 worldPosition, int face) {
mat4 viewshedViewMatrix = viewshedViewMatrices[face];
vec4 viewshedUv4 = viewshedViewMatrix * worldPosition;
vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;
float depth = -viewshedUv.z;
return viewshedDepthToFloat(depth);
}
float viewshedReadShadowMapDepth(sampler2D _viewshedShadowmap, ivec2 uv) {
return texelFetch(_viewshedShadowmap, uv, 0).r;
}
float viewshedFilterShadow(sampler2D _viewshedShadowmap, vec2 uv) {
vec2 uvScaled = uv * vec2(textureSize(_viewshedShadowmap, 0));
vec2 st    = fract(uvScaled);
ivec2 base = ivec2(uvScaled);
float s00 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x,     base.y    ));
float s10 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x + 1, base.y    ));
float s11 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x + 1, base.y + 1));
float s01 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x,     base.y + 1));
return mix(mix(s00, s10, st.x), mix(s01, s11, st.x), st.y);
}
float viewshedTextureAtlasLookup(sampler2D _viewshedShadowmap, vec2 uv, vec4 atlasRegion) {
vec2 atlasScale = atlasRegion.zw - atlasRegion.xy;
vec2 uvAtlas = fract(uv) * atlasScale + atlasRegion.xy;
return viewshedFilterShadow(_viewshedShadowmap, uvAtlas);
}
float getDepthFromShadowMap(vec2 uv, int face) {
int index = 4 * face;
float umin = viewshedAtlasRegions[index];
float umax = viewshedAtlasRegions[index + 1];
float vmin = viewshedAtlasRegions[index + 2];
float vmax = viewshedAtlasRegions[index + 3];
vec4 atlasRegion = vec4(umin, vmin, umax, vmax);
return viewshedTextureAtlasLookup(viewshedShadowMap, uv, atlasRegion);
}
struct ViewshedPoint {
int face;
vec2 uv;
bool isWithin;
float orthographicDepth;
};
mat3 rotationMatrix(vec3 axis, float angle)
{
float s = sin(angle);
float c = cos(angle);
float oc = 1.0 - c;
return mat3(
oc * axis.xxz * axis.xyx + vec3(c, axis.zy) * vec3(1., -s, s),
oc * axis.xyy * axis.yyz + vec3(axis.z, c, axis.x) * vec3(s, 1., -s),
oc * axis.zyz * axis.xzz + vec3(axis.yx, c) * vec3(-s, s, 1.)
);
}
float distanceToPlane(vec3 position, vec3 normal) {
return dot(position, normal);
}
bool outsideViewshed(float distance) {
return distance > -viewshedVolumeOffset;
}
bool isWithinViewshed(vec3 position) {
float positionLength = length(position - viewshedObserverOffset);
float farSphereDistance = positionLength - viewshedNearFar[1];
if (outsideViewshed(farSphereDistance)) { return false; }
float nearSphereDistance = viewshedNearFar[0] - positionLength;
if (outsideViewshed(nearSphereDistance)) { return false; }
vec3 westVector = normalize(cross(viewshedUpVector, viewshedTargetVector));
bool leftOfTarget = distanceToPlane(position, westVector) > 0.0;
if (viewshedFOVs[0] < TWO_PI) {
float horAngle = viewshedFOVs[0] / 2.0;
horAngle = leftOfTarget ? horAngle : -horAngle;
vec3 sideVector = viewshedTargetVector * rotationMatrix(viewshedUpVector, horAngle);
bool inFront = distanceToPlane(position, sideVector) > 0.0;
if (inFront) {
vec3 sideNormal = cross(viewshedUpVector, sideVector) * (leftOfTarget ? 1. : -1.);
float sideDistance = distanceToPlane(position, normalize(sideNormal));
if (outsideViewshed(sideDistance)) { return false; }
} else if (viewshedFOVs[0] < PI) { return false; }
}
if (viewshedFOVs[1] < PI) {
float t = dot(viewshedUpVector, position);
vec3 nProjVector = normalize(position - t * viewshedUpVector);
float heading = acos(clamp(dot(normalize(viewshedTargetVector), nProjVector), -1.0, 1.0));
heading = leftOfTarget ? heading : -heading;
bool aboveTarget = distanceToPlane(position, viewshedUpVector) > 0.0;
float verFOV = viewshedFOVs[1] / 2.0;
verFOV = aboveTarget ? -verFOV : verFOV;
mat3 rotateByHeading = rotationMatrix(viewshedUpVector, heading);
vec3 sideVector = viewshedTargetVector * rotationMatrix(westVector, verFOV) * rotateByHeading;
vec3 leftVector = westVector * rotateByHeading;
vec3 sideNormal = cross(sideVector, leftVector) * (aboveTarget ? 1. : -1.);
float sideDistance = distanceToPlane(position, normalize(sideNormal));
if (outsideViewshed(sideDistance)) { return false; }
}
return true;
}
bool getViewshedPoint(vec4 localPosition, out ViewshedPoint point) {
for(int i=0; i < viewshedNumFaces; i++) {
vec2 viewshedUv = getViewshedUv(localPosition, i);
if (viewshedUv.x > 0. && viewshedUv.x < 1. && viewshedUv.y > 0. && viewshedUv.y < 1.) {
float orthoDepth = getOrthographicDepthToViewshed(localPosition, i);
if (orthoDepth >= 0.) {
bool isWithin = isWithinViewshed(localPosition.xyz);
point = ViewshedPoint(i, viewshedUv, isWithin, orthoDepth);
return true;
}
}
}
return false;
}
float normalCosAngle(float linearDepth, vec3 localPosition) {
vec4 normal4 = texture(normalMap, uv);
vec3 normalN = normalize(normal4.xyz * 2.0 - 1.0);
vec3 normal =  normalize((inverseViewNormalMatrix * vec4(normalN, 1.0)).xyz);
vec3 viewingDir = normalize(localPosition);
return dot(normal, viewingDir);
}`),t.main.add(p.H`float depth = depthFromTexture(depthTexture, uv);
if (depth >= 1.0 || depth <= 0.0) {
return;
}
float linearDepth = linearizeDepth(depth);
vec4 localPosition = reconstructLocalPosition(gl_FragCoord.xy, linearDepth);
ViewshedPoint point;
bool foundFace = getViewshedPoint(localPosition, point);
if (!foundFace || !point.isWithin) {
return;
}
float viewshedDepth = getDepthFromShadowMap(point.uv, point.face);
float distance = point.orthographicDepth;
bool visible = distance < viewshedDepth;
fragColor = visible ? visibleColor : occludedColor;
float cosAngle = normalCosAngle(linearDepth, localPosition.xyz);
float threshold = -0.01;
if (cosAngle > threshold) {
fragColor = occludedColor;
}`),e}const V=(0,r.Ue)(),S=Object.freeze(Object.defineProperty({__proto__:null,ViewshedPassParameters:b,build:y},Symbol.toStringTag,{value:"Module"}))},11674:function(e,t,i){i.d(t,{p:function(){return l}});var s=i(73440),r=i(50702),n=i(76329),a=i(17155),o=(i(61432),i(96711),i(83850),i(48023));const l=e=>{let t=class extends(n.Z.EsriPromiseMixin(e)){constructor(){super(...arguments),this.parent=null,this._userInteractive=!1,this._interactiveViewModelCount=0}get interactive(){return this._interactiveViewModelCount>0||this._userInteractive}set interactive(e){this._userInteractive=e}get updating(){return!1}get visible(){return null==this.parent||this.parent.visible&&!this.parent.suspended}set visible(e){this._overrideIfSome("visible",e)}forceInteractive(){return this._interactiveViewModelCount++,(0,r.kB)((()=>this._interactiveViewModelCount--))}};return(0,s._)([(0,a.Cb)({constructOnly:!0})],t.prototype,"parent",void 0),(0,s._)([(0,a.Cb)({constructOnly:!0})],t.prototype,"view",void 0),(0,s._)([(0,a.Cb)({type:Boolean})],t.prototype,"interactive",null),(0,s._)([(0,a.Cb)()],t.prototype,"_userInteractive",void 0),(0,s._)([(0,a.Cb)({readOnly:!0})],t.prototype,"updating",null),(0,s._)([(0,a.Cb)()],t.prototype,"visible",null),(0,s._)([(0,a.Cb)()],t.prototype,"_interactiveViewModelCount",void 0),t=(0,s._)([(0,o.j)("esri.views.3d.analysis.AnalysisView3D")],t),t}},41531:function(e,t,i){i.d(t,{AN:function(){return d},C7:function(){return V},Ci:function(){return x},Eu:function(){return y},G0:function(){return p},GI:function(){return a},GW:function(){return b},K_:function(){return S},L0:function(){return l},Lf:function(){return f},Mr:function(){return o},P3:function(){return h},QG:function(){return M},Qf:function(){return O},Wp:function(){return u},XC:function(){return c},Yn:function(){return D},ZE:function(){return _},ae:function(){return T},cf:function(){return C},fg:function(){return w},sz:function(){return m},tW:function(){return n},tv:function(){return g},v9:function(){return v},yy:function(){return R}});var s=i(61432),r=i(99574);const n=(0,s.Z)("mac")?"Meta":"Control",a="Shift",o=2,l=1.15,c=1.15,d=2500,h=.02,u=Math.cos((0,r.Vl)(45)),p=Math.cos((0,r.Vl)(5)),_=.95,v=.3,f=2,w=1,m=3,g=11,b=22.5,y=40,V=48,S=2.25,M=4,C=1,D=.3,O=6,R=4,x=1600,T=.4},44976:function(e,t,i){i.r(t),i.d(t,{default:function(){return $t}});var s=i(73440),r=i(37877),n=i(70880),a=i(61432),o=i(96711),l=i(83986),c=i(61100),d=i(90403),h=i(17155),u=(i(83850),i(48023)),p=i(24910),_=i(82846),v=i(13132),f=i(774),w=i(47566),m=i(11674),g=i(1505),b=i(50702),y=i(53147),V=i(28947),S=i(99574),M=i(31865),C=i(10934),D=i(32420),O=i(19596);const R=(0,S.Vl)(2);const x=new class{constructor(){this.collisionRadius=5,this.fovUnfocusedArcWidth=4,this.fovFocusedArcWidth=2*this.fovUnfocusedArcWidth,this.scaleOrientSize=90,this.scaleOrientHandleRadius=.025,this.scaleOrientMinDistance=1,this.scaleOrientArrowTipLength=.3,this.scaleOrientArrowTipFocusMultiplier=2/1.5,this.observerSize=5,this.hoverTimeoutMilliseconds=1e3,this.viewAngleThreshold=10}getFovArcWidth(e){return e?this.fovFocusedArcWidth:this.fovUnfocusedArcWidth}getScaleOrientArrowTipLength(e){return this.scaleOrientArrowTipLength*(e?this.scaleOrientArrowTipFocusMultiplier:1)}};const T=new class{constructor(){this.frameWidthNotSelected=.3,this.frameWidthSelected=1,this.frameColor=new y.Z([255,255,255,.99]),this.observerPointConfiguration={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0,color:y.Z.toUnitRGBA(new y.Z([3,252,111,1]))},this.shapeMaterialParameters={color:[.33,.33,.33,.25],renderOccluded:O.yD.Occlude,cullFace:D.Vr.Back,writeDepth:!1}}};var P=i(34753),A=i(60508),E=i(77773),U=i(3480),F=i(29292),I=i(95437),z=i(93568),H=i(56172),j=i(12818),L=i(89420),G=i(77811),N=i(23857),k=i(69892),W=i(59758);function B({tiltedUpVector:e,rightVector:t,observerRenderSpace:i},s){const r=(0,G.Aq)(e,t,i,s);return r[12]=0,r[13]=0,r[14]=0,r}function Z(e,t,i,s){const r=(0,_.Ue)(),n=(0,E.st)(i.plane),a=function(e,t){const i=q;e.renderCoordsHelper.toRenderCoords(e.camera.position,i);const s=(0,k.kE)(e,i,e.camera.heading,e.camera.tilt,(0,W.dp)()).direction;return(0,S.BV)((0,p.p)(s,t))-90}(t,n);let o;if(Math.abs(a)>x.viewAngleThreshold)o=e.next((0,N._N)(t,i.plane));else{const r=(0,E.Yq)(s.targetRenderSpace,i.basis1,(0,E.Ue)()),n=(0,p.n)(q,i.basis1),a=(0,p.n)(X,i.basis2);o=e.next((0,N._N)(t,r)).next((e=>{const t=e=>{const t=(0,p.e)((0,p.a)(Q,e,i.origin),a),r=Math.acos((0,S.uZ)(t/s.farDistanceRenderSpace,-1,1)),o=Math.sin(r)*s.farDistanceRenderSpace;return(0,p.f)((0,_.Ue)(),i.origin,(0,p.f)((0,_.Ue)(),(0,p.g)(Q,n,o),(0,p.g)(J,a,t)))},r=t(e.renderStart),o=t(e.renderEnd);return{...e,renderStart:r,renderEnd:o}}))}return o.next((e=>{"start"===e.action&&(0,p.c)(r,e.renderStart);const t=(0,S.BV)((0,G.Gd)(r,e.renderEnd,i.origin,n));return{...e,deltaAngle:t}}))}function Y(e,t,i,s){return(0,M.Us)(K,i,s),(0,p.t)(e,t,K)}const q=(0,_.Ue)(),X=(0,_.Ue)(),Q=(0,_.Ue)(),J=(0,_.Ue)(),K=(0,C.Ue)();var $=i(3682),ee=i(23496),te=i(59979),ie=i(72626),se=i(86026),re=i(61719),ne=i(19843),ae=i(69880),oe=i(55541);class le extends ie.w{constructor(e){super(),this._handles=new j.Z,this._tool=e.tool,this._view=e.view,this._focusedArcMaterial=this._createArcMaterial(!0),this._unfocusedArcMaterial=this._createArcMaterial(!1),this._createManipulators(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles=(0,c.SC)(this._handles),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._tool=null,this._view=null,this._manipulators=null}createDragPipeline(e,t){const i=Object.values(this._manipulators);return(0,b.AL)(i.map((({manipulator:i,side:s})=>(0,ae.Xd)(i,((i,r,n,a,o)=>{const l=function(e,{observerRenderSpace:t,targetRenderSpace:i,tiltedUpVector:s,rightVector:r,farDistanceRenderSpace:n}){const a=(0,p.a)(ue,i,t),o=ce(e)?r:s,l=(0,p.g)(pe,o,n);return(0,L.f)(t,a,l)}(s,t),c=r.next((e=>({...e,manipulatorType:te.d.SCALE,side:s}))),d=Z(c,this._view,l,t);e(i,d,n)})))))}updateManipulatorsTransform(e){e.arcCentersPoints(_e),this._forEachManipulatorInfo((t=>this._updateArcManipulatorTransform(t,e,_e[t.side])))}updateManipulatorVisuals(e){this._forEachManipulatorInfo((t=>this._updateArcManipulatorVisuals(t,e)))}_updateArcManipulatorVisuals({manipulator:e,side:t},i){const s=[];if(null!=i){const[r,n]=function(e,t,i){const{horizontalFieldOfView:s,verticalFieldOfView:r}=t,n=ce(e),a=(0,S.Vl)((0,S.uZ)((n?r:s)/2,0,15)),o=function(e,t,i,s=10){(0,re.hu)(s>1,"createArcPolylineGeometry() needs at least 2 for numVertices");const r=t-e;if(r<=0||i<=0)return[(0,_.al)(0,0,.01),(0,_.al)(0,0,-.01)];const n=[],a=r/s;for(let r=0;r<s;r++){let o=e+r*a;r===s-1&&(o=t);const l=Math.cos(o)*i,c=Math.sin(o)*i,d=(0,_.al)(l-i,0,c);n.push(d)}return n}(-a/2,a/2,n?1:Math.max(Math.sin((0,S.Vl)(90-r/2)),.1));return[(0,se.rh)(i,o),o]}(t,i,this._unfocusedArcMaterial);s.push(new ee.r(r,oe.Q9.Unfocused),new ee.r(r.instantiate({material:this._focusedArcMaterial}),oe.Q9.Focused)),e.collisionType={type:"line",paths:[n]}}e.renderObjects=s,e.radius=x.collisionRadius}_updateArcManipulatorTransform({manipulator:e,side:t},i,s){const r=i.horizontalFieldOfView,n=(0,S.Vl)(i.verticalFieldOfView/2),a=(0,S.Vl)(r/2),o=ce(t);e.renderLocation=s;const l=(0,C.Ue)(),c=e=>{(0,M.Jp)(l,e,l)};c((0,M.gT)(he,(0,S.Vl)(-90))),o||c((0,M.aC)(he,n));const d=i.farDistanceRenderSpace;let h,u;c((0,M.xJ)(he,(0,p.i)(ue,d,d,d))),c((0,M.QO)(he,function(e){return function(e){switch(e){case"left":return 0;case"bottom":return 1;case"right":return 2;case"top":return 3}}(e)*de}(t))),c(B(i,he)),o?(h=a,u=i.tiltedUpVector):(u=i.rightVector,h=n),h*="right"===t||"bottom"===t?-1:1;const _=(0,M.Us)(he,h,u);null!=_&&c(_),e.modelTransform=l}_createManipulators(){const e=this._createArcManipulator("left"),t=this._createArcManipulator("right"),i=this._createArcManipulator("top"),s=this._createArcManipulator("bottom");this._manipulators={left:e,right:t,top:i,bottom:s},[[s.manipulator,i.manipulator],[e.manipulator,t.manipulator]].forEach((([e,t])=>{e.metadata={pairedManipulator:t},t.metadata={pairedManipulator:e}}))}_createArcManipulator(e){const t=new $.Z({view:this._view,autoScaleRenderObjects:!1,worldSized:!0}),i={manipulator:t,side:e};return this._updateArcManipulatorVisuals(i),this._handles.add(t.events.on("focus-changed",(e=>{const i=t.metadata?.pairedManipulator;null!=i&&(i.hovering!==t.hovering&&(i.hovering=t.hovering),i.grabbing!==t.grabbing&&(i.grabbing=t.grabbing))}))),i}_createArcMaterial(e){const t=x.getFovArcWidth(e),i=new ne.U({renderOccluded:O.yD.OccludeAndTransparent,isDecoration:!0,width:t});return this._handles.add((0,d.YP)((()=>y.Z.toUnitRGBA(this._view.effectiveTheme.accentColor)),(e=>i.setParameters({color:e})),d.nn)),i}forEachManipulator(e){Object.values(this._manipulators).forEach((({manipulator:t})=>e(t,te.d.SCALE)))}_forEachManipulatorInfo(e){Object.values(this._manipulators).forEach((t=>e(t)))}get test(){return{manipulators:this._manipulators}}}function ce(e){return"left"===e||"right"===e}const de=Math.PI/2,he=(0,C.Ue)(),ue=(0,_.Ue)(),pe=(0,_.Ue)(),_e={top:(0,_.Ue)(),bottom:(0,_.Ue)(),left:(0,_.Ue)(),right:(0,_.Ue)()};var ve=i(12659),fe=i(41531),we=i(80147);class me extends $.Z{constructor(e,t){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:x.collisionRadius}),this._handles=new j.Z,this._setupManipulatorVisual(t)}destroy(){this._handles.remove(),super.destroy()}_setupManipulatorVisual(e){const t=this._createMaterial(),i=[(0,_.al)(0,0,0),(0,_.al)(0,0,1)],s=(0,se.PD)(t,i,e,16,!1),r=(0,se.PD)(t,i,e*fe.Mr,16,!1),n=ge(!1,t,e),a=ge(!0,t,e),o=(0,C.Ue)();(0,M.vc)(o,i[i.length-1]),(0,M.dC)(o,o,(0,M.aC)(be,Math.PI/2)),(0,M.dC)(o,o,(0,M.gT)(be,Math.PI/2)),n.transformation=o,a.transformation=o,this.renderObjects=[new ee.r(s,oe.Q9.Unfocused),new ee.r(r,oe.Q9.Focused),new ee.r(n,oe.Q9.Unfocused),new ee.r(a,oe.Q9.Focused)];const l=(0,_.al)(0,x.getScaleOrientArrowTipLength(!0),0),c=(0,p.t)(l,l,o),d=[...i,c];this.collisionType={type:"line",paths:[d]}}_createMaterial(){const e=new we.E({cullFace:D.Vr.Back,renderOccluded:O.yD.OccludeAndTransparent,isDecoration:!0});return this._handles.add((0,d.YP)((()=>y.Z.toUnitRGBA(this.view.effectiveTheme.accentColor)),(t=>e.setParameters({color:t})),d.nn)),e}}function ge(e,t,i){const s=x.getScaleOrientArrowTipLength(e);let r=2*i;e&&(r*=fe.Mr);const n=s/2;return(0,se.DA)(t,s,n,n,r,0)}const be=(0,C.Ue)();var ye=i(45501);class Ve extends ie.w{constructor(e){super(),this._handles=new j.Z,this._tool=e.tool,this._view=e.view;const t=x.scaleOrientHandleRadius;this._manipulatorHeading=new me(this._view,t),this._manipulatorTilt=new me(this._view,t),this._manipulatorDistance=new me(this._view,t),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles.destroy(),this.forEachManipulator((e=>{this._tool.manipulators.remove(e),e.destroy()})),this._manipulatorHeading=null,this._manipulatorTilt=null,this._manipulatorDistance=null,this._tool=null,this._view=null}createHeadingDragPipeline(e,t){return(0,ae.Xd)(this._manipulatorHeading,((i,s,r,n,a)=>{const o=this._view,{tiltParallelToSurface:l,farDistanceRenderSpace:c,upVector:d,observerRenderSpace:h,targetRenderSpace:u,rightVector:_}=t,v=Math.sin((0,S.Vl)(l))*c,f=(0,p.f)(Ce,h,(0,p.g)(De,d,v)),w=(0,p.a)(De,u,f),m=(0,p.g)(Oe,_,(0,p.H)(w)),g=Z(s,o,(0,L.f)(f,w,m),t).next((e=>({...e,manipulatorType:te.d.ROTATE})));e(i,g,r)}))}createTiltDragPipeline(e,t){return(0,ae.Xd)(this._manipulatorTilt,((i,s,r,n,a)=>{const{observerRenderSpace:o,farDistanceRenderSpace:l,upVector:c,targetDirection:d}=t,h=(0,p.e)(d,c),u=(0,p.b)(Ce,d,c,-h);(0,p.g)(u,(0,p.n)(u,u),l);const _=(0,p.g)(De,c,l),v=(0,L.f)(o,u,_),f=Z(s,this._view,v,t).next((e=>({...e,manipulatorType:te.d.ROTATE})));e(i,f,r)}))}createDistanceDragPipeline(e,t){return(0,ae.Xd)(this._manipulatorDistance,((i,s,r,n,a)=>{const o=(0,ve.al)(t.observerRenderSpace,t.targetDirection),l=s.next((0,ae.kY)(this._view,i.location)).next((0,N.B2)(this._view,o)).next((e=>({...e,manipulatorType:te.d.SCALE})));e(i,l,r)}))}updateManipulators(e){const{targetRenderSpace:t}=e;this._manipulatorHeading.renderLocation=t,this._manipulatorTilt.renderLocation=t,this._manipulatorDistance.renderLocation=t;const i=(0,C.Ue)(),s=e=>{(0,M.Jp)(i,e,i)},r=x.scaleOrientSize*(ye.E5/ye.dB);s((0,M.xJ)(Se,(0,p.i)(Ce,r,r,r))),s(B(e,Se));const n=x.scaleOrientHandleRadius*fe.Mr*r,a=(0,p.g)(Ce,e.targetDirection,n);s((0,M.vc)(Se,a));const o=(0,M.QO)(Se,-Re);(0,M.dC)(o,o,(0,M.gT)(Me,-Re)),this._manipulatorHeading.modelTransform=(0,M.dC)((0,C.Ue)(),i,o);const l=(0,M.gT)(Se,Re);(0,M.dC)(l,l,(0,M.QO)(Me,Math.PI)),this._manipulatorTilt.modelTransform=(0,M.Jp)((0,C.Ue)(),i,l),this._manipulatorDistance.modelTransform=i}forEachManipulator(e){e(this._manipulatorHeading,te.d.ROTATE),e(this._manipulatorTilt,te.d.ROTATE),e(this._manipulatorDistance,te.d.SCALE)}}const Se=(0,C.Ue)(),Me=(0,C.Ue)(),Ce=(0,_.Ue)(),De=(0,_.Ue)(),Oe=(0,_.Ue)(),Re=Math.PI/2;i(8914),i(88194);class xe extends $.Z{constructor(e,t){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:x.observerSize,interactive:!1}),this._handles=new j.Z;const i=(0,G.EA)(this._color);this.renderObjects=[new ee.r((0,se.PI)(i,x.observerSize,32,32))],t.manipulators.add(this),this._handles.add([(0,d.YP)((()=>this._color),(e=>{i.setParameters({color:e})}),d.nn)])}destroy(){this._handles.remove(),super.destroy()}get _color(){return y.Z.toUnitRGBA(this.view.effectiveTheme.accentColor)}}(0,s._)([(0,h.Cb)()],xe.prototype,"_color",null);var Te=i(37727),Pe=i(18208);const Ae=Symbol("dragHandles"),Ee=Symbol("hideManipulators"),Ue=Symbol("hideFoVManipulators"),Fe=Symbol("hideObserverManipulator");let Ie=class extends n.Z{constructor(e){super(e),this._moveManipulation=null,this._observerManipulator=null,this._fieldOfViewManipulation=null,this._scaleOrientManipulation=null,this._forceHoveringTask=null,this._forceHoveringTestPromise=null,this._grabbing=!1,this.viewshedComputedData=null}initialize(){this._moveManipulation=this._createMoveManipulation(),this._fieldOfViewManipulation=new le({view:this.view,tool:this.parentTool}),this._scaleOrientManipulation=new Ve({view:this.view,tool:this.parentTool}),this._observerManipulator=new xe(this.view,this.parentTool),this.addHandles([(0,d.YP)((()=>this.viewshedComputedData?.observerRenderSpace),(e=>{null!=e&&(this._moveManipulation.renderLocation=e,this._observerManipulator.renderLocation=e)}),d.tX),(0,d.YP)((()=>this.viewshedComputedData?.heading),(e=>{e&&(this._moveManipulation.angle=(0,S.Vl)(90-e))}),d.nn),(0,d.YP)((()=>{const{viewshedComputedData:e}=this;return{viewshedComputedData:e,observer:e?.observer}}),(({viewshedComputedData:e,observer:t},i)=>{this._grabbing&&t!==i?.observer||(this.removeHandles(Ae),e?.valid&&this.addHandles([this._buildObserverDragPipeline(e),this._buildFOVDragPipeline(e),this._buildScaleOrientDragPipeline(e)].filter(U.pC),Ae))}),d.nn),(0,d.YP)((()=>{const e=this.viewshedComputedData;return e?.valid?{viewshedCompData:e,target:e.targetRenderSpace,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView}:null}),(e=>{null!=e&&this._fieldOfViewManipulation.updateManipulatorsTransform(e.viewshedCompData)}),d.nn),(0,d.YP)((()=>{const e=this.viewshedComputedData;return e?.valid?{viewshedCompData:e,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView,tilt:e.tilt}:null}),(e=>{null!=e&&this._fieldOfViewManipulation.updateManipulatorVisuals(e.viewshedCompData)}),d.nn),(0,d.YP)((()=>{const e=this.analysisViewData.visible&&(this.viewshedComputedData?.valid??!1),t=this.parentTool.selectedViewshedComputedData===this.viewshedComputedData;return{fovManipulationAvailable:e&&!this.parentTool.isPlacingTarget,nonFOVManipulationAvailable:e&&(!this.parentTool.creating||t)}}),(({fovManipulationAvailable:e,nonFOVManipulationAvailable:t})=>{this._moveManipulation.available=t,this._scaleOrientManipulation.available=t,this._observerManipulator.available=t,this._fieldOfViewManipulation.available=e}),d.nn),(0,d.YP)((()=>{const e=this.viewshedComputedData;if(!e?.valid)return null;const{observer:t,target:i,verticalFieldOfView:s,horizontalFieldOfView:r}=e;return{viewshedCompData:e,observer:t,target:i,verticalFieldOfView:s,horizontalFieldOfView:r}}),(e=>{null!=e&&this._scaleOrientManipulation.updateManipulators(e.viewshedCompData)}),d.nn)]);this._forEachManipulator((e=>{const t=this.analysisViewData;this.addHandles([e.events.on("focus-changed",(()=>{const e=this._someManipulatorHovering();e&&this.parentTool.subToolHandles.forEach((({subTool:e})=>{e._resetHoveringTask()})),this._someManipulatorSelected()||e||(this._forceHoveringTask=(0,F.vr)((async e=>{await(this._forceHoveringTestPromise??(0,z.e4)(x.hoverTimeoutMilliseconds,e)),(0,z.k_)(e),this._forceHoveringTask=null,this._updateManipulatorVisibility()})))})),e.events.on("grab-changed",(i=>{this._grabbing="start"===i.action,"end"===i.action&&t.tool?.updateInteractionVisualsVisibility(),this.parentTool.subToolHandles.forEach((({subTool:e})=>{e!==this&&e._setInteractive(!this._grabbing)})),this._setInteractive((t=>t.hasManipulator(e)||!this._grabbing))})),e.events.on("drag",(e=>{"start"===e.action&&t.tool?.updateInteractionVisualsVisibility()}))])}))}destroy(){this._forceHoveringTask=(0,c.IM)(this._forceHoveringTask),this._moveManipulation=(0,c.SC)(this._moveManipulation),this._fieldOfViewManipulation=(0,c.SC)(this._fieldOfViewManipulation),this._scaleOrientManipulation=(0,c.SC)(this._scaleOrientManipulation),this.parentTool.manipulators.remove(this._observerManipulator),this._observerManipulator=(0,c.SC)(this._observerManipulator)}get viewshed(){return this.viewshedComputedData?.viewshed}get grabbing(){return this._grabbing}get observer(){return this.viewshed?.observer}set observer(e){const t=this.viewshed;null!=t&&(t.observer=e)}get discManipulator(){return this._moveManipulation.xyManipulation.discManipulator}get moveInteractionState(){const{dragging:e,grabbing:t}=this._moveManipulation;return{dragging:e,grabbing:t}}get scaleOrientInteractionState(){const{dragging:e,grabbing:t}=this._scaleOrientManipulation;return{dragging:e,grabbing:t}}_setInteractive(e){const t="boolean"==typeof e;this._forEachManipulation((i=>i.interactive=t?e:e(i)))}onManipulatorSelectionChanged(){this._updateManipulatorVisibility(),this._someManipulatorSelected()||(this.analysisViewData.selectedViewshed===this.viewshed&&(this.analysisViewData.selectedViewshed=null),this._resetHoveringTask())}hasManipulator(e){let t=!1;return this._forEachManipulator((i=>{t=t||i===e})),t}_someManipulatorSelected(){return this._moveManipulation.selected||this._fieldOfViewManipulation.selected||this._scaleOrientManipulation.selected}_someManipulatorHovering(){return this._moveManipulation.hovering||this._fieldOfViewManipulation.hovering||this._scaleOrientManipulation.hovering}_createMoveManipulation(){return new Te.b({view:this.view,tool:this.parentTool,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:ye.E5})}_buildObserverDragPipeline(e){const t=e.observer;if(null==t)return null;const i=this.view.spatialReference;return this._moveManipulation.createDragPipeline(((e,s,r,n,a)=>{n=n.next((0,ae.di)(this,["observer"]));const o=(0,v.tryProjectWithZConversion)(t,i);if(null==o)return{steps:r,cancel:n};const l=Pe.c.fromGeometry(o,(0,H.wg)(this.view.viewingMode));return{steps:r.next((0,ae.$Q)({operations:l})).next((e=>(this.observer=l.data.geometry,e))),cancel:n}}),{mode:"absolute-height",offset:0},i,void 0)}_buildFOVDragPipeline(e){let t=0,i=0;return this._fieldOfViewManipulation.createDragPipeline(((s,r,n)=>{if(null==e)return{steps:r,cancel:n};const a=e.viewshed;let o=null;return n=n.next((0,ae.di)(a,["horizontalFieldOfView","verticalFieldOfView"])),{steps:r.next((s=>{"start"===s.action&&(o=null,t=e.horizontalFieldOfView,i=e.verticalFieldOfView);const r=s.deltaAngle;if(null==o&&0!==r){const e="bottom"===s.side||"left"===s.side?r>0:r<0;o=ce(s.side)?0===t&&e||360===t&&!e:0===i&&e}const n=o?function(e){return"left"===e?"right":"right"===e?"left":"top"===e?"bottom":"top"}(s.side):s.side;let l=0;switch(n){case"left":l=t/2-r;break;case"right":l=t/2+r;break;case"top":l=i+2*r;break;case"bottom":l=i-2*r}return ce(n)?(l=I.BV.normalize(l),l=l>270?0:l>180?180:l,a.horizontalFieldOfView=2*l):a.verticalFieldOfView=l,s})),cancel:n}}),e)}_buildScaleOrientDragPipeline(e){let t=0,i=0;const s=(t,i)=>(s,r,n)=>{if(null==e)return{steps:r,cancel:n};const a=e.viewshed;return n=n.next((0,ae.di)(a,[t])),{steps:r=r.next(i(a,e)),cancel:n}};return(0,b.AL)([this._scaleOrientManipulation.createHeadingDragPipeline(s("heading",((t,s)=>s=>("start"===s.action&&(i=e.heading),t.heading=I.BV.normalize(i+s.deltaAngle),s))),e),this._scaleOrientManipulation.createTiltDragPipeline(s("tilt",((i,s)=>s=>{"start"===s.action&&(t=e.tilt);let r=t+s.deltaAngle;return r<-90?r=180:r>270&&(r=0),i.tilt=He.clamp(r),s})),e),this._scaleOrientManipulation.createDistanceDragPipeline(s("farDistance",((e,t)=>i=>{const s=(0,p.a)(ze,i.renderEnd,t.observerRenderSpace),r=(0,p.H)(s)*t.metersPerUnit,n=(0,p.e)(s,t.targetDirection)<0?x.scaleOrientMinDistance:r;return e.farDistance=n,i})),e)])}_updateManipulatorVisibility(){const e=this._someManipulatorSelected(),t=null!=this._forceHoveringTask||this._someManipulatorHovering(),i=this._fieldOfViewManipulation.hovering,s=this.parentTool.creating;let r=[];const n=e=>{r.push(e.disableDisplay())};e||!s&&t?this.removeHandles(Ee):(this._scaleOrientManipulation.forEachManipulator(n),this._moveManipulation.forEachManipulator(n),this.addHandles(r,Ee),r=[]),e||!s&&t||s&&i?this.removeHandles(Ue):(this._fieldOfViewManipulation.forEachManipulator(n),this.addHandles(r,Ue)),e||!s?this.removeHandles(Fe):this.addHandles(this._observerManipulator.disableDisplay(),Fe)}_resetHoveringTask(){this._forceHoveringTask=(0,c.IM)(this._forceHoveringTask),this._updateManipulatorVisibility()}_forEachManipulator(e){this._forEachManipulation((t=>{t.forEachManipulator(e)})),e(this._observerManipulator)}_forEachManipulation(e){e(this._moveManipulation),e(this._fieldOfViewManipulation),e(this._scaleOrientManipulation)}get test(){return{moveManipulation:this._moveManipulation,fieldOfViewManipulation:this._fieldOfViewManipulation,scaleOrientManipulation:this._scaleOrientManipulation,viewshedComputedData:this.viewshedComputedData,setHoveringTimeoutPromise:e=>{this._forceHoveringTestPromise=e}}}};(0,s._)([(0,h.Cb)({constructOnly:!0})],Ie.prototype,"analysis",void 0),(0,s._)([(0,h.Cb)({constructOnly:!0})],Ie.prototype,"analysisViewData",void 0),(0,s._)([(0,h.Cb)({constructOnly:!0})],Ie.prototype,"parentTool",void 0),(0,s._)([(0,h.Cb)({constructOnly:!0,nonNullable:!0})],Ie.prototype,"view",void 0),(0,s._)([(0,h.Cb)()],Ie.prototype,"viewshed",null),(0,s._)([(0,h.Cb)()],Ie.prototype,"_grabbing",void 0),(0,s._)([(0,h.Cb)()],Ie.prototype,"grabbing",null),(0,s._)([(0,h.Cb)()],Ie.prototype,"viewshedComputedData",void 0),(0,s._)([(0,h.Cb)()],Ie.prototype,"observer",null),Ie=(0,s._)([(0,u.j)("esri.views.3d.analysis.Viewshed.ViewshedSubTool")],Ie);const ze=(0,_.Ue)(),He=new I.pE(0,180);var je=i(42930),Le=i(38078),Ge=i(82845),Ne=i(90189),ke=i(86227),We=i(18753),Be=i(21498),Ze=i(70134);const Ye=Symbol("interactionVisuals");let qe=class extends ke.f{constructor(e){super(e),this.removeIncompleteOnCancel=!1,this.automaticManipulatorSelection=!1,this._stagedViewshed=null,this._stagedViewshedComputedData=null,this._placementMode=it,this._creationState=!1,this._interactionVisualElements=null,this._settings=new je.Z({getTheme:()=>this.view.effectiveTheme}),this._selectedManipulator=null}initialize(){this._intersector=(0,Be.w)(this.view.state.viewingMode),this._createInteractionVisuals();const e=this.analysisViewData.viewshedComputedDataHandles;this.subToolHandles=(0,l.w)((()=>e),(({viewshedComputedData:e})=>{const t=new Ie({analysis:this.analysis,analysisViewData:this.analysisViewData,parentTool:this,view:this.view,viewshedComputedData:e});return{subTool:t,remove:()=>{this.selectedViewshed===e.viewshed&&(this.selectedViewshed=null),t.destroy()}}})),this.addHandles([(0,d.gx)((()=>this._valid),(()=>this.finishToolCreation()),d.tX),(0,d.YP)((()=>this._stagedViewshed),(e=>{const t=this.analysisViewData.viewshedComputedDataHandles;this._stagedViewshedComputedData=null!=e&&null!=t?this._findSubTool(e)?.viewshedComputedData:null}),d.tX),this.analysis.viewsheds.on("after-remove",(e=>{const t=this._stagedViewshed;null!=t&&e.item===t&&this.analysis.viewsheds.add(t)})),(0,d.YP)((()=>this.firstGrabbedManipulator),(e=>{if(null!=e){const t=this._findSubTool(e)?.viewshed;this.selectedViewshed=t,this._selectManipulator(e)}else this._selectedSubTool?.onManipulatorSelectionChanged()}),d.Z_),(0,d.YP)((()=>this.view.activeTool),(e=>{e!==this&&null!=e&&(this.selectedViewshed=null)})),(0,d.gx)((()=>{const e=this.selectedViewshedComputedData;return null==e?null:{subTool:this._selectedSubTool,observer:e.observerRenderSpace,target:e.targetRenderSpace}}),(e=>{const{subTool:t,observer:i,target:s}=e;t?.moveInteractionState.dragging?this._updateInteractionVisualsLocation(i,!0):t?.scaleOrientInteractionState.dragging&&this._updateInteractionVisualsLocation(s,!1)}),d.nn),(0,d.YP)((()=>this.creating),(()=>this.updateInteractionVisualsVisibility())),(0,d.YP)((()=>this.selectedViewshed),(e=>{const t=this._selectedManipulator,i=this._selectedSubTool;null==e?this._selectManipulator(null):null!=t&&i.hasManipulator(t)||this._selectManipulator(i.discManipulator)}),d.nn)])}destroy(){this.subToolHandles=(0,c.SC)(this.subToolHandles),this.removeHandles(Ye)}onDeactivate(){this.removeStaged(),this._creationState=!1}get _valid(){return this.analysisViewData.viewshedComputedDataHandles?.some((e=>e.viewshedComputedData.valid))??!1}get cursor(){return this.creating?"crosshair":null}get _selectedSubTool(){return this._findSubTool(this.selectedViewshed)}_selectManipulator(e){const t=this._selectedManipulator;t!==e&&(this._selectedManipulator=e,null!=t&&(t.selected=!1),null!=e&&(e.selected=!0),this._findSubTool(t)?.onManipulatorSelectionChanged(),this._selectedSubTool?.onManipulatorSelectionChanged())}get selectedViewshed(){return this.analysisViewData.selectedViewshed}set selectedViewshed(e){this.analysisViewData.selectedViewshed=e}get selectedViewshedComputedData(){return this._selectedSubTool?.viewshedComputedData}get stagedViewshed(){return this._stagedViewshed}get grabbing(){return this.subToolHandles.some((({subTool:e})=>e.grabbing))}get creating(){return this._creationState&&this.active}get isPlacingTarget(){return"placing-target"===this._creationState}place(e){this.selectedViewshed=null,this._placementMode=e,this._creationState="placing-observer",this._finishToolCreationIfValid()}onManipulatorSelectionChanged(){this.subToolHandles.forEach((e=>e.subTool.onManipulatorSelectionChanged()))}onInputEvent(e){switch(e.type){case"immediate-double-click":this._doubleClickHandler(e);break;case"pointer-move":this._pointerMoveHandler(e);break;case"key-down":We.Sn.cancel===e.key?this._cancelKeyHandler(e):We.Sn.delete.includes(e.key)&&this._deleteKeyHandler();break;case"hold":this.updateInteractionVisualsVisibility(!0)}}onInputEventAfter(e){"immediate-click"===e.type&&this._clickPlacementHandler(e)}onActivate(){this._placementMode=it}_clickPlacementHandler(e){if(!this.creating||this.hasFocusedManipulators)return;const t=this._intersectScreen(e,tt);if(null!=t){if("placing-observer"===this._creationState){t.mapPoint.z=(t.mapPoint.z??0)+1.5;const e=new P.Z({observer:t.mapPoint.clone(),feature:t.feature});this.analysis.viewsheds.add(e),this._stagedViewshed=e,this._creationState="placing-target",this._updateStagedViewshed(t.scenePoint)}else if("placing-target"===this._creationState){this._updateStagedViewshed(t.scenePoint);const e=this._stagedViewshed;this._stagedViewshed=null,"multiple"===this._placementMode?this._creationState="placing-observer":(this._creationState=!1,this._stagedViewshed=null,this._finishToolCreationIfValid(),this.view.activeTool=null),this.selectedViewshed=e}e.stopPropagation()}}_doubleClickHandler(e){this.creating&&(this.removeStaged(),this._creationState=!1,this.view.activeTool=null,e.stopPropagation())}_pointerMoveHandler(e){if(!this.creating)return;const t=this._intersectScreen(e,tt);null!=t&&(this._updateInteractionVisualsLocation(t.scenePoint,!1),this._updateStagedViewshed(t.scenePoint))}_cancelKeyHandler(e){this.creating?this._onCancelWhileCreating(e):this.grabbing||(this.selectedViewshed=null,e.stopPropagation())}_onCancelWhileCreating(e){const t=this.removeStaged();this._finishToolCreationIfValid(),t?(this._creationState="placing-observer",this.selectedViewshed=null,"multiple"===this._placementMode&&e.stopPropagation()):this._creationState=!1}_deleteKeyHandler(){this.creating&&(this.removeStaged(),this._creationState="placing-observer"),null!=this.selectedViewshed&&this.analysis.viewsheds.remove(this.selectedViewshed)}_finishToolCreationIfValid(){this._valid&&this.finishToolCreation()}_updateStagedViewshed(e){const t=this._stagedViewshed,i=this._stagedViewshedComputedData;if(null==t||null==i)return;const{heading:s,tilt:r,farDistance:n}=function(e,t,i){const s=t.observerRenderSpace,r=(0,p.a)(Xe,i,s),n=(0,p.H)(r)*t.metersPerUnit,a=e.renderCoordsHelper.basisMatrixAtPosition(s,$e),o=(0,p.i)(Qe,a[8],a[9],a[10]),l=(0,E.Yq)(s,o,et),c=(0,E.nF)(l,i,Je),d=(0,p.a)(c,c,s),h=((0,p.H)(d)<1e-4?90:(0,S.BV)((0,p.p)(r,d)))*((0,p.e)(o,r)<0?-1:1)+90,u=(0,p.i)(Ke,a[4],a[5],a[6]),_=(0,S.BV)((0,p.p)(u,d)),v=(0,p.i)(Ke,a[0],a[1],a[2]);return{heading:(0,p.e)(d,v)<0?360-_:_,tilt:h,farDistance:n}}(this.view,i,e);t.farDistance=n,t.tilt=r,t.heading=s}removeStaged(){const e=this._stagedViewshed;return null!=e&&(this._stagedViewshed=null,this.analysis.viewsheds.remove(e),!0)}_intersectScreen(e,t){const i=(0,Ze.Sj)(e);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(i,this._intersector);const s=this._intersector.results.min,r=t.scenePoint;if(!s.getIntersectionPoint(r))return null;const n=t.mapPoint;return n.spatialReference=this.view.spatialReference,this.view.renderCoordsHelper.fromRenderCoords(r,n),null==n?null:(t.feature=(0,Ne.tB)(s,this.view),t)}_createInteractionVisuals(){this.removeHandles(Ye);const e=this._settings.visualElements,t=new Ge.W({view:this.view,attached:!1,style:{glowWidth:e.heightPlane.glowWidth,innerWidth:e.heightPlane.innerWidth},isDecoration:!0}),i=new Le.V({view:this.view,extensionType:e.zVerticalLine.extensionType,attached:!1,innerWidth:1,writeDepthEnabled:!1,renderOccluded:O.yD.OccludeAndTransparent,isDecoration:!0});this._interactionVisualElements={laserline:t,verticalLine:i},this.addHandles([(0,d.YP)((()=>e.zVerticalLine),(e=>e.apply(i)),d.tX),(0,d.YP)((()=>e.heightPlane),(e=>e.apply(t)),d.tX),(0,b.kB)((()=>{t.destroy(),i.destroy(),this._interactionVisualElements=null}))],Ye)}updateInteractionVisualsVisibility(e=!1){const t=this.creating,i=this.analysisViewData.visible,s=this._selectedSubTool,r=this.selectedViewshedComputedData,n=(e,t)=>{const i=this._interactionVisualElements;null!=i&&(i.verticalLine.attached=t,i.laserline.attached=e)};if(t)return void n(i,!1);if(null==s||null==r)return void n(!1,!1);const a=s.moveInteractionState,o=e?a.grabbing:a.dragging,l=s.scaleOrientInteractionState,c=e?l.grabbing:l.dragging,d=i&&(o||c);if(n(d,o),d){const e=o?r.observerRenderSpace:r.targetRenderSpace;this._updateInteractionVisualsLocation(e,o)}}_updateInteractionVisualsLocation(e,t){const i=this._interactionVisualElements;if(null==i)return;const{laserline:s,verticalLine:r}=i;s.heightManifoldTarget=e,s.intersectsWorldUpAtLocation=t?e:null,null!=e&&r.setStartEndFromWorldDownAtLocation(e)}_findSubTool(e){if(null==e)return null;const t=e instanceof $.Z?t=>t.subTool.hasManipulator(e):t=>t.subTool.viewshed===e;return this.subToolHandles?.find(t)?.subTool}get test(){}};(0,s._)([(0,h.Cb)({constructOnly:!0})],qe.prototype,"view",void 0),(0,s._)([(0,h.Cb)()],qe.prototype,"analysisViewData",void 0),(0,s._)([(0,h.Cb)()],qe.prototype,"removeIncompleteOnCancel",void 0),(0,s._)([(0,h.Cb)()],qe.prototype,"automaticManipulatorSelection",void 0),(0,s._)([(0,h.Cb)({constructOnly:!0})],qe.prototype,"analysis",void 0),(0,s._)([(0,h.Cb)()],qe.prototype,"subToolHandles",void 0),(0,s._)([(0,h.Cb)()],qe.prototype,"_stagedViewshed",void 0),(0,s._)([(0,h.Cb)()],qe.prototype,"_stagedViewshedComputedData",void 0),(0,s._)([(0,h.Cb)()],qe.prototype,"_placementMode",void 0),(0,s._)([(0,h.Cb)()],qe.prototype,"_creationState",void 0),(0,s._)([(0,h.Cb)()],qe.prototype,"_valid",null),(0,s._)([(0,h.Cb)({readOnly:!0})],qe.prototype,"cursor",null),(0,s._)([(0,h.Cb)()],qe.prototype,"_selectedManipulator",void 0),(0,s._)([(0,h.Cb)()],qe.prototype,"_selectedSubTool",null),(0,s._)([(0,h.Cb)()],qe.prototype,"selectedViewshed",null),(0,s._)([(0,h.Cb)()],qe.prototype,"selectedViewshedComputedData",null),(0,s._)([(0,h.Cb)()],qe.prototype,"stagedViewshed",null),(0,s._)([(0,h.Cb)()],qe.prototype,"grabbing",null),(0,s._)([(0,h.Cb)()],qe.prototype,"creating",null),(0,s._)([(0,h.Cb)()],qe.prototype,"isPlacingTarget",null),qe=(0,s._)([(0,u.j)("esri.views.3d.analysis.Viewshed.ViewshedTool")],qe);const Xe=(0,_.Ue)(),Qe=(0,_.Ue)(),Je=(0,_.Ue)(),Ke=(0,_.Ue)(),$e=(0,C.Ue)(),et=(0,E.Ue)(),tt={mapPoint:new A.Z,scenePoint:(0,_.Ue)(),feature:null},it="multiple";var st=i(80075),rt=i(68830),nt=i(49102),at=i(81749),ot=i(25952),lt=i(52061);class ct extends nt._{constructor(e){super(e),this._material=null,this._viewshedComputedData=null,this._material=new we.E({...T.shapeMaterialParameters,isDecoration:this.isDecoration,writeDepth:!1}),this.applyProperties(e)}get viewshedComputedData(){return this._viewshedComputedData}set viewshedComputedData(e){this._viewshedComputedData=e,this.updateTransform()}updateTransform(){const e=this._viewshedComputedData;if(null==e)return;const t=(0,C.Ue)(),i=e.farDistanceRenderSpace;(0,M.xJ)(t,(0,_.al)(i,i,i)),B(e,vt),(0,M.dC)(t,vt,t),(0,M.vc)(vt,this._viewshedComputedData.observerRenderSpace),(0,M.dC)(t,vt,t),this.transform=t}createExternalResources(){}destroyExternalResources(){}forEachMaterial(e){e(this._material)}createGeometries(e){const{_material:t,viewshedComputedData:i}=this;null!=i&&null!=t&&i.valid&&function(e,t){const{horizontalFieldOfView:i,verticalFieldOfView:s}=t,r=(0,p.i)(ht,0,0,1),n=(0,p.i)(ut,0,1,0),a=(0,p.i)(pt,1,0,0);Y(r,r,(0,S.Vl)(s/2),n),Y(r,r,(0,S.Vl)(i/2),a);const o=e=>Math.ceil(Math.abs(e)/R)+1,l=(0,S.Vl)(i),c=(0,p.c)(_t,a),d=o(l),h=dt(-l/(d-1)),u=(0,M.Us)(vt,h,c),_=(0,S.Vl)(-s),v=o(_),f=dt(_/(v-1)),w=(0,p.c)(ut,n),m=(0,M.Us)(ft,(0,S.Vl)(i)/2,a);(0,p.t)(w,w,m);const g=ft,b=[],y=(0,p.c)(pt,r);for(let e=0;e<d;e++){(0,M.Us)(g,f,w);for(let t=0;t<v;t++){const i=3*(t*d+e);b[i]=y[0],b[i+1]=y[1],b[i+2]=y[2],(0,p.t)(y,y,g)}(0,p.t)(w,w,u),(0,p.t)(r,r,u),(0,p.c)(y,r)}const V=d*v;b[3*V]=0,b[3*V+1]=0,b[3*V+2]=0;const C=[];for(let e=0;e<d-1;e++)for(let t=0;t<v-1;t++){const i=6*(t*(d-1)+e);C[i]=t*d+e,C[i+1]=(t+1)*d+e,C[i+2]=t*d+e+1,C[i+3]=t*d+e+1,C[i+4]=(t+1)*d+e,C[i+5]=(t+1)*d+e+1}const D=[C];if(360!==i&&0!==s){const e=[],t=[];for(let i=0;i<v-1;i++){const s=3*i;e[s]=V,e[s+1]=(i+1)*d,e[s+2]=i*d,t[s]=V,t[s+1]=i*d+d-1,t[s+2]=(i+1)*d+d-1}D.push(e,t)}if(180!==s&&0!==i){const e=[],t=[];for(let i=0;i<d-1;i++){const s=3*i;e[s]=V,e[s+1]=i,e[s+2]=i+1,t[s]=V,t[s+1]=i+(v-1)*d+1,t[s+2]=i+(v-1)*d}D.push(e,t)}return D.map((t=>{const i=[[lt.T.POSITION,new at.a(b,t,3,!0)]];return new ot.Z(e,i)}))}(t,i).forEach((t=>e.addGeometry(t)))}}function dt(e){return isNaN(e)?1:e}const ht=(0,_.Ue)(),ut=(0,_.Ue)(),pt=(0,_.Ue)(),_t=(0,_.Ue)(),vt=(0,C.Ue)(),ft=(0,C.Ue)();var wt=i(85590);let mt=class extends n.Z{constructor(e){super(e),this.visible=!0,this._viewshedCorners={topLeft:(0,_.Ue)(),topRight:(0,_.Ue)(),bottomLeft:(0,_.Ue)(),bottomRight:(0,_.Ue)()},this._arcCenterPoints={top:(0,_.Ue)(),bottom:(0,_.Ue)(),left:(0,_.Ue)(),right:(0,_.Ue)()},this._parallelCenters={top:(0,_.Ue)(),bottom:(0,_.Ue)()}}initialize(){const e={view:this.view,isDecoration:!0},t={...e,color:this._color,renderOccluded:O.yD.OccludeAndTransparent},i={...t,stipplePattern:(0,wt.z5)(2)};this._observerVisualElement=new rt.L({...e,...T.observerPointConfiguration}),this._shapeVisualElement=new ct({...e,isDecoration:this.isDecoration}),this._frameLinesVisualElement=new st.r(t),this._leftArcVisualElement=new st.r(t),this._rightArcVisualElement=new st.r(t),this._topArcVisualElement=new st.r(t),this._bottomArcVisualElement=new st.r(t),this._centralLongitude=new st.r(i),this._centralLatitude=new st.r(i),this.addHandles([(0,d.YP)((()=>{const e=this.viewshedComputedData;if(!e?.valid)return null;const t=this._viewshedCorners,i=this._arcCenterPoints,s=this._parallelCenters;return e.cornerPoints(t),e.arcCentersPoints(i),e.parallelCenterPoints(s),{viewshedComputedData:e,corners:t,arcCenters:i,parallelCenters:s,interactive:this.analysisViewData.interactive,selected:this._selected}}),(e=>{const t=null!=e;this._forEachVisualElement((e=>e.attached=t)),t&&this._updateVisualElements(e)}),{initial:!0,equals:V.fS}),(0,d.YP)((()=>{const{viewshedComputedData:e}=this,{horizontalFieldOfView:t,verticalFieldOfView:i}=e??{};return{viewshedComputedData:e,horizontalFieldOfView:t,verticalFieldOfView:i}}),(({viewshedComputedData:e})=>{const{_shapeVisualElement:t}=this;e!==t.viewshedComputedData&&(t.viewshedComputedData=e),this._shapeVisualElement.recreateGeometry()}),d.nn),(0,d.YP)((()=>{const{interactive:e}=this.analysisViewData;return{visible:this.visible,selected:e&&this._selected,staged:e&&this._staged,horFovNot360:360!==this.viewshedComputedData?.horizontalFieldOfView}}),(({visible:e,selected:t,staged:i,horFovNot360:s})=>{const r=t||i;this._shapeVisualElement.visible=e,this._topArcVisualElement.visible=e,this._bottomArcVisualElement.visible=e,this._frameLinesVisualElement.visible=e&&s;const n=e&&(t||s);this._leftArcVisualElement.visible=n,this._rightArcVisualElement.visible=n,this._forEachLineVisualElement((e=>{e.width=r?T.frameWidthSelected:T.frameWidthNotSelected,e.renderOccluded=t?O.yD.OccludeAndTransparent:O.yD.Occlude})),[this._centralLatitude,this._centralLongitude].forEach((i=>{i.width=2*(r?T.frameWidthSelected:T.frameWidthNotSelected),i.visible=e&&t}))}),d.nn),(0,d.YP)((()=>{const{analysisViewData:{interactive:e,tool:t},_selected:i,visible:s}=this,r=this.view.activeTool,n=!t?.active&&r instanceof qe&&r.creating;return{observerVisible:s&&!i&&(!e||(t?.creating??!1)||n),color:this._color}}),(({observerVisible:e,color:t})=>{this._observerVisualElement.visible=e,this._forEachLineVisualElement((e=>e.color=t))}),d.nn)])}get _color(){const{viewshedComputedData:e,_selected:t,analysisViewData:i}=this;if(null==e)return y.Z.toUnitRGBA(T.frameColor);const s=i.tool?.active||i.interactive,r=e.viewshed===i.tool?.stagedViewshed,n=s&&(t||r)?this.view.effectiveTheme.accentColor:T.frameColor;return y.Z.toUnitRGBA(n)}get _selected(){const{viewshedComputedData:e,analysisViewData:{selectedViewshedComputedData:t}}=this;return null!=e&&e===t}get _staged(){const{analysisViewData:{tool:e},viewshedComputedData:t}=this;return null!=e&&e.creating&&e.stagedViewshed===t?.viewshed}destroy(){this._observerVisualElement=(0,c.SC)(this._observerVisualElement),this._shapeVisualElement=(0,c.SC)(this._shapeVisualElement),this._frameLinesVisualElement=(0,c.SC)(this._frameLinesVisualElement),this._leftArcVisualElement=(0,c.SC)(this._leftArcVisualElement),this._rightArcVisualElement=(0,c.SC)(this._rightArcVisualElement),this._topArcVisualElement=(0,c.SC)(this._topArcVisualElement),this._bottomArcVisualElement=(0,c.SC)(this._bottomArcVisualElement),this._centralLongitude=(0,c.SC)(this._centralLongitude),this._centralLatitude=(0,c.SC)(this._centralLatitude)}_forEachLineVisualElement(e){[this._frameLinesVisualElement,this._leftArcVisualElement,this._rightArcVisualElement,this._topArcVisualElement,this._bottomArcVisualElement,this._centralLatitude,this._centralLongitude].forEach(e)}_forEachVisualElement(e){this._forEachLineVisualElement(e),e(this._observerVisualElement),e(this._shapeVisualElement)}_updateVisualElements(e){const{viewshedComputedData:t,corners:i,arcCenters:s,parallelCenters:r}=e,n=(0,_.d9)(t.observerRenderSpace);this._observerVisualElement.geometry=t.observer,this._shapeVisualElement.updateTransform(),this._updateFrameLines(n,i),this._updateFrameArcs(t,i,r),this._updateCentralHelperArcs(t,s)}_updateFrameLines(e,t){this._frameLinesVisualElement.geometry=[[e,t.topLeft],[e,t.topRight],[e,t.bottomLeft],[e,t.bottomRight]]}_updateFrameArcs(e,t,i){const{observerRenderSpace:s,rightVector:r,horizontalFieldOfView:n,tiltedUpVector:a}=e,o=(0,S.Vl)(n),l=(0,_.Ue)(),c=(0,C.Ue)();(0,M.Us)(c,o/2,a),(0,p.t)(l,r,c),gt(this._leftArcVisualElement,s,t.bottomLeft,t.topLeft,"forward",l),(0,M.Us)(c,-o/2,a),(0,p.i)(l,0,0,0),(0,p.t)(l,r,c),gt(this._rightArcVisualElement,s,t.bottomRight,t.topRight,"forward",l);const d=n>180?"backward":"forward";gt(this._topArcVisualElement,i.top,t.topRight,t.topLeft,d,a),gt(this._bottomArcVisualElement,i.bottom,t.bottomRight,t.bottomLeft,d,a)}_updateCentralHelperArcs(e,t){const i=e.observerRenderSpace,s=e.horizontalFieldOfView>=180?"backward":"forward";gt(this._centralLatitude,i,t.right,t.left,s,e.tiltedUpVector),gt(this._centralLongitude,i,t.top,t.bottom,"forward",e.leftVector)}get test(){}};function gt(e,t,i,s,r,n,a=R){const o=(0,_.Ue)();(0,p.a)(o,i,t);const l=(0,p.H)(o),c=(0,_.Ue)();(0,p.a)(c,s,t),(0,p.n)(c,c),(0,p.g)(c,c,l);let d=(0,p.p)(o,c);const h=(0,_.d9)(n);"backward"===r&&((0,p.u)(h,h),d=-(2*Math.PI-d));const u=[],v=Math.ceil(Math.abs(d)/a),f=(0,C.Ue)();(0,M.Us)(f,d/v,h);const w=(0,_.Ue)();(0,p.c)(w,o);const m=(0,_.Ue)();(0,p.c)(m,i);for(let e=0;e<v;e++){const e=(0,_.Ue)();(0,p.c)(e,m),(0,p.t)(w,w,f),(0,p.f)(m,t,w);const i=(0,_.Ue)();(0,p.c)(i,m),u.push([e,i])}e.geometry=u}(0,s._)([(0,h.Cb)()],mt.prototype,"view",void 0),(0,s._)([(0,h.Cb)({constructOnly:!0})],mt.prototype,"isDecoration",void 0),(0,s._)([(0,h.Cb)()],mt.prototype,"analysisViewData",void 0),(0,s._)([(0,h.Cb)()],mt.prototype,"viewshedComputedData",void 0),(0,s._)([(0,h.Cb)()],mt.prototype,"visible",void 0),(0,s._)([(0,h.Cb)()],mt.prototype,"_color",null),(0,s._)([(0,h.Cb)()],mt.prototype,"_selected",null),(0,s._)([(0,h.Cb)()],mt.prototype,"_staged",null),mt=(0,s._)([(0,u.j)("esri.views.3d.analysis.Viewshed.ViewshedVisualization")],mt);let bt=class extends n.Z{get visible(){return this.analysisViewData.visible}constructor(e){super(e)}initialize(){const e=this.analysisViewData,t=(0,l.w)((()=>this.analysisViewData.viewshedComputedDataHandles),(({viewshedComputedData:t})=>{const i=new mt({view:this.view,viewshedComputedData:t,analysisViewData:e,isDecoration:this.isDecoration});return{visualization:i,remove:()=>i.destroy()}}));this._viewshedVisualizations=t,this.addHandles([(0,b.ed)(t),(0,d.YP)((()=>this.visible),(e=>this._viewshedVisualizations.forEach((({visualization:t})=>t.visible=e))),d.nn)])}get test(){}};var yt;(0,s._)([(0,h.Cb)({constructOnly:!0})],bt.prototype,"analysisViewData",void 0),(0,s._)([(0,h.Cb)({constructOnly:!0,nonNullable:!0})],bt.prototype,"view",void 0),(0,s._)([(0,h.Cb)({constructOnly:!0})],bt.prototype,"isDecoration",void 0),(0,s._)([(0,h.Cb)()],bt.prototype,"visible",null),bt=(0,s._)([(0,u.j)("esri.views.3d.analysis.Viewshed.ViewshedAnalysisVisualization")],bt);let Vt=yt=class extends n.Z{constructor(e){super(e),this.observerRenderSpaceOverride=null,this.needUpdateByFeature=!1}get observer(){return this.viewshed.observer??new A.Z}get effectiveObserverRenderSpace(){return this.observerRenderSpaceOverride??this.observerRenderSpace}get effectiveObserver(){return this.renderSpaceToPoint(this.effectiveObserverRenderSpace,this.observer.spatialReference)}get effectiveTargetRenderSpace(){return this._computeTargetRenderSpace(this.effectiveObserverRenderSpace)}get farDistance(){return this.viewshed.farDistance}get farDistanceRenderSpace(){return this.farDistance/this.metersPerUnit}get heading(){return this.viewshed.heading}get tilt(){return this.viewshed.tilt}get feature(){return this.viewshed.feature}get tiltParallelToSurface(){return this.tilt-90}get horizontalFieldOfView(){return this.viewshed.horizontalFieldOfView}get verticalFieldOfView(){return this.viewshed.verticalFieldOfView}get observerRenderSpace(){return this._pointToRenderSpace(this.observer,(0,_.Ue)())}get target(){const e=this.targetRenderSpace;return this.renderSpaceToPoint(e,this.observer.spatialReference)}get targetRenderSpace(){return this._computeTargetRenderSpace(this.observerRenderSpace)}get targetDirection(){const e=(0,p.a)((0,_.Ue)(),this.targetRenderSpace,this.observerRenderSpace);return(0,p.n)(e,e)}get tiltedUpVector(){const e=Y((0,_.Ue)(),this.upVector,-(0,S.Vl)(this.tiltParallelToSurface),this.leftVector);return(0,p.n)(e,e)}get _basis(){return this.renderCoordsHelper.basisMatrixAtPosition(this.observerRenderSpace,(0,C.Ue)())}get upVector(){const e=this._basis;return(0,_.al)(e[8],e[9],e[10])}get northVector(){const e=this._basis;return(0,_.al)(e[4],e[5],e[6])}get leftVector(){const e=this.upVector,t=Y((0,_.Ue)(),this.northVector,-(0,S.Vl)(this.heading),e);return(0,p.h)(t,e,t)}get rightVector(){return(0,p.u)((0,_.Ue)(),this.leftVector)}clone(){return new yt({renderCoordsHelper:this.renderCoordsHelper,viewshed:this.viewshed.clone()})}get valid(){return this.viewshed.valid}get metersPerUnit(){return this.renderCoordsHelper.spatialReference.metersPerUnit}pointOnSphere(e,t,i){const{observerRenderSpace:s,targetRenderSpace:r}=this,n=(0,p.a)(St,r,s);return Y(n,n,-(0,S.Vl)(t),this.leftVector),Y(n,n,-(0,S.Vl)(e),this.tiltedUpVector),(0,p.f)(i,n,s)}cornerPoints(e){const t=this.horizontalFieldOfView/2,i=this.verticalFieldOfView/2;this.pointOnSphere(-t,i,e.topLeft),this.pointOnSphere(t,i,e.topRight),this.pointOnSphere(-t,-i,e.bottomLeft),this.pointOnSphere(t,-i,e.bottomRight)}arcCentersPoints(e){const t=this.horizontalFieldOfView/2,i=this.verticalFieldOfView/2;this.pointOnSphere(0,i,e.top),this.pointOnSphere(0,-i,e.bottom),this.pointOnSphere(-t,0,e.left),this.pointOnSphere(t,0,e.right)}parallelCenterPoints(e){const t=this.observerRenderSpace,i=this.farDistanceRenderSpace*Math.sin((0,S.Vl)(this.verticalFieldOfView/2)),s=(0,p.g)(St,this.tiltedUpVector,i);(0,p.f)(e.top,t,s),(0,p.a)(e.bottom,t,s)}renderSpaceToPoint(e,t){const i=St;return this.renderCoordsHelper.fromRenderCoords(e,i,t),new A.Z(i[0],i[1],i[2],t)}_pointToRenderSpace(e,t){const i=(0,_.nI)(e.toArray());return this.renderCoordsHelper.toRenderCoords(i,e.spatialReference,t),t}_computeTargetRenderSpace(e){const{leftVector:t,northVector:i,upVector:s}=this,r=this.farDistanceRenderSpace,n=(0,_.Ue)();return(0,p.g)(n,i,r),Y(n,n,-(0,S.Vl)(this.heading),s),Y(n,n,-(0,S.Vl)(this.tiltParallelToSurface),t),(0,p.f)(n,e,n),n}};(0,s._)([(0,h.Cb)()],Vt.prototype,"renderCoordsHelper",void 0),(0,s._)([(0,h.Cb)()],Vt.prototype,"viewshed",void 0),(0,s._)([(0,h.Cb)()],Vt.prototype,"observerRenderSpaceOverride",void 0),(0,s._)([(0,h.Cb)()],Vt.prototype,"needUpdateByFeature",void 0),(0,s._)([(0,h.Cb)()],Vt.prototype,"observer",null),(0,s._)([(0,h.Cb)()],Vt.prototype,"effectiveObserverRenderSpace",null),(0,s._)([(0,h.Cb)()],Vt.prototype,"effectiveObserver",null),(0,s._)([(0,h.Cb)()],Vt.prototype,"effectiveTargetRenderSpace",null),(0,s._)([(0,h.Cb)()],Vt.prototype,"farDistance",null),(0,s._)([(0,h.Cb)()],Vt.prototype,"farDistanceRenderSpace",null),(0,s._)([(0,h.Cb)()],Vt.prototype,"heading",null),(0,s._)([(0,h.Cb)()],Vt.prototype,"tilt",null),(0,s._)([(0,h.Cb)()],Vt.prototype,"feature",null),(0,s._)([(0,h.Cb)()],Vt.prototype,"tiltParallelToSurface",null),(0,s._)([(0,h.Cb)()],Vt.prototype,"horizontalFieldOfView",null),(0,s._)([(0,h.Cb)()],Vt.prototype,"verticalFieldOfView",null),(0,s._)([(0,h.Cb)()],Vt.prototype,"observerRenderSpace",null),(0,s._)([(0,h.Cb)()],Vt.prototype,"target",null),(0,s._)([(0,h.Cb)()],Vt.prototype,"targetRenderSpace",null),(0,s._)([(0,h.Cb)()],Vt.prototype,"targetDirection",null),(0,s._)([(0,h.Cb)()],Vt.prototype,"tiltedUpVector",null),(0,s._)([(0,h.Cb)()],Vt.prototype,"_basis",null),(0,s._)([(0,h.Cb)()],Vt.prototype,"upVector",null),(0,s._)([(0,h.Cb)()],Vt.prototype,"northVector",null),(0,s._)([(0,h.Cb)()],Vt.prototype,"leftVector",null),(0,s._)([(0,h.Cb)()],Vt.prototype,"rightVector",null),(0,s._)([(0,h.Cb)()],Vt.prototype,"valid",null),(0,s._)([(0,h.Cb)()],Vt.prototype,"metersPerUnit",null),Vt=yt=(0,s._)([(0,u.j)("esri.views.3d.analysis.Viewshed.ViewshedComputedData")],Vt);const St=(0,_.Ue)();var Mt=i(92490),Ct=i(61442),Dt=i(43254),Ot=i(69055),Rt=i(26173),xt=i(52054),Tt=i(4486),Pt=i(69371),At=i(51440),Et=i(27583),Ut=i(48636);let Ft=class extends Ut.Z{constructor(){super(...arguments),this.sectionAngles=(0,Et.Ue)()}get sectionAnglesDeg(){return(0,Et.nI)(this.sectionAngles.map((e=>(0,S.BV)(e))))}set sectionAnglesDeg(e){this.sectionAngles=(0,Et.nI)(e.map((e=>(0,S.Vl)(e))))}get projectionMatrix(){return(0,M.dC)((0,C.Ue)(),this.sectionMatrix,this._projectionMatrixInternal)}get sectionMatrix(){const e=this.sectionAngles[0],t=this.sectionAngles[1],i=this.sectionAngles[2],s=this.sectionAngles[3];(0,re.hu)(e<=t),(0,re.hu)(i<=s);const r=2*Math.tan(this.fovX/2),n=2*Math.tan(this.fovY/2),a=Math.tan(e),o=Math.tan(t),l=Math.tan(i),c=o-a,d=Math.tan(s)-l,h=r/c,u=n/d,p=-(a+c/2)/r*2,_=-(l+d/2)/n*2,v=(0,C.Ue)();(0,M.vc)(v,[p,_,0]);const f=(0,C.Ue)();(0,M.xJ)(f,[h,u,1]);const w=(0,C.Ue)();return(0,M.dC)(w,f,v)}get _sectionRatioX(){const e=Math.tan(this.sectionAngles[0]),t=Math.tan(this.sectionAngles[1]),i=2*Math.tan(this.fovX/2);return Math.min(1,(t-e)/i)}setViewport(e,t){const i=t*this._sectionRatioX;return this.viewport=[e[0],e[1],i,t],i}};(0,s._)([(0,h.Cb)()],Ft.prototype,"sectionAngles",void 0),(0,s._)([(0,h.Cb)()],Ft.prototype,"sectionAnglesDeg",null),(0,s._)([(0,h.Cb)()],Ft.prototype,"projectionMatrix",null),(0,s._)([(0,h.Cb)()],Ft.prototype,"sectionMatrix",null),(0,s._)([(0,h.Cb)()],Ft.prototype,"_sectionRatioX",null),Ft=(0,s._)([(0,u.j)("esri.views.3d.webgl-engine.lib.ViewshedFaceCamera")],Ft);var It=i(65650),zt=i(42377);class Ht{constructor(){this.textureSizeQuality=1,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.textureSizeMultiple=128,this.toleranceSides=5,this.toleranceBottomTop=10}textureSizeModifier(e){const t=e?this.textureSizeModHighQuality:this.textureSizeModLowQuality;return this.textureSizeQuality*t}textureResizeModulo(e){return Math.ceil(e/this.textureSizeMultiple)*this.textureSizeMultiple}}const jt=["front","left","right","back","top","bottom"];class Lt{constructor(e){this._fbos=e,this._faces={},this._width=0,this._height=0,this.settings=new Ht,this._maxTextureSize=Math.min((0,a.Z)("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}get depthTexture(){return this._handle?.getTexture(It.Lu)}get ready(){return null!=this.depthTexture&&0!==this._width&&0!==this._height}get nearFar(){const e=this.faces;return 0===e.length?null:e[0].nearFar}get numActiveFaces(){const e=this._faces;let t=0;return Object.keys(e).forEach((i=>{e[i]&&(t+=1)})),t}get faces(){const e=this._faces,t=[];for(const i of jt){const s=e[i];s&&t.push(s)}return t}get atlasRegions(){return this.faces.map((e=>[e.x/this._width,(e.x+e.width)/this._width,e.y/this._height,(e.y+e.height)/this._height]))}get viewshedProjectionMatrices(){return this.faces.map((e=>e.projectionMatrix))}get viewshedViewMatrices(){return this.faces.map((e=>e.viewMatrix))}_setupFaceCamera(e,t,i,s){const{effectiveObserverRenderSpace:r,tiltedUpVector:n,targetRenderSpace:a,farDistanceRenderSpace:o,horizontalFieldOfView:l,verticalFieldOfView:c}=t,d=(0,_.Ue)();(0,p.a)(d,a,r);const h=(0,_.Ue)(),u=(0,_.Ue)(),v=(e,t)=>{const i=(0,_.Ue)(),s=(0,C.Ue)();return(0,M.Us)(s,e,t),(0,p.t)(i,d,s),(0,p.f)(i,r,i),i};let f,w=n;const m=Math.min(90,l),g=Math.min(90,Math.max(0,(l-90)/2));let b=-45,y=45,V=-45,D=45;if(function(e){return!["top","bottom"].includes(e)}(e)){const e=e=>(0,S.uZ)(e,-45,45);V=e(-c/2)-this.settings.toleranceBottomTop,D=e(+c/2)+this.settings.toleranceBottomTop}switch(e){case"front":f=a,b=-m/2,y=m/2;break;case"left":f=v(Math.PI/2,n),b=45-g;break;case"right":f=v(-Math.PI/2,n),y=-45+g;break;case"top":f=(0,p.f)(h,r,n),w=(0,p.u)(u,d);break;case"bottom":f=(0,p.a)(h,r,n),w=d;break;case"back":f=v(Math.PI,n)}const O=new Ft({center:f,eye:r,up:w,far:o});O.sectionAnglesDeg=[b-this.settings.toleranceSides,y+this.settings.toleranceSides,V,D],O.fovY=Math.PI/2;const R=O.setViewport(i,s);return this._faces[e]=O,R}isActive(e){return this._computeActiveFaces(e).size>0}_computeActiveFaces(e){const t=new Set,{horizontalFieldOfView:i,verticalFieldOfView:s}=e,r=-s/2,n=s/2;return 0===i||0===s||(r<=45&&n>=-45&&t.add("front"),i>90&&(t.add("left"),t.add("right")),i>270&&t.add("back"),n>45-this.settings.toleranceBottomTop&&t.add("top"),r<-45+this.settings.toleranceBottomTop&&t.add("bottom")),t}_computeBaseTextureSize({pixelRatio:e,fullWidth:t,fullHeight:i},s,r,n){const a=s/e,o=this.settings.textureSizeModifier(r);return(0,At.nq)(Math.max(t,i)*a*o,this._maxTextureSize/n)}_ensureFBO(e){const t=this._width,i=this._height,s=this._handle?.fbo;s&&s.width===t&&s.height===i&&e===(0,zt.xR)(s.depthStencilTexture?.descriptor?.internalFormat??It.DM.DEPTH_COMPONENT16)||(this._handle?.release(),this._handle=this._allocateFBO(e))}_allocateFBO(e){const{_width:t,_height:i}=this,s=e?Pt.qk.DEPTH24_STENCIL8:Pt.qk.DEPTH16,r=this._fbos.acquire(t,i,"viewshed shadow map",s);return r.getTexture(It.Lu)?.setShadowFiltering(!1),r}clearFBO(e){const t=this._fbos.rctx;this._ensureFBO(e),t.bindFramebuffer(this._handle?.fbo),t.setClearColor(1,1,1,1),t.clear(It.Hf.COLOR|It.Hf.DEPTH)}dispose(){this._debugFBO||(this._handle=(0,c.RY)(this._handle))}start(e,t,i,s,r=!1){this._faces={};const n=this._computeActiveFaces(t),a=n.size;if(0===a)return!1;const o=this._computeBaseTextureSize(e,s,i,a);let l=0,c=0,d=0;return jt.filter((e=>n.has(e))).forEach((e=>{const i=function(e,t){if(t<4)return 0;const i="front"===e||"left"===e;return 4===t?i?0:1:i||"right"===e?0:1}(e,a);i>c&&(d=Math.max(d,l),l=0),c=i;const s=i*o;l+=this._setupFaceCamera(e,t,[l,s],o)})),d=Math.max(d,l),this._width=this.settings.textureResizeModulo(d),this._height=function(e){return e<4?1:2}(a)*o,this.clearFBO(r),!0}finish(){}get test(){}}var Gt=i(54050),Nt=i(58257),kt=i(29107),Wt=i(51135);class Bt extends kt.A{constructor(e,t){super(e,t,new Nt.J(Gt.a,(()=>i.e(78118).then(i.bind(i,78118)))))}initializePipeline(){return(0,Wt.sm)({colorWrite:Wt.gf,blending:Wt.vf})}}let Zt=class extends xt.Z{get shadowMap(){return this._shadowMap}get hasViewsheds(){return this._viewsheds.length>0}get _contentPixelRatio(){return this.view.state.contentPixelRatio}get _viewshedsInView(){return this._viewsheds.items.filter((e=>function(e,t){const i=(0,Ot.l)(t.observerRenderSpace,t.farDistanceRenderSpace);return!!e.ready&&e.frustum.intersectsSphere(i)}(this.view,e)))}constructor(e){super(e),this.isDecoration=!1,this._passParameters=new Gt.V,this._viewsheds=new Dt.Z,this._shadowMap=null,this.consumes={required:[Rt.CM.VIEWSHED,"normals"]},this.produces=Rt.CM.VIEWSHED,this.requireGeometryDepth=!0}initialize(){this._shadowMap=new Lt(this.fboCache),this.addHandles([(0,d.YP)((()=>this.view.resolutionScale),(e=>{const t=this._shadowMap;t&&(t.settings.textureSizeQuality=e)}),d.nn),(0,d.gx)((()=>!this.hasViewsheds),(()=>this._shadowMap?.dispose())),(0,d.YP)((()=>this._viewshedsInView.map((e=>[e.observerRenderSpace,e.heading,e.tilt,e.farDistance,e.horizontalFieldOfView,e.verticalFieldOfView]))),(()=>this.requestRender(D.Xx.UPDATE)),d.Z_)])}destroy(){this._shadowMap=(0,c.M2)(this._shadowMap)}precompile(){if(this.hasViewsheds){this.techniques.precompile(Bt);for(const e of this._viewshedsInView)if(this._shadowMap?.isActive(e))return void this.view.stage.renderer.precompileViewshedShadowMap()}}render(e){const t=this.bindParameters,i=this.renderingContext,s=e.find((({name:e})=>e===Rt.CM.VIEWSHED));if(!this.hasViewsheds||!t.depth||this.isDecoration&&!t.decorations)return s;this._passParameters.shadowMap=this._shadowMap??this._passParameters.shadowMap,this._passParameters.normals=e.find((({name:e})=>"normals"===e))?.getTexture();const r=this.techniques.get(Bt);if(!r?.compiled)return this.requestRender(D.Xx.UPDATE),s;const n=this.view.stage.renderer.isFeatureEnabled(Tt.Y.HighResolutionViewshed);for(const e of this._viewshedsInView){if(!this._renderShadowCubeMap(t,e,n)||!this._shadowMap?.ready)continue;const a=this._setupViewshedParameters(e,t.camera);i.bindTechnique(r,t,a),i.bindFramebuffer(s.fbo),i.screen.draw()}return this.shadowMap?.dispose(),s}updateViewsheds(e){const t=this._viewsheds,{removes:i,adds:s}=e;if(i&&(Array.isArray(i)?t.removeMany(i):t.remove(i)),s)if(Array.isArray(s)){const e=s.filter((e=>!t.includes(e)));t.addMany(e)}else t.includes(s)||t.add(s)}_renderShadowCubeMap(e,t,i){const s=this._shadowMap;if(!s)return!1;const r=this.view.basemapTerrain.hasStencilEnabledExtents,n=s.start(e.camera,t,i,this._contentPixelRatio,r);return n&&s.faces.forEach((e=>this.view.stage.renderer.renderViewshedShadowMap(e))),s.finish(),n}_setupViewshedParameters(e,t){const i=this._shadowMap;if(!i)return this._passParameters;const s=this._passParameters,r=e.effectiveObserverRenderSpace;s.localOrigin=r,s.observerOffset=(0,p.a)(qt,e.observerRenderSpace,e.effectiveObserverRenderSpace),s.fovs=[(0,S.Vl)(e.horizontalFieldOfView),(0,S.Vl)(e.verticalFieldOfView)],s.headingAndTilt=[(0,S.Vl)(e.heading),(0,S.Vl)(e.tiltParallelToSurface)],s.upVector=e.tiltedUpVector;const n=function(e,t){const i=(0,_.Ue)();return(0,p.a)(i,e,t)}(e.targetRenderSpace,r);s.targetVector=n;const a=new Array,o=new Array;for(let e=0;e<i.numActiveFaces;e++)(0,M.Iu)(Xt,i.viewshedViewMatrices[e],r),a.push(...Xt),Yt(i.viewshedProjectionMatrices[e],Xt,Qt),o.push(...Qt);return s.viewMatrices=a,s.projectionMatrices=o,s.volumeOffset=this.selectedViewshed?.()===e.viewshed?function(e,t,i){if(null==e)return 0;const{observerRenderSpace:s,targetRenderSpace:r}=e,n=(0,p.j)(i,s)>(0,p.j)(i,r)?e.observer:e.target;return t.pixelSizeAt(n)}(e,this.view,t.eye):0,s}get test(){return{viewsheds:this._viewsheds,shadowMap:this._shadowMap,viewshedsInView:this._viewshedsInView}}};function Yt(e,t,i){const s=(0,_.al)(.5,.5,.5);return(0,M.vc)(i,s),(0,M.bA)(i,i,s),(0,M.dC)(i,i,e),(0,M.dC)(i,i,t),i}(0,s._)([(0,h.Cb)()],Zt.prototype,"selectedViewshed",void 0),(0,s._)([(0,h.Cb)()],Zt.prototype,"isDecoration",void 0),(0,s._)([(0,h.Cb)()],Zt.prototype,"shadowMap",null),(0,s._)([(0,h.Cb)()],Zt.prototype,"hasViewsheds",null),(0,s._)([(0,h.Cb)()],Zt.prototype,"_contentPixelRatio",null),(0,s._)([(0,h.Cb)()],Zt.prototype,"_viewshedsInView",null),(0,s._)([(0,h.Cb)()],Zt.prototype,"consumes",void 0),(0,s._)([(0,h.Cb)()],Zt.prototype,"produces",void 0),Zt=(0,s._)([(0,u.j)("esri.views.3d.webgl-engine.lib.Viewshed")],Zt);const qt=(0,_.Ue)(),Xt=(0,C.Ue)(),Qt=(0,C.Ue)();var Jt=i(24468);let Kt=class extends((0,m.p)(n.Z)){constructor(e){super(e),this.type="viewshed-view-3d",this.analysis=null,this.tool=null,this._selectedViewshed=null,this.viewshedComputedDataHandles=null,this.userOperation=null,this._viewshedRenderer=null,this._intersector=null}get selectedViewshed(){return this._selectedViewshed}set selectedViewshed(e){this._unselectOtherViewsheds(e),this._selectedViewshed=e}get selectedViewshedComputedData(){return this.tool?.selectedViewshedComputedData}get _isDecoration(){return!this.parent}initialize(){const e=this.view;this._viewshedRenderer=new Zt({view:e,selectedViewshed:()=>this.selectedViewshed??this.tool?.stagedViewshed,isDecoration:this._isDecoration}),this._intersector=new Mt.r(this.view.state.viewingMode),this._intersector.options.hud=!1,this._intersector.options.store=Ct.e.MIN,this.viewshedComputedDataHandles=(0,l.w)((()=>this.analysis.viewsheds),(t=>{const i=new Vt({renderCoordsHelper:e.renderCoordsHelper,viewshed:t}),s=Symbol();return this.addHandles([(0,d.YP)((()=>({valid:i.valid,canProject:(0,v.canProjectWithoutEngine)(i.observer?.spatialReference,this.view.spatialReference)||(0,v.isLoaded)()})),(({valid:e,canProject:t},s)=>{this.visible&&(e&&t?this._addViewshedsToRenderer(i):s?.valid&&s?.canProject&&this._removeViewshedsFromRenderer(i),t||(0,g.e)(this.analysis,i.observer.spatialReference,o.Z.getLogger(this)))}),d.nn),...this._createFeatureReferenceHandles(i)],s),{viewshedComputedData:i,remove:()=>{this.removeHandles(s),this._removeViewshedsFromRenderer(i),i.destroy()}}})),this._analysisVisualization=new bt({view:e,analysisViewData:this,isDecoration:this._isDecoration}),this.addHandles([(0,d.YP)((()=>this.visible),(e=>{const t=this.viewshedComputedDataHandles;if(null==t)return;e||(this.selectedViewshed=null);const i=t.map((e=>e.viewshedComputedData)).filter((e=>e.valid)).toArray();e?this._addViewshedsToRenderer(i):this._removeViewshedsFromRenderer(i)})),(0,d.YP)((()=>e.renderCoordsHelper),(e=>{this.viewshedComputedDataHandles?.forEach((({viewshedComputedData:t})=>t.renderCoordsHelper=e))})),(0,Jt.Lp)(this,qe),(0,d.gx)((()=>this.interactive),(()=>{this._unselectOtherViewsheds(this.selectedViewshed)}),d.tX)])}destroy(){this.userOperation=(0,c.IM)(this.userOperation),(0,Jt.Yq)(this),this._analysisVisualization=(0,c.SC)(this._analysisVisualization);const e=this.viewshedComputedDataHandles;null!=e&&this._removeViewshedsFromRenderer(e.map((e=>e.viewshedComputedData)).toArray())}_createFeatureReferenceHandles(e){const{view:t}=this;return[(0,d.YP)((()=>[t.state.camera,t.slice.plane,e.viewshed.observer,e.targetRenderSpace,e.verticalFieldOfView,e.horizontalFieldOfView,e.feature]),(()=>{this._updateObserverFromFeature(t,e)}),d.nn),this._createElevationUpdateHandle(e),(0,d.gx)((()=>e.needUpdateByFeature),(()=>{this._updateObserverFromFeature(t,e),e.needUpdateByFeature=!1}))]}_createElevationUpdateHandle(e){const t=(i,s)=>{const{view:r}=this,{observer:n}=e;if(null==n)return;const a=(0,v.projectOrLoad)(n,r.spatialReference);if(null!=a.pending)return void a.pending.finally((()=>t(i,s)));const o=a.geometry;null!=o&&((0,f.d)(i,s,ei,r.spatialReference),(0,w.BD)(ei,[o.x,o.y])&&(e.needUpdateByFeature=!0))};return this.view.elevationProvider.on("elevation-change",(({extent:e,spatialReference:i})=>t(e,i)))}async createViewsheds(e){await(0,Jt.tq)(this,{placementOptions:e,onToolActivated:e=>e.place("multiple")})}place(e){return(0,Jt.tq)(this,{placementOptions:e,onToolActivated:e=>e.place("single")})}_addViewshedsToRenderer(e){this._viewshedRenderer.updateViewsheds({adds:e})}_removeViewshedsFromRenderer(e){this._viewshedRenderer.updateViewsheds({removes:e})}_updateObserverFromFeature(e,t){const i=t.observerRenderSpace,s=t.targetRenderSpace,n=(0,p.c)((0,_.Ue)(),i),a={observer:i,observerSurfaceNormal:null,observerAdjusted:n,observerFeatureId:(0,r.pD)(t.feature),target:s,targetSurfaceNormal:null,targetAdjusted:(0,p.c)((0,_.Ue)(),s),targetFeatureId:null};(0,r.NS)(e,this._intersector,a,(e=>Math.min(e,.05*t.farDistanceRenderSpace))),t.observerRenderSpaceOverride=(0,p.q)(n,i)?null:n}_unselectOtherViewsheds(e){if(null!=e)for(const e of this.view.tools.items)e!==this.tool&&e instanceof qe&&(e.analysisViewData.selectedViewshed=null)}get test(){}};(0,s._)([(0,h.Cb)({readOnly:!0})],Kt.prototype,"type",void 0),(0,s._)([(0,h.Cb)({constructOnly:!0,nonNullable:!0})],Kt.prototype,"analysis",void 0),(0,s._)([(0,h.Cb)()],Kt.prototype,"tool",void 0),(0,s._)([(0,h.Cb)()],Kt.prototype,"_selectedViewshed",void 0),(0,s._)([(0,h.Cb)()],Kt.prototype,"selectedViewshed",null),(0,s._)([(0,h.Cb)()],Kt.prototype,"selectedViewshedComputedData",null),(0,s._)([(0,h.Cb)()],Kt.prototype,"viewshedComputedDataHandles",void 0),(0,s._)([(0,h.Cb)()],Kt.prototype,"userOperation",void 0),(0,s._)([(0,h.Cb)()],Kt.prototype,"_analysisVisualization",void 0),(0,s._)([(0,h.Cb)()],Kt.prototype,"_viewshedRenderer",void 0),Kt=(0,s._)([(0,u.j)("esri.views.3d.analysis.ViewshedAnalysisView3D")],Kt);const $t=Kt,ei=(0,w.cS)()},23857:function(e,t,i){i.d(t,{B2:function(){return R},G:function(){return C},J4:function(){return T},JA:function(){return D},Sp:function(){return O},_N:function(){return V},bB:function(){return S},cx:function(){return s},gv:function(){return P},zP:function(){return x}});var s,r,n=i(96094),a=i(41788),o=i(24910),l=i(82846),c=i(60508),d=i(13132),h=i(77773),u=i(12659),p=i(63271),_=i(69811),v=i(51870),f=i(13445),w=i(92490),m=i(61442),g=i(19821),b=i(43925),y=i(69880);function V(e,t){return M(e,(()=>t))}function S(e){return M(e,(e=>e.plane))}function M(e,t){const i=(0,l.Ue)(),s=(0,l.Ue)();let r=!1;return a=>{const o=t(a);if("start"===a.action){const t=(0,n.md)(a.screenStart,(0,n.c$)(_.qW.get())),s=(0,f.u4)(e.state.camera,t,F);null!=s&&(r=(0,h.BR)(o,s,i))}if(!r)return null;const l=(0,n.md)(a.screenEnd,(0,n.c$)(_.qW.get())),c=(0,f.u4)(e.state.camera,l,F);return null==c?null:(0,h.BR)(o,c,s)?{...a,renderStart:i,renderEnd:s,plane:o,ray:c}:null}}function C(e,t,i,s=null,r=null){return function(e,t,i=0,s=null,r=null){let a=null;return o=>{if("start"===o.action&&(a=e.sceneIntersectionHelper.intersectElevationFromScreen((0,n.s1)(o.screenStart.x,o.screenStart.y),t,i,r),null!=a&&null!=s&&!(0,d.projectPoint)(a,a,s)))return null;if(null==a)return null;const l=e.sceneIntersectionHelper.intersectElevationFromScreen((0,n.s1)(o.screenEnd.x,o.screenEnd.y),t,i,r);return null==l||null!=s&&!(0,d.projectPoint)(l,l,s)?null:{...o,mapStart:a,mapEnd:l}}}(e,i,(0,v.Ou)(t,e,i),s,r)}function D(e,t,i,s){const r=i.toMap(e.screenStart);return null!=r?C(t,r,i.elevationInfo,s):null}function O(e,t,i){let s=null;const r=new y.hM;return r.next(V(e,function(e,t){const i=E,s=U,r=(0,h.Ue)();e.renderCoordsHelper.worldUpAtPosition(t,i);const n=(0,o.h)((0,h.st)(r),i,(0,o.d)(s,t,e.state.camera.eye));return(0,o.h)(n,n,i),(0,h.Yq)(t,n,r)}(e,t))).next(function(e,t){const i=(0,l.Ue)(),s=(0,o.l)(t);e.renderCoordsHelper.worldUpAtPosition(t,i);const r=(0,l.Ue)(),n=(0,l.Ue)(),a=r=>((0,o.d)(r,r,t),(0,p.nF)(i,r,r),"global"===e.viewingMode&&(0,o.l)(r)*Math.sign((0,o.e)(i,r))<.001-s&&(0,o.d)(r,(0,o.g)(r,i,.001),t),(0,o.f)(r,r,t),r);return e=>(e.renderStart=a((0,o.c)(r,e.renderStart)),e.renderEnd=a((0,o.c)(n,e.renderEnd)),e)}(e,t)).next(x(e,i)).next((e=>{e.mapEnd.x=e.mapStart.x,e.mapEnd.y=e.mapStart.y,s=e})),e=>(s=null,r.execute(e),s)}function R(e,t){const i=i=>{const s=(0,n.md)(i,(0,n.c$)(A)),r=(0,f.u4)(e.state.camera,s,F);if(null==r)return null;return(0,u._w)(t,r,E,U)?.[0]};return e=>{const t=i(e.screenStart);if(null==t)return null;const s=i(e.screenEnd);return null==s?null:{...e,renderStart:t,renderEnd:s}}}function x(e,t){const i=e.renderCoordsHelper;return e=>{const s=i.fromRenderCoords(e.renderStart,new c.Z({spatialReference:t})),r=i.fromRenderCoords(e.renderEnd,new c.Z({spatialReference:t}));return null!=s&&null!=r?{...e,mapStart:s,mapEnd:r}:null}}function T(e){let t=null;return i=>{switch(i.action){case"start":t=e.disableDisplay();break;case"end":case"cancel":null!=t&&(t.remove(),t=null)}return i}}function P(e,t=null){const i=new w.r(e.state.viewingMode);i.options.selectionMode=!0,i.options.store=m.e.MIN,i.options.hud=!1;const r=(0,n.s1)(),a={requiresGroundFeedback:!0,enableDraped:!0,exclude:new Set},o=(0,l.Ue)(),d=t??e.spatialReference,h=t=>{e.map.ground&&e.map.ground.opacity<1?a.exclude.add(b.xX):a.exclude.delete(b.xX),e.sceneIntersectionHelper.intersectIntersectorScreen((0,n.md)(t,r),i,a);const l=i.results.min;let h;if(l.getIntersectionPoint(o))h=l.intersector===g.q.TERRAIN?s.GROUND:s.OTHER;else{if(!i.results.ground.getIntersectionPoint(o))return null;h=s.GROUND}return{location:e.renderCoordsHelper.fromRenderCoords(o,new c.Z({spatialReference:d})),surfaceType:h}};let u;return e=>{if("start"===e.action){const t=h(e.screenStart);u=null!=t?t.location:null}if(null==u)return null;const t=h(e.screenEnd);return null!=t?.location?{...e,mapStart:u,mapEnd:t.location,surfaceType:t.surfaceType}:null}}(r=s||(s={}))[r.GROUND=0]="GROUND",r[r.OTHER=1]="OTHER";const A=(0,a.Ue)(),E=(0,l.Ue)(),U=(0,l.Ue)(),F=(0,u.Ue)()},34105:function(e,t,i){i.d(t,{i:function(){return m}});var s=i(73440),r=i(70880),n=i(15894),a=i(17155),o=(i(61432),i(96711),i(83850),i(48023)),l=i(94808),c=i(89341),d=i(94125);class h{constructor(e){this._resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1,this._renderGroup=l.eZ.Outline}destroy(){this._destroyResources()}get resources(){return this._resources?.external}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncGeometriesToRenderer())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}get renderGroup(){return this._renderGroup}set renderGroup(e){this._renderGroup=e;const t=this._resources?.layerView;t&&(t.renderGroup=e)}recreate(){this.attached&&this._createResources()}recreateGeometry(){this._resourceFactory.recreateGeometry?null!=this._resources&&(this._ensureRenderGeometriesRemoved(),this._resourceFactory.recreateGeometry(this._resources.external),this._syncGeometriesToRenderer()):this.recreate()}forEachMaterial(e){this._resources&&this._resourceFactory.forEachMaterial(this._resources.external,e)}_createOrDestroyResources(){this._attached?null==this._resources&&this._createResources():this._destroyResources()}_createResources(){this._destroyResources();const e=this._resourceFactory.createResources(),t=new u({view:this._resourceFactory.view,renderGroup:this._renderGroup}),i=this._resourceFactory.view.basemapTerrain?.overlayManager;this._resources={layerView:t,external:e,geometriesAdded:!1},i&&(this._resources.drapeSourceRenderer=i.registerGeometryDrapeSource(t)),this._syncGeometriesToRenderer()}_destroyResources(){if(null==this._resources)return;this._ensureRenderGeometriesRemoved();const e=this._resourceFactory.view.basemapTerrain?.overlayManager;e&&e.unregisterDrapeSource(this._resources.layerView),this._resourceFactory.destroyResources(this._resources.external),this._resources=null}_syncGeometriesToRenderer(){this._visible?this._ensureRenderGeometriesAdded():this._ensureRenderGeometriesRemoved()}_ensureRenderGeometriesRemoved(){null!=this._resources?.drapeSourceRenderer&&this._resources.geometriesAdded&&(this._resources.drapeSourceRenderer.removeGeometries(this._resources.external.geometries,c.T.UPDATE),this._resources.geometriesAdded=!1)}_ensureRenderGeometriesAdded(){null!=this._resources?.drapeSourceRenderer&&(this._resources.geometriesAdded||(this._resources.drapeSourceRenderer.addGeometries(this._resources.external.geometries,c.T.UPDATE),this._resources.geometriesAdded=!0))}}let u=class extends(n.Z.IdentifiableMixin(r.Z)){constructor(e){super(e),this.drapeSourceType=l.Lw.Features,this.updatePolicy=d.j.SYNC,this.renderGroup=l.eZ.Outline}};(0,s._)([(0,a.Cb)({constructOnly:!0})],u.prototype,"view",void 0),(0,s._)([(0,a.Cb)({readOnly:!0})],u.prototype,"drapeSourceType",void 0),(0,s._)([(0,a.Cb)()],u.prototype,"renderGroup",void 0),u=(0,s._)([(0,o.j)("esri.views.3d.interactive.visualElements.DrapedVisualElementResources")],u);var p=i(56960),_=i(90403),v=i(26475),f=i(65759);class w{constructor(e){this._resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get object(){return null!=this._resources?this._resources.object:null}get resources(){return null!=this._resources?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncVisible())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){if(!this._resourceFactory.recreateGeometry)return void this.recreate();const e=this._resourceFactory.view.stage;if(null==this._resources||!e)return;const t=this._resources.object;t.removeAllGeometries(),this._resourceFactory.recreateGeometry(this._resources.external,t,this._resources.layer)}forEachMaterial(e){this._resources&&this._resourceFactory.forEachMaterial(this._resources.external,e)}_createOrDestroyResources(){this._attached?this._resources||this._createResources():this._destroyResources()}_createResources(){this._destroyResources();const e=this._resourceFactory,t=e.view,i=t.stage;if(!i)return;const s=new f.F(i,{pickable:!1,updatePolicy:d.j.SYNC}),r=new v.T({castShadow:!1}),n=e.createResources(r,s);s.add(r);const a=e.cameraChanged,o=a?(0,_.YP)((()=>t.state.camera),(e=>a(e)),_.nn):null;this._resources={layer:s,object:r,external:n,cameraHandle:o},this._syncVisible()}_destroyResources(){null!=this._resources&&(this._resources.layer.destroy(),this._resources.object.dispose(),this._resources.cameraHandle?.remove(),this._resourceFactory.destroyResources(this._resources.external),this._resources=null)}_syncVisible(){null!=this._resources&&(this._resources.object.visible=this._visible)}}class m extends p.l{constructor(e){super(e),this._isDraped=!1,this.object3dResources=new w(this.createObject3DResourceFactory(e.view)),this.drapedResources=new h(this.createDrapedResourceFactory(e.view)),this.isDraped=e.isDraped??!1}get isDraped(){return this._isDraped}set isDraped(e){e!==this._isDraped&&(this._isDraped=e,this.object3dResources.attached=this.attached&&!e,this.drapedResources.attached=this.attached&&e)}get renderGroup(){return this.drapedResources.renderGroup}set renderGroup(e){this.drapedResources.renderGroup=e}createResources(){this.object3dResources.attached=!this._isDraped,this.drapedResources.attached=this._isDraped}destroyResources(){this.object3dResources.attached=!1,this.drapedResources.attached=!1}recreate(){this.object3dResources.recreate(),this.drapedResources.recreate()}recreateGeometry(){this.object3dResources.recreateGeometry(),this.drapedResources.recreateGeometry()}destroy(){this.object3dResources.destroy(),this.drapedResources.destroy(),super.destroy()}updateVisibility(e){this.object3dResources.visible=e,this.drapedResources.visible=e}forEachMaterial(e){this.object3dResources?.forEachMaterial(e),this.drapedResources?.forEachMaterial(e)}}},38078:function(e,t,i){i.d(t,{V:function(){return g},n:function(){return C}});i(61432);var s=i(24910),r=i(82846),n=i(73749),a=i(27583),o=i(41207),l=i(33869),c=i(88970),d=i(12659),h=i(34105),u=i(82845),p=i(61471),_=i(86026),v=i(19596),f=i(14357),w=i(52061),m=i(19843);class g extends h.i{constructor(e){super(e),this._ray=(0,d.Ue)(),this._isWorldDown=!1,this._start=(0,r.Ue)(),this._end=(0,r.al)(1,0,0),this._width=1,this._color=(0,a.al)(1,0,1,1),this._polygonOffset=!1,this._writeDepthEnabled=!0,this._innerWidth=0,this._innerColor=(0,a.al)(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._stipplePreferContinuous=!0,this._falloff=0,this._extensionType=C.LINE,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=v.yD.OccludeAndTransparent,this._fadedExtensions=R,this._laserline=new u.W({view:this.view,isDecoration:e.isDecoration}),this.applyProperties(e)}destroy(){this._laserline.destroy(),super.destroy()}createObject3DResourceFactory(e){return{view:e,createResources:e=>this._createObject3DResources(e),destroyResources:b,recreateGeometry:(e,t)=>this._recreateObject3DGeometry(e,t),cameraChanged:()=>this._updateGeometry(),forEachMaterial:(e,t)=>t(e.material)}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:b,recreateGeometry:e=>this._recreateDrapedGeometry(e),forEachMaterial:(e,t)=>t(e.material)}}updateVisibility(e){super.updateVisibility(e),this._laserline.visible=e}onAttachedChange(){this._laserline.attached=this._laserlineAttached}setStartEndFromWorldDownAtLocation(e){this._isWorldDown=!0,(0,s.c)(this._start,e),this.view.renderCoordsHelper.worldUpAtPosition(e,this._end),(0,s.d)(this._end,e,this._end),(0,d.zk)(this._start,this._end,this._ray),this._updateGeometry()}get start(){return this._start}set start(e){this._isWorldDown=!1,(0,s.q)(this._start,e)||((0,s.c)(this._start,e),(0,d.zk)(this._start,this._end,this._ray),this._updateGeometry())}get end(){return this._end}set end(e){this._isWorldDown=!1,(0,s.q)(this._end,e)||((0,s.c)(this._end,e),(0,d.zk)(this._start,this._end,this._ray),this._updateGeometry())}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){(0,n.a)(e,this._color)||((0,n.c)(this._color,e),this._updateMaterial())}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){e!==this._polygonOffset&&(this._polygonOffset=e,this._updateMaterial())}get writeDepthEnabled(){return this._writeDepthEnabled}set writeDepthEnabled(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){(0,n.a)(e,this._innerColor)||((0,n.c)(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const t=null!=e!=(null!=this._stipplePattern);this._stipplePattern=e,t?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){null!=e&&null!=this._stippleOffColor&&(0,n.a)(e,this._stippleOffColor)||(this._stippleOffColor=null!=e?(0,a.d9)(e):null,this._updateMaterial())}get stipplePreferContinuous(){return this._stipplePreferContinuous}set stipplePreferContinuous(e){e!==this._stipplePreferContinuous&&(this._stipplePreferContinuous=e,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get extensionType(){return this._extensionType}set extensionType(e){e!==this._extensionType&&(this._extensionType=e,this.recreateGeometry())}get _laserlineAttached(){return this._laserlineEnabled&&null!=this._laserlineStyle&&this.attached&&!this.isDraped}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,this._laserline.attached=this._laserlineAttached,null!=e&&(this._laserline.style=e)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,this._laserline.attached=this._laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get _normalizedRenderOccluded(){return this.isDraped&&this._renderOccluded===v.yD.OccludeAndTransparentStencil?v.yD.OccludeAndTransparent:this._renderOccluded}get fadedExtensions(){return this._fadedExtensions}set fadedExtensions(e){this._fadedExtensions=e??R,this.recreateGeometry()}_updateMaterial(){const{materialParameters:e}=this;this.object3dResources.resources?.material.setParameters(e),this.drapedResources.resources?.material.setParameters(e)}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:this._stipplePreferContinuous,innerWidth:this._innerWidth,innerColor:this._innerColor,falloff:this._falloff,hasPolygonOffset:this._polygonOffset,renderOccluded:this._normalizedRenderOccluded,isDecoration:this.isDecoration,writeDepth:this._writeDepthEnabled}}_createObject3DResources(e){const t=new m.U(this.materialParameters),i=new Array;return this._createObject3DGeometry(t,e,i),{material:t,geometries:i}}_recreateObject3DGeometry(e,t){e.geometries.length=0,this._createObject3DGeometry(e.material,t,e.geometries)}_createObject3DGeometry(e,t,i){const s=this._createGeometry(e);i.push(s),t.addGeometry(s),this._updateVerticesObject3D(t)}_createDrapedResources(){const e=new m.U(this.materialParameters);return{material:e,geometries:[this._createDrapedGeometry(e)]}}_recreateDrapedGeometry(e){e.geometries=[this._createDrapedGeometry(e.material)]}_createDrapedGeometry(e){const t=this._createGeometry(e);return this._updateVerticesDraped(t),new f.z(t)}_createGeometry(e){const t=this.extensionType===C.FADED,i=t?[(0,r.Ue)(),(0,r.Ue)(),(0,r.Ue)(),(0,r.Ue)()]:[(0,r.Ue)(),(0,r.Ue)()];return(0,_.rh)(e,i,null,t?[1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0]:null)}_updateGeometry(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const e=this.object3dResources.object;e&&this._updateVerticesObject3D(e)}}_updateVerticesObject3D(e){const t=this._lineSegment;this._updateVertexAttributesObject3D(e,t),this._laserline.intersectsLine=t}_updateVerticesDraped(e){this._updateVertexAttributesDraped(e,this._lineSegment)}get _lineSegment(){return this._extensionType===C.FADED?this._updateLineSegmentFinite(M):this._updateLineSegmentInfinite(this._extensionType,M)}_updateLineSegmentFinite(e){return(0,c.zk)(this._start,this._end,e)}_updateLineSegmentInfinite(e,t){const i=this.view.state.camera;switch((0,o.iL)(this._ray,y),e){case C.LINE:y.c0=-Number.MAX_VALUE;break;case C.RAY:case C.GROUND_RAY:{const e=this._ray.origin,t=this.view.elevationProvider.getElevation(e[0],e[1],e[2],this.view.renderCoordsHelper.spatialReference,"ground")??0,i=this.view.renderCoordsHelper.getAltitude(e);this._isWorldDown&&i<t&&(0,s.u)(y.ray.direction,y.ray.direction),this._extensionType===C.GROUND_RAY&&null!=t&&(y.c1=Math.abs(i-t));break}}if(!(0,l.zq)(i.frustum,y))return this._updateLineSegmentFinite(t);const r=(0,o.Ws)(y,V),n=(0,o.S$)(y,S);return(0,c.zk)(r,n,t)}_updateVertexAttributesObject3D(e,t){const i=e.geometries[0].getMutableAttribute(w.T.POSITION)?.data;if(!i)return;let s=0;for(const e of this._lineVertices(t))i[s++]=e[0],i[s++]=e[1],i[s++]=e[2];e.geometryVertexAttributeUpdated(e.geometries[0],w.T.POSITION)}_updateVertexAttributesDraped(e,t){const i=e.getMutableAttribute(w.T.POSITION)?.data;if(!i)return;let s=0;for(const e of this._lineVertices(t))i[s++]=e[0],i[s++]=e[1],i[s++]=p.gi;e.invalidateBoundingInfo()}*_lineVertices(e){this.extensionType===C.FADED?(yield(0,c.KU)(e,-this.fadedExtensions.start,V),yield(0,c.KU)(e,0,V),yield(0,c.KU)(e,1,V),yield(0,c.KU)(e,1+this.fadedExtensions.end,V)):(yield(0,c.KU)(e,0,V),yield(0,c.KU)(e,1,V))}}function b(e){e.geometries=[]}const y=(0,o.Ue)(),V=(0,r.Ue)(),S=(0,r.Ue)(),M=(0,c.Ue)();var C,D;(D=C||(C={}))[D.LINE=0]="LINE",D[D.RAY=1]="RAY",D[D.GROUND_RAY=2]="GROUND_RAY",D[D.FADED=3]="FADED";const O=1/3,R={start:O,end:O}},68830:function(e,t,i){i.d(t,{L:function(){return g}});var s=i(99574),r=i(24910),n=i(82846),a=i(73749),o=i(27583),l=i(2051),c=i(16447),d=i(69811),h=i(56172),u=i(49102),p=i(90210),_=i(94290),v=i(78560),f=i(86026),w=i(52061),m=i(3970);class g extends u._{constructor(e){super(e),this._material=null,this._texture=null,this._geometry=null,this._size=3,this._color=(0,o.al)(1,0,1,1),this._pixelSnappingEnabled=!0,this._primitive="square",this._outlineSize=1,this._outlineColor=(0,o.al)(1,1,1,1),this._elevationInfo=null,this.applyProperties(e)}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get size(){return this._size}set size(e){if(e!==this._size){const t=this._preferredTextureSize;this._size=e,t<this._preferredTextureSize?this.recreate():this._updateSizeAttribute()}}get color(){return this._color}set color(e){(0,a.a)(e,this._color)||((0,a.c)(this._color,e),this._updateMaterial())}get pixelSnappingEnabled(){return this._pixelSnappingEnabled}set pixelSnappingEnabled(e){this._pixelSnappingEnabled!==e&&(this._pixelSnappingEnabled=e,this._updateMaterial())}get primitive(){return this._primitive}set primitive(e){this._primitive!==e&&(this._primitive=e,this.recreate())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){(0,a.a)(e,this._outlineColor)||((0,a.c)(this._outlineColor,e),this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}_updateMaterial(){this._material?.setParameters(this._materialParameters)}_updateSizeAttribute(){const e=this.object;if(null==e)return;const t=e.geometries[0];if(null==t)return;const i=t.getMutableAttribute(w.T.SIZE).data,s=this._geometrySize;i[0]=s,i[1]=s,e.geometryVertexAttributeUpdated(e.geometries[0],w.T.SIZE)}get _materialParameters(){return{color:this._color,textureIsSignedDistanceField:!0,sampleSignedDistanceFieldTexelCenter:(0,v.Rg)(this._primitive),distanceFieldBoundingBox:v.ER,occlusionTest:!1,outlineColor:this._outlineColor,outlineSize:this._outlineSize,textureId:this._texture?.id,polygonOffset:!1,shaderPolygonOffset:0,drawAsLabel:!0,depthEnabled:!1,pixelSnappingEnabled:this.pixelSnappingEnabled,isDecoration:this.isDecoration}}get _geometrySize(){return this._size/v.hy}createExternalResources(){this._texture=(0,v.cU)(this._primitive,this._preferredTextureSize),this._material=new m.A(this._materialParameters,this.view.state.viewingMode===h.JY.Global);const e=this.view.stage;this._texture.load(e.renderView.renderingContext),e.addTexture(this._texture)}destroyExternalResources(){this._texture&&(this.view.stage.removeTexture(this._texture),this._texture.dispose(),this._texture=null),this._material=null}createGeometries(e){const t=this._createRenderGeometry();null!=t&&e.addGeometry(t)}forEachMaterial(e){e(this._material)}get _preferredTextureSize(){return(0,s.uZ)(2*this._geometrySize,16,128)}calculateMapBounds(e){const t=this.object?.geometries[0];if(!t)return!1;const i=t.attributes.get(w.T.POSITION).data;return(0,l.S)(i,this.view.renderCoordsHelper.spatialReference,b,this.view.spatialReference),(0,c.G1)(e,b),!0}_createRenderGeometry(){const{geometry:e,_material:t}=this;if(null==e||null==t)return null;const{renderCoordsHelper:i,elevationProvider:s}=this.view,n=(0,p.w7)(e,s,_.o.fromElevationInfo(this.elevationInfo),i),a=(0,r.i)(d.WM.get(),e.x,e.y,n),o=d.WM.get();(0,l.S)(a,e.spatialReference,o,i.spatialReference);const c=this._geometrySize;return(0,f.dV)(t,{position:o,size:[c,c],centerOffsetAndDistance:[0,0,0,1]})}}const b=(0,n.Ue)()},32386:function(e,t,i){i.d(t,{c:function(){return d},u:function(){return h}});var s=i(31865),r=i(10934),n=i(82846),a=i(77983),o=i(48857),l=i(95334),c=i(74826);class d extends c.K{constructor(){super(...arguments),this.localOrigin=(0,n.ll)()}}function h(e){e.include(a.GZ),e.fragment.uniforms.add(new l.g("inverseViewMatrix",((e,t)=>{const i=(0,s.Iu)((0,r.Ue)(),t.camera.viewMatrix,e.localOrigin);return(0,s.iS)(i,i)}))).code.add(o.H`vec4 reconstructLocalPosition(vec2 coord, float linearDepth) {
vec4 cameraSpace = vec4(reconstructPosition(coord, linearDepth), 1.0);
return inverseViewMatrix * cameraSpace;
}`)}},42266:function(e,t,i){i.d(t,{c:function(){return a}});var s=i(82846),r=i(19596),n=i(87807);class a extends r.F5{constructor(){super(...arguments),this._pp0=(0,s.al)(0,0,1),this._pp1=(0,s.al)(0,0,0)}intersect(e,t,i,s,r,a){return(0,n.Bw)(e,i,s,r,void 0,a)}intersectDraped(e,t,i,s){return this._pp0[0]=this._pp1[0]=i[0],this._pp0[1]=this._pp1[1]=i[1],(0,n.Bw)(e,t,this._pp0,this._pp1,void 0,s)}}},85590:function(e,t,i){i.d(t,{Dp:function(){return a},z5:function(){return n}});const s={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},r={dash:s.dash,"dash-dot":[...s.dash,...s.dot],dot:s.dot,"long-dash":s["long-dash"],"long-dash-dot":[...s["long-dash"],...s.dot],"long-dash-dot-dot":[...s["long-dash"],...s.dot,...s.dot],none:null,"short-dash":s["short-dash"],"short-dash-dot":[...s["short-dash"],...s["short-dot"]],"short-dash-dot-dot":[...s["short-dash"],...s["short-dot"],...s["short-dot"]],"short-dot":s["short-dot"],solid:null};function n(e){return{pattern:[e,e],pixelRatio:2}}function a(e){return"style"===e?.type?function(e){return null!=e?function(e,t){return null==e?e:{pattern:e.slice(),pixelRatio:t}}(r[e],8):null}(e.style):null}},24468:function(e,t,i){i.d(t,{Av:function(){return d},Lp:function(){return l},Yq:function(){return c},tq:function(){return h}});var s=i(29292),r=i(50702),n=i(61100),a=i(93568),o=i(90403);function l(e,t){return(0,o.YP)((()=>e.interactive),(()=>function(e,t){e.interactive?function(e,t){c(e);const{view:i,analysis:s}=e,r=new t({view:i,analysis:s,analysisViewData:e});e.tool=r,i.tools.add(r)}(e,t):c(e)}(e,t)),o.tX)}function c(e){const{view:t,tool:i}=e;null!=i&&(t.tools.remove(i),e.tool=null)}function d(e,t){const i=e.userOperation,l=(0,s.vr)((async l=>{if(i){const e=i.promise.catch((()=>{}));i?.abort(),await e,(0,a.k_)(l)}const c=function(e,t){e.interactive=!0;const{tool:i,view:r}=e;r.activeTool=i;let l=(0,a.fu)(t,(()=>{r.activeTool===i&&(r.activeTool=null)}));return(0,s.vr)((async t=>{await(0,o.N1)((()=>!e.tool?.active),t),l=(0,n.hw)(l)}),t)}(e,{signal:l}),d=t?.shouldRejectOnCancel??(()=>!0),h=(0,r.AL)([(0,o.on)((()=>e.tool),"cancel",(()=>{d()&&c.abort()}))]),{tool:u}=e;try{u&&(u.resetCreated(),t?.onToolActivated?.(u)),await c.promise,(0,a.k_)(l)}catch(e){if(l.aborted||!(0,a.D_)(e)||d())throw e}finally{h?.remove()}}),{signal:t?.abortOptions?.signal});return e.userOperation=l,l.promise.finally((()=>{e.userOperation===l&&(e.userOperation=null)}))}async function h(e,t){const i=e.analysis.clone();return await d(e,{abortOptions:t?.placementOptions,onToolActivated:t?.onToolActivated,shouldRejectOnCancel:()=>{const{analysis:t}=e;return!t.valid||t.equals(i)}}),{}}},86227:function(e,t,i){i.d(t,{f:function(){return o}});var s=i(73440),r=i(90403),n=(i(96711),i(61432),i(83850),i(88194),i(48023)),a=i(56128);let o=class extends a.m{constructor(e){super(e)}initialize(){this.addHandles((0,r.YP)((()=>this.analysisViewData.visible),(e=>this.visible=e),r.tX))}deactivate(){this.onDeactivate(),this.created||this.analysis.clear()}resetCreated(){this._set("created",!1)}};o=(0,s._)([(0,n.j)("esri.views.interactive.AnalysisToolBase")],o)},21498:function(e,t,i){i.d(t,{w:function(){return n}});var s=i(92490),r=i(61442);function n(e){const t=new s.r(e);return t.options.store=r.e.MIN,t.options.excludeLabels=!0,t}},11465:function(e,t,i){i.d(t,{SP:function(){return s},UG:function(){return d},dU:function(){return c},k0:function(){return o},xO:function(){return l}});i(99574);var s,r=i(26821),n=i(41788);function a(e,t){return e[0]*t[1]-e[1]*t[0]}function o(e,t,i,s,n=i){return(0,r.$X)(u,s,i),(0,r.$X)(_,t,n),function(e,t,i){const s=(0,r.AK)(i,t)/(0,r.we)(i);(0,r.bA)(e,i,s)}(v,_,u),(0,r.IH)(e,n,v)}function l(e,t,i,s){(0,r.$X)(u,t,i);const n=s/(0,r.kE)(u);return(0,r.od)(e,i,u,n)}function c(e,t){const i=e.start,n=e.end,o=t.start,l=t.end,c=(0,r.$X)(u,n,i),d=(0,r.$X)(p,l,o),f=a(c,d);if(Math.abs(f)<=h)return[];const w=(0,r.$X)(_,i,o),m=a(d,w)/f,g=a(c,w)/f;if(m>=0){if(g>=0||t.type===s.LINE)return[(0,r.od)(v,i,c,m)]}else if(e.type===s.LINE&&(g>=0||t.type===s.LINE))return[(0,r.od)(v,i,c,m)];return[]}function d(e,t,i){const n=[],a=(0,r.$X)(u,e.end,e.start),o=(0,r.$X)(p,e.start,t),l=(0,r.we)(a),c=2*(0,r.AK)(a,o),d=c*c-4*l*((0,r.we)(o)-i*i);if(0===d){const t=-c/(2*l);(e.type===s.LINE||t>=0)&&n.push((0,r.od)(v,e.start,a,t))}else if(d>0){const t=Math.sqrt(d),i=(-c+t)/(2*l);(e.type===s.LINE||i>=0)&&n.push((0,r.od)(v,e.start,a,i));const o=(-c-t)/(2*l);(e.type===s.LINE||o>=0)&&n.push((0,r.od)(_,e.start,a,o))}return n}!function(e){e[e.RAY=0]="RAY",e[e.LINE=1]="LINE"}(s||(s={}));const h=1e-6,u=(0,n.Ue)(),p=(0,n.Ue)(),_=(0,n.Ue)(),v=(0,n.Ue)()}}]);