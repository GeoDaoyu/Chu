"use strict";(self.webpackChunkscene_pro=self.webpackChunkscene_pro||[]).push([[68433],{13131:function(e,t,r){function*i(e){switch(e.type){case"object-id":case"unique-id-simple":return void(yield e.fieldName);case"unique-id-composite":return void(yield*e.fieldNames)}}r.d(t,{n:function(){return i}})},20950:function(e,t,r){r.d(t,{Z:function(){return f}});var i,s=r(73440),n=r(88194),l=r(63255),a=r(60123),o=r(17155),u=(r(61432),r(96711),r(83850),r(48023)),d=r(615),c=r(58174);const p={read:{reader:d.ij},write:{writer:d.cW,overridePolicy(){return{allowNull:null!=this.excludedEffect,isRequired:null==this.excludedEffect}}}},h={read:{reader:d.ij},write:{writer:d.cW,overridePolicy(){return{allowNull:null!=this.includedEffect,isRequired:null==this.includedEffect}}}},y={name:"showExcludedLabels",default:!0};let f=i=class extends l.Z{constructor(e){super(e),this.filter=null,this.includedEffect=null,this.excludedEffect=null,this.excludedLabelsVisible=!1}write(e,t){const r=super.write(e,t);if(t?.origin){if(r.filter){const e=Object.keys(r.filter);if(e.length>1||"where"!==e[0])return t.messages?.push(new n.Z("web-document-write:unsupported-feature-effect","Invalid feature effect 'filter'. A filter can only contain a 'where' property",{layer:t.layer,effect:this})),null}if("showExcludedLabels"in r)return t.messages?.push(new n.Z("web-document-write:unsupported-feature-effect","Invalid value for property 'excludedLabelsVisible' which should always be 'true'",{layer:t.layer,effect:this})),null}return r}clone(){return new i({filter:null!=this.filter?this.filter.clone():null,includedEffect:this.includedEffect,excludedEffect:this.excludedEffect,excludedLabelsVisible:this.excludedLabelsVisible})}};(0,s._)([(0,o.Cb)({type:c.Z,json:{write:{allowNull:!0,writer(e,t,r,i){const s=e?.write({},i);s&&0!==Object.keys(s).length?(0,a.RB)(r,s,t):(0,a.RB)(r,null,t)}}}})],f.prototype,"filter",void 0),(0,s._)([(0,o.Cb)({json:{read:d.ij,write:{writer:d.cW,allowNull:!0},origins:{"web-map":p,"portal-item":p}}})],f.prototype,"includedEffect",void 0),(0,s._)([(0,o.Cb)({json:{read:d.ij,write:{writer:d.cW,allowNull:!0},origins:{"web-map":h,"portal-item":h}}})],f.prototype,"excludedEffect",void 0),(0,s._)([(0,o.Cb)({type:Boolean,json:{write:!0,name:"showExcludedLabels",origins:{"web-map":y,"portal-item":y}}})],f.prototype,"excludedLabelsVisible",void 0),f=i=(0,s._)([(0,u.j)("esri.layers.support.FeatureEffect")],f)},49859:function(e,t,r){r.d(t,{$:function(){return a},k:function(){return o}});var i=r(93568),s=r(48797),n=r(76554),l=r(3411);async function a(e,t,r,l){const a=new Array(t.length),u=new Map,d=new Map,c=(0,n.Lk)(e.fieldsIndex,r.outFields),p=l?.hasRequiredFields??n.R9;for(let e=0;e<t.length;e++){const r=t[e];if(r.isAggregate){a[e]=r;continue}let s=!1;if(l?.getPopupTemplate){const e=r.origin?.layer??r.sourceLayer??r.layer,t=l.getPopupTemplate(e);if(null==t)continue;const n=await o(t);(0,i.k_)(l),s=n&&n.arcadeUtils.hasGeometryOperations(t)}if(s||!p(r,c)){const t=r.getObjectId();if(null!=t){u.set(t,{graphic:r,index:e});continue}const i=r.getGlobalId();if(null!=i){d.set(i,{graphic:r,index:e});continue}}a[e]=r}if(!e.queryFeatures||0===u.size&&0===d.size)return a.filter(Boolean);const h=[],y=(e,t)=>{t&&(e.outFields??=[],e.outFields.includes(t)||e.outFields.push(t))};if(u.size>0){const t=r.clone();y(t,e.objectIdField),"uniqueIdFields"in e&&e.uniqueIdFields?.length&&(t.outFields??=[],t.outFields.push(...e.uniqueIdFields)),t.objectIds=Array.from(u.keys()),h.push({type:"object-id",query:t,map:u})}const f="globalIdField"in e?e.globalIdField:null;if(null!=f&&d.size>0){const e=r.clone();y(e,f);const t=Array.from(d.keys());e.where=(0,s._$)(r.where,`${f} IN (${t.map((e=>`'${e}'`)).join(",")})`),h.push({type:"global-id",query:e,map:d})}const m=l?.updateSourceAttributes??!1;for(const{type:t,query:r,map:i}of h)try{const s=await e.queryFeatures(r,l);for(const e of s.features){const r="object-id"===t?e.getObjectId():e.getGlobalId();if(null==r)continue;const s=i.get(r);if(!s)continue;const{graphic:n,index:l}=s;if(m&&e.attributes){n.attributes??={};for(const t of c)t in e.attributes&&(n.attributes[t]=e.attributes[t])}const{geometry:o,origin:u}=n;e.geometry||=o,e.origin=u,a[l]=e}}catch{}return a.filter(Boolean)}async function o(e){if(e.expressionInfos?.length||Array.isArray(e.content)&&e.content.some((e=>"expression"===e.type)))return(0,l.L)()}},68433:function(e,t,r){r.d(t,{Z:function(){return se}});var i=r(73440),s=r(88194),n=r(61432),l=r(61100),a=r(90403),o=r(17155),u=r(96711),d=(r(83850),r(48023)),c=r(49211),p=r(70979),h=r(24381),y=r(74774),f=r(90218),m=r(60559),g=r(47971),b=r(70880),F=r(93568),w=r(74355),_=r(96010),v=r(67908),x=r(37580),C=r(45213),I=r(49651);class R{constructor(e){this._controller=e,this._handle=new E((t=>e.schedule(t)))}destroy(){this._handle.destroy()}invoke(e,t){return e.buffer&&0!==e.buffer.byteLength?(e.options.sourceSpatialReference&&e.options.sourceSpatialReference instanceof C.Z&&(e.options={...e.options,sourceSpatialReference:e.options.sourceSpatialReference.toJSON()}),this._handle.invoke(e,t).then((e=>{let t=0,r=0;const i=C.Z.fromJSON(e.spatialReference);e.spatialReference=i;const s=async n=>{const l=e.fields;if(l)for(;t<l.length;)if(l[t]=I.Z.fromJSON(l[t]),t++,n.madeProgress())return this._controller.reschedule((e=>s(e)));const a=e.features;for(;r<a.length;){const e=a[r];++r,e.uid=(0,v.D)();const t=e.geometry;if(null!=t&&(t.spatialReference=i,q(t),n.madeProgress()))return this._controller.reschedule((e=>s(e)))}return e};return this._controller.schedule((e=>s(e)))}))):Promise.resolve(null)}}function q(e){switch(e.type){case"polyline":e.paths=e.hasZ&&e.hasM?e.paths.map((e=>e.map((e=>[e[0],e[1],e[2],e[3]])))):e.hasZ||e.hasM?e.paths.map((e=>e.map((e=>[e[0],e[1],e[2]])))):e.paths.map((e=>e.map((e=>[e[0],e[1]]))));break;case"polygon":e.rings=e.hasZ&&e.hasM?e.rings.map((e=>e.map((e=>[e[0],e[1],e[2],e[3]])))):e.hasZ||e.hasM?e.rings.map((e=>e.map((e=>[e[0],e[1],e[2]])))):e.rings.map((e=>e.map((e=>[e[0],e[1]]))))}}class E extends x.q{constructor(e){super("PBFDecoderWorker","_parseFeatureQuery",{_parseFeatureQuery:e=>[e.buffer]},e)}}let P=class extends b.Z{constructor(e){super(e)}get implicitFields(){const e=this.layer.outFields?.includes("*");if(!e)return new Set;const t=new Set(this.layerView.requiredFields),r=new Set(this.layerView.availableFields);return(0,w.e5)(r,t)}get queryFeaturesDehydrated(){const{layer:e}=this,t=e.capabilities,r=t&&t.query,i=r&&r.supportsFormatPBF,s=e.parsedUrl;if(i){null==this._decoder&&(this._decoder=new R(this.controller));const t={sourceSpatialReference:e.spatialReference?.toJSON()??null,applyTransform:!0,maxStringAttributeFields:this.implicitFields,maxStringAttributeLength:V};return(e,r)=>(0,_.Vn)(s,e,"pbf",this._createRequestOptions(r)).then((e=>((0,F.k_)(r),null!=this._decoder?this._decoder.invoke({buffer:e.data,options:t},r.signal):Promise.reject((0,F.zE)()))))}return(t,r)=>(0,_.JT)(s,t,e.spatialReference,this._createRequestOptions(r)).then((e=>(0,c.PA)(e.data,{maxStringAttributeFields:this.implicitFields,maxStringAttributeLength:V})))}queryFeatureCount(e,t){return this.layer.queryFeatureCount(e,t)}destroy(){this._decoder=(0,l.SC)(this._decoder)}_createRequestOptions(e){return{...e,query:{...this.layer.customParameters,token:this.layer.apiKey,...e?.query}}}};(0,i._)([(0,o.Cb)({constructOnly:!0})],P.prototype,"layer",void 0),(0,i._)([(0,o.Cb)({constructOnly:!0})],P.prototype,"layerView",void 0),(0,i._)([(0,o.Cb)({constructOnly:!0})],P.prototype,"controller",void 0),(0,i._)([(0,o.Cb)({readOnly:!0})],P.prototype,"implicitFields",null),(0,i._)([(0,o.Cb)({readOnly:!0})],P.prototype,"queryFeaturesDehydrated",null),P=(0,i._)([(0,d.j)("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],P);let O=class extends b.Z{constructor(e){super(e)}queryFeaturesDehydrated(e,t){return this.layer.queryFeatures(e,t)}};(0,i._)([(0,o.Cb)({constructOnly:!0})],O.prototype,"layer",void 0),O=(0,i._)([(0,d.j)("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileOGCServiceQuery3D")],O);let M=class extends b.Z{constructor(e){super(e)}queryFeaturesDehydrated(e,t){return this.source.queryFeaturesJSON(e,t).then(c.PA,(r=>{if(r&&"query-features-json:unsupported"===r.name)return this.layer.queryFeatures(e,t);throw r}))}queryFeatureCount(e,t){return this.layer.queryFeatureCount(e,t)}};(0,i._)([(0,o.Cb)({constructOnly:!0})],M.prototype,"layer",void 0),(0,i._)([(0,o.Cb)({constructOnly:!0})],M.prototype,"source",void 0),M=(0,i._)([(0,d.j)("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileClientQuery3D")],M);const V=1024;class N{constructor(e){this._memoryCache=null;const t=e.layerView.layer;this._layerView=e.layerView,this.objectIdField=t.objectIdField,this.globalIdField="globalIdField"in t?t.globalIdField:null,this._returnZ=e.returnZ,this._returnM=e.returnM;const r=this._layerView.view.resourceController;this.query=function(e,t){const{layer:r}=e;return"feature"===r.type&&"feature-layer"===r.source.type||"catalog-footprint"===r.type?new P({layer:r,layerView:e,controller:t}):"feature"===r.type&&"memory"===r.source.type||"csv"===r.type||"geojson"===r.type||"oriented-imagery"===r.type||"wfs"===r.type?new M({layer:r,source:r.source}):"ogc-feature"===r.type?new O({layer:r}):null}(this._layerView,r.normal),r&&this._memoryCacheEnabled&&(this._memoryCache=r.memoryController.newCache(`fl-${t.uid}`))}get _memoryCacheEnabled(){switch(this._layerView.layer.source.type){case"feature-layer":case"ogc-feature":case"oriented-imagery":return!0;case"csv":case"parquet":case"geojson":case"memory":case"wfs":return!1}}destroy(){this._memoryCache=(0,l.SC)(this._memoryCache),this.query.destroy()}createQuery(){const e=this._layerView.layer.createQuery();return e.outFields=this._layerView.availableFields,e.returnZ=this._returnZ,e.returnM=this._returnM,e.outSpatialReference=this.tilingScheme.spatialReference,e}get memoryCache(){return this._memoryCache}get viewingMode(){return this._layerView.view.state.viewingMode}get tilingScheme(){return this._layerView.view.featureTiles.tilingScheme}get scheduler(){return this._layerView.view.resourceController?.scheduler}get geometryType(){return this._layerView.layer.geometryType}get fullExtent(){return this._layerView.layer.fullExtent}get tileMaxRecordCount(){return this._layerView.layer.capabilities.query.tileMaxRecordCount}get standardMaxRecordCount(){return this._layerView.layer.capabilities.query.standardMaxRecordCount}get maxRecordCount(){return this._layerView.layer.capabilities.query.maxRecordCount}get isDraped(){return"on-the-ground"===this._layerView.layer.elevationInfo?.mode}get effectiveDisplayFilter(){return this._layerView.displayFilterEnabled?this._layerView.effectiveDisplayFilter:null}get capabilities(){return this._capabilities??=function(e){const t=e.capabilities.query;return{supportsMultipleResolutions:S(e),supportsPagination:!(!t||!t.supportsPagination),supportsResultType:!(!t||!t.supportsResultType),supportsCacheHint:!(!t||!t.supportsCacheHint),supportsQuantization:!(!t||!t.supportsQuantization),supportsQuantizationEditMode:!(!t||!t.supportsQuantizationEditMode),supportsMaxRecordCountFactor:!(!t||!t.supportsMaxRecordCountFactor),supportsFormatPBF:!(!t||!t.supportsFormatPBF)}}(this._layerView.layer),this._capabilities}logFetchError(e,t){e.error("#fetchTile()",this._layerView.layer,t?.message??t)}}function S(e){switch(e.geometryType){case"polyline":return!0;case"polygon":return e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsQuantization;default:return!1}}var T=r(45239),j=r(94125);let Z=class extends g.Q{constructor(e){super(e),this._controllerTotal=0,this._processorTotal=0,this._needsRefresh=!1,this.suspendResumeExtentMode="data"}initialize(){this.addHandles((0,a.YP)((()=>({controller:this.controller,suspended:this.suspended})),(({controller:e,suspended:t})=>{e&&!t&&this._needsRefresh&&(e.refetch(),this._needsRefresh=!1)})))}destroy(){this._fetcherContext=(0,l.SC)(this._fetcherContext)}get maximumNumberOfFeatures(){return this.controller?.maximumNumberOfFeatures??this._get("maximumNumberOfFeatures")}set maximumNumberOfFeatures(e){this._set("maximumNumberOfFeatures",e),this.controller&&(this.controller.maximumNumberOfFeatures=e)}get maximumNumberOfFeaturesExceeded(){return!!this.controller&&!(this.suspended||!this.controller.maximumNumberOfFeaturesExceeded)}get updatingProgressValue(){let e=0;if(this.controller?.updating){const t=this.controller.updatingRemaining,r=Math.max(this.controller.updatingTotal,this._controllerTotal);r>0&&(e=(r-t)/r,this._controllerTotal=r)}let t=0;if(this.processor?.updating){const e=this.processor.updatingRemaining,r=Math.max(e,this._processorTotal);r>0&&(t=(r-e)/r,this._processorTotal=r)}return.5*(e+t)}get updatePolicy(){if(!this.controller)return j.j.ASYNC;switch(this.controller.mode){case"snapshot":{const e=k.get(this.layer.geometryType);return null==e||this.controller.serviceDataCount>e?j.j.ASYNC:j.j.SYNC}case"tiles":return j.j.ASYNC}}get usedMemory(){return(this.processor?.usedMemory??0)+(this.controller?.memoryForUnusedFeatures??0)}get unloadedMemory(){const e=this.processor?.unprocessedMemoryEstimate??0,t=this.controller?.expectedFeatureDiff??0,r=this.processor?.loadedFeatures??0,i=r+t>0?r/(r+t):1;return e+t*(this.processor?.usedMemoryPerFeature??0)*i}get ignoresMemoryFactor(){return this.controller?.hasMaximumNumberOfFeaturesOverride}get performanceInfo(){const e=this.controller?.displayFeatureLimit,t=null!=e?e.averageSymbolComplexity:void 0,r=null!=t?`f:${t.verticesPerFeature},v:${t.verticesPerCoordinate}`:"n/a";return new m.u(super.performanceInfo,this.controller?.performanceInfo?.storedFeatures??0,this.controller?.performanceInfo?.totalVertices??0,this.maximumNumberOfFeaturesExceeded,this.controller?.mode??"n/a",r)}async doRefresh(e){const{controller:t,processor:r,suspended:i}=this;e&&t&&(i?this._needsRefresh=!0:(t.refetch(),this._needsRefresh=!1)),r.refreshFilter()}setVisibility(e,t){this.processor?.setObjectIdVisibility(e,t)}getMissingAttributesForFeature(e){return this.controller.getMissingAttributesForFeature(e)}getHydratedGeometry(e){const t=this.graphics3DProcessor;if(null==t)return null;const r=t.graphics3DGraphicsByObjectID;if(null==r)return null;const i=r.get(e);return null==i?null:(0,y.kB)(i.graphic.geometry)}createController(){this._fetcherContext=new N({layerView:this.layerView,returnZ:this.hasZ,returnM:this.hasM});const e=new f.g({layerView:this.layerView,context:this._fetcherContext,graphics:new T.g,extent:this.clippingExtent});return this.updatingHandles.add((()=>e.serviceDataExtent),(e=>{this.processor&&(this.processor.dataExtent=e)}),a.nn),this.addHandles((0,a.YP)((()=>this.suspended&&this.layerView.updateSuspended),(t=>{t?e.suspend():e.resume()}),a.tX)),this.updatingHandles.add((()=>this.processor?.displayFeatureLimit),(t=>e.displayFeatureLimit=t),a.nn),this.addHandles((0,a.gx)((()=>!this.updating),(()=>{this._controllerTotal=0,this._processorTotal=0}))),e}beforeSetController(e){e.maximumNumberOfFeatures=this.maximumNumberOfFeatures}get test(){return{controller:this.controller,graphics3DProcessor:this.graphics3DProcessor,heatmapProcessor:this.heatmapProcessor,loadedGraphics:this.loadedGraphics}}};(0,i._)([(0,o.Cb)()],Z.prototype,"layerView",void 0),(0,i._)([(0,o.Cb)()],Z.prototype,"controller",void 0),(0,i._)([(0,o.Cb)()],Z.prototype,"_controllerTotal",void 0),(0,i._)([(0,o.Cb)()],Z.prototype,"_processorTotal",void 0),(0,i._)([(0,o.Cb)()],Z.prototype,"_needsRefresh",void 0),(0,i._)([(0,o.Cb)()],Z.prototype,"maximumNumberOfFeatures",null),(0,i._)([(0,o.Cb)()],Z.prototype,"maximumNumberOfFeaturesExceeded",null),(0,i._)([(0,o.Cb)()],Z.prototype,"updatingProgressValue",null),(0,i._)([(0,o.Cb)()],Z.prototype,"updatePolicy",null),(0,i._)([(0,o.Cb)()],Z.prototype,"suspendResumeExtentMode",void 0),Z=(0,i._)([(0,d.j)("esri.views.3d.layers.graphics.FeatureGraphics3DGraphicsPipeline")],Z);const k=new Map([["point",5e3],["polygon",500],["polyline",1e3]]);var L=r(81808),D=r(48797),A=r(13131),Q=r(3849),B=r(78279),H=r(20950),G=r(58174),z=r(88792),U=r(49859),W=r(76554),$=r(44695);function Y(e,t){if("feature"!==t.type&&"subtype-group"!==t.type)return[];if(!t.url)return[];const r="utilityNetworks"in e.map?e.map.utilityNetworks??[]:[];for(const e of r)if(e.isUtilityLayer(t)){const e=t.fieldsIndex.get("assetgroup"),r=t.fieldsIndex.get("assettype");return[e?.name,r?.name].filter((e=>null!=e))}return[]}var J=r(29191),X=r(16395),K=r(85754);class ee{constructor(e){this._fieldsIndex=e,this._clauses=[]}async finish(){return{requiresCurrentUser:(await Promise.all(this._clauses)).some((e=>e.currentUserRequired))}}visitClientWhereClause(e){e&&this._clauses.push((0,D.EP)(e,this._fieldsIndex))}visitFeatureReduction(e){if(e)switch(e.type){case"binning":case"cluster":this.visitLabelingInfo(e.labelsVisible,e.labelingInfo)}}visitLabelingInfo(e,t){if(e&&null!=t)for(const e of t)this.visitClientWhereClause(e.where)}visitDisplayFilter(e,t){if(e)for(const e of t?.filters??[])this.visitClientWhereClause(e.where)}visitFilter(e){this.visitClientWhereClause(e?.where)}visitTrackInfo(e){null!=e&&(this.visitLabelingInfo(e?.latestObservations.labelsVisible,e?.latestObservations.labelingInfo),this.visitLabelingInfo(e?.previousObservations.labelsVisible,e?.previousObservations.labelingInfo),this.visitLabelingInfo(e?.trackLines.labelsVisible,e?.trackLines.labelingInfo))}}const te=e=>{let t=class extends e{constructor(...e){super(...e),this._updatingRequiredPromise=null,this.filter=null,this.layer=null,this.requiresCurrentUser=!1,this.requiredFields=[],this.view=null}initialize(){this.addHandles([(0,a.YP)((()=>{const e=this.layer,t=this.view;return[e&&"elevationInfo"in e?e.elevationInfo?.featureExpressionInfo:null,e&&"displayField"in e?e.displayField:null,e&&"timeInfo"in e&&e.timeInfo,e&&"renderer"in e&&e.renderer,e&&"labelingInfo"in e&&e.labelingInfo,e&&"floorInfo"in e&&e.floorInfo,t?.requiredFieldsOptions?.featureTitleFields&&e&&"featureTitleFields"in e&&e.featureTitleFields,t?.requiredFieldsOptions?.utilityNetworkFields&&Y(t,e),e.displayFilterInfo,this.displayFilterEnabled,this.filter,this.featureEffect,this.timeExtent,"knowledge-graph-sublayer"===e?.type&&"link-chart"===e.parentCompositeLayer.type&&e.parentCompositeLayer.linkChart?.linkChartProperties.nonspatialDataDisplay?.mode,"parquet"===e?.type&&e.popupTemplate]}),(()=>this._handleChange()),a.tX),(0,a.on)((()=>this.view?.floors),"change",(()=>this._handleChange())),(0,a.on)((()=>this.layer.displayFilterInfo?.filters),"change",(()=>this._handleChange())),(0,a.on)((()=>this.layer&&"sublayers"in this.layer?this.layer.sublayers:null),"change",(()=>this._handleChange()))])}get availableFields(){if(!this.layer)return[];const{layer:e,layer:{fieldsIndex:t},requiredFields:r}=this;return"outFields"in e&&e.outFields?(0,W.Q0)(t,[...(0,W.Lk)(t,e.outFields),...r]):(0,W.Q0)(t,r)}get displayFilterEnabled(){return(this.view?.displayFilterEnabled??!0)&&(!("displayFilterEnabled"in this.layer)||(this.layer?.displayFilterEnabled??!0))}get effectiveDisplayFilter(){const e=this.layer;return this.displayFilterEnabled&&e.displayFilterInfo?(0,B.UO)(e.displayFilterInfo,this.view):null}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(e){this._override("featureEffect",e)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){u.Z.getLogger(this).error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}get signedInUser(){return this.layer?.url?(0,z.Wd)(this.layer.url):Promise.resolve(null)}highlight(e,t){throw new Error("missing implementation")}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=null!=this.filter?this.filter.createQuery(e):new J.Z(e);return"floorInfo"in this.layer&&this.layer.floorInfo&&(t.where=(0,D._$)(t.where,(0,$.c)(this))),this.displayFilterEnabled&&(t.where=(0,D._$)(t.where,this.effectiveDisplayFilter?.where)),null!=this.timeExtent&&(t.timeExtent=null!=t.timeExtent?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t}createAggregateQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new J.Z(e)}queryFeatures(e,t){throw new Error("missing implementation")}queryObjectIds(e,t){throw new Error("missing implementation")}queryFeatureCount(e,t){throw new Error("missing implementation")}queryExtent(e,t){throw new Error("missing implementation")}async fetchPopupFeaturesFromGraphics(e,t){const r=await this._createPopupQuery(e.map((e=>e.origin?.layer??e.layer)),t);return await(0,U.$)(this.layer,e,r,{getPopupTemplate:e=>e&&"popupEnabled"in e&&e.popupEnabled?(0,K.V5)(e,t):null,hasRequiredFields:(e,t)=>this._popupFeatureHasRequiredFields(e,t),...t})}_handleChange(){const e=Promise.all([this._updateRequiredFields(),this._updateClientWhereClauseRequirements()]).then((()=>{}));return this._set("_updatingRequiredPromise",e),e.then((()=>{this._updatingRequiredPromise===e&&this._set("_updatingRequiredPromise",null)})),e}async _updateClientWhereClauseRequirements(){if(!this.layer||!this.view)return;const{layer:e}=this,t=new ee(e.fieldsIndex);if(t.visitFilter(this.filter),"featureReduction"in e&&t.visitFeatureReduction(e.featureReduction),"labelingInfo"in e&&t.visitLabelingInfo(e.labelsVisible,e.labelingInfo),"trackInfo"in e&&t.visitTrackInfo(e.trackInfo),"2d"===this.view.type&&(t.visitFilter(this.featureEffect?.filter),t.visitDisplayFilter(this.displayFilterEnabled,e.displayFilterInfo),"featureReduction"in e&&t.visitFeatureReduction(e.featureReduction)),"subtype-group"===e.type)for(const r of e.sublayers)t.visitLabelingInfo(r.labelsVisible,r.labelingInfo);try{const e=await t.finish();this._set("requiresCurrentUser",e.requiresCurrentUser)}catch(e){u.Z.getLogger(this).error(e)}}async _updateRequiredFields(){if(!this.layer||!this.view)return;const e="3d"===this.view.type,{layer:t,layer:{fieldsIndex:r}}=this,i="renderer"in t&&t.renderer,s="orderBy"in t&&t.orderBy,n="featureReduction"in t?t.featureReduction:null,l=new Set,a=[i?i.collectRequiredFields(l,r):null,(0,W.Mu)(l,t),e&&"elevationInfo"in t?(0,W.vl)(l,t):null,null!=this.filter?(0,W.Ll)(l,t,this.filter):null,e||null==this.featureEffect?null:(0,W.Ll)(l,t,this.featureEffect.filter),!e&&n?(0,W.ZV)(l,t,n):null,!e&&s?(0,W.Qj)(l,t,s):null];if("timeInfo"in t&&t.timeInfo&&this.timeExtent&&(0,W.gd)(l,t.fieldsIndex,[t.timeInfo.startField,t.timeInfo.endField]),"timeInfo"in t&&t.timeInfo&&"trackInfo"in t&&t.trackInfo){const{trackInfo:e}=t;(0,W.gd)(l,t.fieldsIndex,[t.timeInfo.trackIdField]),"feature"!==t.type&&"startTimeField"!==e.timeField||(0,W.gd)(l,t.fieldsIndex,[t.timeInfo.startField]),"endTimeField"===e.timeField&&(0,W.gd)(l,t.fieldsIndex,[t.timeInfo.endField]),await(0,W.E2)(l,t)}if("floorInfo"in t&&t.floorInfo&&(0,W.gd)(l,t.fieldsIndex,[t.floorInfo.floorField]),"featureTitleFields"in t&&this.view?.requiredFieldsOptions?.featureTitleFields&&t.featureTitleFields&&(0,W.gd)(l,t.fieldsIndex,t.featureTitleFields),"feature"===t.type&&t.globalIdField&&this.view?.requiredFieldsOptions?.globalIdField&&(0,W.gd)(l,t.fieldsIndex,[t.globalIdField]),this.displayFilterEnabled&&a.push((0,W.WH)(l,t,t.displayFilterInfo)),"feature"===t.type&&e&&null!=t.infoFor3D&&(null==t.globalIdField&&u.Z.getLogger(this).error("globalIdField missing on 3DObjectFeatureLayer"),(0,W.gd)(l,t.fieldsIndex,[t.globalIdField])),"subtype-group"===t.type){(0,W.AB)(l,r,t.subtypeField);const e=t.sublayers.map((e=>Promise.all([e.renderer?.collectRequiredFields(l,r),(0,W.Mu)(l,e)])));a.push(Promise.all(e))}if("catalog-footprint"===t.type&&t.parent){const e=t.parent;(0,W.gd)(l,r,[e.itemNameField,e.itemSourceField,e.itemTypeField,e.maxScaleField,e.minScaleField])}"knowledge-graph-sublayer"===t.type&&"link-chart"===t.parentCompositeLayer.type&&(0,W.AB)(l,r,Q._k),"parquet"===t.type&&a.push((0,K.e7)(t,t.popupTemplate).then((e=>{for(const t of e)l.add(t)})));const o=await Promise.allSettled(a);if(e)(0,W.AB)(l,r,t.objectIdField);else for(const e of(0,A.n)((0,X.c)(t)))(0,W.AB)(l,r,e);e&&"displayField"in t&&t.displayField&&(0,W.AB)(l,r,t.displayField);for(const e of o)"rejected"===e.status&&u.Z.getLogger(this).error(e.reason);const d=Array.from(l).sort();this._set("requiredFields",d)}_popupFeatureHasRequiredFields(e,t){return(0,W.R9)(e,t)}async _createPopupQuery(e,t){const r=this.layer.createQuery(),i=new Set;let s=!1;const n=e??[this.layer];for(const e of n){if(!("popupEnabled"in e))continue;const r=(0,K.V5)(e,t);if(null==r)continue;const n=await(0,U.k)(r);(0,F.k_)(t);const l=n&&n.arcadeUtils.hasGeometryOperations(r);s=!("point"!==this.layer.geometryType&&!l);const a=await(0,K.e7)(this.layer,r);(0,F.k_)(t);for(const e of a)i.add(e)}return r.returnGeometry=s,r.returnZ=s,r.returnM=s,r.outFields=Array.from(i),r.outSpatialReference=this.view.spatialReference,"floorInfo"in this.layer&&this.layer.floorInfo&&(r.where=(0,D._$)(r.where,(0,$.c)(this))),r}canResume(){return!(!super.canResume()||null!=this.timeExtent&&this.timeExtent.isEmpty)}getTest(){}get test(){}};return(0,i._)([(0,o.Cb)()],t.prototype,"_updatingRequiredPromise",void 0),(0,i._)([(0,o.Cb)({readOnly:!0})],t.prototype,"availableFields",null),(0,i._)([(0,o.Cb)({readOnly:!0})],t.prototype,"displayFilterEnabled",null),(0,i._)([(0,o.Cb)({readOnly:!0})],t.prototype,"effectiveDisplayFilter",null),(0,i._)([(0,o.Cb)({type:H.Z})],t.prototype,"featureEffect",null),(0,i._)([(0,o.Cb)({type:G.Z})],t.prototype,"filter",void 0),(0,i._)([(0,o.Cb)()],t.prototype,"layer",void 0),(0,i._)([(0,o.Cb)({type:Number})],t.prototype,"maximumNumberOfFeatures",null),(0,i._)([(0,o.Cb)({readOnly:!0,type:Boolean})],t.prototype,"maximumNumberOfFeaturesExceeded",null),(0,i._)([(0,o.Cb)()],t.prototype,"requiresCurrentUser",void 0),(0,i._)([(0,o.Cb)({readOnly:!0})],t.prototype,"requiredFields",void 0),(0,i._)([(0,o.Cb)({readOnly:!0})],t.prototype,"signedInUser",null),(0,i._)([(0,o.Cb)()],t.prototype,"suspended",void 0),(0,i._)([(0,o.Cb)()],t.prototype,"view",void 0),t=(0,i._)([(0,d.j)("esri.views.layers.FeatureLayerView")],t),t};var re=r(5527),ie=r(69937);let se=class extends((0,ie.Z)((0,p.R)(te((0,h.A)(re.Z))))){constructor(e){super(e)}initialize(){this.addHandles((0,a.YP)((()=>this._updatingRequiredPromise),(e=>this._updatingHandles.addPromise(e)),a.tX))}destroy(){this._updatingHandles.removeAll(),this._fetcherContext=(0,l.SC)(this._fetcherContext)}get maximumNumberOfFeatures(){return this.graphicsPipeline.maximumNumberOfFeatures}set maximumNumberOfFeatures(e){this.graphicsPipeline.maximumNumberOfFeatures=e}get maximumNumberOfFeaturesExceeded(){return null!=this.graphicsPipeline&&!this.suspended&&this.graphicsPipeline.maximumNumberOfFeaturesExceeded}get updatingProgressValue(){return this.graphicsPipeline?.updatingProgressValue??0}get updatePolicy(){return this.graphicsPipeline?.updatePolicy??j.j.ASYNC}get hasZ(){const e=this.layer,t=e.capabilities&&e.capabilities.data;return!(!t||!t.supportsZ)&&("returnZ"in e&&null!=e.returnZ?e.returnZ:t.supportsZ)}get hasM(){const e=this.layer,t=e.capabilities&&e.capabilities.data;return!(!t||!t.supportsM)&&"returnM"in e&&null!=e.returnM&&e.returnM}setVisibility(e,t){this.graphicsPipeline?.setVisibility(e,t)}createQuery(){return super.createQuery()}queryFeatures(e,t){const r=()=>super.queryFeatures(e,t);return"mesh"===this.layer.geometryType?this._queryFeaturesMesh(this._ensureQuery(e),r):r()}async createGraphicsPipeline(){if((0,n.Z)("feature-pipeline-3d-test")){const{Feature3DPipeline:e}=await Promise.all([r.e(65009),r.e(64051)]).then(r.bind(r,64051));return new e({layerView:this})}return new Z({layerView:this})}async doRefresh(e){return await this.graphicsPipeline.doRefresh(e)}_popupFeatureHasRequiredFields(e,t){if(!super._popupFeatureHasRequiredFields(e,t))return!1;const r=(0,c.MS)(e,this.layer.objectIdField);if(null==r)return!0;const i=this.graphicsPipeline.getMissingAttributesForFeature(r);if(null==i)return!0;for(const e of t)if(i.has(e))return!1;return!0}get usedMemory(){return this.graphicsPipeline?.usedMemory??0}get unloadedMemory(){return this.graphicsPipeline?.unloadedMemory??0}get ignoresMemoryFactor(){return this.graphicsPipeline?.ignoresMemoryFactor??!1}async _queryFeaturesMesh(e,t){await this._validateQueryFeaturesMesh(e);const r=await t(),i=this.graphicsPipeline;if(e?.outStatistics||null==i)return r;const s=this.layer.objectIdField,n=[];for(const e of r.features)if(e.geometry){const t=i.getHydratedGeometry(e.attributes[s]);t&&(e.geometry=t,n.push(e))}else n.push(e);return r.features=n,r}async _validateQueryFeaturesMesh(e){if(!e)return;const t=e=>{throw new s.Z("feature-layer-view:unsupported-query",`Queries on Mesh feature collection layers do not support '${e}'`)},r=["quantizationParameters","geometryPrecision","maxAllowableOffset"];for(const i of r)null!=e[i]&&t(i);"returnM"in e&&e.returnM&&t("returnM"),"returnCentroid"in e&&e.returnCentroid&&t("returnCentroid"),null==e.outSpatialReference||e.outSpatialReference.equals(this.view.spatialReference)||t("outSpatialReference")}get test(){}};(0,i._)([(0,o.Cb)()],se.prototype,"layer",void 0),(0,i._)([(0,o.Cb)()],se.prototype,"graphicsPipeline",void 0),(0,i._)([(0,o.Cb)()],se.prototype,"maximumNumberOfFeatures",null),(0,i._)([(0,o.Cb)()],se.prototype,"maximumNumberOfFeaturesExceeded",null),(0,i._)([(0,o.Cb)(L.q)],se.prototype,"updatingProgress",void 0),(0,i._)([(0,o.Cb)({readOnly:!0})],se.prototype,"updatingProgressValue",null),(0,i._)([(0,o.Cb)({readOnly:!0})],se.prototype,"updatePolicy",null),(0,i._)([(0,o.Cb)({readOnly:!0})],se.prototype,"hasZ",null),(0,i._)([(0,o.Cb)({readOnly:!0})],se.prototype,"hasM",null),se=(0,i._)([(0,d.j)("esri.views.3d.layers.FeatureLayerViewBase3D")],se)},60559:function(e,t,r){r.d(t,{u:function(){return s}});var i=r(15165);class s extends i.W{constructor(e,t,r,i,s,n){super(e.usedMemory,e.displayedFeatures,e.totalFeatures,e.maximumFeatures,e.nodes,e.core),this.storedFeatures=t,this.totalVertices=r,this.partial=i,this.mode=s,this.symbolComplexity=n}}},69937:function(e,t,r){r.d(t,{Z:function(){return o}});var i=r(73440),s=r(96711),n=r(93568),l=r(90403),a=(r(61432),r(83850),r(88194),r(48023));const o=e=>{let t=class extends e{initialize(){this.addHandles((0,l.on)((()=>this.layer),"refresh",(e=>{this.doRefresh(e.dataChanged).catch((e=>{(0,n.D_)(e)||s.Z.getLogger(this).error(e)}))})),"RefreshableLayerView")}};return t=(0,i._)([(0,a.j)("esri.views.layers.RefreshableLayerView")],t),t}}}]);