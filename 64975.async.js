"use strict";(self.webpackChunkscene_pro=self.webpackChunkscene_pro||[]).push([[64975],{94311:function(e,t,r){r.d(t,{L:function(){return n}});var a=r(24284);class n{constructor(){this._serviceMetadatas=new Map,this._itemDatas=new Map}async fetchServiceMetadata(e,t){const r=this._serviceMetadatas.get(e);if(r)return r;const n=await(0,a.T)(e,t);return this._serviceMetadatas.set(e,n),n}async fetchItemData(e){const{id:t}=e;if(!t)return null;const{_itemDatas:r}=this;if(r.has(t))return r.get(t);const a=await e.fetchData();return r.set(t,a),a}async fetchCustomParameters(e,t){const r=await this.fetchItemData(e);return r&&"object"==typeof r&&(t?t(r):r.customParameters)||null}}},76889:function(e,t,r){r.d(t,{w:function(){return c}});var a=r(10218),n=r(78619),s=r(88194),o=r(93568),i=r(66619),l=r(77601),u=r(96193);async function c(e,t){const r=(0,i.Qc)(e);if(!r)throw new s.Z("invalid-url","Invalid scene service url");const c={...t,sceneServerUrl:r.url.path,layerId:r.sublayer??void 0};if(c.sceneLayerItem??=await async function(e){const t=(await y(e)).serviceItemId;if(!t)return null;const r=new u.default({id:t,apiKey:e.apiKey}),s=await async function(e){const t=a.id?.findServerInfo(e.sceneServerUrl);if(t?.owningSystemUrl)return t.owningSystemUrl;const r=e.sceneServerUrl.replace(/(.*\/rest)\/.*/i,"$1")+"/info";try{const t=(await(0,n.Z)(r,{query:{f:"json"},responseType:"json",signal:e.signal})).data.owningSystemUrl;if(t)return t}catch(e){(0,o.r9)(e)}return null}(e);null!=s&&(r.portal=new l.Z({url:s}));try{return await r.load({signal:e.signal})}catch(e){return(0,o.r9)(e),null}}(c),null==c.sceneLayerItem)return f(c.sceneServerUrl.replace("/SceneServer","/FeatureServer"),c);const p=await async function({sceneLayerItem:e,signal:t}){if(!e)return null;try{const r=(await e.fetchRelatedItems({relationshipType:"Service2Service",direction:"reverse"},{signal:t})).find((e=>"Feature Service"===e.type))||null;if(!r)return null;const a=new u.default({portal:r.portal,id:r.id});return await a.load(),a}catch(e){return(0,o.r9)(e),null}}(c);if(!p?.url)throw new s.Z("related-service-not-found","Could not find feature service through portal item relationship");c.featureServiceItem=p;const d=await f(p.url,c);return d.portalItem=p,d}async function y(e){if(e.rootDocument)return e.rootDocument;const t={query:{f:"json",...e.customParameters,token:e.apiKey},responseType:"json",signal:e.signal};try{const r=await(0,n.Z)(e.sceneServerUrl,t);e.rootDocument=r.data}catch{e.rootDocument={}}return e.rootDocument}async function f(e,t){const r=(0,i.Qc)(e);if(!r)throw new s.Z("invalid-feature-service-url","Invalid feature service url");const a=r.url.path,o=t.layerId;if(null==o)return{serverUrl:a};const l=y(t),u=t.featureServiceItem?await t.featureServiceItem.fetchData("json"):null,c=(u?.layers?.[0]||u?.tables?.[0])?.customParameters,f=e=>{const r={query:{f:"json",...c},responseType:"json",authMode:e,signal:t.signal};return(0,n.Z)(a,r)},p=f("anonymous").catch((()=>f("no-prompt"))),[d,m]=await Promise.all([p,l]),h=m?.layers,w=d.data&&d.data.layers;if(!Array.isArray(w))throw new Error("expected layers array");if(Array.isArray(h)){for(let e=0;e<Math.min(h.length,w.length);e++)if(h[e].id===o)return{serverUrl:a,layerId:w[e].id}}else if(null!=o&&o<w.length)return{serverUrl:a,layerId:w[o].id};throw new Error("could not find matching associated sublayer")}},35681:function(e,t,r){r.d(t,{V:function(){return o},W:function(){return p}});var a=r(75428),n=r(24284);const s=new Set(["Catalog Layer","Feature Layer","Oriented Imagery Layer"]);async function o(e,t){const{loadContext:r,...s}=t||{},o=r?await r.fetchServiceMetadata(e,s):await(0,n.T)(e,s),i=(0,a.V7)();f(o),u(o);const l={serviceJSON:o,preferredHost:i};if((o.currentVersion??0)<10.5)return l;const c=`${(0,a.fR)()??e}/layers`,y=r?await r.fetchServiceMetadata(c,s):await(0,n.T)(c,s);return f(y),u(y),l.layersJSON={layers:y.layers,tables:y.tables},l}function i(e){const{type:t}=e;return!!t&&s.has(t)}function l(e){return"Table"===e.type}function u(e){e.layers=e.layers?.filter(i),e.tables=e.tables?.filter(l)}function c(e){e.type||="Feature Layer"}function y(e){e.type||="Table"}function f(e){e.layers?.forEach(c),e.tables?.forEach(y)}function p(e){switch(e){case"Feature Layer":case"Table":return"FeatureLayer";case"Oriented Imagery Layer":return"OrientedImageryLayer";case"Catalog Layer":return"CatalogLayer"}return"FeatureLayer"}},39438:function(e,t,r){r.d(t,{Y:function(){return o},h:function(){return s}});var a=r(95490),n=r(77601);function s(e,t){return{...i(e,t),readResourcePaths:[]}}function o(e,t,r){const n=(0,a.mN)(e.itemUrl);return{...i(e,t),messages:[],writtenProperties:[],blockedRelativeUrls:[],verifyItemRelativeUrls:n?{rootPath:n.path,writtenUrls:[]}:null,resources:r?{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}:null}}function i(e,t){return{origin:t,url:(0,a.mN)(e.itemUrl),portal:e.portal||n.Z.getDefault(),portalItem:e}}},64975:function(e,t,r){r.d(t,{load:function(){return d}});var a=r(88194),n=r(66619),s=r(35681),o=r(94311),i=r(75428),l=r(77601),u=r(39438),c=r(90272),y=r(47626),f=r(89913),p=r(24284);async function d(e,t){const r=e.instance.portalItem;if(r?.id)return await r.load(t),function(e){const t=e.instance.portalItem;if(!t?.type||!e.supportedTypes.includes(t.type))throw new a.Z("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:t?.type,expectedType:e.supportedTypes.join(", ")})}(e),e.validateItem&&e.validateItem(r),async function(e,t){const r=e.instance,n=r.portalItem;if(!n)return;let{url:l}=n;const{title:d}=n,h=(0,u.h)(n,"portal-item");if("group"===r.type)return async function(e,t,r){const n=e.portalItem;if(!e.sourceIsPortalItem)return;const{title:l,type:f}=n;if("Group Layer"===f){if(!(0,y._$)(n,"Map"))throw new a.Z("portal:invalid-layer-item-typekeyword","'Group Layer' item without 'Map' type keyword is not supported");return async function(e,t){const r=e.portalItem,n=await r.fetchData("json");if(!n)return;if(!t.populateGroupLayer)throw new a.Z("portal:missing-populate-group-layer","Missing populate group layer");const s=(0,u.h)(r,"web-map");e.read(n,s),await t.populateGroupLayer(e,n,{context:s}),e.resourceReferences={portalItem:r,paths:s.readResourcePaths??[]}}(e,r)}return e.read({title:l},t),async function(e,t){let r;const{portalItem:n}=e;if(!n)return;const l=n.type,u=t.layerModuleTypeMap;if(!u)throw new a.Z("portal:missing-layer-module-type-map","Layer module type map is required to construct sub layers");switch(l){case"Feature Service":case"Feature Collection":r=u.FeatureLayer;break;case"Stream Service":r=u.StreamLayer;break;case"Scene Service":r=u.SceneLayer;break;case"Video Service":r=u.VideoLayer;break;default:throw new a.Z("portal:unsupported-item-type-as-group",`The item type '${l}' is not supported as a 'IGroupLayer'`)}const y="Video Service"===l,f=new o.L;let[d,{data:h}]=await Promise.all([r(),y?{data:null}:w(t,f)]),g=()=>d;if(y)return async function(e,t,r){const{portalItem:a}=e;if(!a?.url)return;const n=await(0,p.T)(a.url);n&&m(e,t,null,{layers:n.layers?.map((({id:e,name:t})=>({id:e,name:t})))},r)}(e,g,u);if("Feature Service"===l){const t=(0,c.uE)(h)?.customParameters;h=n.url?(await(0,c.$O)(h,n.url,f)).data:{},g=await async function(e,t){const{layers:r,tables:a}=e,n=[...r??[],...a??[]];if(!n.length)return;const s=new Set,o=[];for(const{layerType:e}of n){const r=e??"ArcGISFeatureLayer";if(s.has(r))continue;s.add(r);const a=t[(0,c.qT)(r)];o.push(a())}const i=await Promise.all(o),l=new Map;return Array.from(s).forEach(((e,t)=>{l.set(e,i[t])})),({layerType:e})=>{const t=e??"ArcGISFeatureLayer";return l.get(t)}}(h,u)||g;const{provider:r,preferredHost:a}=await async function(e,t){const{layersJSON:r,preferredHost:a}=await(0,s.V)(e,t);if(!r)return{provider:null,preferredHost:a};const n=[...r.layers,...r.tables];return{provider:e=>n.find((t=>t.id===e.id)),preferredHost:a}}(n.url,{customParameters:t,loadContext:f});return(0,i.hd)(n,a),await m(e,g,g,h,u,r)}return"Scene Service"===l&&n.url&&(h=await(0,c.CD)(n,h,f)),(0,c.Q4)(h)>0?await m(e,g,null,h,u):await async function(e,t,r){const{portalItem:a}=e;if(!a?.url)return;const n=await(0,p.T)(a.url);n&&m(e,t,null,{layers:n.layers?.map(c.bS),tables:n.tables?.map(c.bS)},r)}(e,g,u)}(e,r)}(r,h,e);l&&"media"!==r.type&&r.read({url:l},h);const g=new o.L,{data:v,preferredHost:b}=await w(e,g,t);return l=n.url,"isUrlHostModified"in r&&(b?r.applyPreferredHost({preferredHost:b}):r.applyHostFromPortalItem()),v&&r.read(v,h),r.resourceReferences={portalItem:n,paths:h.readResourcePaths??[]},"subtype-group"!==r.type&&r.read({title:d},h),(0,f.y)(r,h)}(e,t)}async function m(e,t,r,a,n,s){let o=a.layers||[];const i=a.tables||[];if("Feature Collection"===e.portalItem?.type?(o.forEach(((e,t)=>{e.id=t,"Table"===e?.layerDefinition?.type&&i.push(e)})),o=o.filter((e=>"Table"!==e?.layerDefinition?.type))):(o.reverse(),i.reverse()),o.forEach((r=>{const n=s?.(r);if(n||!s){const s=h(e,t(r),a,r,n);e.add(s)}})),i.length){const t=r?null:await n.FeatureLayer();i.forEach((n=>{const o=s?.(n);if(o||!s){const s=h(e,r?r(n):t,a,n,o);e.tables.add(s)}}))}}function h(e,t,r,a,n){const s=e.portalItem,o={portalItem:s.clone(),layerId:a.id};null!=a.url&&(o.url=a.url);const i=new t(o);if("sourceJSON"in i&&(i.sourceJSON=n),"subtype-group"!==i.type&&"catalog"!==i.type&&(i.sublayerTitleMode="service-name"),"Feature Collection"===s.type){const e={origin:"portal-item",portal:s.portal||l.Z.getDefault()};i.read(a,e);const t=r.showLegend;null!=t&&i.read({showLegend:t},e)}return i}async function w(e,t,r){if(!1===e.supportsData)return{data:void 0};const a=e.instance,s=a.portalItem;if(!s)return{data:void 0};let o=null;try{o=await s.fetchData("json",r)}catch(e){}if(function(e){return"stream"!==e.type&&"layerId"in e}(a)){let e=null;const{count:r,preferredHost:l}=await async function(e,t,r){if(t?.layers&&t?.tables)return{count:(0,c.Q4)(t)};const a=(0,n.Qc)(e.url);if(!a)return{count:1};const s=a.url.path,o=await r.fetchServiceMetadata(s,{customParameters:(0,c.uE)(t)?.customParameters}).catch((()=>null));return{count:(t?.layers?.length??o?.layers?.length??0)+(t?.tables?.length??o?.tables?.length??0),preferredHost:(0,i.AN)(e)?(0,i.V7)():null}}(s,o,t);if((0,i.hd)(s,l),(o?.layers||o?.tables)&&r>0){if(null==a.layerId){const e=(0,c.on)(a.type),t=e?.length?(0,c.r9)(o,e)[0]:(0,c.uE)(o);t&&(a.layerId=t.id)}e=function(e,t){const{layerId:r}=t,a=e.layers?.find((e=>e.id===r))||e.tables?.find((e=>e.id===r));return a&&function(e,t){const r="layerType"in e&&e.layerType,{type:a}=t;return!("feature"===a&&r&&"ArcGISFeatureLayer"!==e.layerType||"catalog"===a&&!r||"oriented-imagery"===a&&!r||"subtype-group"===a&&!r)}(a,t)?a:null}(o,a),"OrientedImageryLayer"===e?.layerType&&"oriented-imagery"===a.type&&a.supportedSourceTypes.add("Feature Layer"),e&&null!=o.showLegend&&(e.showLegend=o.showLegend)}return r>1&&"sublayerTitleMode"in a&&"service-name"!==a.sublayerTitleMode&&(a.sublayerTitleMode="item-title-and-service-name"),{data:e,preferredHost:l}}return{data:o}}},90272:function(e,t,r){r.d(t,{$O:function(){return i},CD:function(){return d},Q4:function(){return y},bS:function(){return o},hq:function(){return u},on:function(){return f},qT:function(){return p},r9:function(){return c},uE:function(){return l}});var a=r(76889),n=r(35681),s=r(75428);function o(e){const t={id:e.id,name:e.name},r=(0,n.W)(e.type);return"FeatureLayer"!==r&&(t.layerType=r),t}async function i(e,t,r){let a;if(null==e?.layers||null==e?.tables){const n=await r.fetchServiceMetadata(t,{customParameters:l(e)?.customParameters});a=(0,s.V7)(),(e=e||{}).layers=e.layers||n?.layers?.map(o),e.tables=e.tables||n?.tables?.map(o)}return{data:e,preferredHost:a}}function l(e){if(!e)return null;const{layers:t,tables:r}=e;return t?.length?t[0]:r?.length?r[0]:null}function u(e,t){return null==t?null:[...e.layers||[],...e.tables||[]].find((e=>e.id===t))}function c(e,t){return[...e.layers||[],...e.tables||[]].filter((({layerType:e})=>e?t.includes(e):t.includes("ArcGISFeatureLayer")))}function y(e){return(e?.layers?.length??0)+(e?.tables?.length??0)}function f(e){switch(e){case"catalog":return["CatalogLayer"];case"feature":return["ArcGISFeatureLayer"];case"oriented-imagery":return["OrientedImageryLayer"];case"subtype-group":return["SubtypeGroupLayer","SubtypeGroupTable"]}return null}function p(e){switch(e){case"CatalogLayer":return"CatalogLayer";case"OrientedImageryLayer":return"OrientedImageryLayer";case"SubtypeGroupLayer":case"SubtypeGroupTable":return"SubtypeGroupLayer"}return"FeatureLayer"}async function d(e,t,r){if(!e?.url)return t??{};if(t??={},!t.layers){const a=await r.fetchServiceMetadata(e.url);t.layers=a.layers?.map(o)}const{serverUrl:n,portalItem:s}=await(0,a.w)(e.url,{sceneLayerItem:e,customParameters:l(t)?.customParameters}).catch((()=>({serverUrl:null,portalItem:null})));if(null==n)return t.tables=[],t;if(!t.tables&&s){const e=await s.fetchData().catch((()=>null));if(e?.tables)t.tables=e.tables.map(o);else{const a=await r.fetchServiceMetadata(n,{customParameters:l(e)?.customParameters}).catch((()=>null));t.tables=a?.tables?.map(o)}}if(t.tables)for(const e of t.tables)e.url=`${n}/${e.id}`;return t}},89913:function(e,t,r){r.d(t,{y:function(){return o}});var a=r(29292),n=r(93568),s=r(8914);async function o(e,t,r){const o=e&&e.getAtOrigin&&e.getAtOrigin("renderer",t.origin);if(o&&"unique-value"===o.type&&o.styleOrigin){const i=await(0,a.q6)(o.populateFromStyle());if((0,n.k_)(r),!1===i.ok){const r=i.error;t?.messages&&t.messages.push(new s.Z("renderer:style-reference",`Failed to create unique value renderer from style reference: ${r.message}`,{error:r,context:t})),e.clear("renderer",t?.origin)}}}},24284:function(e,t,r){r.d(t,{T:function(){return n}});var a=r(78619);async function n(e,t){const{data:r}=await(0,a.Z)(e,{responseType:"json",query:{f:"json",...t?.customParameters,token:t?.apiKey}});return r}}}]);