"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[88202],{2875:function(t,e,i){i.d(e,{a:function(){return u},b:function(){return o},c:function(){return a},d:function(){return r},e:function(){return d},f:function(){return c},l:function(){return l},n:function(){return f},t:function(){return s}});var n=i(38461);i(61432),i(96711);function r(t,e,i){s(t.typedBuffer,e.typedBuffer,i,t.typedBufferStride,e.typedBufferStride)}function s(t,e,i,n=3,r=n){if(t.length/n!==Math.ceil(e.length/r))return t;const s=t.length/n,a=i[0],o=i[1],h=i[2],l=i[4],c=i[5],u=i[6],d=i[8],f=i[9],_=i[10],g=i[12],m=i[13],p=i[14];let x=0,y=0;for(let i=0;i<s;i++){const i=e[x],s=e[x+1],v=e[x+2];t[y]=a*i+l*s+d*v+g,t[y+1]=o*i+c*s+f*v+m,t[y+2]=h*i+u*s+_*v+p,x+=r,y+=n}return t}function a(t,e,i){o(t.typedBuffer,e.typedBuffer,i,t.typedBufferStride,e.typedBufferStride)}function o(t,e,i,n=3,r=n){if(t.length/n!==Math.ceil(e.length/r))return;const s=t.length/n,a=i[0],o=i[1],h=i[2],l=i[3],c=i[4],u=i[5],d=i[6],f=i[7],_=i[8];let g=0,m=0;for(let i=0;i<s;i++){const i=e[g],s=e[g+1],p=e[g+2];t[m]=a*i+l*s+d*p,t[m+1]=o*i+c*s+f*p,t[m+2]=h*i+u*s+_*p,g+=r,m+=n}}function h(t,e,i,n=3,r=n){const s=Math.min(t.length/n,e.length/r);let a=0,o=0;for(let h=0;h<s;h++)t[o]=i*e[a],t[o+1]=i*e[a+1],t[o+2]=i*e[a+2],a+=r,o+=n;return t}function l(t,e,i,n){c(t.typedBuffer,e.typedBuffer,i,n,t.typedBufferStride,e.typedBufferStride)}function c(t,e,i,r,s=3,a=s){const o=Math.min(t.length/s,e.length/a);let h=0,l=0;const c=1/n.jm;for(let n=0;n<o;n++)t[l]=r*(i*e[h])**c,t[l+1]=r*(i*e[h+1])**c,t[l+2]=r*(i*e[h+2])**c,h+=a,l+=s}function u(t,e,i,n=3,r=n){const s=t.length/n;if(s!==Math.ceil(e.length/r))return t;let a=0,o=0;for(let h=0;h<s;h++)t[o]=e[a]+i[0],t[o+1]=e[a+1]+i[1],t[o+2]=e[a+2]+i[2],a+=r,o+=n;return t}function d(t,e){f(t.typedBuffer,e.typedBuffer,t.typedBufferStride,e.typedBufferStride)}function f(t,e,i=3,n=i){const r=Math.min(t.length/i,e.length/n);let s=0,a=0;for(let o=0;o<r;o++){const r=e[s],o=e[s+1],h=e[s+2],l=r*r+o*o+h*h;if(l>0){const e=1/Math.sqrt(l);t[a]=e*r,t[a+1]=e*o,t[a+2]=e*h}s+=n,a+=i}}Object.freeze(Object.defineProperty({__proto__:null,linearToSRGB:c,linearToSRGBView:l,normalize:f,normalizeView:d,scale:h,scaleView:function(t,e,i){h(t.typedBuffer,e.typedBuffer,i,t.typedBufferStride,e.typedBufferStride)},shiftRight:function(t,e,i){const n=Math.min(t.count,e.count),r=t.typedBuffer,s=t.typedBufferStride,a=e.typedBuffer,o=e.typedBufferStride;let h=0,l=0;for(let t=0;t<n;t++)r[l]=a[h]>>i,r[l+1]=a[h+1]>>i,r[l+2]=a[h+2]>>i,h+=o,l+=s},transformMat3:o,transformMat3View:a,transformMat4:s,transformMat4View:r,translate:u},Symbol.toStringTag,{value:"Module"}))},75307:function(t,e,i){i.d(e,{J:function(){return r}});var n=i(59384);function r(t){return t<=n.c8?new Array(t):new Int16Array(t)}},95631:function(t,e,i){i.d(e,{C:function(){return h}});var n=i(78619),r=i(29292),s=i(88194),a=i(93568),o=i(95490);class h{constructor(t){this._streamDataRequester=t}async loadJSON(t,e){return this._load("json",t,e)}async loadBinary(t,e){return(0,o.HK)(t)?((0,a.k_)(e),(0,o.AH)(t)):this._load("binary",t,e)}async loadImage(t,e){return this._load("image",t,e)}async _load(t,e,i){if(null==this._streamDataRequester)return(await(0,n.Z)(e,{responseType:l[t]})).data;const o=await(0,r.q6)(this._streamDataRequester.request(e,t,i));if(!0===o.ok)return o.value;throw(0,a.r9)(o.error),new s.Z("glt-loader-request-error",`Request for resource failed: ${o.error}`)}}const l={image:"image",binary:"array-buffer",json:"json","image+type":void 0}},91896:function(t,e,i){i.d(e,{U:function(){return o},a:function(){return a}});var n=i(41788),r=i(82846),s=i(27583);class a{constructor(t,e="center",i=!1,a=(0,n.Ue)(),o=(0,s.al)(0,0,0,-1),h="world",l=(0,r.Ue)(),c=0){this.verticalOffset=t,this.anchor=e,this.hasLabelVerticalOffset=i,this.screenOffset=a,this.centerOffset=o,this.centerOffsetUnits=h,this.translation=l,this.elevationOffset=c}}class o{constructor(t,e="center",i="center",r=null,s=(0,n.Ue)(),a=!0){this.placement=t,this.horizontalPlacement=e,this.verticalPlacement=i,this.text=r,this.displaySize=s,this.isFocused=a}}},29989:function(t,e,i){i.d(e,{$A:function(){return a},EP:function(){return c},QW:function(){return u},c4:function(){return f},j1:function(){return d},mq:function(){return h},yY:function(){return o},zi:function(){return l}});var n=i(26821),r=i(41788),s=i(84262);const a=Object.freeze({left:0,center:.5,right:1}),o=Object.freeze({"bottom-left":(0,r.al)(0,0),bottom:(0,r.al)(.5,0),"bottom-right":(0,r.al)(1,0),left:(0,r.al)(0,.5),center:(0,r.al)(.5,.5),right:(0,r.al)(1,.5),"top-left":(0,r.al)(0,1),top:(0,r.al)(.5,1),"top-right":(0,r.al)(1,1)});function h(t){switch(t){case"left":return s.vU.Left;case"right":return s.vU.Right;default:return s.vU.Center}}function l(t){switch(t){case"bottom-left":case"left":case"top-left":return"left";case"bottom":case"center":case"top":return"center";case"bottom-right":case"right":case"top-right":return"right"}}function c(t){switch(t){case"bottom-left":case"bottom":case"bottom-right":return"bottom";case"left":case"center":case"right":return"center";case"top-left":case"top":case"top-right":return"top"}}function u(t,e){switch(e){case"bottom":return"left"===t?"bottom-left":"right"===t?"bottom-right":"bottom";case"center":return t;case"top":return"left"===t?"top-left":"right"===t?"top-right":"top"}}function d(t){return"middle"===t?"center":t}function f(t,e){switch(t){case"top":return(0,n.t8)(e,0,s.Wg);case"bottom":return(0,n.t8)(e,0,-1);default:return(0,n.JG)(e,r.AG)}}},58744:function(t,e,i){i.d(e,{p2:function(){return k},zD:function(){return S}});var n=i(78619),r=i(29292),s=i(88194),a=i(96711),o=i(85881),h=i(61544),l=i(93568),c=i(15322),u=i(82846),d=i(16447),f=i(38766),_=i(51880),g=i(81749),m=i(32420),p=i(25952),x=i(28751),y=i(52061),v=i(35720),w=i(65650);const b=()=>a.Z.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");class R{constructor(t,e,i){this.resource=t,this.textures=e,this.cachedMemory=i}}async function S(t,e){const i=await async function(t,e){const i=e?.streamDataRequester;if(i)return async function(t,e,i){const n=await(0,r.q6)(e.request(t,"json",i));if(!0===n.ok)return n.value;(0,l.r9)(n.error),T(n.error.details.url)}(t,i,e);const s=await(0,r.q6)((0,n.Z)(t,e));if(!0===s.ok)return s.value.data;(0,l.r9)(s.error),T(s.error)}(t,e),s=await async function(t,e){const i=new Array;for(const n in t){const r=t[n],s=r.images[0].data;if(!s){b().warn("Externally referenced texture data is not yet supported");continue}const a=r.encoding+";base64,"+s,o="/textureDefinitions/"+n,h="rgba"===r.channels?r.alphaChannelUsage||"transparency":"none",l={noUnpackFlip:!0,wrap:{s:w.e8.REPEAT,t:w.e8.REPEAT},preMultiplyAlpha:P(h)!==m.JJ.Opaque},c=e?.disableTextures?Promise.resolve(null):(0,_.t)(a,e);i.push(c.then((t=>({refId:o,image:t,parameters:l,alphaChannelUsage:h}))))}const n=await Promise.all(i),r={};for(const t of n)r[t.refId]=t;return r}(i.textureDefinitions??{},e);let a=0;for(const t in s)if(s.hasOwnProperty(t)){const e=s[t];a+=e?.image?e.image.width*e.image.height*4:0}return new R(i,s,a+(0,o.kk)(i))}function T(t){throw new s.Z("",`Request for object resource failed: ${t}`)}function M(t){const e=t.params,i=e.topology;let n=!0;switch(e.vertexAttributes||(b().warn("Geometry must specify vertex attributes"),n=!1),e.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const t=e.faces;if(t){if(e.vertexAttributes)for(const i in e.vertexAttributes){const e=t[i];e?.values?(null!=e.valueType&&"UInt32"!==e.valueType&&(b().warn(`Unsupported indexed geometry indices type '${e.valueType}', only UInt32 is currently supported`),n=!1),null!=e.valuesPerElement&&1!==e.valuesPerElement&&(b().warn(`Unsupported indexed geometry values per element '${e.valuesPerElement}', only 1 is currently supported`),n=!1)):(b().warn(`Indexed geometry does not specify face indices for '${i}' attribute`),n=!1)}}else b().warn("Indexed geometries must specify faces"),n=!1;break}default:b().warn(`Unsupported topology '${i}'`),n=!1}t.params.material||(b().warn("Geometry requires material"),n=!1);const r=t.params.vertexAttributes;for(const t in r)r[t].values||(b().warn("Geometries with externally defined attributes are not yet supported"),n=!1);return n}function k(t,e){const i=new Array,n=new Array,r=new Array,s=new h.r,a=t.resource,o=c.G.parse(a.version||"1.0","wosr");U.validate(o);const l=a.model.name,d=a.model.geometries,_=a.materialDefinitions??{},w=t.textures;let b=0;const R=new Map;for(let t=0;t<d.length;t++){const a=d[t];if(!M(a))continue;const o=z(a),h=a.params.vertexAttributes,l=[],c=t=>{if("PerAttributeArray"===a.params.topology)return null;const e=a.params.faces;for(const i in e)if(i===t)return e[i].values;return null},S=h[y.T.POSITION],T=S.values.length/S.valuesPerElement;for(const t in h){const e=h[t],i=e.values,n=c(t)??(0,f.KF)(T);l.push([t,new g.a(i,n,e.valuesPerElement,!0)])}const k=o.texture,A=w&&w[k];if(A&&!R.has(k)){const{image:t,parameters:e}=A,i=new x.x(t,e);n.push(i),R.set(k,i)}const U=R.get(k),B=U?U.id:void 0,L=o.material;let O=s.get(L,k);if(null==O){const t=_[L.slice(L.lastIndexOf("/")+1)].params;1===t.transparency&&(t.transparency=0);const i=A?P(A.alphaChannelUsage):void 0,n={ambient:(0,u.nI)(t.diffuse),diffuse:(0,u.nI)(t.diffuse),opacity:1-(t.transparency||0),textureAlphaMode:i,textureAlphaCutoff:.33,textureId:B,doubleSided:!0,cullFace:m.Vr.None,colorMixMode:t.externalColorMixMode||"tint",textureAlphaPremultiplied:A?.parameters.preMultiplyAlpha??!1};e?.materialParameters&&Object.assign(n,e.materialParameters),O=new v.Gp(n,e),s.set(L,k,O)}r.push(O);const C=new p.Z(O,l);b+=l.find((t=>t[0]===y.T.POSITION))?.[1]?.indices.length??0,i.push(C)}return{engineResources:[{name:l,stageResources:{textures:n,materials:r,geometries:i},pivotOffset:a.model.pivotOffset,numberOfVertices:b,lodThreshold:null}],referenceBoundingBox:A(i)}}function A(t){const e=(0,d.cS)();return t.forEach((t=>{const i=t.boundingInfo;null!=i&&((0,d.pp)(e,i.bbMin),(0,d.pp)(e,i.bbMax))})),e}function P(t){switch(t){case"mask":return m.JJ.Mask;case"maskAndTransparency":return m.JJ.MaskBlend;case"none":return m.JJ.Opaque;default:return m.JJ.Blend}}function z(t){const e=t.params;return{id:1,material:e.material,texture:e.texture,region:e.texture}}const U=new c.G(1,2,"wosr")},13212:function(t,e,i){i.d(e,{n:function(){return r}});var n=i(48857);function r(t,e){e.spherical?t.vertex.code.add(n.H`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return normalize(pos + origin);
}`):t.vertex.code.add(n.H`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return vec3(0.0, 0.0, 1.0);
}`),e.spherical?t.vertex.code.add(n.H`mat3 getTBNMatrix(in vec3 n) {
vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`):t.vertex.code.add(n.H`mat3 getTBNMatrix(in vec3 n) {
vec3 t = vec3(1.0, 0.0, 0.0);
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`)}},65001:function(t,e,i){i.d(e,{P:function(){return n}});class n{constructor(t=1/0,e=-1/0){this.near=t,this.far=e}set(t,e){this.near=t,this.far=e}union(t){null!=t&&(this.near=Math.min(this.near,t.near),this.far=Math.max(this.far,t.far))}within(t){return this.near<=t&&t<=this.far}equals(t){return this.near===t.near&&this.far===t.far}static{this.zero=new n(0,0)}static{this.infinite=new n}}},24956:function(t,e,i){i.d(e,{U:function(){return r}});var n=i(40420);function r(t){const{size:e}=t.definition,i=t.fontString(e);let r=s.get(i);if(!r){const l=(0,n.G)(o,0,0).getContext("2d");t.setFontProperties(l,e);const c=l.measureText(h);r=new a(c.actualBoundingBoxAscent,c.actualBoundingBoxDescent),s.set(i,r)}return r}const s=new Map;class a{get maxHeight(){return this.maxAscent+this.maxDescent}constructor(t,e){this.maxAscent=t,this.maxDescent=e}}const o={canvas:null},h=(()=>{let t="";for(let e=32;e<127;e++)t+=String.fromCharCode(e);return t})()},55003:function(t,e,i){i.d(e,{p:function(){return r}});var n=i(32420);class r{constructor(t,e){this._material=t,this._repository=e,this._map=new Map}dispose(){this._map.forEach(((t,e)=>{null!=t&&this._repository.release(this._material,e)}))}load(t,e,i){if(!this._material.produces.get(e)?.(i))return null;this._map.has(i)||this._map.set(i,this._repository.acquire(this._material,e,i));const r=this._map.get(i);if(r){if(r.ensureResources(t)===n.Rw.LOADED)return r;this._repository.requestRender()}return null}}},72913:function(t,e,i){i.d(e,{Pj:function(){return l},hd:function(){return o},nG:function(){return h},rc:function(){return c}});var n=i(99574),r=i(24910),s=i(82846),a=(i(39909),i(75307));function o(t,e,i,n,r,s=2){const a=1/(Math.abs(i)+Math.abs(n)+Math.abs(r)),o=i*a,h=n*a,l=r<=0?(o>=0?1:-1)*(1-Math.abs(h)):o,c=r<=0?(h>=0?1:-1)*(1-Math.abs(o)):h,d=e*s;t[d]=u(l),t[d+1]=u(c)}function h(t){const e=t.length/3,i=(0,a.J)(2*e);let n=0;for(let r=0;r<e;++r)o(i,r,t[n++],t[n++],t[n++]);return i}function l(t,e){const i=t.length/3,n=new Int16Array(2*i);let a=0;const h=(0,s.Ue)();for(let s=0;s<i;++s)h[0]=t[a++],h[1]=t[a++],h[2]=t[a++],(0,r.o)(h,h,e),o(n,s,h[0],h[1],h[2]);return n}function c(t,e,i,n=2){const s=i*n,a=d(e[s]),o=d(e[s+1]),h=1-Math.abs(a)-Math.abs(o);return t[2]=h,h<0?(t[0]=(a>=0?1:-1)*(1-Math.abs(o)),t[1]=(o>=0?1:-1)*(1-Math.abs(a))):(t[0]=a,t[1]=o),(0,r.n)(t,t)}function u(t){return(0,n.uZ)(Math.round(32767*t),-32767,32767)}function d(t){return(0,n.uZ)(t/32767,-1,1)}},40420:function(t,e,i){function n(t,e,i){return t.canvas||(t.canvas=document.createElement("canvas")),t.canvas.width=e,t.canvas.height=i,t.canvas}i.d(e,{G:function(){return n}})},53412:function(t,e,i){i.d(e,{V:function(){return h}});var n=i(53147),r=i(88890),s=i(96711),a=i(96094),o=i(27583);class h{constructor(t){this.definition=t,this.key=JSON.stringify(t),this.haloSize=Math.round(t.halo.size),this.textStyle=l(t.color),this.haloStyle=function(t){return`rgb(${t.slice(0,3).map((t=>Math.floor(255*t))).toString()})`}(t.halo.color),this.backgroundStyle=0!==t.background.color[3]?l(t.background.color):null}fontString(t){const e=this.definition.font;return`${e.style} ${e.weight} ${t}px ${e.family}, sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji`}setFontProperties(t,e){t.font=this.fontString(e),t.textAlign="left",t.textBaseline="alphabetic"}static async fromSymbol(t,e){const i=t?.material?.color,l=n.Z.toUnitRGBA(i)??o.AG,u=null!=t.size?(0,a.F2)(t.size):12,d=t.lineHeight,f=null!=t.background?n.Z.toUnitRGBA(t.background.color):o.AG,_={family:t.font?.family??"sans-serif",decoration:t.font?.decoration??"none",weight:t.font?.weight??"normal",style:t.font?.style??"normal"},g=t.halo,m=null!=g?.color&&g.size>0?{size:(0,a.F2)(g.size),color:n.Z.toUnitRGBA(g.color)}:{size:0,color:o.AG},p=new h({color:l,size:u,background:{color:f,padding:null!=t.background?[.65*u,.5*u]:[0,0],borderRadius:null!=t.background?u*(6/16):0},lineSpacingFactor:d,font:_,halo:m,pixelRatio:e});if(t.font){let e=!1;const i=p.fontString(u);try{e=(await document.fonts.load(i)).some((t=>!(0,r.hZ)(t)))}catch(t){s.Z.getLogger("esri.views.3d.webgl-engine.lib.TextRenderParameters").warnOnce(`Failed to preload font '${i}'. Some text symbology may be rendered using the default browser font.`)}if(!e&&!c.has(t.font.family))try{await(0,r.mx)(t.font)}catch(t){}}return p}}function l(t){return`rgba(${t.slice(0,3).map((t=>Math.floor(255*t))).toString()},${t[3]})`}const c=new Set(["Arial","Times New Roman","Courier New","serif","sans-serif","monospace","cursive","fantasy","system-ui","ui-serif","ui-sans-serif","ui-monospace","ui-rounded","math","emoji","fangsong"])},84262:function(t,e,i){i.d(e,{Wg:function(){return o},tV:function(){return h},vU:function(){return c}});var n=i(99574),r=i(27762),s=i(24956),a=i(40420);const o=1;class h{constructor(t,e,i,n){this.text=t,this._alignment=e,this._parameters=i,this._maxSize=n,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._metricsCached=null,this.key=`${t}--${this._parameters.key}-${this._alignment}`,this._lines=t.replaceAll(" "," ").split(/\r?\n/)}get displayWidth(){return Math.ceil(this._displayWidth+2*this._horizontalPadding)}get displayHeight(){let t=this._metrics.firstLineAscent;for(let e=0;e<this._lines.length-1;e++)t+=this._lineSpacing;return t+=this._metrics.lastLineDescent,Math.ceil(t+2*this._haloSize+2*this._verticalPadding)}get renderedWidth(){return this._toRoundedRenderUnit(this.displayWidth)}get renderedHeight(){return this._toRoundedRenderUnit(this.displayHeight)}get firstRenderedBaselinePosition(){return this._toRenderUnit(this._firstLineYOffset+this._metrics.firstLineAscent)}get _firstLineYOffset(){return this._verticalPadding+this._haloSize}get _metrics(){if(null==this._metricsCached){const t=(0,a.G)(d,_,_).getContext("2d"),e=this._parameters.definition.pixelRatio,i=this._fontSize*e;this._parameters.setFontProperties(t,i);let n=2*this._haloSize;const r=this._parameters.definition.font;"italic"!==r.style&&"oblique"!==r.style&&"bold"!==r.weight&&"bolder"!==r.weight||(n+=.3*t.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;let o=0,h=0,l=0,c=0,u=0;this._lines.forEach(((i,r)=>{const s=t.measureText(i),a=s.width/e,d=a+n;this._textWidths.push(a),this._lineWidths.push(d),o=Math.max(o,d),c=Math.max(c,s.actualBoundingBoxAscent/e),u=Math.max(u,s.actualBoundingBoxDescent/e),0===r&&(h=s.actualBoundingBoxAscent/e),r===this._lines.length-1&&(l=s.actualBoundingBoxDescent/e)}));const f=(0,s.U)(this._parameters),g=Math.max(c,f.maxAscent),p=Math.max(u,f.maxDescent),x=h,y="underline"===this._parameters.definition.font.decoration?p:l,v=o;this._metricsCached=new m(x,y,g,p,v)}return this._metricsCached}get _lineSpacing(){return(this._midLineHeight+this._linePadding)*this._parameters.definition.lineSpacingFactor}get _midLineHeight(){return this._metrics.midLineHeight}get _linePadding(){return this._midLineHeight*f}get _midLineAscent(){return this._metrics.maxLineAscent}get _renderedFontSize(){return this._toRenderUnit(this._fontSize)}get _fontSize(){return this._parameters.definition.size}get _renderedHaloSize(){return this._toRenderUnit(this._haloSize)}get _haloSize(){return this._parameters.haloSize}get _horizontalPadding(){return this._hasBackground?this._parameters.definition.background.padding[0]:0}get _verticalPadding(){return Math.max(this._hasBackground?this._parameters.definition.background.padding[1]:0,o)}get _hasBackground(){return!!this._parameters.backgroundStyle}get renderPixelRatio(){if(null==this._renderPixelRatio){const t=this._parameters.definition.pixelRatio;this._renderPixelRatio=Math.min(t,Math.min(this._maxSize[0]/this.displayWidth,this._maxSize[1]/this.displayHeight))}return this._renderPixelRatio}_getLineXOffset(t){switch(this._alignment){case c.Left:return this._horizontalPadding;case c.Center:return(this.displayWidth-this._lineWidths[t])/2;case c.Right:return this.displayWidth-this._horizontalPadding-this._lineWidths[t]}}render(t,e,i){t.save();const n=e/=this.renderPixelRatio,s=i/=this.renderPixelRatio,a=this._haloSize,o=this._firstLineYOffset+this._metrics.firstLineAscent;e+=a,i+=o;const h=this._haloSize>0;h&&this._renderHalo(t,n,s,a,o),this._parameters.setFontProperties(t,this._renderedFontSize);for(let n=0;n<this._lines.length;++n){const r=this._lines[n],s=this._getLineXOffset(n);h&&(t.globalCompositeOperation="destination-out",t.fillStyle="rgb(0, 0, 0)",this._fillText(t,r,e+s,i),this._renderLineDecoration(t,e+s,i,this._textWidths[n])),t.globalCompositeOperation="source-over",t.fillStyle=this._parameters.textStyle,this._fillText(t,r,e+this._getLineXOffset(n),i),this._renderLineDecoration(t,e+s,i,this._textWidths[n]),i+=this._lineSpacing}if(r.h.TEXT_SHOW_BASELINE){t.strokeStyle=g,t.setLineDash([2,2]),t.lineWidth=1;let e=s+o;for(let i=0;i<this._lines.length;++i)this._drawLine(t,[n,e],[n+this.displayWidth,e]),e+=this._lineSpacing}if(r.h.TEXT_SHOW_BORDER&&(t.strokeStyle=g,t.setLineDash([]),t.lineWidth=1,this._drawBox(t,[n,s],[this.displayWidth,this.displayHeight])),this._hasBackground){const e=this._parameters.definition.background.borderRadius*this.renderPixelRatio;this._roundedRect(t,n,s,e),t.globalCompositeOperation="destination-over",t.fillStyle=this._parameters.backgroundStyle,t.fill()}t.restore()}_renderLineDecoration(t,e,i,n,r=!1){if("none"===this._parameters.definition.font.decoration||0===n)return;const s=Math.max(this._parameters.definition.size/16,1);switch(this._parameters.definition.font.decoration){case"underline":i+=2*s;break;case"line-through":i-=.33*this._midLineAscent}const a=r?this._haloSize:0;t.strokeStyle=r?this._parameters.haloStyle:this._parameters.textStyle,t.lineWidth=this._toRenderUnit(s+2*a),t.beginPath(),t.moveTo(this._toRenderUnit(e-a),this._toRenderUnit(i)),t.lineTo(this._toRenderUnit(e+n+a),this._toRenderUnit(i)),t.stroke()}_roundedRect(t,e,i,r){e=this._toRenderUnit(e),i=this._toRenderUnit(i);const s=this.renderedWidth,a=this.renderedHeight;0!==r?(r=(0,n.uZ)(r,0,Math.floor(a/2)),t.beginPath(),t.moveTo(e,i+r),t.arcTo(e,i,e+r,i,r),t.lineTo(e+s-r,i),t.arcTo(e+s,i,e+s,i+r,r),t.lineTo(e+s,i+a-r),t.arcTo(e+s,i+a,e+s-r,i+a,r),t.lineTo(e+r,i+a),t.arcTo(e,i+a,e,i+a-r,r),t.closePath()):t.rect(e,i,s,a)}_renderHalo(t,e,i,n,r){const s=this.renderedWidth,o=this.renderedHeight,h=(0,a.G)(d,Math.max(s,_),Math.max(o,_)),l=h.getContext("2d");l.clearRect(0,0,s,o),this._parameters.setFontProperties(l,this._renderedFontSize),l.fillStyle=this._parameters.haloStyle,l.strokeStyle=this._parameters.haloStyle;const c=this._renderedHaloSize<3;l.lineJoin=c?"miter":"round",c?this._renderHaloEmulated(l,n,r):this._renderHaloNative(l,n,r);let u=r;for(let t=0;t<this._lines.length;++t){const e=this._getLineXOffset(t);this._renderLineDecoration(l,n+e,u,this._textWidths[t],!0),u+=this._lineSpacing}t.globalAlpha=this._parameters.definition.halo.color[3],t.drawImage(h,0,0,s,o,this._toRenderUnit(e),this._toRenderUnit(i),s,o),t.globalAlpha=1}_renderHaloEmulated(t,e,i){for(let n=0;n<this._lines.length;++n){const r=this._lines[n],s=this._getLineXOffset(n);for(const[n,a]of l)this._fillText(t,r,e+s+this._haloSize*n,i+this._haloSize*a);i+=this._lineSpacing}}_renderHaloNative(t,e,i){const n=2*this._haloSize;for(let r=0;r<this._lines.length;++r){const s=this._lines[r],a=this._getLineXOffset(r),o=5,h=.1;for(let r=0;r<o;r++){const l=1-(o-1)*h+r*h;t.lineWidth=this._toRenderUnit(l*n),this._strokeText(t,s,e+a,i)}i+=this._lineSpacing}}get _displayWidth(){return this._metrics.displayWidth}_toRenderUnit(t){return t*this.renderPixelRatio}_toRoundedRenderUnit(t){return Math.round(t*this.renderPixelRatio)}_fillText(t,e,i,n){t.fillText(e,this._toRenderUnit(i),this._toRenderUnit(n))}_strokeText(t,e,i,n){t.strokeText(e,this._toRenderUnit(i),this._toRenderUnit(n))}_drawLine(t,e,i){t.beginPath(),t.moveTo(this._toRoundedRenderUnit(e[0])+.5,this._toRoundedRenderUnit(e[1])+.5),t.lineTo(this._toRoundedRenderUnit(i[0])+.5,this._toRoundedRenderUnit(i[1])+.5),t.stroke()}_drawBox(t,e,i){const n=this._toRenderUnit(e[0]),r=this._toRenderUnit(e[1]),s=this._toRenderUnit(i[0]),a=this._toRenderUnit(i[1]),o=Math.floor(n)+.5,h=Math.ceil(n+s)-.5,l=Math.floor(r)+.5,c=Math.ceil(r+a)-.5;t.beginPath(),t.moveTo(o,l),t.lineTo(h,l),t.lineTo(h,c),t.lineTo(o,c),t.lineTo(o,l),t.stroke()}}const l=[];{const t=16;for(let e=0;e<360;e+=360/t)l.push([Math.cos(Math.PI*e/180),Math.sin(Math.PI*e/180)])}var c,u;(u=c||(c={}))[u.Left=0]="Left",u[u.Center=1]="Center",u[u.Right=2]="Right";const d={canvas:null},f=.2,_=512,g="rgb(255, 0, 255, 0.5)";class m{get firstLineHeight(){return this.firstLineAscent+this.maxLineDescent}get midLineHeight(){return this.maxLineAscent+this.maxLineDescent}get lastLineHeight(){return this.maxLineAscent+this.lastLineDescent}constructor(t,e,i,n,r){this.firstLineAscent=t,this.lastLineDescent=e,this.maxLineAscent=i,this.maxLineDescent=n,this.displayWidth=r}}},4664:function(t,e,i){i.d(e,{U:function(){return v}});var n=i(73440),r=i(70880),s=i(87833),a=(i(61432),i(61100)),o=i(67908),h=i(17155),l=(i(96711),i(83850),i(48023)),c=i(73749),u=i(27583),d=i(21243),f=i(51440),_=i(50399),g=i(78891),m=i(65650),p=i(8158),x=i(35928);const y=4096;let v=class extends r.Z{constructor(t){super(t),this.id=(0,o.D)(),this.events=new s.Z,this._glTexture=null,this._atlas=new S(256,256),this._needsRepack=!1,this._canRepack=!0,this._elementsToRender=new Map,this._elements=new Map,this._uvCallbacks=new Map,this.updating=!1}initialize(){this._canvas=document.createElement("canvas"),this._canvas.setAttribute("id","textAtlasCanvas"),this._canvas.setAttribute("style","display:none"),this._ctx=this._canvas.getContext("2d"),this._stage=this.view.stage,this._stage.addTexture(this),this._updateCanvasElementSize(this._atlas),this._reset()}unload(){this._glTexture=(0,a.M2)(this._glTexture),this._frameWorker=(0,a.hw)(this._frameWorker),this.updating=!1,this.events.emit("unloaded")}get loaded(){return null!=this._glTexture}get glTexture(){return this._glTexture}static get maxSize(){return M=d.y.stableRendering?w:0,[y-w-M,y-w-M-b]}load(t){if(this._glTexture)return this._glTexture;const e=new x.X;return e.wrapMode=m.e8.CLAMP_TO_EDGE,e.samplingMode=m.cw.LINEAR_MIPMAP_LINEAR,e.hasMipmap=!0,e.preMultiplyAlpha=!0,e.maxAnisotropy=t.parameters.maxMaxAnisotropy,this._glTexture=new p.x(t,e,this._canvas),this._frameWorker=this.view.resourceController.scheduler.registerTask(_.T8.TEXT_TEXTURE_ATLAS,this),this.setDirty(),this._glTexture}dispose(){this._elements.clear(),this._elementsToRender.clear(),this._frameWorker=(0,a.hw)(this._frameWorker),this._glTexture&&(this._stage.removeTexture(this),this._glTexture=(0,a.M2)(this._glTexture)),this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._ctx=null}_updateCanvasElementSize(t){this._canvas.width=t.width,this._canvas.height=t.height}_resizeAtlas(t,e){const{width:i,height:n}=this._atlas;i===t&&n===e||(this._atlas.width=t,this._atlas.height=e,this._glTexture?.resize(t,e),this._glTexture?.updateData(0,0,0,i,n,this._canvas),this._updateCanvasElementSize(this._atlas),this._elements.forEach((t=>this._uvCallbacks.get(t.textRenderer.key)?.forEach((e=>e(t.uv))))),this._reset())}_reset(){this._elementsToRender.clear(),this._atlas.reset(),this._needsRepack=!0,this.setDirty()}_addAtlasElement(t,e,i,n){const r=this._atlas;if(r.width<i||r.height<n)return!1;let s=r.cursors.get(n);if(!s){if(r.height<r.nextY+n)return!1;s=[new T(r.nextY)],r.cursors.set(n,s),r.nextY+=n}let a=s.find((t=>r.width>=t.x+i));if(null==a){if(r.height<r.nextY+n)return!1;a=new T(r.nextY),r.nextY+=n,s.push(a)}return t.setNewPosition(a),this._elements.set(e,t),this._elementsToRender.set(e,t),a.x+=i,!0}_ensureCallbacks(t){const e=this._uvCallbacks.get(t);if(e)return e;const i=new Set;return this._uvCallbacks.set(t,i),i}_addCallback(t,e){this._ensureCallbacks(t).add(e)}_removeCallback(t,e){const i=this._uvCallbacks.get(t);return!(!i?.delete(e)||0!==i.size||(this._uvCallbacks.delete(t),0))}_processAddition(t){const e=t.textRenderer.key;if(this._needsRepack)return void this._elements.set(e,t);const i=this._atlas,n=t.textRenderer.renderedWidth,r=t.textRenderer.renderedHeight,s=n+w,a=r+w+b;if(!this._addAtlasElement(t,e,s,a)){if(this._canRepack)this._reset();else if(i.width<s){const t=(0,f.gu)(Math.max(s,1.5*i.width),y);this._resizeAtlas(t,i.height)}else{const t=i.nextY+a,e=(0,f.gu)(Math.max(t,1.5*i.height),y);if(e>i.height)this._resizeAtlas(i.width,e);else if(i.width<y){const t=(0,f.gu)(1.5*i.width,y);this._resizeAtlas(t,i.height)}}this._elements.set(e,t)}}_renderElement(t){const e=t.commitNewPosition(),i=t.textRenderer;this._ctx.clearRect(e[0]-w,e[1]-w,i.renderedWidth+2*w,i.renderedHeight+2*w),i.render(this._ctx,e[0],e[1]),this._uvCallbacks.get(i.key)?.forEach((e=>e(t.uv)))}get running(){return this.updating}runTask(t){if(null==this._glTexture)return g.J;for(;this._needsRepack&&(this._canRepack||this._atlas.height<y&&this._atlas.height<y);){this._canRepack=this._needsRepack=!1;const e=this._elements;this._elements=new Map,e.forEach((t=>this._processAddition(t))),t.madeProgress()}if(this._elementsToRender.size>0){for(const[e,i]of this._elementsToRender){if(t.done)break;this._renderElement(i),this._elementsToRender.delete(e),t.madeProgress()}this._glTexture.setData(this._canvas)}this.updating=this._elementsToRender.size>0}addText(t,e){const i=t.key;this._addCallback(i,e);let n=this._elements.get(i);return n?(0,c.a)(n.uv,u.AG)||e(n.uv):(n=new R(t),this._processAddition(n),this.setDirty()),{remove:()=>this._removeText(t,e)}}_removeText(t,e){const i=t.key;this._elements.get(i)&&this._removeCallback(i,e)&&(this._elements.delete(i),this._elementsToRender.delete(i),this._canRepack=!0)}setDirty(){this._glTexture&&(this.updating=!0)}get test(){}};(0,n._)([(0,h.Cb)({constructOnly:!0})],v.prototype,"view",void 0),(0,n._)([(0,h.Cb)({type:Boolean})],v.prototype,"updating",void 0),v=(0,n._)([(0,l.j)("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],v);const w=2,b=2;class R{constructor(t){this.textRenderer=t,this._uv=(0,u.Ue)(),this._newPosition=[0,0]}get uv(){if(null==this._xOffset||null==this._yOffset)return u.AG;const{renderedWidth:t,renderedHeight:e}=this.textRenderer;return(0,c.s)(this._uv,this._xOffset,this._yOffset+e,this._xOffset+t,this._yOffset)}setNewPosition(t){this._newPosition[0]=t.x,this._newPosition[1]=t.y}commitNewPosition(){return this._xOffset=this._newPosition[0],this._yOffset=this._newPosition[1],this._newPosition}get xOffset(){return this._xOffset}get yOffset(){return this._yOffset}}class S{constructor(t,e){this.width=t,this.height=e,this.cursors=new Map,this.nextY=0}reset(){this.cursors.clear(),this.nextY=M}}class T{constructor(t){this.y=t,this.x=M}}let M=0}}]);