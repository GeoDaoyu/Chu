"use strict";(self.webpackChunkscene_pro=self.webpackChunkscene_pro||[]).push([[28118],{2875:function(t,e,n){n.d(e,{a:function(){return u},b:function(){return o},c:function(){return a},d:function(){return r},e:function(){return d},f:function(){return c},l:function(){return l},n:function(){return f},t:function(){return s}});var i=n(38461);n(61432),n(96711);function r(t,e,n){s(t.typedBuffer,e.typedBuffer,n,t.typedBufferStride,e.typedBufferStride)}function s(t,e,n,i=3,r=i){if(t.length/i!==Math.ceil(e.length/r))return t;const s=t.length/i,a=n[0],o=n[1],h=n[2],l=n[4],c=n[5],u=n[6],d=n[8],f=n[9],_=n[10],g=n[12],m=n[13],p=n[14];let y=0,x=0;for(let n=0;n<s;n++){const n=e[y],s=e[y+1],w=e[y+2];t[x]=a*n+l*s+d*w+g,t[x+1]=o*n+c*s+f*w+m,t[x+2]=h*n+u*s+_*w+p,y+=r,x+=i}return t}function a(t,e,n){o(t.typedBuffer,e.typedBuffer,n,t.typedBufferStride,e.typedBufferStride)}function o(t,e,n,i=3,r=i){if(t.length/i!==Math.ceil(e.length/r))return;const s=t.length/i,a=n[0],o=n[1],h=n[2],l=n[3],c=n[4],u=n[5],d=n[6],f=n[7],_=n[8];let g=0,m=0;for(let n=0;n<s;n++){const n=e[g],s=e[g+1],p=e[g+2];t[m]=a*n+l*s+d*p,t[m+1]=o*n+c*s+f*p,t[m+2]=h*n+u*s+_*p,g+=r,m+=i}}function h(t,e,n,i=3,r=i){const s=Math.min(t.length/i,e.length/r);let a=0,o=0;for(let h=0;h<s;h++)t[o]=n*e[a],t[o+1]=n*e[a+1],t[o+2]=n*e[a+2],a+=r,o+=i;return t}function l(t,e,n,i){c(t.typedBuffer,e.typedBuffer,n,i,t.typedBufferStride,e.typedBufferStride)}function c(t,e,n,r,s=3,a=s){const o=Math.min(t.length/s,e.length/a);let h=0,l=0;const c=1/i.jm;for(let i=0;i<o;i++)t[l]=r*(n*e[h])**c,t[l+1]=r*(n*e[h+1])**c,t[l+2]=r*(n*e[h+2])**c,h+=a,l+=s}function u(t,e,n,i=3,r=i){const s=t.length/i;if(s!==Math.ceil(e.length/r))return t;let a=0,o=0;for(let h=0;h<s;h++)t[o]=e[a]+n[0],t[o+1]=e[a+1]+n[1],t[o+2]=e[a+2]+n[2],a+=r,o+=i;return t}function d(t,e){f(t.typedBuffer,e.typedBuffer,t.typedBufferStride,e.typedBufferStride)}function f(t,e,n=3,i=n){const r=Math.min(t.length/n,e.length/i);let s=0,a=0;for(let o=0;o<r;o++){const r=e[s],o=e[s+1],h=e[s+2],l=r*r+o*o+h*h;if(l>0){const e=1/Math.sqrt(l);t[a]=e*r,t[a+1]=e*o,t[a+2]=e*h}s+=i,a+=n}}Object.freeze(Object.defineProperty({__proto__:null,linearToSRGB:c,linearToSRGBView:l,normalize:f,normalizeView:d,scale:h,scaleView:function(t,e,n){h(t.typedBuffer,e.typedBuffer,n,t.typedBufferStride,e.typedBufferStride)},shiftRight:function(t,e,n){const i=Math.min(t.count,e.count),r=t.typedBuffer,s=t.typedBufferStride,a=e.typedBuffer,o=e.typedBufferStride;let h=0,l=0;for(let t=0;t<i;t++)r[l]=a[h]>>n,r[l+1]=a[h+1]>>n,r[l+2]=a[h+2]>>n,h+=o,l+=s},transformMat3:o,transformMat3View:a,transformMat4:s,transformMat4View:r,translate:u},Symbol.toStringTag,{value:"Module"}))},88890:function(t,e,n){n.d(e,{em:function(){return r},hZ:function(){return c},mx:function(){return l}});var i=n(81001);const r="arial-unicode-ms",s="woff2",a=new Map,o=new Set;class h{constructor(t,e){this.fontFace=t,this.promise=e}}async function l(t){const e=f(t),n=d(t),r=a.get(e);if(r)return r.promise;const l=new FontFace(t.family,`url('${i.default.fontsUrl}/woff2/${n}.${s}') format('${s}')`,{style:t.style,weight:t.weight}),c=document.fonts;if(c.has(l)&&"loading"===l.status)return l.loaded;const u=l.load().then((()=>(c.add(l),l)));return a.set(e,new h(l,u)),o.add(l),u}function c(t){return o.has(t)}function u(t){if(!t)return r;const e=t.toLowerCase().split(" ").join("-");switch(e){case"serif":return"noto-serif";case"sans-serif":return"arial-unicode-ms";case"monospace":return"ubuntu-mono";case"fantasy":return"cabin-sketch";case"cursive":return"redressed";default:return e}}function d(t){const e=_(t)+g(t);return u(t.family)+(e.length>0?e:"-regular")}function f(t){const e=_(t)+g(t);return(t.family||r)+(e.length>0?e:"-regular")}function _(t){if(!t.weight)return"";switch(t.weight.toLowerCase()){case"bold":case"bolder":return"-bold"}return""}function g(t){if(!t.style)return"";switch(t.style.toLowerCase()){case"italic":case"oblique":return"-italic"}return""}},35236:function(t,e,n){n.d(e,{Jl:function(){return u},n$:function(){return f},r7:function(){return c}});var i=n(78619),r=n(88194),s=n(93568),a=n(95490),o=n(90230);let h=null,l=!0;function c(t,e,n){if(!t||!e)throw new Error("Cannot construct image data without dimensions");if(l)try{return new ImageData(t,e)}catch(t){l=!1}return d(t,e,n)}function u(t,e,n,i){if(!e||!n)throw new Error("Cannot construct image data without dimensions");if(l)try{return new ImageData(t,e,n)}catch(t){l=!1}const r=d(e,n,i);return r.data.set(t,0),r}function d(t,e,n){return n||(h||(h=document.createElement("canvas"),h.width=1,h.height=1),n=h),n.getContext("2d").createImageData(t,e)}async function f(t,e){const{arrayBuffer:h,mediaType:l}=await async function(t,e){const n=(0,a.sJ)(t);if(n?.isBase64)return{arrayBuffer:(0,o.R)(n.data),mediaType:n.mediaType};const r=await(0,i.Z)(t,{responseType:"array-buffer",...e});return{arrayBuffer:r.data,mediaType:r.getHeader?.("Content-Type")??""}}(t,e),c="image/png"===l;if("image/gif"===l){const{isAnimatedGIF:t,parseGif:i}=await n.e(20256).then(n.bind(n,20256));if(t(h))return i(h,e)}if(c){const{isAnimatedPNG:t,parseApng:i}=await n.e(98333).then(n.bind(n,98333));if(t(h))return i(h,e)}return async function(t,e){const n=window.URL.createObjectURL(t);try{const{data:t}=await(0,i.Z)(n,{...e,responseType:"image"});return t}catch(t){if(!(0,s.D_)(t))throw new r.Z("invalid-image",`Could not fetch requested image at ${n}`);throw t}finally{window.URL.revokeObjectURL(n)}}(new Blob([h],{type:l}),e)}},75307:function(t,e,n){n.d(e,{J:function(){return r}});var i=n(59384);function r(t){return t<=i.c8?new Array(t):new Int16Array(t)}},95631:function(t,e,n){n.d(e,{C:function(){return h}});var i=n(78619),r=n(29292),s=n(88194),a=n(93568),o=n(95490);class h{constructor(t){this._streamDataRequester=t}async loadJSON(t,e){return this._load("json",t,e)}async loadBinary(t,e){return(0,o.HK)(t)?((0,a.k_)(e),(0,o.AH)(t)):this._load("binary",t,e)}async loadImage(t,e){return this._load("image",t,e)}async _load(t,e,n){if(null==this._streamDataRequester)return(await(0,i.Z)(e,{responseType:l[t]})).data;const o=await(0,r.q6)(this._streamDataRequester.request(e,t,n));if(!0===o.ok)return o.value;throw(0,a.r9)(o.error),new s.Z("glt-loader-request-error",`Request for resource failed: ${o.error}`)}}const l={image:"image",binary:"array-buffer",json:"json","image+type":void 0}},91896:function(t,e,n){n.d(e,{U:function(){return o},a:function(){return a}});var i=n(41788),r=n(82846),s=n(27583);class a{constructor(t,e="center",n=!1,a=(0,i.Ue)(),o=(0,s.al)(0,0,0,-1),h="world",l=(0,r.Ue)(),c=0){this.verticalOffset=t,this.anchor=e,this.hasLabelVerticalOffset=n,this.screenOffset=a,this.centerOffset=o,this.centerOffsetUnits=h,this.translation=l,this.elevationOffset=c}}class o{constructor(t,e="center",n="center",r=null,s=(0,i.Ue)(),a=!0){this.placement=t,this.horizontalPlacement=e,this.verticalPlacement=n,this.text=r,this.displaySize=s,this.isFocused=a}}},29989:function(t,e,n){n.d(e,{$A:function(){return a},EP:function(){return c},QW:function(){return u},c4:function(){return f},j1:function(){return d},mq:function(){return h},yY:function(){return o},zi:function(){return l}});var i=n(26821),r=n(41788),s=n(84262);const a=Object.freeze({left:0,center:.5,right:1}),o=Object.freeze({"bottom-left":(0,r.al)(0,0),bottom:(0,r.al)(.5,0),"bottom-right":(0,r.al)(1,0),left:(0,r.al)(0,.5),center:(0,r.al)(.5,.5),right:(0,r.al)(1,.5),"top-left":(0,r.al)(0,1),top:(0,r.al)(.5,1),"top-right":(0,r.al)(1,1)});function h(t){switch(t){case"left":return s.vU.Left;case"right":return s.vU.Right;default:return s.vU.Center}}function l(t){switch(t){case"bottom-left":case"left":case"top-left":return"left";case"bottom":case"center":case"top":return"center";case"bottom-right":case"right":case"top-right":return"right"}}function c(t){switch(t){case"bottom-left":case"bottom":case"bottom-right":return"bottom";case"left":case"center":case"right":return"center";case"top-left":case"top":case"top-right":return"top"}}function u(t,e){switch(e){case"bottom":return"left"===t?"bottom-left":"right"===t?"bottom-right":"bottom";case"center":return t;case"top":return"left"===t?"top-left":"right"===t?"top-right":"top"}}function d(t){return"middle"===t?"center":t}function f(t,e){switch(t){case"top":return(0,i.t8)(e,0,s.Wg);case"bottom":return(0,i.t8)(e,0,-1);default:return(0,i.JG)(e,r.AG)}}},58744:function(t,e,n){n.d(e,{p2:function(){return A},zD:function(){return T}});var i=n(78619),r=n(29292),s=n(88194),a=n(96711),o=n(85881),h=n(61544),l=n(93568),c=n(15322),u=n(82846),d=n(16447),f=n(38766),_=n(51880),g=n(81749),m=n(32420),p=n(25952),y=n(28751),x=n(52061),w=n(35720),v=n(65650);const b=()=>a.Z.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");class R{constructor(t,e,n){this.resource=t,this.textures=e,this.cachedMemory=n}}async function T(t,e){const n=await async function(t,e){const n=e?.streamDataRequester;if(n)return async function(t,e,n){const i=await(0,r.q6)(e.request(t,"json",n));if(!0===i.ok)return i.value;(0,l.r9)(i.error),S(i.error.details.url)}(t,n,e);const s=await(0,r.q6)((0,i.Z)(t,e));if(!0===s.ok)return s.value.data;(0,l.r9)(s.error),S(s.error)}(t,e),s=await async function(t,e){const n=new Array;for(const i in t){const r=t[i],s=r.images[0].data;if(!s){b().warn("Externally referenced texture data is not yet supported");continue}const a=r.encoding+";base64,"+s,o="/textureDefinitions/"+i,h="rgba"===r.channels?r.alphaChannelUsage||"transparency":"none",l={noUnpackFlip:!0,wrap:{s:v.e8.REPEAT,t:v.e8.REPEAT},preMultiplyAlpha:P(h)!==m.JJ.Opaque},c=e?.disableTextures?Promise.resolve(null):(0,_.t)(a,e);n.push(c.then((t=>({refId:o,image:t,parameters:l,alphaChannelUsage:h}))))}const i=await Promise.all(n),r={};for(const t of i)r[t.refId]=t;return r}(n.textureDefinitions??{},e);let a=0;for(const t in s)if(s.hasOwnProperty(t)){const e=s[t];a+=e?.image?e.image.width*e.image.height*4:0}return new R(n,s,a+(0,o.kk)(n))}function S(t){throw new s.Z("",`Request for object resource failed: ${t}`)}function k(t){const e=t.params,n=e.topology;let i=!0;switch(e.vertexAttributes||(b().warn("Geometry must specify vertex attributes"),i=!1),e.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const t=e.faces;if(t){if(e.vertexAttributes)for(const n in e.vertexAttributes){const e=t[n];e?.values?(null!=e.valueType&&"UInt32"!==e.valueType&&(b().warn(`Unsupported indexed geometry indices type '${e.valueType}', only UInt32 is currently supported`),i=!1),null!=e.valuesPerElement&&1!==e.valuesPerElement&&(b().warn(`Unsupported indexed geometry values per element '${e.valuesPerElement}', only 1 is currently supported`),i=!1)):(b().warn(`Indexed geometry does not specify face indices for '${n}' attribute`),i=!1)}}else b().warn("Indexed geometries must specify faces"),i=!1;break}default:b().warn(`Unsupported topology '${n}'`),i=!1}t.params.material||(b().warn("Geometry requires material"),i=!1);const r=t.params.vertexAttributes;for(const t in r)r[t].values||(b().warn("Geometries with externally defined attributes are not yet supported"),i=!1);return i}function A(t,e){const n=new Array,i=new Array,r=new Array,s=new h.r,a=t.resource,o=c.G.parse(a.version||"1.0","wosr");U.validate(o);const l=a.model.name,d=a.model.geometries,_=a.materialDefinitions??{},v=t.textures;let b=0;const R=new Map;for(let t=0;t<d.length;t++){const a=d[t];if(!k(a))continue;const o=z(a),h=a.params.vertexAttributes,l=[],c=t=>{if("PerAttributeArray"===a.params.topology)return null;const e=a.params.faces;for(const n in e)if(n===t)return e[n].values;return null},T=h[x.T.POSITION],S=T.values.length/T.valuesPerElement;for(const t in h){const e=h[t],n=e.values,i=c(t)??(0,f.KF)(S);l.push([t,new g.a(n,i,e.valuesPerElement,!0)])}const A=o.texture,M=v&&v[A];if(M&&!R.has(A)){const{image:t,parameters:e}=M,n=new y.x(t,e);i.push(n),R.set(A,n)}const U=R.get(A),B=U?U.id:void 0,L=o.material;let C=s.get(L,A);if(null==C){const t=_[L.slice(L.lastIndexOf("/")+1)].params;1===t.transparency&&(t.transparency=0);const n=M?P(M.alphaChannelUsage):void 0,i={ambient:(0,u.nI)(t.diffuse),diffuse:(0,u.nI)(t.diffuse),opacity:1-(t.transparency||0),textureAlphaMode:n,textureAlphaCutoff:.33,textureId:B,doubleSided:!0,cullFace:m.Vr.None,colorMixMode:t.externalColorMixMode||"tint",textureAlphaPremultiplied:M?.parameters.preMultiplyAlpha??!1};e?.materialParameters&&Object.assign(i,e.materialParameters),C=new w.Gp(i,e),s.set(L,A,C)}r.push(C);const O=new p.Z(C,l);b+=l.find((t=>t[0]===x.T.POSITION))?.[1]?.indices.length??0,n.push(O)}return{engineResources:[{name:l,stageResources:{textures:i,materials:r,geometries:n},pivotOffset:a.model.pivotOffset,numberOfVertices:b,lodThreshold:null}],referenceBoundingBox:M(n)}}function M(t){const e=(0,d.cS)();return t.forEach((t=>{const n=t.boundingInfo;null!=n&&((0,d.pp)(e,n.bbMin),(0,d.pp)(e,n.bbMax))})),e}function P(t){switch(t){case"mask":return m.JJ.Mask;case"maskAndTransparency":return m.JJ.MaskBlend;case"none":return m.JJ.Opaque;default:return m.JJ.Blend}}function z(t){const e=t.params;return{id:1,material:e.material,texture:e.texture,region:e.texture}}const U=new c.G(1,2,"wosr")},13212:function(t,e,n){n.d(e,{n:function(){return r}});var i=n(48857);function r(t,e){e.spherical?t.vertex.code.add(i.H`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return normalize(pos + origin);
}`):t.vertex.code.add(i.H`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return vec3(0.0, 0.0, 1.0);
}`),e.spherical?t.vertex.code.add(i.H`mat3 getTBNMatrix(in vec3 n) {
vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`):t.vertex.code.add(i.H`mat3 getTBNMatrix(in vec3 n) {
vec3 t = vec3(1.0, 0.0, 0.0);
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`)}},65001:function(t,e,n){n.d(e,{P:function(){return i}});class i{constructor(t=1/0,e=-1/0){this.near=t,this.far=e}set(t,e){this.near=t,this.far=e}union(t){null!=t&&(this.near=Math.min(this.near,t.near),this.far=Math.max(this.far,t.far))}within(t){return this.near<=t&&t<=this.far}equals(t){return this.near===t.near&&this.far===t.far}static{this.zero=new i(0,0)}static{this.infinite=new i}}},24956:function(t,e,n){n.d(e,{U:function(){return r}});var i=n(40420);function r(t){const{size:e}=t.definition,n=t.fontString(e);let r=s.get(n);if(!r){const l=(0,i.G)(o,0,0).getContext("2d");t.setFontProperties(l,e);const c=l.measureText(h);r=new a(c.actualBoundingBoxAscent,c.actualBoundingBoxDescent),s.set(n,r)}return r}const s=new Map;class a{get maxHeight(){return this.maxAscent+this.maxDescent}constructor(t,e){this.maxAscent=t,this.maxDescent=e}}const o={canvas:null},h=(()=>{let t="";for(let e=32;e<127;e++)t+=String.fromCharCode(e);return t})()},55003:function(t,e,n){n.d(e,{p:function(){return r}});var i=n(32420);class r{constructor(t,e){this._material=t,this._repository=e,this._map=new Map}dispose(){this._map.forEach(((t,e)=>{null!=t&&this._repository.release(this._material,e)}))}load(t,e,n){if(!this._material.produces.get(e)?.(n))return null;this._map.has(n)||this._map.set(n,this._repository.acquire(this._material,e,n));const r=this._map.get(n);if(r){if(r.ensureResources(t)===i.Rw.LOADED)return r;this._repository.requestRender()}return null}}},72913:function(t,e,n){n.d(e,{Pj:function(){return l},hd:function(){return o},nG:function(){return h},rc:function(){return c}});var i=n(99574),r=n(24910),s=n(82846),a=(n(39909),n(75307));function o(t,e,n,i,r,s=2){const a=1/(Math.abs(n)+Math.abs(i)+Math.abs(r)),o=n*a,h=i*a,l=r<=0?(o>=0?1:-1)*(1-Math.abs(h)):o,c=r<=0?(h>=0?1:-1)*(1-Math.abs(o)):h,d=e*s;t[d]=u(l),t[d+1]=u(c)}function h(t){const e=t.length/3,n=(0,a.J)(2*e);let i=0;for(let r=0;r<e;++r)o(n,r,t[i++],t[i++],t[i++]);return n}function l(t,e){const n=t.length/3,i=new Int16Array(2*n);let a=0;const h=(0,s.Ue)();for(let s=0;s<n;++s)h[0]=t[a++],h[1]=t[a++],h[2]=t[a++],(0,r.o)(h,h,e),o(i,s,h[0],h[1],h[2]);return i}function c(t,e,n,i=2){const s=n*i,a=d(e[s]),o=d(e[s+1]),h=1-Math.abs(a)-Math.abs(o);return t[2]=h,h<0?(t[0]=(a>=0?1:-1)*(1-Math.abs(o)),t[1]=(o>=0?1:-1)*(1-Math.abs(a))):(t[0]=a,t[1]=o),(0,r.n)(t,t)}function u(t){return(0,i.uZ)(Math.round(32767*t),-32767,32767)}function d(t){return(0,i.uZ)(t/32767,-1,1)}},40420:function(t,e,n){function i(t,e,n){return t.canvas||(t.canvas=document.createElement("canvas")),t.canvas.width=e,t.canvas.height=n,t.canvas}n.d(e,{G:function(){return i}})},53412:function(t,e,n){n.d(e,{V:function(){return h}});var i=n(53147),r=n(88890),s=n(96711),a=n(96094),o=n(27583);class h{constructor(t){this.definition=t,this.key=JSON.stringify(t),this.haloSize=Math.round(t.halo.size),this.textStyle=l(t.color),this.haloStyle=function(t){return`rgb(${t.slice(0,3).map((t=>Math.floor(255*t))).toString()})`}(t.halo.color),this.backgroundStyle=0!==t.background.color[3]?l(t.background.color):null}fontString(t){const e=this.definition.font;return`${e.style} ${e.weight} ${t}px ${e.family}, sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji`}setFontProperties(t,e){t.font=this.fontString(e),t.textAlign="left",t.textBaseline="alphabetic"}static async fromSymbol(t,e){const n=t?.material?.color,l=i.Z.toUnitRGBA(n)??o.AG,u=null!=t.size?(0,a.F2)(t.size):12,d=t.lineHeight,f=null!=t.background?i.Z.toUnitRGBA(t.background.color):o.AG,_={family:t.font?.family??"sans-serif",decoration:t.font?.decoration??"none",weight:t.font?.weight??"normal",style:t.font?.style??"normal"},g=t.halo,m=null!=g?.color&&g.size>0?{size:(0,a.F2)(g.size),color:i.Z.toUnitRGBA(g.color)}:{size:0,color:o.AG},p=new h({color:l,size:u,background:{color:f,padding:null!=t.background?[.65*u,.5*u]:[0,0],borderRadius:null!=t.background?u*(6/16):0},lineSpacingFactor:d,font:_,halo:m,pixelRatio:e});if(t.font){let e=!1;const n=p.fontString(u);try{e=(await document.fonts.load(n)).some((t=>!(0,r.hZ)(t)))}catch(t){s.Z.getLogger("esri.views.3d.webgl-engine.lib.TextRenderParameters").warnOnce(`Failed to preload font '${n}'. Some text symbology may be rendered using the default browser font.`)}if(!e&&!c.has(t.font.family))try{await(0,r.mx)(t.font)}catch(t){}}return p}}function l(t){return`rgba(${t.slice(0,3).map((t=>Math.floor(255*t))).toString()},${t[3]})`}const c=new Set(["Arial","Times New Roman","Courier New","serif","sans-serif","monospace","cursive","fantasy","system-ui","ui-serif","ui-sans-serif","ui-monospace","ui-rounded","math","emoji","fangsong"])},84262:function(t,e,n){n.d(e,{Wg:function(){return o},tV:function(){return h},vU:function(){return c}});var i=n(99574),r=n(27762),s=n(24956),a=n(40420);const o=1;class h{constructor(t,e,n,i){this.text=t,this._alignment=e,this._parameters=n,this._maxSize=i,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._metricsCached=null,this.key=`${t}--${this._parameters.key}-${this._alignment}`,this._lines=t.replaceAll(" "," ").split(/\r?\n/)}get displayWidth(){return Math.ceil(this._displayWidth+2*this._horizontalPadding)}get displayHeight(){let t=this._metrics.firstLineAscent;for(let e=0;e<this._lines.length-1;e++)t+=this._lineSpacing;return t+=this._metrics.lastLineDescent,Math.ceil(t+2*this._haloSize+2*this._verticalPadding)}get renderedWidth(){return this._toRoundedRenderUnit(this.displayWidth)}get renderedHeight(){return this._toRoundedRenderUnit(this.displayHeight)}get firstRenderedBaselinePosition(){return this._toRenderUnit(this._firstLineYOffset+this._metrics.firstLineAscent)}get _firstLineYOffset(){return this._verticalPadding+this._haloSize}get _metrics(){if(null==this._metricsCached){const t=(0,a.G)(d,_,_).getContext("2d"),e=this._parameters.definition.pixelRatio,n=this._fontSize*e;this._parameters.setFontProperties(t,n);let i=2*this._haloSize;const r=this._parameters.definition.font;"italic"!==r.style&&"oblique"!==r.style&&"bold"!==r.weight&&"bolder"!==r.weight||(i+=.3*t.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;let o=0,h=0,l=0,c=0,u=0;this._lines.forEach(((n,r)=>{const s=t.measureText(n),a=s.width/e,d=a+i;this._textWidths.push(a),this._lineWidths.push(d),o=Math.max(o,d),c=Math.max(c,s.actualBoundingBoxAscent/e),u=Math.max(u,s.actualBoundingBoxDescent/e),0===r&&(h=s.actualBoundingBoxAscent/e),r===this._lines.length-1&&(l=s.actualBoundingBoxDescent/e)}));const f=(0,s.U)(this._parameters),g=Math.max(c,f.maxAscent),p=Math.max(u,f.maxDescent),y=h,x="underline"===this._parameters.definition.font.decoration?p:l,w=o;this._metricsCached=new m(y,x,g,p,w)}return this._metricsCached}get _lineSpacing(){return(this._midLineHeight+this._linePadding)*this._parameters.definition.lineSpacingFactor}get _midLineHeight(){return this._metrics.midLineHeight}get _linePadding(){return this._midLineHeight*f}get _midLineAscent(){return this._metrics.maxLineAscent}get _renderedFontSize(){return this._toRenderUnit(this._fontSize)}get _fontSize(){return this._parameters.definition.size}get _renderedHaloSize(){return this._toRenderUnit(this._haloSize)}get _haloSize(){return this._parameters.haloSize}get _horizontalPadding(){return this._hasBackground?this._parameters.definition.background.padding[0]:0}get _verticalPadding(){return Math.max(this._hasBackground?this._parameters.definition.background.padding[1]:0,o)}get _hasBackground(){return!!this._parameters.backgroundStyle}get renderPixelRatio(){if(null==this._renderPixelRatio){const t=this._parameters.definition.pixelRatio;this._renderPixelRatio=Math.min(t,Math.min(this._maxSize[0]/this.displayWidth,this._maxSize[1]/this.displayHeight))}return this._renderPixelRatio}_getLineXOffset(t){switch(this._alignment){case c.Left:return this._horizontalPadding;case c.Center:return(this.displayWidth-this._lineWidths[t])/2;case c.Right:return this.displayWidth-this._horizontalPadding-this._lineWidths[t]}}render(t,e,n){t.save();const i=e/=this.renderPixelRatio,s=n/=this.renderPixelRatio,a=this._haloSize,o=this._firstLineYOffset+this._metrics.firstLineAscent;e+=a,n+=o;const h=this._haloSize>0;h&&this._renderHalo(t,i,s,a,o),this._parameters.setFontProperties(t,this._renderedFontSize);for(let i=0;i<this._lines.length;++i){const r=this._lines[i],s=this._getLineXOffset(i);h&&(t.globalCompositeOperation="destination-out",t.fillStyle="rgb(0, 0, 0)",this._fillText(t,r,e+s,n),this._renderLineDecoration(t,e+s,n,this._textWidths[i])),t.globalCompositeOperation="source-over",t.fillStyle=this._parameters.textStyle,this._fillText(t,r,e+this._getLineXOffset(i),n),this._renderLineDecoration(t,e+s,n,this._textWidths[i]),n+=this._lineSpacing}if(r.h.TEXT_SHOW_BASELINE){t.strokeStyle=g,t.setLineDash([2,2]),t.lineWidth=1;let e=s+o;for(let n=0;n<this._lines.length;++n)this._drawLine(t,[i,e],[i+this.displayWidth,e]),e+=this._lineSpacing}if(r.h.TEXT_SHOW_BORDER&&(t.strokeStyle=g,t.setLineDash([]),t.lineWidth=1,this._drawBox(t,[i,s],[this.displayWidth,this.displayHeight])),this._hasBackground){const e=this._parameters.definition.background.borderRadius*this.renderPixelRatio;this._roundedRect(t,i,s,e),t.globalCompositeOperation="destination-over",t.fillStyle=this._parameters.backgroundStyle,t.fill()}t.restore()}_renderLineDecoration(t,e,n,i,r=!1){if("none"===this._parameters.definition.font.decoration||0===i)return;const s=Math.max(this._parameters.definition.size/16,1);switch(this._parameters.definition.font.decoration){case"underline":n+=2*s;break;case"line-through":n-=.33*this._midLineAscent}const a=r?this._haloSize:0;t.strokeStyle=r?this._parameters.haloStyle:this._parameters.textStyle,t.lineWidth=this._toRenderUnit(s+2*a),t.beginPath(),t.moveTo(this._toRenderUnit(e-a),this._toRenderUnit(n)),t.lineTo(this._toRenderUnit(e+i+a),this._toRenderUnit(n)),t.stroke()}_roundedRect(t,e,n,r){e=this._toRenderUnit(e),n=this._toRenderUnit(n);const s=this.renderedWidth,a=this.renderedHeight;0!==r?(r=(0,i.uZ)(r,0,Math.floor(a/2)),t.beginPath(),t.moveTo(e,n+r),t.arcTo(e,n,e+r,n,r),t.lineTo(e+s-r,n),t.arcTo(e+s,n,e+s,n+r,r),t.lineTo(e+s,n+a-r),t.arcTo(e+s,n+a,e+s-r,n+a,r),t.lineTo(e+r,n+a),t.arcTo(e,n+a,e,n+a-r,r),t.closePath()):t.rect(e,n,s,a)}_renderHalo(t,e,n,i,r){const s=this.renderedWidth,o=this.renderedHeight,h=(0,a.G)(d,Math.max(s,_),Math.max(o,_)),l=h.getContext("2d");l.clearRect(0,0,s,o),this._parameters.setFontProperties(l,this._renderedFontSize),l.fillStyle=this._parameters.haloStyle,l.strokeStyle=this._parameters.haloStyle;const c=this._renderedHaloSize<3;l.lineJoin=c?"miter":"round",c?this._renderHaloEmulated(l,i,r):this._renderHaloNative(l,i,r);let u=r;for(let t=0;t<this._lines.length;++t){const e=this._getLineXOffset(t);this._renderLineDecoration(l,i+e,u,this._textWidths[t],!0),u+=this._lineSpacing}t.globalAlpha=this._parameters.definition.halo.color[3],t.drawImage(h,0,0,s,o,this._toRenderUnit(e),this._toRenderUnit(n),s,o),t.globalAlpha=1}_renderHaloEmulated(t,e,n){for(let i=0;i<this._lines.length;++i){const r=this._lines[i],s=this._getLineXOffset(i);for(const[i,a]of l)this._fillText(t,r,e+s+this._haloSize*i,n+this._haloSize*a);n+=this._lineSpacing}}_renderHaloNative(t,e,n){const i=2*this._haloSize;for(let r=0;r<this._lines.length;++r){const s=this._lines[r],a=this._getLineXOffset(r),o=5,h=.1;for(let r=0;r<o;r++){const l=1-(o-1)*h+r*h;t.lineWidth=this._toRenderUnit(l*i),this._strokeText(t,s,e+a,n)}n+=this._lineSpacing}}get _displayWidth(){return this._metrics.displayWidth}_toRenderUnit(t){return t*this.renderPixelRatio}_toRoundedRenderUnit(t){return Math.round(t*this.renderPixelRatio)}_fillText(t,e,n,i){t.fillText(e,this._toRenderUnit(n),this._toRenderUnit(i))}_strokeText(t,e,n,i){t.strokeText(e,this._toRenderUnit(n),this._toRenderUnit(i))}_drawLine(t,e,n){t.beginPath(),t.moveTo(this._toRoundedRenderUnit(e[0])+.5,this._toRoundedRenderUnit(e[1])+.5),t.lineTo(this._toRoundedRenderUnit(n[0])+.5,this._toRoundedRenderUnit(n[1])+.5),t.stroke()}_drawBox(t,e,n){const i=this._toRenderUnit(e[0]),r=this._toRenderUnit(e[1]),s=this._toRenderUnit(n[0]),a=this._toRenderUnit(n[1]),o=Math.floor(i)+.5,h=Math.ceil(i+s)-.5,l=Math.floor(r)+.5,c=Math.ceil(r+a)-.5;t.beginPath(),t.moveTo(o,l),t.lineTo(h,l),t.lineTo(h,c),t.lineTo(o,c),t.lineTo(o,l),t.stroke()}}const l=[];{const t=16;for(let e=0;e<360;e+=360/t)l.push([Math.cos(Math.PI*e/180),Math.sin(Math.PI*e/180)])}var c,u;(u=c||(c={}))[u.Left=0]="Left",u[u.Center=1]="Center",u[u.Right=2]="Right";const d={canvas:null},f=.2,_=512,g="rgb(255, 0, 255, 0.5)";class m{get firstLineHeight(){return this.firstLineAscent+this.maxLineDescent}get midLineHeight(){return this.maxLineAscent+this.maxLineDescent}get lastLineHeight(){return this.maxLineAscent+this.lastLineDescent}constructor(t,e,n,i,r){this.firstLineAscent=t,this.lastLineDescent=e,this.maxLineAscent=n,this.maxLineDescent=i,this.displayWidth=r}}},4664:function(t,e,n){n.d(e,{U:function(){return w}});var i=n(73440),r=n(70880),s=n(87833),a=(n(61432),n(61100)),o=n(67908),h=n(17155),l=(n(96711),n(83850),n(48023)),c=n(73749),u=n(27583),d=n(21243),f=n(51440),_=n(50399),g=n(78891),m=n(65650),p=n(8158),y=n(35928);const x=4096;let w=class extends r.Z{constructor(t){super(t),this.id=(0,o.D)(),this.events=new s.Z,this._glTexture=null,this._atlas=new T(256,256),this._needsRepack=!1,this._canRepack=!0,this._elementsToRender=new Map,this._elements=new Map,this._uvCallbacks=new Map,this.updating=!1}initialize(){this._canvas=document.createElement("canvas"),this._canvas.setAttribute("id","textAtlasCanvas"),this._canvas.setAttribute("style","display:none"),this._ctx=this._canvas.getContext("2d"),this._stage=this.view.stage,this._stage.addTexture(this),this._updateCanvasElementSize(this._atlas),this._reset()}unload(){this._glTexture=(0,a.M2)(this._glTexture),this._frameWorker=(0,a.hw)(this._frameWorker),this.updating=!1,this.events.emit("unloaded")}get loaded(){return null!=this._glTexture}get glTexture(){return this._glTexture}static get maxSize(){return k=d.y.stableRendering?v:0,[x-v-k,x-v-k-b]}load(t){if(this._glTexture)return this._glTexture;const e=new y.X;return e.wrapMode=m.e8.CLAMP_TO_EDGE,e.samplingMode=m.cw.LINEAR_MIPMAP_LINEAR,e.hasMipmap=!0,e.preMultiplyAlpha=!0,e.maxAnisotropy=t.parameters.maxMaxAnisotropy,this._glTexture=new p.x(t,e,this._canvas),this._frameWorker=this.view.resourceController.scheduler.registerTask(_.T8.TEXT_TEXTURE_ATLAS,this),this.setDirty(),this._glTexture}dispose(){this._elements.clear(),this._elementsToRender.clear(),this._frameWorker=(0,a.hw)(this._frameWorker),this._glTexture&&(this._stage.removeTexture(this),this._glTexture=(0,a.M2)(this._glTexture)),this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._ctx=null}_updateCanvasElementSize(t){this._canvas.width=t.width,this._canvas.height=t.height}_resizeAtlas(t,e){const{width:n,height:i}=this._atlas;n===t&&i===e||(this._atlas.width=t,this._atlas.height=e,this._glTexture?.resize(t,e),this._glTexture?.updateData(0,0,0,n,i,this._canvas),this._updateCanvasElementSize(this._atlas),this._elements.forEach((t=>this._uvCallbacks.get(t.textRenderer.key)?.forEach((e=>e(t.uv))))),this._reset())}_reset(){this._elementsToRender.clear(),this._atlas.reset(),this._needsRepack=!0,this.setDirty()}_addAtlasElement(t,e,n,i){const r=this._atlas;if(r.width<n||r.height<i)return!1;let s=r.cursors.get(i);if(!s){if(r.height<r.nextY+i)return!1;s=[new S(r.nextY)],r.cursors.set(i,s),r.nextY+=i}let a=s.find((t=>r.width>=t.x+n));if(null==a){if(r.height<r.nextY+i)return!1;a=new S(r.nextY),r.nextY+=i,s.push(a)}return t.setNewPosition(a),this._elements.set(e,t),this._elementsToRender.set(e,t),a.x+=n,!0}_ensureCallbacks(t){const e=this._uvCallbacks.get(t);if(e)return e;const n=new Set;return this._uvCallbacks.set(t,n),n}_addCallback(t,e){this._ensureCallbacks(t).add(e)}_removeCallback(t,e){const n=this._uvCallbacks.get(t);return!(!n?.delete(e)||0!==n.size||(this._uvCallbacks.delete(t),0))}_processAddition(t){const e=t.textRenderer.key;if(this._needsRepack)return void this._elements.set(e,t);const n=this._atlas,i=t.textRenderer.renderedWidth,r=t.textRenderer.renderedHeight,s=i+v,a=r+v+b;if(!this._addAtlasElement(t,e,s,a)){if(this._canRepack)this._reset();else if(n.width<s){const t=(0,f.gu)(Math.max(s,1.5*n.width),x);this._resizeAtlas(t,n.height)}else{const t=n.nextY+a,e=(0,f.gu)(Math.max(t,1.5*n.height),x);if(e>n.height)this._resizeAtlas(n.width,e);else if(n.width<x){const t=(0,f.gu)(1.5*n.width,x);this._resizeAtlas(t,n.height)}}this._elements.set(e,t)}}_renderElement(t){const e=t.commitNewPosition(),n=t.textRenderer;this._ctx.clearRect(e[0]-v,e[1]-v,n.renderedWidth+2*v,n.renderedHeight+2*v),n.render(this._ctx,e[0],e[1]),this._uvCallbacks.get(n.key)?.forEach((e=>e(t.uv)))}get running(){return this.updating}runTask(t){if(null==this._glTexture)return g.J;for(;this._needsRepack&&(this._canRepack||this._atlas.height<x&&this._atlas.height<x);){this._canRepack=this._needsRepack=!1;const e=this._elements;this._elements=new Map,e.forEach((t=>this._processAddition(t))),t.madeProgress()}if(this._elementsToRender.size>0){for(const[e,n]of this._elementsToRender){if(t.done)break;this._renderElement(n),this._elementsToRender.delete(e),t.madeProgress()}this._glTexture.setData(this._canvas)}this.updating=this._elementsToRender.size>0}addText(t,e){const n=t.key;this._addCallback(n,e);let i=this._elements.get(n);return i?(0,c.a)(i.uv,u.AG)||e(i.uv):(i=new R(t),this._processAddition(i),this.setDirty()),{remove:()=>this._removeText(t,e)}}_removeText(t,e){const n=t.key;this._elements.get(n)&&this._removeCallback(n,e)&&(this._elements.delete(n),this._elementsToRender.delete(n),this._canRepack=!0)}setDirty(){this._glTexture&&(this.updating=!0)}get test(){}};(0,i._)([(0,h.Cb)({constructOnly:!0})],w.prototype,"view",void 0),(0,i._)([(0,h.Cb)({type:Boolean})],w.prototype,"updating",void 0),w=(0,i._)([(0,l.j)("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],w);const v=2,b=2;class R{constructor(t){this.textRenderer=t,this._uv=(0,u.Ue)(),this._newPosition=[0,0]}get uv(){if(null==this._xOffset||null==this._yOffset)return u.AG;const{renderedWidth:t,renderedHeight:e}=this.textRenderer;return(0,c.s)(this._uv,this._xOffset,this._yOffset+e,this._xOffset+t,this._yOffset)}setNewPosition(t){this._newPosition[0]=t.x,this._newPosition[1]=t.y}commitNewPosition(){return this._xOffset=this._newPosition[0],this._yOffset=this._newPosition[1],this._newPosition}get xOffset(){return this._xOffset}get yOffset(){return this._yOffset}}class T{constructor(t,e){this.width=t,this.height=e,this.cursors=new Map,this.nextY=0}reset(){this.cursors.clear(),this.nextY=k}}class S{constructor(t){this.y=t,this.x=k}}let k=0}}]);