"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[65234,93762,22679],{3859:function(e,t,i){i.d(t,{Z:function(){return C}});var r=i(88153),s=i(44194),n=i(51865),a=i.n(n),o=i(54570),l=i(26402),c=i(14845),h=i(45802),u=i(35540);var d=i(10253),p=function(e,t){var i={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(r=Object.getOwnPropertySymbols(e);s<r.length;s++)t.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(e,r[s])&&(i[r[s]]=e[r[s]])}return i};function m(e){let{suffixCls:t,tagName:i,displayName:r}=e;return e=>s.forwardRef(((r,n)=>s.createElement(e,Object.assign({ref:n,suffixCls:t,tagName:i},r))))}const _=s.forwardRef(((e,t)=>{const{prefixCls:i,suffixCls:r,className:n,tagName:o}=e,c=p(e,["prefixCls","suffixCls","className","tagName"]),{getPrefixCls:h}=s.useContext(l.E_),u=h("layout",i),[m,_,f]=(0,d.ZP)(u),g=r?`${u}-${r}`:u;return m(s.createElement(o,Object.assign({className:a()(i||g,n,_,f),ref:t},c)))})),f=s.forwardRef(((e,t)=>{const{direction:i}=s.useContext(l.E_),[n,m]=s.useState([]),{prefixCls:_,className:f,rootClassName:g,children:y,hasSider:v,tagName:b,style:w}=e,C=p(e,["prefixCls","className","rootClassName","children","hasSider","tagName","style"]),x=(0,o.Z)(C,["suffixCls"]),{getPrefixCls:T,className:S,style:M}=(0,l.dj)("layout"),E=T("layout",_),R=function(e,t,i){return"boolean"==typeof i?i:!!e.length||(0,h.Z)(t).some((e=>e.type===u.Z))}(n,y,v),[P,A,O]=(0,d.ZP)(E),D=a()(E,{[`${E}-has-sider`]:R,[`${E}-rtl`]:"rtl"===i},S,f,g,A,O),I=s.useMemo((()=>({siderHook:{addSider:e=>{m((t=>[].concat((0,r.Z)(t),[e])))},removeSider:e=>{m((t=>t.filter((t=>t!==e))))}}})),[]);return P(s.createElement(c.V.Provider,{value:I},s.createElement(b,Object.assign({ref:t,className:D,style:Object.assign(Object.assign({},M),w)},x),y)))})),g=m({tagName:"div",displayName:"Layout"})(f),y=m({suffixCls:"header",tagName:"header",displayName:"Header"})(_),v=m({suffixCls:"footer",tagName:"footer",displayName:"Footer"})(_),b=m({suffixCls:"content",tagName:"main",displayName:"Content"})(_);const w=g;w.Header=y,w.Footer=v,w.Content=b,w.Sider=u.Z,w._InternalSiderContext=u.D;var C=w},93762:function(e,t,i){i.r(t),i.d(t,{default:function(){return L}});var r=i(73440),s=i(81001),n=i(78619),a=i(43254),o=i(41145),l=i(63255),c=i(28947),h=i(97006),u=i(332),d=i(96711),p=i(61100),m=i(93568),_=i(95490),f=i(17155),g=(i(61432),i(48023)),y=i(29884),v=i(45213),b=i(77601),w=i(96193),C=i(26334),x=(i(55214),i(70880)),T=(i(83850),i(74765)),S=i(12816);let M=class extends x.Z{constructor(e){super(e),this.apiKey=null,this.id=null,this.language=null,this.places=null,this.serviceUrl="https://basemapstyles-api.arcgis.com/arcgis/rest/services/styles/v2",this.worldview=null}get languageParameter(){const e=this.language;let t="local"===e||"global"===e?e:(0,S.Su)(e??(0,T.Kd)())??"global";return t="no"===t?"nb":t,t}};(0,r._)([(0,f.Cb)()],M.prototype,"apiKey",void 0),(0,r._)([(0,f.Cb)()],M.prototype,"id",void 0),(0,r._)([(0,f.Cb)()],M.prototype,"language",void 0),(0,r._)([(0,f.Cb)()],M.prototype,"places",void 0),(0,r._)([(0,f.Cb)()],M.prototype,"serviceUrl",void 0),(0,r._)([(0,f.Cb)()],M.prototype,"worldview",void 0),M=(0,r._)([(0,g.j)("esri.support.BasemapStyle")],M);const E=M;var R,P=i(49675);let A=0,O=R=class extends(l.Z.JSONSupportMixin(h.Z)){constructor(e){super(e),this.id=null,this.portalItem=null,this.spatialReference=null,this.style=null,this.thumbnailUrl=null,this.title="Basemap",this.id=Date.now().toString(16)+"-basemap-"+A++,this.baseLayers=new a.Z,this.referenceLayers=new a.Z;const t=e=>{e.parent&&e.parent!==this&&"remove"in e.parent&&e.parent.remove(e),e.parent=this,"elevation"===e.type&&d.Z.getLogger(this).error(`Layer '${e.title}, id:${e.id}' of type '${e.type}' is not supported as a basemap layer and will therefore be ignored.`)},i=e=>{e.parent=null};this.addHandles([this.baseLayers.on("after-add",(e=>t(e.item))),this.referenceLayers.on("after-add",(e=>t(e.item))),this.baseLayers.on("after-remove",(e=>i(e.item))),this.referenceLayers.on("after-remove",(e=>i(e.item)))])}initialize(){this.when().catch((e=>{d.Z.getLogger(this).error("#load()",`Failed to load basemap (title: '${this.title}', id: '${this.id}')`,e)})),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)}destroy(){const e=this.baseLayers.toArray();for(const t of e)t.destroy();const t=this.referenceLayers.toArray();for(const e of t)e.destroy();this.baseLayers.destroy(),this.referenceLayers.destroy(),this.portalItem=(0,p.SC)(this.portalItem)}normalizeCtorArgs(e){return e&&"resourceInfo"in e&&(this._set("resourceInfo",e.resourceInfo),delete(e={...e}).resourceInfo),e}set baseLayers(e){this._set("baseLayers",(0,o.Z)(e,this._get("baseLayers")))}_writeBaseLayers(e,t,i){const r=[];e?(i={...i,layerContainerType:"basemap"},this.baseLayers.forEach((e=>{const t=(0,P.Nw)(e,i.webmap?i.webmap.getLayerJSONFromResourceInfo(e):null,i);null!=t&&r.push(t)})),this.referenceLayers.forEach((e=>{const t=(0,P.Nw)(e,i.webmap?i.webmap.getLayerJSONFromResourceInfo(e):null,i);null!=t&&("scene"!==e.type&&(t.isReference=!0),r.push(t))})),t.baseMapLayers=r):t.baseMapLayers=r}set referenceLayers(e){this._set("referenceLayers",(0,o.Z)(e,this._get("referenceLayers")))}writeTitle(e,t){t.title=e||"Basemap"}load(e){return this.addResolvingPromise(this._loadFromSource(e)),Promise.resolve(this)}loadAll(){return(0,u.G)(this,(e=>{e(this.baseLayers,this.referenceLayers)}))}clone(){const e={id:this.id,title:this.title,portalItem:this.portalItem,baseLayers:this.baseLayers.map((e=>(0,c.tZ)(e)?e.clone():e)),referenceLayers:this.referenceLayers.map((e=>(0,c.tZ)(e)?e.clone():e))};return this.loaded&&(e.loadStatus="loaded"),new R({resourceInfo:this.resourceInfo}).set(e)}read(e,t){this.resourceInfo||this._set("resourceInfo",{data:e,context:t}),super.read(e,t)}write(e,t){return e=e||{},t?.origin||(t={origin:"web-map",...t}),super.write(e,t),!this.loaded&&this.resourceInfo?.data.baseMapLayers&&(e.baseMapLayers=this.resourceInfo.data.baseMapLayers.map((e=>{const t=(0,c.d9)(e);return t.url&&(0,_.oC)(t.url)&&(t.url=`https:${t.url}`),t.templateUrl&&(0,_.oC)(t.templateUrl)&&(t.templateUrl=`https:${t.templateUrl}`),t}))),e}async _loadFromSource(e){const{resourceInfo:t,portalItem:i,style:r}=this;(0,m.k_)(e);const s=[];if(t){const i=t.context?t.context.url:null;if(s.push(this._loadLayersFromJSON(t.data,i,e)),t.data.id&&!t.data.title){const e=t.data.id;s.push((0,C.g)(e).then((e=>{e&&this.read({title:e},t.context)})))}}else i?s.push(this._loadFromItem(i,e)):r&&s.push(this._loadFromStylesService(r,e));await Promise.all(s)}async _loadLayersFromJSON(e,t,r){const s=this.resourceInfo?.context,n=this.portalItem?.portal||s?.portal||null,a=I[s?.origin||""]??"web-map",{populateOperationalLayers:o}=await i.e(13259).then(i.bind(i,13259)),l=[];if((0,m.k_)(r),e.baseMapLayers&&Array.isArray(e.baseMapLayers)){const i={context:{...s,origin:a,url:t,portal:n,layerContainerType:"basemap"},defaultLayerType:"DefaultTileLayer"},r=e=>"web-scene"===a&&"ArcGISSceneServiceLayer"===e.layerType||e.isReference,c=o(this.baseLayers,e.baseMapLayers.filter((e=>!r(e))),i);l.push(c);const h=o(this.referenceLayers,e.baseMapLayers.filter(r),i);l.push(h)}await Promise.allSettled(l)}async _loadFromItem(e,t){const i=await e.load(t),r=await i.fetchData("json",t),s=(0,_.mN)(e.itemUrl??"");return this._set("resourceInfo",{data:r.baseMap??{},context:{origin:D[e.type||""]??"web-map",portal:e.portal||b.Z.getDefault(),url:s}}),this.read(this.resourceInfo.data,this.resourceInfo.context),this.read({spatialReference:r.spatialReference},this.resourceInfo.context),this.read({title:e.title,thumbnailUrl:e.thumbnailUrl},{origin:"portal-item",portal:e.portal||b.Z.getDefault(),url:s}),this._loadLayersFromJSON(this.resourceInfo.data,s,t)}async _loadFromStylesService(e,t){const i=e.serviceUrl.endsWith("/webmaps")?e.serviceUrl.slice(0,-8):e.serviceUrl,r=`${i}/styles/${e.id}/self`,a=`${i}/webmaps/${e.id}`,o=e.apiKey??s.default.apiKeys.basemapStyles,[l,c]=await Promise.all([(await(0,n.Z)(r,{query:{token:o},signal:t?.signal})).data,(await(0,n.Z)(a,{query:{language:e.languageParameter,places:e.places,worldview:e.worldview,token:o},signal:t?.signal})).data]);this.thumbnailUrl??=l.thumbnailUrl;const h=(0,_.mN)(a);if(this._set("resourceInfo",{data:c.baseMap??{},context:{origin:"web-map",url:h}}),this.read(this.resourceInfo.data,this.resourceInfo.context),this.read({spatialReference:c.spatialReference},this.resourceInfo.context),await this._loadLayersFromJSON(this.resourceInfo.data,h,t),o)for(const e of[...this.baseLayers,...this.referenceLayers])"apiKey"in e&&(e.apiKey=o)}static fromId(e){const t=C.s[e];return t?t.itemId?new R({portalItem:{id:t.itemId,portal:{url:"https://www.arcgis.com"}}}):R.fromJSON(t,t.is3d?{origin:"web-scene",portal:new b.Z({url:"https://www.arcgis.com"})}:{origin:"web-map"}):null}};(0,r._)([(0,f.Cb)({json:{write:{ignoreOrigin:!0,target:"baseMapLayers",writer(e,t,i,r){this._writeBaseLayers(e,t,r)}},origins:{"web-scene":{write:{ignoreOrigin:!0,target:{baseMapLayers:{type:a.Z}},writer(e,t,i,r){this._writeBaseLayers(e,t,r)}}}}}})],O.prototype,"baseLayers",null),(0,r._)([(0,f.Cb)({type:String,json:{origins:{"web-scene":{write:!0}}}})],O.prototype,"id",void 0),(0,r._)([(0,f.Cb)({type:w.default})],O.prototype,"portalItem",void 0),(0,r._)([(0,f.Cb)()],O.prototype,"referenceLayers",null),(0,r._)([(0,f.Cb)({readOnly:!0})],O.prototype,"resourceInfo",void 0),(0,r._)([(0,f.Cb)({type:v.Z})],O.prototype,"spatialReference",void 0),(0,r._)([(0,f.Cb)({type:E})],O.prototype,"style",void 0),(0,r._)([(0,f.Cb)()],O.prototype,"thumbnailUrl",void 0),(0,r._)([(0,f.Cb)({type:String,json:{origins:{"web-scene":{write:{isRequired:!0}}}}})],O.prototype,"title",void 0),(0,r._)([(0,y.c)("title")],O.prototype,"writeTitle",null),O=R=(0,r._)([(0,g.j)("esri.Basemap")],O);const D={"Web Scene":"web-scene","Web Map":"web-map","Link Chart":"link-chart"},I={"web-scene":"web-scene","web-map":"web-map","link-chart":"link-chart"},L=O},41309:function(e,t,i){i.d(t,{Z:function(){return y}});var r=i(73440),s=i(89314),n=i(17155),a=(i(61432),i(96711),i(83850),i(48023));let o=class extends s.Z{constructor(e){super(e),this.row=0,this.column=0,this.rows=1,this.columns=1}equals(e){return null!=e&&this.row===e.row&&this.rows===e.rows&&this.column===e.column&&this.columns===e.columns}};(0,r._)([(0,n.Cb)({type:Number,nonNullable:!0,json:{read:!1,write:!1}})],o.prototype,"row",void 0),(0,r._)([(0,n.Cb)({type:Number,nonNullable:!0,json:{read:!1,write:!1}})],o.prototype,"column",void 0),(0,r._)([(0,n.Cb)({type:Number,nonNullable:!0,json:{read:!1,write:!1}})],o.prototype,"rows",void 0),(0,r._)([(0,n.Cb)({type:Number,nonNullable:!0,json:{read:!1,write:!1}})],o.prototype,"columns",void 0),o=(0,r._)([(0,a.j)("esri.CameraLayout")],o);const l=o;var c=i(95437),h=i(63255),u=i(99574),d=i(90775),p=i(1194),m=i(29884),_=i(95226),f=i(60508);let g=class extends(s.Z.ClonableMixin(h.Z)){constructor(...e){super(...e),this.position=new f.Z([0,0,0]),this.heading=0,this.tilt=0,this.fov=55,this.layout=new l}normalizeCtorArgs(e,t,i,r){if(e&&"object"==typeof e&&("x"in e||Array.isArray(e))){const s={position:e};return null!=t&&(s.heading=t),null!=i&&(s.tilt=i),null!=r&&(s.fov=r),s}return e}writePosition(e,t,i,r){const s=e.clone();s.x=(0,_.q9)(e.x||0),s.y=(0,_.q9)(e.y||0),s.z=e.hasZ?(0,_.q9)(e.z||0):e.z,t[i]=s.write({},r)}readPosition(e,t){const i=new f.Z;return i.read(e,t),i.x=(0,_.q9)(i.x||0),i.y=(0,_.q9)(i.y||0),i.z=i.hasZ?(0,_.q9)(i.z||0):i.z,i}equals(e){return null!=e&&this.tilt===e.tilt&&this.heading===e.heading&&this.fov===e.fov&&this.position.equals(e.position)&&this.layout.equals(e.layout)}};(0,r._)([(0,n.Cb)({type:f.Z,json:{write:{isRequired:!0}}})],g.prototype,"position",void 0),(0,r._)([(0,m.c)("position")],g.prototype,"writePosition",null),(0,r._)([(0,p.r)("position")],g.prototype,"readPosition",null),(0,r._)([(0,n.Cb)({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),(0,d.p)((e=>c.BV.normalize((0,_.q9)(e))))],g.prototype,"heading",void 0),(0,r._)([(0,n.Cb)({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),(0,d.p)((e=>(0,u.uZ)((0,_.q9)(e),-180,180)))],g.prototype,"tilt",void 0),(0,r._)([(0,n.Cb)({type:Number,nonNullable:!0,json:{default:55,write:!0}}),(0,d.p)((e=>(0,u.uZ)((0,_.q9)(e,55),1,170)))],g.prototype,"fov",void 0),(0,r._)([(0,n.Cb)({type:l,nonNullable:!0,json:{read:!1,write:!1}})],g.prototype,"layout",void 0),g=(0,r._)([(0,a.j)("esri.Camera")],g);const y=g},27172:function(e,t,i){i.d(t,{Z:function(){return p}});var r,s=i(73440),n=i(41309),a=i(63255),o=i(17155),l=i(90775),c=(i(61432),i(83850),i(48023)),h=i(90756),u=i(98842);let d=r=class extends a.Z{constructor(e){super(e),this.rotation=0,this.scale=0,this.targetGeometry=null,this.camera=null}castRotation(e){return(e%=360)<0&&(e+=360),e}clone(){return new r({rotation:this.rotation,scale:this.scale,targetGeometry:null!=this.targetGeometry?this.targetGeometry.clone():null,camera:null!=this.camera?this.camera.clone():null})}};(0,s._)([(0,o.Cb)({type:Number,json:{write:!0,origins:{"web-map":{default:0,write:!0},"web-scene":{write:{overridePolicy:m}}}}})],d.prototype,"rotation",void 0),(0,s._)([(0,l.p)("rotation")],d.prototype,"castRotation",null),(0,s._)([(0,o.Cb)({type:Number,json:{write:!0,origins:{"web-map":{default:0,write:!0},"web-scene":{write:{overridePolicy:m}}}}})],d.prototype,"scale",void 0),(0,s._)([(0,o.Cb)({types:u.qM,json:{read:h.im,write:!0,origins:{"web-scene":{read:h.im,write:{overridePolicy:m}}}}})],d.prototype,"targetGeometry",void 0),(0,s._)([(0,o.Cb)({type:n.Z,json:{write:!0,origins:{"web-scene":{write:{isRequired:!0}}}}})],d.prototype,"camera",void 0),d=r=(0,s._)([(0,c.j)("esri.Viewpoint")],d);const p=d;function m(){return{enabled:!this.camera}}},7332:function(e,t,i){i.d(t,{A:function(){return c},a:function(){return u},b:function(){return h}});var r=i(17904),s=i(48857),n=i(71063),a=i(34709),o=i(74826),l=i(15150);class c extends o.K{}function h(){const e=new l.kG;return e.include(r.k),e.fragment.uniforms.add(new a.A("colorTexture",(e=>e.color)),new n.e("depthTexture",(e=>e.mainDepth))),e.fragment.main.add(s.H`float depthSample = texture(depthTexture, uv).r;
if (depthSample != 1.0 ) {
fragColor = vec4(0);
return;
}
fragColor = texture(colorTexture, uv);`),e}const u=Object.freeze(Object.defineProperty({__proto__:null,AtmosphereCompositingPassParameters:c,build:h},Symbol.toStringTag,{value:"Module"}))},91102:function(e,t,i){i.d(t,{B:function(){return m},a:function(){return r},b:function(){return p}});var r,s=i(56791),n=i(82214),a=i(99563),o=i(58226),l=i(9535),c=i(85119),h=i(48857),u=i(34709),d=i(15150);function p(e){const t=new d.kG,i=t.fragment;if(t.include(o.T),e.background===r.Only){const r=e.output===n.l.ColorComposite;return r?i.uniforms.add(new l.J("backgroundColor",(e=>e.backgroundColor))):i.include(s.H),i.main.add(h.H`fragColor = vec4(${r?h.H`backgroundColor`:h.H`gridColor(uv)`}, 1.0);`),t}return t.include(a.J,e),i.uniforms.add(new u.A("tex",(e=>e.texture)),new c.p("opacity",(e=>e.opacity))),i.main.add(h.H`fragColor = blendLayers(uv, texture(tex, uv), opacity);`),t}!function(e){e[e.BelowLayer=0]="BelowLayer",e[e.Only=1]="Only",e[e.COUNT=2]="COUNT"}(r||(r={}));const m=Object.freeze(Object.defineProperty({__proto__:null,get BackgroundMode(){return r},build:p},Symbol.toStringTag,{value:"Module"}))},5918:function(e,t,i){i.d(t,{B:function(){return l},b:function(){return o}});var r=i(17904),s=i(48857),n=i(34709),a=i(15150);function o(){const e=new a.kG;e.include(r.k),e.fragment.uniforms.add(new n.A("edgesTexture",(e=>e.inputTexture)),new n.A("areaTexture",(e=>e.areaTexture)),new n.A("searchTexture",(e=>e.searchTexture))),e.fragment.constants.add("smaaAreaTexPixelSize","vec2",[1/160,1/560]);return e.fragment.code.add(s.H`
    vec4 sampleLevelZeroOffset(vec2 coord, vec2 offset, vec2 resolution) {
      return texture(edgesTexture, coord + offset.x * resolution);
    }

    float searchLength(vec2 e, float bias, float scale) {
      e.r = bias + e.r * scale;
      return 255.0 * texture(searchTexture, e).r;
    }

    float searchLeft(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(0.0, 1.0);
      for (int i = 0; i < ${s.H.int(8)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord -= vec2(2.0, 0.0) * resolution;
        if (! (texcoord.x > end && e.g > 0.8281 && e.r == 0.0)) break;
      }
      texcoord.x += 0.25 * resolution.x;
      texcoord.x += resolution.x;
      texcoord.x += 2.0 * resolution.x;
      texcoord.x -= resolution.x * searchLength(e, 0.0, 0.5);
      return texcoord.x;
    }

    float searchRight(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(0.0, 1.0);
      for (int i = 0; i < ${s.H.int(8)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord += vec2(2.0, 0.0) * resolution;
        if (! (texcoord.x < end && e.g > 0.8281 && e.r == 0.0)) break;
      }
      texcoord.x -= 0.25 * resolution.x;
      texcoord.x -= resolution.x;
      texcoord.x -= 2.0 * resolution.x;
      texcoord.x += resolution.x * searchLength(e, 0.5, 0.5);
      return texcoord.x;
    }

    float searchUp(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(1.0, 0.0);
      for (int i = 0; i < ${s.H.int(8)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord += vec2(0.0, 2.0) * resolution;
        if (! (texcoord.y > end && e.r > 0.8281 && e.g == 0.0)) break;
      }
      texcoord.y -= 0.25 * resolution.y;
      texcoord.y -= resolution.y;
      texcoord.y -= 2.0 * resolution.y;
      texcoord.y += resolution.y * searchLength(e.gr, 0.0, 0.5);
      return texcoord.y;
    }

    float searchDown(vec2 texcoord, float end, vec2 resolution) {
      vec2 e = vec2(1.0, 0.0);
      for (int i = 0; i < ${s.H.int(8)}; ++i) {
        e = texture(edgesTexture, texcoord).rg;
        texcoord -= vec2(0.0, 2.0) * resolution;
        if (! (texcoord.y < end && e.r > 0.8281 && e.g == 0.0)) break;
      }
      texcoord.y += 0.25 * resolution.y;
      texcoord.y += resolution.y;
      texcoord.y += 2.0 * resolution.y;
      texcoord.y -= resolution.y * searchLength(e.gr, 0.5, 0.5);
      return texcoord.y;
    }

    vec2 getArea(sampler2D areaTex, vec2 dist, float e1, float e2, float offset) {
      vec2 texcoord = float(${s.H.int(16)}) * round(4.0 * vec2(e1, e2)) + dist;
      texcoord = smaaAreaTexPixelSize * texcoord + (0.5 * smaaAreaTexPixelSize);
      texcoord.y += ${s.H.float(1/7)} * offset;
      return texture(areaTex, texcoord).rg;
    }`),e.fragment.main.add(s.H`
    vec2 size = vec2(textureSize(edgesTexture, 0));
    vec2 resolution = 1.0 / size;
    vec2 pixelCoord = uv * size;
    vec4 offsets[2];
    offsets[0] = uv.xyxy + resolution.xyxy * vec4(-0.25, 0.125, 1.25, 0.125);
    offsets[1] = uv.xyxy + resolution.xyxy * vec4(-0.125, 0.25, -0.125, -1.25);
    vec4 maxOffset = vec4(offsets[0].xz, offsets[1].yw) + vec4(-2.0, 2.0, -2.0, 2.0) * resolution.xxyy * float(${s.H.int(8)});
    ivec4 subsampleIndices = ivec4(0.0);
    vec4 weights = vec4(0.0);
    vec2 e = texture(edgesTexture, uv).rg;
    if (e.r > 0.0) {
      vec2 d;
      vec2 coords;
      coords.y = searchUp(offsets[1].xy, maxOffset.z, resolution);
      coords.x = offsets[0].x;
      d.x = coords.y;
      float e1 = texture(edgesTexture, coords).g;
      coords.y = searchDown(offsets[1].zw, maxOffset.w, resolution);
      d.y = coords.y;
      d = d * size.y - pixelCoord.y;
      vec2 sqrt_d = sqrt(abs(d));
      coords.y -= 1.0 * resolution.y;
      float e2 = sampleLevelZeroOffset(coords, vec2(0.0, 1.0), resolution).g;
      weights.ba = getArea(areaTexture, sqrt_d, e1, e2, float(subsampleIndices.x));
      // for some reason the following lines are necessary to prevent
      // texture lookup precision issues on some Intel integrated graphics chips
      vec4 dbg = (offsets[0] + offsets[1] + maxOffset + coords.xyyx);
      weights.r += 0.00000001 * dot(vec4(0, 1, 0, 1), dbg);
    }
    if (e.g > 0.0) {
      vec2 d;
      vec2 coords;
      coords.x = searchLeft(offsets[0].xy, maxOffset.x, resolution);
      coords.y = offsets[1].y;
      d.x = coords.x;
      float e1 = texture(edgesTexture, coords).r;
      coords.x = searchRight(offsets[0].zw, maxOffset.y, resolution);
      d.y = coords.x;
      d = d * size.x - pixelCoord.x;
      vec2 sqrt_d = sqrt(abs(d));
      coords.y -= 1.0 * resolution.y;
      float e2 = sampleLevelZeroOffset(coords, vec2(1.0, 0.0), resolution).r;
      weights.rg = getArea(areaTexture, sqrt_d, e1, e2, float(subsampleIndices.y));
    }
    fragColor = weights;
  `),e}const l=Object.freeze(Object.defineProperty({__proto__:null,build:o},Symbol.toStringTag,{value:"Module"}))},666:function(e,t,i){i.d(t,{B:function(){return p},a:function(){return r},b:function(){return _},c:function(){return m}});var r,s=i(99574),n=i(17904),a=i(40212),o=i(85119),l=i(48857),c=i(34709),h=i(40673),u=i(74826),d=i(15150);!function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.COUNT=2]="COUNT"}(r||(r={}));class p extends u.K{constructor(){super(...arguments),this.blurRadius=h.L9.sunny}}function m(e){const t=new d.kG,i=t.fragment;t.include(n.k),i.include(a.D),i.uniforms.add(new c.A("colorTexture",(e=>e.color)),new o.p("blurRadius",(e=>e.blurRadius)));let h="";const u=15;for(let e=0;e<u;e++)h+=`locations1D[${e}] = ${(e/14*2-1).toFixed(3).toString()};`;let p="";for(let e=0;e<u;e++)p+=`locations1DWeights[${e}] = ${(0,s.j3)(e-Math.floor(7.5),2).toFixed(7).toString()};`;const m=e.bloomStage===r.Horizontal;return i.code.add(l.H`
    float locations1D[${l.H.int(u)}];
    float locations1DWeights[${l.H.int(u)}];

    vec4 blurUniformSamples(sampler2D toBlur) {
      vec4 res = vec4(0.0);
      vec2 size = vec2(textureSize(toBlur, 0));
      vec2 aspectCorrection = vec2(1.0, size.x / size.y);
      vec2 uvInPixel = uv * size;

      ${h}
      ${p}
      vec2 pixelCenterShift = 0.5 / size;

      for(int i=0;i < ${l.H.int(u)}; i++) {
        float uv1D = locations1D[i] + ${m?"pixelCenterShift.x":"pixelCenterShift.y"};
        vec2 uvOffset = ${m?"vec2(uv1D, 0.0)":"vec2(0.0, uv1D)"};

        vec2 uvDistorted = uv + uvOffset * blurRadius * aspectCorrection;
        vec4 sampleColor = texture(toBlur, uvDistorted);
        res += vec4(linearizeGamma(sampleColor.rgb), sampleColor.a)  * locations1DWeights[i];
      }
      res.a = clamp(res.a, 0.0, 1.0);
      return delinearizeGamma(res);
    }
  `).main.add(l.H`fragColor = blurUniformSamples(colorTexture);`),t}const _=Object.freeze(Object.defineProperty({__proto__:null,BloomBlurPassParameters:p,get BlurDirection(){return r},build:m},Symbol.toStringTag,{value:"Module"}))},60700:function(e,t,i){i.d(t,{B:function(){return g},a:function(){return v},b:function(){return y},d:function(){return f}});var r=i(17904),s=i(20638),n=i(40212),a=i(85119),o=i(39163),l=i(48857),c=i(20431),h=i(34709),u=i(40673),d=i(85797),p=i(74826),m=i(15150);class _ extends p.K{constructor(e=u.S7,t=u.Ml.sunny.far,i=u.Ml.sunny.near){super(),this.exposure=e,this.lodFactors=t,this.lodFactorsFront=i}}const f=new _;class g extends _{constructor(){super(...arguments),this.bloomLod=-1}}function y(){const e=new m.kG,t=e.fragment;return e.include(r.k),t.include(n.D),t.include(s.K),t.include(d.l),t.uniforms.add(new h.A("colorTexture",(e=>e.color)),new h.A("emissionTexture",(e=>e.emission)),new h.A("bloomTexture0",(e=>e.bloomTexture0)),new h.A("bloomTexture1",(e=>e.bloomTexture1)),new h.A("bloomTexture2",(e=>e.bloomTexture2)),new h.A("bloomTexture3",(e=>e.bloomTexture3)),new h.A("bloomTexture4",(e=>e.bloomTexture4)),new a.p("exposure",(e=>e.exposure)),new c._("bloomLod",(e=>e.bloomLod)),new o.O("lodFactors",(e=>e.lodFactors),5),new o.O("lodFactorsFront",(e=>e.lodFactorsFront),5)).main.add(l.H`vec4 color = texture(colorTexture, uv);
color = vec4(linearizeGamma(color.rgb), color.a);
vec4 lod0 = texture(bloomTexture0, uv);
lod0 = vec4(linearizeGamma(lod0.rgb), lod0.a);
vec4 lod1 = texture(bloomTexture1, uv);
lod1 = vec4(linearizeGamma(lod1.rgb), lod1.a);
vec4 lod2 = texture(bloomTexture2, uv);
lod2 = vec4(linearizeGamma(lod2.rgb), lod2.a);
vec4 lod3 = texture(bloomTexture3, uv);
lod3 = vec4(linearizeGamma(lod3.rgb), lod3.a);
vec4 lod4 = texture(bloomTexture4, uv);
lod4 = vec4(linearizeGamma(lod4.rgb), lod4.a);
vec4 blur = lodFactors[0] * lod0;
blur += lodFactors[1] * lod1;
blur += lodFactors[2] * lod2;
blur += lodFactors[3] * lod3;
blur += lodFactors[4] * lod4;
blur = bloomLod == 0 ? lodFactors[0] * lod0 : bloomLod == 1 ? lodFactors[1] * lod1 : bloomLod == 2 ? lodFactors[2] * lod2 : bloomLod == 3 ? lodFactors[3] * lod3 : bloomLod == 4 ? lodFactors[4] * lod4 : blur;
vec4 emission = texture(emissionTexture, uv);
emission = vec4(linearizeGamma(emission.rgb), emission.a);
emission += blur;
emission = vec4(tonemapACES(emission.rgb), emission.a);
fragColor = emission + color;
fragColor = delinearizeGamma(fragColor);`),e}const v=Object.freeze(Object.defineProperty({__proto__:null,BloomCompositionPassParameters:g,build:y,defaultCompositionParameters:f},Symbol.toStringTag,{value:"Module"}))},57088:function(e,t,i){i.d(t,{B:function(){return l},b:function(){return o}});var r=i(17904),s=i(48857),n=i(34709),a=i(15150);function o(){const e=new a.kG;return e.include(r.k),e.fragment.uniforms.add(new n.A("blendWeightsTexture",(e=>e.inputTexture)),new n.A("colorTexture",(e=>e.color))),e.fragment.main.add(s.H`vec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));
vec4 offsets = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);
vec4 a;
a.rb = texture(blendWeightsTexture, uv).rb;
a.g = texture(blendWeightsTexture, offsets.zw).g;
a.a = texture(blendWeightsTexture, offsets.xy).a;
if ( dot(a, vec4(1.0)) < 1e-5 ) {
fragColor = texture( colorTexture, uv, 0.0 );
} else {
vec2 offset;
offset.x = a.a > a.b ? a.a : -a.b;
offset.y = a.g > a.r ? -a.g : a.r;
if ( abs( offset.x ) > abs( offset.y )) {
offset.y = 0.0;
} else {
offset.x = 0.0;
}
vec4 C = texture( colorTexture, uv, 0.0 );
vec4 Cop = texture( colorTexture, uv + sign( offset ) * resolution.xy, 0.0 );
float s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );
fragColor = mix(C, Cop, s);
}`),e}const l=Object.freeze(Object.defineProperty({__proto__:null,build:o},Symbol.toStringTag,{value:"Module"}))},32667:function(e,t,i){i.d(t,{C:function(){return _},b:function(){return m}});var r=i(1824),s=i(40212),n=i(32179),a=i(9535),o=i(85119),l=i(48857),c=i(71063),h=i(4075),u=i(47975),d=i(85797),p=i(15150);function m(e){const t=new p.kG;t.include(h.X);const{reduced:i}=e,{fragment:m}=t;return(0,n.Pe)(m),m.include(s.D),m.include(u.l),m.include(d.l),m.include(r.t,!1),m.uniforms.add(new a.J("backgroundColor",(e=>e.backgroundColor)),new o.p("innerFadeDistance",(e=>e.innerFadeDistance)),new o.p("altitudeFade",(e=>e.altitudeFade)),new c.e("depthTexture",(e=>e.mainDepth))).code.add(l.H`vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {
float rayPlanetDistance = heightParameters[1] - radii[0] * radii[0];
vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, rayPlanetDistance);
if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {
return fragColor;
}
float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));
vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);
float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;
if (relDist > 1.0) {
return surfaceColor;
}
return mix(fragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));
}
float getGlow(float dist, float radius, float intensity) {
return pow(radius / max(dist, 1e-6), intensity);
}
vec3 getSun(vec3 cameraPos, vec3 rayDir, vec3 lightDir){
float scaleFract = (length(cameraPos) - radii[0]) / scaleHeight;
float sunOpticalDepth = getOpticalDepth(cameraPos, rayDir, max(scaleFract, 0.0));
vec3 sunTransmittance = exp(-(mix(betaCombined, betaRayleigh, 0.5)) * max(0.0, sunOpticalDepth));
float mu = clamp(dot(rayDir, lightDir), 0.0, 1.0);
float sunDisc = 256.0 * smoothstep(0.0, 128.0, clamp(getGlow(1.0 - mu, 3e-5, 3.0), 0.0, 128.0));
return normalize(sunTransmittance) * sunDisc;
}`).main.add(l.H`
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;
      ${(0,l.If)(!i,l.H`float depthSample = texture(depthTexture, uv).r;
             if (depthSample != 1.0) {
                fragColor = vec4(0);
                return;
             }`)}

      vec3 col = linearizeGamma(backgroundColor);
      col += raymarchAtmosphere(cameraPosition, rayDir, mainLightDirection, terrainDepth);
      col += getSun(cameraPosition, rayDir, mainLightDirection);
      float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));

      col = tonemapACES(col);
      fragColor = delinearizeGamma(vec4(col, alpha));
      fragColor = applyUndergroundAtmosphere(rayDir, mainLightDirection, fragColor);
  `),t}const _=Object.freeze(Object.defineProperty({__proto__:null,build:m},Symbol.toStringTag,{value:"Module"}))},55868:function(e,t,i){i.d(t,{C:function(){return b},a:function(){return T},b:function(){return C},c:function(){return w}});var r=i(61432),s=i(99574),n=i(30748),a=i(26821),o=i(41788),l=i(85382),c=i(23625),h=i(17904),u=i(54231),d=i(19155),p=i(85119),m=i(48857),_=i(57798),f=i(34709),g=i(47975),y=i(74826),v=i(15150);class b extends y.K{constructor(){super(...arguments),this.cloudRadius=0,this.cloudSize=0,this.detailSize=0,this.absorption=0,this.density=0,this.smoothness=0,this.cloudHeight=0,this.coverage=0,this.lastSlice=!1,this.viewMatrix=(0,n.Ue)()}}const w=(0,r.Z)("esri-mobile")?1024:2048;function C(e){const t=new v.kG;t.include(h.k,!1);const i=t.fragment;return i.include(g.l),i.uniforms.add(new p.p("cloudRadius",(e=>e.cloudRadius)),new p.p("power",(e=>(0,s.t7)(35,120,e.absorption))),new p.p("sigmaE",(e=>1+e.absorption)),new p.p("density",(e=>(0,s.t7)(0,.3,e.density))),new p.p("cloudSize",(e=>(0,s.t7)(0,.02,Math.max(.01,1-e.cloudSize)))),new p.p("detailSize",(e=>(0,s.t7)(0,.2,Math.max(.01,1-e.detailSize)))),new p.p("smoothness",(e=>(0,s.t7)(0,.5,1-e.smoothness))),new p.p("cloudHeight",(e=>(0,s.t7)(0,1500,e.cloudHeight))),new p.p("coverage",(e=>e.coverage)),new _.c("view",(e=>e.viewMatrix)),new f.A("cloudShapeTexture",(e=>null!=e.noiseTexture?e.noiseTexture.textureAtlas:null)),new d.A("cloudVariables",(e=>(0,a.t8)(x,e.coverage,e.absorption))),new u.U("lastSlice",(e=>e.lastSlice))),i.constants.add("halfCubeMapSize","float",.5*w),i.code.add(m.H`
    const int STEPS = ${e.steps===l.p.SIXTEEN?m.H`16`:e.steps===l.p.HUNDRED?m.H`100`:m.H`200`};
    const int STEPS_LIGHT = 6;
    const float stepL = 300.0 / float(STEPS_LIGHT);
    const float cloudStart = 1500.0;

    vec3 rayDirection(vec2 fragCoord) {
      vec2 xy = fragCoord;
      xy.x -= halfCubeMapSize;
      xy.y = lastSlice ? fragCoord.y - halfCubeMapSize : fragCoord.y;

      return normalize(vec3(-xy, -halfCubeMapSize));
    }

    float remap(float x, float low1, float high1, float low2, float high2) {
      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
    }

    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }`),i.code.add(m.H`
    float getCloudShape(vec3 pos, float pOffset) {
      const float textureWidth = ${m.H.float(c.a5)};
      const float dataWidth = ${m.H.float(c.a5)};
      const float tileRows = ${m.H.float(c.CB)};
      const vec3 atlasDimensions = vec3(${m.H.float(c.i9)}, ${m.H.float(c.i9)}, tileRows * tileRows);

      //Change from Y being height to Z being height
      vec3 p = float(${m.H.float(c.Mw)}) * pos.xzy;

      //Pixel coordinates of point in the 3D data
      vec3 coord = vec3(mod(p - pOffset * atlasDimensions, atlasDimensions));
      float f = fract(coord.z);
      float level = floor(coord.z);
      float tileY = floor(level / tileRows);
      float tileX = level - tileY * tileRows;

      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column
      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;
      vec2 pixel = coord.xy + offset;
      vec2 data = texture(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;

      return 1.0 - mix(data.x, data.y, f);
    }

    float getCloudMap(vec2 p){
      // Shift the texture center to origin to avoid seam artifacts
      vec2 uv = (${m.H.float(c.H6)} * p) / ${m.H.float(c.a5)} + 0.5;

      return texture(cloudShapeTexture, uv).a;
    }
    `),i.code.add(m.H`float clouds(vec3 p) {
float cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));
if (cloud <= 0.0) {
return 0.0;
}
float cloudMap = getCloudMap(cloudSize * p.xy);
cloud = mix(cloud, min(2.0 * (coverage), 1.0) * cloudMap, min(2.0 * (1.0 - coverage), 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float shape = getCloudShape(8.0 * cloudSize * p, 0.0);
cloud = saturate(remap(cloud, smoothness * shape, 1.0, 0.0, 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);
cloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * smoothstep(1.0, 0.25, heightFraction);
if (cloud <= 0.0) {
return 0.0;
}
return density * saturate(remap(cloud, 0.35 * smoothness * getCloudShape(detailSize * p, 0.0), 1.0, 0.0, 1.0));
}`),i.code.add(m.H`float HenyeyGreenstein(float g, float costh) {
return (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));
}
float multipleOctaves(float extinction, float mu, float stepL) {
float attenuation = 1.0;
float contribution = 1.0;
float phaseAttenuation = 1.0;
float luminance = 0.0;
for (int i = 0; i < 4; i++) {
float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);
luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);
attenuation *= 0.2;
contribution *= 0.6;
phaseAttenuation *= 0.5;
}
return luminance;
}`),i.code.add(m.H`float lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {
float lightRayDensity = clouds(p);
lightRayDensity += clouds(p + sunDirection * 1.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 2.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 3.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 4.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 5.0 * stepL);
float beersLaw = multipleOctaves(lightRayDensity, mu, stepL);
return mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);
}`),i.code.add(m.H`float mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {
if (dir.z < 0.0) {
return 0.0;
}
totalTransmittance = 1.0;
float stepS = totalDistance / float(STEPS);
float cameraHeight = length(org);
float mu = 0.5 + 0.5 * dot(sunDirection, dir);
float phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);
vec3 p = org + distToStart  * dir;
float dist = distToStart;
float shading = 0.0;
for (int i = 0; i < STEPS; i++) {
float sampleDensity = clouds(p);
float sampleSigmaE = sampleDensity * sigmaE;
if (sampleDensity > 0.0 ) {
float ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));
float luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));
float transmittance = exp(-sampleSigmaE * stepS);
shading += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;
totalTransmittance *= transmittance;
if (totalTransmittance <= 0.001) {
totalTransmittance = 0.0;
break;
}
}
dist += stepS;
p = org + dir * dist;
}
return shading;
}`),i.main.add(m.H`if (coverage ==  0.0) {
fragColor = vec4(0.0, 1.0, 0.0, 1.0);
return;
}
vec3 rayDir = rayDirection(gl_FragCoord.xy);
rayDir = normalize(view * rayDir);
vec3 viewPos = vec3(0, 0, cloudRadius + 1.0);
float hazeFactor = smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(dot(rayDir, vec3(0, 0, 1))));
float totalTransmittance = 1.0;
float shading = 0.0;
float cloudDistance = cloudRadius + cloudStart;
float rayStartDistance = dot(viewPos, viewPos) - (cloudDistance * cloudDistance);
vec2 rayStartIntersect = sphereIntersect(viewPos, rayDir, rayStartDistance);
float rayEndDistance = dot(viewPos, viewPos) - ((cloudDistance + cloudHeight) * (cloudDistance + cloudHeight));
vec2 rayEndIntersect = sphereIntersect(viewPos, rayDir, rayEndDistance);
float distToStart = rayStartIntersect.y;
float totalDistance = rayEndIntersect.y - distToStart;
vec3 sunDirection = normalize(vec3(0, 0, 1));
shading = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance);
shading = mix(clamp(1.0 - cloudVariables.y, 0.6, 1.0), shading, hazeFactor);
totalTransmittance = mix(0.0, totalTransmittance, hazeFactor);
fragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);`),t}const x=(0,o.Ue)(),T=Object.freeze(Object.defineProperty({__proto__:null,CloudsPassParameters:b,build:C,cubeMapSize:w},Symbol.toStringTag,{value:"Module"}))},30418:function(e,t,i){i.d(t,{C:function(){return f},b:function(){return _}});var r=i(72882),s=i(40212),n=i(42510),a=i(28262),o=i(29736),l=i(13743),c=i(45701),h=i(87688),u=i(13663),d=i(48857),p=i(4075),m=i(15150);function _(){const e=new m.kG,{fragment:t}=e;return e.include(p.X,{needUVs:!1,needEyeDirection:!1}),t.include(l.Y),t.include(c.n),e.include(r._,{pbrMode:n.f7.Disabled,lightingSphericalHarmonicsOrder:2}),t.include(a.e),t.include(s.D),e.include(o.j),t.uniforms.add(new h.d("cameraPosition",(e=>e.camera.eye)),new u.z("cloudsOpacity",(e=>e.clouds.opacity))).main.add(d.H`vec4 cloudsColor = renderClouds(normalize(worldRay), cameraPosition);
fragColor = vec4(cloudsOpacity * cloudsColor.rgb, cloudsColor.a);`),e}const f=Object.freeze(Object.defineProperty({__proto__:null,build:_},Symbol.toStringTag,{value:"Module"}))},58498:function(e,t,i){i.d(t,{C:function(){return U},b:function(){return N}});var r=i(21414),s=i(61796),n=i(54998),a=i(92473),o=i(70662),l=i(41044),c=i(27349),h=i(31839),u=i(56335),d=i(48737),p=i(92684),m=i(37452),_=i(40122),f=i(24807),g=i(67669),y=i(46722),v=i(51647),b=i(19065),w=i(32179),C=i(42510),x=i(4162),T=i(36351),S=i(7086),M=i(76144),E=i(95030),R=i(93270),P=i(48857),A=i(71063),O=i(34709),D=i(60037),I=i(75047),L=i(15150),F=i(64801);function N(e){const t=new L.kG,{vertex:i,fragment:N}=t;t.include(p.up,e),t.include(d.Bb,e),t.include(u.c,e),t.include(h.D,e),t.include(o.qj,e),t.include(n.AD,e),t.include(E.o,e),N.include(c.P_,e),t.include(x.s,e),t.include(S.H,e);const{output:U,pbrMode:H,hasNormalTexture:V,snowCover:k,receiveShadows:B,shadeNormals:z,spherical:G,ellipsoidMode:q,overlayEnabled:Z,componentData:j,vertexDiscardMode:W,hasBloom:$,renderOccluded:X}=e,Y=H===C.f7.Normal||H===C.f7.Schematic;Y&&(t.include(C.jV,e),V&&t.include(v.Q,e));const Q=U===l.H_.Shadow||U===l.H_.ShadowHighlight||U===l.H_.ShadowExcludeHighlight,K=Q&&j===n._N.Varying;if(Z){t.include(b.XP,e),t.include(M.WB,e);const s=q===R.U.Earth,n=q===R.U.Earth,a=s?r.sv.radius:n?r.yr.radius:r.Z1.radius;i.code.add(`\n      ${(0,P.If)(G,`const float invRadius = ${P.H.float(1/a)};`)}\n      vec2 projectOverlay(vec3 pos) { return pos.xy ${(0,P.If)(G,"/ (1.0 + invRadius * pos.z);")}; }`)}const J=Z&&(0,l.c1)(U)&&H===C.f7.WaterOnIntegratedMesh;J&&(t.varyings.add("tbnTangent","vec3"),t.varyings.add("tbnBiTangent","vec3"),t.varyings.add("groundNormal","vec3"));const ee=W===a.a.None,te=W===a.a.Opaque;if(i.main.add(P.H`
    bool castShadows;
    vec4 externalColor = forwardExternalColor(castShadows);
    ${(0,P.If)(K,"if(!castShadows) { gl_Position = vec4(vec3(1e38), 1.0); return; }")}

    ${(0,P.If)(!ee,`{ if (externalColor.a ${te?">":"<="} ${P.H.float(1-1/255)}) { gl_Position = vec4(vec3(1e38), 1.0); return; } }`)}

    ${(0,P.If)(U===l.H_.ObjectAndLayerIdColor,"externalColor.a = 1.0;")}

    forwardPosition(readElevationOffset());
    forwardViewPosDepth(vPosition_view);
    forwardNormal();
    forwardTextureCoordinates();
    forwardVertexColor();
    forwardLinearDepth();
    forwardObjectAndLayerIdColor();
    ${(0,P.If)(J,G?P.H`
            groundNormal = normalize(positionWorld());
            tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));
            tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`:P.H`
            groundNormal = vec3(0.0, 0.0, 1.0);
            tbnTangent = vec3(1.0, 0.0, 0.0);
            tbnBiTangent = vec3(0.0, 1.0, 0.0);`)}
    ${(0,P.If)(Z,"setOverlayVTC(projectOverlay(position));")}

    if (externalColor.a < ${P.H.float(F.e)}) {
      // Discard this vertex
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    }
  `),(0,l.c1)(U))return t.include(y.P,e),t.include(g.K,e),t.include(b.XP,e),t.include(I.j,e),N.include(D.R,e),B&&t.include(T.hb,e),N.code.add(P.H`
      float evaluateShadow() {
        return ${B?"readShadowMap(vPositionWorldCameraRelative, linearDepth)":"0.0"};
      }`),Z&&N.uniforms.add(new O.A("ovColorTex",((e,t)=>(0,M.WE)(e,t)))),N.main.add(P.H`
      discardBySlice(vPositionWorldCameraRelative);
      discardByTerrainDepth();

      vec4 textureColor = readBaseColorTexture();
      discardOrAdjustAlpha(textureColor);

      /* When rendering the occluded overlay, we still need to read the base color texture
       * because we need to use the same discard logic. However after that to render only the
       * draped overlay, we simply set the base texture color to zero. */
      ${(0,P.If)(X,P.H`textureColor = vec4(0);`)}

      ${(0,P.If)(Z,P.H`vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);`)}

      /* Early discard to only emit when we have overlay */
      ${(0,P.If)(Z&&X,P.H`if (overlayColor.a < ${P.H.float(F.e)}) { discard; }`)}

      vec4 externalColor;
      int externalColorMixMode;
      readExternalColor(externalColor, externalColorMixMode);

      vec4 materialColor = computeMaterialColor(textureColor, externalColor, externalColorMixMode);
    `),Y?((0,w.F1)(N),G&&(0,b.sC)(N),N.main.add(P.H`
        applyPBRFactors();
        ${(0,P.If)(H===C.f7.Normal,P.H`if (externalColorMixMode == 3) {
              mrr = vec3(0.0, 0.6, 0.2);
            }`)}
        float additionalIrradiance = 0.02 * mainLightIntensity[2];
        ${(0,P.If)(V,"mat3 tangentSpace = computeTangentSpace(fragmentFaceNormal, vPositionWorldCameraRelative, vuv0);")}
        vec3 shadingNormal = ${V?"computeTextureNormal(tangentSpace, vuv0)":"fragmentShadingNormal"};
        vec3 groundNormal = ${G?P.H`normalize(positionWorld())`:P.H`vec3(0.0, 0.0, 1.0)`};

        vec3 viewDir = normalize(vPositionWorldCameraRelative);
        float ssao = 1.0 - occlusion * evaluateAmbientOcclusionInverse();
        ${(0,P.If)(k,P.H`float snow = getSnow(fragmentFaceNormal, normalize(positionWorld()));
                 materialColor.rgb = mix(materialColor.rgb, vec3(1.1), snow);
                 ssao = mix(ssao, 0.5 * ssao, snow);
                 shadingNormal = mix(shadingNormal, fragmentFaceNormal, snow);`)}
        ${(0,P.If)(Z,"materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;")}

        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());
        vec4 emission = ${$?"vec4(0.0)":"getEmissions(materialColor.rgb)"};
        ${(0,P.If)(G,"float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());")}
        ${G?P.H`float shadow = max(lightingGlobalFactor * (1.0 - additionalAmbientScale), evaluateShadow());`:"float shadow = evaluateShadow();"}
        vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, shadow, ssao, additionalLight, viewDir, groundNormal, mrr, emission, additionalIrradiance), materialColor.a);
        `)):((0,w.Pe)(N),G&&(0,b.sC)(N),J&&N.uniforms.add(new A.e("ovNormalTex",(e=>e.overlay?.getTexture(s.D.WaterNormal)))),N.main.add(P.H`
        ${(0,P.If)(G,"float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());")}
        float shadow = ${B?G?"max(lightingGlobalFactor * (1.0 - additionalAmbientScale), evaluateShadow())":"evaluateShadow()":G?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0"};

        ${(0,P.If)(B&&!z,P.H`
            float dotFL = dot(fragmentFaceNormal, mainLightDirection);
            if( dotFL <= 0.0) shadow = 1.0;
        `)}
        ${(0,P.If)(k,P.H`float snow = getSnow(fragmentFaceNormal, normalize(positionWorld()));
               materialColor.rgb = mix(materialColor.rgb, vec3(1), snow);`)}

        // At global scale we create some additional ambient light based on the main light to simulate global illumination
        float ssao = evaluateAmbientOcclusion();
        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());

        ${(0,P.If)(Z,"materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;")}

        vec4 shadedColor = vec4(evaluateSceneLighting(fragmentShadingNormal, materialColor.rgb, shadow, ssao, additionalLight), materialColor.a);
        ${(0,P.If)(J,P.H`vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);
                 float waterNormalLength = length(overlayWaterMask);
                 if (waterNormalLength > 0.95) {
                   mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);
                   vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, overlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, vPosition_view, positionWorld());
                   vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                   // un-gamma the ground color to mix in linear space
                   shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);
                 }`)}
      `)),N.main.add(`outputColorHighlightOID(shadedColor, vPositionWorldCameraRelative, materialColor.rgb ${(0,P.If)(k,", snow")});`),t;const ie=U===l.H_.Normal,re=U===l.H_.ObjectAndLayerIdColor,se=U===l.H_.Highlight,ne=Q||U===l.H_.ViewshedShadow;return ne&&t.include(m.F,e),ie&&t.include(g.K,e),Z&&t.include(f._,e),t.include(_.b,e),N.main.add(P.H`
    discardBySlice(vPositionWorldCameraRelative);

    vec4 textureColor = readBaseColorTexture();
    discardOrAdjustAlpha(textureColor);

    ${(0,P.If)(ne,"outputDepth(linearDepth);")}
    ${(0,P.If)(ie,P.H`fragColor = vec4(vec3(0.5) + 0.5 * fragmentFaceNormalView, 1.0);`)}
    ${(0,P.If)(re,Z?"fragColor = getOverlayColorTexel();":"outputObjectAndLayerIdColor();")}
    ${(0,P.If)(se,(0,P.If)(Z,P.H`calculateOcclusionAndOutputHighlight(getAllOverlayHighlightValuesEncoded());`,P.H`calculateOcclusionAndOutputHighlight();`))}`),t}const U=Object.freeze(Object.defineProperty({__proto__:null,build:N},Symbol.toStringTag,{value:"Module"}))},65562:function(e,t,i){i.d(t,{C:function(){return p},a:function(){return _},b:function(){return m}});var r=i(17904),s=i(20638),n=i(45701),a=i(37124),o=i(85119),l=i(48857),c=i(34709),h=i(38419),u=i(74826),d=i(15150);class p extends u.K{constructor(){super(...arguments),this.opacity=1}}function m(e){const t=new d.kG;t.include(r.k),t.fragment.uniforms.add(new c.A("tex",(e=>e.texture))),e.hasOpacityFactor&&t.fragment.uniforms.add(new o.p("opacity",(e=>e.opacity)));const i=e.blitMode===h.J.Depth;return i&&(t.fragment.uniforms.add(new a.$("nearFar",(e=>e.camera.nearFar))),t.fragment.include(s.K),t.fragment.include(n.n)),t.fragment.main.add(l.H`
    ${i?l.H`
          float normalizedLinearDepth = (-linearDepthFromTexture(tex, uv) - nearFar[0]) / (nearFar[1] - nearFar[0]);
          fragColor = float2rgba(normalizedLinearDepth);`:l.H`
          fragColor = texture(tex, uv) ${e.hasOpacityFactor?"* opacity":""};`}`),t}const _=Object.freeze(Object.defineProperty({__proto__:null,CompositingPassParameters:p,build:m},Symbol.toStringTag,{value:"Module"}))},47935:function(e,t,i){i.d(t,{E:function(){return l},b:function(){return o}});var r=i(17904),s=i(48857),n=i(34709),a=i(15150);function o(){const e=new a.kG;return e.include(r.k),e.outputs.add("fragEdges","vec2"),e.fragment.code.add(s.H`float absMax3(vec3 v) {
vec3 t = abs(v);
return max(max(t.r, t.g), t.b);
}`),e.fragment.uniforms.add(new n.A("colorTexture",(e=>e.color))).main.add(s.H`
    vec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));
    vec4 offsets[3];
    offsets[0] = vec4(uv.x - resolution.x, uv.y, uv.x, uv.y + resolution.y);
    offsets[1] = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);
    offsets[2] = vec4(uv.x - 2.0 * resolution.x, uv.y, uv.x, uv.y + 2.0 * resolution.y);

    // Calculate color deltas:
    vec3 C = texture(colorTexture, uv).rgb;
    vec3 Cleft = texture(colorTexture, offsets[0].xy).rgb;
    vec3 Ctop = texture(colorTexture, offsets[0].zw).rgb;
    vec2 delta = vec2(absMax3(C - Cleft), absMax3(C - Ctop));
    vec2 edges = step(vec2(${s.H.float(.05)}), delta);

    // discard if there is no edge:
    if (dot(edges, vec2(1.0)) == 0.0) {
      fragEdges = vec2(0.0);
    }
    else {
      // Calculate right and bottom deltas:
      vec3 Cright = texture(colorTexture, offsets[1].xy).rgb;
      float horizontal = absMax3(C - Cright);

      vec3 Cbottom  = texture(colorTexture, offsets[1].zw).rgb;
      float vertical = absMax3(C - Cbottom);

      // Calculate the maximum delta in the direct neighborhood:
      float maxDelta = max(max(max(delta.x, delta.y), horizontal), vertical);

      // Calculate left-left and top-top deltas:
      vec3 Cleftleft  = texture(colorTexture, offsets[2].xy).rgb;
      horizontal = absMax3(C - Cleftleft);

      vec3 Ctoptop = texture(colorTexture, offsets[2].zw).rgb;
      vertical = absMax3(C - Ctoptop);

      // Calculate the final maximum delta:
      maxDelta = max(max(maxDelta, horizontal), vertical);

      // Local contrast adaptation in action:
      fragEdges = edges * step(maxDelta, float(${s.H.float(2)}) * delta);
    }
  `),e}const l=Object.freeze(Object.defineProperty({__proto__:null,build:o},Symbol.toStringTag,{value:"Module"}))},16926:function(e,t,i){i.d(t,{F:function(){return f},a:function(){return y},b:function(){return g}});var r=i(82846),s=i(20638),n=i(40212),a=i(87688),o=i(9535),l=i(85119),c=i(48857),h=i(71063),u=i(4075),d=i(47975),p=i(85797),m=i(74826),_=i(15150);class f extends m.K{constructor(){super(...arguments),this.color=(0,r.Ue)(),this.strength=4e-6,this.atmosphereC=1,this.amount=0}}function g(){const e=new _.kG;e.include(u.X,{needUVs:!0,needEyeDirection:!0});const t=e.fragment;return t.uniforms.add(new l.p("atmosphereC",(e=>e.atmosphereC)),new a.d("cameraPosition",(e=>e.camera.eye)),new h.e("depthTexture",(e=>e.mainDepth)),new l.p("fogStrength",(e=>e.strength)),new l.p("fogAmount",(e=>e.amount)),new o.J("fogColor",(e=>e.color))),t.include(n.D),t.include(d.l),t.include(p.l),t.include(s.K),t.code.add(c.H`float getFogAmount(float dist, vec3 rayDir) {
if(dist == -1.0){
dist = 0.055 * sphereIntersect(cameraPosition, rayDir, atmosphereC).y;
}
return fogAmount * (1.0 - exp(-dist * fogStrength));
}`),t.main.add(c.H`vec3 rayDir = normalize(worldRay);
float terrainDepth = -1.0;
float depthSample = depthFromTexture(depthTexture, uv);
if(depthSample < 1.0 && depthSample > 0.0){
vec3 cameraSpaceRay = normalize(eyeDir);
cameraSpaceRay /= cameraSpaceRay.z;
cameraSpaceRay *= linearizeDepth(depthSample);;
terrainDepth = max(0.0, length(cameraSpaceRay));
}
float fogAmount = getFogAmount(terrainDepth, rayDir);
vec4 fog = vec4(fogColor, 1.0) * fogAmount;
fragColor = delinearizeGamma(vec4(tonemapACES(fog.rgb), fog.a));`),e}const y=Object.freeze(Object.defineProperty({__proto__:null,FogPassParameters:f,build:g},Symbol.toStringTag,{value:"Module"}))},93223:function(e,t,i){i.d(t,{H:function(){return l},a:function(){return h},b:function(){return c}});var r=i(17904),s=i(48857),n=i(34709),a=i(74826),o=i(15150);class l extends a.K{}function c(){const e=new o.kG;return e.include(r.k),e.fragment.uniforms.add(new n.A("tex",(e=>e.texture))),e.fragment.main.add(s.H`fragColor = vec4(1.0 - texture(tex, uv).a);`),e}const h=Object.freeze(Object.defineProperty({__proto__:null,HUDCompositingPassParameters:l,build:c},Symbol.toStringTag,{value:"Module"}))},79626:function(e,t,i){i.d(t,{H:function(){return _},b:function(){return m}});var r=i(1824),s=i(20638),n=i(40212),a=i(32179),o=i(85119),l=i(48857),c=i(71063),h=i(4075),u=i(47975),d=i(85797),p=i(15150);function m(e){const t=new p.kG,{fragment:i}=t;t.include(h.X),(0,a.Pe)(i),i.include(n.D),i.include(s.K),i.include(u.l),i.include(d.l),i.include(r.t,!0),i.uniforms.add(new c.e("depthTexture",(e=>e.mainDepth)),new o.p("hazeStrength",(e=>e.hazeStrength)));const{reduced:m}=e;return m&&i.code.add(l.H`float getDepth(vec2 uv){
return linearDepthFromTexture(depthTexture, uv);
}
float textureBilinear(vec2 uv) {
vec2 depthTextureSize = vec2(textureSize(depthTexture, 0));
vec2 texelSize = 1.0 / depthTextureSize;
vec2 depthUV = (uv * depthTextureSize) - vec2(0.5);
vec2 f = fract(depthUV);
vec2 snapUV = (floor(depthUV) + vec2(0.5)) / depthTextureSize;
float d0 = getDepth(snapUV);
float d1 = getDepth(snapUV + vec2(texelSize.x, 0.0));
float d2 = getDepth(snapUV + vec2(0.0, texelSize.y));
float d3 = getDepth(snapUV + texelSize);
return mix(mix(d0, d1, f.x), mix(d2, d3, f.x), f.y);
}`),i.main.add(l.H`
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;

      float depthSample = texture(depthTexture, uv).r;
      if (depthSample != 1.0) {
        vec3 cameraSpaceRay = normalize(eyeDir);
        cameraSpaceRay /= cameraSpaceRay.z;

        cameraSpaceRay *= ${(0,l.If)(m,"-textureBilinear(uv)","-linearDepthFromTexture(depthTexture, uv)")};
        terrainDepth = max(0.0, length(cameraSpaceRay));
      } else {
        discard;
      }

      // Alpha is ignored for haze blending
      vec3 col = vec3(0);
      float fadeOut = smoothstep(-10000.0, -15000.0, heightParameters[0] - radii[0]);
      if(depthSample != 1.0){
        col = (1.0 - fadeOut) * hazeStrength * raymarchAtmosphere(cameraPosition, rayDir, mainLightDirection, terrainDepth);
      }
      float alpha = 1.0;

      col = tonemapACES(col);
      fragColor = delinearizeGamma(vec4(col, alpha));
  `),t}const _=Object.freeze(Object.defineProperty({__proto__:null,build:m},Symbol.toStringTag,{value:"Module"}))},41811:function(e,t,i){i.d(t,{H:function(){return c},a:function(){return u},b:function(){return h}});var r=i(17904),s=i(48857),n=i(71063),a=i(34709),o=i(74826),l=i(15150);class c extends o.K{}function h(){const e=new l.kG;return e.include(r.k),e.fragment.uniforms.add(new a.A("colorTexture",(e=>e.color)),new n.e("depthTexture",(e=>e.mainDepth))),e.fragment.main.add(s.H`float depthSample = texture(depthTexture, uv).r;
if (depthSample == 1.0 ) {
fragColor = vec4(0);
return;
}
fragColor = texture(colorTexture, uv);`),e}const u=Object.freeze(Object.defineProperty({__proto__:null,HazeCompositingPassParameters:c,build:h},Symbol.toStringTag,{value:"Module"}))},87619:function(e,t,i){i.d(t,{M:function(){return p},a:function(){return y},b:function(){return m}});var r=i(96094),s=i(73749),n=i(27583),a=i(54231),o=i(2013),l=i(48857),c=i(34709),h=i(52061),u=i(74826),d=i(15150);class p extends u.K{constructor(){super(...arguments),this.mask=null,this.overlay=null,this.input=null,this.size=0}}function m(){const e=new d.kG;return e.attributes.add(h.T.POSITION,"vec2"),e.vertex.uniforms.add(new o.N("drawPosition",((e,t)=>function(e,t){const i=t.camera.pixelRatio,n=e.magnifier.offset.x*i,a=e.magnifier.offset.y*i;(0,r.md)(e.magnifier.position,_);const o=t.camera.screenToRender(_,f),l=Math.ceil(i*e.magnifier.size),{fullWidth:c,fullHeight:h}=t.camera;return(0,s.s)(g,(o[0]+n)/c*2-1,(o[1]-a)/h*2-1,l/c*2,l/h*2)}(e,t)))),e.varyings.add("vUV","vec2"),e.vertex.main.add(l.H`vUV = position;
gl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);`),e.fragment.uniforms.add(new c.A("textureInput",(e=>e.input))),e.fragment.uniforms.add(new c.A("textureMask",(e=>e.mask))),e.fragment.uniforms.add(new c.A("textureOverlay",(e=>e.overlay))),e.fragment.uniforms.add(new a.U("maskEnabled",(e=>e.magnifier.maskEnabled))),e.fragment.uniforms.add(new a.U("overlayEnabled",(e=>e.magnifier.overlayEnabled))),e.fragment.code.add(l.H`const float barrelFactor = 1.1;
vec2 barrel(vec2 uv) {
vec2 uvn = uv * 2.0 - 1.0;
if (uvn.x == 0.0 && uvn.y == 0.0) {
return vec2(0.5, 0.5);
}
float theta = atan(uvn.y, uvn.x);
float r = pow(length(uvn), barrelFactor);
return r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;
}`),e.fragment.main.add(l.H`float mask = maskEnabled ? texture(textureMask, vUV).a : 1.0;
vec4 inputColor = texture(textureInput, barrel(vUV)) * mask;
vec4 overlayColor = overlayEnabled ? texture(textureOverlay, vUV) : vec4(0);
fragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;`),e}const _=(0,r.s1)(),f=(0,r.gX)(),g=(0,n.Ue)(),y=Object.freeze(Object.defineProperty({__proto__:null,MagnifierPassParameters:p,build:m},Symbol.toStringTag,{value:"Module"}))},26605:function(e,t,i){i.d(t,{N:function(){return u},a:function(){return p},b:function(){return d}});var r=i(41788),s=i(80461),n=i(23625),a=i(17904),o=i(19155),l=i(48857),c=i(74826),h=i(15150);class u extends c.K{constructor(){super(...arguments),this.weatherTile=(0,r.al)(0,0)}}function d(e){const t=new h.kG;if(t.include(a.k,!1),t.fragment.code.add(l.H`float remap(float x, float low1, float high1, float low2, float high2) {
return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
}`),e.mode===s.u.Full){const e=2,i=8;t.fragment.code.add(l.H`float saturate(float x) {
return clamp(x, 0.0, 1.0);
}`),t.fragment.code.add(l.H`vec3 modulo(vec3 m, float n) {
return mod(mod(m, n) + n, n);
}
vec3 hash(vec3 p3, float frequency) {
p3 = modulo(p3, frequency);
p3 = fract(p3 * vec3(0.1031, 0.1030, 0.0973));
p3 += dot(p3, p3.yxz + 33.33);
return -1.0 + 2.0 * fract((p3.xxy + p3.yxx) * p3.zyx);
}`),t.fragment.code.add(l.H`vec3 fade(vec3 t) {
return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
}`),t.fragment.code.add(l.H`
    float gradientNoise(vec3 p, float frequency) {
      vec3 i = floor(p);
      vec3 f = fract(p);
      vec3 u = fade(f);
      return mix( mix( mix( dot( hash( i + vec3(0.0,0.0,0.0), frequency), f - vec3(0.0,0.0,0.0) ),
                            dot( hash( i + vec3(1.0,0.0,0.0), frequency), f - vec3(1.0,0.0,0.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,0.0), frequency), f - vec3(0.0,1.0,0.0) ),
                            dot( hash( i + vec3(1.0,1.0,0.0), frequency), f - vec3(1.0,1.0,0.0) ), u.x), u.y),
                  mix( mix( dot( hash( i + vec3(0.0,0.0,1.0), frequency), f - vec3(0.0,0.0,1.0) ),
                            dot( hash( i + vec3(1.0,0.0,1.0), frequency), f - vec3(1.0,0.0,1.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,1.0), frequency), f - vec3(0.0,1.0,1.0) ),
                            dot( hash( i + vec3(1.0,1.0,1.0), frequency), f - vec3(1.0,1.0,1.0) ), u.x), u.y), u.z );
    }

    float getPerlinNoise(vec3 pos, float frequency) {
      float octaveFrequency = 2.0;
      float sum = 0.0;
      float weightSum = 0.0;
      float weight = 1.0;

      for (int oct = 0; oct < 3; oct++) {
        vec3 p = pos * frequency;
        float val = 0.5 + 0.5 * gradientNoise(p, frequency);
        sum += val * weight;
        weightSum += weight;
        weight *= 0.5;
        frequency *= octaveFrequency;
      }

      float noise = (sum / weightSum);
      noise = saturate(noise);
      return noise;
    }

    float worley(vec3 pos, float numCells) {
      vec3 p = pos * numCells;
      float d = 1.0e10;

      for (int x = -1; x <= 1; x++) {
        for (int y = -1; y <= 1; y++) {
          for (int z = -1; z <= 1; z++) {
            vec3 tp = floor(p) + vec3(x, y, z);
            tp = p - tp - (hash(tp, numCells) * 0.5 + 0.5);
            d = min(d, dot(tp, tp));
          }
        }
      }

      return 1.0 - clamp(d, 0.0, 1.0);
    }

    vec3 get3Dfrom2D(vec2 uv) {
      vec2 tile = floor(uv);
      float z = floor(${l.H.float(n.CB)} * tile.y + tile.x);
      return vec3(fract(uv), z);
    }

    float getTextureForPointPerlinWorley(vec3 p) {
      float perlinNoise = getPerlinNoise(p, ${l.H.float(i)});

      float worley0 = worley(p, ${l.H.float(e)} * 2.0);
      float worley1 = worley(p, ${l.H.float(e)} * 8.0);
      float worley2 = worley(p, ${l.H.float(e)} * 14.0);

      float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);
    }

    float getTextureForPointWorley(vec3 p) {
      float worley0 = worley(p, ${l.H.float(e)});
      float worley1 = worley(p, ${l.H.float(e)} * 2.0);
      float worley2 = worley(p, ${l.H.float(e)} * 4.0);
      float worley3 = worley(p, ${l.H.float(e)} * 8.0);

      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;
      float FBM2 = worley2 * 0.75 + worley3 * 0.25;

      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;
    }
  `)}return t.fragment.uniforms.add(new o.A("weatherTile",(e=>e.weatherTile))).code.add(l.H`
    vec2 modulo(vec2 m, float n){
      return mod(mod(m, n) + n, n);
    }

    vec2 hash(vec2 p){
      // Get position of p in weather tile
      p = modulo(p, ${l.H.float(n.JK)});

      // Get global coordinates of p
      p += weatherTile * ${l.H.float(n.JK)};

      // Limit position to avoid numerical instability
      p = modulo(p, ${l.H.float(n.r7)});

      vec3 p3 = fract(vec3(p.xyx) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return 2.0 * fract((p3.xx + p3.yz) * p3.zy) - 1.0;
    }

    vec2 fade(vec2 t){
      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
    }

    float gradientNoise(vec2 p){
      vec2 i = floor( p );
      vec2 f = fract( p );

      vec2 u = fade(f);

      // Bilinear interpolation of gradients at cell vertices around point
      return  mix(
                mix(dot( hash( i + vec2(0.0,0.0) ), f - vec2(0.0,0.0) ),
                    dot( hash( i + vec2(1.0,0.0) ), f - vec2(1.0,0.0) ), u.x),
                mix(dot( hash( i + vec2(0.0,1.0) ), f - vec2(0.0,1.0) ),
                    dot( hash( i + vec2(1.0,1.0) ), f - vec2(1.0,1.0) ), u.x),
                u.y);
    }

    float worley(vec2 p){
      float d = 1.0e10;
      for (int x = -1; x <= 1; x++){
        for (int y = -1; y <= 1; y++){
                vec2 tp = floor(p) + vec2(x, y);
                tp = p - tp - (0.5 + 0.5 * hash(tp));
                d = min(d, dot(tp, tp));
            }
        }
      return 1.0 - clamp(d, 0.0, 1.0);
    }
  `),e.mode===s.u.Full?t.fragment.main.add(l.H`
      float padWidth = 1.0;
      float paddedSize = ${l.H.float(n.i9)} + 2.0 * padWidth;
      float tileCount = ${l.H.float(n.CB)} * ${l.H.float(n.CB)};
      vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);

      bool padCell = false;
      if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {
        padCell = true;
      }

      if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {
        padCell = true;
      }

      bool startPadX = false;
      bool startPadY = false;
      bool endPadX = false;
      bool endPadY = false;

      if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {
        startPadX = true;
      }

      if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {
        startPadY = true;
      }

      if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {
        endPadX = true;
      }

      if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {
        endPadY = true;
      }

      vec2 padding = vec2(2.0 * padWidth) * tile;
      vec2 uv;

      if (padCell) {
        vec2 pixel = gl_FragCoord.xy - padWidth - padding;

        if (startPadX) {
          pixel.x += ${l.H.float(n.i9)};
        }

        if (startPadY) {
          pixel.y += ${l.H.float(n.i9)};
        }

        if (endPadX) {
          pixel.x -= ${l.H.float(n.i9)};
        }

        if (endPadY) {
          pixel.y -= ${l.H.float(n.i9)};
        }

        uv = vec2(pixel.xy / ${l.H.float(n.i9)});
      } else {
        vec2 pixel = gl_FragCoord.xy - padWidth - padding;
        uv = vec2(pixel.xy / ${l.H.float(n.i9)});
      }

      vec3 p_ = get3Dfrom2D(uv);
      vec3 p = p_;
      p.z /= (${l.H.float(n.CB)} * ${l.H.float(n.CB)});

      float worleyPerlinNoise = getTextureForPointPerlinWorley(p);
      float worleyNoise = getTextureForPointWorley(p);

      fragColor.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

      p_ = mod(p_ + 1.0, ${l.H.float(n.CB)} * ${l.H.float(n.CB)});
      p = p_;
      p.z /= (${l.H.float(n.CB)} * ${l.H.float(n.CB)});

      worleyPerlinNoise = getTextureForPointPerlinWorley(p);
      worleyNoise = getTextureForPointWorley(p);

      fragColor.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

      vec2 mapUV = ${l.H.float(n.JK)} * (gl_FragCoord.xy / ${l.H.float(n.a5)});
      float map = abs(gradientNoise(mapUV));
      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);
      fragColor.ba = vec2(0.0, map);
      `):t.fragment.main.add(l.H`
      vec2 mapUV = ${l.H.float(n.JK)} * (gl_FragCoord.xy / ${l.H.float(n.a5)});
      float map = abs(gradientNoise(mapUV));
      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);
      fragColor = vec4(map);
    `),t}const p=Object.freeze(Object.defineProperty({__proto__:null,NoiseTextureAtlasPassParameters:u,build:d},Symbol.toStringTag,{value:"Module"}))},3931:function(e,t,i){i.d(t,{O:function(){return l},a:function(){return h},b:function(){return c}});var r=i(17904),s=i(48857),n=i(34709),a=i(74826),o=i(15150);class l extends a.K{}function c(e){const t=new o.kG;t.include(r.k);const i=e.hasEmission,a=t.fragment;return a.uniforms.add(new n.A("colorTexture",(e=>e.colorTexture)),new n.A("alphaTexture",(e=>e.alphaTexture)),new n.A("frontFaceTexture",(e=>e.frontFaceTexture))),t.outputs.add("fragColor","vec4",0),i&&(t.outputs.add("fragEmission","vec4",1),a.uniforms.add(new n.A("emissionTexture",(e=>e.emissionTexture))),a.uniforms.add(new n.A("emissionFrontFaceTexture",(e=>e.emissionFrontFaceTexture)))),a.main.add(s.H`
      float srcAlpha = texture(alphaTexture, uv).r;
      if(srcAlpha == 0.0){
        fragColor = vec4(0.0);
        ${(0,s.If)(i,"fragEmission = vec4(0.0);")}
        return;
      }

      vec4 srcColor = texture(colorTexture, uv);
      vec4 frontFace = texture(frontFaceTexture, uv);

      vec4 transparentColor = vec4(mix(srcColor.rgb / srcAlpha, frontFace.rgb, frontFace.a), 1.0 - srcColor.a);
      fragColor = transparentColor;

      ${(0,s.If)(i,"vec4 emission = texture(emissionTexture, uv);\n         vec4 emissionFrontFace = texture(emissionFrontFaceTexture, uv);\n        fragEmission = vec4(mix(emission.rgb / srcAlpha, emissionFrontFace.rgb, emissionFrontFace.a), emissionFrontFace.a);")}
    `),t}const h=Object.freeze(Object.defineProperty({__proto__:null,OITBlendPassParameters:l,build:c},Symbol.toStringTag,{value:"Module"}))},40854:function(e,t,i){i.d(t,{P:function(){return v},b:function(){return p}});var r=i(24910),s=i(82846),n=i(22567),a=i(87688),o=i(9535),l=i(85119),c=i(48857),h=i(18489),u=i(52061),d=i(15150);function p(e){const t=new d.kG;return t.attributes.add(u.T.POSITION,"vec3"),t.attributes.add(u.T.INSTANCEFEATUREATTRIBUTE,"float"),t.vertex.uniforms.add(new a.d("cameraPosition",(e=>e.camera.eye)),new o.J("offset",((e,t)=>function(e,t){const i=t.camera.eye,s=.5*e.width,n=1/e.width,a=(0,r.J)(m,(0,r.i)(m,(i[0]+s)*n,(i[1]+s)*n,(i[2]+s)*n));return(0,r.a)(a,i,(0,r.g)(a,a,e.width))}(e,t))),new l.p("width",(e=>e.width)),new l.p("time",(e=>e.time)),new h.C("proj",(e=>e.camera.projectionMatrix)),new h.C("view",(e=>e.camera.viewMatrix))),t.varyings.add("vUv","vec2"),t.vertex.code.add(c.H`vec3 hash31(float p){
vec3 p3 = fract(vec3(p) * vec3(0.1031, 0.1030, 0.0973));
p3 += dot(p3, p3.yzx + 33.33);
return fract((p3.xxy + p3.yzz) * p3.zyx);
}
float hash11(float p){
p = fract(p * 0.1031);
p *= p + 33.33;
p *= p + p;
return fract(p);
}
vec3 rotateVectorByQuaternion(vec3 v, vec4 q){
return 2.0 * cross(q.xyz, v * q.w + cross(q.xyz, v)) + v;
}`),t.vertex.main.add(c.H`
      vUv = position.xz;
      vec3 rand = hash31(instanceFeatureAttribute);

      // Set random position for all particles
      // The hash function space is not high resolution so offset particles by an additional random value
      // This creates grids of 1000 particles which are shifted by random hundredths of the tile width
      // overlaying multiple identical but offset grids
      vec3 randomPosition = 2.0 * (rand + (0.01 + 0.01 * rand) * floor(0.001 * instanceFeatureAttribute)) - 1.0;

      // Random orientation of rain drops
      float angle = 3.1415 * hash11(instanceFeatureAttribute);

      vec3 up = vec3(0, 0, 1);

      // Gravity and wind direction
      vec3 direction = normalize(cameraPosition);

      vec3 tangent = normalize(cross(direction, up));

      // Gravity
      vec3 animatedPos = randomPosition + direction * -time;

      // Rain particles fall straight down and are randomly oriented
      // Snow particles have random sinusoid trajectories and are rotated to face the camera
      ${e.type===n.H.Rain?c.H`
            // Random rotation for particle
            vec3 rotationAxis = up;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));
            vec3 transformedPos = rotateVectorByQuaternion(vec3(0.2, 0.2, 4.0) * (position - vec3(0.5, 0.0, 0.5)), quat);

            // Rotate particle to planetary position
            rotationAxis = tangent;
            angle = 0.5 * -acos(dot(direction, up));
            quat = vec4(rotationAxis * sin(angle), cos(angle));
            transformedPos = rotateVectorByQuaternion(transformedPos, quat);

            vec4 pos = mat4(mat3(view)) * vec4(transformedPos + (mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * pos;
      `:c.H`
            vec3 rotationAxis = direction;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));

            tangent = rotateVectorByQuaternion(tangent, quat);
            // Random sinusoid from friction
            animatedPos += tangent * 0.25 * sin(dot(animatedPos, direction));
            vec4 pos = mat4(mat3(view)) * vec4((mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * (0.5 * vec4(position.xzy, 0.0) + pos);
      `}
  `),t.fragment.uniforms.add(new l.p("opacity",(e=>e.opacity)),new a.d("particleColor",(t=>function(e,t){const i=t.type===n.H.Rain?g:f,s=(0,r.g)(m,i,y),a=e.camera.eye;(0,r.n)(_,a);const o=Math.max(0,(0,r.e)(_,e.lighting.mainLight.direction));return(0,r.m)(s,s,i,o)}(t,e)))),t.fragment.main.add(c.H`
    float d = length(vUv - vec2(0.5));

    ${e.type===n.H.Rain?c.H`d = 0.35 * smoothstep(0.5, 0.0, d);`:c.H`d = smoothstep(0.5, 0.1, d);`}
    fragColor = opacity * vec4(particleColor * d, d);
  `),t}const m=(0,s.Ue)(),_=(0,s.Ue)(),f=(0,s.al)(1,1,1),g=(0,s.al)(.85,.85,.85),y=.7,v=Object.freeze(Object.defineProperty({__proto__:null,build:p},Symbol.toStringTag,{value:"Module"}))},86295:function(e,t,i){i.d(t,{C:function(){return y},R:function(){return C},a:function(){return v},b:function(){return b},c:function(){return w}});var r=i(82846),s=i(20350),n=i(94129),a=i(13887),o=i(99563),l=i(58226),c=i(13743),h=i(54231),u=i(19155),d=i(85119),p=i(39163),m=i(48857),_=i(20431),f=i(34709),g=i(15150);class y extends a.J{constructor(e,t,i,s,n,a){super(e,s,n),this.colormap=t,this.symbolizer=i,this.u_colormap=a,this.backgroundColor=r.AG,this.fboTexture=null,this.baseOpacity=1}}class v extends y{}class b extends y{}function w(e){const t=new g.kG;return t.include(l.T),t.include(a.G,e),t.include(n.i,e),t.include(o.J,e),t.fragment.code.add(m.H`vec4 applyBackgroundBlend(vec4 layerColor) {
return blendLayers(vuv, layerColor, u_opacity);
}`),e.colorizerType===s.U.Stretch?function(e,t){e.fragment.uniforms.add(new _._("u_bandCount",(e=>e.symbolizer.u_bandCount)),new p.O("u_minCutOff",(e=>e.symbolizer.u_minCutOff),3),new p.O("u_maxCutOff",(e=>e.symbolizer.u_maxCutOff),3),new p.O("u_factor",(e=>e.symbolizer.u_factor),3),new d.p("u_minOutput",(e=>e.symbolizer.u_minOutput)),new d.p("u_maxOutput",(e=>e.symbolizer.u_maxOutput)),new h.U("u_useGamma",(e=>e.symbolizer.u_useGamma)),new p.O("u_gamma",(e=>e.symbolizer.u_gamma),3),new p.O("u_gammaCorrection",(e=>e.symbolizer.u_gammaCorrection),3),new d.p("u_opacity",(e=>e.common.u_opacity))),e.fragment.code.add(m.H`float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {
if (val >= maxCutOff) {
return maxOutput;
} else if (val <= minCutOff) {
return minOutput;
}
float stretchedVal;
if (useGamma) {
float tempf = 1.0;
float outRange = maxOutput - minOutput;
float relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);
if (gamma > 1.0) {
tempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);
}
stretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;
} else {
stretchedVal = minOutput + (val - minCutOff) * factor;
}
return stretchedVal;
}`);const i=t.applyColormap?m.H`fragColor = applyBackgroundBlend(colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma));`:m.H`fragColor = applyBackgroundBlend(vec4(grayVal, grayVal, grayVal, currentPixel.a));`;e.fragment.main.add(m.H`
    vec2 pixelLocation = getPixelLocation(uv);
    if (isOutside(pixelLocation)) {
      fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
      return;
    }

    vec4 currentPixel = getPixel(pixelLocation);
    ${t.stretchType===s.H.Noop?m.H`fragColor = applyBackgroundBlend(currentPixel);`:m.H`
    if (currentPixel.a == 0.0) {
      fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
      return;
    }
    if (u_bandCount == 1) {
      float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
      ${i}
    } else {
      float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
      float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);
      float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);
      fragColor = applyBackgroundBlend(vec4(redVal, greenVal, blueVal, currentPixel.a));
    }`}`)}(t,e):e.colorizerType===s.U.Lut?function(e){e.fragment.main.add(m.H`vec2 pixelLocation = getPixelLocation(uv);
if (isOutside(pixelLocation)) {
fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
return;
}
vec4 currentPixel = getPixel(pixelLocation);
fragColor = applyBackgroundBlend(colormap(currentPixel, true));`)}(t):e.colorizerType===s.U.Hillshade&&function(e,t){const i=e.fragment;i.uniforms.add(new f.A("u_image",(e=>e.u_image)),new _._("u_hillshadeType",(e=>e.symbolizer.u_hillshadeType)),new p.O("u_sinZcosAs",(e=>e.symbolizer.u_sinZcosAs),6),new p.O("u_sinZsinAs",(e=>e.symbolizer.u_sinZsinAs),6),new p.O("u_cosZs",(e=>e.symbolizer.u_cosZs),6),new p.O("u_weights",(e=>e.symbolizer.u_weights),6),new u.A("u_factor",(e=>e.symbolizer.u_factor)),new d.p("u_minValue",(e=>e.symbolizer.u_minValue)),new d.p("u_maxValue",(e=>e.symbolizer.u_maxValue)),new u.A("u_srcImageSize",(e=>e.common.u_srcImageSize))),i.include(c.Y),i.code.add(m.H`vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {
val = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);
vec4 color = colormap(vec4(val, val, val, 1.0), false);
vec3 hsv = rgb2hsv(color.rgb);
hsv.z = hillshade;
return vec4(hsv2rgb(hsv), 1.0) * alpha * color.a;
}`),i.code.add(m.H`float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){
if (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {
return 0.0;
}  else {
return e;
}
}`);const r=t.applyColormap?m.H`fragColor = applyBackgroundBlend(overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha));`:m.H`hillshade *= alpha;
fragColor = applyBackgroundBlend(vec4(hillshade, hillshade, hillshade, alpha));`;i.main.add(m.H`
      vec2 pixelLocation = getPixelLocation(uv);
      if (isOutside(pixelLocation)) {
        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      vec4 currentPixel = getPixel(pixelLocation);
      if (currentPixel.a == 0.0) {
        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      //mirror edge pixels
      vec2 axy = vec2(-1.0, -1.0);
      vec2 bxy = vec2(0.0, -1.0);
      vec2 cxy = vec2(1.0, -1.0);
      vec2 dxy = vec2(-1.0, 0.0);
      vec2 fxy = vec2(1.0, 0.0);
      vec2 gxy = vec2(-1.0, 1.0);
      vec2 hxy = vec2(0.0, 1.0);
      vec2 ixy = vec2(1.0, 1.0);
      vec2 onePixel = 1.0 / u_srcImageSize;
      if (pixelLocation.s < onePixel.s) {
        axy[0] = 1.0;
        dxy[0] = 1.0;
        gxy[0] = 1.0;
      }
      if (pixelLocation.t < onePixel.t) {
        axy[1] = 1.0;
        bxy[1] = 1.0;
        cxy[1] = 1.0;
      }
      if (pixelLocation.s > 1.0 - onePixel.s) {
        cxy[0] = -1.0;
        fxy[0] = -1.0;
        ixy[0] = -1.0;
      }
      if (pixelLocation.t > 1.0 - onePixel.t) {
        gxy[1] = -1.0;
        hxy[1] = -1.0;
        ixy[1] = -1.0;
      }

      // calculate hillshade
      vec4 va = texture(u_image, pixelLocation + onePixel * axy);
      vec4 vb = texture(u_image, pixelLocation + onePixel * bxy);
      vec4 vc = texture(u_image, pixelLocation + onePixel * cxy);
      vec4 vd = texture(u_image, pixelLocation + onePixel * dxy);
      vec4 ve = texture(u_image, pixelLocation);
      vec4 vf = texture(u_image, pixelLocation + onePixel * fxy);
      vec4 vg = texture(u_image, pixelLocation + onePixel * gxy);
      vec4 vh = texture(u_image, pixelLocation + onePixel * hxy);
      vec4 vi = texture(u_image, pixelLocation + onePixel * ixy);

      // calculate the rate of z change along the x, y, and diagonal direction
      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;
      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;
      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);
      float hillshade = 0.0;

      // traditional single light source
      if (u_hillshadeType == 0){
        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;
        float z = (u_cosZs[0] + cosDelta) / dzd;
        if (z < 0.0)  z = 0.0;
        hillshade = z;
      } else {
        // multi-directional with 6 light sources
        for (int k = 0; k < 6; k++) {
        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;
        float z = (u_cosZs[k] + cosDelta) / dzd;
        if (z < 0.0) z = 0.0;
        hillshade = hillshade + z * u_weights[k];
        if (k == 5) break;
        }
      }

      // set color
      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);
      alpha *= u_opacity;
      ${r}`)}(t,e),t}const C=Object.freeze(Object.defineProperty({__proto__:null,ColorizerHillshadeUniforms:b,ColorizerStretchUniforms:v,ColorizerUniforms:y,build:w},Symbol.toStringTag,{value:"Module"}))},55244:function(e,t,i){i.d(t,{S:function(){return d},a:function(){return f},b:function(){return m}});var r=i(17904),s=i(84201),n=i(36351),a=i(48857),o=i(71063),l=i(11089),c=i(8069),h=i(80518),u=i(15150);const d=255,p=1/d;function m(e){const t=new u.kG,{fragment:i}=t;t.include(r.k),t.include(s.V),t.include(n.hb,_),i.uniforms.add(new l.j("shadowMap",(e=>e.shadowMap.depthTexture)),new o.e("depthMap",(e=>e.depth?.attachment))),i.constants.add("sampleValue","float",p);const c=e.index===h.j.CONTEXT?"vec2":"float";return t.outputs.add("sampleCount",c),i.main.add(a.H`
    sampleCount = ${c}(0.0);

    vec3 uvzShadow = calculateUVZShadowFromDepth(uv, textureSize(shadowMap,0), depthMap);
    if (uvzShadow.z < 0.0) {
      return;
    }

    // The shadow map sampler returns a value between 0 and 1, we take the midpoint as we count discrete samples
    bool shadow = readShadowMapUVZ(uvzShadow, shadowMap) > 0.5;

    if (shadow) {
      sampleCount = ${c}(sampleValue); // Add 1 to the sample count
    }
  `),t}const _=new c.T,f=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastMaxSamples:d,build:m},Symbol.toStringTag,{value:"Module"}))},33011:function(e,t,i){i.d(t,{S:function(){return l},b:function(){return o}});var r=i(17904),s=i(48857),n=i(80518),a=i(15150);function o(e){const t=new a.kG,{fragment:i}=t;t.include(r.k);const o=e.index===n.j.CONTEXT?"vec2":"float",l="value";return t.outputs.add(l,o),i.main.add(s.H`${l} = ${o}(0.0);`),t}const l=Object.freeze(Object.defineProperty({__proto__:null,build:o},Symbol.toStringTag,{value:"Module"}))},89145:function(e,t,i){i.d(t,{S:function(){return g},a:function(){return T},b:function(){return C}});var r=i(41788),s=i(27583),n=i(17904),a=i(34630),o=i(77983),l=i(19155),c=i(2013),h=i(85119),u=i(48857),d=i(34709),p=i(55244),m=i(65718),_=i(74826),f=i(15150);class g extends _.K{constructor(e){super(),this._data=e,this.sampleScale=(0,r.Ue)(),this.opacityFromElevation=1,this.gradientColor=(0,s.d9)(v),this.thresholdColor=(0,s.d9)(b),this.bandedGradientColor=(0,s.d9)(w),this.bandSize=.1,this.threshold=.5}get shadowCastMap(){return this._data.shadowCastTexture}}const y=50/255,v=(0,s.al)(0,0,1,.7),b=(0,s.al)(1,0,0,.7),w=(0,s.al)(y,y,y,.7);function C(e){const t=new f.kG,i=t.fragment;t.include(o.GZ),t.include(n.k);const{visualization:r}=e;i.constants.add("inverseSampleValue","float",p.S),i.uniforms.add(new d.A("shadowCastMap",(e=>e.shadowCastMap)),new l.A("sampleScale",(e=>e.sampleScale)),new h.p("opacityFromElevation",(e=>e.opacityFromElevation)));const s=r===m.w.Threshold,_=r===m.w.ThresholdAndGradient,g=r===m.w.BandedGradient;switch(_&&i.include(a.m),r){case m.w.Gradient:i.uniforms.add(new c.N("uColor",(e=>(0,a.p)(x,e.gradientColor))));break;case m.w.BandedGradient:i.uniforms.add(new c.N("uColor",(e=>(0,a.p)(x,e.bandedGradientColor))),new h.p("bandSize",(e=>e.bandSize)));break;case m.w.ThresholdAndGradient:i.uniforms.add(new c.N("uColor",(e=>(0,a.p)(x,e.thresholdColor))),new c.N("gradientColor",(e=>(0,a.p)(x,e.gradientColor))),new h.p("threshold",(e=>e.threshold)));break;case m.w.Threshold:i.uniforms.add(new c.N("uColor",(e=>(0,a.p)(x,e.thresholdColor))),new h.p("threshold",(e=>e.threshold)))}const{type:y,selector:v,thresholdStrengthSelector:b}=_?{type:"vec2",selector:"rg",thresholdStrengthSelector:"strength.x"}:{type:"float",selector:"r",thresholdStrengthSelector:"strength"};return i.main.add(u.H`
    ${y} numSamples = texture(shadowCastMap, uv).${v} * inverseSampleValue;

    fragColor = vec4(0.0);

    // early out if we do not have any samples in one or more channels
    if (dot(numSamples, ${y}(1)) < 1.0) {
      return;
    }

    // sampleScale is the number of total samples taken, so this brings strength to a 0-1 range.
    // note that sampleScale is always a vec2 even if we have only the primary channel.
    ${y} strength = numSamples * sampleScale.${v};

    // in threshold mode, step the strength to 0 if we are at or below the threshold, 1 otherwise.
    ${(0,u.If)(s||_,u.H`
      ${b} = 1.0 - step(${b}, threshold);
    `)}

    // bail out if we are below the threshold
    ${(0,u.If)(s,u.H`if (${b} == 0.0) { return; }`)}

    ${(0,u.If)(g,u.H`strength = ceil(strength / bandSize) * bandSize;`)}

    ${y} attenuation = opacityFromElevation * strength;

    // in ThresholdAndGradient mode we blend the threshold color on top of the gradient color
    fragColor = ${(0,u.If)(_,u.H`blendColorsPremultiplied(uColor * attenuation.r, gradientColor * attenuation.g)`,u.H`uColor * attenuation`)};
  `),t}const x=(0,s.Ue)(),T=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastVisualizePassParameters:g,build:C},Symbol.toStringTag,{value:"Module"}))},49790:function(e,t,i){i.d(t,{S:function(){return w},b:function(){return v}});var r=i(24910),s=i(82846),n=i(68593),a=i(17904),o=i(84201),l=i(73263),c=i(45701),h=i(87688),u=i(2013),d=i(85119),p=i(48857),m=i(71063),_=i(11089),f=i(29234),g=i(79262),y=i(15150);function v(){const e=new y.kG;e.include(o.V),e.include(l.v),e.include(a.k),e.include(n.R);const t=e.fragment;return t.include(c.n),t.uniforms.add(new _.j("shadowMapExcludingHighlight",(e=>e.shadowMap.getSnapshot(g.i.ExcludeHighlight))),new _.j("shadowMapHighlight",(e=>e.shadowMap.getSnapshot(g.i.Highlight))),new m.e("depthMap",(e=>e.depth?.attachment)),new f.T("highlightTexture",(e=>e.highlightTexture)),new u.N("uColor",(e=>e.shadowColor)),new d.p("opacity",(e=>e.shadowOpacity)),new d.p("occludedOpacity",(e=>e.occludedShadowOpacity)),new d.p("terminationFactor",(e=>e.opacityElevation*e.dayNightTerminator)),new h.d("lightingMainDirectionView",(({lighting:e,camera:t})=>(0,r.n)(b,(0,r.t)(b,e.mainLight.direction,t.viewInverseTransposeMatrix))))),t.main.add(p.H`
    ivec2 highlightTextureSize = textureSize(highlightTexture, 0);
    ivec2 highlightIUV = ivec2(uv * vec2(highlightTextureSize));
    uvec2 highlightInfo = texelFetch(highlightTexture, highlightIUV, 0).rg;

    fragColor = vec4(0.0);

    // Calculate bit mask to check if pixel is highlit unoccluded at any level
    uint ored = (highlightInfo.r << 0) | (highlightInfo.g << 8);

    bool visiblyHighlighted = ((ored & ~(ored >> 1)) & (1u+4u+16u+64u)) != 0u;
    if (visiblyHighlighted) {
      return;
    }

    vec4 currentPixelPos;
    vec3 uvzShadow = calculateUVZShadowAndPixelPosFromDepth(uv, textureSize(shadowMapHighlight,0), depthMap, currentPixelPos);
    if (uvzShadow.z < 0.0) {
      return;
    }

    float shadowHighlightFactor = readShadowMapUVZ(uvzShadow, shadowMapHighlight);
    if (shadowHighlightFactor == 0.0) {
      return;
    }

    float shadowExcludingHighlightFactor = readShadowMapUVZ(uvzShadow, shadowMapExcludingHighlight);

    vec3 normal = normalFromDepth(depthMap, currentPixelPos.xyz, gl_FragCoord.xy, uv);
    bool shaded = dot(normal, lightingMainDirectionView) < ${p.H.float(.025)};

    float occludedFactor = max(shadowExcludingHighlightFactor, shaded ? 1.0 : 0.0);
    float fragOpacity = mix(opacity, occludedOpacity, occludedFactor);
    fragColor = vec4(uColor.rgb, uColor.a * fragOpacity * terminationFactor);
  `),e}const b=(0,s.Ue)(),w=Object.freeze(Object.defineProperty({__proto__:null,build:v},Symbol.toStringTag,{value:"Module"}))},66696:function(e,t,i){i.d(t,{S:function(){return y},a:function(){return w},b:function(){return v},c:function(){return b}});var r=i(41788),s=i(82846),n=i(35286),a=i(2679),o=i(32179),l=i(19155),c=i(87688),h=i(9535),u=i(85119),d=i(48857),p=i(18489),m=i(34709),_=i(52061),f=i(74826),g=i(15150);class y extends f.K{constructor(){super(...arguments),this.texV=(0,r.Ue)(),this.altitudeFade=0,this.innerScale=0,this.undergroundFadeAlpha=0,this.silhouette=new v}}class v{constructor(){this.center=(0,s.Ue)(),this.v1=(0,s.Ue)(),this.v2=(0,s.Ue)()}}function b(e){const t=new g.kG,{vertex:i,fragment:r}=t;if((0,o.Pe)(i),e.geometry===n.n.Underground)t.attributes.add(_.T.POSITION,"vec2"),t.varyings.add("color","vec4"),i.uniforms.add(new c.d("cameraPosition",(e=>e.camera.eye)),new u.p("undergroundFadeAlpha",(e=>e.undergroundFadeAlpha))),i.main.add(d.H`float ndotl = dot(normalize(cameraPosition), mainLightDirection);
float lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));
color = vec4(vec3(lighting), undergroundFadeAlpha);
gl_Position = vec4(position.xy, 1.0, 1.0);`),r.main.add(d.H`fragColor = color;`);else{t.include(a.w,e),t.attributes.add(_.T.POSITION,"vec3"),t.varyings.add("vtc","vec2"),t.varyings.add("falloff","float");const s=e.geometry===n.n.Cylinder;i.uniforms.add(new p.C("proj",(e=>e.camera.projectionMatrix)),new p.C("view",(e=>e.camera.viewMatrix))),s||(t.varyings.add("innerFactor","float"),i.uniforms.add(new h.J("silCircleCenter",(e=>e.silhouette.center))),i.uniforms.add(new h.J("silCircleV1",(e=>e.silhouette.v1))),i.uniforms.add(new h.J("silCircleV2",(e=>e.silhouette.v2))),i.uniforms.add(new l.A("texV",(e=>e.texV))),i.uniforms.add(new u.p("innerScale",(e=>e.innerScale))));const o=6.2831853,c=1/128;i.main.add(d.H`
      ${s?d.H`
      vec3 pos = position;
      float ndotl = mainLightDirection.z;
      vtc = vec2(0.0, position.z + 0.05);`:d.H`
      innerFactor = clamp(-position.z, 0.0, 1.0);
      float scale = position.y * (1.0 + innerFactor * innerScale);
      float phi = position.x * ${d.H.float(o*c)} + 1.0;
      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;
      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), mainLightDirection);
      vtc.x = position.x  * ${d.H.float(c)};
      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;
      `}
      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

		  gl_Position = transformPosition(proj, view, pos);
		  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane
	  `),r.uniforms.add(new m.A("tex",(e=>e.texture))),s||r.uniforms.add(new u.p("altitudeFade",(e=>e.altitudeFade))),r.main.add(d.H`
			vec4 atmosphereColor = texture(tex, vtc) * falloff;
      ${s?d.H`fragColor = atmosphereColor;`:d.H`
			vec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);
			fragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));`}`)}return t}const w=Object.freeze(Object.defineProperty({__proto__:null,SilhouetteCircle:v,SimpleAtmospherePassParameters:y,build:b},Symbol.toStringTag,{value:"Module"}))},92515:function(e,t,i){i.d(t,{S:function(){return p},b:function(){return u}});var r=i(31865),s=i(10934),n=i(23027),a=i(13663),o=i(48857),l=i(95334),c=i(52061),h=i(15150);function u(){const e=new h.kG;return e.attributes.add(c.T.POSITION,"vec3"),e.attributes.add(c.T.COLOR,"vec4"),e.attributes.add(c.T.SIZE,"float"),e.varyings.add("vcolor","vec4"),e.varyings.add("vsize","float"),e.vertex.uniforms.add(new l.g("transform",((e,t)=>function(e,t){const i=24e-8;return(0,r.JG)(d,t.camera.projectionMatrix),d[10]=i-1,d[11]=-1,d[14]=(i-2)*t.camera.near,(0,r.Jp)(d,d,t.camera.viewMatrix),(0,r.Jp)(d,d,e.modelMatrix)}(e,t))),new n.$("viewport",(e=>e.camera.fullViewport)),new a.z("pixelRatio",(e=>e.camera.pixelRatio))),e.vertex.main.add(o.H`gl_Position = transform * vec4(position, 0);
vcolor = color / 1.2;
vsize = size * 5.0 * pixelRatio;
gl_PointSize = vsize;`),e.fragment.main.add(o.H`float cap = 0.7;
float scale = 1.0 / cap;
float helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);
float alpha = clamp((cap - helper) * scale, 0.0, 1.0);
float intensity = alpha * alpha * alpha;
if (vsize < 3.0) {
intensity *= 0.5;
}
fragColor = vec4(vcolor.xyz, intensity);`),e}const d=(0,s.Ue)(),p=Object.freeze(Object.defineProperty({__proto__:null,build:u},Symbol.toStringTag,{value:"Module"}))},91708:function(e,t,i){i.d(t,{T:function(){return F},a:function(){return V},b:function(){return N}});var r=i(31865),s=i(10934),n=i(24910),a=i(82846),o=i(61796),l=i(9779),c=i(70662),h=i(41044),u=i(27349),d=i(2679),p=i(57716),m=i(31839),_=i(82630),f=i(37452),g=i(40122),y=i(24807),v=i(11713),b=i(19065),w=i(32179),C=i(13212),x=i(42510),T=i(36351),S=i(76144),M=i(6397),E=i(96541),R=i(87688),P=i(48857),A=i(10146),O=i(71063),D=i(52061),I=i(15150),L=i(64801);class F extends M.uS{}function N(e){const t=new I.kG,{attributes:i,vertex:s,fragment:a,varyings:F}=t;i.add(D.T.POSITION,"vec3"),t.include(p.O,e),t.include(m.D,e);const N=()=>{t.include(C.n,e),s.code.add(P.H`vec3 getNormal() {
float z = 1.0 - abs(normalCompressed.x) - abs(normalCompressed.y);
vec3 n = vec3(normalCompressed + vec2(normalCompressed.x >= 0.0 ? 1.0 : -1.0,
normalCompressed.y >= 0.0 ? 1.0 : -1.0) * min(z, 0.0), z);
return normalize(n);
}`)};(0,E.Sv)(s,e),t.include(d.w,e);const{output:V,pbrMode:k,overlayMode:B,tileBorders:z,spherical:G,transparencyMode:q,screenSizePerspective:Z,overlayEnabled:j}=e,W=q===l.w.InvisibleWithDraped||q===l.w.Invisible,$=j&&W;switch(V){case h.H_.ColorEmission:case h.H_.Color:{t.include(M.EK,e),t.include(b.XP,e),j&&(e.pbrMode=k===x.f7.Simplified?x.f7.TerrainWithWater:x.f7.Water,t.include(S.yl,e),e.pbrMode=k);const i=B===S.gT.EnabledWithWater;i&&t.include(_.M,e),F.add("vnormal","vec3"),F.add("vpos","vec3",{invariant:!0}),F.add("vup","vec3"),N(),Z&&(0,E._8)(s);const l=e.receiveShadows&&!e.renderOccluded;l&&t.include(c.qj,e),Z&&(F.add("screenSizeDistanceToCamera","float"),F.add("screenSizeCosAngle","float")),s.main.add(P.H`
          vpos = position;
          vec3 positionWorld = position + localOrigin;
          gl_Position = transformPosition(proj, view, vpos);
          vnormal = getNormal();
          vup = getLocalUp(position, localOrigin);
          ${(0,P.If)(i,P.H`forwardVertexTangent(vnormal);`)}

          forwardTextureCoordinatesWithTransform(uv0);
          ${(0,P.If)(j,"setOverlayVTC(uv0);")}
          ${(0,P.If)(z,"forwardTextureCoordinates();")}
          ${(0,P.If)(Z,P.H`vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;
                 screenSizeDistanceToCamera = length(viewPos);
                 vec3 viewSpaceNormal = (viewNormal * vec4(normalize(positionWorld), 1.0)).xyz;
                 screenSizeCosAngle = abs(viewSpaceNormal.z);`)}
          ${(0,P.If)(l,"forwardLinearDepth();")}`),a.include(u.f5,e),t.include(b.XP,e),a.include(v.K,e),t.include(T.XE,e),(0,E.hY)(a,e),(0,b.PN)(a),(0,b.sC)(a),a.uniforms.add(s.uniforms.get("localOrigin"),new R.d("viewDirection",(({camera:e})=>(0,n.n)(H,(0,n.i)(H,e.viewMatrix[12],e.viewMatrix[13],e.viewMatrix[14]))))),i&&a.uniforms.add(new O.e("ovWaterTex",(e=>e.overlay?.getTexture(o.D.WaterNormal))),new A.K("view",(({origin:e},{camera:t})=>(0,r.Iu)(U,t.viewMatrix,e))));const h=.2;a.code.add(P.H`float lum(vec3 c) {
return (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;
}`),(0,w.Pe)(a),(0,w.F1)(a),a.main.add(P.H`
          vec3 normal = normalize(vnormal);
          float vndl = dot(normal, mainLightDirection);

          float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl*2.5, 0.0, 1.0));
          float shadow = ${l?"max(lightingGlobalFactor * (1.0 - additionalAmbientScale), readShadowMap(vpos, linearDepth))":G?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0"};

          float ssao = evaluateAmbientOcclusionInverse();
          vec4 tileColor = getTileColor();

          ${(0,P.If)(j,P.H`vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
                   vec4 overlayColor = overlayOpacity * overlayColorOpaque;
                   ${(0,P.If)(W,`if (overlayColor.a < ${P.H.float(L.e)}) { discard; }`)}
                   vec4 groundColor = tileColor;
                   tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;`)}

          // If combined alpha is 0 we can discard pixel. The performance impact by having a discard here
          // is neglectable because terrain typically renders first into the framebuffer.
          if(tileColor.a < ${P.H.float(L.e)}) {
            discard;
          }

          bool sliced = rejectBySlice(vpos);
          if (sliced) {
            tileColor *= ${P.H.float(h)};
          }

          vec3 albedo = tileColor.rgb;

          // heuristic shading function used in the old terrain, now used to add ambient lighting

          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

          ${k===x.f7.Simplified||k===x.f7.TerrainWithWater?P.H`fragColor = vec4(evaluatePBRSimplifiedLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight, normalize(vpos - cameraPosition), vup), tileColor.a);`:P.H`fragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);`}
          ${(0,P.If)(i,P.H`vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);
                   float waterNormalLength = length(overlayWaterMask);
                   if (waterNormalLength > 0.95) {
                     mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);
                     vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);
                     vec4 viewPosition = view*vec4(vpos, 1.0);
                     vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - cameraPosition), shadow, vnormal, tbnMatrix, viewPosition.xyz,  vpos + localOrigin);
                     vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                     float opacity = sliced ? ${P.H.float(h)} : 1.0;
                     // un-gamma the ground color to mix in linear space
                     fragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w) * opacity;
                   }`)}
          ${(0,P.If)(Z,P.H`float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, vec4(0.0));
                   if (perspectiveScale <= 0.25) {
                     fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);
                   } else if (perspectiveScale <= 0.5) {
                     fragColor = mix(fragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);
                   } else if (perspectiveScale >= 0.99) {
                     fragColor = mix(fragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);
                   } else {
                     fragColor = mix(fragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);
                   }`)}
          ${(0,P.If)(e.visualizeNormals,G?P.H`
                  vec3 localUp = normalize(vpos + localOrigin);
                  vec3 right = normalize(cross(vec3(0.0, 0.0, 1.0), localUp));
                  vec3 forward = normalize(cross(localUp, right));
                  mat3 tbn = mat3(right, forward, localUp);
                  vec3 tNormal = normalize(normal * tbn);
                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);`:P.H`
                  vec3 tNormal = normalize(normal);
                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);`)}
          ${(0,P.If)(z,P.H`vec2 dVuv = fwidth(vuv0);
                 vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv0, 1.0 - vuv0));
                 float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);
                 fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);`)}
          fragColor = applySlice(fragColor, vpos);`)}break;case h.H_.Depth:$&&t.include(S.yl,e),s.main.add(P.H`
        ${(0,P.If)($,"setOverlayVTC(uv0);")}
        gl_Position = transformPosition(proj, view, position);`),a.main.add(`${(0,P.If)($,`if (getCombinedOverlayColor().a < ${P.H.float(L.e)}) discard;`)}`);break;case h.H_.Shadow:case h.H_.ShadowHighlight:case h.H_.ShadowExcludeHighlight:case h.H_.ViewshedShadow:t.include(f.F,e),(0,c.Lm)(t),(0,c.Zu)(t),s.main.add(P.H`gl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);`),a.main.add(P.H`outputDepth(linearDepth);`);break;case h.H_.Normal:$&&t.include(S.yl,e),F.add("vnormal","vec3"),(0,E._8)(s),N(),s.main.add(P.H`
        ${(0,P.If)($,"setOverlayVTC(uv0);")}
        gl_Position = transformPosition(proj, view, position);
        vnormal = normalize((viewNormal * vec4(getNormal(), 1.0)).xyz);`),a.main.add(P.H`
        ${(0,P.If)($,`if (getCombinedOverlayColor().a < ${P.H.float(L.e)}) discard;`)}
        vec3 normal = normalize(vnormal);
        if (gl_FrontFacing == false) {
          normal = -normal;
        }
        fragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);`);break;case h.H_.Highlight:j&&(t.include(S.yl,e),t.include(y._,e)),s.main.add(P.H`
        ${(0,P.If)(j,"setOverlayVTC(uv0);")}
        gl_Position = transformPosition(proj, view, position);`),t.include(g.b,e),a.main.add(P.H`
        ${(0,P.If)(j,P.H`
           calculateOcclusionAndOutputHighlight(getAllOverlayHighlightValuesEncoded());`,"calculateOcclusionAndOutputHighlight();")}
      `)}if(V===h.H_.ObjectAndLayerIdColor)if(j)e.pbrMode=x.f7.Disabled,t.include(S.yl,e),e.pbrMode=k,s.main.add(P.H`gl_Position = transformPosition(proj, view, position);
setOverlayVTC(uv0);`),a.main.add(P.H`fragColor = getOverlayColorTexel();`);else{const e=q===l.w.Opaque;s.main.add(P.H`${(0,P.If)(e,"gl_Position = transformPosition(proj, view, position);")}`),a.main.add(P.H`fragColor = vec4(0.0);`)}return t}const U=(0,s.Ue)(),H=(0,a.Ue)(),V=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:F,build:N},Symbol.toStringTag,{value:"Module"}))},32222:function(e,t,i){function r(e,t,i=3,r=i){const s=t.length/r;let n=0,a=0;for(let o=0;o<s;++o)e[n]=t[a],e[n+1]=t[a+1],e[n+2]=t[a+2],n+=i,a+=r}function s(e,t,i,r,s){const n=e.typedBuffer,a=e.typedBufferStride,o=s?.count??e.count;let l=(s?.dstIndex??0)*a;for(let e=0;e<o;++e)n[l]=t,n[l+1]=i,n[l+2]=r,l+=a}i.d(t,{c:function(){return r},f:function(){return s}});Object.freeze(Object.defineProperty({__proto__:null,copy:r,copyView:function(e,t){r(e.typedBuffer,t.typedBuffer,e.typedBufferStride,t.typedBufferStride)},fill:s},Symbol.toStringTag,{value:"Module"}))},12019:function(e,t,i){i.d(t,{n:function(){return s}});var r=i(81001);const s=()=>r.default.respectPrefersReducedMotion&&window.matchMedia("(prefers-reduced-motion: reduce)").matches},34058:function(e,t,i){i.d(t,{D:function(){return s}});var r=i(9713);function s(e){e?.writtenProperties&&e.writtenProperties.forEach((({target:e,propName:t,newOrigin:i})=>{(0,r.l)(e)&&i&&e.originOf(t)!==i&&e.updateOrigin(t,i)}))}},11034:function(e,t,i){function r(){const e=new Float32Array(9);return e[0]=1,e[4]=1,e[8]=1,e}function s(e){const t=new Float32Array(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}function n(e,t,i,r,s,n,a,o,l){const c=new Float32Array(9);return c[0]=e,c[1]=t,c[2]=i,c[3]=r,c[4]=s,c[5]=n,c[6]=a,c[7]=o,c[8]=l,c}i.d(t,{Ue:function(){return r},al:function(){return n},d9:function(){return s}});Object.freeze(Object.defineProperty({__proto__:null,clone:s,create:r,fromValues:n},Symbol.toStringTag,{value:"Module"}))},43280:function(e,t,i){function r(){return new Float32Array(4)}function s(e){const t=new Float32Array(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function n(e,t,i,r){const s=new Float32Array(4);return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}function a(){return r()}function o(){return n(1,1,1,1)}function l(){return n(1,0,0,0)}function c(){return n(0,1,0,0)}function h(){return n(0,0,1,0)}function u(){return n(0,0,0,1)}i.d(t,{AG:function(){return d},al:function(){return n},d9:function(){return s}});const d=a(),p=o(),m=l(),_=c(),f=h(),g=u();Object.freeze(Object.defineProperty({__proto__:null,ONES:p,UNIT_W:g,UNIT_X:m,UNIT_Y:_,UNIT_Z:f,ZEROS:d,clone:s,create:r,fromValues:n,ones:o,unitW:u,unitX:l,unitY:c,unitZ:h,zeros:a},Symbol.toStringTag,{value:"Module"}))},83986:function(e,t,i){i.d(t,{T:function(){return d},w:function(){return l}});var r=i(29292),s=i(43254),n=i(50702),a=i(93568),o=i(90403);function l(e,t,i){const r=i?.createCollection?.()??new s.Z,n=i?.recycleItems?new c:null,a=(e,t=0)=>{if(!e?.length)return;const i=r.splice(t,e.length);n?n.processRemoved(e):i.forEach(u)},l=(e,i=0)=>{if(!e?.length)return;const s=[];for(const i of e){const e=n?.use(i);if(e)s.push(e);else{const e=t(i);n?.register(i,e),s.push(e)}}r.addMany(s,i)},h=(0,o.on)(e,"after-splice",(({added:e,start:t,removed:i})=>{a(i,t),l(e,t)}),{sync:!0,onListenerRemove:e=>a(e.items),onListenerAdd:e=>l(e.items)});return r.addHandles(h),r}class c{constructor(){this._originalToMapped=new Map,this._removedItemCandidates=new Set,this._garbageCollectionQueued=!1}processRemoved(e){if(!e?.length)return;const{_removedItemCandidates:t}=this;for(const i of e)this._getItem(i)?.markRemoved()&&(t.add(i),this._queueGarbageCollection())}use(e){const t=this._getItem(e);return t&&(t.removed=!1),t?.item}register(e,t){this._originalToMapped.set(e,new h(t))}_getItem(e){return this._originalToMapped.get(e)}_queueGarbageCollection(){this._garbageCollectionQueued||(this._garbageCollectionQueued=!0,queueMicrotask((()=>this._garbageCollectCandidates())))}_garbageCollectCandidates(){this._garbageCollectionQueued=!1;const{_removedItemCandidates:e}=this,t=Array.from(e);e.clear(),t.forEach((e=>this._garbageCollectIfRemoved(e)))}_garbageCollectIfRemoved(e){const{_originalToMapped:t}=this,i=this._getItem(e);i?.removed&&(u(i.item),t.delete(e))}}class h{constructor(e){this.item=e,this.removed=!1}markRemoved(){return this.removed=!0,!0}}function u(e){"object"==typeof e&&e&&("destroy"in e&&"function"==typeof e.destroy?e.destroy():(0,n.C7)(e))}function d(e,t,i){const o=new s.Z,c=l(e,(e=>(0,r.vr)((async i=>{const r=await t(e,i);if((0,a.Hc)(i))throw u(r),(0,a.zE)();return r}))),i),h=()=>null,d=async e=>{const t=await e.promise,i=c.indexOf(e);i<0||o.splice(i,1,t)};o.addMany(c.items.map(h));for(const e of c)(0,a.R8)(d(e));const p=c.on("after-splice",(({added:e,start:t,deleteCount:i})=>{const r=o.splice(t,i);for(const e of r)u(e);if(e?.length){o.addMany(e.map(h),t);for(const t of e)(0,a.R8)(d(t))}}));return o.addHandles([(0,n.ed)(c),p]),o}},51067:function(e,t,i){i.d(t,{L4:function(){return x},LO:function(){return d},Qv:function(){return h},Rd:function(){return p},Ud:function(){return g},VG:function(){return u},Wv:function(){return _},Zv:function(){return v},aC:function(){return b},h9:function(){return f},ld:function(){return w},mg:function(){return m},q6:function(){return y},sS:function(){return E},yc:function(){return C}});var r=i(46965),s=i(95437),n=i(99574),a=i(1925),o=i(29138),l=i(26636),c=i(40030);function h(e,t,i){return e.units[t][i]}function u(e,t,i,r=2,s="abbr"){return`${(0,c.uf)(t,{minimumFractionDigits:r,maximumFractionDigits:r,signDisplay:t>0?"never":"exceptZero"})} ${h(e,i,s)}`}function d(e,t,i,r=2,s="abbr"){return`${(0,c.uf)(t,{minimumFractionDigits:r,maximumFractionDigits:r,signDisplay:"exceptZero"})} ${h(e,i,s)}`}function p(e,t,i,r=2,s="abbr"){const n=(0,l.Y8)(t,i);return u(e,(0,l.En)(t,i,n),n,r,s)}function m(e,t,i,r=2,s="abbr"){const n=(0,l.Y8)(t,i);return d(e,(0,l.En)(t,i,n),n,r,s)}function _(e,t,i,r=2,s="abbr"){const n=(0,l.Dw)(t,i);return u(e,(0,l.En)(t,i,n),n,r,s)}function f(e,t,i,r=2,s="abbr"){const n=(0,l.Dw)(t,i);return d(e,(0,l.En)(t,i,n),n,r,s)}function g(e,t,i,r=2,s="abbr"){const n=(0,l.Q7)(t,i);return u(e,(0,l.En)(t,i,n),n,r,s)}function y(e,t,i,r=2,s="abbr"){const n=(0,l.Q7)(t,i);return d(e,(0,l.En)(t,i,n),n,r,s)}function v(e,t,i,r=2,s="abbr"){const n=(0,l.jl)(t,i);return u(e,(0,l.En)(t,i,n),n,r,s)}function b(e,t,i,r=2,s="abbr"){const n=(0,l.jl)(t,i);return d(e,(0,l.En)(t,i,n),n,r,s)}function w(e,t,i,r=2,s="abbr"){const n=(0,l.ZI)(t,i);return u(e,(0,l.En)(t,i,n),n,r,s)}function C(e,t,i,r=2,s="abbr"){const n=(0,l.LV)(t,i);return u(e,(0,l.En)(t,i,n),n,r,s)}function x(e,t,i,r,n,o=s.BV,h=!0){let u=o.normalize((0,a.hw)((0,l.En)(e,t,"degrees"),i,r),0,h);const d=((e,t)=>({style:"unit",unitDisplay:"narrow",unit:"degree",maximumFractionDigits:t,minimumFractionDigits:t,signDisplay:e>0?"never":"exceptZero"}))(u,n??2);return u=S(u,d),(0,c.uf)(u,d)}const T=new Map;function S(e,t){const i=JSON.stringify(t);let r=T.get(i);return r||(r=new Intl.NumberFormat("en-US",t),T.set(i,r)),/^[-+]?360\.?0*?$/.test(r.format(e))?0:e}const M=["B","kB","MB","GB","TB"];function E(e,t){let i=0===(t=Math.round(t))?0:Math.floor(Math.log(t)/Math.log(r.Y.KILOBYTES));i=(0,n.uZ)(i,0,M.length-1);const s=(0,c.uf)(t/r.Y.KILOBYTES**i,{maximumFractionDigits:2});return(0,o.gx)(e.units.bytes[M[i]],{fileSize:s})}},37580:function(e,t,i){i.d(t,{q:function(){return l}});var r=i(3480),s=i(50702),n=i(96711),a=i(93568),o=i(82592);class l{constructor(e,t,i,r,s={}){this._mainMethod=t,this._transferLists=i,this._listeners=[],this._promise=(0,o.bA)(e,{...s,schedule:r}).then((e=>{if(void 0===this._thread){this._thread=e,this._promise=null,s.hasInitialize&&this.broadcast({},"initialize");for(const e of this._listeners)this._connectListener(e)}else e.close()})),this._promise.catch((t=>n.Z.getLogger("esri.core.workers.WorkerHandle").error(`Failed to initialize ${e} worker: ${t}`)))}on(e,t){const i={removed:!1,eventName:e,callback:t,threadHandle:null};return this._listeners.push(i),this._connectListener(i),(0,s.kB)((()=>{i.removed=!0,(0,r.Od)(this._listeners,i),this._thread&&null!=i.threadHandle&&i.threadHandle.remove()}))}destroy(){this._thread&&(this._thread.close(),this._thread=null),this._promise=null,this._listeners.length=0,this._transferLists={}}invoke(e,t,i){return this.invokeMethod(this._mainMethod,e,t,i)}invokeMethod(e,t,i,r){if(this._thread){const s=this._transferLists[e],n=s?s(t):[];return this._thread.invoke(e,t,{transferList:n,signal:i,priority:r})}return this._promise?this._promise.then((()=>((0,a.k_)(i),this.invokeMethod(e,t,i)))):Promise.reject(null)}broadcast(e,t){return this._thread?Promise.all(this._thread.broadcast(t,e)).then((()=>{})):this._promise?this._promise.then((()=>this.broadcast(e,t))):Promise.reject()}get promise(){return this._promise}_connectListener(e){this._thread&&this._thread.on(e.eventName,e.callback).then((t=>{e.removed||(e.threadHandle=t)}))}}},5226:function(e,t,i){i.d(t,{BR:function(){return w},E2:function(){return A},Is:function(){return T},Kf:function(){return b},NE:function(){return M},P0:function(){return v},Tz:function(){return P},Ue:function(){return d},bk:function(){return m},ej:function(){return C},id:function(){return x},pb:function(){return y},pt:function(){return f},qf:function(){return p},rF:function(){return S},yS:function(){return R}});var r=i(31865),s=i(24910),n=i(82846),a=i(47925),o=i(45213),l=i(70331),c=i(93070),h=i(89420),u=i(69055);function d(e){const{value:t,operations:i}=e;return{operations:i,value:i.create(t)}}function p(e,t,i){return e.operations.setExtent(e.value,t,i.value),i}function m(e,t){return e.operations.getExtent(e.value,t),t}function _(e,t,i=function(e){return{operations:e,value:e.create()}}(e)){return i.operations=e,e.copy(t,i.value),i}function f(e){return _(u.s,(0,u.f)(0,0,0,(0,a.Iu)(e).radius))}const g=2**50;function y(){return _(h.b,(0,h.f)([0,0,0],[g,0,0],[0,g,0]))}function v(e,t,i){return e.operations.axisAt(e.value,t,c.R.Z,i)}function b(e,t,i,r){return e.operations.axisAt(e.value,t,i,r)}function w(e,t,i){return e.operations.intersectRay(e.value,t,i)}function C(e,t,i){return e.operations.intersectRayClosestSilhouette(e.value,t,i)}function x(e,t){return e.operations.altitudeAt(e.value,t)}function T(e,t,i,r){return e.operations.setAltitudeAt(e.value,t,i,r)}function S(e,t,i,n){return t!==n&&(0,r.JG)(n,t),(0,s.i)(E,n[12],n[13],n[14]),T(e,E,i,E),n[12]=E[0],n[13]=E[1],n[14]=E[2],n}function M(e,t,i){return e.operations.elevate(e.value,t,i.value)}const E=(0,n.Ue)();function R(e,t,i,r,n){return n[0]=(0,s.e)(e,t),n[1]=(0,s.e)(e,i),n[2]=(0,s.e)(e,r),n}function P(e,t,i,r,n){(0,s.c)(i,e),(0,s.c)(O,t),(0,s.n)(O,O),(0,s.h)(r,O,i),(0,s.h)(n,r,i)}function A(e,t){return e?(0,l.rS)(t):t.isGeographic?o.Z.PlateCarree:t}const O=(0,n.Ue)()},38700:function(e,t,i){var r,s,n,a,o,l,c,h,u,d,p,m,_,f,g;i.d(t,{$1:function(){return c},AQ:function(){return l},Em:function(){return v},Lz:function(){return n},MB:function(){return r},Nl:function(){return g},Q3:function(){return y},Qd:function(){return m},aw:function(){return f},jE:function(){return _},l7:function(){return s},xL:function(){return a}}),function(e){e.U8="U8",e.I8="I8",e.U16="U16",e.I16="I16",e.U32="U32",e.I32="I32",e.F32="F32",e.F64="F64",e.Utf8String="Utf8String",e.NotSet="NotSet"}(r||(r={})),function(e){e.Png="Png",e.Jpeg="Jpeg",e.Dds="Dds",e.Raw="Raw",e.Dxt1="Dxt1",e.Dxt5="Dxt5",e.Bc7="Bc7",e.Basis="Basis",e.Etc1="Etc1",e.Etc2="Etc2",e.Astc="Astc",e.Pvrtc="Pvrtc",e.NotSet="NotSet"}(s||(s={})),function(e){e.Position="Position",e.Normal="Normal",e.TexCoord="TexCoord",e.Color="Color",e.Tangent="Tangent",e.FeatureIndex="FeatureIndex",e.UvRegion="UvRegion",e.FeatureVariable="FeatureVariable",e.NotSet="NotSet"}(n||(n={})),function(e){e.Opaque="Opaque",e.Mask="Mask",e.Blend="Blend"}(a||(a={})),function(e){e.None="None",e.Mask="Mask",e.Alpha="Alpha",e.PreMultAlpha="PreMultAlpha",e.NotSet="NotSet"}(o||(o={})),function(e){e.Points="Points",e.Lines="Lines",e.LineStrip="LineStrip",e.Triangles="Triangles",e.TriangleStrip="TriangleStrip",e.NotSet="NotSet"}(l||(l={})),function(e){e.None="None",e.WrapXBit="WrapXBit",e.WrapYBit="WrapYBit",e.WrapXy="WrapXy",e.NotSet="NotSet"}(c||(c={})),function(e){e.Linear="Linear",e.Nearest="Nearest",e.NotSet="NotSet"}(h||(h={})),function(e){e.Linear="Linear",e.Nearest="Nearest",e.NearestMipmapNearest="NearestMipmapNearest",e.LinearMipmapNearest="LinearMipmapNearest",e.NearestMipmapLinear="NearestMipmapLinear",e.LinearMipmapLinear="LinearMipmapLinear",e.NotSet="NotSet"}(u||(u={})),function(e){e.FeatureId="FeatureId",e.GlobalUid="GlobalUid",e.UnspecifiedDateTime="UnspecifiedDateTime",e.EcmaIso8601DateTime="EcmaIso8601DateTime",e.EcmaIso8601DateOnly="EcmaIso8601DateOnly",e.TimeOnly="TimeOnly",e.TimeStamp="TimeStamp",e.ColorRgb="ColorRgb",e.ColorRgba="ColorRgba",e.Unrecognized="Unrecognized",e.NotSet="NotSet"}(d||(d={})),function(e){e.Texture="Texture",e.VertexAtrb="VertexAtrb",e.Implicit="Implicit",e.NotSet="NotSet"}(p||(p={})),function(e){e.Front="Front",e.Back="Back",e.None="None",e.NotSet="NotSet"}(m||(m={})),function(e){e.Pbr="Pbr",e.Unlit="Unlit"}(_||(_={})),function(e){e.Rgb8="Rgb8",e.Rgba8="Rgba8",e.R8="R8",e.Bgr8="Bgr8",e.Bgra8="Bgra8",e.Rg8="Rg8",e.Ga8="Ga8",e.Etc1="Etc1",e.Etc2="Etc2",e.Dxt1="Dxt1",e.Dxt5="Dxt5",e.Bc7="Bc7",e.NotSet="NotSet"}(f||(f={})),function(e){e[e.Succeeded=0]="Succeeded",e[e.Failed=1]="Failed",e[e.MissingInputs=2]="MissingInputs"}(g||(g={}));const y=-1,v=-2},78646:function(e,t,i){i.d(t,{d:function(){return r}});const r="OBJECTID"},62535:function(e,t,i){i.d(t,{G$:function(){return p},Tl:function(){return d}});i(61432);var r=i(50702),s=i(96711),n=i(26636),a=i(60508),o=i(47566),l=i(97290);const c=()=>s.Z.getLogger("esri.layers.support.ElevationSampler");class h{queryElevation(e){return p(e.clone(),this)}on(){return(0,r.kB)()}projectIfRequired(e,t){return m(e,t)}}class u extends h{get spatialReference(){return this.extent.spatialReference}constructor(e,t,i){super(),this.tile=e,this.noDataValue=i;const r=e.tile.extent;this.extent=(0,o.HH)(r,t.spatialReference),this.extent.zmin=e.zmin,this.extent.zmax=e.zmax,this._aaExtent=r;const s=(0,n.c9)(t.spatialReference),a=t.lodAt(e.tile.level).resolution*s;this.demResolution={min:a,max:a}}contains(e){const t=this.projectIfRequired(e,this.spatialReference);return null!=t&&this.containsAt(t.x,t.y)}containsAt(e,t){return(0,o.jE)(this._aaExtent,e,t)}elevationAt(e,t){if(!this.containsAt(e,t)){const i=this.extent,r=`${i.xmin}, ${i.ymin}, ${i.xmax}, ${i.ymax}`;return c().warn("#elevationAt()",`Point used to sample elevation (${e}, ${t}) is outside of the sampler extent (${r})`),this.noDataValue}return this.tile.sample(e,t)??this.noDataValue}}class d extends h{get spatialReference(){return this.extent.spatialReference}constructor(e,t,i){let r;super(),"number"==typeof t?(this.noDataValue=t,r=null):(r=t,this.noDataValue=i),this.samplers=r?e.map((e=>new u(e,r,this.noDataValue))):e;const s=this.samplers[0];if(s){this.extent=s.extent.clone();const{min:e,max:t}=s.demResolution;this.demResolution={min:e,max:t};for(let e=1;e<this.samplers.length;e++){const t=this.samplers[e];this.extent.union(t.extent),this.demResolution.min=Math.min(this.demResolution.min,t.demResolution.min),this.demResolution.max=Math.max(this.demResolution.max,t.demResolution.max)}}else this.extent=(0,o.HH)((0,o.Ue)(),r.spatialReference),this.demResolution={min:0,max:0}}elevationAt(e,t){let i,r=!1;for(const s of this.samplers)if(s.containsAt(e,t)&&(r=!0,i=s.elevationAt(e,t),i!==s.noDataValue))return i;return null!=i?i:(r||c().warn("#elevationAt()",`Point used to sample elevation (${e}, ${t}) is outside of the sampler`),this.noDataValue)}}function p(e,t){const i=m(e,t.spatialReference);if(!i)return null;switch(e.type){case"point":!function(e,t,i){e.z=i.elevationAt(t.x,t.y)}(e,i,t);break;case"polyline":!function(e,t,i){_.spatialReference=t.spatialReference;const r=e.hasM&&!e.hasZ;for(let s=0;s<e.paths.length;s++){const n=e.paths[s],a=t.paths[s];for(let e=0;e<n.length;e++){const t=n[e],s=a[e];_.x=s[0],_.y=s[1],r&&(t[3]=t[2]),t[2]=i.elevationAt(_.x,_.y)}}e.hasZ=!0}(e,i,t);break;case"multipoint":!function(e,t,i){_.spatialReference=t.spatialReference;const r=e.hasM&&!e.hasZ;for(let s=0;s<e.points.length;s++){const n=e.points[s],a=t.points[s];_.x=a[0],_.y=a[1],r&&(n[3]=n[2]),n[2]=i.elevationAt(_.x,_.y)}e.hasZ=!0}(e,i,t)}return e}function m(e,t){if(null==e)return null;const i=e.spatialReference;if(i.equals(t))return e;const r=(0,l.iV)(e,t);return r||c().error(`Cannot project geometry spatial reference (wkid:${i.wkid}) to elevation sampler spatial reference (wkid:${t.wkid})`),r}const _=new a.Z},5135:function(e,t,i){i.d(t,{K:function(){return r}});class r{constructor(e,t){this.data=e,this.safeWidth=.99999999*(e.width-1),this.dx=(e.width-1)/(t[2]-t[0]),this.dy=(e.width-1)/(t[3]-t[1]),this.x0=t[0],this.y1=t[3]}}},35857:function(e,t,i){i.d(t,{Z:function(){return d}});var r,s=i(73440),n=i(43254),a=i(63255),o=i(8914),l=(i(96711),i(61432),i(83850),i(88194),i(48023)),c=i(67764),h=i(13132);let u=r=class extends(a.Z.JSONSupportMixin(n.Z.ofType(c.Z))){constructor(e){super(e)}clone(){return new r(this.items.map((e=>e.clone())))}write(e,t){return this.toJSON(t)}toJSON(e){const t=e?.layer?.spatialReference;return t?this.toArray().map((i=>{if(!t.equals(i.spatialReference)){if(!(0,h.canProjectWithoutEngine)(i.spatialReference,t))return e?.messages?.push(new o.Z("scenefilter:unsupported","Scene filters with incompatible spatial references are not supported",{modification:this,spatialReference:e.layer.spatialReference,context:e})),null;const r=new c.Z;(0,h.projectPolygon)(i,r,t),i=r}const r=i.toJSON(e);return delete r.spatialReference,r})).filter((e=>null!=e)):this.toArray().map((t=>t.toJSON(e)))}static fromJSON(e,t){const i=new r;return e.forEach((e=>i.add(c.Z.fromJSON(e,t)))),i}};u=r=(0,s._)([(0,l.j)("esri.layers.support.PolygonCollection")],u);const d=u},22679:function(e,t,i){i.d(t,{FO:function(){return d},W7:function(){return p},addOrUpdateResources:function(){return o},fetchResources:function(){return a},removeAllResources:function(){return c},removeResource:function(){return l}});var r=i(78619),s=i(88194),n=i(95490);async function a(e,t={},i){await e.load(i);const r=(0,n.v_)(e.itemUrl,"resources"),{start:s=1,num:a=10,sortOrder:o="asc",sortField:l="resource"}=t,c={query:{start:s,num:a,sortOrder:o,sortField:l,token:e.apiKey},signal:i?.signal},h=await e.portal.request(r,c);return{total:h.total,nextStart:h.nextStart,resources:h.resources.map((({created:t,size:i,resource:r})=>({created:new Date(t),size:i,resource:e.resourceFromPath(r)})))}}async function o(e,t,i,r){const a=new Map;for(const{resource:e,content:r,compress:n,access:o}of t){if(!e.hasPath())throw new s.Z(`portal-item-resource-${i}:invalid-path`,"Resource does not have a valid path");const[t,l]=h(e.path),c=`${t}/${n??""}/${o??""}`;a.has(c)||a.set(c,{prefix:t,compress:n,access:o,files:[]}),a.get(c).files.push({fileName:l,content:r})}await e.load(r);const o=(0,n.v_)(e.userItemUrl,"add"===i?"addResources":"updateResources");for(const{prefix:t,compress:i,access:s,files:n}of a.values()){const a=25;for(let l=0;l<n.length;l+=a){const c=n.slice(l,l+a),h=new FormData;t&&"."!==t&&h.append("resourcesPrefix",t),i&&h.append("compress","true"),s&&h.append("access",s);let u=0;for(const{fileName:e,content:t}of c)h.append("file"+ ++u,t,e);h.append("f","json"),await e.portal.request(o,{method:"post",body:h,signal:r?.signal})}}}async function l(e,t,i){if(!t.hasPath())throw new s.Z("portal-item-resources-remove:invalid-path","Resource does not have a valid path");await e.load(i);const r=(0,n.v_)(e.userItemUrl,"removeResources");await e.portal.request(r,{method:"post",query:{resource:t.path},signal:i?.signal}),t.portalItem=null}async function c(e,t){await e.load(t);const i=(0,n.v_)(e.userItemUrl,"removeResources");return e.portal.request(i,{method:"post",query:{deleteAll:!0},signal:t?.signal})}function h(e){const t=e.lastIndexOf("/");return-1===t?[".",e]:[e.slice(0,t),e.slice(t+1)]}function u(e){const[t,i]=function(e){const t=(0,n.Ml)(e);return null==t?[e,""]:[e.slice(0,e.length-t.length-1),`.${t}`]}(e),[r,s]=h(t);return[r,s,i]}async function d(e){return"blob"===e.type?e.blob:"json"===e.type?new Blob([e.jsonString],{type:"application/json"}):(await(0,r.Z)(e.url,{responseType:"blob"})).data}function p(e,t){if(!e.hasPath())return null;const[i,,r]=u(e.path);return e.portalItem.resourceFromPath((0,n.v_)(i,t+r))}},74935:function(e,t,i){i.d(t,{i:function(){return h}});var r=i(78619),s=i(95226),n=i(90756),a=i(56545),o=i(93333),l=i(8084);const c=(0,s.se)(l.Z);async function h(e,t,i){t=c(t);const s=(0,a.en)(e),l={...s.query,f:"json",...t.toJSON()},h=t.outSpatialReference,u=(0,n.Ji)(t.geometries[0]),d=(0,a.lA)(l,i);return(0,r.Z)(s.path+"/project",d).then((({data:{geometries:e}})=>(0,o.o)(e,u,h)))}},8084:function(e,t,i){i.d(t,{Z:function(){return h}});var r=i(73440),s=i(63255),n=i(17155),a=(i(61432),i(96711),i(83850),i(48023)),o=i(45213),l=i(90756),c=i(8554);let h=class extends s.Z{constructor(e){super(e),this.geometries=[],this.outSpatialReference=null,this.transformation=null,this.transformForward=null}toJSON(){const e=this.geometries.map((e=>e.toJSON())),t=this.geometries[0],i={};return i.outSR=(0,c.B9)(this.outSpatialReference),i.inSR=(0,c.B9)(t.spatialReference),i.geometries=JSON.stringify({geometryType:(0,l.Ji)(t),geometries:e}),this.transformation&&(i.transformation=this.transformation.wkid||JSON.stringify(this.transformation)),null!=this.transformForward&&(i.transformForward=this.transformForward),i}};(0,r._)([(0,n.Cb)()],h.prototype,"geometries",void 0),(0,r._)([(0,n.Cb)({type:o.Z,json:{read:{source:"outSR"}}})],h.prototype,"outSpatialReference",void 0),(0,r._)([(0,n.Cb)()],h.prototype,"transformation",void 0),(0,r._)([(0,n.Cb)()],h.prototype,"transformForward",void 0),h=(0,r._)([(0,a.j)("esri.rest.support.ProjectParameters")],h)},83322:function(e,t,i){i.d(t,{K:function(){return d}});var r=i(73440),s=i(43254),n=i(41145),a=i(96711),o=i(93568),l=i(17155),c=(i(61432),i(83850),i(48023)),h=i(38209);function u(e,t,i){let r,s;if(e)for(let n=0,a=e.length;n<a;n++){if(r=e.at(n),r?.[t]===i)return r;if("group"===r?.type&&(s=u(r.layers,t,i),s))return s}}const d=e=>{let t=class extends e{constructor(...e){super(...e),this.layers=new s.Z;const t=e=>{e.parent=this,this.layerAdded(e),"elevation"!==e.type&&"base-elevation"!==e.type||a.Z.getLogger(this).error(`Layer 'title:${e.title}, id:${e.id}' of type '${e.type}' is not supported as an operational layer and will therefore be ignored.`)},i=e=>{e.parent=null,this.layerRemoved(e)};this.addHandles([this.layers.on("before-add",(e=>{if(e.item===this)return e.preventDefault(),void a.Z.getLogger(this).error("#add()","Cannot add layer to itself.");(e=>{e.parent&&"remove"in e.parent&&e.parent.remove(e)})(e.item)})),this.layers.on("after-add",(e=>t(e.item))),this.layers.on("after-remove",(e=>i(e.item)))])}destroy(){const e=this.layers.toArray();for(const t of e)t.destroy();this.layers.destroy()}set layers(e){this._set("layers",(0,n.Z)(e,this._get("layers")))}add(e,t){const i=this.layers;if(t=i.getNextIndex(t),e instanceof h.Z){const r=e;r.parent===this?this.reorder(r,t):i.add(r,t)}else(0,o.y8)(e)?e.then((e=>{this.destroyed||this.add(e,t)})):a.Z.getLogger(this).error("#add()","The item being added is not a Layer or a Promise that resolves to a Layer.")}addMany(e,t){const i=this.layers;let r=i.getNextIndex(t);e.slice().forEach((e=>{e.parent!==this?(i.add(e,r),r+=1):this.reorder(e,r)}))}findLayerById(e){return u(this.layers,"id",e)}findLayerByUid(e){return u(this.layers,"uid",e)}remove(e){return this.layers.remove(e)}removeMany(e){return this.layers.removeMany(e)}removeAll(){return this.layers.removeAll()}reorder(e,t){return this.layers.reorder(e,t)}layerAdded(e){}layerRemoved(e){}};return(0,r._)([(0,l.Cb)()],t.prototype,"layers",null),t=(0,r._)([(0,c.j)("esri.support.LayersMixin")],t),t}},33800:function(e,t,i){i.d(t,{Q:function(){return u}});var r=i(73440),s=i(43254),n=i(41145),a=i(96711),o=i(17155),l=(i(61432),i(83850),i(48023));const c=new Set(["feature","subtype-group"]);function h(e,t,i){if(e)for(let r=0,s=e.length;r<s;r++){const s=e.at(r);if(s[t]===i)return s;if("group"===s?.type){const e=h(s.tables,t,i);if(e)return e}}}const u=e=>{let t=class extends e{constructor(...e){super(...e),this.tables=new s.Z,this.addHandles([this.tables.on("after-add",(e=>{const t=e.item;t.parent&&t.parent!==this&&"tables"in t.parent&&t.parent.tables.remove(t),t.parent=this,c.has(t.type)||a.Z.getLogger(this).error(`Layer 'title:${t.title}, id:${t.id}' of type '${t.type}' is not supported as a table and will therefore be ignored.`)})),this.tables.on("after-remove",(e=>{e.item.parent=null}))])}destroy(){const e=this.tables.toArray();for(const t of e)t.destroy();this.tables.destroy()}set tables(e){this._set("tables",(0,n.Z)(e,this._get("tables")))}findTableById(e){return h(this.tables,"id",e)}findTableByUid(e){return h(this.tables,"uid",e)}};return(0,r._)([(0,o.Cb)()],t.prototype,"tables",null),t=(0,r._)([(0,l.j)("esri.support.TablesMixin")],t),t}},76277:function(e,t,i){i.d(t,{O:function(){return n},a:function(){return s}});var r=i(63727);function s(e){return new r.Z({getCollections:()=>[e.tables,e.layers],getChildrenFunction:e=>{const t=[];return"tables"in e&&t.push(e.tables),"layers"in e&&t.push(e.layers),t},itemFilterFunction:e=>{const t=e.parent;return!!t&&"tables"in t&&t.tables.includes(e)}})}function n(e){for(const t of e.values())t?.destroy();e.clear()}},72728:function(e,t,i){i.d(t,{x:function(){return r}});const r=Symbol("WebScene")},20350:function(e,t,i){var r,s;i.d(t,{H:function(){return s},U:function(){return r}}),function(e){e[e.Stretch=0]="Stretch",e[e.Lut=1]="Lut",e[e.Hillshade=2]="Hillshade",e[e.COUNT=3]="COUNT"}(r||(r={})),function(e){e[e.Noop=0]="Noop",e[e.PerBand=1]="PerBand",e[e.COUNT=2]="COUNT"}(s||(s={}))},25330:function(e,t,i){i.d(t,{i:function(){return w}});i(61432);var r=i(96373),s=i(11034),n=i(5379),a=i(99028),o=i(61100),l=i(85881),c=(i(71090),i(64544)),h=(i(48153),i(13772),i(92937)),u=i(92761),d=i(65650),p=i(57945);class m{constructor(e,t){this.layerUIDs=[],this.isDestroyed=!1,this._data=e;let i=1;const r=new Uint32Array(e);this.layerUIDs=[];const s=r[i++];for(let e=0;e<s;e++)this.layerUIDs[e]=r[i++];this.bufferDataOffset=i,t&&(this.layer=t.getStyleLayerByUID(this.layerUIDs[0]))}get isPreparedForRendering(){return null==this._data}get offset(){return this.bufferDataOffset}get data(){return this._data}destroy(){this.isDestroyed||(this.doDestroy(),this._data=null,this.isDestroyed=!0)}prepareForRendering(e){null!=this._data&&(this.doPrepareForRendering(e,this._data,this.bufferDataOffset),this._data=null)}}class _ extends m{constructor(e,t){super(e,t),this.type=a.al.LINE,this.lineIndexStart=0,this.lineIndexCount=0;const i=new Uint32Array(e);let r=this.bufferDataOffset;this.lineIndexStart=i[r++],this.lineIndexCount=i[r++];const s=i[r++];if(s>0){this.patternMap=new Map;for(let e=0;e<s;e++){const e=i[r++],t=i[r++],s=i[r++];this.patternMap.set(e,[t,s])}}this.bufferDataOffset=r}get usedMemory(){return(this.data?.byteLength??0)+(this.vao?.cachedMemory??0)}hasData(){return this.lineIndexCount>0}triangleCount(){return this.lineIndexCount/3}doDestroy(){this.vao=(0,o.M2)(this.vao)}doPrepareForRendering(e,t,i){const r=new Uint32Array(t),s=new Int32Array(r.buffer),n=r[i++],a=u.f.createVertex(e,d.l1.STATIC_DRAW,new Int32Array(s.buffer,4*i,n));i+=n;const o=r[i++],l=u.f.createIndex(e,d.l1.STATIC_DRAW,new Uint32Array(r.buffer,4*i,o));i+=o;const c=this.layer.lineMaterial;this.vao=new p.U(e,c.getAttributeLocations(),c.getLayoutInfo(),new Map([["geometry",a]]),l)}}class f extends m{constructor(e,t){super(e,t),this.type=a.al.FILL,this.fillIndexStart=0,this.fillIndexCount=0,this.outlineIndexStart=0,this.outlineIndexCount=0;const i=new Uint32Array(e);let r=this.bufferDataOffset;this.fillIndexStart=i[r++],this.fillIndexCount=i[r++],this.outlineIndexStart=i[r++],this.outlineIndexCount=i[r++];const s=i[r++];if(s>0){this.patternMap=new Map;for(let e=0;e<s;e++){const e=i[r++],t=i[r++],s=i[r++];this.patternMap.set(e,[t,s])}}this.bufferDataOffset=r}get usedMemory(){return(this.data?.byteLength??0)+(this.fillVAO?.cachedMemory??0)+(this.outlineVAO?.cachedMemory??0)}hasData(){return this.fillIndexCount>0||this.outlineIndexCount>0}triangleCount(){return(this.fillIndexCount+this.outlineIndexCount)/3}doDestroy(){this.fillVAO=(0,o.M2)(this.fillVAO),this.outlineVAO=(0,o.M2)(this.outlineVAO)}doPrepareForRendering(e,t,i){const r=new Uint32Array(t),s=new Int32Array(r.buffer),n=r[i++],a=u.f.createVertex(e,d.l1.STATIC_DRAW,new Int32Array(s.buffer,4*i,n));i+=n;const o=r[i++],l=u.f.createIndex(e,d.l1.STATIC_DRAW,new Uint32Array(r.buffer,4*i,o));i+=o;const c=r[i++],h=u.f.createVertex(e,d.l1.STATIC_DRAW,new Int32Array(s.buffer,4*i,c));i+=c;const m=r[i++],_=u.f.createIndex(e,d.l1.STATIC_DRAW,new Uint32Array(r.buffer,4*i,m));i+=m;const f=this.layer,g=f.fillMaterial,y=f.outlineMaterial;this.fillVAO=new p.U(e,g.getAttributeLocations(),g.getLayoutInfo(),new Map([["geometry",a]]),l),this.outlineVAO=new p.U(e,y.getAttributeLocations(),y.getLayoutInfo(),new Map([["geometry",h]]),_)}}class g extends m{constructor(e,t,i){super(e,t),this.type=a.al.SYMBOL,this.iconPerPageElementsMap=new Map,this.glyphPerPageElementsMap=new Map,this.symbolInstances=[],this.isIconSDF=!1,this.opacityChanged=!1,this.lastOpacityUpdate=0,this.symbols=[];const r=new Uint32Array(e),s=new Int32Array(e),n=new Float32Array(e);let o=this.bufferDataOffset;this.isIconSDF=!!r[o++];const l=r[o++],u=r[o++],d=r[o++],p=new c.Z(l,u,d,0),m=r[o++];for(let e=0;e<m;e++){const e=r[o++],t=r[o++],i=r[o++];this.iconPerPageElementsMap.set(e,[t,i])}const _=r[o++];for(let e=0;e<_;e++){const e=r[o++],t=r[o++],i=r[o++];this.glyphPerPageElementsMap.set(e,[t,i])}const f=r[o++],g=r[o++];this.iconOpacity=new Int32Array(f),this.textOpacity=new Int32Array(g),o=(0,h.wB)(r,s,n,o,this.symbols,i,p),this.bufferDataOffset=o}get usedMemory(){return(this.data?.byteLength??0)+(this.iconVAO?.cachedMemory??0)+(this.textVAO?.cachedMemory??0)+(0,l.G7)(this.iconOpacity)+(0,l.G7)(this.textOpacity)}hasData(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}triangleCount(){let e=0;for(const t of this.iconPerPageElementsMap.values())e+=t[1];for(const t of this.glyphPerPageElementsMap.values())e+=t[1];return e/3}doDestroy(){this.iconVAO=(0,o.M2)(this.iconVAO),this.textVAO=(0,o.M2)(this.textVAO)}updateOpacityInfo(){if(!this.opacityChanged)return;this.opacityChanged=!1;const e=this.iconOpacity,t=this.iconVAO.vertexBuffers.get("opacity");e.length>0&&e.byteLength===t.usedMemory&&t.setSubData(e,0,0,e.length);const i=this.textOpacity,r=this.textVAO.vertexBuffers.get("opacity");i.length>0&&i.byteLength===r.usedMemory&&r.setSubData(i,0,0,i.length)}doPrepareForRendering(e,t,i){const r=new Uint32Array(t),s=new Int32Array(r.buffer),n=r[i++],a=u.f.createVertex(e,d.l1.STATIC_DRAW,new Int32Array(s.buffer,4*i,n));i+=n;const o=r[i++],l=u.f.createIndex(e,d.l1.STATIC_DRAW,new Uint32Array(r.buffer,4*i,o));i+=o;const c=r[i++],h=u.f.createVertex(e,d.l1.STATIC_DRAW,new Int32Array(s.buffer,4*i,c));i+=c;const m=r[i++],_=u.f.createIndex(e,d.l1.STATIC_DRAW,new Uint32Array(r.buffer,4*i,m));i+=m;const f=u.f.createVertex(e,d.l1.STATIC_DRAW,this.iconOpacity.buffer),g=u.f.createVertex(e,d.l1.STATIC_DRAW,this.textOpacity.buffer),y=this.layer,v=y.iconMaterial,b=y.textMaterial;this.iconVAO=new p.U(e,v.getAttributeLocations(),v.getLayoutInfo(),new Map([["geometry",a],["opacity",f]]),l),this.textVAO=new p.U(e,b.getAttributeLocations(),b.getLayoutInfo(),new Map([["geometry",h],["opacity",g]]),_)}}class y extends m{constructor(e,t){super(e,t),this.type=a.al.CIRCLE,this.circleIndexStart=0,this.circleIndexCount=0;const i=new Uint32Array(e);let r=this.bufferDataOffset;this.circleIndexStart=i[r++],this.circleIndexCount=i[r++],this.bufferDataOffset=r}get usedMemory(){return(this.data?.byteLength??0)+(this.vao?.cachedMemory??0)}hasData(){return this.circleIndexCount>0}triangleCount(){return this.circleIndexCount/3}doDestroy(){this.vao=(0,o.M2)(this.vao)}doPrepareForRendering(e,t,i){const r=new Uint32Array(t),s=new Int32Array(r.buffer),n=r[i++],a=u.f.createVertex(e,d.l1.STATIC_DRAW,new Int32Array(s.buffer,4*i,n));i+=n;const o=r[i++],l=u.f.createIndex(e,d.l1.STATIC_DRAW,new Uint32Array(r.buffer,4*i,o));i+=o;const c=this.layer.circleMaterial;this.vao=new p.U(e,c.getAttributeLocations(),c.getLayoutInfo(),new Map([["geometry",a]]),l)}}var v=i(76496),b=i(58783);class w extends b.I{constructor(e,t,i,r,s,a,o,l=null){super(e,t,i,r,s,a,n.V2,n.V2),this.styleRepository=o,this._memCache=l,this.type="vector-tile",this._referenced=1,this._hasSymbolBuckets=!1,this._usedMemory=256,this.layerData=new Map,this.status="loading",this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.parentTile=null,this.childrenTiles=new Set,this.featureIndex=null,this.triangleCount=0,this._processed=!1,this.id=e.id}get styleLayerUIDs(){return Array.from(this.layerData.keys())}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<v.v7}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<v.v7)}get wasRequested(){return"errored"===this.status||"loaded"===this.status||"reloading"===this.status}setData(e){this.changeDataImpl(e),this.requestRender(),this.ready(),this._processed=!0}deleteLayerData(e){let t=!1;for(const i of e){const e=this.layerData.get(i);e&&(this._usedMemory-=e.usedMemory,e.type===a.al.SYMBOL&&this.symbols.delete(i)&&(t=!0),e.destroy(),this.layerData.delete(i))}this._memCache?.updateSize(this.key.id,this),t&&(this.featureIndex?.clear(),this.emit("symbols-changed")),this.requestRender()}processed(){return this._processed}hasData(){return this.layerData.size>0}hasFeatures(){const e=this.layerData.values();for(const t of e)if(t.hasData())return!0;return!1}dispose(){"unloaded"!==this.status&&(w._destroyRenderBuckets(this.layerData),this.layerData.clear(),this.featureIndex=null,this._usedMemory=0,this.destroy(),this.status="unloaded")}release(){0==--this._referenced&&(this.dispose(),this.stage=null)}retain(){++this._referenced}get cachedMemory(){return this._usedMemory}get usedMemory(){return this._usedMemory}get usedMemoryPerReference(){return this._usedMemory/(this._referenced||1)}changeDataImpl(e){this.featureIndex?.clear();let t=!1;if(e){const{bucketsWithData:i,emptyBuckets:r}=e,s=this._createRenderBuckets(i);if(r&&r.byteLength>0){const e=new Uint32Array(r);for(const t of e)this._deleteLayerData(t)}for(const[e,i]of s)this._deleteLayerData(e),i.type===a.al.SYMBOL&&(this.symbols.set(e,i.symbols),t=!0),this._usedMemory+=i.usedMemory,this.layerData.set(e,i);this._memCache?.updateSize(this.key.id,this)}this._hasSymbolBuckets=!1;for(const e of this.layerData.values())e.type===a.al.SYMBOL&&(this._hasSymbolBuckets=!0);t&&this.emit("symbols-changed")}attachWithContext(e){this.stage={context:e,trashDisplayObject(e){e.processDetach()},untrashDisplayObject:()=>!1}}setTransform(e){super.setTransform(e);const t=this.resolution/(e.resolution*e.pixelRatio),i=this.width/this.rangeX*t,s=this.height/this.rangeY*t,n=[0,0];e.toScreen(n,[this.x,this.y]);const a=this.transforms.tileUnitsToPixels;(0,r.yR)(a),(0,r.Iu)(a,a,n),(0,r.U1)(a,a,Math.PI*e.rotation/180),(0,r.bA)(a,a,[i,s,1])}_createTransforms(){return{displayViewScreenMat3:(0,s.Ue)(),tileMat3:(0,s.Ue)(),tileUnitsToPixels:(0,s.Ue)()}}static _destroyRenderBuckets(e){if(!e)return;const t=new Set;for(const i of e.values())t.has(i)||(i.destroy(),t.add(i));e.clear()}_createRenderBuckets(e){const t=new Map,i=new Map;for(const r of e){const e=this._deserializeBucket(r,i);for(const i of e.layerUIDs)t.set(i,e)}return t}_deserializeBucket(e,t){let i=t.get(e);if(i)return i;switch(new Uint32Array(e)[0]){case a.al.FILL:i=new f(e,this.styleRepository);break;case a.al.LINE:i=new _(e,this.styleRepository);break;case a.al.SYMBOL:i=new g(e,this.styleRepository,this);break;case a.al.CIRCLE:i=new y(e,this.styleRepository)}return t.set(e,i),i}_deleteLayerData(e){if(!this.layerData.has(e))return;const t=this.layerData.get(e);this._usedMemory-=t.usedMemory,t.destroy(),this.layerData.delete(e)}}},76496:function(e,t,i){i.d(t,{R8:function(){return r},cn:function(){return s},v7:function(){return n}});const r=!0,s=32,n=200},64274:function(e,t,i){i.d(t,{V:function(){return s},a:function(){return r}});class r{constructor(e,t){this.sourceTile=t,this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.featureIndex=0,this.uniqueSymbol=null,this._colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=e}colliders(){return this._colliders}}class s{constructor(e){this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1,this.lastShow=!1,this.tileSymbols=[e],this.id=e.id}}},92937:function(e,t,i){i.d(t,{C$:function(){return u},Fe:function(){return p},HX:function(){return c},Yc:function(){return o},rX:function(){return a},wB:function(){return h}});var r=i(99028),s=i(99719),n=i(64274);function a(e,t,i,r){return l(e,t,i.level,i.col,r.key.level,r.key.col)}function o(e,t,i,r){return l(e,t,i.level,i.row,r.level,r.row)}function l(e,t,i,r,s,n){const a=i-s;if(a>=0)return(t>>a)+(r-(n<<a))*(e>>a);const o=-a;return t-(n-(r<<o))*(e>>o)<<o}class c{constructor(e,t,i){this._rows=Math.ceil(t/i),this._columns=Math.ceil(e/i),this._cellSize=i,this.cells=new Array(this._rows);for(let e=0;e<this._rows;e++){this.cells[e]=new Array(this._columns);for(let t=0;t<this._columns;t++)this.cells[e][t]=[]}}getCell(e,t){const i=Math.min(Math.max(Math.floor(t/this._cellSize),0),this._rows-1),r=Math.min(Math.max(Math.floor(e/this._cellSize),0),this._columns-1);return this.cells[i]&&this.cells[i][r]||null}getCellSpan(e,t,i,r){return[Math.min(Math.max(Math.floor(e/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(t/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(i/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(r/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}}function h(e,t,i,r,s,a,o){const l=t[r++];for(let c=0;c<l;c++){const l=new n.a(a,o);l.xTile=t[r++],l.yTile=t[r++],l.hash=t[r++],l.priority=t[r++],l.featureIndex=t[r++];const c=t[r++],h=l.colliders();for(let e=0;e<c;e++){const e=t[r++],s=t[r++],n=t[r++],a=t[r++],o=!!t[r++],l=t[r++],c=i[r++],u=i[r++],d=t[r++],p=t[r++];h.push({xTile:e,yTile:s,dxPixels:n,dyPixels:a,hard:o,partIndex:l,width:d,height:p,minLod:c,maxLod:u})}const u=e[r++];for(let t=0;t<u;t++)l.textVertexRanges.push([e[r++],e[r++]]);const d=e[r++];for(let t=0;t<d;t++)l.iconVertexRanges.push([e[r++],e[r++]]);s.push(l)}return r}function u(e,t,i){for(const[r,s]of e.symbols)d(e,t,i,s,r)}function d(e,t,i,s,n){const a=e.layerData.get(n);if(a.type===r.al.SYMBOL){for(const t of s){const r=t.uniqueSymbol;let s;if(t.selectedForRendering){const t=r.parts[0],n=t.startOpacity,a=t.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&0===a;const o=i?Math.floor(127*n)|a<<7:a?255:0;s=o<<24|o<<16|o<<8|o}else s=0;for(const[e,i]of t.iconVertexRanges)for(let t=e;t<e+i;t+=4)a.iconOpacity[t/4]=s;if(t.selectedForRendering){const t=r.parts[1],n=t.startOpacity,a=t.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&0===a;const o=i?Math.floor(127*n)|a<<7:a?255:0;s=o<<24|o<<16|o<<8|o}else s=0;for(const[e,i]of t.textVertexRanges)for(let t=e;t<e+i;t+=4)a.textOpacity[t/4]=s}a.lastOpacityUpdate=t,a.opacityChanged=!0}}function p(e,t,i,r){const n=e.colliders();let a,o,l,c;for(const h of n)if(e.uniqueSymbol?.show&&e.uniqueSymbol.parts[h.partIndex].show&&(a=h.xScreen-r[0]+h.dxScreen,o=h.yScreen-r[1]+h.dyScreen,l=a+h.width,c=o+h.height,(0,s.Px)(i,t.x,t.y,a,o,l,c)))return!0;return!1}},58783:function(e,t,i){i.d(t,{I:function(){return _}});var r=i(96373),s=i(3480),n=i(87833),a=i(73440),o=i(70880),l=i(61432),c=i(93568),h=i(17155),u=(i(96711),i(83850),i(48023));let d=class extends o.Z{constructor(e){super(e),this.computedOpacity=1,this.computedVisible=!0,this.opacity=1,this.visible=!0,this._fadeOutResolver=null,this._fadeInResolver=null}get transitioning(){return(this._fadeOutResolver||!this.visible?0:this.opacity)!==this.computedOpacity}endTransition(){this._fadeInResolver?.(),this._fadeOutResolver?.(),this._fadeInResolver=this._fadeOutResolver=null,this.computedOpacity=this.visible?this.opacity:0}fadeIn(){return this._fadeInResolver||(this.opacity=1,this.computedOpacity=0,this._fadeOutResolver?.(),this._fadeOutResolver=null,this._fadeInResolver=(0,c.hh)()),this._fadeInResolver.promise}fadeOut(){return this._fadeOutResolver||(this.opacity=0,this._fadeInResolver?.(),this._fadeInResolver=null,this._fadeOutResolver=(0,c.hh)()),this._fadeOutResolver.promise}transitionStep(e,t){const i=(0,l.Z)("mapview-transitions-duration"),r=i?1/i:0;if(0===r)this.computedOpacity=this.opacity,this.computedVisible=this.visible;else{const t=this._fadeOutResolver||!this.visible?0:this.opacity,i=this.computedOpacity;if(i===t)this.computedVisible=this.visible;else{const s=e*r;this.computedOpacity=i>t?Math.max(t,i-s):Math.min(t,i+s),this.computedVisible=this.computedOpacity>0}}this.transitioning||(this._fadeInResolver?.(),this._fadeOutResolver?.(),this._fadeOutResolver=this._fadeInResolver=null)}};(0,a._)([(0,h.Cb)()],d.prototype,"computedOpacity",void 0),(0,a._)([(0,h.Cb)()],d.prototype,"computedVisible",void 0),(0,a._)([(0,h.Cb)()],d.prototype,"opacity",void 0),(0,a._)([(0,h.Cb)()],d.prototype,"visible",void 0),(0,a._)([(0,h.Cb)()],d.prototype,"transitioning",null),(0,a._)([(0,h.Cb)()],d.prototype,"_fadeOutResolver",void 0),(0,a._)([(0,h.Cb)()],d.prototype,"_fadeInResolver",void 0),d=(0,a._)([(0,u.j)("esri.views.2d.engine.transitions.FadeTransition")],d);class p extends n.Z{constructor(){super(...arguments),this._transitionables=null,this._clips=null,this._fadeTransition=null,this._isReady=!1,this._opacity=1,this.parent=null,this._stage=null,this._visible=!0}get computedOpacity(){return this._fadeTransition?.computedOpacity??this.opacity}get clips(){return this._clips}set clips(e){this._clips=e,this.requestRender()}get fadeTransitionEnabled(){return null!==this._fadeTransition}set fadeTransitionEnabled(e){!this._fadeTransition&&e?(this._fadeTransition=new d({opacity:this.opacity,visible:this.visible}),this.addTransitionable(this._fadeTransition)):this._fadeTransition&&!e&&(this.removeTransitionable(this._fadeTransition),this._fadeTransition=null)}get inFadeTransition(){return this._fadeTransition?.transitioning??!1}get isReady(){return this._isReady}get opacity(){return this._opacity}set opacity(e){this._opacity!==e&&(this._opacity=Math.min(1,Math.max(e,0)),this._fadeTransition&&(this._fadeTransition.opacity=this._opacity),this.requestRender())}get stage(){return this._stage}set stage(e){if(this._stage===e)return;const t=this._stage;this._stage=e,e?this._stage?.untrashDisplayObject(this)||(this.onAttach(),this.emit("attach")):t?.trashDisplayObject(this)}get transforms(){return null==this._transforms&&(this._transforms=this._createTransforms()),this._transforms}get transitioning(){return this.isTransitioning()}get visible(){return this._visible}set visible(e){this._visible!==e&&(this._visible=e,this._fadeTransition&&(this._fadeTransition.visible=this._visible),this.requestRender())}get hasLabels(){return!1}get hasHighlight(){return!1}get hasBlending(){return!1}addTransitionable(e){this._transitionables??=[],this._transitionables.push(e),this.requestRender()}removeTransitionable(e){e.endTransition(),this._transitionables&&(0,s.Od)(this._transitionables,e),this.requestRender()}fadeIn(){this.fadeTransitionEnabled=!0;const e=this._fadeTransition.fadeIn();return this.opacity=1,this.requestRender(),e}fadeOut(){this.fadeTransitionEnabled=!0;const e=this._fadeTransition.fadeOut();return this.opacity=0,this.requestRender(),e}endTransitions(){if(this._transitionables){for(const e of this._transitionables)e.endTransition();this.requestRender()}}beforeRender(e){this.transitionStep(e.deltaTime,e.state.scale),this.setTransform(e.state)}afterRender(e){this.transitioning&&this.requestRender()}remove(){this.parent?.removeChild(this)}setTransform(e){}processRender(e){this.stage&&(this._fadeTransition?.computedVisible??this.visible)&&this.doRender(e)}requestRender(){this.stage&&this.stage.requestRender()}processDetach(){this.endTransitions(),this.onDetach(),this.emit("detach")}isTransitioning(){return this._transitionables?.some((e=>e.transitioning))??!1}transitionStep(e,t){if(this._transitionables)for(const i of this._transitionables)i.transitionStep(e,t)}onAttach(){}onDetach(){}doRender(e){}ready(){this._isReady||(this._isReady=!0,this.emit("isReady"),this.requestRender())}}var m=i(64544);class _ extends p{constructor(e,t,i,r,s,n,a=s,o=n){super(),this.tileDebugInfoTexture=null,this.debugInfo={display:{length:0,minOrderedLength:0,minUnorderedLength:0,triangleCount:0},memory:{bytesUsed:0,bytesReserved:0}},this._destroyed=!1,this.key=new m.Z(e),this.resolution=t,this.x=i,this.y=r,this.width=s,this.height=n,this.rangeX=a,this.rangeY=o}destroy(){this.tileDebugInfoTexture&&(this.tileDebugInfoTexture.dispose(),this.tileDebugInfoTexture=null),this._destroyed=!0}get debugSlot(){let e=this;for(;e.parent!==this._stage;){if(!e.parent)return 0;e=e.parent}return this._stage.children.indexOf(e)}setTransform(e){const t=this.resolution/(e.resolution*e.pixelRatio),i=this.transforms.tileMat3,[s,n]=e.toScreenNoRotation([0,0],[this.x,this.y]),a=this.width/this.rangeX*t,o=this.height/this.rangeY*t;(0,r.t8)(i,a,0,0,0,o,0,s,n,1),(0,r.Jp)(this.transforms.displayViewScreenMat3,e.displayViewMat3,i)}get destroyed(){return this._destroyed}}},97750:function(e,t,i){i.d(t,{dP:function(){return d},lM:function(){return h},wH:function(){return u}});var r=i(24910),s=i(82846),n=i(47925),a=i(47566),o=i(48636),l=i(65001),c=i(92490);function h(e,t,i,r){return null!=e.renderCoordsHelper.fromRenderCoords(t.eye,_,r)&&(0,a.BD)(i,_)}function u(e,t){return e.elevationProvider?e.elevationProvider.getElevation(t[0],t[1],t[2],e.renderCoordsHelper.spatialReference,"ground")??0:0}function d(e,t,i,s){const a=e.state.camera.clone();t&&i&&s&&(a.eye=t,a.center=i,a.up=s),function(e,t,i){let s=m[e.viewingMode];s||(s=new c.r(e.state.viewingMode),s.options.backfacesTerrain=!e.state.isGlobal,s.options.invisibleTerrain=!0,m[e.viewingMode]=s);const{isGlobal:a}=e.state;return!(!e.sceneIntersectionHelper.intersectRay(t,s,i)||p(e,t.origin,i))||!(!e.renderCoordsHelper.intersectManifold(t,0,i)||p(e,t.origin,i))||!!a&&function(e,t,i){const s=(0,r.e)(e.origin,e.origin)-i*i,n=s>0?Math.sqrt(s)/3:1;return(0,r.g)(t,e.direction,n/(0,r.l)(e.direction)),(0,r.f)(t,t,e.origin),!0}(t,i,(0,n.Iu)(e.spatialReference).radius)}(e,a.ray,f)||(0,r.c)(f,a.center);const o=e.state.constraints,l=o.minimumPoiDistance;if((0,r.s)(a.eye,f)<l){const t=o.collision.enabled;(0,r.c)(g,a.viewForward),(0,r.g)(g,g,l),t?a.eye=(0,r.d)(_,f,g):(0,r.f)(f,a.eye,g);const i=e.renderCoordsHelper,s=i.getAltitude(a.eye),n=o.collision.elevationMargin;t&&s<n&&((0,r.d)(g,f,a.eye),a.eye=i.setAltitude(_,n,a.eye),(0,r.f)(f,a.eye,g))}return a.center=f,a}function p(e,t,i){if(!e.state.isGlobal||!e.stateManager.constraintsManager)return!1;const s=u(e,t),n=e.stateManager.constraintsManager.nearFarHeuristic;let a=y.get(e);void 0===a&&(a=new o.Z,y.set(e,a)),a.eye=t,a.center=i;const{far:c}=n.compute(a,e.renderDataExtent,l.P.infinite,s),h=c*c;return(0,r.s)(t,i)>h}const m={},_=(0,s.Ue)(),f=(0,s.Ue)(),g=(0,s.Ue)(),y=new WeakMap},37132:function(e,t,i){i.d(t,{G:function(){return u},o:function(){return h}});var r=i(41788),s=i(27583),n=i(21414),a=i(19155),o=i(2013),l=i(48857),c=i(74826);class h extends c.K{constructor(){super(...arguments),this.radii=(0,r.Ue)(),this.heightParameters=(0,s.Ue)()}}function u(e){e.uniforms.add(new a.A("radii",(e=>e.radii)),new o.N("heightParameters",(e=>e.heightParameters))),e.constants.add("scaleHeight","float",n.sv.scaleHeight*n.sv.atmosphereHeight),e.code.add(l.H`float chapmanApproximation(float thickness, float height, float cosZenith) {
float c = sqrt(thickness + height);
float cExpH = c * exp(-height);
if (cosZenith >= 0.0) {
return cExpH / (c * cosZenith + 1.0);
} else {
float x0 = sqrt(1.0 - cosZenith * cosZenith) * (thickness + height);
float c0 = sqrt(x0);
return 2.0 * c0 * exp(thickness - x0) - cExpH / (1.0 - c * cosZenith);
}
}`),e.code.add(l.H`float getOpticalDepth(vec3 position, vec3 dir, float h) {
return scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h, dot(normalize(position), dir));
}`),e.code.add(l.H`vec4 planetIntersect(vec3 cameraPos, vec3 rayDir) {
float reducedPlanetRadius = radii[0] - 20000.0;
float rayPlanetDistance = heightParameters[1] - reducedPlanetRadius * reducedPlanetRadius;
vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, rayPlanetDistance);
vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, heightParameters[2]);
bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;
bool insideAtmosphere = heightParameters[0] < radii[1];
if (!(hitsAtmosphere || insideAtmosphere)) {
return vec4(1.0, 0.0, 0.0, 0.0);
}
bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;
float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;
if (heightParameters[0] < reducedPlanetRadius) {
if (dot(rayDir, normalize(cameraPos)) < -0.025) {
return vec4(1.0, 0.0, 0.0, 0.0);
}
start = rayPlanetIntersect.y;
}
float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;
return vec4(0.0, hitsPlanet ? 1.0 : 0.0, start, end);
}`)}},1824:function(e,t,i){i.d(t,{t:function(){return o}});var r=i(78037),s=i(37132),n=i(87688),a=i(48857);function o(e,t){e.include(s.G);e.uniforms.add(new n.d("cameraPosition",(e=>e.camera.eye))),e.constants.add("betaRayleigh","vec3",r.aM),e.constants.add("betaCombined","vec3",r.nB),e.constants.add("betaMie","float",r.th),e.code.add(a.H`
    vec3 raymarchAtmosphere(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {
      vec4 ray = planetIntersect(cameraPos, rayDir);
      if(ray.x == 1.0) {
        return vec3(0);
      }
      ${(0,a.If)(t,"if (terrainDepth != -1.0) { ray.w = terrainDepth; }")}

      vec3 samplePoint = cameraPos + rayDir * ray.w;
      float multiplier = ray.y == 1.0 ? -1.0 : 1.0;

      vec3 scattering = vec3(0);
      float scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
      float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir, scaleFract);
      float stepSize = (ray.w - ray.z) / ${a.H.float(6)};

      for (int i = 0; i < ${a.H.int(6)}; i++) {
        samplePoint -= stepSize * rayDir;
        scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
        float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier, scaleFract);

        if (i > 0) {
          scattering *= exp(-(mix(betaCombined, betaRayleigh, 0.5) + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));
          ${(0,a.If)(!t,"scattering *= mix(2.5, 1.0, clamp((length(cameraPos) - radii[0]) / 50e3, 0.0, 1.0))")};
        }

        if (dot(normalize(samplePoint), lightDir) > -0.3) {
          float scale = exp(-scaleFract);
          float lightDepth = getOpticalDepth(samplePoint, lightDir, scaleFract);
          scattering += scale * exp(-(betaCombined + betaMie) * lightDepth);
          ${(0,a.If)(!t,"scattering += scale * exp(-(0.25 * betaCombined ) * lightDepth);")}
        }
        lastOpticalDepth = opticalDepth;
      }

      float mu = dot(rayDir, lightDir);
      float mumu = 1.0 + mu * mu;

      float phaseRayleigh = 0.0596831 * mumu;
      ${t?"return 3.0 * scattering * stepSize * phaseRayleigh * betaRayleigh;":a.H`const float g = 0.8;
             const float gg = g * g;
             float phaseMie = 0.1193662 * ((1.0 - gg) * mumu) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg));
             phaseMie = clamp(phaseMie, 0.0, 128.0);
             return 3.0 * scattering * stepSize * (phaseRayleigh * betaRayleigh + 0.025 * phaseMie * betaMie);`}
    }`)}},85382:function(e,t,i){i.d(t,{p:function(){return r},t:function(){return o}});var r,s=i(73440),n=i(41629),a=i(83046);!function(e){e[e.SIXTEEN=0]="SIXTEEN",e[e.HUNDRED=1]="HUNDRED",e[e.TWOHUNDRED=2]="TWOHUNDRED",e[e.COUNT=3]="COUNT"}(r||(r={}));class o extends a.m{constructor(){super(...arguments),this.steps=r.SIXTEEN,this.writeTextureChannels=n.uz.RG}}(0,s._)([(0,a.o)({count:r.COUNT})],o.prototype,"steps",void 0),(0,s._)([(0,a.o)({count:n.uz.COUNT})],o.prototype,"writeTextureChannels",void 0)},80461:function(e,t,i){i.d(t,{i:function(){return a},u:function(){return r}});var r,s=i(73440),n=i(83046);!function(e){e[e.Full=0]="Full",e[e.WeatherMap=1]="WeatherMap",e[e.COUNT=2]="COUNT"}(r||(r={}));class a extends n.m{constructor(){super(...arguments),this.mode=r.Full}}(0,s._)([(0,n.o)({count:r.COUNT})],a.prototype,"mode",void 0)},23625:function(e,t,i){i.d(t,{CB:function(){return n},H6:function(){return c},JK:function(){return l},Mw:function(){return s},a5:function(){return a},i9:function(){return r},r7:function(){return o}});const r=(0,i(61432).Z)("esri-mobile")?64:128,s=r/128,n=Math.ceil(Math.sqrt(r)),a=(r+2)*n,o=1e5,l=128,c=a/1560},22567:function(e,t,i){i.d(t,{H:function(){return r},Y:function(){return a}});var r,s=i(73440),n=i(83046);!function(e){e[e.Rain=0]="Rain",e[e.Snow=1]="Snow",e[e.COUNT=2]="COUNT"}(r||(r={}));class a extends n.m{constructor(){super(...arguments),this.type=r.Rain}}(0,s._)([(0,n.o)({count:r.COUNT})],a.prototype,"type",void 0)},35286:function(e,t,i){i.d(t,{f:function(){return o},n:function(){return r}});var r,s=i(73440),n=i(83046),a=i(91041);!function(e){e[e.Cone=0]="Cone",e[e.Cylinder=1]="Cylinder",e[e.Underground=2]="Underground",e[e.COUNT=3]="COUNT"}(r||(r={}));class o extends a.W{constructor(){super(...arguments),this.geometry=r.Cone}}(0,s._)([(0,n.o)({count:r.COUNT})],o.prototype,"geometry",void 0)},78037:function(e,t,i){i.d(t,{Tk:function(){return l},aM:function(){return c},mP:function(){return a},nB:function(){return d},th:function(){return u},yx:function(){return n}});var r=i(99574),s=i(82846);function n(e){return(0,r.uZ)((e-a)/(o-a),0,1)}const a=1e5,o=1e6,l=1e4,c=(0,s.al)(parseFloat(Number(5802e-9).toFixed(6)),parseFloat(Number(13558e-9).toFixed(6)),parseFloat(Number(331e-7).toFixed(6))),h=(0,s.al)(3*parseFloat(Number(65e-8).toFixed(6)),3*parseFloat(Number(1881e-9).toFixed(6)),3*parseFloat(Number(85e-9).toFixed(6))),u=3996e-9,d=(0,s.al)(parseFloat(Number(c[0]+h[0]).toFixed(6)),parseFloat(Number(c[1]+h[1]).toFixed(6)),parseFloat(Number(c[2]+h[2]).toFixed(6)))},23195:function(e,t,i){i.d(t,{JF:function(){return l},WM:function(){return c},mq:function(){return h}});var r=i(88194),s=i(38700);let n,a=null;const o=new Map;async function l(e){null==a&&(null==n&&(n=i.e(26809).then(i.bind(i,26809))),a=await n);const t=e.view;let l=o.get(t);l||(l=new a.default({view:t}),o.set(t,l));const c=!!t.stage.renderView.renderingContext.capabilities.compressedTextureS3TC,h=!!t.stage.renderView.renderingContext.capabilities.compressedTextureETC;await l.initializeWasm(c,h);const u=l.add3DTilesLayerView(e);if(u.wasmLayerId<0)throw l.getValidLayerViewCount()<1&&(o.delete(t),0===o.size&&(n=null,a=null)),u.wasmLayerId===s.Em?new r.Z("tiles3d:addLayer-failure","The 3d tiles layer web assembly module failed to download.",{}):new r.Z("tiles3d:addLayer-failure",u.check?.errorDescription??"The 3d tiles layer description was invalid.",{});return u.wasmLayerId}function c(e){return o.get(e)}function h(e){const t=e.view,i=o.get(t);i&&i.remove3DTilesLayerView(e)<1&&(o.delete(t),0===o.size&&(n=null,a=null))}},23555:function(e,t,i){i.d(t,{$L:function(){return o},JF:function(){return a},mq:function(){return l}});let r,s=null;const n=new Map;async function a(e){null==s&&(null==r&&(r=i.e(70558).then(i.bind(i,70558))),s=await r);const t=e.view;let a=n.get(t);return a||(a=new s.default({view:t}),n.set(t,a)),a.addVoxelLayer(e)}function o(e){return n.get(e)}function l(e){const t=e.view,i=n.get(t);i&&i.removeVoxelLayer(e)<1&&(n.delete(t),0===n.size&&(r=null,s=null))}},62640:function(e,t,i){i.d(t,{S:function(){return X},C:function(){return te}});var r=i(73440),s=i(70880),n=i(29292),a=(i(61432),i(96711)),o=i(61100),l=i(93568),c=i(90403),h=i(17155),u=(i(83850),i(48023)),d=i(41788),p=i(74774),m=i(10813),_=i(75970),f=i(10841),g=i(80139),y=i(25136),v=i(19269),b=i(26834);function w(e){return e instanceof b.l?e.graphics3DSymbol:e instanceof v.q?e:null}var C=i(24910),x=i(82846),T=i(16447),S=i(47451),M=i(91896),E=i(84262),R=i(3970);const P=()=>a.Z.getLogger("esri.views.3d.layers.graphics.labelPlacement");class A{constructor(e,t,i,r=null){this._graphic=e,this._symbol=t,this._class=i,this._disablePlacement=r}get placement(){const e=this._verticalOffsetPlacement;if(null==e)return null;const t=this._getPlacementInfo(e);if(null==t)return null;const i=t.anchor,r=!!e.hasLabelVerticalOffset,s=e.verticalOffset,n=new M.a(s,i,r);return this._calculatePlacementOffsets(n,t)}get _verticalOffsetPlacement(){const e=this._class.labelPlacement,{_symbol:t,_graphic:i}=this,r=w(i.graphics3DSymbol),s="point-3d"===r?.symbol.type?r.symbol:null,n=I[e]||this._defaultPlacementInfo;return s?.supportsCallout()&&s.hasVisibleVerticalOffset()&&!i.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:s.verticalOffset.clone(),anchor:null,normalizedOffset:null}:!t?.hasVisibleVerticalOffset()||null!=s&&s.supportsCallout()&&s.verticalOffset&&!i.isDraped?{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}:n&&function(e){return"above-center"===e}(n.placement)?{placement:"above-center",verticalOffset:t.verticalOffset.clone(),anchor:"bottom",normalizedOffset:[0,n.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(P().errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+e+" placement)"),null)}_getPlacementInfo(e){if(e.anchor)return e;const t=this._class.labelPlacement,i=I[t],r=i||this._defaultPlacementInfo;return t&&!i&&P().warnOnce(`the requested label placement '${t}' is currently unsupported in SceneView.`),this._validatePlacementInfo(r)}_calculatePlacementOffsets(e,t){const i=this._graphic.graphic.geometry;if(null==i)return null;switch(i.type){case"point":this._setPointSpecificPlacement(e,t);break;case"mesh":this._setMeshSpecificPlacement(e,t);break;case"polygon":this._setPolygonSpecificPlacement(e,t)}const r=S.aT-E.Wg;return e.screenOffset[0]+=r*t.normalizedOffset[0],e.screenOffset[1]+=r*t.normalizedOffset[1],e}get _defaultPlacementInfo(){const e=this._graphic.graphic.geometry;if(null==e)return null;switch(e.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:x.AG,anchor:"center"};case"polygon":return"extrude"===this._firstSymbolLayer?.type?I["above-center"]:{placement:"center-center",normalizedOffset:x.AG,anchor:"center"};case"point":case"mesh":return I["above-center"];default:return}}_validatePlacementInfo(e){const t=this._graphic.graphic.geometry;if(null==t)return null;if(null!=this._disablePlacement){const t=this._class.labelPlacement;return t?(P().warnOncePerTick(O(t,this._disablePlacement.logEntityDescription)),this._defaultPlacementInfo):e}const i=t.type;switch(i){case"polyline":case"polygon":case"extent":case"multipoint":{const e=this._class.labelPlacement;if(e)return I[e]&&P().warnOnce(O(e,`'${i}' geometries`)),this._defaultPlacementInfo;break}case"point":case"mesh":return e}return e}_setPointSpecificPlacement(e,t){const i=this._firstSymbolLayer;if(null==i)return;const r=this._graphic.layers[0];switch(null!=r?r.getCenterObjectSpace(e.translation):(0,C.i)(e.translation,0,0,0),i.type){case"icon":case"text":this._setHUDSpecificPlacement(e,t,r);break;case"object":D(e,t,r)}}_setMeshSpecificPlacement(e,t){const i=this._firstSymbolLayer;null!=i&&"fill"===i.type&&D(e,t,this._graphic.layers[0])}_setPolygonSpecificPlacement(e,t){const i=this._firstSymbolLayer;if(null!=i)switch(i.type){case"extrude":{const i=this._graphic.layers[0];null!=i?(i.getBoundingBoxObjectSpace(N),(0,T.be)(N,e.translation),e.translation[2]=(0,T.Cb)(N)/2):(0,C.i)(e.translation,0,0,0),D(e,t,i);break}}}_setHUDSpecificPlacement(e,t,i){const{_graphic:r}=this,s=null!=i?i.getScreenSize():null;if(r.isDraped||null==s)e.hasLabelVerticalOffset||"center"===e.anchor||(I[this._class.labelPlacement]&&P().warnOncePerTick(`the requested placement '${t.placement}' is currently unsupported for draped graphics`),e.anchor="center");else{const i=this._normalizedSymbolAnchorPos;e.screenOffset[0]=s[0]/2*(t.normalizedOffset[0]-i[0]);const r=s[1]/2*(t.normalizedOffset[1]-i[1]);e.hasLabelVerticalOffset?(e.centerOffset[1]=r,e.centerOffsetUnits="screen"):e.screenOffset[1]=r}}get _firstSymbolLayer(){const e=w(this._graphic.graphics3DSymbol);return null!=e?e.symbol.symbolLayers.at(0):null}get _normalizedSymbolAnchorPos(){const e=this._graphic.layers[0]?.stageObject.geometries[0].material??null;if(e&&e instanceof R.A){const t=e.parameters.anchorPosition;F[0]=2*(t[0]-.5),F[1]=2*(t[1]-.5)}else F[0]=0,F[1]=0;return F}}function O(e,t){return`the requested label placement '${e}' is currently unsupported for ${t} in SceneView.`}function D(e,t,i){const r=null!=i?i.getBoundingBoxObjectSpace(N):N,s=(0,x.al)(r[3]-r[0],r[4]-r[1],r[5]-r[2]),n=Math.sqrt(s[0]*s[0]+s[1]*s[1]);e.centerOffset[0]=n/2*t.normalizedOffset[0];const a=e.translation[2],o=s[2]/2*t.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=a+o;const l=(0,C.l)(s);e.centerOffset[2]=l/2*t.normalizedOffset[2]}const I={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},L={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const e in L){const t=L[e],i=I[e];t.forEach((e=>{I[e]=i}))}Object.freeze&&(Object.freeze(I),Object.keys(I).forEach((e=>{Object.freeze(I[e]),Object.freeze(I[e]?.normalizedOffset)})));const F=[0,0],N=(0,T.Ue)();var U=i(29989),H=i(29819),V=i(53412),k=i(4664),B=i(52061),z=i(65759),G=i(27546),q=i(50399),Z=i(78891);class j{constructor(e,t){this.labelingContext=e,this.graphics3DGraphic=t,this.hasGraphics3DResources=!1,this.visible=!1,this.textureAtlasHandles=[],this.textInitialized=!1,this.textRenderers=new Array,this.textLabelPlacements=new Array}}class W{constructor(e,t,i,r,s){this.labelClass=e,this.graphics3DSymbol=t,this.graphics3DCalloutSymbolLayer=i,this.textRenderParameters=r,this.labelFunction=s,this.calloutSymbolLayerIndex=0,this.graphics=new Map,this.scaleVisibility=null}}class ${constructor(e,t,i,r,s,n,a,o){this.layer=t,this.graphics3DCore=i,this.scaleVisibility=r,this.emptySymbolLabelSupported=s,this.elevationInfoOverride=n,this.disablePlacement=a,this.active=o,this.labelClassAbortController=new AbortController,this.labelClassContexts=new Array,this.graphics=new Map,this.labelsToInitialize=new Map,this.stageLayer=new z.F(e,{pickable:!0},i.owner.layerViewUid)}destroy(){this.stageLayer.destroy()}}let X=class extends s.Z{constructor(e){super(e),this._hudMaterials=new Map,this._calloutMaterials=new Map,this._dirty=!1,this._labels=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this.addHandles([(0,c.YP)((()=>this.view.state?.camera),(()=>this.setDirty())),(0,c.YP)((()=>this.view.state?.rasterPixelRatio),(()=>this._resetAllLabels())),(0,c.YP)((()=>this.view.focusAreasView?.polygons),(()=>this._updateFocus())),this.view.resourceController.scheduler.registerTask(q.T8.LABELER,this)]),(0,G.Dc)()&&this.addHandles((0,c.YP)((()=>this.view.scale),(()=>this._updateScaleVisibility()))),this._textTextureAtlas=new k.U({view:this.view})}dispose(){this.removeAllHandles(),this._textTextureAtlas=(0,o.M2)(this._textTextureAtlas),this._hudMaterials.clear(),this._calloutMaterials.clear(),this._labelingContexts.length=0,this._labels.clear()}destroy(){this.dispose(),ie.graphic=null,ie.renderingInfo=null,ie.layer=null}_updateFocus(){this._labelingContexts.forEach((e=>{e.graphics.forEach((t=>{if(0===t.labelLayers.length)return;const i=(0,H.S_)(t.graphic.geometry);if(null==i)return;const r=this.view.focusAreasView?.containsGeometry(i)??!0;t.labelLayers.forEach((i=>{i.stageObject.geometries.some((e=>e.material.parameters.isFocused!==r))&&(this._removeGraphic(e,t),this._addGraphic(e,t),this.setDirty())}))}))}))}_activateLabelingContext(e){e.graphics.forEach(((t,i)=>{const r=new j(e,t);this._labels.set(i,r),e.labelsToInitialize.set(i,r),t.setVisibilityFlag(f.E.LABEL,f.P.USER,!0)})),e.active=!0}_deactivateLabelingContext(e){e.graphics.forEach(((e,t)=>{e.setVisibilityFlag(f.E.LABEL,f.P.USER,!1),this.setLabelGraphicVisibility(e,!1),e.clearLabelGraphics(),this._labels.delete(t)})),e.active=!1}_addLabelTextureToAtlas(e){for(const t of e.graphics3DGraphic.labelLayers){if(!t.labelClass)continue;const i=e.textRenderers[t.labelClassContextIndex];i&&(e.textureAtlasHandles.push(this._textTextureAtlas.addText(i,(e=>Q(t.stageObject,e)))),Y(t.stageObject,i))}}_removeLabelTextureFromAtlas(e){e.textureAtlasHandles.forEach((e=>e.remove())),e.textureAtlasHandles.length=0}get running(){return this.view.ready&&(this._dirty||this.deconflictor.running)}runTask(e){return this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e),Z.J}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(t.active)if(K(t))this._dirty=!0;else if(J(t.labelClassContexts)){if(null===t.labelClassContexts){this._deactivateLabelingContext(t);continue}this._createLabelClassContext(t),this._dirty=!0}else for(const[i,r]of t.labelsToInitialize)if(this._ensureGraphics3DResources(r)&&(this._labels.set(i,r),this.deconflictor.setDirty(),e.madeProgress()),(r.visible&&r.textInitialized||!r.visible&&r.hasGraphics3DResources)&&(t.labelsToInitialize.delete(i),e.madeProgress()),e.done){this._dirty=!0;break}this._dirty||this.notifyChange("updating")}}async _createLabelClassContextAsync(e){const t=e.labelClassAbortController?.signal;e.layer.when&&await e.layer.when(),(0,l.k_)(t),e.scaleVisibility?.updateScaleRangeActive();const i=e.graphics3DCore,r=i.layer.labelingInfo?.filter((e=>!!e.symbol));if(!r||0===r.length)return;let s=!1;await(0,n.Ed)(r,(async(r,o)=>{const c=r.symbol,h=w(i.getOrCreateGraphics3DSymbol(c));if(null==h)return void a.Z.getLogger(this).error("Failed to create Graphics3DSymbol for label");await h.load(),(0,l.k_)(t);let u=null;(0,_.Pd)(c)&&c.hasVisibleCallout()&&(u=(0,g.S)(c,i.symbolCreationContext),await u.load(),(0,l.k_)(t));const d=await(0,n.q6)((0,m.J)(r,e.layer.fieldsIndex,this.view.spatialReference));if((0,l.k_)(t),!0===d.ok){const i=await this._createTextRenderParameters(h.symbol);(0,l.k_)(t);const s=new W(r,h,u,i,d.value);this._updateLabelClassContextVisibility(s),e.labelClassContexts[o]=s}else a.Z.getLogger(this).error(`Label expression failed to evaluate: ${d.error}`),s=!0})),(0,l.k_)(t)}async _createLabelClassContext(e){return null==e.labelClassPromise&&(e.labelClassPromise=this._createLabelClassContextAsync(e).catch((t=>{if((0,l.D_)(t))throw t;e.labelClassContexts.length=0})).then((()=>{e.labelClassAbortController=null,this.notifyChange("updating")})).catch((()=>{})),this.notifyChange("updating")),e.labelClassPromise}async _createTextRenderParameters(e){const t=e.symbolLayers.at(0);return"text"!==t?.type?null:V.V.fromSymbol(t,this.view.state.rasterPixelRatio)}_destroyLabelClassContext(e){for(const t of e.labelClassContexts)--t.graphics3DSymbol.referenced;const t=e.labelClassAbortController;e.labelClassAbortController=new AbortController,(0,o.IM)(t),e.labelClassContexts.length=0,e.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(e,t,i,r,s,n){const a=new M.U(i,(0,U.zi)(i.anchor),(0,U.EP)(i.anchor),e.text,(0,d.al)(e.displayWidth,e.displayHeight));return ie.graphic=t,ie.layer=r,ie.renderingInfo=null,s.createLabel(ie,a,this._hudMaterials,this._textTextureAtlas,(()=>n.placement?.elevationOffset??null))}_createLineCalloutGraphic(e,t,i,r,s){ie.graphic=e,ie.layer=s;const n=r.screenOffset[0];return ie.renderingInfo=new y.Ly(null,t,r.translation,r.centerOffset,n,r.centerOffsetUnits,r.elevationOffset),i.createGraphics3DGraphic(ie,this._calloutMaterials)}_ensureGraphics3DResources(e){if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);const i=e.labelingContext,r=i.labelClassContexts;if(J(r)||!i.emptySymbolLabelSupported&&0===t.layers.length)return!1;let s=!1;const n=t.graphic,a=i.layer,o=te(i.layer);for(let l=0;l<r.length;l++){const c=e.textRenderers[l],h=e.textLabelPlacements[l];if(null==c||null==h)continue;const u=r[l],d=u.graphics3DSymbol,p=ee(d),m=d.symbolLayers[0];if(!m)continue;m.setElevationInfoOverride(i.elevationInfoOverride);const _=new A(t,p,u.labelClass),g=this._createTextSymbolGraphic(c,n,h,a,m,_);if(null==g)return!1;g.labelClass=u.labelClass,g.labelClassContextIndex=l,t.addLabelGraphic(g,i.stageLayer),this.deconflictor.setPriority(t,u.textRenderParameters?.definition.size??0),t.setVisibilityFlag(f.E.LABEL,f.P.USER,o),t.setVisibilityFlag(f.E.LABEL,f.P.SCALE_RANGE,u.scaleVisibility??!0),t.setVisibilityFlag(f.E.LABEL,f.P.DECONFLICTION,!1),(0,G.Dc)()&&u.graphics.set(n.uid,t),s=!0;const y=u.graphics3DCalloutSymbolLayer;if(y&&h.hasLabelVerticalOffset){y.setElevationInfoOverride(i.elevationInfoOverride);const e=this._createLineCalloutGraphic(n,p,y,h,a);null!=e&&(u.calloutSymbolLayerIndex=t.labelLayers.length,t.addLabelGraphic(e,i.stageLayer))}break}return s&&i.scaleVisibility?.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const i of e.graphics3DGraphic.labelLayers){if(null==i.labelClass)continue;t[i.labelClassContextIndex].graphics3DSymbol.symbolLayers[0]?.onRemoveGraphic(i)}e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}_ensureTextTextureResources(e){if(e.textInitialized)return;const t=e.labelingContext,i=t.labelClassContexts;if(J(i))return;const r=e.graphics3DGraphic.graphic;for(let s=0;s<i.length;s++){const n=i[s];if(e.textRenderers[s]=null,e.textLabelPlacements[s]=null,null==n?.textRenderParameters)continue;const a=n.labelFunction;let o;if("arcade"===a.type)try{const e=a.needsHydrationToEvaluate()?(0,p.mW)(r,t.layer):r;o=a.evaluate(e)}catch(e){o=null}else o=a.evaluate(r);if(null==o||""===o||/^\s+$/.test(o))continue;const l=n.graphics3DSymbol;if(!l.symbolLayers[0])continue;const c=e.graphics3DGraphic,h="label-3d"===l.symbol?.type?l.symbol:null,u=n.labelClass,d=t.disablePlacement,m=new A(c,h,u,d).placement;if(null==m)continue;const _=(0,U.zi)(m.anchor),f=(0,U.mq)(_);e.textRenderers[s]=new E.tV(o,f,n.textRenderParameters,k.U.maxSize),e.textLabelPlacements[s]=m}e.textInitialized=!0}_destroyTextTextureResources(e){e.textInitialized=!1,e.textRenderers.length=0,e.textLabelPlacements.length=0}_addGraphic(e,t){const i=t.graphic.uid;if(e.graphics.set(i,t),e.active){const r=new j(e,t);this._labels.set(i,r),e.labelsToInitialize.set(i,r)}this.setDirty(),this.deconflictor.setDirty()}_updateGraphicGeometry(e,t){const i=t.graphic.uid,r=this._labels.get(i);if(!r)return!0;for(const i of r.graphics3DGraphic.labelLayers)if(null!=i.labelClass&&!e.labelClassContexts[i.labelClassContextIndex].graphics3DSymbol.symbolLayers[0].updateGeometry(i,t.graphic.geometry))return!1;return this.setDirty(),this.deconflictor.setDirty(),!0}_removeGraphic(e,t){const i=t.graphic.uid,r=this._labels.get(i);e.graphics.delete(i),r&&(this._destroyGraphic(r,i),e.labelsToInitialize.delete(i),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(e,t){this._labels.delete(t),e.textureAtlasHandles.length&&this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}async _labelingInfoChange(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const i of t){const t=e.graphics.get(i);t&&(this._removeGraphic(e,t),this._addGraphic(e,t))}}_globalPropertyChanged(e,t){for(const i of t.labelClassContexts){const r=new Map;t.graphics.forEach((e=>r.set(e.graphic.uid,e)));const s=e=>e.labelLayers[0];if(i.graphics3DSymbol.symbolLayers[0].globalPropertyChanged(e,r,s),i.graphics3DCalloutSymbolLayer){const t=e=>e.labelLayers[i.calloutSymbolLayerIndex];i.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,r,t)}}}_visibilityInfoChange(e){const t=te(e.layer);t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e)}_resetLabels(e){e.graphics.forEach(((t,i)=>{const r=this._labels.get(i);r&&(this._destroyGraphic(r,i),r.visible=!1,e.labelsToInitialize.set(i,r))})),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,i){const r=i?.emptySymbolLabelSupported||!1,s=i?.elevationInfoOverride||null,n=i?.disablePlacement||null;if(this._findLabelingContext(e))return;const a=e.layer,o=new $(this.view.stage,a,e,t,r,s,n,te(a));return this._labelingContexts.push(o),this.setDirty(),{addGraphic:e=>this._addGraphic(o,e),removeGraphic:e=>this._removeGraphic(o,e),updateGraphicGeometry:e=>this._updateGraphicGeometry(o,e),layerLabelsEnabled:()=>te(o.layer),labelingInfoChange:e=>this._labelingInfoChange(o,e),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",o),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",o),visibilityInfoChange:()=>this._visibilityInfoChange(o),reset:()=>this._resetLabels(o),remove:()=>this._removeGraphicsOwner(e),setDirty:()=>this.setDirty()}}_removeGraphicsOwner(e){const t=this._findLabelingContext(e);if(!t)return;const i=this._labelingContexts.indexOf(t);this._labelingContexts.splice(i,1),t.graphics.forEach((e=>this._removeGraphic(t,e))),t.destroy(),this.setDirty()}_updateScaleVisibility(){for(const e of this._labelingContexts)if(e.active&&!K(e))for(const t of e.labelClassContexts)this._updateLabelClassContextVisibility(t)}_updateLabelClassContextVisibility(e){if(!(0,G.Dc)())return;const{labelClass:t,graphics:i}=e,r={minScale:t.minScale,maxScale:t.maxScale},s=(0,G.GB)(r,this.view.scale),n=null==e.scaleVisibility||e.scaleVisibility!==s;e.scaleVisibility=s,n&&i.size&&(i.forEach((e=>e.setVisibilityFlag(f.E.LABEL,f.P.SCALE_RANGE,s))),this.deconflictor.setDirty(),this.setDirty())}setLabelGraphicVisibility(e,t){const i=e.graphic.uid,r=this._labels.get(i);r&&r.visible!==t&&(t&&!r.textureAtlasHandles.length?(this._addLabelTextureToAtlas(r),r.textInitialized||r.labelingContext.labelsToInitialize.set(i,r)):!t&&r.textureAtlasHandles.length&&this._removeLabelTextureFromAtlas(r),r.visible=t,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._dirty||this._textTextureAtlas?.updating||this.deconflictor.updating||this._labelingContexts.some((e=>K(e)))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce(((e,t)=>e+(K(t)?0:1)),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get test(){}};function Y(e,t){e.geometries[0].setAttributeData(B.T.SIZE,[t.displayWidth,t.displayHeight]),e.geometryVertexAttributeUpdated(e.geometries[0],B.T.SIZE)}function Q(e,t){e.geometries[0].setAttributeData(B.T.UVI,t),e.geometryVertexAttributeUpdated(e.geometries[0],B.T.UVI,!0)}function K(e){return!!e.labelClassPromise&&!!e.labelClassAbortController}function J(e){return!e||0===e.length}function ee(e){return"label-3d"===e.symbol?.type?e.symbol:null}function te(e){return!!e.labelsVisible&&!!e.labelingInfo?.some((e=>!!e.symbol))}(0,r._)([(0,h.Cb)({constructOnly:!0})],X.prototype,"view",void 0),(0,r._)([(0,h.Cb)({constructOnly:!0})],X.prototype,"deconflictor",void 0),(0,r._)([(0,h.Cb)()],X.prototype,"_textTextureAtlas",void 0),(0,r._)([(0,h.Cb)({type:Boolean,readOnly:!0})],X.prototype,"updating",null),X=(0,r._)([(0,u.j)("esri.views.3d.layers.graphics.Labeler")],X);const ie=new y._D(null,null,null)},91383:function(e,t,i){i.d(t,{J:function(){return o},Q:function(){return n}});var r=i(47925),s=i(47566);class n{constructor(e,t,i,r,n=o(e,t,i)){this._tilingScheme=r,this.id=n,this.lij=[0,0,0],this.extent=(0,s.Ue)(),this.measures=new a,this.loadPriority=0,this.used=!1,this.lij[0]=this.measures.lodLevel=e,this.lij[1]=t,this.lij[2]=i,r.getExtent(e,t,i,this.extent)}get planetRadius(){return(0,r.Iu)(this.spatialReference).radius}get spatialReference(){return this._tilingScheme.spatialReference}get resolution(){return this._tilingScheme.resolutionAtLevel(this.measures.lodLevel)}get level(){return this.lij[0]}get lodLevelDelta(){return this.measures.lodLevel-this.level}createChildren(){const e=this.lij[0]+1,t=2*this.lij[1],i=2*this.lij[2];return[new n(e,t,i,this._tilingScheme),new n(e,t+1,i,this._tilingScheme),new n(e,t,i+1,this._tilingScheme),new n(e,t+1,i+1,this._tilingScheme)]}}class a{constructor(){this.visible=!0,this.distance=0,this.lodLevel=0,this.splitPriority=0,this.mergeable=!0}}function o(e,t,i){return`${e}/${t}/${i}`}},63510:function(e,t,i){function r(e){return t=>{if(e.immediate)return e.immediate.schedule(t);const i="No immediate scheduler";throw console.error(i),new Error(i)}}i.d(t,{H:function(){return r}})},59505:function(e,t,i){i.d(t,{i:function(){return o},p:function(){return r}});var r,s=i(24910),n=i(82846),a=i(33869);class o{get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}get origin(){return this._origin}constructor(e){this.renderCoordsHelper=e,this.frustum=(0,a.Ue)(),this._points=(0,a.Hf)(),this.lines=new Array(12),this._origin=(0,n.Ue)(),this._direction=(0,n.Ue)(),this._altitude=null;for(let e=0;e<12;e++)this.lines[e]={origin:null,direction:(0,n.Ue)(),endpoint:null}}update(e){(0,a.q_)(e.viewMatrix,e.projectionMatrix,this.frustum,this._points),(0,s.c)(this._origin,e.eye),(0,s.c)(this._direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this._updateLines()}updatePoints(e){for(let t=0;t<this._points.length;t++)(0,s.c)(this._points[t],e[t]);(0,a.Jp)(this.frustum,this._points),this._updateLines()}get altitude(){return this._altitude}intersectsSphere(e){return(0,a.hr)(this.frustum,e)}intersectsRay(e){return(0,a.Zr)(this.frustum,e)}intersectsLineSegment(e,t){return(0,a.rN)(this.frustum,e,t)}intersectsPoint(e){return(0,a.g8)(this.frustum,e)}_updateLines(){const e=this._points;for(let t=0;t<4;t++){const i=t+4;l(this.lines[t],e[t],e[i]),l(this.lines[t+4],e[t],3===t?e[0]:e[t+1]),l(this.lines[t+8],e[i],3===t?e[4]:e[i+1])}}static{this.planePointIndices=a.xu}static{this.nearFarLineIndices=[[a.NQ.NEAR_BOTTOM_LEFT,a.NQ.FAR_BOTTOM_LEFT],[a.NQ.NEAR_BOTTOM_RIGHT,a.NQ.FAR_BOTTOM_RIGHT],[a.NQ.NEAR_TOP_RIGHT,a.NQ.FAR_TOP_RIGHT],[a.NQ.NEAR_TOP_LEFT,a.NQ.FAR_TOP_LEFT]]}}function l(e,t,i){e.origin=t,e.endpoint=i,(0,s.E)(e.direction,t,i)}!function(e){e[e.NEAR_FAR_BOTTOM_LEFT=0]="NEAR_FAR_BOTTOM_LEFT",e[e.NEAR_FAR_BOTTOM_RIGHT=1]="NEAR_FAR_BOTTOM_RIGHT",e[e.NEAR_FAR_TOP_RIGHT=2]="NEAR_FAR_TOP_RIGHT",e[e.NEAR_FAR_TOP_LEFT=3]="NEAR_FAR_TOP_LEFT",e[e.NEAR_BOTTOM=4]="NEAR_BOTTOM",e[e.NEAR_RIGHT=5]="NEAR_RIGHT",e[e.NEAR_TOP=6]="NEAR_TOP",e[e.NEAR_LEFT=7]="NEAR_LEFT",e[e.FAR_BOTTOM=8]="FAR_BOTTOM",e[e.FAR_RIGHT=9]="FAR_RIGHT",e[e.FAR_TOP=10]="FAR_TOP",e[e.FAR_LEFT=11]="FAR_LEFT"}(r||(r={}))},60321:function(e,t,i){i.d(t,{Z:function(){return C},l:function(){return m}});var r=i(99574),s=i(26636),n=i(24910),a=i(82846),o=i(47925),l=i(71354),c=i(12659),h=i(69055),u=i(56172),d=i(78037),p=i(65001);function m(e,t,i){return e===u.JY.Global?new f(t,i):new _(t,i)}class _{constructor(e,t){this._elevationProvider=e,this._referenceEllipsoid=(0,o.Iu)(t),this._unitInMeters=(0,s.c9)(t,this._referenceEllipsoid.metersPerDegree)}compute(e,t,i,s){const{eye:a,center:o}=e;let c=a[2]*this._unitInMeters;const h=c,u=c-s,d=this._elevationProvider?.visibleElevationBounds;d&&(c=u>=0?h-this._unitInMeters*d.min:this._unitInMeters*d.max-h),t??=new l.Z({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0});const p={x:t.xmax-t.xmin,y:t.ymax-t.ymin,z:4*Math.max(t.xmax-t.xmin,t.ymax-t.ymin)},m=Math.max(p.x,p.y,p.z);(0,n.d)(M,o,a),S[0]=M[0]>0?t.xmax:t.xmin,S[1]=M[1]>0?t.ymax:t.ymin,S[2]=M[2]>0?m/2:-m/2,(0,n.d)(S,S,a),(0,n.n)(M,M);const _=1.1*(0,n.e)(S,M)*this._unitInMeters,f=Math.sqrt(c*(c+2*this._referenceEllipsoid.radius)),y=Math.max(t.xmax-t.xmin,t.ymax-t.ymin),v=y*x*this._unitInMeters,w=y*T*this._unitInMeters,C=(0,r.uZ)((c-w)/(v-w),0,1)**3,R=Math.min((0,r.t7)(f,_,C),f)*Math.max(Math.log(Math.abs(u)),1);return g(Math.min(R,Math.max(34064e4,m))/this._unitInMeters,b,this._unitInMeters,E)}}class f{constructor(e,t){this._elevationProvider=e,this._referenceEllipsoid=(0,o.Iu)(t)}compute(e,t,i,s){const{eye:a}=e,o=(0,n.l)(a),l=o-this._referenceEllipsoid.radius,u=this._referenceEllipsoid.radius+Math.min(0,s),m=Math.abs(l-s),_=Math.max(m,Math.abs(l)),f=this._elevationProvider?.visibleElevationBounds.max??0,x=(0,d.yx)(_),T=Math.sqrt(_*(_+2*u)),A=o+this._referenceEllipsoid.radius,O=1.2*(0,r.t7)(T,A,x),D=(Math.log(_)-y)/(v-y);g(O,(0,r.uZ)(b-D*(b-w),w,b),1,E);const I=this._referenceEllipsoid.radius+f,L=this._referenceEllipsoid.radius+this._referenceEllipsoid.atmosphereHeight,F=Math.max(I,L),N=o-F;if(x>0&&N>C){const t=(0,n.n)(S,(0,n.g)(S,e.eye,-1)),s=(0,n.n)(M,e.viewForward),a=(0,r.ZF)((0,n.e)(t,s)),o=.5*e.fovY,l=Math.cos(o);let u=p.P.infinite.near;if(a<=o)u=N*l;else{const t=(0,n.n)(S,e.viewUp),i=Math.tan(o),r=(0,n.g)(S,t,i),a=(0,n.n)(S,(0,n.d)(S,s,r)),d=(0,c.al)(e.eye,a,P),p=(0,h.b)(R,F);if((0,h.i)(p,d,S)){const t=(0,n.d)(S,S,e.eye);u=(0,n.l)(t)*l}}const d=.99*Math.min(i.near,u);if(d<p.P.infinite.near&&d>E.near){const e=(0,r.t7)(E.near,d,x);E.near=e}}return E}}function g(e,t,i,r){const s=C/i,n=e/t;return n>s?(r.far=e,r.near=n):(r.near=s,r.far=r.near*t),r}const y=7.983,v=16.994,b=2e4,w=100,C=2,x=.001,T=1e-4,S=(0,a.Ue)(),M=(0,a.Ue)(),E={near:0,far:0},R=(0,h.c)(),P=(0,c.Ue)()},13340:function(e,t,i){i.d(t,{L:function(){return a}});var r=i(99574),s=i(24910),n=i(82846);function a(e,t,i){e.worldUpAtPosition(t,o),(0,s.d)(l,i,t);const n=(0,s.l)(l);return 0===n?0:(0,r.ZF)((0,s.e)(l,o)/n)}const o=(0,n.Ue)(),l=(0,n.Ue)()},71298:function(e,t,i){i.d(t,{r:function(){return r}});class r{constructor(e=1/0,t=-1/0){this.elevationRangeMin=e,this.elevationRangeMax=t}get elevationRangeValid(){return!Number.isNaN(this.elevationRangeMin)}invalidateElevationRange(){this.elevationRangeMin=NaN}expandElevationRangeValues(e,t){this.elevationRangeMin=Math.min(this.elevationRangeMin,e),this.elevationRangeMax=Math.max(this.elevationRangeMax,t)}expandElevationRange(e){this.elevationRangeMin=Math.min(this.elevationRangeMin,e.elevationRangeMin),this.elevationRangeMax=Math.max(this.elevationRangeMax,e.elevationRangeMax)}setElevationRange(e){this.elevationRangeMin=e.elevationRangeMin,this.elevationRangeMax=e.elevationRangeMax}}},48621:function(e,t,i){i.d(t,{d:function(){return p},c:function(){return d}});var r=i(73440),s=i(70880),n=(i(61432),i(96711)),a=i(69071),o=i(99153),l=i(32555),c=i(17155),h=(i(83850),i(48023));var u=i(50399);function d(e){return new m({view:e})}const p=.1;let m=class extends s.Z{constructor(e){super(e),this._quality=1,this._usedMemory=0,this._updating=!1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._predictedMemory=0,this._cacheStorage=new a.WJ,this._warnMemoryUsage=null,this._numQualityChanges=0,this._maxMemory=750,this._additionalCacheMemory=0,this.addHandles((0,o.A)({prepare:()=>this._updateMemory()}))}destroy(){this._cacheStorage.destroy()}get maxMemory(){return this._maxMemory}set maxMemory(e){null==e||e<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(1),this._maxMemory=e)}get additionalCacheMemory(){return this._additionalCacheMemory}set additionalCacheMemory(e){null!=e&&(this._additionalCacheMemory=e)}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._usedMemory}get usedCacheMemory(){return this._cacheStorage.size}newCache(e,t,i){return new a.Xq(e,this._cacheStorage,t,i)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(this._predictedMemory<=0&&!this._updating)return;let e=this._layersUpdating();if(this._predictedMemory<.6&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(1);else if(e){if(this._predictedMemory>1.1||this._usedMemory>1)if(this._stableQuality>0)this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality);else if(this._quality>p&&this._downscaleMemoryUsed<this._usedMemory){if(this._compactAndUpdate())return;this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._usedMemory,this._canFastRecover=!1}}else if(this._downscaleMemoryUsed=0,this._usedMemory>1){if(this._compactAndUpdate())return;this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._predictedMemory}else if(this._stableQuality!==this._quality)if(this._usedMemory<.75&&this._quality<1){this._stableQuality=this._quality;const t=.05;e=this._updateQuality(this._quality+t)}else this._quality<1&&(this._canFastRecover=!0);this._updating=e}_compactAndUpdate(){const e=(0,u.S0)((0,l.HA)(100)),t=this.view.stage.compact(e);return this.view.basemapTerrain.overlayManager.renderer.compact(e)||t}_updateQuality(e){return(e=Math.min(Math.max(e,p),1))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)}_layersUpdating(){return this.view.allLayerViews.some((e=>!!e.updating))}_updateMemory(){if(!this.view)return;this.view.stage?.renderer?.tick();const e=this.view.stage?.renderer?.usedMemory;let t=(this.view.basemapTerrain?.usedMemory??0)+(e?e.fbos+e.edges+e.plugins:0),i=0;this.view.allLayerViews&&this.view.allLayerViews.forEach((e=>{if(function(e){return"usedMemory"in e&&"unloadedMemory"in e&&"ignoresMemoryFactor"in e}(e)){const r=e.ignoresMemoryFactor?this._quality:1;t+=e.usedMemory*r,i+=e.unloadedMemory*r}}));const r=null==this._warnMemoryUsage||Math.round(10*t)!==Math.round(10*this._warnMemoryUsage),s=1048576*this.maxMemory;if(t>s&&r){this._warnMemoryUsage=t;const e=e=>(e/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",r=Math.round(100*this._quality);n.Z.getLogger(this).warn(`Memory Limit exceeded! Limit: ${e(s)} Current: ${e(t)} Projected: ${e(t+i)} Quality: ${r}%`)}this._usedMemory=t/s,this._predictedMemory=(t+i)/s;const a=s-t;this._cacheStorage.maxSize=Math.max(0,a+1048576*this.additionalCacheMemory)}get test(){}};(0,r._)([(0,c.Cb)({constructOnly:!0})],m.prototype,"view",void 0),(0,r._)([(0,c.Cb)()],m.prototype,"maxMemory",null),(0,r._)([(0,c.Cb)()],m.prototype,"additionalCacheMemory",null),(0,r._)([(0,c.Cb)({readOnly:!0})],m.prototype,"memoryFactor",null),(0,r._)([(0,c.Cb)({readOnly:!0})],m.prototype,"updating",null),(0,r._)([(0,c.Cb)({readOnly:!0})],m.prototype,"usedMemory",null),(0,r._)([(0,c.Cb)({readOnly:!0})],m.prototype,"usedCacheMemory",null),(0,r._)([(0,c.Cb)()],m.prototype,"_quality",void 0),(0,r._)([(0,c.Cb)()],m.prototype,"_usedMemory",void 0),(0,r._)([(0,c.Cb)()],m.prototype,"_updating",void 0),(0,r._)([(0,c.Cb)()],m.prototype,"_stableQuality",void 0),(0,r._)([(0,c.Cb)()],m.prototype,"_maxMemory",void 0),(0,r._)([(0,c.Cb)()],m.prototype,"_additionalCacheMemory",void 0),m=(0,r._)([(0,h.j)("esri.views.3d.support.MemoryController")],m)},32243:function(e,t,i){i.d(t,{Z:function(){return b}});var r=i(99574),s=i(26636),n=i(31865),a=i(24910),o=i(47925),l=i(70331),c=i(6961),h=i(96937),u=i(2051),d=i(47566),p=i(93070),m=i(5226),_=i(77773),f=i(63271),g=i(69811),y=i(27936),v=i(56172);class b{constructor(e,t,i,r){this.viewingMode=e,this.spatialReference=t,this.unitInMeters=i,this._coordinateSystem=r,this._tmpCoordinateSystem=(0,m.Ue)(r),this.referenceEllipsoid=(0,o.Iu)(t),this.sphericalPCPF=(0,l.rS)(t)}set extent(e){e&&(0,m.qf)(this._coordinateSystem,e,this._coordinateSystem)}get extent(){return(0,m.bk)(this._coordinateSystem,(0,d.Ue)())}getAltitude(e){return(0,m.id)(this._coordinateSystem,e)}setAltitude(e,t,i=e){return(0,m.Is)(this._coordinateSystem,i,t,e)}setAltitudeOfTransformation(e,t){(0,m.rF)(this._coordinateSystem,t,e,t)}worldUpAtPosition(e,t){return(0,m.P0)(this._coordinateSystem,e,t)}worldBasisAtPosition(e,t,i){return(0,m.Kf)(this._coordinateSystem,e,t,i)}basisMatrixAtPosition(e,t){const i=this.worldBasisAtPosition(e,p.R.X,g.WM.get()),r=this.worldBasisAtPosition(e,p.R.Y,g.WM.get()),s=this.worldBasisAtPosition(e,p.R.Z,g.WM.get());return(0,n.t8)(t,i[0],i[1],i[2],0,r[0],r[1],r[2],0,s[0],s[1],s[2],0,0,0,0,1),t}headingAtPosition(e,t){const i=this.worldUpAtPosition(e,g.WM.get()),s=this.worldBasisAtPosition(e,p.R.Y,g.WM.get()),n=(0,f.cp)(t,s,i);return(0,r.BV)(n)}intersectManifoldClosestSilhouette(e,t,i){return(0,m.NE)(this._coordinateSystem,t,this._tmpCoordinateSystem),(0,m.ej)(this._tmpCoordinateSystem,e,i),i}intersectManifold(e,t,i){(0,m.NE)(this._coordinateSystem,t,this._tmpCoordinateSystem);const r=g.WM.get();return(0,m.BR)(this._tmpCoordinateSystem,e,r)?(0,a.c)(i,r):null}intersectInfiniteManifold(e,t,i){if(this.viewingMode===v.JY.Global)return this.intersectManifold(e,t,i);(0,m.NE)(this._coordinateSystem,t,this._tmpCoordinateSystem);const r=this._tmpCoordinateSystem.value,s=g.WM.get();return(0,_.BR)(r.plane,e,s)?(0,a.c)(i,s):null}toRenderCoords(e,t,i){return(0,y.f)(e)?(0,c.K)(e,t,this.spatialReference):(0,u.S)(e,t,i,this.spatialReference)}fromRenderCoords(e,t,i=null){return(0,y.f)(t)?(null!=i&&(t.spatialReference=i),(0,h.f)(e,this.spatialReference,t)?t:null):(0,u.S)(e,this.spatialReference,t,i)?t:null}static create(e,t){switch(e){case v.JY.Local:return new b(v.JY.Local,t,(0,s.c9)(t),(0,m.pb)());case v.JY.Global:return new b(v.JY.Global,t,1,(0,m.pt)(t))}}static renderUnitScaleFactor(e,t){return(0,s.r6)(e)/(0,s.r6)(t)}}},69892:function(e,t,i){i.d(t,{Q8:function(){return De},Br:function(){return Be},t_:function(){return Xe},Xt:function(){return ke},n3:function(){return Ne},gL:function(){return $e},Hm:function(){return We},UI:function(){return je},Ic:function(){return ot},S9:function(){return lt},P$:function(){return Qe},h5:function(){return Ie},kE:function(){return Fe},l0:function(){return He},_U:function(){return Ve},sO:function(){return ft},ao:function(){return ht},HH:function(){return ct},cb:function(){return Ze},EO:function(){return gt}});var r,s,n,a=i(41309),o=i(95437),l=i(96711),c=i(99574),h=i(93568),u=i(24910),d=i(82846),p=i(47925),m=i(60508),_=i(13132),f=i(45213),g=i(6961),y=i(96937),v=i(2051),b=i(56172),w=i(97750),C=i(31865),x=i(10934),T=i(41788),S=i(71354),M=i(67764),E=i(28931),R=i(33869),P=i(26821);function A(e,t){const i=[],r=[];return O(i,e,t,n.LEFT),O(r,i,t,n.BOTTOM),O(i,r,t,n.RIGHT),O(r,i,t,n.TOP),r}function O(e,t,i,r){const n=I(i,r);if(e.length=0,t.length){n(L,t[0],t[0])===s.INSIDE&&D(e,t[0]);for(let i=0;i<t.length;i++){const r=t[i===t.length-1?0:i+1];switch(n(L,t[i],r)){case s.INSIDE:D(e,r);break;case s.INSIDE_OUT:D(e,(0,T.d9)(L));break;case s.OUTSIDE_IN:D(e,(0,T.d9)(L)),D(e,r);case s.OUTSIDE:}}}}function D(e,t){0!==e.length&&(0,P.fS)(e.at(-1),t)||e.push(t)}function I(e,t){const i=t===n.LEFT||t===n.RIGHT?0:1,a=e[t],o=t===n.LEFT||t===n.BOTTOM?r.MIN:r.MAX,l=0===i?1:0;return(e,t,n)=>{if(t[i]<a&&n[i]<a)return o===r.MIN?s.OUTSIDE:s.INSIDE;if(t[i]>a&&n[i]>a)return o===r.MIN?s.INSIDE:s.OUTSIDE;const c=(n[l]-t[l])/(n[i]-t[i]),h=t[l]+c*(a-t[i]);return e[i]=a,e[l]=h,(t[i]<a?1:-1)*o>0?s.OUTSIDE_IN:s.INSIDE_OUT}}!function(e){e[e.MIN=1]="MIN",e[e.MAX=-1]="MAX"}(r||(r={})),function(e){e[e.OUTSIDE=0]="OUTSIDE",e[e.INSIDE=1]="INSIDE",e[e.OUTSIDE_IN=2]="OUTSIDE_IN",e[e.INSIDE_OUT=3]="INSIDE_OUT"}(s||(s={})),function(e){e[e.LEFT=0]="LEFT",e[e.BOTTOM=1]="BOTTOM",e[e.RIGHT=2]="RIGHT",e[e.TOP=3]="TOP"}(n||(n={}));const L=(0,T.Ue)();var F=i(12659),N=i(59505),U=i(59758);const H=(0,d.al)(0,1,0),V=(0,d.al)(0,0,1),k=(0,x.Ue)(),B=(0,d.Ue)(),z=(0,d.Ue)();function G(e,t,i,r=(0,U.dp)()){const{direction:s,up:n}=r;return(0,C.QO)(k,-(0,c.Vl)(t)),(0,C.lM)(k,k,(0,c.Vl)(i)),(0,u.t)(s,V,k),(0,u.g)(s,s,-1),(0,u.t)(n,H,k),r}function q(e,t,i,r,s){const n=t.lines[N.p.FAR_LEFT].direction,a=(s-i.getAltitude(r))/n[2];(0,u.b)(e,r,n,a)}const Z=(0,d.Ue)(),j=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:function(e,t,i,r){return(0,U.t_)(t,i,r,V,H)},eyeForCenterWithHeadingTilt:function(e,t,i,r){const s=G(0,i,r),n=(0,d.Ue)();return(0,u.g)(n,s.direction,-t),(0,u.f)(n,n,e),{up:s.up,eye:n,heading:i,tilt:r}},eyeTiltToLookAtTilt:function(e){return(0,c.Vl)(e)},headingTiltToDirectionUp:G,lookAtTiltToEyeTilt:function(e){return(0,c.BV)(e)},toArea:function(e,t){const i=e.frustum,{renderCoordsHelper:r}=e,s=r.getAltitude(t),n=e.spatialReference,a=e.state.camera.eye,o=[],l=i.planes[R.Nu.FAR];for(let e=0;e<4;e++){const t=i.lines[e];r.intersectInfiniteManifold((0,F.re)(t.origin,t.direction),s,Z)||q(Z,i,r,t.endpoint,s),(0,U.H2)(Z,a,Z,l),o.push((0,T.al)(Z[0],Z[1]))}return function(e,t,i){const r=e.map((e=>((0,u.i)(Z,e[0],e[1],0),t.fromRenderCoords(Z,Z,i),[Z[0],Z[1]])));return r.length<=2?new M.Z({spatialReference:i}):(r.push(r[0].slice()),(0,E.bu)(r)||r.reverse(),new M.Z({rings:[r],spatialReference:i}))}(A(o,r.extent),r,n)},toExtent:function(e,t,i,r,s){const n=e.renderSpatialReference,a=e.spatialReference??t.spatialReference;return(0,g.K)(t,B,n),(0,g.K)(t,z,n),B[0]-=i/2,z[0]+=i/2,B[1]-=r/2,z[1]+=r/2,(0,v.S)(B,n,B,a),(0,v.S)(z,n,z,a),s?(s.xmin=B[0],s.ymin=B[1],s.xmax=z[0],s.ymax=z[1],s.spatialReference=a):s=new S.Z(B[0],B[1],z[0],z[1],a),s}},Symbol.toStringTag,{value:"Module"}));var W=i(73749),$=i(27583),X=i(66130),Y=i(88970),Q=i(77773),K=i(69055),J=i(97290),ee=i(60321),te=i(13340),ie=i(32185),re=i(22365);const se=(0,d.al)(0,0,1),ne=(0,u.n)((0,d.Ue)(),(0,d.al)(1,1,1)),ae=new o.pE(-180,180),oe=(0,x.Ue)(),le=(0,d.Ue)(),ce=(0,d.Ue)();function he(e,t,i,r=(0,U.dp)()){(0,u.h)(le,e,se),0===(0,u.e)(le,le)&&(0,u.h)(le,e,ne),(0,C.Us)(oe,-(0,c.Vl)(t),e),(0,C.U1)(oe,oe,-(0,c.Vl)(i),le);const{up:s,direction:n}=r;return(0,u.h)(s,le,e),(0,u.n)(s,s),(0,u.t)(s,s,oe),(0,u.n)(n,e),(0,u.u)(n,n),(0,u.t)(n,n,oe),r}function ue(e){const t=e[1];e[1]=-e[2],e[2]=t}function de(e,t){const i=he(t,e.heading,e.tilt);return e.up=i.up,e}function pe(e,t){const i=[],r=[],s=(0,X.bn)();for(let n=0;n<e.length;n++){const a=e[n],o=n===e.length-1?e[0]:e[n+1],l=(0,Y.zk)(a,o,we),c=(0,Q.Qi)(t,l.origin,l.vector,Q.oy.NONE,ve);switch(c){case Q.Kt.INSIDE:i.push(a);break;case Q.Kt.OUTSIDE:r.push(a);break;case Q.Kt.INTERSECTS_INSIDE_OUT:case Q.Kt.INTERSECTS_OUTSIDE_IN:{const[e,n,o]=c===Q.Kt.INTERSECTS_INSIDE_OUT?[1,i,r]:[-1,r,i],l=(0,Q.st)(t),h=(0,u.b)((0,d.Ue)(),ve,l,e*s),p=(0,u.b)((0,d.Ue)(),ve,l,e*-s);n.push(a),n.push(h),o.push(p)}}}const n=[];return i.length&&n.push(i),r.length&&n.push(r),n}const me={minCurvature:(0,c.Vl)(5),maxCurvature:(0,c.Vl)(50),minSamples:1,maxSamples:6},_e=(0,d.al)(1,0,0),fe=(0,d.al)(0,1,0),ge=(0,d.Ue)(),ye=(0,d.Ue)(),ve=(0,d.Ue)(),be=(0,K.c)(),we=(0,Y.Ue)(),Ce=(0,$.Ue)(),xe=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:function(e,t,i,r){const s=le,n=ce;return(0,u.n)(s,e),(0,u.h)(ce,s,se),0===(0,u.e)(ce,ce)&&(0,u.h)(ce,s,ne),(0,u.h)(n,ce,s),(0,U.t_)(t,i,r,s,n)},eyeForCenterWithHeadingTilt:function(e,t,i,r){const s={eye:(0,d.Ue)(),up:null,tilt:r,heading:i},n=le;n[0]=e[0],n[1]=e[2],n[2]=-e[1];const a=t,o=(0,c.Vl)(i),l=(0,c.Vl)(r),h=Math.sin(o),p=Math.cos(o),m=Math.sin(l),_=Math.cos(l),f=(0,u.l)(n);let g;if(Math.abs(l)<1e-8)g=a+f;else{const e=f/m,t=(0,c.Kt)(a/e),i=Math.PI-l-t;g=e*Math.sin(i)}const y=_*a,v=a*a*(m*m),b=p*p*v,w=g-y,C=w*w,x=b*(b+C-n[1]*n[1]);if(x<0)return(0,u.g)(s.eye,n,g/f),s.tilt=0,de(s,e);const T=Math.sqrt(x),S=n[1]*w,M=b+C;let E;if(E=p>0?-T+S:T+S,Math.abs(M)<1e-8)return f<1e-8?(s.eye[0]=0,s.eye[1]=0,s.eye[2]=a):(0,u.g)(s.eye,n,g/f),s.tilt=0,ue(s.eye),de(s,e);s.eye[1]=E/M;const R=h*h*v,P=m*a,A=p*P*s.eye[1],O=s.eye[1]*s.eye[1],D=1-O,I=Math.sqrt(D),L=b*O+R-2*A*I*w+D*C;return Math.abs(L)<1e-8?((0,u.g)(s.eye,n,g/f),s.tilt=0,ue(s.eye),de(s,e)):(s.eye[0]=(D*(g*n[0]-y*n[0])-P*I*(n[0]*s.eye[1]*p+n[2]*h))/L,s.eye[2]=(D*(g*n[2]-y*n[2])-P*I*(n[2]*s.eye[1]*p-n[0]*h))/L,(0,u.g)(s.eye,s.eye,g),ue(s.eye),de(s,e))},eyeTiltToLookAtTilt:function(e,t,i){const r=(0,c.Vl)(e),s=(0,u.l)(t);return(0,c.Kt)(i/(s/Math.sin(r)))+r},headingTiltToDirectionUp:he,lookAtTiltToEyeTilt:function(e,t,i){const r=(0,u.l)(t),s=Math.sqrt(i*i+r*r-2*i*r*Math.cos(Math.PI-e)),n=(0,c.Kt)(i/(s/Math.sin(e)));return(0,c.BV)(e-n)},toArea:function(e,t){const{renderCoordsHelper:i}=e,r=e.state.camera.clone(),s=new N.i(i);r.near=ee.Z,s.update(r);const n=i.getAltitude(t),a=e.spatialReference,o=i.referenceEllipsoid.radius,l=r.eye,h=1+(0,u.j)(l,t)/(o+n),p=Math.sqrt(h*h-1),{minCurvature:m,maxCurvature:_,minSamples:f,maxSamples:g}=me,y=function(e){const{renderCoordsHelper:t,state:{camera:i}}=e,{center:r,eye:s}=i,n=Math.abs(t.getAltitude(r)),a=Math.abs(Math.PI/2-(0,te.L)(t,r,s));return(0,K.b)(be,t.referenceEllipsoid.radius+n),(0,K.d)(be,a,i.distance,i.fovY)}(e),v=(0,c.uZ)((p-m)/(_-m),0,1),b=Math.round((0,c.t7)(f,g,v)),w=r.aboveGround,C=s.planes[R.Nu.FAR],x=[],T=(0,Q.Yq)(d.AG,_e,(0,Q.Ue)()),S=(0,Q.Yq)(d.AG,fe,(0,Q.Ue)());(0,W.s)(Ce,0,0,0,0);for(let e=0;e<4;e++){const t=e===N.p.NEAR_FAR_BOTTOM_RIGHT&&!w||e===N.p.NEAR_FAR_TOP_LEFT&&w?1-y:0,r=e===N.p.NEAR_FAR_BOTTOM_RIGHT&&w||e===N.p.NEAR_FAR_TOP_LEFT&&!w?y:1,a=s.lines[e],o=s.lines[3===e?0:e+1];for(let s=0;s<b;s++){const h=s/b,p=e===N.p.NEAR_FAR_BOTTOM_RIGHT?1-(1-h)**2:e===N.p.NEAR_FAR_TOP_LEFT?h**2:h,m=0===s?0:(0,c.t7)(t,r,p),_=(0,u.m)(ye,a.origin,o.origin,m),f=(0,re.ZA)(a.direction,o.direction,m,ge);i.intersectManifoldClosestSilhouette((0,F.re)(_,f),n,ve),(0,U.H2)(ve,l,ve,C),x.push((0,d.d9)(ve)),0!==x.length&&(0,u.x)(x.at(-1),ve);const g=((0,Q.Ac)(T,ve)?1:0)|((0,Q.Ac)(S,ve)?2:0);Ce[g]=1}}x.length>2&&(0,u.x)(x[0],x.at(-1));const P=function(e,t,i){const r=2*(0,X.bn)();return e.map((e=>{const s=[];let n=!1;for(const a of e)t.fromRenderCoords(a,ve,i),Math.abs(a[0])<r&&Math.abs(a[1])<r?(s.push([null,ve[1]]),s.push([null,ve[1]]),n=!0):s.push([ve[0],ve[1]]);if(n)for(let e=0;e<s.length;e++){const t=s[e];if(null!=t[0])continue;const i=s[e+1],r=s.at(0===e?-1:e-1);t[0]=r[0],e++;const n=s.at(e===s.length-1?0:e+1);i[0]=n[0]}return s.push(s[0]),(0,E.bu)(s)||s.reverse(),s}))}((0,W.b)(Ce)>1?function(e,t){const i=[];for(const r of e)i.push(...pe(r,t));return i}(pe(x,T),S):[x],i,a);return new M.Z({rings:P,spatialReference:a})},toExtent:function(e,t,i,r,s){let n,a,l,h;const u=t.latitude,d=(0,p.Iu)(e.spatialReference).radius,m=t.longitude,_=(0,ie.Be)(u,i,d)/2;n=m-_,a=m+_;const g=(0,c.Vl)(u),y=(1+Math.sin(g))/(1-Math.sin(g)),v=(y+1)*Math.tan(r/d/2),b=v*v;function w(e){const t=Math.PI/2;return(e=o.c5.normalize(e,-t))>t&&(e=Math.PI-e),e}if(l=1.5*Math.PI-2*Math.atan(.5*(v+Math.sqrt(4*y+b))),h=l+r/d,l=w(l),h=w(h),h<l){const e=h;h=l,l=e}if(l=Math.max((0,c.BV)(l),-90),h=Math.min((0,c.BV)(h),90),a=ae.monotonic(n,a),a-n>180){const e=(a-n-180)/2;n+=e,a-=e}const C=e.spatialReference&&e.spatialReference.isGeographic?e.spatialReference:f.Z.WGS84;return s?(s.xmin=n,s.ymin=l,s.xmax=a,s.ymax=h,s.spatialReference=C):s=new S.Z(n,l,a,h,C),e.spatialReference&&e.spatialReference.isWebMercator&&(0,J.$)(s,!1,s),s}},Symbol.toStringTag,{value:"Module"}));var Te=i(90494),Se=i(45391);const Me=()=>l.Z.getLogger("esri.views.3d.support.cameraUtils"),Ee=96*39.37,Re={heading:0,tilt:0},Pe=(0,d.Ue)(),Ae=new o.pE(-20037508.342788905,20037508.342788905),Oe=new o.pE(-180,180);var De;function Ie(e){return e.spatialReference??f.Z.WGS84}function Le({state:e}){return e.isGlobal?xe:j}function Fe(e,t,i,r,s){return Le(e).headingTiltToDirectionUp(t,i,r,s)}function Ne(e,t){if(null==t)return null;const i=e.renderSpatialReference,r=Le(e).headingTiltToDirectionUp,s=(0,d.Ue)();if(!(0,g.K)(t.position,s,i))return null;const n=r(s,t.heading,t.tilt);(0,u.g)(n.direction,n.direction,e.state.camera.distance),(0,u.f)(n.direction,n.direction,s);const a=(0,w.dP)(e,s,n.direction,n.up);return a.fov=(0,c.Vl)(t.fov),a.row=t.layout.row,a.rows=t.layout.rows,a.column=t.layout.column,a.columns=t.layout.columns,a}!function(e){e[e.LOCKED=0]="LOCKED",e[e.ADJUST=1]="ADJUST"}(De||(De={}));const Ue=(0,d.Ue)();function He(e,t,i){const r=e.renderSpatialReference,s=Xe(e,t.eye,t.viewForward,t.up,Re);let n=Ie(e);return(0,v.S)(t.eye,r,Ue,n)||(n=f.Z.WGS84,(0,v.S)(t.eye,r,Ue,n)),null==i?i=new a.Z(new m.Z(Ue,n),s.heading,s.tilt,(0,c.BV)(t.fov)):(i.position.x=Ue[0],i.position.y=Ue[1],i.position.z=Ue[2],i.position.spatialReference=n,i.heading=s.heading,i.tilt=s.tilt,i.fov=(0,c.BV)(t.fov)),i.layout.row=t.row,i.layout.rows=t.rows,i.layout.column=t.column,i.layout.columns=t.columns,i}function Ve(e,t){const{camera:i}=e.state,{unitInMeters:r}=e.renderCoordsHelper;return t/=r,i.width/2/i.pixelRatio/(Ee/t)/Math.tan(i.fovX/2)}function ke(e,t){const{camera:i}=e.state,{unitInMeters:r}=e.renderCoordsHelper,s=t*Math.tan(i.fovX/2),n=i.width/2/i.pixelRatio;return Ee/(n/s)*r}function Be(e,t,i,r){const s=r.levelAtScale(t),n=Ge(Xe(e,i.eye,i.viewForward,i.up).tilt),a=Math.max(s-n,0);return r.scaleAtLevel(a)}function ze(e,t,i){const r=i.levelAtScale(e),s=Ge(t);return i.scaleAtLevel(r+s)}function Ge(e){return 2*((e>90?180-e:e)/90)**2}function qe(e,t,i=0){const r=Ne(e,t);return r?function(e,t,i=0){const r=e.basemapTerrain?.tilingScheme;if(!r)return 0;const s=(0,p.Iu)(e.spatialReference).radius,n=e.state.viewingMode===b.JY.Local?t.eye[2]:(0,u.l)(t.eye)-s;return Be(e,ke(e,Math.abs(n-i)),t,r)}(e,r,i):0}function Ze(e,t,i,r,s){if(0===t)return 0;const n=(0,u.j)(i.eye,r),a=e.basemapTerrain?.tilingScheme;if(!a)return Me().error("#scaleToTargetDistance()","Cannot compute distance from scale without a tiling scheme"),n;let o=n;const l=Xe(e,i.eye,i.viewForward,i.up),h=l.tilt>90;if(e.state.isLocal){const r=(Ve(e,ze(t,l.tilt,a))-Math.abs(i.eye[2]-s[2]))/Math.cos((0,c.Vl)(l.tilt));return o=h?o-r:o+r,o}let d=1/0,m=0,_=Qe(e,l.heading,l.tilt,r,n,De.ADJUST);if(!_)return o;const f=(0,u.l)(s);for(;d>1&&m<100;){const s=(0,u.l)(_.eye),n=h?180-_.tilt:_.tilt,g=(0,c.Vl)(n),y=Math.sin(g)*s,v=Math.cos(g)*s,b=Ve(e,ze(t,_.tilt,a)),w=h?f-b:f+b,C=(0,c.Kt)(y/w),x=Math.cos(C)*w-v,T=(0,u.j)(_.eye,r);o=h?T-x:T+x,_=Qe(e,l.heading,l.tilt,r,o,De.ADJUST);const S=mt(e,_,(0,c.BV)(i.fov));if(!_||!S)return o;const M=qe(e,S,f-(0,p.Iu)(e.spatialReference).radius);d=Math.abs(t-M),++m}return o}async function je(e,t,i,r,s,n){return $e(e,t,Ve(e,i),r,s,n)}function We(e,t,i,r,s,n){return mt(e,Qe(e,r.heading,r.tilt,t,i,s),r.fov,n)}async function $e(e,t,i,r,s,n){const a=await Ke(e,r.heading,r.tilt,t,i,s,n);return(0,h.k_)(n),_t(e,a,r.fov,n)}function Xe(e,t,i,r,s){return Le(e).directionToHeadingTilt(t,i,r,s)}function Ye(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,Pe,e.spatialReference)&&e.elevationProvider&&((0,Te.KO)(e.elevationProvider,Pe)??0)>Pe[2]-1)}function Qe(e,t,i,r,s,n){return Je(e,t,i,r instanceof m.Z?r:null,function(e,t){const i=(0,d.Ue)();if(null==t)return(0,u.c)(i,e.state.camera.center);if(t instanceof m.Z){if(!(0,g.K)(t,i,e.renderSpatialReference))return null;const{basemapTerrain:r,elevationProvider:s}=e;if(null==t.z&&null!=r&&null!=s){const r=(0,Te.KO)(s,t);null!=r&&e.renderCoordsHelper.setAltitude(i,r)}return i}return(0,u.c)(i,t)}(e,r),s,n)}async function Ke(e,t,i,r,s,n,a){const o=r instanceof m.Z?r:null,l=await async function(e,t,i){const r=(0,d.Ue)();if(null==t)return(0,u.c)(r,e.state.camera.center);if(t instanceof m.Z){const{renderSpatialReference:s,basemapTerrain:n,elevationProvider:a}=e,o=t.spatialReference;if(await(0,g.U)(t,r,s,0,{signal:i}),(0,h.k_)(i),null==t.z&&null!=n&&null!=a){const s=await a.queryElevation(t.x,t.y,t.z??0,o,"ground",i);(0,h.k_)(i),null!=s&&e.renderCoordsHelper.setAltitude(r,s)}return r}return(0,u.c)(r,t)}(e,r,a);return(0,h.k_)(a),et(e,t,i,o,l,s,n,a)}function Je(e,t,i,r,s,n,a){if(null==s)return null;if(!r&&(r=new m.Z({spatialReference:Ie(e)}),!(0,y.f)(s,e.renderSpatialReference,r)))return null;const o=tt(e,t,i,s,n,a);if(it(e,i,a)&&Ye(e,o.eye)){const{tilt:a,mode:o}=rt(e,i,s,n);return Je(e,t,a,r,s,n,o)}return st(o,s)}async function et(e,t,i,r,s,n,a,o){r||(r=new m.Z({spatialReference:Ie(e)}),await(0,y.A)(s,e.renderSpatialReference,r,{signal:o})||(r=null)),(0,h.k_)(o);const l=tt(e,t,i,s,n,a);if(it(e,i,a)&&await async function(e,t,i){if(Ye(e,t))return!0;const{elevationProvider:r,spatialReference:s,renderCoordsHelper:n}=e;if(null==r||!n.fromRenderCoords(t,Pe,s))return!1;const[a,o,l]=Pe,c=await r.queryElevation(a,o,l,s,"ground",i)??0;return(0,h.k_)(i),c>l-1}(e,l.eye,o)){(0,h.k_)(o);const{tilt:a,mode:l}=rt(e,i,s,n);return et(e,t,a,r,s,n,l,o)}return st(l,s)}function tt(e,t,i,r,s,n){const a=function(e,t,i,r,s,n){let a=0;return n===De.ADJUST&&function(e,t,i){const r=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(i/r)/Math.LN2>8)return!0;const s=t,n=e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation;return(0,u.j)(s,n)/(Math.tan(.5*e.state.camera.fov)*r)>5}(e,r,s)?(t=0,a=function(e,t,i,r){const s=pt(e,r,t,i);if(!e.state.constraints.tilt)return s;const n=e.state.constraints.tilt(t);n.max=Math.min(n.max,.5*Math.PI);const a=n.min*(1-ut)+n.max*ut;return Math.min(s,a)}(e,s,i,r)):a=pt(e,r,s,i),a=e.state.constraints.clampTilt(s,a),{heading:t,tilt:i=dt(e,r,s,a)}}(e,t,i,r,s=Math.max(s,e.state.constraints.minimumPoiDistance),n);return(0,Le(e).eyeForCenterWithHeadingTilt)(r,s,a.heading,a.tilt)}function it(e,t,i){const r=e.map.ground.navigationConstraint;return i===De.ADJUST&&e.state.isGlobal&&t>0&&(null==r||"stay-above"===r.type)}function rt(e,t,i,r){const s=dt(e,i,r,function(e,t,i,r){let s=pt(e,r,t,i);if(!e.state.constraints.tilt)return s;const n=e.state.constraints.tilt(t);return s=Math.min(s,.5*Math.PI),n.min*(1-ut)+s*ut}(e,r,t,i));return{tilt:s,mode:t-s<1?De.LOCKED:De.ADJUST}}function st(e,t){return{...e,center:(0,d.d9)(t)}}function nt(e,t){const{state:i,spatialReference:r}=e,s=t.spatialReference;return i.isGlobal&&(0,Se.D)(s,b.JY.Global)||i.isLocal&&r.equals(s)}function at(e,t){let i,r,s;if(e.state.isGlobal){const e=new m.Z(t.xmin,t.ymin,t.spatialReference),n=new m.Z(t.xmax,t.ymax,t.spatialReference),a=t.spatialReference.isGeographic?Oe:Ae;i=new m.Z({x:a.center(e.x,n.x),y:(n.y+e.y)/2,z:null!=t.zmax&&null!=t.zmin?(t.zmax+t.zmin)/2:void 0,spatialReference:t.spatialReference});const o=(0,p.Iu)(t.spatialReference),l=(0,ie.Nf)(i,e,n);r=l.lon,s=l.lat,a.diff(e.x,n.x)>a.range/2&&(r+=o.halfCircumference),r=Math.min(r,o.halfCircumference),s=Math.min(s,o.halfCircumference)}else{const n=e.renderSpatialReference??t.spatialReference;n.equals(t.spatialReference)||(t=(0,_.project)(t,n)),r=t.xmax-t.xmin,s=t.ymax-t.ymin;const a=null!=t.zmax&&null!=t.zmin?(t.zmax+t.zmin)/2:void 0;i=new m.Z({x:t.xmin+.5*r,y:t.ymin+.5*s,z:a,spatialReference:n})}const n=null!=t.zmax&&null!=t.zmin?t.zmax-t.zmin:0,a=e.state.camera,o=1/Math.tan(a.fovX/2),l=1/Math.tan(a.fovY/2),c=1/Math.tan(a.fov/2);return{center:i,distance:Math.max(.5*r*o,.5*s*l,.5*n*c)/1}}async function ot(e,t,i,r,s,n){const a=nt(e,t)?t:await(0,_.projectWithZConversion)(t,e.spatialReference,{signal:n});(0,h.k_)(n);const{center:o,distance:l}=at(e,a),c=await Ke(e,i,r,o,l,s,n);return(0,h.k_)(n),_t(e,c,e.camera.fov,n)}function lt(e,t,i,r,s,n){let a;try{a=nt(e,t)?t:(0,_.project)(t,e.spatialReference)}catch(e){return null}const{center:o,distance:l}=at(e,a),c=Qe(e,i,r,o,l,s);return null==c?null:mt(e,c,e.camera.fov,n)}function ct(e,t,i){const r=e.renderSpatialReference,s=new m.Z({spatialReference:Ie(e)});if(!(0,y.f)(i,r,s))return null;const n=Math.tan(t.fovX/2),a=Math.tan(t.fovY/2),o=(0,u.F)(t.eye,i),l=2*o*n*1,c=2*o*a*1;return Le(e).toExtent(e,s,l,c)}function ht(e,t){return Le(e).toArea(e,t)}const ut=.7;function dt(e,t,i,r){return Le(e).lookAtTiltToEyeTilt(r,t,i)}function pt(e,t,i,r){return Le(e).eyeTiltToLookAtTilt(r,t,i)}function mt(e,t,i,r){if(null==t)return null;const s=e.renderSpatialReference,n=new m.Z({spatialReference:Ie(e)});return(0,y.f)(t.eye,s,n)?(r??=new a.Z,r.position=n,r.heading=t.heading,r.tilt=t.tilt,r.fov=i,r):null}async function _t(e,t,i,r){const s=e.renderSpatialReference,n=new m.Z({spatialReference:Ie(e)});return await(0,y.A)(t.eye,s,n,{signal:r}),(0,h.k_)(r),new a.Z(n,t.heading,t.tilt,i)}function ft(e,t){const i=e.basemapTerrain?.tilingScheme;if(i)return i.levelAtScale(t);Me().error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function gt(e,t){const i=e.basemapTerrain?.tilingScheme;if(i)return i.scaleAtLevel(t);Me().error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}},59758:function(e,t,i){i.d(t,{H2:function(){return d},dp:function(){return h},t_:function(){return u}});var r=i(99574),s=i(24910),n=i(82846),a=i(88970),o=i(77773);const l=(0,n.Ue)(),c=(0,n.Ue)();function h(){return{direction:(0,n.Ue)(),up:(0,n.Ue)()}}function u(e,t,i,n,a){let o=(0,s.n)(l,e),h=(0,s.e)(o,n);const u=h>0;h=Math.abs(h),h>.99&&(h=Math.abs((0,s.e)(t,n)),h<.99?((0,s.c)(o,t),u&&(0,s.g)(o,o,-1)):o=null);let d=0;if(o){(0,s.g)(c,n,(0,s.e)(n,o)),(0,s.d)(o,o,c);const e=(0,s.e)(o,a)/((0,s.l)(o)*(0,s.l)(a));(0,s.h)(c,o,a),d=((0,s.e)(c,n)>0?1:-1)*(0,r.BV)((0,r.ZF)(e))}const p=(0,r.BV)((0,r.ZF)(-(0,s.e)(n,e)/(0,s.l)(e)));return i?(i.heading=d,i.tilt=p,i):{heading:d,tilt:p}}function d(e,t,i,r){(0,s.d)(p,i,t),(0,o.rx)(r,(0,a.re)(t,p),e)||e===i||(0,s.c)(e,i)}const p=(0,n.Ue)()},13445:function(e,t,i){i.d(t,{Bh:function(){return h},eW:function(){return d},iE:function(){return u},j$:function(){return l},u4:function(){return c}});var r=i(96094),s=i(26821),n=i(24910),a=i(12659),o=i(69811);function l(e,t,i=(0,a.Ue)()){return c(e,(0,r.md)(t),i),(0,n.n)(i.direction,i.direction),i}function c(e,t,i){return h(e,e.screenToRender(t,(0,r.Wv)(o.WM.get())),i)}function h(e,t,i){const a=(0,r.Wv)((0,s.JG)(o.WM.get(),t));if(a[2]=0,!e.unprojectFromRenderScreen(a,i.origin))return null;const l=(0,r.Wv)((0,s.JG)(o.WM.get(),t));l[2]=1;const c=e.unprojectFromRenderScreen(l,o.WM.get());return null==c?null:((0,n.d)(i.direction,c,i.origin),i)}function u(e,t,i){return d(e,e.screenToRender(t,(0,r.Wv)(o.WM.get())),i)}function d(e,t,i){(0,n.c)(i.origin,e.eye);const r=(0,n.i)(o.WM.get(),t[0],t[1],1),s=e.unprojectFromRenderScreen(r,o.WM.get());return null==s?null:((0,n.d)(i.direction,s,i.origin),i)}},43759:function(e,t,i){i.d(t,{K0:function(){return M},qL:function(){return w},wX:function(){return b}});var r=i(46451),s=i(96302),n=i(96094),a=i(82846),o=i(60508),l=i(45213),c=i(2051),h=i(78646),u=i(75428),d=i(27762),p=i(90494),m=i(92490),_=i(61442),f=i(32033),g=i(19821),y=i(90189),v=i(43925);async function b(e,t,i,r){const s=i?E(e,i):r,a=(0,n.s1)(t.x,t.y);s.requiresGroundFeedback=!0,s.enableDraped=!0;const o=new m.r(e.state.viewingMode);o.options.selectionMode=!0,o.options.store=_.e.ALL,e.sceneIntersectionHelper.intersectIntersectorScreen(a,o,s);const l=await async function(e,t,i){const r=new Array;let s,n=null;const a={defer(e){s=e()}};for(let o=0;o<t.length;o++){const l=t[o],c=(0,y.J4)(l,e);if(null!=c&&(c===e.map.ground||"type"in c&&(0,u.nx)(c.type)))break;const h=(0,y.bK)(l,e,a)??await s;if(s=null,null==h)continue;if("graphic"===h.type){if(null==n&&o!==t.length-1&&(n=new Set),null!=n){const e=x(h.graphic);if(n.has(e))continue;n.add(e)}if(!T(i,h.graphic))continue}const d=C(e,l),p=l.distanceInRenderSpace;if("media"===h.type){const e=h.element.toSource(d);r.push({...h,mapPoint:d,distance:p,sourcePoint:e})}else r.push({...h,mapPoint:d,distance:p})}return r}(e,o.results.all,s.graphics),c=o.results.ground,h=(0,y.J4)(c,e),p=null!=h&&"type"in h&&(0,u.nx)(h.type)?h:null,g={screenPoint:t,results:l,ground:{mapPoint:C(e,c),distance:(0,f.n)(c)?c.distanceInRenderSpace:0,layer:p}};return d.h.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(g.intersector=o),g}function w(e,t,i,r){const s=i?E(e,i):r,a=!(!s.graphics?.include&&!s.graphics?.exclude),o=!(!s.mediaElements?.include&&!s.mediaElements?.exclude),l=(0,n.md)(t);s.enableDraped=s.include&&!s.include.has(v.xX)||s.exclude?.has(v.xX);const c=e.sceneIntersectionHelper,h=new m.r(e.state.viewingMode);if(h.options.selectionMode=!0,h.options.store=a||o?_.e.ALL:_.e.MIN,h.options.excludeLabels=i?.excludeLabels??!1,c.intersectIntersectorScreen(l,h,s),a||o){for(const t of h.results.all){const i=(0,y.bK)(t,e);if(null==i)return C(e,t);if(a&&("graphic"!==i.type||T(s.graphics,i.graphic)))return C(e,t);if(o&&("media"!==i.type||S(s.mediaElements,i.element)))return C(e,t)}return null}return C(e,h.results.min)}function C(e,t,i){return t.getIntersectionPoint(O)?(i=M(e,O,i),t.intersector===g.q.TERRAIN&&e.basemapTerrain&&(i.z=(0,p.KO)(e.basemapTerrain,i)??0),i):null}function x(e){const t=e.sourceLayer,i=e.layer,r=t&&"objectIdField"in t?t:i&&"objectIdField"in i?i:t;if(r){const t=r.objectIdField??h.d,i=e.attributes?.[t];if(i)return`o-${r.id}-${i}`}return`u-${e.uid}`}function T(e,t){return S(e,x(t))}function S(e,t){return null==e||(null==e.include||e.include.has(t))&&(null==e.exclude||!e.exclude.has(t))}function M(e,t,i){let r=e.spatialReference||l.Z.WGS84;return(0,c.S)(t,e.renderSpatialReference,O,r)?t=O:(r=l.Z.WGS84,(0,c.S)(t,e.renderSpatialReference,O,r)&&(t=O)),i?(i.x=t[0],i.y=t[1],i.z=t[2],i.spatialReference=r):i=new o.Z(t,r),i}function E(e,t){const i=R(e,t.include,D.INCLUDE),r=R(e,t.exclude,D.EXCLUDE);return{include:i.layerViewUids,exclude:r.layerViewUids,graphics:{include:i.graphicUids,exclude:r.graphicUids},mediaElements:{include:i.mediaElements,exclude:r.mediaElements}}}function R(e,t,i,n={layerViewUids:void 0,graphicUids:void 0,mediaElements:void 0}){if(!t)return n;if(t instanceof r.Z)(function(e,t){e.graphicUids||(e.graphicUids=new Set),e.graphicUids.add(t)})(n,x(t)),i===D.INCLUDE&&(null!=e.graphicsView&&t.layer===e?A(n,e.graphicsView.uid):t.layer&&P(n,e,t.layer.uid));else if("layer"in t&&"element"in t)(function(e,t){e.mediaElements||(e.mediaElements=new Set),e.mediaElements.add(t)})(n,t.element),i===D.INCLUDE&&P(n,e,t.layer.uid);else if((0,s.TW)(t))for(const r of t)r===e.graphics&&null!=e.graphicsView?A(n,e.graphicsView.uid):r===e.map.ground?A(n,v.xX):R(e,r,i,n);else"uid"in t&&P(n,e,t.uid);return n}function P(e,t,i){const r=t.allLayerViews.find((e=>e.layer.uid===i));r&&A(e,r.uid)}function A(e,t){e.layerViewUids||(e.layerViewUids=new Set),e.layerViewUids.add(t)}const O=(0,a.Ue)();var D;!function(e){e[e.INCLUDE=0]="INCLUDE",e[e.EXCLUDE=1]="EXCLUDE"}(D||(D={}))},88270:function(e,t,i){var r;i.d(t,{Bh:function(){return r},NT:function(){return n},Ty:function(){return s}}),function(e){e[e.ELEVATION=0]="ELEVATION",e[e.BASEMAP=1]="BASEMAP",e[e.I3S_INDEX=2]="I3S_INDEX",e[e.I3S_DATA=3]="I3S_DATA",e[e.SYMBOLOGY=4]="SYMBOLOGY"}(r||(r={}));const s=(()=>{const e=new Array;return e[r.ELEVATION]=10,e[r.BASEMAP]=10,e[r.I3S_INDEX]=10,e[r.I3S_DATA]=10,e[r.SYMBOLOGY]=5,e})(),n=30},39717:function(e,t,i){i.d(t,{M:function(){return s},O:function(){return n}});var r=i(8554);function s(e){return n(e)||(0,r.BZ)(e)||(0,r.V2)(e)}function n(e){return(0,r.oR)(e)||(0,r.yW)(e)}},81808:function(e,t,i){i.d(t,{V:function(){return r},q:function(){return s}});const r={value:.5,readOnly:!0},s={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}}},77755:function(e,t,i){i.d(t,{Q8:function(){return U},QI:function(){return L},Ue:function(){return H},toCameraAsync:function(){return F}});var r=i(41309),s=i(46451),n=i(27172),a=i(29292),o=(i(61432),i(95437)),l=i(88194),c=i(93568),h=i(96373),u=i(30748),d=i(10934),p=i(24910),m=i(82846),_=i(71354),f=i(82890),g=i(82868),y=i(60508),v=i(13132),b=i(45213),w=i(74238),C=i(6961),x=i(96937),T=i(2051),S=i(16447),M=i(47566),E=i(33869),R=i(4469),P=i(97750),A=i(69892),O=i(90494);function D(e){return 360-o.BV.normalize(e)}function I(e){return o.BV.normalize(360-e)}function L(e,t,i){const r=t.camera;if(null!=r)return function(e,t){const i=e.position;let r;try{r=(0,v.tryProjectWithZConversion)(i,t)}catch(e){return null}if(!r)return null;const s=e.clone();return s.position=r.clone(),s}(r,(0,A.h5)(e));const{targetGeometry:s}=t;if(null==s)return null;const{camera:n,mode:a}=N(e,t.rotation,i);if("point"===s.type)return function(e,t,i,r,s){const n=e.spatialReference;let a;try{a=(0,v.tryProjectWithZConversion)(i.clone(),n)}catch(e){return null}if(!a)return null;const o=null!=t.scale?(0,A._U)(e,t.scale):e.state.camera.distance;return(0,A.Hm)(e,a,o,r,s)}(e,t,s,n,a);const o=s.extent;return null==o?null:(0,A.S9)(e,o,n.heading,n.tilt,a)}async function F(e,t,i,r){const s=t.camera;if(null!=s)return async function(e,t,i){const r=e.position,s=await(0,v.projectWithZConversion)(r,t,{signal:i});(0,c.k_)(i);const n=e.clone();return n.position=s.clone(),n}(s,(0,A.h5)(e),r);const{targetGeometry:n}=t;if(null==n)throw new Error("Viewpoint has no targetGeometry!");const{camera:a,mode:o}=N(e,t.rotation,i);if("point"===n.type)return async function(e,t,i,r,s,n){const a=e.spatialReference,o=await(0,v.projectWithZConversion)(i.clone(),a,{signal:n});(0,c.k_)(n);const l=null!=t.scale?(0,A._U)(e,t.scale):e.state.camera.distance;return(0,A.gL)(e,o,l,r,s,n)}(e,t,n,a,o,r);const l=n.extent;if(null==l)throw new Error("Target geometry has no extent!");return(0,A.Ic)(e,l,a.heading,a.tilt,o,r)}function N(e,t,i){const r=(0,A.l0)(e,e.state.camera);let s=A.Q8.ADJUST;return null!=t&&(r.heading=D(t),s=A.Q8.LOCKED),null!=i&&(r.tilt=i),{camera:r,mode:s}}function U(e,t,i=null){return null==i&&(i=new n.Z),B(e,null,t.clone(),i)}async function H(e,t,i){const s=function(e,t){if(!t||!e.spatialReference)return null;const i={target:void 0};return"declaredClass"in t||Array.isArray(t)?i.target=t:(Object.assign(i,t),!i.target&&"center"in t&&t.center&&(i.target=t.center)),i}(e,t);if(!s)throw new l.Z("viewpointutils-create:no-target","Missing target for creating viewpoint");const a=new r.Z({fov:e.camera.fov}),o=new n.Z({camera:a});if(s.target instanceof n.Z)return j(await async function(e,t,i,r,s){if(t.camera)return q(e,t.camera,r,s);s.scale=t.scale,s.rotation=t.rotation,s.targetGeometry=null!=t.targetGeometry?t.targetGeometry.clone():null,s.camera=null,null!=i.heading?s.rotation=I(i.heading):null!=i.rotation&&(s.rotation=i.rotation);const n=V(e,i);return null!=n&&(s.scale=n),s.camera=await F(e,s,i.tilt,r),s}(e,s.target,s,i,o));if(s.target instanceof r.Z)return j(await q(e,s.target,i,o));const c=null!=s.scale||null!=s.zoom;if(s.target instanceof _.Z){const t=s.target.xmin===s.target.xmax||s.target.ymin===s.target.ymax;return j(c||t?await Z(e,s,s.target.center,a,i,o):await async function(e,t,i,r,s,n){n.targetGeometry=i.clone();const a=(0,P.dP)(e);(0,A.l0)(e,a,r);const o=k(r,t)?A.Q8.LOCKED:A.Q8.ADJUST;return n.camera=await(0,A.Ic)(e,i,r.heading,r.tilt,o,s),n}(e,s,s.target,a,i,o))}const u=new W,d=c?function(e,t){const i=V(e,t);return i?(0,R.DE)(i):void 0}(e,s):void 0;if(await G(e,s.target,d,u,i),isFinite(u.boundingBox[0])){let t;if((0,S.be)(u.boundingBox,$),re.x=$[0],re.y=$[1],re.z=$[2],re.spatialReference=e.spatialReference,isFinite(re.z)&&u.hasZ?t=(0,S.wp)(u.boundingBox):(re.z=void 0,t=(0,M.wp)((0,S.y8)(u.boundingBox,K))),c||t)return j(await Z(e,s,re,a,i,o));const r=function(e,t){const i=.66;if(!t.length)return i;let r=Number.NEGATIVE_INFINITY;for(let e=0;e<t.length;e++){const i=t[e].screenSpaceBoundingRect;r=Math.max(r,Math.abs(i[0]),Math.abs(i[1]),Math.abs(i[2]),Math.abs(i[3]))}return i-r/Math.min(e.width,e.height)*2}(e,u.screenSpaceObjects);return j(await async function(e,t,i,r,s,n,a,o){o.targetGeometry=i.clone();const l=(0,P.dP)(e),c=function(e,t,i,r,s){let n=0;null!=i.z?n=i.z:e.basemapTerrain&&e.elevationProvider&&(n=(0,O.KO)(e.elevationProvider,i)),(0,p.i)($,i.x,i.y,n),(0,w.B)(e.spatialReference,$,X,e.renderSpatialReference),(0,h.xO)(Y,X),(0,h.p4)(Y,Y),(0,S.cS)(Q);const a=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(let t=0;t<a.length;t++){const i=a[t];let s=r[i[2]];isFinite(s)||(s=n),(0,p.i)($,r[i[0]],r[i[1]],s),(0,T.S)($,e.spatialReference,$,e.renderSpatialReference),(0,S.pp)(Q,(0,p.o)($,$,Y))}const o=(0,S.bf)(Q),l=(0,S.Cb)(Q),c=(0,S.Ye)(Q),u=1/Math.tan(t.fovX/2),d=1/Math.tan(t.fovY/2),m=.5*Math.sqrt(o*o+c*c)*Math.max(d,u)+.5*l,_=.5*l*d+.5*Math.max(o,c);return Math.max(m,_)/s}(e,l,i,r,s);(0,A.l0)(e,l,n);const u=k(n,t)?A.Q8.LOCKED:A.Q8.ADJUST;return o.camera=await(0,A.gL)(e,o.targetGeometry,c,n,u,a),o.scale=(0,A.Xt)(e,c),o}(e,s,re,u.boundingBox,r,a,i,o))}return s.position?j(await async function(e,t,i,r,s){const n=(0,P.dP)(e);(0,p.c)(J,n.viewForward),(0,A.t_)(e,n.eye,J,n.up,ie);const a=e.spatialReference,{position:o}=t;if(o){const e=await(0,v.projectWithZConversion)(o,a,{signal:s});i.position=e}else i.position=new y.Z;return i.heading=null!=t.heading?t.heading:ie.heading,i.tilt=null!=t.tilt?t.tilt:ie.tilt,B(e,null,i,r)}(e,s,a,o,i)):j(await async function(e,t,i,r,s){if(null!=t.heading||null!=t.rotation||null!=t.scale||null!=t.tilt||null!=t.zoom||null!=t.zoomFactor){const n=(0,P.dP)(e),{spatialReference:a,renderSpatialReference:o}=e,l=new y.Z({spatialReference:a});return(0,x.f)(n.center,o,l)?Z(e,t,l,i,r,s):s}return s.scale=e.scale,s.camera=e.camera.clone(),k(s.camera,t),s}(e,s,a,i,o))}function V(e,t){return null==t.scale&&null!=t.zoom?(0,A.EO)(e,t.zoom):t.scale}function k(e,t){let i=!1;return null!=t.heading?(e.heading=t.heading,i=!0):null!=t.rotation&&(e.heading=D(t.rotation),i=!0),null!=t.tilt&&(e.tilt=t.tilt,i=!0),null!=t.fov&&(e.fov=t.fov),i}function B(e,t,i,r){const s=e.spatialReference||b.Z.WGS84;if(t??=(0,A.n3)(e,i),null==t)return r;const n=new y.Z({spatialReference:s});return(0,x.f)(t.center,e.renderSpatialReference,n)?(r.targetGeometry=n,r.scale=(0,A.Xt)(e,t.distance),r.rotation=I(i.heading),r.camera=i,r):r}async function z(e,t,i,r){const s=()=>new l.Z("viewpointutils:invalid-geometry","The target is missing a valid geometry");if(!t)throw s();"mesh"===t.type&&(t=t.extent);const n=e.basemapTerrain.spatialReference;if(!t.hasZ&&e.basemapTerrain){let i;switch(t.type){case"point":i=t;break;case"multipoint":case"polyline":i=t.extent?.center;break;case"extent":i=t.center;break;case"polygon":i=t.centroid}null!=i&&n&&e.elevationProvider?(i=await(0,v.projectWithZConversion)(i,n,{signal:r}),$[2]=(0,O.KO)(e.elevationProvider,i)??0):$[2]=0}const a=se[t.type],o=new Array;if(a(t,t.hasZ?e=>{o.push([e[0],e[1],e[2]])}:e=>{o.push([e[0],e[1]])},$),0===o.length)throw s();const c=t.spatialReference,h=e.spatialReference,u=await(0,v.projectWithZConversion)(new g.Z({spatialReference:c,hasZ:t.hasZ,hasM:!1,points:o}),h,{signal:r});if(t.hasZ&&(i.hasZ=!0),t.hasZ)for(const[e,t,r]of u.points)$[0]=e,$[1]=t,$[2]=r,(0,S.pp)(i.boundingBox,$);else for(const[e,t]of u.points)$[0]=e,$[1]=t,(0,S.pp)(i.boundingBox,$)}async function G(e,t,i,r,n){if(Array.isArray(t)&&2===t.length){const i=t[0],s=t[1];if("number"==typeof i&&"number"==typeof s)return re.x=i,re.y=s,re.z=void 0,re.spatialReference=e.spatialReference?.isGeographic?e.spatialReference:b.Z.WGS84,void await z(e,re,r,n)}t&&"map"in t&&"function"==typeof t.map?await Promise.allSettled(t.map((t=>G(e,t,i,r,n)))):t instanceof f.Z?await z(e,t,r,n):t instanceof s.Z&&await async function(e,t,i,r,s){const n=await(0,a.q6)(e.whenViewForGraphic(t));if(!1===n.ok||null==n.value||!("whenGraphicBounds"in n.value))return void await z(e,t.geometry,r,s);const o=n.value,l=await(0,a.q6)(o.whenGraphicBounds(t,{minDemResolution:i}));if(!1===l.ok||!l.value)return void await z(e,t.geometry,r,s);const{screenSpaceObjects:c,boundingBox:h}=l.value;(0,S.TC)(r.boundingBox,h),c&&c.forEach((e=>{r.screenSpaceObjects.push(e)})),isFinite(h[2])&&(r.hasZ=!0)}(e,t,i,r,n)}async function q(e,t,i,r){const s=e.spatialReference,n=await(0,v.projectWithZConversion)(t.position,s,{signal:i}),a=t.clone();return a.position=n,B(e,null,a,r)}async function Z(e,t,i,r,s,n){n.targetGeometry=i.clone();const a=(0,P.dP)(e);if(t.position)return async function(e,t,i,r,s,n,a){const o=e.renderSpatialReference;return await(0,C.U)(t,te,o,0,{signal:a}),await(0,C.U)(i,ee,o,0,{signal:a}),n.targetGeometry=new y.Z(t),s.position=new y.Z(i),(0,p.d)(J,te,ee),(0,A.t_)(e,ee,J,r.up,s),n.scale=(0,A.Xt)(e,(0,p.j)(ee,te)),n.rotation=I(s.heading),n.camera=s,n}(e,n.targetGeometry,t.position,a,r,n,s);if(t.zoomFactor){const i=a.distance/t.zoomFactor,r=(0,p.g)($,a.viewForward,-i);a.eye=(0,p.f)($,a.center,r),n.scale=(0,A.Xt)(e,i)}(0,A.l0)(e,a,r);const o=k(r,t)?A.Q8.LOCKED:A.Q8.ADJUST;if(!t.zoomFactor){const i=V(e,t);if(null==i){await(0,C.U)(n.targetGeometry,$,e.renderSpatialReference,0,{signal:s});const t=(0,E.g8)(a.frustum,$)?(0,p.j)(a.eye,$):a.distance;n.camera=await(0,A.gL)(e,n.targetGeometry,t,r,o),n.scale=(0,A.Xt)(e,t)}else n.scale=i,n.camera=await(0,A.UI)(e,n.targetGeometry,n.scale,r,o,s)}return n}function j(e){return null!=e?.camera&&(e.rotation=I(e.camera.heading)),e}class W{constructor(){this.hasZ=!1,this.boundingBox=(0,S.cS)(),this.screenSpaceObjects=new Array}}const $=(0,m.Ue)(),X=(0,d.Ue)(),Y=(0,u.Ue)(),Q=(0,S.Ue)(),K=(0,M.Ue)(),J=(0,m.Ue)(),ee=(0,m.Ue)(),te=(0,m.Ue)(),ie={heading:0,tilt:0},re=new y.Z,se={point(e,t,i){i[0]=e.x,i[1]=e.y,null!=e.z&&(i[2]=e.z),t(i)},polygon(e,t,i){const r=e.hasZ;for(let s=0;s<e.rings.length;s++){const n=e.rings[s];for(let e=0;e<n.length;e++)i[0]=n[e][0],i[1]=n[e][1],r&&(i[2]=n[e][2]),t(i)}},polyline(e,t,i){const r=e.hasZ;for(let s=0;s<e.paths.length;s++){const n=e.paths[s];for(let e=0;e<n.length;e++)i[0]=n[e][0],i[1]=n[e][1],r&&(i[2]=n[e][2]),t(i)}},multipoint(e,t,i){const r=e.points,s=e.hasZ;for(let e=0;e<r.length;e++)i[0]=r[e][0],i[1]=r[e][1],s&&(i[2]=r[e][2]),t(i)},extent(e,t,i){null!=e.zmin&&null!=e.zmax?(t((0,p.i)(i,e.xmin,e.ymin,e.zmin)),t((0,p.i)(i,e.xmax,e.ymin,e.zmin)),t((0,p.i)(i,e.xmin,e.ymax,e.zmin)),t((0,p.i)(i,e.xmax,e.ymax,e.zmin)),t((0,p.i)(i,e.xmin,e.ymin,e.zmax)),t((0,p.i)(i,e.xmax,e.ymin,e.zmax)),t((0,p.i)(i,e.xmin,e.ymax,e.zmax)),t((0,p.i)(i,e.xmax,e.ymax,e.zmax))):(t((0,p.i)(i,e.xmin,e.ymin,i[2])),t((0,p.i)(i,e.xmax,e.ymin,i[2])),t((0,p.i)(i,e.xmin,e.ymax,i[2])),t((0,p.i)(i,e.xmax,e.ymax,i[2])))}}},29499:function(e,t,i){var r;i.d(t,{X:function(){return r}}),function(e){e[e.NORTH=0]="NORTH",e[e.NORTH_EAST=1]="NORTH_EAST",e[e.EAST=2]="EAST",e[e.SOUTH_EAST=3]="SOUTH_EAST",e[e.SOUTH=4]="SOUTH",e[e.SOUTH_WEST=5]="SOUTH_WEST",e[e.WEST=6]="WEST",e[e.NORTH_WEST=7]="NORTH_WEST"}(r||(r={}))},74446:function(e,t,i){var r;i.d(t,{z:function(){return r}}),function(e){e[e.BACK_TO_FRONT=-1]="BACK_TO_FRONT",e[e.NONE=0]="NONE",e[e.FRONT_TO_BACK=1]="FRONT_TO_BACK"}(r||(r={}))},61554:function(e,t,i){i.d(t,{$X:function(){return a},C5:function(){return p},Cf:function(){return o},GZ:function(){return h},JR:function(){return d},if:function(){return l},p1:function(){return m},qC:function(){return _},uU:function(){return u},zl:function(){return c}});var r=i(99574),s=i(47566),n=i(76060);const a=64,o=512,l=2.5,c=(0,r.oK)(r.F3/10),h=2,u=(0,s.Ue)();n.t.WebMercatorAuxiliarySphere.getExtent(0,0,0,u);const d=(0,s.Ue)([-180,-90,180,90]),p="Cannot extend surface to encompass all layers because it would result in too many root tiles.",m="Surface extent is too large for tile resolution at level 0.",_=4},74796:function(e,t,i){function r(e){return null!=e&&"type"in e&&"vector-tile"===e.type}function s(e){return null!=e&&"type"in e&&"raster-tile"===e.type}function n(e){return null!=e&&"type"in e&&"tile-texture"===e.type}function a(e){return null!=e&&"type"in e&&"image+type"===e.type}i.d(t,{AK:function(){return r},Cm:function(){return a},Q_:function(){return n},yd:function(){return s}})},76060:function(e,t,i){i.d(t,{_:function(){return _},t:function(){return m}});var r=i(88194),s=(i(61432),i(99574)),n=i(26636),a=i(71354),o=i(60508),l=i(45213),c=i(47566),h=i(8554),u=i(97290),d=i(45107),p=i(97550);class m{constructor(e){const t=m.checkUnsupported(e);if(null!=t)throw t;const i=e;this.spatialReference=i.spatialReference,this._isWebMercator=this.spatialReference.isWebMercator,this._isGCS=(0,h.sT)(this.spatialReference),this.origin=[i.origin.x,i.origin.y],this.pixelSize=i.size[0],this.dpi=i.dpi;const r=i.lods.reduce(((e,t)=>(t.level<e.minLod.level&&(e.minLod=t),e.max=Math.max(e.max,t.level),e)),{minLod:i.lods[0],max:-1/0}),s=r.minLod,n=2**s.level;let a=s.resolution*n,o=s.scale*n;this.levels=new Array(r.max+1);for(let e=0;e<this.levels.length;e++)this.levels[e]={resolution:a,scale:o,tileSize:[a*i.size[0],a*i.size[1]]},a/=2,o/=2}clone(){return new m(this.toTileInfo())}toTileInfo(){return new p.Z({dpi:this.dpi,origin:new o.Z({x:this.origin[0],y:this.origin[1],spatialReference:this.spatialReference}),size:[this.pixelSize,this.pixelSize],spatialReference:this.spatialReference,lods:this.levels.map(((e,t)=>new d.Z({level:t,scale:e.scale,resolution:e.resolution})))})}getExtent(e,t,i,r){const s=this.levels[e],n=s.tileSize[0],a=s.tileSize[1];r[0]=this.origin[0]+i*n,r[2]=this.origin[0]+(i+1)*n,r[3]=this.origin[1]-t*a,r[1]=this.origin[1]-(t+1)*a}convertExtentToRadians(e,t){this._isWebMercator?(t[0]=(0,u.tp)(e[0]),t[1]=(0,u.mZ)(e[1]),t[2]=(0,u.tp)(e[2]),t[3]=(0,u.mZ)(e[3])):this._isGCS&&(t[0]=(0,s.Vl)(e[0]),t[1]=(0,s.Vl)(e[1]),t[2]=(0,s.Vl)(e[2]),t[3]=(0,s.Vl)(e[3]))}getExtentGeometry(e,t,i,r=new a.Z){return this.getExtent(e,t,i,f),r.spatialReference=this.spatialReference,r.xmin=f[0],r.ymin=f[1],r.xmax=f[2],r.ymax=f[3],r.zmin=void 0,r.zmax=void 0,r}ensureMaxLod(e){if(null==e)return!1;let t=!1;for(;this.levels.length<=e;){const{resolution:e,scale:i}=this.levels[this.levels.length-1],r=e/2*this.pixelSize;this.levels.push({resolution:e/2,scale:i/2,tileSize:[r,r]}),t=!0}return t}capMaxLod(e){this.levels.length>e+1&&(this.levels.length=e+1)}getMaxLod(){return this.levels.length-1}scaleAtLevel(e){return this.levels[0].scale/2**e}levelAtScale(e){const t=this.levels[0].scale;return e>=t?0:Math.log(t/e)*Math.LOG2E}resolutionAtLevel(e){return this.levels[0].resolution/2**e}compatibleWith(e,t=1/0){if(m.checkUnsupported(e))return!1;const i=new m(e);if(!i.spatialReference.equals(this.spatialReference))return!1;if(i.pixelSize!==this.pixelSize)return!1;const r=Math.min(this.levels.length-1,i.levels.length-1,t),n=this.levels[r].resolution;let a=.5*n;return!(!(0,s.W8)(i.origin[0],this.origin[0],a)||!(0,s.W8)(i.origin[1],this.origin[1],a))&&(a=.5*n/2**r/this.pixelSize*12,(0,s.W8)(n,i.levels[r].resolution,a))}rootTilesInExtent(e,t=null,i=1/0){const r=new Array,s=this.levels[0].tileSize;if(null==e||0===s[0]||0===s[1])return r;m.computeRowColExtent(e,s,this.origin,f);let n=f[1],a=f[3],o=f[0],l=f[2];const c=l-o,h=a-n;if(c*h>i){const e=Math.floor(Math.sqrt(i));h>e&&(n=n+Math.floor(.5*h)-Math.floor(.5*e),a=n+e),c>e&&(o=o+Math.floor(.5*c)-Math.floor(.5*e),l=o+e)}for(let e=n;e<a;e++)for(let t=o;t<l;t++)r.push([0,e,t]);return null!=t&&(t[0]=this.origin[0]+o*s[0],t[1]=this.origin[1]-a*s[1],t[2]=this.origin[0]+l*s[0],t[3]=this.origin[1]-n*s[1]),r}static computeRowColExtent(e,t,i,r){const s=.001*(e[2]-e[0]+(e[3]-e[1]));r[0]=Math.max(0,Math.floor((e[0]+s-i[0])/t[0])),r[2]=Math.max(0,Math.ceil((e[2]-s-i[0])/t[0])),r[1]=Math.max(0,Math.floor((i[1]-e[3]+s)/t[1])),r[3]=Math.max(0,Math.ceil((i[1]-e[1]-s)/t[1]))}static isPowerOfTwo(e){const t=e.lods,i=t[0].resolution*2**t[0].level;return!t.some((e=>!(0,s.Y8)(e.resolution,i/2**e.level)))}static hasGapInLevels(e){const t=e.lods.map((e=>e.level));t.sort(((e,t)=>e-t));for(let e=1;e<t.length;e++)if(t[e]!==t[0]+e)return!0;return!1}static tileSizeSupported(e){const t=e.size[1];return t===e.size[0]&&!(t&t-1)&&t>=128&&t<=512}static hasOriginPerLODs(e){const t=e.origin;return e.lods.some((e=>null!=e.origin&&(e.origin[0]!==t.x||e.origin[1]!==t.y)))}static getMissingTileInfoError(){return new r.Z("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}static checkUnsupported(e){return null==e?_():e.lods.length<1?new r.Z("tilingscheme:generic","Tiling scheme must have at least one level"):m.isPowerOfTwo(e)?m.hasGapInLevels(e)?new r.Z("tilingscheme:gaps","Tiling scheme levels must not have gaps between min and max level"):m.tileSizeSupported(e)?m.hasOriginPerLODs(e)?new r.Z("tilingscheme:multiple-origin","Tiling scheme levels must not have their own origin"):null:new r.Z("tilingscheme:tile-size","Tiles must be square and size must be one of [128, 256, 512]"):new r.Z("tilingscheme:power-of-two","Tiling scheme must be power of two")}static fromExtent(e,t){const i=e[2]-e[0],r=e[3]-e[1],s=(0,n.c9)(t),a=1.2*Math.max(i,r),l=a/256,c=l*s*(96/.0254),h=new m(new p.Z({size:[256,256],origin:new o.Z({x:e[0]-.5*(a-i),y:e[3]+.5*(a-r)}),lods:[new d.Z({level:0,resolution:l,scale:c})],spatialReference:t}));return h.ensureMaxLod(20),h}static makeWebMercatorAuxiliarySphere(e){const t=new m(m.WebMercatorAuxiliarySphereTileInfo);return t.ensureMaxLod(e),t}static makeGCSWithTileSize(e,t=256,i=16){const r=256/t,s=new m(new p.Z({size:[t,t],origin:new o.Z({x:-180,y:90,spatialReference:e}),spatialReference:e,lods:[new d.Z({level:0,resolution:.703125*r,scale:295497598.570834*r})]}));return s.ensureMaxLod(i),s}static{this.WebMercatorAuxiliarySphereTileInfo=new p.Z({size:[256,256],origin:new o.Z({x:-20037508.342787,y:20037508.342787,spatialReference:l.Z.WebMercator}),spatialReference:l.Z.WebMercator,lods:[new d.Z({level:0,resolution:156543.03392800014,scale:591657527.591555})]})}static{this.WebMercatorAuxiliarySphere=m.makeWebMercatorAuxiliarySphere(19)}get test(){}}function _(){return new r.Z("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}const f=(0,c.Ue)()},9779:function(e,t,i){var r;i.d(t,{w:function(){return r}}),function(e){e[e.Opaque=0]="Opaque",e[e.Transparent=1]="Transparent",e[e.InvisibleWithDraped=2]="InvisibleWithDraped",e[e.Invisible=3]="Invisible",e[e.COUNT=4]="COUNT"}(r||(r={}))},6883:function(e,t,i){i.d(t,{Wq:function(){return j},er:function(){return k},qA:function(){return w},T9:function(){return y},HK:function(){return b},V0:function(){return v},E_:function(){return B},Fp:function(){return C},TK:function(){return A},Eu:function(){return K},_1:function(){return R},a_:function(){return P},S3:function(){return N},sR:function(){return T},Ay:function(){return I},GL:function(){return O},Mw:function(){return ee},wt:function(){return Y},x4:function(){return x},uv:function(){return J},wP:function(){return D},z7:function(){return F},Q:function(){return M},B9:function(){return U},Ke:function(){return L},OD:function(){return Q},_0:function(){return X},sP:function(){return q},cA:function(){return ie},OC:function(){return te},$v:function(){return W},_F:function(){return $},ep:function(){return H},Bu:function(){return G},FZ:function(){return V},zT:function(){return Z},jO:function(){return z},wu:function(){return g}});var r=i(43254),s=i(8554),n=i(75428),a=i(56172),o=i(29499),l=i(74796),c=i(88194),h=i(47566),u=i(39717),d=i(61554),p=i(76060);const m=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:function(e,t,i,r){if(null==e)return(0,p._)();const s=e.spatialReference;if(s.isGeographic&&!(0,u.O)(s))return new c.Z("tilingscheme:local-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in local scenes");const n=p.t.checkUnsupported(e);if(null!=n)return n;if(null==i)return new c.Z("tilingscheme:extent-not-exist","The layer does not provide a layer extent.");const a=function(e,t){const i=e.lods,r=i[0].resolution*2**i[0].level,s=[r*e.size[0],r*e.size[1]],n=[e.origin.x,e.origin.y],a=(0,h.oJ)(t),o=(0,h.Ue)();p.t.computeRowColExtent(a,s,n,o);const l=(o[2]-o[0])*(o[3]-o[1]);if(l>d.$X){const t=i[0].scale*2**i[0].level;let s=Math.max((a[3]-a[1])/e.size[1],(a[2]-a[0])/e.size[0])*t/r;const n=Math.floor(Math.log(s)/Math.log(10));return s=Math.ceil(s/10**n)*10**n,new c.Z("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(t).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+s.toLocaleString()+".",{level0Scale:t,suggestedLevel0Scale:s,requiredNumRootTiles:l,allowedNumRootTiles:d.$X})}return null}(e,i);return a||(null==t||s.equals(t)||t.isWGS84&&s.isWebMercator?null:new c.Z("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene"))}},Symbol.toStringTag,{value:"Module"}));const _=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:function(e,t,i,r){if(null==e)return(0,p._)();const s=e?.lods.length-1,n=e.spatialReference;if(n.isWebMercator){if(!p.t.makeWebMercatorAuxiliarySphere(s).compatibleWith(e,r))return new c.Z("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!(0,u.M)(n))return new c.Z("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!p.t.makeGCSWithTileSize(e.spatialReference,e.size[0],s).compatibleWith(e,r))return e.spatialReference.isWGS84?new c.Z("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new c.Z("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}return null==t||e.spatialReference.equals(t)?null:new c.Z("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene")}},Symbol.toStringTag,{value:"Module"})),f={[a.JY.Global]:_,[a.JY.Local]:m};function g(e,t){e||console.warn("Terrain: "+t)}let y=!1,v=!1;function b(e){v=e,y=y||e}function w(e){y=e}function C(e,t){if(y&&!e){const e=(new Error).stack?.slice(5);throw console.warn("Terrain internal: "+(t??"")+" at "+e),new Error("Assertion failed"+(t?": "+t:""))}}function x(e){return"imagery-tile"===e?.type||"wcs"===e?.type}function T(e){return"imagery-tile-3d"===e?.type}function S(e){return"tile-3d"===e?.type}function M(e){return"vector-tile-3d"===e?.type}function E(e){return"wmts-3d"===e?.type}function R(e){return"elevation-3d"===e?.type}function P(e){return"group"===e?.type}function A(e){return e&&(S(e)||E(e)||T(e)||M(e))}function O(e){return e&&(S(e)||T(e)||M(e)||E(e))}function D(e){return O(e)||R(e)}function I(e){return(0,l.yd)(e?.sourceLayerInfo?.data)}function L(e){return U(e?.sourceLayerInfo)||!!e?.isVTLBackground}function F(e){return(0,l.Q_)(e?.sourceLayerInfo?.data)}function N(e){const t=e?.sourceLayerInfo?.data;return(0,l.Cm)(t)||t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof ImageData}function U(e){return(0,l.AK)(e?.data)}function H(e){return null!=e&&"release"in e&&e.release(),null}function V(e){return e.fetchTile&&!1!==e.hasOverriddenFetchTile}function k(e,t,i,r,s){return f[r].checkIfTileInfoSupportedForViewSR(e,i,t,s)}function B(e,t,i){let s=null,o=null;if("wmts"===e?.type){const a=function(e,t,i){const s=(0,n.mt)(e);if(null!=s){if(!r.Z.isCollection(s))return{tileInfo:s.tileInfo,fullExtent:s.fullExtent};{const e=s.find((e=>null==k(e.tileInfo,e.fullExtent,t,i)));if(e)return{tileInfo:e.tileInfo,fullExtent:e.fullExtent}}}return{tileInfo:null,fullExtent:null}}(e,t,i);s=a.tileInfo,o=a.fullExtent}else{o=x(e)?e.getCompatibleFullExtent(t):e.fullExtent;const r=i===a.JY.Local;s=x(e)?e.getCompatibleTileInfo(t,o,r):"vector-tile"===e?.type?r&&!z(t)||G.force512VTL?e.tileInfo:e.tileInfo.getCompatibleForVTL(256):e.tileInfo}const l="tilemapCache"in e?e.tilemapCache?.effectiveMaxLOD:void 0;return null!=s&&null!=o&&null==k(s,o,t,i,l)?{tileInfo:s,fullExtent:o}:null}function z(e){return e.isWGS84||e.isWebMercator||(0,s.yW)(e)||!(0,s.N$)(e)}const G={force512VTL:!1};function q(e){return"["+e[0]+","+e[1]+","+e[2]+"]"}function Z(e){return"("+e[0]+","+e[1]+","+e[2]+")"}function j(e,t,i=re){return Math.abs(e-t)<i}function W(e){return e===o.X.NORTH_EAST?o.X.SOUTH_WEST:e===o.X.NORTH_WEST?o.X.SOUTH_EAST:e===o.X.SOUTH_WEST?o.X.NORTH_EAST:o.X.NORTH_WEST}function $(e){return e===o.X.NORTH?o.X.SOUTH:e===o.X.EAST?o.X.WEST:e===o.X.SOUTH?o.X.NORTH:o.X.EAST}function X(e){return e===o.X.NORTH_WEST||e===o.X.SOUTH_WEST}function Y(e){return e===o.X.NORTH_WEST||e===o.X.NORTH_EAST}function Q(e){return e===o.X.NORTH_WEST||e===o.X.WEST||e===o.X.SOUTH_WEST}function K(e){return e===o.X.NORTH_EAST||e===o.X.EAST||e===o.X.SOUTH_EAST}function J(e){return e===o.X.SOUTH_EAST||e===o.X.SOUTH||e===o.X.SOUTH_WEST}function ee(e){return e===o.X.NORTH_EAST||e===o.X.NORTH||e===o.X.NORTH_WEST}const te=[o.X.NORTH,o.X.EAST,o.X.SOUTH,o.X.WEST],ie=[o.X.NORTH_EAST,o.X.SOUTH_EAST,o.X.SOUTH_WEST,o.X.NORTH_WEST],re=1e-5},25907:function(e,t,i){i.d(t,{AA:function(){return a},Ay:function(){return c},E9:function(){return b},QT:function(){return y},W4:function(){return l},b:function(){return g},dF:function(){return m},gl:function(){return h},rv:function(){return o},t8:function(){return v},zW:function(){return u}});var r=i(63974),s=i(74446),n=i(6883);class a{constructor(){this._queue=new r.Z,this.remove=()=>{}}get done(){return 0===this._queue.length&&(!this._last||this._last.leaf)}resetOne(e){this._queue.clear(),this._queue.push(e),this._last=void 0}reset(e=null){this._queue.clear(),null!=e&&this._queue.pushArray(e),this._last=void 0}skipSubtree(){this._last=void 0}next(){const e=this._last?.children;return e?.[0]&&this._queue.pushArray(e),this._last=this._queue.pop(),this._last}}class o{constructor(){this._q=new r.Z}get done(){return 0===this._q.length}reset(e){if(this._q.clear(),null!=e){this._q.pushArray(e);for(let e=0;e<this._q.length;++e){const t=this._q.data[e];t.leaf||this._q.pushArray(t.children)}}}next(){return this._q.pop()}}function l(e,t){if(null==t)return!1;const i=function(e){return(0,n.sR)(e)?{fullExtent:e.fullExtent,minScale:e.layer.minScale,maxScale:e.layer.maxScale}:e.layer}(t);if(null==i?.fullExtent)return!1;const r=i.fullExtent,s=e.extent;if(r.xmin>s[2]||r.ymin>s[3]||r.xmax<s[0]||r.ymax<s[1])return!1;const a=e.surface.tilingScheme.levels[e.level].scale,o=i.minScale;if(o>0&&a>1.00000001*o)return!1;const l=i.maxScale;return!(l>0&&a<.99999999*l)}function c(e){return!(0,n.sR)(e)&&e.layer&&"tilemapCache"in e.layer?e.layer.tilemapCache:null}function h(e,t){const i=e.lij,r=t.lij;return i[0]-r[0]||i[1]-r[1]||i[2]-r[2]}function u(e,t,i=null){null==i||0===i.length?e===s.z.BACK_TO_FRONT?t.sort(d):t.sort(p):t.sort(((t,r)=>function(e,t,i,r){return _(e,r)===_(t,r)?m(e,t,i):e?i:-i}(t,r,e,i)))}function d(e,t){const i=t.screenDepth-e.screenDepth;if(0!==i)return i;const r=e.lij,s=t.lij;return r[0]-s[0]||r[1]-s[1]||r[2]-s[2]}function p(e,t){const i=e.screenDepth-t.screenDepth;if(0!==i)return i;const r=e.lij,s=t.lij;return r[0]-s[0]||r[1]-s[1]||r[2]-s[2]}function m(e,t,i){const r=e.screenDepth,s=t.screenDepth;return r<s?-i:r>s?i:h(e,t)}function _(e,t){for(const i of t)if(e.intersectsExtent(i))return!0;return!1}function f(e,t){const i=e.distanceToPOI-t.distanceToPOI;if(0!==i)return i;const r=e.lij,s=t.lij;return r[0]-s[0]||r[1]-s[1]||r[2]-s[2]}function g(e,t){const i=e.length;for(let r=0;r<i;++r)e.at(r).updateDistanceToPOI(t);e.sort(f)}function y(e,t,i){let r=1,s=0,n=0;for(;e!==t;)if(r*=.5,s*=.5,n*=.5,1&e.lij[2]&&(s+=.5),1&e.lij[1]||(n+=.5),null==(e=e.parent))throw new Error("tile was not a descendant of upsampleTile");i.init(t,s,n,r)}function v(e){for(let t=0;t<e.length;t++){const i=e[t],r=i.parent;if(r)for(let e=0;e<4;e++){const t=r.children[e];if(t&&t!==i)return!0}}return!1}function b(e,t){if(!e||!t||e[0]===t[0])return!1;const i=e[0]<t[0],r=i?e:t,s=i?t:e,n=1<<s[0]-r[0];return Math.floor(s[1]/n)===r[1]&&Math.floor(s[2]/n)===r[2]}},44417:function(e,t,i){i.d(t,{Un:function(){return H},ws:function(){return x},zO:function(){return k},Qu:function(){return B}});var r=i(73440),s=i(96373),n=i(30748),a=i(24910),o=i(82846),l=i(73749),c=i(27583),h=i(88331),u=i(72432),d=i(61796),p=i(21184),m=i(29041),_=i(54998),f=i(92473),g=i(74826);class y extends g.K{constructor(){super(...arguments),this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,null!=this._parameterBlocks)for(const e of this._parameterBlocks)this[e]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(null==this._parameterBlocks)return!1;for(const e of this._parameterBlocks)if(this[e].dirty)return!0;return!1}}class v{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}}function b(e={}){return(t,i)=>{const r=t._parameterCount??0;if(t._parameterCount=r+1,e.vectorOps){const s=e.vectorOps;Object.defineProperty(t,i,{get(){return this[r]},set(e){const t=this[r];if(null==t)this[r]=[...e];else{if(s.equals(t,e))return;s.copy(t,e)}this._setDirty()}})}else Object.defineProperty(t,i,{get(){return this[r]},set(t){this[r]!==t&&(e.dispose&&this[r]&&this[r].dispose(),this[r]=t,this._setDirty())}})}}function w(){return(e,t)=>{const i=e._parameterCount??0;e._parameterCount=i+1,e._parameterBlocks=e._parameterBlocks||[],e._parameterBlocks.push(i),Object.defineProperty(e,t,{get(){return this[i]},set(e){this[i]!==e&&(this[i]=e,this._setDirty())}})}}var C,x,T=i(74222),S=i(41044),M=i(57716),E=i(34479),R=i(83346),P=i(42510),A=i(93270),O=i(20022),D=i(32420),I=i(33610),L=i(948),F=i(18836),N=i(43295),U=i(64801);class H extends y{constructor(e,t){super(),this.toMapSpace=t,this.baseColor=(0,c.vV)(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=F.xq,this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.normalTexture=null,this.occlusionTexture=null,this.emissionTexture=null,this.emissiveBaseColor=(0,o.vV)(0,0,0),this.emissiveStrength=1,this.emissiveSource=h.V6.Emissive,this.commonMaterialParameters=new V,this.componentParameters=new k,this.objectOpacity=1,this.textureAlphaCutoff=U.e,this.alphaDiscardMode=D.JJ.Opaque,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=A.U.Earth,this.hasOccludees=!1;const i=new O.I(e.position),r=(0,n.d9)(e.rotationScale);(0,s.U_)(r,r),(0,s.p4)(r,r),this.transformNormalGlobalFromModel=r,this.transformWorldFromModelTL=i.low,this.transformWorldFromModelTH=i.high,this.transformWorldFromModelRS=e.rotationScale}dispose(){this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}get hasEmissions(){return null!=this.emissionTexture||!(0,a.q)(this.emissiveBaseColor,o.AG)}get texture(){return this.baseColorTexture?.glTexture}get textureMetallicRoughness(){return this.metallicRoughnessTexture?.glTexture}get textureEmissive(){return this.emissionTexture?.glTexture}get textureOcclusion(){return this.occlusionTexture?.glTexture}get textureNormal(){return this.normalTexture?.glTexture}acquireTechnique(e,t,i,r){const s=new m._(e.context.spherical);s.renderOccluded=i.slot===L.r.OCCLUDED_GROUND,s.hasVertexColors=r.colors,s.hasNormals=r.hasNormals,s.textureCoordinateType=r.textureCoordinates,s.hasMetallicRoughnessTexture=null!=this.metallicRoughnessTexture,s.hasOcclusionTexture=null!=this.occlusionTexture,s.hasNormalTexture=null!=this.normalTexture,s.oitPass=t.identifier===T.o.Material&&null!=i.oitPass?i.oitPass:I.M.NONE,s.terrainDepthTest=t.identifier===T.o.Material&&i.terrainDepthTest,s.cullAboveTerrain=t.identifier===T.o.Material&&i.cullAboveTerrain,s.ellipsoidMode=this.ellipsoidMode,s.componentData=this.componentParameters.type,s.cullFace=this.commonMaterialParameters.cullFace,s.doubleSidedMode=this.commonMaterialParameters.doubleSided?R.q.View:R.q.None,s.hasColorTexture=null!=this.baseColorTexture;const n=this._computeWhichMaterialPass();if(s.blendingEnabled=n===C.Transparent||n===C.OpaqueAndTransparent,s.alphaDiscardMode=this.alphaDiscardMode,s.integratedMeshMode=this.isIntegratedMesh?function(e){return null!=e.overlay?.getTexture(d.D.ColorNoRasterImage)}(i)?function(e){return null!=e.overlay?.getTexture(d.D.WaterNormal)}(i)?m.O.ColorOverlayWithWater:m.O.ColorOverlay:m.O.NoOverlay:m.O.None,s.hasPolygonOffset=this.polygonOffsetEnabled,s.pbrMode=s.integratedMeshMode===m.O.ColorOverlayWithWater?P.f7.WaterOnIntegratedMesh:this.usePBR?this.hasParametersFromSource?r.shadeNormals&&this.isIntegratedMesh?P.f7.Disabled:P.f7.Schematic:P.f7.Normal:P.f7.Disabled,s.emissionSource=this.hasEmissions?null!=this.emissionTexture?E.jo.Texture:s.pbrMode===P.f7.Normal?E.jo.SymbolColor:E.jo.None:E.jo.None,s.shadeNormals=r.shadeNormals,s.normalType=s.hasNormals?M.r.Compressed:M.r.ScreenDerivative,s.hasSlicePlane=null!=i.slicePlane&&this.commonMaterialParameters.hasSlicePlane,s.receiveAmbientOcclusion=s.hasOccludees=s.receiveShadows=s.screenSpaceReflections=s.cloudReflections=s.hasHighlightMixTexture=!1,t.identifier===T.o.ShadowMap)s.output=S.H_.Shadow,s.vertexDiscardMode=f.a.None;else if(t.identifier===T.o.ViewshedShadowMap)s.output=S.H_.ViewshedShadow,s.vertexDiscardMode=f.a.None;else if(t.identifier===T.o.Highlight)s.output=S.H_.Highlight,s.vertexDiscardMode=f.a.None,s.hasHighlightMixTexture=null!=i.highlightMixTexture;else{switch(n===C.OpaqueAndTransparent?s.vertexDiscardMode=t.transparent?f.a.Opaque:f.a.Transparent:s.vertexDiscardMode=f.a.None,s.hasBloom=(0,S.qC)(t.output),s.output=t.output,t.output){case S.H_.Color:case S.H_.ColorEmission:s.receiveAmbientOcclusion=r.applySSAO&&null!=i.ssao?.getTexture(),s.hasOccludees=i.hasOccludees,s.receiveShadows=i.shadowMap.ready,s.screenSpaceReflections=null!=i.ssr.lastFrameColor,s.cloudReflections=null!=i.clouds.data?.cubeMap?.colorTexture;break;case S.H_.ObjectAndLayerIdColor:s.objectAndLayerIdColor=!0}s.snowCover=i.snowCover}const a=e.get(p.h,s);return this._setClean(),a}submit(e,t,i){if(this.objectOpacity<=0)return;const{componentData:r,renderable:s}=i,{geometry:n}=s,a=s.meta.cameraDepthSquared;r.updateHighlights(t.highlights);const{geometryRanges:o,highlightRangesMap:l,shadowmapRanges:c}=r;switch(this._computeWhichMaterialPass()){case C.Opaque:e.opaque.submitDraw(this,n,o,a);break;case C.Transparent:e.transparent.submitDraw(this,n,o,a);break;case C.OpaqueAndTransparent:e.opaque.submitDraw(this,n,o,a),e.transparent.submitDraw(this,n,o,a);break;case C.IntegratedMesh:e.integratedMesh.submitDraw(this,n,o,a),function(e){return null!=e.overlay?.getTexture(d.D.Occluded)}(t)&&e.occludedGround.submitDraw(this,n,o,a),function(e){return null!=e.overlay?.getTexture(d.D.Highlight)}(t)&&e.highlightIntegratedMesh.submitDraw(this,n,o,a)}if(this.componentParameters.castShadows!==x.None){if(null!=l)for(const t of l)t[0]===N.b&&e.highlightShadowMap.submitDraw(this,n,t[1],a,t[0]);null!=c&&e.defaultShadowMap.submitDraw(this,n,c,a),e.shadowMap.submitDraw(this,n,o,a)}if(null!=l)for(const t of l)e.highlight.submitDraw(this,n,t[1],a,t[0]);t.viewshedEnabled&&e.viewshedShadowMap.submitDraw(this,n,o,a)}_computeWhichMaterialPass(){if(this.isIntegratedMesh)return C.IntegratedMesh;if(this.objectOpacity<1)return C.Transparent;if(this.componentParameters.opaqueOverride===x.All)return C.Opaque;if(this.baseColor[3]<1||this.alphaDiscardMode===D.JJ.Blend||this.alphaDiscardMode===D.JJ.MaskBlend)return C.Transparent;switch(this.componentParameters.transparent){case x.None:return C.Opaque;case x.All:return C.Transparent;case x.Some:return C.OpaqueAndTransparent}}}(0,r._)([b({vectorOps:l.v})],H.prototype,"baseColor",void 0),(0,r._)([b()],H.prototype,"usePBR",void 0),(0,r._)([b()],H.prototype,"hasParametersFromSource",void 0),(0,r._)([b({vectorOps:a.I})],H.prototype,"mrrFactors",void 0),(0,r._)([b({dispose:!0})],H.prototype,"baseColorTexture",void 0),(0,r._)([b({dispose:!0})],H.prototype,"metallicRoughnessTexture",void 0),(0,r._)([b({dispose:!0})],H.prototype,"normalTexture",void 0),(0,r._)([b({dispose:!0})],H.prototype,"occlusionTexture",void 0),(0,r._)([b({dispose:!0})],H.prototype,"emissionTexture",void 0),(0,r._)([b({vectorOps:a.I})],H.prototype,"emissiveBaseColor",void 0),(0,r._)([b()],H.prototype,"emissiveStrength",void 0),(0,r._)([b()],H.prototype,"emissiveSource",void 0),(0,r._)([w()],H.prototype,"commonMaterialParameters",void 0),(0,r._)([w()],H.prototype,"componentParameters",void 0),(0,r._)([b()],H.prototype,"objectOpacity",void 0),(0,r._)([b()],H.prototype,"textureAlphaCutoff",void 0),(0,r._)([b()],H.prototype,"alphaDiscardMode",void 0),(0,r._)([b()],H.prototype,"isIntegratedMesh",void 0),(0,r._)([b()],H.prototype,"polygonOffsetEnabled",void 0),(0,r._)([b()],H.prototype,"ellipsoidMode",void 0),(0,r._)([b()],H.prototype,"hasOccludees",void 0),function(e){e[e.Opaque=0]="Opaque",e[e.Transparent=1]="Transparent",e[e.OpaqueAndTransparent=2]="OpaqueAndTransparent",e[e.IntegratedMesh=3]="IntegratedMesh"}(C||(C={}));class V extends v{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=D.Vr.Back,this.hasSlicePlane=!0}}(0,r._)([b()],V.prototype,"doubleSided",void 0),(0,r._)([b()],V.prototype,"cullFace",void 0),(0,r._)([b()],V.prototype,"hasSlicePlane",void 0);class k extends v{constructor(){super(...arguments),this.externalColor=(0,c.al)(1,1,1,1),this.externalColorMixMode=u.a9.Multiply,this.castShadows=x.All}get transparent(){return this.externalColor[3]<1?x.All:x.None}get opaqueOverride(){return this.externalColorMixMode===u.a9.Replace&&1===this.externalColor[3]?x.All:x.None}get visible(){return this.externalColor[3]>0?x.All:x.None}get type(){return _._N.Uniform}}(0,r._)([b({vectorOps:l.v})],k.prototype,"externalColor",void 0),(0,r._)([b()],k.prototype,"externalColorMixMode",void 0),(0,r._)([b()],k.prototype,"castShadows",void 0),function(e){e[e.All=0]="All",e[e.Some=1]="Some",e[e.None=2]="None"}(x||(x={}));class B extends v{constructor(){super(...arguments),this.texture=null,this.transparent=x.None,this.opaqueOverride=x.None,this.castShadows=x.None}get type(){return _._N.Varying}}(0,r._)([b()],B.prototype,"texture",void 0),(0,r._)([b()],B.prototype,"transparent",void 0),(0,r._)([b()],B.prototype,"opaqueOverride",void 0),(0,r._)([b()],B.prototype,"castShadows",void 0)},21184:function(e,t,i){i.d(t,{h:function(){return m},k:function(){return _}});var r=i(29041),s=i(58498),n=i(41044),a=i(58257),o=i(29107),l=i(32420),c=i(33610),h=i(61536),u=i(26041),d=i(52061),p=i(51135);class m extends o.A{constructor(e,t){super(e,t,new a.J(s.C,(()=>i.e(97979).then(i.bind(i,97979)))),_)}initializePipeline(e){const{integratedMeshMode:t,output:i,blendingEnabled:s,cullFace:a,hasOccludees:d,hasPolygonOffset:m,oitPass:_,renderOccluded:f}=e,g=t!==r.O.None,y=_===c.M.NONE,v=_===c.M.FrontFace;return(0,p.sm)({blending:f?p.Zo:(0,n.c1)(i)&&s?(0,h.Wo)(_):null,culling:(0,p.zp)(a),depthTest:f?null:{func:(0,h.Bh)(_)},depthWrite:f||!y&&!v?null:p.ck,drawBuffers:(0,o.E)(i,(0,h.u_)(_,i)),colorWrite:p.gf,stencilWrite:!f&&g||d?u.s3:null,stencilTest:g?(0,u.ec)(l.hU.IntegratedMeshMaskExcluded):d?u.RY:null,polygonOffset:y||v?m?{factor:2,units:2}:null:h.E0})}}const _=new Map([[d.T.POSITION,0],[d.T.NORMAL,1],[d.T.NORMALCOMPRESSED,1],[d.T.COLOR,2],[d.T.UV0,3],[d.T.UVREGION,4],[d.T.COMPONENTINDEX,5]])},29041:function(e,t,i){i.d(t,{O:function(){return r},_:function(){return y}});var r,s=i(73440),n=i(54998),a=i(92473),o=i(41044),l=i(57716),c=i(31839),h=i(34479),u=i(83346),d=i(42510),p=i(93270),m=i(83046),_=i(32420),f=i(33610),g=i(5998);!function(e){e[e.None=0]="None",e[e.NoOverlay=1]="NoOverlay",e[e.ColorOverlay=2]="ColorOverlay",e[e.ColorOverlayWithWater=3]="ColorOverlayWithWater",e[e.COUNT=4]="COUNT"}(r||(r={}));class y extends m.m{constructor(e){super(),this.spherical=e,this.output=o.H_.Color,this.textureCoordinateType=c.I.None,this.componentData=n._N.Uniform,this.cullFace=_.Vr.Back,this.vertexDiscardMode=a.a.None,this.doubleSidedMode=u.q.WindingOrder,this.alphaDiscardMode=_.JJ.Opaque,this.integratedMeshMode=r.None,this.oitPass=f.M.NONE,this.ellipsoidMode=p.U.Earth,this.pbrMode=d.f7.Disabled,this.normalType=l.r.Attribute,this.emissionSource=h.jo.None,this.hasVertexColors=!1,this.hasNormals=!1,this.shadeNormals=!0,this.hasSlicePlane=!1,this.hasColorTexture=!1,this.hasHighlightMixTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.blendingEnabled=!0,this.screenSpaceReflections=!1,this.hasPolygonOffset=!1,this.hasMetallicRoughnessTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.hasNormalTextureTransform=!1,this.cloudReflections=!0,this.snowCover=!1,this.objectAndLayerIdColor=!1,this.hasBloom=!1,this.renderOccluded=!1,this.discardInvisibleFragments=!1,this.occlusionPass=!1,this.bindType=g.P.Draw,this.useCustomDTRExponentForWater=!1,this.hasVertexTangents=!1,this.highStepCount=!1,this.instancedDoublePrecision=!1,this.hasModelTransformation=!1,this.useFillLights=!0,this.objectAndLayerIdColorInstanced=!1,this.draped=!1}get overlayEnabled(){return(this.integratedMeshMode===r.ColorOverlay||this.integratedMeshMode===r.ColorOverlayWithWater)&&(0,o.Qo)(this.output)}}(0,s._)([(0,m.o)({count:o.H_.COUNT})],y.prototype,"output",void 0),(0,s._)([(0,m.o)({count:c.I.COUNT})],y.prototype,"textureCoordinateType",void 0),(0,s._)([(0,m.o)({count:n._N.COUNT})],y.prototype,"componentData",void 0),(0,s._)([(0,m.o)({count:_.Vr.COUNT})],y.prototype,"cullFace",void 0),(0,s._)([(0,m.o)({count:a.a.COUNT})],y.prototype,"vertexDiscardMode",void 0),(0,s._)([(0,m.o)({count:u.q.COUNT})],y.prototype,"doubleSidedMode",void 0),(0,s._)([(0,m.o)({count:_.JJ.COUNT})],y.prototype,"alphaDiscardMode",void 0),(0,s._)([(0,m.o)({count:r.COUNT})],y.prototype,"integratedMeshMode",void 0),(0,s._)([(0,m.o)({count:f.M.COUNT})],y.prototype,"oitPass",void 0),(0,s._)([(0,m.o)({count:p.U.COUNT})],y.prototype,"ellipsoidMode",void 0),(0,s._)([(0,m.o)({count:d.f7.COUNT})],y.prototype,"pbrMode",void 0),(0,s._)([(0,m.o)({count:l.r.COUNT})],y.prototype,"normalType",void 0),(0,s._)([(0,m.o)({count:h.jo.COUNT})],y.prototype,"emissionSource",void 0),(0,s._)([(0,m.o)()],y.prototype,"hasVertexColors",void 0),(0,s._)([(0,m.o)()],y.prototype,"hasNormals",void 0),(0,s._)([(0,m.o)()],y.prototype,"shadeNormals",void 0),(0,s._)([(0,m.o)()],y.prototype,"hasSlicePlane",void 0),(0,s._)([(0,m.o)()],y.prototype,"hasColorTexture",void 0),(0,s._)([(0,m.o)()],y.prototype,"hasHighlightMixTexture",void 0),(0,s._)([(0,m.o)()],y.prototype,"receiveAmbientOcclusion",void 0),(0,s._)([(0,m.o)()],y.prototype,"receiveShadows",void 0),(0,s._)([(0,m.o)()],y.prototype,"blendingEnabled",void 0),(0,s._)([(0,m.o)()],y.prototype,"screenSpaceReflections",void 0),(0,s._)([(0,m.o)()],y.prototype,"hasPolygonOffset",void 0),(0,s._)([(0,m.o)()],y.prototype,"hasMetallicRoughnessTexture",void 0),(0,s._)([(0,m.o)()],y.prototype,"hasOcclusionTexture",void 0),(0,s._)([(0,m.o)()],y.prototype,"hasNormalTexture",void 0),(0,s._)([(0,m.o)()],y.prototype,"hasOccludees",void 0),(0,s._)([(0,m.o)()],y.prototype,"terrainDepthTest",void 0),(0,s._)([(0,m.o)()],y.prototype,"cullAboveTerrain",void 0),(0,s._)([(0,m.o)()],y.prototype,"hasNormalTextureTransform",void 0),(0,s._)([(0,m.o)()],y.prototype,"cloudReflections",void 0),(0,s._)([(0,m.o)()],y.prototype,"snowCover",void 0),(0,s._)([(0,m.o)()],y.prototype,"objectAndLayerIdColor",void 0),(0,s._)([(0,m.o)()],y.prototype,"hasBloom",void 0),(0,s._)([(0,m.o)()],y.prototype,"renderOccluded",void 0)},92473:function(e,t,i){var r;i.d(t,{a:function(){return r}}),function(e){e[e.None=0]="None",e[e.Transparent=1]="Transparent",e[e.Opaque=2]="Opaque",e[e.COUNT=3]="COUNT"}(r||(r={}))},91129:function(e,t,i){i.d(t,{N:function(){return l},h:function(){return o}});var r=i(52890),s=i(31839),n=i(52061),a=i(74826);class o extends a.K{constructor(e,t,i,r,s){super(),this.colors=e,this.textureCoordinates=t,this.hasNormals=i,this.shadeNormals=r,this.applySSAO=s}}function l({hasNormals:e,textureCoordinates:t,colors:i}){const a=(0,r.U$)().vec3f(n.T.POSITION);return e&&a.vec2i16(n.T.NORMALCOMPRESSED,{glNormalized:!0}),t===s.I.Default?a.vec2f(n.T.UV0):t===s.I.Atlas&&(a.vec2f(n.T.UV0),a.vec4u16(n.T.UVREGION,{glNormalized:!0})),i&&a.vec4u8(n.T.COLOR,{glNormalized:!0}),a.freeze()}},68593:function(e,t,i){i.d(t,{R:function(){return a}});var r=i(20638),s=i(77983),n=i(48857);function a(e){const t=e.fragment;e.include(s.GZ),t.include(r.K),t.code.add(n.H`vec3 normalFromDepth(sampler2D depthMap, vec3 pixelPos, vec2 fragCoord, vec2 uv) {
ivec2 iuv = ivec2(uv * vec2(textureSize(depthMap, 0)));
float leftPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(-1, 0), 0).r);
float rightPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(1, 0), 0).r);
float bottomPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(0, -1), 0).r);
float topPixelDepth = linearizeDepth(texelFetch(depthMap, iuv + ivec2(0, 1), 0).r);
bool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);
bool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);
vec3 fragCoordHorizontal = pickLeft
? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)
: vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);
vec3 fragCoordVertical = pickBottom
? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)
: vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);
vec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);
vec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);
vec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));
return pickLeft == pickBottom ? normal : -normal;
}`)}},82630:function(e,t,i){i.d(t,{M:function(){return s}});var r=i(48857);function s(e,t){e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),t.spherical?e.vertex.code.add(r.H`void forwardVertexTangent(vec3 n) {
tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));
tbnBiTangent = normalize(cross(n, tbnTangent));
}`):e.vertex.code.add(r.H`void forwardVertexTangent(vec3 n) {
tbnTangent = vec3(1.0, 0.0, 0.0);
tbnBiTangent = normalize(cross(n, tbnTangent));
}`),e.fragment.code.add(r.H`mat3 getTBNMatrix(vec3 n) {
return mat3(tbnTangent, tbnBiTangent, n);
}`)}},17993:function(e,t,i){var r;i.d(t,{MV:function(){return n},iM:function(){return r},pU:function(){return s}}),function(e){e[e.Normal=0]="Normal",e[e.Average=1]="Average",e[e.Lighten=2]="Lighten",e[e.Lighter=3]="Lighter",e[e.Plus=4]="Plus",e[e.Screen=5]="Screen",e[e.ColorDodge=6]="ColorDodge",e[e.Darken=7]="Darken",e[e.Multiply=8]="Multiply",e[e.ColorBurn=9]="ColorBurn",e[e.Overlay=10]="Overlay",e[e.SoftLight=11]="SoftLight",e[e.HardLight=12]="HardLight",e[e.VividLight=13]="VividLight",e[e.Hue=14]="Hue",e[e.Saturation=15]="Saturation",e[e.Luminosity=16]="Luminosity",e[e.Color=17]="Color",e[e.DestinationOver=18]="DestinationOver",e[e.DestinationAtop=19]="DestinationAtop",e[e.DestinationIn=20]="DestinationIn",e[e.DestinationOut=21]="DestinationOut",e[e.SourceAtop=22]="SourceAtop",e[e.SourceIn=23]="SourceIn",e[e.SourceOut=24]="SourceOut",e[e.Xor=25]="Xor",e[e.Difference=26]="Difference",e[e.Exclusion=27]="Exclusion",e[e.Minus=28]="Minus",e[e.Invert=29]="Invert",e[e.Reflect=30]="Reflect",e[e.COUNT=31]="COUNT"}(r||(r={}));const s={normal:r.Normal,average:r.Average,lighten:r.Lighten,lighter:r.Lighter,screen:r.Screen,plus:r.Plus,"color-dodge":r.ColorDodge,darken:r.Darken,multiply:r.Multiply,"color-burn":r.ColorBurn,overlay:r.Overlay,"soft-light":r.SoftLight,"hard-light":r.HardLight,"vivid-light":r.VividLight,hue:r.Hue,saturation:r.Saturation,luminosity:r.Luminosity,color:r.Color,difference:r.Difference,exclusion:r.Exclusion,minus:r.Minus,invert:r.Invert,reflect:r.Reflect,"destination-over":r.DestinationOver,"destination-atop":r.DestinationAtop,"destination-in":r.DestinationIn,"destination-out":r.DestinationOut,"source-atop":r.SourceAtop,"source-in":r.SourceIn,"source-out":r.SourceOut,xor:r.Xor};function n(e){return e===r.DestinationOver||e===r.DestinationAtop||e===r.DestinationIn||e===r.DestinationOut||e===r.SourceAtop||e===r.SourceIn||e===r.SourceOut||e===r.Xor}},24807:function(e,t,i){i.d(t,{_:function(){return a}});var r=i(41044),s=i(40122),n=i(48857);function a(e,t){t.output===r.H_.Highlight&&(e.include(s.b,t),e.fragment.code.add(n.H`
    void calculateOcclusionAndOutputHighlight(uvec2 highlightToAdd) {
      uint levelBits = readLevelBits(highlightToAdd, highlightLevel);
      if ((levelBits & 1u) == 0u) discard;
      outputHighlight(isHighlightOccluded());
    }
  `))}},94129:function(e,t,i){i.d(t,{i:function(){return a}});var r=i(85119),s=i(48857),n=i(34709);function a(e){e.fragment.uniforms.add(new n.A("u_colormap",(e=>e.u_colormap)),new r.p("u_colormapOffset",(e=>e.colormap.u_colormapOffset)),new r.p("u_colormapMaxIndex",(e=>e.colormap.u_colormapMaxIndex)),new r.p("u_opacity",(e=>e.common.u_opacity))),e.fragment.code.add(s.H`vec4 colormap(vec4 currentPixel, bool isFloat) {
float colorIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;
vec4 result;
if (currentPixel.a == 0.0 || colorIndex > u_colormapMaxIndex) {
result = vec4(0.0, 0.0, 0.0, 0.0);
} else {
vec2 texelCoordinates = vec2((colorIndex + 0.5), 0.5);
result = texelFetch(u_colormap, ivec2(texelCoordinates), 0);
}
return result;
}`)}},13887:function(e,t,i){i.d(t,{G:function(){return h},J:function(){return c}});var r=i(19155),s=i(48857),n=i(34709);function a(e){e.fragment.uniforms.add(new n.A("u_transformGrid",(e=>e.u_transformGrid)),new r.A("u_transformSpacing",(e=>e.common.u_transformSpacing)),new r.A("u_targetImageSize",(e=>e.common.u_targetImageSize))),e.fragment.code.add(s.H`vec2 projectPixelLocation(vec2 coords) {
vec2 index_image = floor(coords * u_targetImageSize);
vec2 oneTransformPixel = vec2(4.0, 1.0);
vec2 index_transform = floor(index_image / u_transformSpacing) * oneTransformPixel;
vec2 pos = fract((index_image + 0.5) / u_transformSpacing);
vec2 transform_location = index_transform + 0.5;
vec2 srcLocation;
if (pos.s <= pos.t) {
vec3 ll_abc = texelFetch(u_transformGrid, ivec2(transform_location), 0).rgb;
vec3 ll_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 1.0, transform_location.t), 0).rgb;
srcLocation.s = dot(ll_abc, vec3(pos, 1.0));
srcLocation.t = dot(ll_def, vec3(pos, 1.0));
} else {
vec3 ur_abc = texelFetch(u_transformGrid, ivec2(transform_location.s + 2.0, transform_location.t), 0).rgb;
vec3 ur_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 3.0, transform_location.t), 0).rgb;
srcLocation.s = dot(ur_abc, vec3(pos, 1.0));
srcLocation.t = dot(ur_def, vec3(pos, 1.0));
}
return srcLocation;
}`)}var o=i(58226),l=i(54231);class c extends o.R{constructor(e,t,i){super(),this.common=e,this.u_image=t,this.u_transformGrid=i}}function h(e,t){e.include(a),e.fragment.uniforms.add(new n.A("u_image",(e=>e.u_image)),new l.U("u_flipY",(e=>e.common.u_flipY)),new l.U("u_applyTransform",(e=>e.common.u_applyTransform)));const{requireBilinearWithNN:i}=t;i&&e.fragment.uniforms.add(new r.A("u_srcImageSize",(e=>e.common.u_srcImageSize))),e.fragment.code.add(s.H`vec2 getPixelLocation(vec2 coords) {
vec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;
if (!u_applyTransform) {
return targetLocation;
}
return projectPixelLocation(targetLocation);
}
bool isOutside(vec2 coords){
if (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {
return true;
} else {
return false;
}
}`),i?e.fragment.code.add(s.H`vec4 sampleBilinear(sampler2D sampler, vec2 coords, vec2 texSize) {
vec2 texelStart = floor(coords * texSize);
vec2 coord0 = texelStart / texSize;
vec2 coord1 = (texelStart +  vec2(1.0, 0.0)) / texSize;
vec2 coord2 = (texelStart +  vec2(0.0, 1.0)) / texSize;
vec2 coord3 = (texelStart +  vec2(1.0, 1.0)) / texSize;
vec4 color0 = texture(sampler, coord0);
vec4 color1 = texture(sampler, coord1);
vec4 color2 = texture(sampler, coord2);
vec4 color3 = texture(sampler, coord3);
vec2 blend = fract(coords * texSize);
vec4 color01 = mix(color0, color1, blend.x);
vec4 color23 = mix(color2, color3, blend.x);
vec4 color = mix(color01, color23, blend.y);
float alpha = floor(color0.a * color1.a * color2.a * color3.a + 0.5);
color = color * alpha + (1.0 - alpha) * texture(sampler, coords);
return color;
}
vec4 getPixel(vec2 pixelLocation) {
return sampleBilinear(u_image, pixelLocation, u_srcImageSize);
}`):e.fragment.code.add(s.H`vec4 getPixel(vec2 pixelLocation) {
return texture(u_image, pixelLocation);
}`)}},67669:function(e,t,i){i.d(t,{K:function(){return c}});var r=i(79487),s=i(57716),n=i(48737),a=i(92684),o=i(83346),l=i(48857);function c(e,t){const i=e.fragment;switch(t.doubleSidedMode){case o.q.None:i.code.add(l.H`vec3 _adjustDoublesided(vec3 normal) {
return normal;
}`);break;case o.q.View:e.include(a.up,t),i.code.add(l.H`vec3 _adjustDoublesided(vec3 normal) {
return dot(normal, vPositionWorldCameraRelative) > 0.0 ? -normal : normal;
}`);break;case o.q.WindingOrder:i.code.add(l.H`vec3 _adjustDoublesided(vec3 normal) {
return gl_FrontFacing ? normal : -normal;
}`);break;default:(0,r.Bg)(t.doubleSidedMode);case o.q.COUNT:}switch(t.normalType){case s.r.Attribute:case s.r.Compressed:e.include(n.Bb,t),i.main.add(l.H`vec3 fragmentFaceNormal = _adjustDoublesided(normalize(vNormalWorld));
vec3 fragmentFaceNormalView = gl_FrontFacing ? normalize(vNormalView) : -normalize(vNormalView);`);break;case s.r.ScreenDerivative:e.include(a.up,t),i.main.add(l.H`vec3 fragmentFaceNormal = normalize(cross(dFdx(vPositionWorldCameraRelative), dFdy(vPositionWorldCameraRelative)));
vec3 fragmentFaceNormalView = normalize(cross(dFdx(vPosition_view), dFdy(vPosition_view)));`);default:case s.r.COUNT:}t.shadeNormals?i.main.add(l.H`vec3 fragmentShadingNormal = fragmentFaceNormal;`):t.spherical?(e.include(a.up,t),i.main.add(l.H`vec3 fragmentShadingNormal = normalize(positionWorld());`)):i.main.add(l.H`vec3 fragmentShadingNormal = vec3(0.0, 0.0, 1.0);`)}},46722:function(e,t,i){i.d(t,{P:function(){return l}});var r=i(56335),s=i(5763),n=i(90285),a=i(30881),o=i(48857);function l(e,t){e.include(r.c,t),e.fragment.include(s.y);const i=e.fragment;i.uniforms.add(new n.$("baseColor",(e=>e.baseColor))),i.uniforms.add(new a.p("objectOpacity",(e=>e.objectOpacity))),t.hasVertexColors?i.code.add(o.H`vec3 _baseColor() {
return baseColor.rgb * vColor.rgb;
}
float _baseOpacity() {
return baseColor.a * vColor.a;
}`):i.code.add(o.H`vec3 _baseColor() {
return baseColor.rgb;
}
float _baseOpacity() {
return baseColor.a;
}`),i.code.add(o.H`vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {
vec3 baseColor = _baseColor();
float baseOpacity = _baseOpacity();
vec3 color = mixExternalColor(
baseColor,
textureColor.rgb,
externalColor.rgb,
externalColorMixMode
);
float opacity = objectOpacity * mixExternalOpacity(
baseOpacity,
textureColor.a,
externalColor.a,
externalColorMixMode
);
return vec4(color, opacity);
}`)}},4162:function(e,t,i){i.d(t,{s:function(){return l}});var r=i(41044),s=i(79786),n=i(48857),a=i(29193),o=i(32420);function l(e,t){const i=t.hasColorTexture&&((0,r.c1)(t.output)||t.alphaDiscardMode!==o.JJ.Opaque);i&&(e.include(s.i,t),e.fragment.uniforms.add(new a.R("baseColorTexture",(e=>e.texture)))),e.fragment.code.add(n.H`
    vec4 readBaseColorTexture() {
      return ${i?"textureLookup(baseColorTexture, vuv0)":"vec4(1.0)"};
    }
  `)}},84201:function(e,t,i){i.d(t,{V:function(){return h}});var r=i(31865),s=i(10934),n=i(20638),a=i(56819),o=i(77983),l=i(48857),c=i(18489);function h(e){e.include(a.dK),u(e)}function u(e){e.fragment.include(n.K),e.include(o.GZ),e.fragment.uniforms.add(new c.C("inverseViewMatrix",(({camera:e})=>(0,r.U_)(d,(0,r.Iu)(d,e.viewMatrix,e.center))))).code.add(l.H`vec3 calculateUVZShadowAndPixelPosFromDepth(
in vec2 _uv,
ivec2 shadowMapSize,
in sampler2D _depthMap,
out vec4 currentPixelPos
) {
float depth = depthFromTexture(_depthMap, _uv);
if (depth >= 1.0 || depth <= 0.0) {
return invalidShadowmapUVZ;
}
float currentPixelDepth = linearizeDepth(depth);
currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;
float linearDepth = -currentPixelDepth;
return calculateUVZShadow(worldSpacePos.xyz, linearDepth, shadowMapSize);
}
vec3 calculateUVZShadowFromDepth(
in vec2 _uv,
ivec2 shadowMapSize,
in sampler2D _depthMap
) {
vec4 currentPixelPos;
return calculateUVZShadowAndPixelPosFromDepth(_uv, shadowMapSize, _depthMap, currentPixelPos);
}`)}const d=(0,s.Ue)()},56791:function(e,t,i){i.d(t,{H:function(){return s}});var r=i(48857);function s(e){e.code.add(r.H`
    float lineFactorAtPosition(float value) {
      float pos = value * ${r.H.float(257)};
      if(pos < 0.5 || pos > ${r.H.float(256.5)}) {
        return 1.0;
      }

      pos = pos + 0.5;
      float modulo = mod(pos, 16.0);
      return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;
    }

    float lineFactorAtUV(vec2 uv) {
      return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));
    }

    float lineFactor(vec2 uv) {
      vec2 offset = fwidth(uv) * 0.25;
      return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;
    }

    vec3 gridColor(vec2 uv) {
      float line = lineFactor(uv) * 0.1 + 0.9;
      return vec3(1.0, 0.972, 0.918) * line;
    }`)}},93288:function(e,t,i){var r;i.d(t,{I:function(){return r}}),function(e){e[e.NotRequired=0]="NotRequired",e[e.Required=1]="Required",e[e.COUNT=2]="COUNT"}(r||(r={}))},82214:function(e,t,i){var r;i.d(t,{l:function(){return r}}),function(e){e[e.Draw=0]="Draw",e[e.Composite=1]="Composite",e[e.ColorComposite=2]="ColorComposite",e[e.GridComposite=3]="GridComposite",e[e.GroupBackgroundComposite=4]="GroupBackgroundComposite",e[e.COUNT=5]="COUNT"}(r||(r={}))},12024:function(e,t,i){var r;i.d(t,{m:function(){return r}}),function(e){e[e.Off=0]="Off",e[e.On=1]="On",e[e.COUNT=2]="COUNT"}(r||(r={}))},6397:function(e,t,i){i.d(t,{EK:function(){return c},uS:function(){return l}});var r=i(36351),s=i(56791),n=i(47744),a=i(48857),o=i(92217);class l extends r.nj{constructor(){super(...arguments),this.overlayOpacity=1}}function c(e,t){const{vertex:i,fragment:r,varyings:o}=e;o.add("vtc","vec2"),i.uniforms.add(new d("texOffsetAndScale")),r.uniforms.add(new p("tex")),r.uniforms.add(new u("textureOpacities"));const l=t.textureFadingEnabled&&!t.renderOccluded;l&&(i.uniforms.add(new d("nextTexOffsetAndScale")),o.add("nvtc","vec2"),r.uniforms.add(new p("texNext")),r.uniforms.add(new u("nextTexOpacities")),r.uniforms.add(new h("fadeFactor")));const c=t.tileBlendInput===n.R.ColorComposite,m=t.tileBlendInput===n.R.GridComposite;m&&r.include(s.H),c&&r.uniforms.add(new u("backgroundColor")),i.code.add(a.H`
  void forwardTextureCoordinatesWithTransform(in vec2 uv) {
    vtc = texOffsetAndScale.xy + uv * texOffsetAndScale.zw;
    ${(0,a.If)(l,"nvtc = nextTexOffsetAndScale.xy + uv * nextTexOffsetAndScale.zw;")}
  }`),r.code.add(a.H`
    vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
      ${(0,a.If)(m||c,a.H`if (opacities.y <= 0.0) {
           return color * opacities.z * opacities.x;
         }
         vec4 bg = vec4(${c?a.H`backgroundColor`:a.H`gridColor(uv)`} * opacities.y, opacities.y);
         vec4 layer = color * opacities.z;
         return (bg * (1.0 - layer.a) + layer) * opacities.x;`,"return color;")}
    }`),l?r.code.add(a.H`vec4 getTileColor() {
vec4 color = getColor(texture(tex, vtc), vtc, textureOpacities);
if (fadeFactor >= 1.0) {
return color;
}
vec4 nextColor = getColor(texture(texNext, nvtc), nvtc, nextTexOpacities);
return mix(nextColor, color, fadeFactor);
}`):r.code.add(a.H`vec4 getTileColor() {
return getColor(texture(tex, vtc), vtc, textureOpacities);
}`)}class h extends o.x{constructor(e){super(e,"float")}}class u extends o.x{constructor(e){super(e,"vec3")}}class d extends o.x{constructor(e){super(e,"vec4")}}class p extends o.x{constructor(e){super(e,"sampler2D")}}},99563:function(e,t,i){i.d(t,{J:function(){return p}});i(61432),i(82846);var r=i(17993),s=i(56791),n=i(93288),a=i(82214),o=i(12024),l=i(48857);function c(e,t){const i=t.blendMode;i!==r.iM.Normal&&(i===r.iM.Reflect&&e.code.add(l.H`float reflectBlend(in float cb, in float cl) {
return (cl == 1.0) ? cl : min(cb * cb / (1.0 - cl), 1.0);
}`),i!==r.iM.ColorDodge&&i!==r.iM.VividLight||e.code.add(l.H`float colorDodge(in float cb, in float cl) {
return (cb == 0.0) ? 0.0 : (cl == 1.0) ? 1.0 : min(1.0, cb / (1.0 - cl));
}`),i!==r.iM.ColorBurn&&i!==r.iM.VividLight||e.code.add(l.H`float colorBurn(in float cb, in float cl) {
return (cb == 1.0) ? 1.0 : (cl == 0.0) ? 0.0 : 1.0 - min(1.0, (1.0 - cb) / cl);
}`),i===r.iM.Overlay&&e.code.add(l.H`float overlay(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (1.0 - 2.0 * (1.0 - cl ) * (1.0 - cb)) + step(0.5, cl) * (2.0 * cl * cb);
}`),i===r.iM.HardLight&&e.code.add(l.H`float hardLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (2.0 * cl * cb) + step(0.5, cl) * (1.0 - 2.0 * (1.0 - cl) * (1.0 - cb));
}`),i===r.iM.SoftLight&&e.code.add(l.H`float softLight(in float cb, in float cl) {
if (cl <= 0.5) {
return cb - (1.0 - 2.0 * cl) * cb * (1.0 - cb);
}
if (cb <= 0.25) {
return cb + (2.0 * cl - 1.0) * cb * ((16.0 * cb - 12.0) * cb + 3.0);
}
return cb + (2.0 * cl - 1.0) * (sqrt(cb) - cb);
}`),i===r.iM.VividLight&&e.code.add(l.H`float vividLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * colorBurn(cb, 2.0 * cl) + step(0.5, cl) * colorDodge(cb, (2.0 * (cl - 0.5)));
}`),i!==r.iM.Hue&&i!==r.iM.Saturation&&i!==r.iM.Color&&i!==r.iM.Luminosity||(e.code.add(l.H`float minv3(in vec3 c) {
return min(min(c.r, c.g), c.b);
}
float maxv3(in vec3 c) {
return max(max(c.r, c.g), c.b);
}
float lumv3(in vec3 c) {
return dot(c, vec3(0.3, 0.59, 0.11));
}
vec3 clipColor(vec3 color) {
float lum = lumv3(color);
float mincol = minv3(color);
float maxcol = maxv3(color);
if (mincol < 0.0) {
color = lum + ((color - lum) * lum) / (lum - mincol);
}
if (maxcol > 1.0) {
color = lum + ((color - lum) * (1.0 - lum)) / (maxcol - lum);
}
return color;
}
vec3 setLum(vec3 cbase, vec3 clum) {
return clipColor(cbase + vec3(lumv3(clum) - lumv3(cbase)));
}`),i!==r.iM.Hue&&i!==r.iM.Saturation||e.code.add(l.H`float satv3(vec3 c) {
return maxv3(c) - minv3(c);
}
vec3 setLumSat(vec3 cbase, vec3 csat, vec3 clum)
{
float minbase = minv3(cbase);
float sbase = satv3(cbase);
float ssat = satv3(csat);
return setLum(sbase > 0.0 ? (cbase - minbase) * ssat / sbase : vec3(0.0), clum);
}`)),e.code.add(l.H`
    vec4 applyBlendMode(vec3 cl, float ol, vec3 cb, float ob) {
      ${i===r.iM.Multiply?l.H`return vec4(cl * ol * cb * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.Average?l.H`return vec4((cb + cl) * 0.5 * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.Lighten?l.H`return vec4(max(cb, cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.Darken?l.H`return vec4(min(cl, cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.Lighter?l.H`return vec4(cl * ol + cb * ob, ol + ob);`:i===r.iM.Plus?l.H`return clamp(vec4(cl.rgb + cb.rgb, ol + ob), 0.0, 1.0);`:i===r.iM.Minus?l.H`return vec4(clamp(vec3(cb.rgb - cl.rgb), 0.0, 1.0), ob * ol);`:i===r.iM.Screen?l.H`return vec4((cl + cb - cl * cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.Difference?l.H`return vec4(abs(cb - cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.Invert?l.H`return vec4((1.0 - cb) * ol * ob + cb * ob * (1.0 - ol), ob);`:i===r.iM.DestinationOver?l.H`return vec4(cl * ol * (1.0 - ob) + cb * ob, ol + ob - ol * ob);`:i===r.iM.DestinationAtop?l.H`return vec4(cl * ol * (1.0 - ob) + cb * ob * ol, ol);`:i===r.iM.DestinationOut?l.H`return vec4(cb * ob * (1.0 - ol), ob * (1.0 - ol));`:i===r.iM.SourceAtop?l.H`return vec4(cl * ol * ob + cb * ob * (1.0 - ol), ob);`:i===r.iM.SourceOut?l.H`return vec4(cl * ol * (1.0 - ob), ol * (1.0 - ob));`:i===r.iM.Xor?l.H`return vec4(cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), ol * (1.0 - ob) + ob * (1.0 - ol));`:i===r.iM.DestinationIn?l.H`return vec4(cb * ob * ol, ol * ob);`:i===r.iM.SourceIn?l.H`return vec4(cl * ol * ob, ol * ob);`:i===r.iM.Hue?l.H`
          vec3 f = setLumSat(cl, cb, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.Saturation?l.H`
          vec3 f = setLumSat(cb, cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.Color?l.H`
          vec3 f = setLum(cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.Luminosity?l.H`
          vec3 f = setLum(cb, cl);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.Exclusion?l.H`
          vec3 f = cl + cb - 2.0 * cl * cb;
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.Reflect?l.H`
          vec3 f = vec3(reflectBlend(cb.r, cl.r), reflectBlend(cb.g, cl.g), reflectBlend(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.ColorDodge?l.H`
          vec3 f = vec3(colorDodge(cb.r, cl.r), colorDodge(cb.g, cl.g), colorDodge(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.ColorBurn?l.H`
          vec3 f = vec3(colorBurn(cb.r, cl.r), colorBurn(cb.g, cl.g), colorBurn(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.Overlay?l.H`
          vec3 f = vec3(overlay(cb.r, cl.r), overlay(cb.g, cl.g), overlay(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.SoftLight?l.H`
          vec3 f = vec3(softLight(cb.r, cl.r), softLight(cb.g, cl.g), softLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.HardLight?l.H`
          vec3 f = vec3(hardLight(cb.r, cl.r), hardLight(cb.g, cl.g), hardLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===r.iM.VividLight?l.H`
          vec3 f = vec3(vividLight(cb.r, cl.r), vividLight(cb.g, cl.g), vividLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:l.H``}
    }
  `))}var h=i(9535),u=i(85119),d=i(34709);i(74826);function p(e,t){const{output:i,blendMode:p,baseOpacityMode:m,premultipliedSource:_}=t,f=e.fragment,g=m===n.I.Required;g&&f.uniforms.add(new u.p("baseOpacity",(e=>e.baseOpacity)));const y=p!==r.iM.Normal,v=_===o.m.On,b=i===a.l.Composite,w=i===a.l.GroupBackgroundComposite,C=!y&&!v&&(b&&!g||w);f.include(c,t);let x="";switch(i){case a.l.GroupBackgroundComposite:case a.l.Draw:x=l.H`vec4(0.0)`;break;case a.l.ColorComposite:f.uniforms.add(new h.J("backgroundColor",(e=>e.backgroundColor))),x=l.H`vec4(backgroundColor, 1.0)`;break;case a.l.GridComposite:f.include(s.H),x=l.H`vec4(gridColor(uv), 1.0)`;break;case a.l.Composite:f.uniforms.add(new d.A("fboColor",(e=>e.fboTexture))),x=l.H`texelFetch(fboColor, ivec2(gl_FragCoord.xy), 0)`;case a.l.COUNT:}f.code.add(l.H`
    vec4 getBackground(vec2 uv) {
      return ${(0,l.If)(g,l.H`baseOpacity *`)} ${x};
    }

    vec4 blendLayers(vec2 bgUV, vec4 colorLayer, float opacity) {
      ${y?l.H`
          vec3 cl = colorLayer.a == 0.0 ? colorLayer.rgb : colorLayer.rgb / colorLayer.a;
          vec4 bgColor = getBackground(bgUV);
          vec3 cb = bgColor.a == 0.0 ? bgColor.rgb : bgColor.rgb / bgColor.a;
          return applyBlendMode(clamp(cl, vec3(0.0), vec3(1.0)), colorLayer.a * opacity, cb, bgColor.a);`:l.H`
          float composeAlpha = colorLayer.a * opacity;
          ${C?l.H`return colorLayer * opacity;`:l.H`
            vec4 bgColor = getBackground(bgUV);
            return bgColor * (1.0 - composeAlpha) + colorLayer * opacity;`}`}
    }`)}},47744:function(e,t,i){var r;i.d(t,{R:function(){return r}}),function(e){e[e.LayerOnly=0]="LayerOnly",e[e.ColorComposite=1]="ColorComposite",e[e.GridComposite=2]="GridComposite",e[e.COUNT=3]="COUNT"}(r||(r={}))},58226:function(e,t,i){i.d(t,{R:function(){return c},T:function(){return h}});var r=i(41788),s=i(19155),n=i(85119),a=i(48857),o=i(52061),l=i(74826);class c extends l.K{constructor(){super(...arguments),this.scale=1,this.offset=r.AG}}function h(e){e.attributes.add(o.T.POSITION,"vec2"),e.attributes.add(o.T.UV0,"vec2"),e.varyings.add("uv","vec2"),e.varyings.add("vuv","vec2"),e.vertex.uniforms.add(new n.p("scale",(e=>e.scale)),new s.A("offset",(e=>e.offset))).main.add(a.H`gl_Position = vec4(position, 0.0, 1.0);
uv = uv0 * scale + offset;
vuv = uv0;`)}},34630:function(e,t,i){function r(e){e.code.add("\n  vec4 blendColorsPremultiplied(vec4 source, vec4 dest) {\n    float oneMinusSourceAlpha = 1.0 - source.a;\n    return source + dest * oneMinusSourceAlpha;\n  }\n  ")}function s(e,t){return e[0]=t[0]*t[3],e[1]=t[1]*t[3],e[2]=t[2]*t[3],e[3]=t[3],e}i.d(t,{m:function(){return r},p:function(){return s}})},93270:function(e,t,i){i.d(t,{U:function(){return r},j:function(){return n}});var r,s=i(8554);function n(e){return e&&(0,s.BZ)(e)?r.Mars:e&&(0,s.V2)(e)?r.Moon:r.Earth}!function(e){e[e.Earth=1]="Earth",e[e.Mars=2]="Mars",e[e.Moon=3]="Moon",e[e.COUNT=4]="COUNT"}(r||(r={}))},54231:function(e,t,i){i.d(t,{U:function(){return n}});var r=i(5998),s=i(92217);class n extends s.x{constructor(e,t){super(e,"bool",r.P.Pass,((i,r,s)=>i.setUniform1b(e,t(r,s))))}}},20022:function(e,t,i){i.d(t,{I:function(){return a}});var r=i(24910),s=i(86875),n=i(82846);class a{constructor(e){this._low=(0,n.Ue)(),this._high=(0,n.Ue)(),e&&this.set(e)}get low(){return this._low}get high(){return this._high}set(e){(0,r.c)(this._low,(0,r.c)(o,e));const t=(0,r.a)(o,e,this._low);(0,r.c)(this._high,t)}get(e){return(0,r.f)(e,this._low,this._high)}getLowScaled(e){return(0,r.g)(e,this._low,1)}}const o=(0,s.Ue)()},25631:function(e,t,i){i.d(t,{N:function(){return o}});var r=i(65562),s=i(25906),n=i(38419),a=i(65650);class o{constructor(e,t=n.J.None){this._techniques=e,this._parameters=new r.C,this._configuration=new n.Z,this._configuration.blitMode=t,e.precompile(s.l,this._configuration)}blit(e,t,i,r){e.bindFramebuffer(i.fbo),e.setClearColor(0,0,0,1),e.clear(a.Hf.COLOR),this._parameters.texture=t.getTexture();const n=this._techniques.get(s.l,this._configuration);e.bindTechnique(n,r,this._parameters),e.screen.draw()}blend(e,t,i,r,n=1){this._configuration.hasOpacityFactor=n<1;const a=this._techniques.get(s.l,this._configuration);return!!a.compiled&&(e.bindFramebuffer(i.fbo),this._parameters.texture=t.getTexture(),this._parameters.opacity=n,e.bindTechnique(a,r,this._parameters),e.screen.draw(),!0)}}},40673:function(e,t,i){i.d(t,{L9:function(){return s},Ml:function(){return a},S7:function(){return r},Su:function(){return o}});const r=2.6,s={sunny:.0022,cloudy:.0022,rainy:.0022,snowy:.0022,foggy:.0022};class n{constructor(e,t){this.near=e,this.far=t,this.near=o(e),this.far=o(t)}}const a={sunny:new n([.15,.05,.01,0,0],[1,.8,.6,.4,.2]),cloudy:new n([.15,.05,.01,0,0],[1,.8,.6,.4,.2]),rainy:new n([.15,.05,.01,0,0],[1,.8,.6,.4,.2]),snowy:new n([.15,.05,.01,0,0],[1,.8,.6,.4,.2]),foggy:new n([.15,.05,.01,0,0],[1,.8,.6,.4,.2])};function o(e,t=1){const i=e[0]+e[1]+e[2]+e[3]+e[4];return i<t?e:[e[0]/i,e[1]/i,e[2]/i,e[3]/i,e[4]/i]}},71356:function(e,t,i){function r(e){return!!e.update}i.d(t,{f:function(){return r}})},4486:function(e,t,i){i.d(t,{Y:function(){return r},n:function(){return o}});var r,s=i(61432),n=i(61544),a=i(99734);function o(e=!(0,s.Z)("disable-feature:high-quality-idle"),t=null){const i=new n.r;return e?(i.set(a.n.IDLE,r.Antialiasing,"low"!==t),i.set(a.n.IDLE,r.HighResolutionAtmosphere,"low"!==t),i.set(a.n.IDLE,r.HighQualityTransparency,!0),i.set(a.n.IDLE,r.SSAO,!0),i.set(a.n.IDLE,r.WaterReflection,!0),i.set(a.n.IDLE,r.PhysicalPixelRendering,!0)):(i.set(a.n.ANIMATING,r.HighResolutionShadows,!0),i.set(a.n.ANIMATING,r.HighResolutionViewshed,!0),i.set(a.n.INTERACTING,r.HighResolutionShadows,!0),i.set(a.n.INTERACTING,r.HighResolutionViewshed,!0)),i.set(a.n.IDLE,r.HighResolutionShadows,!0),i.set(a.n.IDLE,r.HighResolutionViewshed,!0),i.set(a.n.IDLE,r.HighResolutionVoxel,!0),i}!function(e){e[e.Antialiasing=0]="Antialiasing",e[e.HighQualityTransparency=1]="HighQualityTransparency",e[e.HighResolutionVoxel=2]="HighResolutionVoxel",e[e.HighResolutionAtmosphere=3]="HighResolutionAtmosphere",e[e.SSAO=4]="SSAO",e[e.WaterReflection=5]="WaterReflection",e[e.HighResolutionShadows=6]="HighResolutionShadows",e[e.HighResolutionViewshed=7]="HighResolutionViewshed",e[e.PhysicalPixelRendering=8]="PhysicalPixelRendering"}(r||(r={}))},47718:function(e,t,i){i.d(t,{F:function(){return h}});var r=i(73440),s=i(70880),n=i(90403),a=i(17155),o=(i(61432),i(96711),i(83850),i(48023)),l=i(10517),c=i(27076);let h=class extends s.Z{constructor(e){super(e),this._renderers=new Map}destroy(){this._renderers.forEach((e=>e.destroy())),this._renderers.clear()}initialize(){this.addHandles((0,n.YP)((()=>this.stage.view.state.highlights),(()=>this.updateHighlights())))}getMaterialRenderer(e){return this._renderers.get(e)}updateHighlights(){this._renderers.forEach((e=>e.updateHighlights(this.stage.view.state.highlightOrderMap)))}commit(e,t,i){const{adds:r,removes:s,updates:n}=e;if(0===r.length&&0===s.length&&0===n.length)return!1;(0,l.q9)(e).forEach(((e,r)=>{if(t.done)return;let s=this._renderers.get(r);null==s&&e.adds.length>0&&(s=new c.A({material:r,highlightOrderMap:this.stage.view.state.highlightOrderMap}),s.initializeRenderContext(i),this.rendererAdded(s),this._renderers.set(r,s)),s?(s.modify(e,t),s.updateHighlights(this.stage.view.state.highlightOrderMap),0===s.numGeometries&&(this._renderers.delete(s.material),this.rendererRemoved(s),s.destroy())):(e.clear(),t.madeProgress())}));let a=0;for(const e of this._renderers.values())e.drapedPriority=a++;return!0}get canCompact(){for(const e of this._renderers.values())if(e.canCompact)return!0;return!1}compact(e){let t=!1;for(const i of this._renderers.values()){if(e.done)return t;t=i.compact(e)||t}return t}get renderers(){return this._renderers}};(0,r._)([(0,a.Cb)({constructOnly:!0})],h.prototype,"stage",void 0),h=(0,r._)([(0,o.j)("esri.views.3d.webgl-engine.lib.RendererBase")],h)},62935:function(e,t,i){i.d(t,{S:function(){return w}});var r=i(73440),s=(i(61432),i(79577)),n=i(63974),a=i(17155),o=(i(96711),i(83850),i(48023)),l=i(41788),c=i(69055),h=i(38142),u=i(41044),d=i(82915),p=i(61442),m=i(32033),_=i(19821),f=i(19596),g=i(89341),y=i(47718),v=i(948),b=i(50399);let w=class extends y.F{constructor(e){super(e),this._pending=new C,this._changes=new d.as,this._sortedRenderers=new n.Z,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._sortedRenderers.clear(),this._geometries.clear(),this._pending.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}hasHighlight(e){return(0,s.oE)(this.renderers,(t=>t.hasHighlight(e)))}get hasWater(){return this._hasWater}get rendersOccludedDraped(){for(const e of this.renderers.values())if(0!==e.numGeometries&&e.renderOccludedFlags&~f.yD.Occlude)return!0;return!1}get isEmpty(){return!this.updating&&0===this.renderers.size&&0===this._geometries.size}get sortedRenderers(){return this._sortedRenderers}commitChanges(){return!!this.updating&&(this._processAddsRemoves(),this.commit(this._changes,b.G5,this.rendererContext.pluginContext)&&(this._updateSortedMaterialRenderers(),this._hasHighlights=(0,s.oE)(this.renderers,(e=>{const t=e.produces.get(v.r.DRAPED_MATERIAL);return!!t&&t(u.H_.Highlight)})),this._hasWater=(0,s.oE)(this.renderers,(e=>{const t=e.produces.get(v.r.DRAPED_WATER);return!!t&&t(u.H_.Normal)}))),this.notifyChange("updating"),!0)}rendererAdded(){this._sortedRenderers.clear()}rendererRemoved(){this._sortedRenderers.clear()}addGeometries(e,t){if(0===e.length)return;const i=this._validateRenderGeometries(e);for(const e of i)this._geometries.set(e.id,e);const r=this._pending.empty;for(const e of i)this._pending.adds.add(e);r&&this.notifyChange("updating"),t===g.T.UPDATE&&this._notifyGraphicGeometryChanged(e)}removeGeometries(e,t){const i=this._pending.empty,r=this._pending.adds;for(const t of e)r.has(t)?(this._pending.removed.add(t),r.delete(t)):this._pending.removed.has(t)||this._pending.removes.add(t),this._geometries.delete(t.id);i&&!this._pending.empty&&this.notifyChange("updating"),t===g.T.UPDATE&&this._notifyGraphicGeometryChanged(e)}modifyGeometries(e,t){const i=0===this._changes.updates.length;for(const i of e){const e=this._changes.updates.pushNew();e.renderGeometry=this._ensureValidRenderGeometry(i),e.updateType=t}switch(i&&this._changes.updates.length>0&&this.notifyChange("updating"),t){case g.$.TRANSFORMATION:case g.$.GEOMETRY:return this._notifyGraphicGeometryChanged(e);case g.$.VISIBILITY:return this._notifyGraphicVisibilityChanged(e)}}updateAnimation(e){let t=!1;return this._sortedRenderers.forAll((i=>t=!!i.updateAnimation&&i.updateAnimation(e)||t)),t}precompile(e){return this._sortedRenderers.reduce(((t,i)=>i.precompile(e)||t),!1)}render(e){this._sortedRenderers.forAll((t=>{const i=t.acquireTechniques(e);i&&t.render(e,i)}))}intersect(e,t,i,r,s){for(const n of this._geometries.values()){if(!r(n))continue;this._intersectRenderGeometry(n,i,t,0,e,s);const a=this.rendererContext.longitudeCyclical;a&&(n.boundingSphere[0]-n.boundingSphere[3]<a.min&&this._intersectRenderGeometry(n,i,t,a.range,e,s),n.boundingSphere[0]+n.boundingSphere[3]>a.max&&this._intersectRenderGeometry(n,i,t,-a.range,e,s)),s++}return s}_updateSortedMaterialRenderers(){if(!(this._sortedRenderers.length>0)){for(const e of this.renderers.values())this._sortedRenderers.push(e);this._sortedRenderers.sort(((e,t)=>t.material?.renderPriority===e.material?.renderPriority?e.drapedPriority-t.drapedPriority:(t.material?.renderPriority||0)-(e.material?.renderPriority||0)))}}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes)),this._changes.updates.filterInPlace((({renderGeometry:e})=>!this._pending.has(e))),this._pending.clear()}_intersectRenderGeometry(e,t,i,r,s,n){if(!e.visible||!e.material.visible||!e.material.intersectDraped)return;let a=0;r+=e.transformation[12],a=e.transformation[13],x[0]=i[0]-r,x[1]=i[1]-a,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersectDraped(e,s,x,((i,r,a)=>{!function(e,t,i,r,s,n,a){const o=new h.T6(n,a,t),l=t=>{t.set(_.q.OVERLAY,o,e.distance,e.normal,e.transformation,i,r)};if((null==s.results.min.drapedLayerOrder||i>=s.results.min.drapedLayerOrder)&&(null==s.results.min.distance||s.results.ground.distance<=s.results.min.distance)&&l(s.results.min),s.options.store!==p.e.MIN&&(null==s.results.max.drapedLayerOrder||i<s.results.max.drapedLayerOrder)&&(null==s.results.max.distance||s.results.ground.distance>s.results.max.distance)&&l(s.results.max),s.options.store===p.e.ALL){const e=new m.x(s.ray);l(e),s.results.all.push(e)}}(t,a,n,e.material.renderPriority,s,e.layerViewUid,e.graphicUid)}),t)}_notifyGraphicGeometryChanged(e){if(null==this.drapeSource.notifyGraphicGeometryChanged)return;let t;for(const{graphicUid:i}of e)null!=i&&i!==t&&(this.drapeSource.notifyGraphicGeometryChanged(i),t=i)}_notifyGraphicVisibilityChanged(e){if(null==this.drapeSource.notifyGraphicVisibilityChanged)return;let t;for(const{graphicUid:i}of e)null!=i&&i!==t&&(this.drapeSource.notifyGraphicVisibilityChanged(i),t=i)}_validateRenderGeometries(e){for(const t of e)this._ensureValidRenderGeometry(t);return e}_ensureValidRenderGeometry(e){return null==e.localOrigin&&(e.localOrigin=this._localOriginFactory.getOrigin((0,c.a)(e.boundingSphere))),e}get test(){}};(0,r._)([(0,a.Cb)({constructOnly:!0})],w.prototype,"drapeSource",void 0),(0,r._)([(0,a.Cb)({constructOnly:!0})],w.prototype,"rendererContext",void 0),(0,r._)([(0,a.Cb)()],w.prototype,"updating",null),(0,r._)([(0,a.Cb)()],w.prototype,"rctx",null),(0,r._)([(0,a.Cb)()],w.prototype,"_localOriginFactory",null),(0,r._)([(0,a.Cb)({readOnly:!0})],w.prototype,"isEmpty",null),(0,r._)([(0,a.Cb)()],w.prototype,"_geometries",void 0),w=(0,r._)([(0,o.j)("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],w);class C{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}const x=(0,l.Ue)()},13580:function(e,t,i){i.d(t,{g:function(){return h}});class r{constructor(e){this._maxCount=e,this._nextIndex=0,this._recycledIndices=[]}get activeCount(){return this._nextIndex-this._recycledIndices.length}get availableCount(){return this._recycledIndices.length+this._maxCount-this._nextIndex}acquire(){return this._recycledIndices.length>0?this._recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(e){this._recycledIndices.push(e)}}var s=i(81342),n=i(65650),a=i(8158),o=i(35928);class l{constructor(e,t=1){this._rctx=e,this._fieldCount=t,this.textureWidth=4096,this._dirty=!0;const i=new o.X(this.textureWidth,1);i.samplingMode=n.cw.NEAREST,i.wrapMode=n.e8.CLAMP_TO_EDGE,this._texture=new a.x(this._rctx,i),this._data=new s.mc(new ArrayBuffer(4*this.textureWidth))}dispose(){this._texture.dispose(),this._texture=void 0,this._data=void 0}setData(e,t,i,r,s,n){const a=e*this._fieldCount+t;this._dirty=!0,this._data.set(a,0,i),this._data.set(a,1,r),this._data.set(a,2,s),this._data.set(a,3,n)}setDataElement(e,t,i,r){const s=e*this._fieldCount+t;this._dirty=!0,this._data.set(s,i,r)}getDataElement(e,t,i){const r=e*this._fieldCount+t;return this._dirty=!0,this._data.get(r,i)}resizeToFit(e){const t=(e+1)*this._fieldCount;if(t>this._data.count){const e=Math.ceil(t/this.textureWidth)*this.textureWidth,i=new s.mc(new ArrayBuffer(4*e));i.typedBuffer.set(this._data.typedBuffer),this._data=i}}updateTexture(){if(!this._dirty)return;const e=this._texture.descriptor.width,t=this._texture.descriptor.height;this._data.count>e*t&&this._texture.resize(e,this._data.count/e),this._texture.setData(this._data.typedBuffer),this._dirty=!1}get texture(){return this._texture}}class c{constructor(e,t=1){this.textureBuffer=new l(e,t),this._indexManager=new r(65536)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this._indexManager.availableCount}get activeCount(){return this._indexManager.activeCount}acquireIndex(){const e=this._indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}releaseIndex(e){this._indexManager.release(e)}}class h{constructor(e,t=1){this._rctx=e,this._fieldCount=t,this._buffers=[]}garbageCollect(){this._buffers=this._buffers.filter((e=>0!==e.activeCount||(e.dispose(),!1)))}destroy(){this._buffers.forEach((e=>e.dispose())),this._buffers=[]}getBuffer(e){for(const t of this._buffers)if(t.availableCount>=e)return t;if(e>65536)return null;const t=new c(this._rctx,this._fieldCount);return this._buffers.push(t),t}updateTextures(){for(const e of this._buffers)e.textureBuffer.updateTexture()}}},54753:function(e,t,i){i.d(t,{Ar:function(){return p},l_:function(){return d},ow:function(){return u}});var r=i(57192),s=i(75025),n=i(31214),a=i(32335),o=i(92761),l=i(65650),c=i(8158),h=i(35928);function u(e,t=p.Pos2,i=s.i,c=-1,h=1){const u=t===p.Pos2Tex,d=u?r.LL?new Float32Array([c,c,0,h,c,0,c,h,0,h,h,0]):new Float32Array([c,c,0,0,h,c,1,0,c,h,0,1,h,h,1,1]):new Float32Array([c,c,h,c,c,h,h,h]);if(u&&r.LL){const e=(0,r.TQ)(d.buffer);e[10]=e[17]=e[22]=e[23]=1}return new a.U(e,i,new Map([["geometry",u?r.LL?n.W:n.GN:n.QI]]),new Map([["geometry",o.f.createVertex(e,l.l1.STATIC_DRAW,d)]]))}function d(e){const t=new h.X(4);return t.samplingMode=l.cw.NEAREST,new c.x(e,t)}var p;!function(e){e[e.Pos2=0]="Pos2",e[e.Pos2Tex=1]="Pos2Tex"}(p||(p={}))},13896:function(e,t,i){i.d(t,{w:function(){return n}});var r=i(82846),s=i(48737);class n extends s.Pf{constructor(e=(0,r.Ue)()){super(),this.origin=e}get slicePlaneLocalOrigin(){return this.origin}}},27076:function(e,t,i){i.d(t,{A:function(){return D}});var r=i(73440),s=i(3480),n=(i(61432),i(99574)),a=i(61100),o=i(61544),l=i(63974),c=i(74355),h=i(17155),u=(i(96711),i(48023)),d=i(31865),p=i(10934),m=i(72894),_=i(41044),f=i(20472),g=i(55003),y=i(89341),v=i(948),b=i(61719),w=i(13896);class C{constructor(e=0,t=0){this.from=e,this.to=t}get numElements(){return this.to-this.from}}function x(e){if(e.length<2)return;const t=new Map;e.forAll((e=>t.set(e.from,e)));let i=!0;for(;i;){i=!1;for(let r=0;r<e.length;++r){const s=e.data[r],n=t.get(s.to);n&&(s.to=n.to,t.delete(n.from),e.removeUnordered(n),i=!0)}}}class T extends C{constructor(e,t,i,r){super(t,i),this.geometry=e,this._highlightName=null,this.updateHighlightOptions(r)}updateHighlightOptions(e){const{geometry:t}=this;if(!t.hasHighlights)return void(this._highlightName=null);let i=-1,r=null;t.foreachHighlightOptions((t=>{const s=e.get(t)??-1;s>i&&(i=s,r=t)})),this._highlightName=r}get highlightName(){return this._highlightName}get isVisible(){return this.geometry.visible}get hasHighlights(){return this.isVisible&&this.geometry.hasHighlights}get hasOccludees(){return null!=this.geometry.occludees}}var S=i(79577);class M{constructor(){this.first=0,this.count=0}}var E=i(43295);class R{constructor(){this._numElements=0,this._instances=new Map,this.holes=new l.Z({allocator:e=>e||new C,deallocator:null}),this.hasHiddenInstances=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.highlightNames=new Set,this.drawCommandsDefault=P(),this.drawCommandsHighlights=new Map,this.drawCommandsOccludees=P(),this.drawCommandsShadowHighlightRest=P()}get numElements(){return this._numElements}get instances(){return this._instances}get hasHighlights(){return this.highlightNames.size>0}resetInstanceSummary(){this.hasHiddenInstances=!1,this.hasOccludees=!1,this.highlightNames.clear()}updateIfDrawCommandsDirty(e,t){if(this.drawCommandsDirty){this.resetInstanceSummary();for(const e of this.instances.values())this.updateDrawState(e);this.updateDrawCommands(e,t)}}addInstance(e,t){this.deleteInstance(e),this._instances.set(e,t),this._numElements+=t.numElements}deleteInstance(e){const t=this._instances.get(e);t&&(this._numElements-=t.numElements,this._instances.delete(e))}updateInstance(e,t,i){const r=this._instances.get(e);r&&(this._numElements-=r.numElements,r.from=t,r.to=i,this._numElements+=r.numElements)}updateDrawState(e){if(e.isVisible){const{highlightName:t}=e;t&&this.highlightNames.add(t),e.hasOccludees&&(this.hasOccludees=!0)}else this.hasHiddenInstances=!0}updateDrawCommands(e,t){if(this.drawCommandsDefault.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsDirty=!1,0===this._instances.size)return;const{sortedInstances:i}=this;if(this._updateHighlightDrawCommands(e,i),!this.needsMultipleCommands()){const e=this.drawCommandsDefault.pushNew(),i=this.holes.front();return this.vao&&1===this.holes.length&&i.to===Math.floor(this.vao.getByteLength("geometry")/t)?(e.first=0,void(e.count=i.from)):(e.first=1/0,e.count=0,this._instances.forEach((t=>{e.first=Math.min(e.first,t.from),e.count=Math.max(e.count,t.to)})),void(e.count-=e.first))}for(const e of i)e.isVisible&&A(e.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,e)}get sortedInstances(){return Array.from(this._instances.values()).sort(((e,t)=>e.from===t.from?e.to-t.to:e.from-t.from))}updateHighlights(e){this.highlightNames.clear();const t=this.sortedInstances;for(const i of t)i.updateHighlightOptions(e),i.isVisible&&i.highlightName&&this.highlightNames.add(i.highlightName);this._updateHighlightDrawCommands(e)}_updateHighlightDrawCommands(e,t=this.sortedInstances){const{drawCommandsHighlights:i,drawCommandsShadowHighlightRest:r}=this;i.clear(),r.clear();for(const s of t){if(s.updateHighlightOptions(e),!s.isVisible)continue;const{highlightName:t}=s;t&&(this.highlightNames.add(t),A((0,S.s1)(i,t,P),s)),t&&t===E.b||A(r,s)}}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}}function P(){return new l.Z({allocator:e=>e||new M,deallocator:e=>e})}function A(e,t){const i=e.back();if(null==i){const i=e.pushNew();return i.first=t.from,void(i.count=t.numElements)}if(function(e,t){return e.first+e.count>=t.from}(i,t)){const e=t.from-i.first+t.numElements;i.count=e}else{const i=e.pushNew();i.first=t.from,i.count=t.numElements}}class O{constructor(e){this.origin=e,this.buffers=new Array}dispose(){this.buffers.forEach((e=>e.vao.dispose())),this.buffers.length=0}findBuffer(e){return this.buffers.find((t=>t.instances.has(e)))}}let D=class extends f.tY{get _hasHighlights(){return this._highlightNames.size>0}hasHighlight(e){return this._highlightNames.has(e)}constructor(e){super(e),this._dataByOrigin=new Map,this._drawParameters=new w.w,this._highlightNames=new Set,this.drapedPriority=0,this._produces=new Map,this._hasOccludees=!1}destroy(){this._glMaterials=(0,a.M2)(this._glMaterials),this._dataByOrigin.forEach((e=>e.dispose())),this._dataByOrigin.clear(),this._vaoCache=null}initialize(){this._updateProduces()}_updateProduces(){this.material.produces.forEach(((e,t)=>{this._produces.set(t,(t=>!(0===this._dataByOrigin.size||!(t!==_.H_.Highlight&&t!==_.H_.ShadowHighlight||this._hasHighlights))&&e(t)))}))}initializeRenderContext(e){j??=e.renderContext.rctx.isAssumedMetalDriver,this._glMaterials=new g.p(this.material,e.materials),this._bufferWriter=this.material.createBufferWriter(),this._vaoCache=e.renderContext.rctx.getVaoCache(this.material.vertexAttributeLocations,(0,m.K)(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}get produces(){return this._produces}get hasOccludees(){return this._hasOccludees}get hasEmissions(){return this.material.hasEmissions}get isDecoration(){return this.material.parameters.isDecoration}get renderOccludedFlags(){return this.material.renderOccludedFlags}get numGeometries(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.instances.size),0))),e}get usedMemory(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.vao.cachedMemory),0))),e}forEachGeometry(e){this._dataByOrigin.forEach((t=>t.buffers.forEach((t=>t.instances.forEach((({geometry:t})=>e(t)))))))}modify(e,t){this._applyUpdates(e,t),this._applyAddsAndRemoves(e),this._updateDrawCommands()}get canCompact(){for(const e of this._dataByOrigin.values())if(e.buffers.some((e=>e.holes.length>1)))return!0;return!1}compact(e){if(!this.canCompact)return!1;let t=!1;for(const i of this._dataByOrigin.values()){const r=new Array;for(let t=0;t<i.buffers.length&&!e.done;){const s=i.buffers[t];s.holes.length<=1?++t:(s.instances.forEach((({geometry:e})=>r.push(e))),this._vaoCache.deleteVao(s.vao),i.buffers[t]=i.buffers[i.buffers.length-1],--i.buffers.length,e.madeProgress())}if(r.length>0){for(i.buffers.forEach((e=>this._applyAdds(e,r)));r.length>0;)i.buffers.push(this._applyAndRebuild(new R,r,null));t=!0}}return t}updateHighlights(e){this.highlightOrderMap=e,this._highlightNames.clear(),this._dataByOrigin.forEach((t=>{t.buffers.forEach((t=>{t.updateHighlights(e),t.highlightNames.forEach((e=>this._highlightNames.add(e)))}))})),this._updateProduces()}_applyUpdates(e,t){const i=this._bufferWriter;if(null==i)return void e.clearUpdates();const r=i.vertexBufferLayout.stride/4;for(const s of e.updates){if(t.done)return;const{renderGeometry:n,updateType:a}=s;e.pending.updates.removeUnordered(s),t.madeProgress();const o=this._dataByOrigin.get(n.localOrigin.id)?.findBuffer(n.id);if(null==o)return;const l=o.instances.get(n.id);if(a&(y.$.GEOMETRY|y.$.TRANSFORMATION)){const e=G(i.elementCount(l.geometry.geometry.attributes)*r),t=i.vertexBufferLayout.createView(e.buffer);this._writeGeometry(n,t,0),o.vao.vertexBuffers.get("geometry").setSubData(e,l.from*r,0,l.numElements*r)}a&(y.$.HIGHLIGHT|y.$.OCCLUDEE|y.$.VISIBILITY)&&(o.drawCommandsDirty=!0)}}_computeDeltas(e,t){const i=new o.r;for(const t of e){const e=t.localOrigin;if(null==e)continue;let r=i.get(e.id,null);null==r&&(r=new I(e.vec3),i.set(e.id,null,r)),r.changes.push(t)}for(const e of t){const t=e.localOrigin;if(null==t)continue;const r=this._dataByOrigin.get(t.id)?.findBuffer(e.id);if(null==r)continue;let s=i.get(t.id,r);null==s&&(s=new I(t.vec3),i.set(t.id,r,s)),s.changes.push(e)}return i}_applyAddsAndRemoves(e){const{_bufferWriter:t,_dataByOrigin:i,_vaoCache:r}=this;if(null==t||null==r)return void e.clearAddsAndRemoves();const n=t.vertexBufferLayout.stride/4,a=this._computeDeltas(e.adds,e.removes);a.forEach(((e,o)=>{const l=e.get(null),c=l?.changes??[];a.delete(o,null);let h=i.get(o);if(e.forEach(((e,l)=>{if(a.delete(o,l),null==l&&(0,b.hu)(!1,"No VAO for removed geometries"),l.instances.size===e.changes.length)return r.deleteVao(l.vao),(0,s.e$)(h.buffers,l),void(0===h.buffers.length&&0===c.length&&i.delete(o));const u=l.numElements,d=l.vao.getByteLength("geometry")/4,p=c.reduce(((e,i)=>e+t.elementCount(i.geometry.attributes)),0),m=e.changes.reduce(((e,i)=>e+t.elementCount(i.geometry.attributes)),0),_=Math.min((u+p-m)*n,B),f=_>d;_>H&&_<d/2?(e.changes.forEach((({id:e})=>l.deleteInstance(e))),l.instances.forEach((({geometry:e})=>c.push(e))),this._vaoCache.deleteVao(l.vao),(0,s.e$)(h.buffers,l)):f?this._applyAndRebuild(l,c,e):this._applyRemoves(l,e)})),c.length>0)for(null==h&&(h=new O(l.origin),i.set(o,h)),h.buffers.forEach((e=>this._applyAdds(e,c)));c.length>0;)h.buffers.push(this._applyAndRebuild(new R,c,null))})),e.clearAddsAndRemoves()}_updateDrawCommands(){this._highlightNames.clear(),this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.buffers.forEach((e=>{e.updateIfDrawCommandsDirty(this.highlightOrderMap,this._bufferWriter.vertexBufferLayout.stride),e.hasHighlights&&(0,c.w6)(this._highlightNames,e.highlightNames),this._hasOccludees=this._hasOccludees||e.hasOccludees}))}))}_applyAndRebuild(e,t,i){if(i)for(const t of i.changes)e.deleteInstance(t.id);const r=this._bufferWriter,s=r.vertexBufferLayout.stride,n=s/4,a=Math.floor(B/n);let o=e.numElements;for(;t.length>0;){const i=t.pop(),s=r.elementCount(i.geometry.attributes);if(o+s>a&&o>0){t.push(i);break}o+=s;const n=new T(i,0,0,this.highlightOrderMap);(0,b.hu)(null==e.instances.get(i.id)),e.addInstance(i.id,n)}const l=o*n,c=G(l),h=r.vertexBufferLayout.createView(c.buffer);let u=0;e.resetInstanceSummary(),e.instances.forEach(((t,i)=>{this._writeGeometry(t.geometry,h,u);const s=u;u+=r.elementCount(t.geometry.geometry.attributes),e.updateInstance(i,s,u),e.updateDrawState(t)})),this._vaoCache.deleteVao(e.vao),e.vao=this._vaoCache.newVao(q(l)),e.vao.vertexBuffers.get("geometry").setSubData(c,0,0,u*n),e.holes.clear();const d=e.holes.pushNew();return d.from=u,d.to=Math.floor(e.vao.getByteLength("geometry")/s),e.updateDrawCommands(this.highlightOrderMap,s),e}_applyRemoves(e,t){if(0===t.changes.length||null==this._bufferWriter)return;let i=1/0,r=-1/0;for(const s of t.changes){const t=s.id,n=e.instances.get(t);if(!n)continue;e.deleteInstance(t),j&&(i=Math.min(i,n.from),r=Math.max(r,n.to));const a=U.back();if(a){if(a.to===n.from){a.to=n.to;continue}if(a.from===n.to){a.from=n.from;continue}}const o=U.pushNew();o.from=n.from,o.to=n.to}x(U);const s=this._bufferWriter.vertexBufferLayout.stride/4,n=e.vao.vertexBuffers.get("geometry");if(j){const t=(r-i)*s,a=G(t),o=this._bufferWriter.vertexBufferLayout.createView(a.buffer);a.fill(0,0,t),e.instances.forEach((e=>{if(!(e.from>=i&&e.to<=r))return;const t=e.from-i;this._writeGeometry(e.geometry,o,t)})),n.setSubData(a,i*s,0,t)}else{const e=U.reduce(((e,t)=>Math.max(e,t.numElements)),0)*s,t=G(e);t.fill(0,0,e),U.forAll((e=>n.setSubData(t,e.from*s,0,e.numElements*s)))}e.holes.pushArray(U.data,U.length),U.forAll(((e,t)=>U.data[t]=null)),U.clear(),e.drawCommandsDirty=!0}_applyAdds(e,t){if(0===t.length||null==this._bufferWriter)return;if(!function(e){return null!=e.vao}(e))return void this._applyAndRebuild(e,t,null);const i=this._bufferWriter,r=i.vertexBufferLayout.stride/4,n=e.numElements,a=t.reduce(((e,t)=>e+i.elementCount(t.geometry.attributes)),0),o=Math.min((n+a)*r,B),l=4*o;if(e.vao.getByteLength("geometry")<q(B-H)&&l>e.vao.getByteLength("geometry"))return void this._applyAndRebuild(e,t,null);x(e.holes);const c=new Array;let h=1/0,u=-1/0;for(const r of t){const t=i.elementCount(r.geometry.attributes),s=L(e.holes,t);c.push(s),j&&null!=s&&(h=Math.min(s,h),u=Math.max(s+t,u))}const d=e.vao.vertexBuffers.get("geometry");let p=0,m=0,_=0;const f=G(j?(u-h)*r:o),g=i.vertexBufferLayout.createView(f.buffer);if(t.forEach(((t,s)=>{const n=c[s];if(null==n)return;const a=i.elementCount(t.geometry.attributes);if(!j){if(_!==n){const e=_-m;e>0&&d.setSubData(f,m*r,0,e*r),m=n,p=0}this._writeGeometry(t,g,p),p+=a,_=n+a}const o=new T(t,n,n+a,this.highlightOrderMap);(0,b.hu)(null==e.instances.get(t.id)),e.addInstance(t.id,o),e.drawCommandsDirty=!0})),j){const t=(u-h)*r;f.fill(0,0,t),e.instances.forEach((e=>{if(!(e.from>=h&&e.to<=u))return;const t=e.from-h;this._writeGeometry(e.geometry,g,t)})),m=h,_=u}const y=_-m;y>0&&d.setSubData(f,m*r,0,y*r),(0,s.hv)(t,((e,t)=>null==c[t]))}_writeGeometry(e,t,i){null!=this._bufferWriter&&((0,d.JG)(F,e.transformation),F[12]-=e.localOrigin.vec3[0],F[13]-=e.localOrigin.vec3[1],F[14]-=e.localOrigin.vec3[2],(0,d.U_)(N,F),(0,d.p4)(N,N),this._bufferWriter.write(F,N,e.geometry.attributes,e.geometry.objectAndLayerIdColor,t,i))}updateAnimation(e){return this.material.update(e)}acquireTechniques(e){if(!this.material.shouldRender(e))return null;const{output:t,bind:i}=e;if(!this.material.produces.get(i.slot)?.(t))return null;const{highlight:r,slot:s}=i,n=t===_.H_.ShadowHighlight,a=t===_.H_.Highlight,o=a||n,l=r?.name;if(o&&(0===this._highlightNames.size||a&&l&&!this._highlightNames.has(l)))return null;const c=e=>a&&!!l&&!e.has(l),h=t===_.H_.ShadowExcludeHighlight,u=!(o||h);for(const{buffers:r}of this._dataByOrigin.values())for(const a of r){if(c(a.highlightNames))continue;const r=n?a.drawCommandsHighlights.get(E.b):o?l?a.drawCommandsHighlights.get(l):a.drawCommandsHighlights.size>0:((h&&a.needsMultipleCommands()?a.drawCommandsShadowHighlightRest:a.drawCommandsDefault)||null)?.length??!1,d=u&&a.drawCommandsOccludees||null;if(r||d?.length){const r=this._glMaterials.load(e.rctx,s,t)?.beginSlot(i);if(r)return r}}return null}render(e,t){const{output:i,bind:r}=e,{slot:s,highlight:n}=r,a=i===_.H_.Highlight,o=n?.name??"";if(a&&!n)return;const c=i===_.H_.ShadowHighlight,h=a||c,u=i===_.H_.ShadowExcludeHighlight,d=!(h||u),p=s===v.r.OCCLUDER_MATERIAL||s===v.r.TRANSPARENT_OCCLUDER_MATERIAL?s:null,{rctx:m}=e;m.runAppleAmdDriverHelper();const f=m.bindTechnique(t,r,this.material.parameters);for(const e of this._dataByOrigin.values())for(const i of e.buffers){if(a&&(!i.hasHighlights||!i.drawCommandsHighlights.has(o)))continue;if(c&&(!i.hasHighlights||!i.drawCommandsHighlights.has(E.b)))continue;const s=()=>{const e=[],t=i.drawCommandsHighlights.get(E.b)??new l.Z;return t&&e.push(t),e},n=h&&!c?i.drawCommandsHighlights.get(o)??null:null,_=c?s():h?n?[n]:Z:u&&i.needsMultipleCommands()?[i.drawCommandsShadowHighlightRest]:[i.drawCommandsDefault],g=_.some((e=>e.length>0)),y=d&&i.drawCommandsOccludees||null;if(g||y?.length){if(this._drawParameters.origin=e.origin,f.bindDraw(r,this.material.parameters,this._drawParameters),t.ensureAttributeLocations(i.vao),m.bindVAO(i.vao),g)for(const e of _)m.setPipelineState(t.getPipeline(!1,p)),e.forAll((e=>m.drawArrays(t.primitiveType,e.first,e.count)));y?.length&&(m.setPipelineState(t.getPipeline(!0,p)),y.forAll((e=>m.drawArrays(t.primitiveType,e.first,e.count))))}}}static prune(){z=new Float32Array(H)}get test(){}};(0,r._)([(0,h.Cb)({constructOnly:!0})],D.prototype,"material",void 0),(0,r._)([(0,h.Cb)({})],D.prototype,"highlightOrderMap",void 0),D=(0,r._)([(0,u.j)("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],D);class I{constructor(e){this.origin=e,this.changes=new Array}}function L(e,t){const i=e.find((e=>e.numElements>=t));if(null==i)return null;const r=i.from;return i.from+=t,i.from>=i.to&&e.removeUnordered(i),r}const F=(0,p.Ue)(),N=(0,p.Ue)(),U=new l.Z({allocator:e=>e||new C,deallocator:null}),H=65536,V=4*H,k=16777216,B=k/4;let z=new Float32Array(H);function G(e){return z.length<e&&(z=new Float32Array(e)),z}function q(e){const t=4*e;return t<=1024?1024:t<V?(0,n.Sf)(t):Math.max(Math.min(Math.ceil(1.5*t/V)*V,k),t)}const Z=[];let j},25906:function(e,t,i){i.d(t,{l:function(){return c}});var r=i(79487),s=i(58257),n=i(29107),a=i(65562),o=i(38419),l=i(51135);class c extends n.A{constructor(e,t){super(e,t,new s.J(a.a,(()=>i.e(39568).then(i.bind(i,39568)))))}initializePipeline(e){switch(e.blitMode){case o.J.None:case o.J.Depth:return(0,l.sm)({colorWrite:l.gf});case o.J.Alpha:return(0,l.sm)({blending:l.vf,colorWrite:l.gf});default:(0,r.Bg)(e.blitMode);case o.J.PremultipliedAlpha:case o.J.COUNT:return(0,l.sm)({blending:l.Zo,colorWrite:l.gf})}}}},38419:function(e,t,i){i.d(t,{J:function(){return r},Z:function(){return a}});var r,s=i(73440),n=i(83046);!function(e){e[e.None=0]="None",e[e.Alpha=1]="Alpha",e[e.PremultipliedAlpha=2]="PremultipliedAlpha",e[e.Depth=3]="Depth",e[e.COUNT=4]="COUNT"}(r||(r={}));class a extends n.m{constructor(){super(...arguments),this.blitMode=r.None,this.hasOpacityFactor=!1}}(0,s._)([(0,n.o)({count:r.COUNT})],a.prototype,"blitMode",void 0),(0,s._)([(0,n.o)()],a.prototype,"hasOpacityFactor",void 0)},8069:function(e,t,i){i.d(t,{T:function(){return n}});var r=i(73440),s=i(83046);class n extends s.m{constructor(){super(...arguments),this.receiveShadows=!0}}(0,r._)([(0,s.o)()],n.prototype,"receiveShadows",void 0)},4075:function(e,t,i){i.d(t,{X:function(){return l}});var r=i(31865),s=i(10934),n=i(48857),a=i(18489),o=i(52061);function l(e,t={needUVs:!0,needEyeDirection:!0}){e.attributes.add(o.T.POSITION,"vec2"),e.varyings.add("worldRay","vec3");const{needUVs:i,needEyeDirection:s}=t;i&&e.varyings.add("uv","vec2"),s&&e.varyings.add("eyeDir","vec3"),e.vertex.uniforms.add(new a.C("inverseProjectionMatrix",(e=>e.camera.inverseProjectionMatrix)),new a.C("inverseViewMatrix",(e=>(0,r.iS)(c,e.camera.viewMatrix)))),e.vertex.main.add(n.H`
    vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;
    ${(0,n.If)(s,"eyeDir = posViewNear;")}
    worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
    ${(0,n.If)(i,"uv = position * 0.5 + vec2(0.5);")}
    gl_Position = vec4(position, 1, 1);
  `)}const c=(0,s.Ue)()},80518:function(e,t,i){i.d(t,{i:function(){return a},j:function(){return r}});var r,s=i(73440),n=i(83046);!function(e){e[e.PRIMARY=0]="PRIMARY",e[e.CONTEXT=1]="CONTEXT",e[e.COUNT=2]="COUNT"}(r||(r={}));class a extends n.m{constructor(e){super(),this.index=r.PRIMARY,this.index=e}}(0,s._)([(0,n.o)({count:r.COUNT})],a.prototype,"index",void 0)},65718:function(e,t,i){i.d(t,{l:function(){return a},w:function(){return r}});var r,s=i(73440),n=i(83046);!function(e){e[e.Gradient=0]="Gradient",e[e.BandedGradient=1]="BandedGradient",e[e.Threshold=2]="Threshold",e[e.ThresholdAndGradient=3]="ThresholdAndGradient",e[e.COUNT=4]="COUNT"}(r||(r={}));class a extends n.m{constructor(){super(...arguments),this.visualization=r.Gradient}}(0,s._)([(0,n.o)({count:r.COUNT})],a.prototype,"visualization",void 0)},47975:function(e,t,i){i.d(t,{l:function(){return s}});var r=i(48857);function s(e){e.code.add(r.H`vec2 sphereIntersect(vec3 start, vec3 dir, float distance) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float d = (b * b) - 4.0 * a * distance;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`)}},50670:function(e,t,i){var r;i.d(t,{t:function(){return r}}),function(e){e[e.Left=0]="Left",e[e.Middle=1]="Middle",e[e.Right=2]="Right"}(r||(r={}))},26124:function(e,t,i){i.d(t,{CE:function(){return u},uS:function(){return l}});i(61432);var r=i(50702),s=i(99574),n=i(96094),a=i(42527),o=i(96620);i(50670);const l=["click","double-click","immediate-click","immediate-double-click","hold","drag","key-down","key-up","pointer-down","pointer-move","pointer-up","pointer-drag","mouse-wheel","pointer-enter","pointer-leave","gamepad","focus","blur"],c={};function h(e){return!!c[e]}l.forEach((e=>{c[e]=!0}));class u{constructor(e){this._handlers=new Map,this._counter=0,this._handlerCounts=new Map,this.view=e,this.inputManager=null}connect(e){e&&this.disconnect(),this.inputManager=e,this._handlers.forEach((({handler:e,priority:t},i)=>this.inputManager?.installHandlers(i,[e],t)))}disconnect(){this.inputManager&&this._handlers.forEach(((e,t)=>this.inputManager?.uninstallHandlers(t))),this.inputManager=null}destroy(){this.disconnect(),this._handlers.clear(),this.view=null}on(e,t,i,s){const n=Array.isArray(e)?e:e.split(",");if(!function(e){for(const t of e)if(!h(t))return!1;return!0}(n))return n.some(h)&&console.error("Error: registering input events and other events on the view at the same time is not supported."),null;let a,l;Array.isArray(t)?l=t:(a=t,l=[]),"function"==typeof i?a=i:s=i,s=null!=s?s:o.f.DEFAULT;const c=this._createUniqueGroupName(),u=new d(this.view,n,l,a);this._handlers.set(c,{handler:u,priority:s});for(const e of n){const t=this._handlerCounts.get(e)||0;this._handlerCounts.set(e,t+1)}return this.inputManager&&this.inputManager.installHandlers(c,[u],s),(0,r.kB)((()=>this._removeHandler(c,n)))}hasHandler(e){return!!this._handlerCounts.get(e)}_removeHandler(e,t){if(this._handlers.has(e)){this._handlers.delete(e);for(const e of t){const t=this._handlerCounts.get(e);void 0===t||(1===t?this._handlerCounts.delete(e):this._handlerCounts.set(e,t-1))}}this.inputManager&&this.inputManager.uninstallHandlers(e)}_createUniqueGroupName(){return this._counter+=1,`viewEvents_${this._counter}`}}class d extends a.a{constructor(e,t,i,r){super(!0),this._latestDragStart=void 0,this.view=e;for(const s of t)switch(s){case"click":this.registerIncoming("click",i,(t=>r(_(e,t))));break;case"double-click":this.registerIncoming("double-click",i,(t=>r(f(e,t))));break;case"immediate-click":this.registerIncoming("immediate-click",i,(t=>r(g(e,t))));break;case"immediate-double-click":this.registerIncoming("immediate-double-click",i,(t=>r(y(e,t))));break;case"hold":this.registerIncoming("hold",i,(t=>r(v(e,t))));break;case"drag":this.registerIncoming("drag",i,(e=>{const t=this._wrapDrag(e);t&&r(t)}));break;case"key-down":this.registerIncoming("key-down",i,(e=>r(w(e))));break;case"key-up":this.registerIncoming("key-up",i,(e=>r(C(e))));break;case"pointer-down":this.registerIncoming("pointer-down",i,(e=>r(x(e,"pointer-down"))));break;case"pointer-move":this.registerIncoming("pointer-move",i,(e=>r(x(e,"pointer-move"))));break;case"pointer-up":this.registerIncoming("pointer-up",i,(e=>r(x(e,"pointer-up"))));break;case"pointer-drag":this.registerIncoming("pointer-drag",i,(e=>r(T(e))));break;case"mouse-wheel":this.registerIncoming("mouse-wheel",i,(e=>r(S(e))));break;case"pointer-enter":this.registerIncoming("pointer-enter",i,(e=>r(x(e,"pointer-enter"))));break;case"pointer-leave":this.registerIncoming("pointer-leave",i,(e=>r(x(e,"pointer-leave"))));break;case"gamepad":this.registerIncoming("gamepad",i,(e=>{r(M(e))}));break;case"focus":this.registerIncoming("focus",i,(e=>{r(p(e))}));break;case"blur":this.registerIncoming("blur",i,(e=>{r(m(e))}))}}_wrapDrag(e){const t=e.data,{x:i,y:r}=t.center,{action:n,pointerType:a,button:o}=t;if("start"===n&&(this._latestDragStart=t),!this._latestDragStart)return;const l=t.pointer.native,c=t.buttons,{cancelable:h,timestamp:u}=e,d={x:this._latestDragStart.center.x,y:this._latestDragStart.center.y};return"end"===n&&(this._latestDragStart=void 0),{type:"drag",action:n,x:i,y:r,origin:d,pointerType:a,button:o,buttons:c,radius:t.radius,angle:(0,s.BV)(t.angle),native:l,timestamp:u,cancelable:h,stopPropagation:()=>e.stopPropagation(),defer:t=>e.defer(t),preventDefault:()=>e.preventDefault()}}}function p(e){return{type:"focus",timestamp:e.timestamp,native:e.data.native,cancelable:e.cancelable,stopPropagation:()=>e.stopPropagation(),defer:t=>e.defer(t),preventDefault:()=>e.preventDefault()}}function m(e){return{type:"blur",timestamp:e.timestamp,native:e.data.native,cancelable:e.cancelable,stopPropagation:()=>e.stopPropagation(),defer:t=>e.defer(t),preventDefault:()=>e.preventDefault()}}function _(e,t){const{pointerType:i,button:r,buttons:s,x:a,y:o,native:l,eventId:c}=t.data,{cancelable:h,timestamp:u}=t;return{type:"click",pointerType:i,button:r,buttons:s,x:a,y:o,native:l,timestamp:u,screenPoint:(0,n.vW)(a,o),mapPoint:b(e,a,o),eventId:c,cancelable:h,stopPropagation:()=>t.stopPropagation(),defer:e=>t.defer(e),preventDefault:()=>t.preventDefault()}}function f(e,t){const{pointerType:i,button:r,buttons:s,x:n,y:a,native:o,eventId:l}=t.data,{cancelable:c,timestamp:h}=t;return{type:"double-click",pointerType:i,button:r,buttons:s,x:n,y:a,native:o,timestamp:h,mapPoint:b(e,n,a),eventId:l,cancelable:c,stopPropagation:()=>t.stopPropagation(),defer:e=>t.defer(e),preventDefault:()=>t.preventDefault()}}function g(e,t){const{pointerType:i,button:r,buttons:s,x:n,y:a,native:o,eventId:l}=t.data,c=o.pointerId,{cancelable:h,timestamp:u}=t;return{type:"immediate-click",pointerId:c,pointerType:i,button:r,buttons:s,x:n,y:a,native:o,timestamp:u,mapPoint:b(e,n,a),eventId:l,cancelable:h,stopPropagation:()=>t.stopPropagation(),defer:e=>t.defer(e),preventDefault:()=>t.preventDefault()}}function y(e,t){const{pointerType:i,button:r,buttons:s,x:n,y:a,native:o,eventId:l}=t.data,c=o.pointerId,{cancelable:h,timestamp:u}=t;return{type:"immediate-double-click",pointerId:c,pointerType:i,button:r,buttons:s,x:n,y:a,native:o,timestamp:u,mapPoint:b(e,n,a),eventId:l,cancelable:h,stopPropagation:()=>t.stopPropagation(),defer:e=>t.defer(e),preventDefault:()=>t.preventDefault()}}function v(e,t){const{pointerType:i,button:r,buttons:s,x:n,y:a,native:o}=t.data,{cancelable:l,timestamp:c}=t;return{type:"hold",pointerType:i,button:r,buttons:s,x:n,y:a,native:o,timestamp:c,mapPoint:b(e,n,a),cancelable:l,stopPropagation:()=>t.stopPropagation(),defer:e=>t.defer(e),preventDefault:()=>t.preventDefault()}}function b(e,t,i){return e.toMap((0,n.vW)(t,i),{exclude:[]})}function w(e){const{key:t,repeat:i,native:r}=e.data,{cancelable:s,timestamp:n}=e;return{type:"key-down",key:t,repeat:i,native:r,timestamp:n,cancelable:s,stopPropagation:()=>e.stopPropagation(),defer:t=>e.defer(t),preventDefault:()=>e.preventDefault()}}function C(e){const{key:t,native:i}=e.data,{cancelable:r,timestamp:s}=e;return{type:"key-up",key:t,native:i,timestamp:s,cancelable:r,stopPropagation:()=>e.stopPropagation(),defer:t=>e.defer(t),preventDefault:()=>e.preventDefault()}}function x(e,t){const{x:i,y:r,button:s,buttons:n,native:a,eventId:o}=e.data,l=a.pointerId,c=a.pointerType,{cancelable:h,timestamp:u}=e;return{type:t,x:i,y:r,pointerId:l,pointerType:c,button:s,buttons:n,native:a,timestamp:u,eventId:o,cancelable:h,stopPropagation:()=>e.stopPropagation(),defer:t=>e.defer(t),preventDefault:()=>e.preventDefault()}}function T(e){const{x:t,y:i,buttons:r,native:s,eventId:n}=e.data.currentEvent,{button:a}=e.data.startEvent,o=e.data.startEvent.native.pointerId,l=e.data.startEvent.native.pointerType,c=e.data.action,h={x:e.data.startEvent.x,y:e.data.startEvent.y},{cancelable:u,timestamp:d}=e;return{type:"pointer-drag",x:t,y:i,pointerId:o,pointerType:l,button:a,buttons:r,action:c,origin:h,native:s,timestamp:d,eventId:n,cancelable:u,stopPropagation:()=>e.stopPropagation(),defer:t=>e.defer(t),preventDefault:()=>e.preventDefault()}}function S(e){const{cancelable:t,data:i,timestamp:r}=e,{x:s,y:n,deltaY:a,native:o}=i;return{type:"mouse-wheel",x:s,y:n,deltaY:a,native:o,timestamp:r,cancelable:t,stopPropagation:()=>e.stopPropagation(),defer:t=>e.defer(t),preventDefault:()=>e.preventDefault()}}function M(e){const{action:t,state:i,device:r}=e.data,{cancelable:s,timestamp:n}=e,{buttons:a,axes:o}=i;return{type:"gamepad",device:r,timestamp:n,action:t,buttons:a,axes:o,cancelable:s,stopPropagation:()=>e.stopPropagation(),defer:t=>e.defer(t),preventDefault:()=>e.preventDefault()}}},53433:function(e,t,i){i.r(t),i.d(t,{completeUserSettings:function(){return n},createEmptyImageData:function(){return s.r7},encode:function(){return o},encodeData:function(){return l},getFormatAndQuality:function(){return p},getMaximumResolutionScale:function(){return m},resampleHermite:function(){return _},screenshotSuperSampleSettings:function(){return f},toDataUrl:function(){return d},toRenderSettings:function(){return a}});i(61432);var r=i(99574),s=i(35236);function n(e,t){const{format:i,quality:s,rotation:n,disableDecorations:a}=e||{},o=g(e,t.padding),l=function(e,t){const i={x:0,y:0,width:t.width,height:t.height};if(e?.area){null!=e.area.x&&(i.x=Math.floor(e.area.x)),null!=e.area.y&&(i.y=Math.floor(e.area.y));const r=null!=e.area.width?Math.floor(e.area.width):null,s=null!=e.area.height?Math.floor(e.area.height):null;if(i.width=t.width-i.x,i.height=t.height-i.y,null!=r&&null!=s)i.width=Math.min(i.width,r),i.height=Math.min(i.height,s);else if(null==r&&null!=s){const e=Math.min(i.width,r);i.height=e/i.width*i.height,i.width=e}else if(null!=r&&null==s){const e=Math.min(i.height,s);i.width=e/i.height*i.width,i.height=e}}return function(e,t){const i=Math.floor(Math.max(e.x,0)),r=Math.floor(Math.max(e.y,0)),s={x:i,y:r,width:Math.floor(Math.min(e.width,t.width-i)),height:Math.floor(Math.min(e.height,t.height-r))},n=s.width/s.height,a=e.width/e.height;if(a===n)return s;if(a>n){const e=Math.floor(s.width/a),t=s.height-e;return{x:s.x,y:Math.floor(s.y+t/2),width:s.width,height:e}}const o=Math.floor(s.height*a),l=s.width-o;return{x:Math.floor(s.x+l/2),y:s.y,width:o,height:s.height}}(function(e,t){if(null==t?.width||null==t.height)return e;const i=t.width/t.height,r=e.width/e.height;if(r===i)return e;if(r<i){const t=Math.floor(e.height*i);return e.x-=(t-e.width)/2,e.width=t,e}const s=Math.floor(e.width/i);return e.y-=(s-e.height)/2,e.height=s,e}(i,e),t)}(e,{width:t.width-o.left-o.right,height:t.height-o.top-o.bottom}),{width:c,height:h}=function(e,t){if(!e)return t;const i=e.width,r=e.height;if(null!=i&&null!=r)return{width:Math.floor(i),height:Math.floor(r)};if(null==i&&null==r)return t;const s=t.width/t.height;return null==r?{width:Math.floor(i),height:Math.floor(i/s)}:{width:Math.floor(r*s),height:Math.floor(r)}}(e,l),u=y(i),d=w[u];return{format:u,quality:(0,r.uZ)(null!=s?s:d,0,100),area:l,width:c,height:h,rotation:n,disableDecorations:!!a,ignoreBackground:!!e?.ignoreBackground,ignorePadding:!!e?.ignorePadding}}function a(e,t){const i=n(e,t),r=i.area,s=i.width/r.width,a=g(i,t.padding),o=a.left+a.right,l=a.top+a.bottom,c=t.width-o,h=t.height-l,u=Math.floor(c*s+o),d=Math.floor(h*s+l),p=e?.layers??[],m=i.ignoreBackground,_=i.ignorePadding;return{framebufferWidth:u,framebufferHeight:d,region:{x:Math.floor(r.x*s)+a.left,y:Math.floor(r.y*s)+a.top,width:i.width,height:i.height},format:i.format,quality:i.quality,rotation:i.rotation,pixelRatio:s,layers:p,disableDecorations:i.disableDecorations,ignoreBackground:m,ignorePadding:_,objectAndLayerIdColor:!1}}function o(e,t,i){const{ctx:r,canvas:s}=c(e,i),n=r.getImageData(0,0,e.width,e.height),a=d(s,t);return h(s),{dataUrl:a,data:n}}function l(e,t){const{ctx:i,canvas:r}=c(e,t),s=i.getImageData(0,0,e.width,e.height);return h(r),s}function c(e,t){const i=(null==u&&(u=document.createElement("canvas")),u);t.premultipliedAlpha&&function(e){const t=e.data,i=t.length;for(let e=0;e<i;e+=4){const i=t[e+3];if(255!==i&&i>0){const r=255/i;t[e]=t[e]*r,t[e+1]=t[e+1]*r,t[e+2]=t[e+2]*r}}}(e),i.width=e.width,i.height=e.height;const r=i.getContext("2d",{willReadFrequently:!0});return r.putImageData(e,0,0),t.flipY&&function(e){e.save(),e.globalCompositeOperation="copy",e.scale(1,-1),e.translate(0,-e.canvas.height),e.drawImage(e.canvas,0,0),e.restore()}(r),{ctx:r,canvas:i}}function h(e){e.width=0,e.height=0}let u=null;function d(e,t){const i=v[t.format],r=t.quality/100;return e.toDataURL(i,r)}function p(e,t){const i=y(e),s=w[i];return{format:i,quality:(0,r.uZ)(null!=t?t:s,0,100)}}function m(e,t){return t/Math.max(e[0],e[1])}function _(e,t,i,r=0,s=0,n=e.width-r,a=e.height-s,o=!1){const{data:l}=e,{width:c,height:h,data:u}=t,d=n/c,p=a/h,m=Math.ceil(d/2),_=Math.ceil(p/2),f=e.width;for(let e=0;e<h;e++)for(let t=0;t<c;t++){const n=4*(t+(o?h-e-1:e)*c);let a=0,g=0,y=0,v=0,b=0,w=0;const C=(e+.5)*p;for(let n=Math.floor(e*p);n<(e+1)*p;n++){const e=Math.abs(C-(n+.5))/_,o=(t+.5)*d,c=e*e;for(let e=Math.floor(t*d);e<(t+1)*d;e++){const t=Math.abs(o-(e+.5))/m,h=Math.sqrt(c+t*t);if(h>=1)continue;let u=2*h*h*h-3*h*h+1;const d=4*(r+e+(s+n)*f);w+=u*l[d+3],g+=u,!i&&l[d+3]<255&&(u=u*l[d+3]/255),y+=u*l[d],v+=u*l[d+1],b+=u*l[d+2],a+=u}}u[n]=y/a,u[n+1]=v/a,u[n+2]=b/a,u[n+3]=w/g}return t}function f(e,t,i){if(!t)return e;const{framebufferWidth:r,framebufferHeight:s,pixelRatio:n,region:a}=e,o=g(e,i),l=o.left+o.right,c=o.top+o.bottom,h=r-l,u=s-c,d=Math.min(8,Math.min((2048-l)/h,(2048-c)/u));return d<1.5?e:{...e,framebufferWidth:Math.round(h*d)+l,framebufferHeight:Math.round(u*d)+c,pixelRatio:n*d,resample:{region:{x:Math.round((a.x-o.left)*d)+o.left,y:Math.round((a.y-o.top)*d)+o.top,width:Math.round(a.width*d),height:Math.round(a.height*d)},width:r,height:s}}}function g(e,t){return!t||e?.ignorePadding?C:t}function y(e){switch(e){case"png":case"jpg":case"jpeg":return e;default:return b}}const v={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"},b="png",w={png:100,jpg:98,jpeg:98},C={top:0,right:0,bottom:0,left:0}},45391:function(e,t,i){i.d(t,{D:function(){return n}});var r=i(5052),s=i(56172);function n(e,t){return null!=e&&(null==t||(t===s.JY.Local?!e.isGeographic||e.isWGS84||e.wkid===r.W.CGCS2000:e.isWebMercator||e.isWGS84||e.wkid===r.W.CGCS2000||e.wkid===r.W.GCSMARS2000||e.wkid===r.W.GCSMARS2000_SPHERE||e.wkid===r.W.GCSMOON2000))}},31454:function(e,t,i){i.d(t,{X:function(){return d},d:function(){return _}});i(61432);var r=i(96711),s=i(61100),n=i(92761),a=i(13e3),o=i(65650),l=i(29870),c=i(54704);class h{constructor(e,t){this._context=e,this._descriptor=t,this.type=l.R.Renderbuffer,this._context.instanceCounter.increment(o._g.Renderbuffer,this);const i=this._context.gl;this.glName=i.createRenderbuffer(),this._context.bindRenderbuffer(this);const{width:r,height:s,internalFormat:n,multisampled:a}=t;a?i.renderbufferStorageMultisample(i.RENDERBUFFER,this.samples,n,r,s):i.renderbufferStorage(i.RENDERBUFFER,n,r,s),this._context.bindRenderbuffer(null)}get descriptor(){return this._descriptor}get samples(){const e=this._descriptor.samples,t=this._context.parameters.maxSamples;return e?Math.min(e,t):t}get usedMemory(){return(0,c.G)(this._descriptor)}resize(e,t){const i=this._descriptor;if(i.width===e&&i.height===t)return;i.width=e,i.height=t;const r=this._context.gl;this._context.bindRenderbuffer(this),i.multisampled?r.renderbufferStorageMultisample(r.RENDERBUFFER,this.samples,i.internalFormat,i.width,i.height):r.renderbufferStorage(r.RENDERBUFFER,i.internalFormat,i.width,i.height),this._context.bindRenderbuffer(null)}dispose(){this._context&&(this._context.gl.deleteRenderbuffer(this.glName),this._context.instanceCounter.decrement(o._g.Renderbuffer,this),this._context=null)}}var u=i(8158);class d{constructor(e,t,i){if(this._context=e,this._glName=null,this._colorAttachments=new Map,this._depthStencilBuffer=null,this._depthStencilTexture=null,this._initialized=!1,e.instanceCounter.increment(o._g.FramebufferObject,this),null!=t){const i=p(t)?t:new u.x(e,t);this._colorAttachments.set(o.Ii,i),this._validateTextureDescriptor(i.descriptor),this._validateColorAttachmentPoint(o.Ii)}if(null!=i)if(function(e){return p(e)||function(e){return m(e)===l.R.TextureDescriptor}(e)}(i))this._depthStencilTexture=p(i)?i:new u.x(e,i),this._validateTextureDescriptor(this._depthStencilTexture.descriptor);else{const t=function(e){return m(e)===l.R.Renderbuffer}(i)?i:new h(e,i);this._depthStencilBuffer=t,this._validateRenderbufferDescriptor(t.descriptor)}}dispose(){const{_colorAttachments:e,_glName:t}=this;if(0===e.size&&!this._depthStencilBuffer&&!this._depthStencilTexture&&!t)return;const{_context:i}=this,r=i.getBoundFramebufferObject();e.forEach(((e,t)=>this.detachColorTexture(t)?.dispose())),this.detachDepthStencilBuffer()?.dispose(),this.detachDepthStencilTexture()?.dispose(),i.gl.deleteFramebuffer(t),this._glName=null,i.bindFramebuffer(r===this?null:r),i.instanceCounter.decrement(o._g.FramebufferObject,this)}get glName(){return this._glName}get colorTexture(){return this._colorAttachments.get(o.Ii)}get depthStencil(){return this._depthStencilTexture||this._depthStencilBuffer}get depthStencilTexture(){return this._depthStencilTexture}get width(){return(this._colorAttachments.get(o.Ii)??this._depthStencilTexture??this._depthStencilBuffer)?.descriptor?.width??0}get height(){return(this._colorAttachments.get(o.Ii)??this._depthStencilTexture??this._depthStencilBuffer)?.descriptor?.height??0}get usedMemory(){return[...this._colorAttachments].reduce(((e,[t,i])=>e+i.usedMemory),this.depthStencil?.usedMemory??0)}static{this._MAX_COLOR_ATTACHMENTS=-1}getColorTexture(e){const t=this._colorAttachments.get(e);return t&&p(t)?t:null}get colorAttachments(){return[...this._colorAttachments.keys()]}attachColorTexture(e,t=o.Ii){if(!e)return;this._validateColorAttachmentPoint(t);const{descriptor:i}=e;this._validateTextureDescriptor(i),this.detachColorTexture(t)?.dispose(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(e.glName,t)),this._colorAttachments.set(t,e)}detachColorTexture(e=o.Ii){const t=this._colorAttachments.get(e);if(t)return this._initialized&&this._context.temporaryBindFramebufferObject(this,(()=>{this._framebufferTexture2D(null,e)})),this._colorAttachments.delete(e),t}setColorTextureTarget(e,t=o.Ii,i=0){const r=this._colorAttachments.get(t);r&&(e===o.No.TEXTURE_2D_ARRAY?this._framebufferTextureLayer(r.glName,t,o.qi.FRAMEBUFFER,0,i):this._framebufferTexture2D(r.glName,t,e,o.qi.FRAMEBUFFER,0))}attachDepthStencil(e){if(e)switch(e.type){case l.R.Texture:return this._attachDepthStencilTexture(e);case l.R.Renderbuffer:return this._attachDepthStencilBuffer(e)}}_attachDepthStencilTexture(e){if(null==e)return;const{descriptor:t}=e,{pixelFormat:i,dataType:r}=t;i===o.N2.DEPTH_STENCIL||i===o.N2.DEPTH_COMPONENT?i!==o.N2.DEPTH_STENCIL||r===o.Br.UNSIGNED_INT_24_8?i!==o.N2.DEPTH_COMPONENT||r===o.Br.UNSIGNED_INT||r===o.Br.UNSIGNED_SHORT?(this._validateTextureDescriptor(t),this._disposeDepthStencilAttachments(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(e.glName,g(i))),this._depthStencilTexture?.dispose(),this._depthStencilTexture=e):console.error("Depth texture must have data type of UNSIGNED_INT or UNSIGNED_SHORT!"):console.error("Depth/Stencil texture must have data type of UNSIGNED_INT_24_8!"):console.error("Depth/Stencil texture must have a pixel type of DEPTH_STENCIL!")}detachDepthStencilTexture(){const e=this._depthStencilTexture;return e&&this._initialized&&this._context.temporaryBindFramebufferObject(this,(()=>{this._framebufferTexture2D(null,g(e.descriptor.pixelFormat))})),this._depthStencilTexture=null,e}_attachDepthStencilBuffer(e){if(null==e)return;const t=e.descriptor;if(this._validateRenderbufferDescriptor(t),this._disposeDepthStencilAttachments(),this._initialized){this._context.bindFramebuffer(this);const{gl:i}=this._context,r=this._getGLAttachmentPoint(t);i.framebufferRenderbuffer(o.qi.FRAMEBUFFER,r,i.RENDERBUFFER,e.glName)}this._depthStencilBuffer=e}detachDepthStencilBuffer(){const e=this._depthStencilBuffer;if(e&&this._initialized){const{_context:t}=this,i=t.getBoundFramebufferObject();t.bindFramebuffer(this);const{gl:r}=t,s=this._getGLAttachmentPoint(e.descriptor);r.framebufferRenderbuffer(o.qi.FRAMEBUFFER,s,r.RENDERBUFFER,null),t.bindFramebuffer(i)}return this._depthStencilBuffer=null,e}invalidateAttachments(e){const{_context:t}=this;t.temporaryBindFramebufferObject(this,(()=>t.gl.invalidateFramebuffer(o.qi.FRAMEBUFFER,e)),!0)}copyToTexture(e,t,i,r,s,n,a){(e<0||t<0||s<0||n<0)&&console.error("Offsets cannot be negative!"),(i<=0||r<=0)&&console.error("Copy width and height must be greater than zero!");const l=a.descriptor;a.descriptor.target!==o.No.TEXTURE_2D&&console.error("Texture target must be TEXTURE_2D!"),(null==l?.width||null==l?.height||e+i>this.width||t+r>this.height||s+i>l.width||n+r>l.height)&&console.error("Bad dimensions, the current input values will attempt to read or copy out of bounds!");const c=this._context,h=c.bindTexture(a,u.x.TEXTURE_UNIT_FOR_UPDATES);c.setActiveTexture(u.x.TEXTURE_UNIT_FOR_UPDATES),c.bindFramebuffer(this),c.gl.copyTexSubImage2D(o.No.TEXTURE_2D,0,s,n,e,t,i,r),c.bindTexture(h,u.x.TEXTURE_UNIT_FOR_UPDATES)}readPixels(e,t,i,r,s,n,a){(i<=0||r<=0)&&console.error("Copy width and height must be greater than zero!"),a||console.error("Target memory is not initialized!"),this._context.bindFramebuffer(this),this._context.gl.readPixels(e,t,i,r,s,n,a)}async readPixelsAsync(e,t,i,r,s,a,l){const{gl:c}=this._context,h=n.f.createPixelPack(this._context,o.l1.STREAM_READ,l.byteLength);this._context.bindBuffer(h);const u=this._context.getBoundFramebufferObject();this._context.bindFramebuffer(this),c.readPixels(e,t,i,r,s,a,0),this._context.unbindBuffer(o.w0.PIXEL_PACK_BUFFER),this._context.bindFramebuffer(u),await h.getSubDataAsync(l),h.dispose()}resize(e,t){if(this.width===e&&this.height===t)return;const i={width:e,height:t};_(i,this._context.parameters.maxTextureSize),this._colorAttachments.forEach((e=>e.resize(i.width,i.height))),this._depthStencilTexture?.resize(i.width,i.height),this._initialized&&(_(i,this._context.parameters.maxRenderbufferSize),this._depthStencilBuffer?.resize(i.width,i.height),this._context.getBoundFramebufferObject()===this&&this._context.bindFramebuffer(null),this._initialized=!1)}initializeAndBind(e=o.qi.FRAMEBUFFER){const{gl:t}=this._context;if(this._initialized)return void t.bindFramebuffer(e,this.glName);this._glName&&t.deleteFramebuffer(this._glName);const i=t.createFramebuffer();if(t.bindFramebuffer(e,i),this._colorAttachments.forEach(((t,i)=>{const r=f(t);r===o.No.TEXTURE_2D_ARRAY?this._framebufferTextureLayer(t.glName,i,e,0,0):this._framebufferTexture2D(t.glName,i,r,e)})),this._depthStencilBuffer){const i=this._getGLAttachmentPoint(this._depthStencilBuffer.descriptor);t.framebufferRenderbuffer(e,i,t.RENDERBUFFER,this._depthStencilBuffer.glName)}else if(this._depthStencilTexture){const t=g(this._depthStencilTexture.descriptor.pixelFormat);this._framebufferTexture2D(this._depthStencilTexture.glName,t,f(this._depthStencilTexture),e)}(0,a.hZ)()&&t.checkFramebufferStatus(e)!==t.FRAMEBUFFER_COMPLETE&&console.error("Framebuffer is incomplete!"),this._glName=i,this._initialized=!0}_framebufferTexture2D(e,t=o.Ii,i=o.No.TEXTURE_2D,r=o.qi.FRAMEBUFFER,s=0){this._context.gl.framebufferTexture2D(r,t,i,e,s)}_framebufferTextureLayer(e,t=o.Ii,i=o.qi.FRAMEBUFFER,r=0,s=0){this._context.gl.framebufferTextureLayer(i,t,e,r,s)}_disposeDepthStencilAttachments(){const e=this._context.gl;if(this._depthStencilBuffer){if(this._initialized){this._context.bindFramebuffer(this);const t=this._getGLAttachmentPoint(this._depthStencilBuffer.descriptor);e.framebufferRenderbuffer(o.qi.FRAMEBUFFER,t,e.RENDERBUFFER,null)}this._depthStencilBuffer=(0,s.M2)(this._depthStencilBuffer)}this._depthStencilTexture&&(this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,g(this._depthStencilTexture.descriptor.pixelFormat))),this._depthStencilTexture=(0,s.M2)(this._depthStencilTexture))}_validateTextureDescriptor(e){e.target!==o.No.TEXTURE_2D&&e.target!==o.No.TEXTURE_CUBE_MAP&&e.target!==o.No.TEXTURE_2D_ARRAY&&console.error("Texture type must be TEXTURE_2D, TEXTURE_2D_ARRAY or TEXTURE_CUBE_MAP!"),_(e,this._context.parameters.maxTextureSize),this._validateBufferDimensions(e)}_validateRenderbufferDescriptor(e){_(e,this._context.parameters.maxRenderbufferSize),this._validateBufferDimensions(e)}_validateBufferDimensions(e){e.width<=0&&(e.width=this.width),e.height<=0&&(e.height=this.height),this.width>0&&this.height>0&&(this.width===e.width&&this.height===e.height||console.error("Attachment size must match framebuffer size!"))}_getGLAttachmentPoint(e){switch(e.internalFormat){case o.DM.DEPTH_COMPONENT16:case o.DM.DEPTH_COMPONENT24:case o.DM.DEPTH_COMPONENT32F:return o._L;case o.wo.DEPTH24_STENCIL8:case o.wo.DEPTH32F_STENCIL8:return o.Lu;case o.YM.STENCIL_INDEX8:return o.sQ}}_validateColorAttachmentPoint(e){if(-1===d._MAX_COLOR_ATTACHMENTS){const{gl:e}=this._context;d._MAX_COLOR_ATTACHMENTS=e.getParameter(e.MAX_COLOR_ATTACHMENTS)}const t=e-o.Ii;t+1>d._MAX_COLOR_ATTACHMENTS&&r.Z.getLogger("esri.views.webgl.FrameBufferObject").error("esri.FrameBufferObject",`illegal attachment point for color attachment: ${t+1}. Implementation supports up to ${d._MAX_COLOR_ATTACHMENTS} color attachments`)}}function p(e){return m(e)===l.R.Texture}function m(e){return null!=e&&"type"in e?e.type:null}function _(e,t){const i=Math.max(e.width,e.height);if(i>t){r.Z.getLogger("esri.views.webgl.FramebufferObject").warnOnce(`Resizing FBO attachment size ${e.width}x${e.height} to device limit ${t}`);const s=t/i;return e.width=Math.round(e.width*s),e.height=Math.round(e.height*s),!1}return!0}function f(e){return e.descriptor.target===o.No.TEXTURE_CUBE_MAP?o.No.TEXTURE_CUBE_MAP_POSITIVE_X:e.descriptor.target===o.No.TEXTURE_2D_ARRAY?o.No.TEXTURE_2D_ARRAY:o.No.TEXTURE_2D}function g(e){return e===o.N2.DEPTH_COMPONENT?o._L:o.Lu}},54704:function(e,t,i){i.d(t,{G:function(){return n},Y:function(){return s}});var r=i(15483);class s{constructor(e,t=0,i=t){this.internalFormat=e,this.width=t,this.height=i,this.multisampled=!1,this.samples=1}}function n(e){return e.width<=0||e.height<=0||null==e.internalFormat?0:e.width*e.height*(0,r.RG)(e.internalFormat)}},79922:function(e,t,i){i.d(t,{H:function(){return o},b:function(){return l}});var r=i(88194),s=i(93568),n=i(18764),a=i(22679);async function o(e,t,i){const r=await c(e,t,i);await h(r,t,i)}async function l(e,t,i,r,s){const n=await c(i,r,s);await e.update({data:t}),await h(n,r,s)}async function c(e,t,o){if(!t?.resources)return;const l=t.portalItem===e.portalItem?new Set(e.paths):new Set;e.paths.length=0,e.portalItem=t.portalItem;const c=new Set(t.resources.toKeep.map((e=>e.resource.path))),h=new Set,u=[];c.forEach((t=>{l.delete(t),e.paths.push(t)}));const d=[],p=[],m=[];for(const i of t.resources.toUpdate)if(l.delete(i.resource.path),c.has(i.resource.path)||h.has(i.resource.path)){const{resource:t,content:r,finish:s}=i,o=(0,a.W7)(t,(0,n.DO)());e.paths.push(o.path),d.push({resource:o,content:await(0,a.FO)(r),compress:i.compress}),s&&m.push((()=>s(o)))}else{e.paths.push(i.resource.path),p.push({resource:i.resource,content:await(0,a.FO)(i.content),compress:i.compress});const t=i.finish;t&&m.push((()=>t(i.resource))),h.add(i.resource.path)}for(const i of t.resources.toAdd)if(e.paths.push(i.resource.path),l.has(i.resource.path))l.delete(i.resource.path);else{d.push({resource:i.resource,content:await(0,a.FO)(i.content),compress:i.compress});const e=i.finish;e&&m.push((()=>e(i.resource)))}if(d.length||p.length){const{addOrUpdateResources:e}=await Promise.resolve().then(i.bind(i,22679));await e(t.portalItem,d,"add",o),await e(t.portalItem,p,"update",o)}if(m.forEach((e=>e())),0===u.length)return l;const _=await(0,s.UO)(u);if((0,s.k_)(o),_.length>0)throw new r.Z("save:resources","Failed to save one or more resources",{errors:_});return l}async function h(e,t,i){if(!e||!t.portalItem)return;const r=[];for(const s of e){const e=t.portalItem.resourceFromPath(s);r.push(e.portalItem.removeResource(e,i))}await(0,s.as)(r)}},68875:function(e,t,i){i.d(t,{Pl:function(){return s},zC:function(){return a}});var r=i(88194);i(75428);async function s(e){const t=[];for(const i of e.allLayers)if("beforeSave"in i&&"function"==typeof i.beforeSave){const e=i.beforeSave();e&&t.push(e)}await Promise.allSettled(t)}const n=new Set(["layer:unsupported","property:unsupported","symbol:unsupported","symbol-layer:unsupported","url:unsupported"]);function a(e,t,i){let s=(e.messages??[]).filter((({type:e})=>"error"===e)).map((({name:e,message:t,details:i})=>new r.Z(e,t,i)));if(e.blockedRelativeUrls&&(s=s.concat(e.blockedRelativeUrls.map((e=>new r.Z("url:unsupported",`Relative url '${e}' is not supported`))))),i){const{ignoreUnsupported:e,supplementalUnsupportedErrors:t=[],requiredPropertyChecksDisabled:r}=i;e&&(s=s.filter((({name:e})=>!(n.has(e)||t.includes(e))))),r&&(s=s.filter((e=>"web-document-write:property-required"!==e.name)))}if(s.length>0)throw new r.Z(t.errorName,"Failed to save due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:s})}},49675:function(e,t,i){i.d(t,{Nw:function(){return m}});var r=i(88194),s=i(28947),n=i(60123),a=i(42146),o=i(75428);const l=new Set(["bing-maps","imagery","imagery-tile","map-image","open-street-map","tile","unknown","unsupported","vector-tile","web-tile","wcs","wms","wmts"]),c=new Set(["catalog","csv","feature","geo-rss","geojson","group","imagery","imagery-tile","kml","knowledge-graph","map-image","map-notes","media","ogc-feature","oriented-imagery","route","stream","subtype-group","tile","unknown","unsupported","vector-tile","video","web-tile","wcs","wfs","wms","wmts"]),h=new Set([...c,"link-chart"]);function u(e,t){if(t.restrictedWebMapWriting){const i=function(e){switch(e.layerContainerType){case"basemap":return l;case"operational-layers":return"link-chart"===e.origin?h:c;default:return null}}(t);return null==i||i.has(e.type)&&!(0,o.rQ)(e)}return!0}function d(e,t){"maxScale"in e&&(t.maxScale=(0,a.k)(e.maxScale)??void 0),"minScale"in e&&(t.minScale=(0,a.k)(e.minScale)??void 0)}function p(e,t){if(function(e,t){if(t)if((0,o.rQ)(e)){const i=(0,n.hS)("featureCollection.layers",t)?.[0]?.layerDefinition;i&&d(e,i)}else"group"!==e.type&&d(e,t)}(e,t),t&&(t.id=e.id,"blendMode"in e&&(t.blendMode=e.blendMode,"normal"===t.blendMode&&delete t.blendMode),t.opacity=(0,a.k)(e.opacity)??void 0,t.title=e.title||"Layer",t.visibility=e.visible,"legendEnabled"in e&&"wmts"!==e.type))if((0,o.rQ)(e)){const i=t.featureCollection;i&&(i.showLegend=e.legendEnabled)}else t.showLegend=e.legendEnabled}function m(e,t,i){if(!e.persistenceEnabled)return null;if(!("write"in e)||!e.write)return i?.messages&&i.messages.push(new r.Z("layer:unsupported",`Layers (${e.title}, ${e.id}) of type '${e.declaredClass}' cannot be persisted`,{layer:e})),null;if((0,o.rQ)(e)&&!e.isTable)t=e.resourceInfo;else if(u(e,i)){const t={};return e.write(t,i)?t:null}return null!=t&&p(e,t=(0,s.d9)(t)),t}},96949:function(e,t,i){var r=i(64297),s=i(41309),n=i(90403),a=i(60508),o=i(73440),l=i(27172),c=i(43254),h=i(87286),u=i(88194),d=i(10729),p=i(50702),m=i(61432),_=i(96711),f=i(61100),g=i(93399),y=i(93568),v=i(99153),b=i(96094),w=i(26636),C=i(82592),x=i(17155),T=i(90775),S=(i(83850),i(48023)),M=i(95226),E=i(70880),R=i(66951),P=i(22018);function A(e,t){const i=(0,P.vw)(e),r=(0,P.vw)(t),s=i.store,n=r.store,a=r.metadata;for(const t in a){const i=a[t],r=s.originOf(t),o=n.originOf(t);if(!i.readOnly&&o!==R.s3.DEFAULTS)if(r===R.s3.DEFAULTS)e.set(t,n.get(t));else{const e=s.get(t),i=n.get(t);e&&i&&i instanceof E.Z&&e instanceof E.Z&&e instanceof i.constructor&&A(e,i)}}}var O=i(82846),D=i(34415),I=i(71354),L=i(86640),F=i(13132),N=i(45213),U=i(774),H=i(6961),V=i(47566),k=i(5226),B=i(4469),z=i(75428);let G=class extends D.a{constructor(e){super(e),this.addHandles(this.on("before-add",(e=>{null!=e.item&&e.item.parent===this.owner&&(_.Z.getLogger(this).warn("Analysis inside the collection must be unique. Not adding this element again."),e.preventDefault())})))}_own(e){e.parent=this.owner}_release(e){e.parent=null}};G=(0,o._)([(0,S.j)("esri.support.AnalysesCollection")],G);var q=i(72728),Z=i(82703);const j={widthBreakpoint:{getValue(e){const t=e.viewSize[0],i=e.breakpoints,r=this.values;return t<=i.xsmall?r.xsmall:t<=i.small?r.small:t<=i.medium?r.medium:t<=i.large?r.large:r.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-width-xsmall esri-view-width-less-than-small esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",small:"esri-view-width-small esri-view-width-greater-than-xsmall esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",medium:"esri-view-width-medium esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-less-than-large esri-view-width-less-than-xlarge",large:"esri-view-width-large esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-less-than-xlarge",xlarge:"esri-view-width-xlarge esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-greater-than-large"}},heightBreakpoint:{getValue(e){const t=e.viewSize[1],i=e.breakpoints,r=this.values;return t<=i.xsmall?r.xsmall:t<=i.small?r.small:t<=i.medium?r.medium:t<=i.large?r.large:r.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-height-xsmall esri-view-height-less-than-small esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",small:"esri-view-height-small esri-view-height-greater-than-xsmall esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",medium:"esri-view-height-medium esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-less-than-large esri-view-height-less-than-xlarge",large:"esri-view-height-large esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-less-than-xlarge",xlarge:"esri-view-height-xlarge esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-greater-than-large"}},orientation:{getValue(e){const t=e.viewSize,i=t[0],r=t[1],s=this.values;return r>=i?s.portrait:s.landscape},values:{portrait:"portrait",landscape:"landscape"},valueToClassName:{portrait:"esri-view-orientation-portrait",landscape:"esri-view-orientation-landscape"}}},W={xsmall:544,small:768,medium:992,large:1200};function $(e,t){return t?j[e].valueToClassName[t].split(" "):[]}const X=e=>{let t=class extends e{constructor(...e){super(...e),this.orientation=null,this.widthBreakpoint=null,this.heightBreakpoint=null,this.breakpoints=W}initialize(){this.addHandles((0,n.YP)((()=>[this.breakpoints,this.size]),(()=>this._updateClassNames()),n.nn))}destroy(){this.destroyed||this._removeActiveClassNames()}set breakpoints(e){if(e!==this._get("breakpoints")){if(!function(e){const t=e;return t&&t.xsmall<t.small&&t.small<t.medium&&t.medium<t.large}(e)){const t=JSON.stringify(W,null,2);console.warn("provided breakpoints are not valid, using defaults:"+t),e=W}this._set("breakpoints",{...e})}}_updateClassNames(){if(!this.container)return;const e=Z.Z.acquire(),t=Z.Z.acquire();let i,r=!1;for(i in j){const s=this[i],n=j[i].getValue({viewSize:this.size,breakpoints:this.breakpoints});s!==n&&(r=!0,this[i]=n,$(i,s).forEach((e=>t.push(e))),$(i,n).forEach((t=>e.push(t))))}r&&(this._applyClassNameChanges(e,t),Z.Z.release(e),Z.Z.release(t))}_applyClassNameChanges(e,t){const i=this.container;i&&(t.forEach((e=>i.classList.remove(e))),e.forEach((e=>i.classList.add(e))))}_removeActiveClassNames(){const e=this.container;if(!e)return;let t;for(t in j)$(t,this[t]).forEach((t=>e.classList.remove(t)))}};return(0,o._)([(0,x.Cb)()],t.prototype,"breakpoints",null),(0,o._)([(0,x.Cb)()],t.prototype,"orientation",void 0),(0,o._)([(0,x.Cb)()],t.prototype,"widthBreakpoint",void 0),(0,o._)([(0,x.Cb)()],t.prototype,"heightBreakpoint",void 0),t=(0,o._)([(0,S.j)("esri.views.BreakpointsOwner")],t),t};var Y=i(60147),Q=(i(45357),i(59143));let K=class extends E.Z{constructor(){super(...arguments),this.items=new c.Z,this._watchUpdatingTracking=new Y.R,this._callbacks=new Map,this._projector=(0,Q.E)(),this._hiddenProjector=(0,Q.E)()}get needsRender(){return this.items.length>0}get updating(){return this._watchUpdatingTracking?.updating??!1}initialize(){const e=document.createElement("div");e.className="esri-overlay-surface",this._set("surface",e),this._hiddenSurface=document.createElement("div"),this._hiddenSurface.setAttribute("style","visibility: hidden;"),e.appendChild(this._hiddenSurface),this._watchUpdatingTracking.addOnCollectionChange((()=>this.items),(e=>{for(const t of e.added){const e=()=>t.render();this._callbacks.set(t,e),this._projector.append(this.surface,e)}for(const t of e.removed){const e=this._projector.detach(this._callbacks.get(t));this.surface.removeChild(e.domNode),this._callbacks.delete(t)}}))}addItem(e){this.items.add(e)}removeItem(e){this.items.remove(e)}destroy(){this.items.removeAll(),this._callbacks.forEach((e=>this._projector.detach(e))),this._callbacks=null,this._projector=null,this._watchUpdatingTracking.destroy()}render(){this._projector.renderNow()}computeBoundingRect(e){const t=this._hiddenSurface,i=this._hiddenProjector;let r;const s=()=>(r=e.render(),r);i.append(t,s),i.renderNow();const n={left:0,top:0,right:0,bottom:0};if(r?.domNode){const e=r.domNode.getBoundingClientRect();n.left=e.left,n.top=e.top,n.right=e.right,n.bottom=e.bottom}for(i.detach(s);t.firstChild;)t.removeChild(t.firstChild);return n}overlaps(e,t){const i=this.computeBoundingRect(e),r=this.computeBoundingRect(t);return Math.max(i.left,r.left)<=Math.min(i.right,r.right)&&Math.max(i.top,r.top)<=Math.min(i.bottom,r.bottom)}get hasVisibleItems(){return this.items.some((e=>e.visible))}async prepare(){await document.fonts.load(this._fontString()).catch((()=>{}))}renderCanvas(e,t){const i=!!t?.disableDecorations;if(!this.items.some((e=>e.visible&&!(i&&e.isDecoration))))return;const r=e.getContext("2d");r.save(),r.font=this._fontString(),this.items.forEach((e=>{i&&e.isDecoration||(r.save(),e.renderCanvas(r),r.restore())})),r.restore()}_fontString(){return`10px ${getComputedStyle(this.surface).fontFamily}`}};(0,o._)([(0,x.Cb)({readOnly:!0})],K.prototype,"surface",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],K.prototype,"items",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],K.prototype,"needsRender",null),(0,o._)([(0,x.Cb)({readOnly:!0})],K.prototype,"_watchUpdatingTracking",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],K.prototype,"updating",null),K=(0,o._)([(0,S.j)("esri.views.overlay.ViewOverlay")],K);const J=K,ee=[0,0];function te(e){e&&(e.textContent="",e.parentNode&&e.parentNode.removeChild(e))}const ie=16,re=750,se=e=>{let t=class extends e{constructor(...e){super(...e),this._freqInfo={freq:ie,time:re},this._overlayRenderTaskHandle=null,this.height=0,this.messagesCommon=null,this.overlay=null,this.position=null,this.resizing=!1,this.root=null,this.surface=null,this.suspended=!0,this.userContent=null,this.width=0,this.widthBreakpoint=null,this.addHandles([(0,n.YP)((()=>this.cursor),(e=>{const{surface:t}=this;t&&t.setAttribute("data-cursor",e)})),(0,n.YP)((()=>this.navigating),(e=>{const{surface:t}=this;t&&t.setAttribute("data-navigating",e.toString())}))])}initialize(){this.addHandles([(0,n.YP)((()=>this.ui),((e,t)=>this._handleUIChange(e,t)),n.nn),this.on("focus",(()=>this.notifyChange("focused"))),this.on("blur",(()=>this.notifyChange("focused")))])}destroy(){this.destroyed||(this.ui?.destroy(),this.container=null)}get container(){return this._get("container")??null}set container(e){const t=this._get("container"),i=(0,h.L)(e);if(i||"string"!=typeof e||_.Z.getLogger(this).error("#container",`element with id '${e}' not found`),t===i)return;if(this._stopMeasuring(),t&&(t.classList.remove("esri-view"),this._overlayRenderTaskHandle&&(this._overlayRenderTaskHandle.remove(),this._overlayRenderTaskHandle=null),this.overlay&&(this.overlay.destroy(),this._set("overlay",null)),this.root&&(te(this.root),this._set("root",null)),this.userContent&&((0,h.Y)(this.userContent,t),te(this.userContent),this._set("userContent",null))),!i)return this._set("width",0),this._set("height",0),this._set("position",null),this._set("suspended",!0),this._set("surface",null),void this._set("container",null);i.classList.add("esri-view");const r=document.createElement("div");r.className="esri-view-user-storage",(0,h.Y)(i,r),i.appendChild(r),this._set("userContent",r);const s=document.createElement("div");s.className="esri-view-root",i.insertBefore(s,i.firstChild),this._set("root",s);const a=document.createElement("div");a.className="esri-view-surface",a.setAttribute("role","application"),a.tabIndex=0,s.appendChild(a),this._set("surface",a);const o=new J;s.appendChild(o.surface),this._set("overlay",o),this.addHandles((0,n.YP)((()=>o.needsRender),(e=>{e&&!this._overlayRenderTaskHandle?this._overlayRenderTaskHandle=(0,v.A)({render:()=>this.overlay?.render()}):this._overlayRenderTaskHandle=(0,f.hw)(this._overlayRenderTaskHandle)}))),this.forceDOMReadyCycle(),this._set("container",i),this._startMeasuring()}get focused(){const e=document.activeElement===this.surface;return document.hasFocus()&&e}get size(){return[this.width,this.height]}set ui(e){const t=this._get("ui");t!==e&&t?.destroy(),this._set("ui",e)}blur(){this.surface?.blur()}focus(){this.surface?.focus()}pageToContainer(e,t,i){const r=this.position;return e-=r?r[0]:0,t-=r?r[1]:0,i?(i[0]=e,i[1]=t):i=[e,t],i}containerToPage(e,t,i){const r=this.position;return e+=r?r[0]:0,t+=r?r[1]:0,i?(i[0]=e,i[1]=t):i=[e,t],i}_handleUIChange(e,t){this.removeHandles("ui"),t&&t!==e&&t.destroy(),e&&(e.view=this,this.addHandles((0,n.YP)((()=>this.root),(t=>{e.container=t?function(e){const t=document.createElement("div");return e.appendChild(t),t}(t):null}),n.nn),"ui")),this._set("ui",e)}_stopMeasuring(){this.removeHandles("measuring"),this._get("resizing")&&this._set("resizing",!1)}_startMeasuring(){const e=this._freqInfo;e.freq=ie,e.time=re;const t=(0,v.A)({prepare:e=>{const i=this._measure(),r=this._freqInfo;if(r.time+=e.deltaTime,i&&(r.freq=ie,this._get("resizing")||this._set("resizing",!0)),r.time<r.freq)return;r.time=0;const s=this._position();r.freq=s||i?ie:Math.min(re,2*r.freq),!i&&r.freq>=512&&(t.pause(),this._get("resizing")&&this._set("resizing",!1))}}),i=new ResizeObserver((i=>{e.freq=ie,e.time=re,t.resume()}));null!=this.container&&i.observe(this.container);const r=(0,p.kB)((()=>i.disconnect()));this.addHandles([(0,d.on)(window,"resize",(()=>{e.freq=ie,e.time=re,t.resume()})),r,t],"measuring"),this._measure(),this._position()}_measure(){const e=this.container,t=e?e.clientWidth:0,i=e?e.clientHeight:0;if(0===t||0===i)return this.suspended||this._set("suspended",!0),!1;const r=this.width,s=this.height;return t===r&&i===s?(this.suspended&&this._set("suspended",!1),!1):(this._set("width",t),this._set("height",i),this.suspended&&this._set("suspended",!1),this.emit("resize",{oldWidth:r,oldHeight:s,width:t,height:i}),!0)}_position(){const e=this.container,t=this.position,i=e&&function(e){const t=(e.ownerDocument||window.document).defaultView,i=e.getBoundingClientRect();return ee[0]=i.left+(t?.pageXOffset??0),ee[1]=i.top+(t?.pageYOffset??0),ee}(e);return!(!i||t&&i[0]===t[0]&&i[1]===t[1]||(this._set("position",[i[0],i[1]]),0))}forceDOMReadyCycle(){}};return(0,o._)([(0,x.Cb)()],t.prototype,"container",null),(0,o._)([(0,x.Cb)({readOnly:!0})],t.prototype,"focused",null),(0,o._)([(0,x.Cb)({readOnly:!0})],t.prototype,"height",void 0),(0,o._)([(0,x.Cb)()],t.prototype,"messagesCommon",void 0),(0,o._)([(0,x.Cb)({type:J})],t.prototype,"overlay",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],t.prototype,"position",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],t.prototype,"resizing",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],t.prototype,"root",void 0),(0,o._)([(0,x.Cb)({value:null,readOnly:!0})],t.prototype,"size",null),(0,o._)([(0,x.Cb)({readOnly:!0})],t.prototype,"surface",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],t.prototype,"suspended",void 0),(0,o._)([(0,x.Cb)({nonNullable:!0})],t.prototype,"ui",null),(0,o._)([(0,x.Cb)({readOnly:!0})],t.prototype,"userContent",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],t.prototype,"width",void 0),(0,o._)([(0,x.Cb)()],t.prototype,"widthBreakpoint",void 0),t=(0,o._)([(0,S.j)("esri.views.DOMContainer")],t),t};var ne=i(69892),ae=i(87833),oe=i(72347),le=i(62535),ce=i(61554);let he=class extends ae.Z.EventedAccessor{constructor(e){super(e),this.noDataValue=ce.zl}initialize(){this.view.basemapTerrain.on("elevation-change",(()=>this.emit("changed",{})))}get demResolution(){return this.view.basemapTerrain.demResolution}get extent(){const e=this.view.basemapTerrain;if(null==e?.extent||null==e.spatialReference)return null;const t=(0,V.HH)(e.extent,e.spatialReference);return t.zmin=e.visibleElevationBounds.min,t.zmax=e.visibleElevationBounds.max,t}get spatialReference(){return this.view.basemapTerrain?.spatialReference??N.Z.WGS84}elevationAt(e,t){if(null==this.extent||!(0,oe.Kv)(this.extent,e,t)){const i=null!=this.extent?`${this.extent.xmin}, ${this.extent.ymin}, ${this.extent.xmax}, ${this.extent.ymax}`:null;return _.Z.getLogger(this).warn("#elevationAt()",`Point used to sample elevation (${e}, ${t}) is outside of the sampler extent (${i})`),this.noDataValue}return this.view.elevationProvider?.getElevation(e,t,0,this.spatialReference,"ground")??this.noDataValue}queryElevation(e){return(0,le.G$)(e.clone(),this)}};(0,o._)([(0,x.Cb)({readOnly:!0})],he.prototype,"demResolution",null),(0,o._)([(0,x.Cb)({readOnly:!0})],he.prototype,"extent",null),(0,o._)([(0,x.Cb)({readOnly:!0})],he.prototype,"noDataValue",void 0),(0,o._)([(0,x.Cb)()],he.prototype,"spatialReference",null),(0,o._)([(0,x.Cb)({constructOnly:!0})],he.prototype,"view",void 0),he=(0,o._)([(0,S.j)("esri.views.support.GroundViewElevationSampler")],he);const ue=he;let de=class extends E.Z{constructor(e){super(e),this.view=null,this.layerViews=new c.Z}initialize(){this.addHandles((0,n.gx)((()=>this.view?.map?.ground),(e=>e.load())))}destroy(){this._set("view",null);for(const e of this.layerViews)e.destroy();this.layerViews.length=0}get elevationSampler(){return"2d"!==this.view?.type&&this.view?.ready&&this.view?.basemapTerrain?.ready?new ue({view:this.view}):null}get extent(){const e=this.view;return e&&"2d"!==e.type&&e.ready?(0,ne.HH)(e,e.state.camera,e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation):null}get updating(){return!this.suspended&&this.layerViews.some((e=>e.updating))}get suspended(){return this.view?.suspended??!0}};(0,o._)([(0,x.Cb)({readOnly:!0})],de.prototype,"elevationSampler",null),(0,o._)([(0,x.Cb)({readOnly:!0})],de.prototype,"extent",null),(0,o._)([(0,x.Cb)({type:Boolean,readOnly:!0})],de.prototype,"updating",null),(0,o._)([(0,x.Cb)({constructOnly:!0})],de.prototype,"view",void 0),(0,o._)([(0,x.Cb)({type:c.Z,readOnly:!0})],de.prototype,"layerViews",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],de.prototype,"suspended",null),de=(0,o._)([(0,S.j)("esri.views.GroundView")],de);const pe=de;var me=i(29292),_e=i(96620);function fe(e){return null!=e&&"open"in e&&"declaredClass"in e}function ge(e){return null!=e&&"declaredClass"in e&&"dockOptions"in e}const ye=e=>{let t=class extends e{constructor(){super(...arguments),this._popupSetupTask=null,this.popup={},this.popupEnabled=!0}initialize(){this.addHandles([(0,n.YP)((()=>[this.ui,this.popup]),(([e,t],i)=>{const r="popup";if(i){const[e,s]=i;e&&fe(s)&&(s.view=null,ge(s)&&(e.remove(s,r),s!==t&&t&&s.destroy()))}e&&fe(t)&&(t.view=this,ge(t)&&e.add(t,{key:r,position:"manual",internal:!0}))}),n.tX),this.on("click",(e=>{this.popup&&this.popupEnabled&&("mouse"!==e.pointerType||0===e.button)&&(fe(this.popup)?this.popup.viewModel.handleViewClick(e):e.defer((async()=>{await this.setupPopup(),fe(this.popup)&&!this.destroyed&&this.ready&&this.popupEnabled&&this.popup.viewModel.handleViewClick(e)})))}),_e.f.WIDGET)]),(0,n.N1)((()=>this.ready&&this.popupEnabled&&!this.updating)).then((()=>{Promise.all([i.e(85330),i.e(55105),i.e(88792),i.e(60541),i.e(98733),i.e(96526),i.e(40993),i.e(30903),i.e(49405),i.e(59876),i.e(86035),i.e(62040),i.e(60180)]).then(i.bind(i,36624))}))}destroy(){this.destroyed||this.closePopup()}async openPopup(e){if(fe(this.popup))return this.popup.open(e);try{if(await this.setupPopup(),!this.popup)return void _.Z.getLogger(this).error(new u.Z("view:null-popup","Popup is null and can't be opened"));this.popup.open(e)}catch{}}closePopup(){this._popupSetupTask?.abort(),fe(this.popup)&&this.popup.close()}async fetchPopupFeatures(e,t){return await this.when(),this._popupHitsToFeatures(await this._getPopupHits(e,t),t)}async setupPopup(){if(this._popupSetupTask?.abort(),this.popup&&!fe(this.popup))return this._popupSetupTask=(0,me.vr)((async e=>{const{default:t}=await Promise.all([i.e(85330),i.e(55105),i.e(88792),i.e(60541),i.e(98733),i.e(96526),i.e(40993),i.e(30903),i.e(49405),i.e(59876),i.e(86035),i.e(62040),i.e(60180)]).then(i.bind(i,36624));if((0,y.k_)(e),!this.popup||fe(this.popup))return;const r=this.popup;delete r.open,delete r.close,this.popup=new t(r)})),this._popupSetupTask.promise}async _popupHitsToFeatures({location:e,hits:t},i){const r=[],s=[];let n=!1;const a=(0,y.CH)(i,(0,m.Z)("popup-view-fetch-timeout")??be),o=e=>{const t=s.at(-1);return t&&t.layerView===e&&!n?t:(e=>{const t=new ve(e);return s.push(t),r.push(t.promise),t})(e)};for(const e of t)"graphic"in e?(o(e.layerView).graphics.push(e.graphic),n=!1):(r.push(e.layerView.fetchPopupFeaturesAtLocation(e.mapPoint,a)),n=!0);s.map((e=>e.resolve(a)));const l=(0,y.OT)(r).then((e=>e.filter((e=>!!e)).flat()));return{pendingFeatures:r,allGraphicsPromise:l,location:e}}async _getPopupHits(e,t){const{hits:i,location:r}=await this.popupHitTest(e);(0,y.k_)(t);const s=[];for(const e of i)if("graphic"in e){if(this._isValidPopupGraphic(e.graphic,t)){const t=this._isValidPopupGraphicsLayerView(e.layerView)?e.layerView:void 0;s.push({graphic:e.graphic,layerView:t})}}else this._isValidPopupLocationLayerView(e.layerView)&&s.push({mapPoint:e.mapPoint,layerView:e.layerView});return{hits:s,location:r}}_isValidPopupGraphic(e,t){return e&&!!e.getEffectivePopupTemplate(t?.defaultPopupTemplateEnabled)}_isValidPopupGraphicsLayerView(e){return!e||(!("layer"in e)||!e.suspended)&&"fetchPopupFeaturesFromGraphics"in e}_isValidPopupLocationLayerView(e){return(!("layer"in e)||!e.suspended)&&"fetchPopupFeaturesAtLocation"in e}};return(0,o._)([(0,x.Cb)()],t.prototype,"popup",void 0),(0,o._)([(0,x.Cb)()],t.prototype,"popupEnabled",void 0),t=(0,o._)([(0,S.j)("esri.views.PopupView")],t),t};class ve{constructor(e){this.layerView=e,this._resolver=(0,y.hh)(),this.graphics=[]}get promise(){return this._resolver.promise}resolve(e){const{layerView:t,graphics:i,_resolver:r}=this;if(!t)return r.resolve(i),r.promise;let s;return t.fetchPopupFeaturesFromGraphics(i,e).catch((e=>(s=e,null))).then((e=>{e?r.resolve(e):r.reject(s)})),r.promise}}const be=5e3;var we,Ce=i(93762),xe=i(53147),Te=i(41145),Se=i(79487),Me=i(63255),Ee=i(28947),Re=i(97006),Pe=i(332),Ae=i(29884),Oe=i(79775);let De=we=class extends Me.Z{constructor(e){super(e),this.type="none"}clone(){return new we({type:this.type})}};(0,o._)([(0,Oe.J)({none:"none",stayAbove:"stay-above"}),(0,x.Cb)({json:{write:{isRequired:!0}}})],De.prototype,"type",void 0),De=we=(0,o._)([(0,S.j)("esri.ground.NavigationConstraint")],De);const Ie=Symbol("GroundInstance");var Le,Fe,Ne=i(20712);let Ue=Fe=class extends(Me.Z.JSONSupportMixin(Re.Z)){static{Le=Ie}constructor(e){super(e),this[Le]=!0,this.opacity=1,this.surfaceColor=null,this.navigationConstraint=null,this.layers=new c.Z;const t=e=>{e.parent&&e.parent!==this&&"remove"in e.parent&&e.parent.remove(e),e.parent=this,"elevation"!==e.type&&"base-elevation"!==e.type&&_.Z.getLogger(this).error(`Layer '${e.title}, id:${e.id}' of type '${e.type}' is not supported as a ground layer and will therefore be ignored. Only layers of type 'elevation' are supported.`)};this.addHandles([this.layers.on("after-add",(e=>t(e.item))),this.layers.on("after-remove",(e=>(e=>{e.parent=null})(e.item)))])}initialize(){this.when().catch((e=>{(0,y.D_)(e)||_.Z.getLogger(this).error("#load()","Failed to load ground",e)})),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)}destroy(){const e=this.layers.removeAll();for(const t of e)(0,f.SC)(t);this.layers.destroy()}normalizeCtorArgs(e){return e&&"resourceInfo"in e&&(this._set("resourceInfo",e.resourceInfo),delete(e={...e}).resourceInfo),e}get layers(){return this._get("layers")}set layers(e){this._set("layers",(0,Te.Z)(e,this._get("layers")))}writeLayers(e,t,i,r){const s=[];e?(r={...r,layerContainerType:"ground"},e.forEach((e=>{if("write"in e){const t={};(0,Se.sM)(e)().write(t,r)&&s.push(t)}else r?.messages&&r.messages.push(new u.Z("layer:unsupported",`Layers (${e.title}, ${e.id}) of type '${e.declaredClass}' cannot be persisted in the ground`,{layer:e}))})),t.layers=s):t.layers=s}load(e){return this.addResolvingPromise(this._loadFromSource(e)),Promise.resolve(this)}loadAll(){return(0,Pe.G)(this,(e=>{e(this.layers)}))}async queryElevation(e,t){await this.load({signal:t?.signal});const{ElevationQuery:r}=await i.e(38308).then(i.bind(i,58086));(0,y.k_)(t);const s=new r,n=this.layers.filter(He).toArray();return s.queryAll(n,e,t)}async createElevationSampler(e,t){await this.load({signal:t?.signal});const{ElevationQuery:r}=await i.e(38308).then(i.bind(i,58086));(0,y.k_)(t);const s=new r,n=this.layers.filter(He).toArray();return s.createSamplerAll(n,e,t)}clone(){const e={opacity:this.opacity,surfaceColor:(0,Ee.d9)(this.surfaceColor),navigationConstraint:(0,Ee.d9)(this.navigationConstraint),layers:this.layers.slice()};return this.loaded&&(e.loadStatus="loaded"),new Fe({resourceInfo:this.resourceInfo}).set(e)}read(e,t){this.resourceInfo||this._set("resourceInfo",{data:e,context:t}),super.read(e,t)}_loadFromSource(e){const t=this.resourceInfo;return t?this._loadLayersFromJSON(t.data,t.context,e):Promise.resolve()}async _loadLayersFromJSON(e,t,r){const s=t?.origin||"web-scene",n=t?.portal||null,a=t?.url||null,{populateOperationalLayers:o}=await i.e(13259).then(i.bind(i,13259));(0,y.k_)(r);const l=[];if(e.layers&&Array.isArray(e.layers)){const t={context:{origin:s,url:a,portal:n,layerContainerType:"ground"},defaultLayerType:"ArcGISTiledElevationServiceLayer"};l.push(o(this.layers,e.layers,t))}await Promise.allSettled(l)}};function He(e){return"elevation"===e.type||function(e){return e&&"createElevationSampler"in e}(e)}(0,o._)([(0,x.Cb)({json:{read:!1,write:{isRequired:!0}}})],Ue.prototype,"layers",null),(0,o._)([(0,Ae.c)("layers")],Ue.prototype,"writeLayers",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Ue.prototype,"resourceInfo",void 0),(0,o._)([(0,x.Cb)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{type:M.z8,read:{reader:Ne.b,source:"transparency"},write:{writer:(e,t)=>{t.transparency=(0,Ne.a)(e)},target:"transparency"}}})],Ue.prototype,"opacity",void 0),(0,o._)([(0,x.Cb)({type:xe.Z,json:{type:[M.z8],write:(e,t)=>{t.surfaceColor=e.toJSON().slice(0,3)}}})],Ue.prototype,"surfaceColor",void 0),(0,o._)([(0,x.Cb)({type:De,json:{write:!0}})],Ue.prototype,"navigationConstraint",void 0),Ue=Fe=(0,o._)([(0,S.j)("esri.Ground")],Ue);const Ve=Ue;var ke=i(63727),Be=i(89314),ze=i(78619),Ge=i(18764),qe=i(1194),Ze=i(75432);let je=class extends(Be.Z.ClonableMixin(Me.Z)){constructor(e){super(e),this.color=null}};(0,o._)([(0,x.Cb)({type:xe.Z,json:{type:[M.z8],write:!0}})],je.prototype,"color",void 0),je=(0,o._)([(0,S.j)("esri.effects.FocusAreaOutline")],je);const We=je;var $e=i(35857),Xe=i(28938);let Ye=class extends(Me.Z.JSONSupportMixin(Be.Z)){constructor(e){super(e),this.id=`focusarea-${(0,Ge.DO)()}`,this.title=null,this.enabled=!0,this.outline=null,this.geometries=new $e.Z}readGeometries(e,t,i){Array.isArray(e)?this.geometries=$e.Z.fromJSON(e,i):i.hooks?.onAfterLoad?.((()=>this._loadGeometries((0,Xe.f)(e,i),i)))}async _loadGeometries(e,t){const i=await(0,ze.Z)(e,{responseType:"json"});this.geometries=$e.Z.fromJSON(i.data,t)}};(0,o._)([(0,x.Cb)({type:String,nonNullable:!0,json:{write:!0,origins:{"web-scene":{write:{isRequired:!0}}}}}),(0,x.Cb)()],Ye.prototype,"id",void 0),(0,o._)([(0,x.Cb)({type:String,json:{write:!0}})],Ye.prototype,"title",void 0),(0,o._)([(0,x.Cb)({type:Boolean,nonNullable:!0,json:{write:!0,origins:{"web-scene":{write:{isRequired:!0}}}}})],Ye.prototype,"enabled",void 0),(0,o._)([(0,x.Cb)({type:We,json:{write:!0}})],Ye.prototype,"outline",void 0),(0,o._)([(0,x.Cb)({type:$e.Z,nonNullable:!0,json:{write:!0,origins:{"web-scene":{write:{isRequired:!0}}}},clonable:e=>new $e.Z(e.items.map((e=>e.clone())))}),(0,Ze.B)({origins:["web-scene","portal-item"],type:"resource",prefix:"geometries",contentAddressed:!0})],Ye.prototype,"geometries",void 0),(0,o._)([(0,qe.r)(["web-scene","portal-item"],"geometries")],Ye.prototype,"readGeometries",null),Ye=(0,o._)([(0,S.j)("esri.effects.FocusArea")],Ye);const Qe=Ye;let Ke=class extends(Me.Z.JSONSupportMixin(Be.Z)){constructor(e){super(e),this.areas=new c.Z,this.style="bright"}};(0,o._)([(0,x.Cb)({type:c.Z.ofType(Qe),nonNullable:!0,json:{write:!0,origins:{"web-scene":{write:{isRequired:!0}}}},clonable:e=>new c.Z(e.items.map((e=>e.clone())))})],Ke.prototype,"areas",void 0),(0,o._)([(0,x.Cb)({type:["bright","dark"],nonNullable:!0,json:{write:!0}})],Ke.prototype,"style",void 0),Ke=(0,o._)([(0,S.j)("esri.effects.FocusAreas")],Ke);const Je=Ke;var et=i(82114);function tt(e){return!(!function(e){return"object"==typeof e&&null!=e&&"loaded"in e&&!0===e.loaded&&"type"in e}(e)||!(0,z.S1)(e)?.operations?.supportsEditing||"editingEnabled"in e&&!(0,z.ln)(e)||(0,et.xu)(e))}var it=i(82674),rt=i(26334),st=i(18177);const nt=()=>_.Z.getLogger("esri.support.basemapUtils");function at(e,t){let i;if("string"==typeof e){const r=e in rt.s,s=!r&&e.includes("/");if(!r&&!s){if((0,it.iU)())nt().warn(`Unable to find basemap definition for: ${e}. See available styles at https://developers.arcgis.com/rest/basemap-styles/`);else{const t=Object.entries(rt.s).filter((([e,t])=>t.classic||t.is3d)).map((([e])=>`"${e}"`)).sort().join(", ");nt().warn(`Unable to find basemap definition for: ${e}. Try one of these: ${t}`)}return null}t&&(i=t[e]),i||(i=r?Ce.default.fromId(e):new Ce.default({style:{id:e}}),t&&(t[e]=i))}else i=(0,M.se)(Ce.default,e);return i?.destroyed&&(nt().warn("The provided basemap is already destroyed",{basemap:i}),i=null),i}function ot(e,t){const i=new c.Z;return e.forEach((e=>{const r=t.find((t=>"scene"!==t.type&&(0,st.RH)((0,st.zw)(e),(0,st.zw)(t))))||e;i.includes(r)?i.push(e):i.push(r)})),i}var lt=i(76277);const ct={"world-elevation":{id:"worldElevation",url:"//elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/Terrain3D/ImageServer",layerType:"ArcGISTiledElevationServiceLayer"},"world-topobathymetry":{id:"worldTopoBathymetry",url:"//elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/TopoBathy3D/ImageServer",layerType:"ArcGISTiledElevationServiceLayer"}};var ht=i(83322),ut=i(33800);let dt=class extends((0,ut.Q)((0,ht.K)(ae.Z.EventedMixin(E.Z)))){constructor(e){super(e),this.allLayers=new ke.Z({getCollections:()=>[this.basemap?.baseLayers,this.ground?.layers,this.layers,this.basemap?.referenceLayers],getChildrenFunction:e=>"layers"in e?e.layers:null}),this.focusAreas=new Je,this.allTables=(0,lt.a)(this),this.basemap=null,this.editableLayers=new ke.Z({getCollections:()=>[this.allLayers],itemFilterFunction:tt}),this.ground=new Ve,this._basemapCache={}}destroy(){(function(e){for(const t in e){const i=e[t];(0,f.SC)(i),delete e[t]}})(this._basemapCache),this._basemapCache=null,this.focusAreas.destroy(),this.allLayers.destroy(),this.allTables.destroy(),this.editableLayers.destroy(),this.basemap=(0,f.SC)(this.basemap),(0,f.SC)(this.ground),this._set("ground",null)}castBasemap(e){return at(e,this._basemapCache)}castGround(e){const t=function(e){let t=null;"string"==typeof e?e in ct?t=new Ve({resourceInfo:{data:{layers:[ct[e]]}}}):_.Z.getLogger("esri.support.groundUtils").warn(`Unable to find ground definition for: ${e}. Try "world-elevation"`):t=(0,M.se)(Ve,e);return t}(e);return t??this._get("ground")}findLayerById(e){return this.allLayers.find((t=>t.id===e))}findTableById(e){return this.allTables.find((t=>t.id===e))}};(0,o._)([(0,x.Cb)({readOnly:!0,dependsOn:[]})],dt.prototype,"allLayers",void 0),(0,o._)([(0,x.Cb)({type:Je,nonNullable:!0,json:{write:{overridePolicy:e=>({enabled:e.areas.length>0,ignoreOrigin:!0})}}})],dt.prototype,"focusAreas",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],dt.prototype,"allTables",void 0),(0,o._)([(0,x.Cb)({type:Ce.default,json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],dt.prototype,"basemap",void 0),(0,o._)([(0,T.p)("basemap")],dt.prototype,"castBasemap",null),(0,o._)([(0,x.Cb)({readOnly:!0})],dt.prototype,"editableLayers",void 0),(0,o._)([(0,x.Cb)({type:Ve,nonNullable:!0})],dt.prototype,"ground",void 0),(0,o._)([(0,T.p)("ground")],dt.prototype,"castGround",null),(0,o._)([(0,x.Cb)()],dt.prototype,"undoRedo",void 0),dt=(0,o._)([(0,S.j)("esri.Map")],dt);const pt=dt;var mt=i(12818),_t=i(76329),ft=i(8554),gt=i(53866),yt=i(41801),vt=i(85913),bt=i(88097);let wt=class extends E.Z{constructor(e){super(e),this.view=null,this.baseLayerViews=new c.Z,this.referenceLayerViews=new c.Z,this._loadingHandle=(0,n.YP)((()=>this.view?.map?.basemap),(e=>{e&&e.load().catch((()=>{}))}),n.nn)}destroy(){this._set("view",null),this._loadingHandle&&(this._loadingHandle.remove(),this._loadingHandle=null);for(const e of this.baseLayerViews)e.destroy();this.baseLayerViews.length=0;for(const e of this.referenceLayerViews)e.destroy();this.referenceLayerViews.length=0}get suspended(){return this.view?.suspended??!0}get updating(){if(this.view?.suspended)return!1;const e=this.view?.map?.basemap;return!!e?.loaded&&(this.baseLayerViews.some((e=>e.updating))||this.referenceLayerViews.some((e=>e.updating)))}};(0,o._)([(0,x.Cb)({constructOnly:!0})],wt.prototype,"view",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],wt.prototype,"baseLayerViews",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],wt.prototype,"referenceLayerViews",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],wt.prototype,"suspended",null),(0,o._)([(0,x.Cb)({type:Boolean,readOnly:!0})],wt.prototype,"updating",null),wt=(0,o._)([(0,S.j)("esri.views.BasemapView")],wt);const Ct=wt;let xt=class extends E.Z{constructor(e){super(e),this.factor=1.5,this.offset=(0,b.vW)(0,0),this.position=null,this.size=120,this.maskUrl=null,this.maskEnabled=!0,this.overlayUrl=null,this.overlayEnabled=!0,this.visible=!0}get version(){return this.commitProperty("factor"),this.commitProperty("offset"),this.commitProperty("position"),this.commitProperty("visible"),this.commitProperty("size"),this.commitProperty("maskUrl"),this.commitProperty("maskEnabled"),this.commitProperty("overlayUrl"),this.commitProperty("overlayEnabled"),(this._get("version")||0)+1}};(0,o._)([(0,x.Cb)({type:Number})],xt.prototype,"factor",void 0),(0,o._)([(0,x.Cb)({nonNullable:!0})],xt.prototype,"offset",void 0),(0,o._)([(0,x.Cb)()],xt.prototype,"position",void 0),(0,o._)([(0,x.Cb)({type:Number,range:{min:0}})],xt.prototype,"size",void 0),(0,o._)([(0,x.Cb)()],xt.prototype,"maskUrl",void 0),(0,o._)([(0,x.Cb)()],xt.prototype,"maskEnabled",void 0),(0,o._)([(0,x.Cb)()],xt.prototype,"overlayUrl",void 0),(0,o._)([(0,x.Cb)()],xt.prototype,"overlayEnabled",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],xt.prototype,"version",null),(0,o._)([(0,x.Cb)({type:Boolean})],xt.prototype,"visible",void 0),xt=(0,o._)([(0,S.j)("esri.views.Magnifier")],xt);const Tt=xt;var St=i(3480),Mt=i(79577),Et=i(87422),Rt=i(74355),Pt=i(29191);function At(e){return!(null==e||"object"!=typeof e||!("createQuery"in e)||!e.createQuery)}let Ot=class extends ae.Z.EventedAccessor{constructor(e){super(e),this._selectionMap=new Et.Z,this._sources=new c.Z,this._trashCan=[],this._layerEditHandles=new c.Z,this._vizTaskId=0,this.view=null,this.showHighlight=!0,this.highlightName="default"}initialize(){this.addHandles([(0,n.YP)((()=>[this.view,this.showHighlight]),(()=>this._refreshVisualization())),(0,n.YP)((()=>this.view),(e=>{e?.when().then((()=>this.syncSources()))}),n.nn),(0,n.on)((()=>this.sources),"change",(e=>{const t=this._selectionMap,i=[];for(const r of e.removed){const e=t.get(r);e&&(t.delete(r),e.highlightHandle?.remove(),i.push({layer:r,selection:[],added:[],removed:[...e.selection]}))}this._refreshListeners(),i.length&&this._onSelectionChange(i)}),{onListenerAdd:()=>this._refreshListeners()})])}destroy(){this.clear(),this._layerEditHandles.drain(f.hw)}get selections(){return Array.from(this._selectionMap.entries()).map((e=>{const[t,i]=e;return{layer:t,selection:[...i.selection]}}))}get count(){let e=0;for(const t of this._selectionMap.values())e+=t.selection.length;return e}get hasSelection(){return this.count>0}get sources(){return this._sources}set sources(e){(0,Te.Z)(e,this._sources)}syncSources(){const e=new Set,t=this.view?.map;if(!t)return;const i=t=>{(0,z.Q2)(t)?(t.layers?.forEach(i),t.tables?.forEach(i)):(0,z.rC)(t)?(t.sublayers?.forEach(i),t.subtables?.forEach(i)):(0,z.e9)(t)?t.sublayers?.forEach(i):At(t)&&e.add(t)};t.allLayers.forEach(i),t.allTables.forEach(i),this.sources=[...e]}async getSelectedFeatures(e,t={},i="layerView"){const{view:r,selections:s}=this;if(!r&&"layerView"===i)return _.Z.getLogger(this).warn("Cannot query layer views without a view."),[];const n=e?.length?s.filter((t=>e.includes(t.layer))):s,a=[];return n.forEach((async e=>{const{layer:s,selection:n}=e;if(!n.length)return;const o=(0,z.Hd)(s)?s.parent:s;if(null==o)return;if("layer"===i)return void a.push(Ft(o,n,t));if(Dt(o)||!r||!It(o))return;const l=await r.whenLayerView(o).catch((()=>null));l&&a.push(Ft(l,n,t))})),(await Promise.all(a)).filter((e=>null!=e))}updateSelection(e){const t=new Map;for(const[e,i]of this._selectionMap)t.set(e,[...i.selection]);let i=!1;const r=e.current.concat(e.added);for(const e of r){const r=e.sourceLayer,s=e.getObjectId();if(this.sources.includes(r)&&(At(r)||(0,z.Hd)(r))&&null!==s){const e=(0,Mt.s1)(t,r,(()=>[]));e.includes(s)||(e.push(s),i=!0)}}for(const r of e.removed){const e=r.sourceLayer,s=r.getObjectId();if(this.sources.includes(e)&&(At(e)||(0,z.Hd)(e))&&null!==s){const r=t.get(e),n=r?.indexOf(s);void 0!==n&&n>=0&&(r?.splice(n,1),i=!0)}}if(i){const{_selectionMap:e,_trashCan:i}=this,r=[];for(const[s,n]of t){const t=e.get(s);void 0!==t&&i.push(t),e.set(s,{selection:n}),r.push({layer:s,selection:n,...(0,St.e5)(void 0!==t?t.selection:[],n)})}this._onSelectionChange(r)}}setSelection(e,t){this._setSelection(e,t)}getSelection(e){return this._selectionMap.get(e)?.selection}appendToSelection(e,t){const i=this._selectionMap.get(e),r=void 0!==i?[...i.selection]:[];for(const e of t)r.includes(e)||r.push(e);this._setSelection(e,r)}removeFromSelection(e,t){const i=this._selectionMap.get(e);if(!i)return;const r=[];for(const e of i.selection)t.includes(e)||r.push(e);this._setSelection(e,r)}toggleInSelection(e,t){const i=this._selectionMap.get(e);if(!i||0===i.selection.length)return void this._setSelection(e,t);const r=new Set(i.selection),s=new Set(t),n=(0,Rt.Sp)(r,s);this._setSelection(e,Array.from(n))}clear(){const e=this._selectionMap.values();this._trashCan.push(...e);const t=[];for(const[e,i]of this._selectionMap.entries())t.push({layer:e,added:[],removed:[...i.selection],selection:[]});this._selectionMap.clear(),this._onSelectionChange(t)}_onSelectionChange(e){this._refreshVisualization(),this.emit("selection-change",{view:this.view,changes:e})}_refreshVisualization(){for(this._vizTaskId++;this._trashCan.length>0;){this._trashCan.pop()?.highlightHandle?.remove()}if(null==this.view)return;const{sources:e,view:t,_selectionMap:i,showHighlight:r}=this,s=this._vizTaskId;for(const n of e){const e=i.get(n),a=(0,z.Hd)(n)?n.parent:n;if(null!=a&&It(a)){if(Dt(a))continue;t.whenLayerView(a).then((t=>{e?.highlightHandle?.remove(),null!=e&&r&&s===this._vizTaskId&&"highlight"in t&&"function"==typeof t.highlight&&e.selection.length>0&&(e.highlightHandle=t.highlight(e.selection,this.highlightName))})).catch((()=>{e?.highlightHandle?.remove()}))}}}_refreshListeners(){this._layerEditHandles.drain(f.hw);const e=new Set(this.sources.map((e=>(0,z.Hd)(e)?e.parent:e)));for(const t of e)At(t)&&"on"in t&&t.on&&this._layerEditHandles.push(t.on("edits",(e=>this._onLayerEdit(e,t))))}_onLayerEdit(e,t){if((0,z.e9)(t))this._onParentLayerEdit(e,t);else if(e.deletedFeatures.length&&this._selectionMap.has(t)){const i=[];e.deletedFeatures.forEach((({error:e,objectId:t})=>{null!=t&&null==e&&i.push(t)})),this.removeFromSelection(t,i)}}_onParentLayerEdit(e,t){const{deletedFeatures:i,edits:r,updatedFeatures:s}=e;if(r?.updateFeatures?.forEach((e=>{const i=e.getObjectId()??e.attributes[t.objectIdField];if(null==i)return;if(s.find((e=>e.objectId===i))?.error)return;const r=t.findSublayerForFeature(e);if(!At(r))return;const n=t.sublayers.find((e=>!(!At(e)||!this.getSelection(e)?.includes(i))));At(n)&&n!==r&&(this.removeFromSelection(n,[i]),this.appendToSelection(r,[i]))})),i.length){const e=[];i.forEach((({error:t,objectId:i})=>{null!=i&&null==t&&e.push(i)})),t.sublayers.forEach((t=>{At(t)&&this._selectionMap.has(t)&&this.removeFromSelection(t,e)}))}}_setSelection(e,t){if(!this.sources.includes(e))throw new Error(`Cannot set selection on layer ${e.title} because it is not in 'sources'`);const i=this._selectionMap.get(e);if(void 0===i||!Lt(i,{selection:t})){void 0!==i&&this._trashCan.push(i),this._selectionMap.set(e,{selection:[...t]});const r={layer:e,selection:[...t],...(0,St.e5)(void 0!==i?i.selection:[],t)};this._onSelectionChange([r])}}};(0,o._)([(0,x.Cb)()],Ot.prototype,"_selectionMap",void 0),(0,o._)([(0,x.Cb)()],Ot.prototype,"_sources",void 0),(0,o._)([(0,x.Cb)({readOnly:!0,nonNullable:!0})],Ot.prototype,"selections",null),(0,o._)([(0,x.Cb)({readOnly:!0,nonNullable:!0})],Ot.prototype,"count",null),(0,o._)([(0,x.Cb)()],Ot.prototype,"view",void 0),(0,o._)([(0,x.Cb)({readOnly:!0,nonNullable:!0})],Ot.prototype,"hasSelection",null),(0,o._)([(0,x.Cb)()],Ot.prototype,"showHighlight",void 0),(0,o._)([(0,x.Cb)()],Ot.prototype,"sources",null),(0,o._)([(0,x.Cb)()],Ot.prototype,"highlightName",void 0),Ot=(0,o._)([(0,S.j)("esri.views.SelectionManager")],Ot);const Dt=e=>(0,z.Hd)(e)?!0===e.parent?.isTable:e.isTable,It=e=>void 0!==e?.when,Lt=(e,t)=>{if(null==e&&null==t)return!0;if(null!=e&&null==t||null==e&&null!=t)return!1;if(null!=e&&null!=t&&null!=e.selection&&null!=t.selection){const i=[...e.selection],r=[...t.selection];if(i.length!==r.length)return!1;i.sort(),r.sort();for(let e=0;e<i.length;e++)if(i[e]!==r[e])return!1}return!0},Ft=async(e,t,i={})=>{let r;if((e=>void 0!==e.layer)(e)){const s=e;r=void 0===s?null:await s.queryFeatures(new Pt.Z({...i,objectIds:t})).then((t=>({data:t,layer:e.layer})))}else{const s=e;r=void 0===s?null:await s.queryFeatures(new Pt.Z({...i,objectIds:t})).then((e=>({data:e,layer:s})))}return r},Nt=Ot;let Ut=class extends(Be.Z.ClonableMixin(E.Z)){constructor(e){super(e),this.accentColor=new xe.Z([255,127,0]),this.textColor=new xe.Z([255,255,255])}};(0,o._)([(0,x.Cb)({type:xe.Z,nonNullable:!0})],Ut.prototype,"accentColor",void 0),(0,o._)([(0,x.Cb)({type:xe.Z,nonNullable:!0})],Ut.prototype,"textColor",void 0),Ut=(0,o._)([(0,S.j)("esri.views.Theme")],Ut);const Ht=Ut;var Vt=i(26411),kt=i(26124),Bt=i(55541),zt=i(18753);function Gt(e){return[e.on("before-add",(t=>{const i=t.item;if(null==i||e.includes(i))return _.Z.getLogger("esri.views.interactive.interactiveToolUtils").warn("Tool is either already in the list of tools or tool is `null`. Not adding tool."),void t.preventDefault();i.onAdd()})),e.on("after-remove",(e=>{const t=e.item;t.active&&(t.view.activeTool=null),t.destroy()}))]}function qt(e){return e.visible&&null!=e.getEditableFlag&&e.getEditableFlag(Bt.bH.USER)&&e.getEditableFlag(Bt.bH.MANAGER)}var Zt=i(96302),jt=i(99574),Wt=i(70134);class $t{constructor(){this._pointerLocations=new Map,this._hoveredManipulators=new Map,this._grabbedManipulators=new Map,this._draggedManipulators=new Map,this._stopDrag=!1,this._externallyDragging=!1,this._revertToNullActiveTool=!1,this._cursor=null}get cursor(){return this._cursor}hasFocusedManipulators(){return this._grabbedManipulators.size>0||this._draggedManipulators.size>0}handleInputEvent(e,t){const i=()=>e.stopPropagation();switch(e.type){case"pointer-move":Qt(e.pointerType)&&this._pointerLocations.set(e.pointerId,{x:e.x,y:e.y,pointerType:e.pointerType});break;case"drag":this._grabbedManipulators.size>0?this._stopDrag=!0:"start"===e.action?this._externallyDragging=!0:"end"===e.action&&(this._externallyDragging=!1),this._stopDrag&&(i(),"end"===e.action&&(this._stopDrag=!1));break;case"pointer-down":{if(!Kt(e))break;const r=(0,Wt.vT)(e),s=Yt(r,e.pointerType,t.forEachTool);if(null==s)break;const n=s.manipulator,a=s.tool;null==n||null==a||!n.interactive||n.grabbable&&n.grabbableForEvent(e)||!n.grabbing||n.dragging||this._releaseManipulatorBeforeDragging(n,e,t),null!=n&&null!=a&&n.interactive&&n.grabbable&&n.grabbableForEvent(e)&&!n.grabbing&&(this._grabbedManipulators.set(e.pointerId,{manipulator:n,tool:a,start:r,pointerType:e.pointerType}),1===this._grabbedManipulators.size&&null==t.activeTool&&(this._revertToNullActiveTool=!0,t.setActiveTool(s.tool)),n.grabbing=!0,n.events.emit("grab-changed",{action:"start",pointerType:e.pointerType,screenPoint:r}),i());break}case"pointer-up":this._draggedManipulators.has(e.pointerId)||this._handlePointerEnd(e,t);break;case"pointer-drag":{if(!Kt(e))break;const r=this._grabbedManipulators.get(e.pointerId),s=r?.manipulator,n=r?.tool;if(null==s||null==n)break;const a=(0,Wt.vT)(e);a.x=(0,jt.uZ)(a.x,0,t.view.width),a.y=(0,jt.uZ)(a.y,0,t.view.height);const o=r.start,l=this._draggedManipulators.get(e.pointerId);switch(e.action){case"start":case"update":"update"!==e.action&&1!==this._grabbedManipulators.size||(s.dragging=!0,l?s.events.emit("drag",{action:"update",start:o,screenPoint:a}):s.events.emit("drag",{action:"start",start:o,screenPoint:a,pointerType:e.pointerType}),this._draggedManipulators.set(e.pointerId,{tool:n,manipulator:s,start:o}));break;case"end":s.dragging=!1,l&&s.events.emit("drag",{action:"end",start:o,screenPoint:a}),this._draggedManipulators.delete(e.pointerId),this._handlePointerEnd(e,t)}i();break}case"immediate-click":{const r=(0,Wt.vT)(e),s=Yt(r,e.pointerType,t.forEachTool);if(function(e){return!!e.native.shiftKey}(e)||t.forEachTool((e=>{if((null==s||s.tool!==e||e.automaticManipulatorSelection)&&e.manipulators){let t=!1;e.manipulators.forEach((({manipulator:e})=>{e.selected&&(e.selected=!1,t=!0)})),t&&e.onManipulatorSelectionChanged&&e.onManipulatorSelectionChanged()}})),null==s)break;const{manipulator:n,tool:a}=s;if(!n.interactive)break;n.selectable&&a.automaticManipulatorSelection&&(n.selected=!n.selected,a.onManipulatorSelectionChanged&&a.onManipulatorSelectionChanged());const o=e.native.shiftKey;n.events.emit("immediate-click",{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:o,stopPropagation:i}),Jt(n,i);break}case"click":{const r=(0,Wt.vT)(e),s=Yt(r,e.pointerType,t.forEachTool)?.manipulator;if(null==s||!s.interactive)break;const n=e.native.shiftKey;s.events.emit(e.type,{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:n}),i();break}case"double-click":{const r=(0,Wt.vT)(e),s=Yt(r,e.pointerType,t.forEachTool),n=null!=s?s.manipulator:null;if(null==n||!n.interactive)break;const a=e.native.shiftKey;n.events.emit("double-click",{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:a,stopPropagation:i}),Jt(n,i);break}case"immediate-double-click":{const r=(0,Wt.vT)(e),s=Yt(r,e.pointerType,t.forEachTool),n=null!=s?s.manipulator:null;if(null==n||!n.interactive)break;const a=e.native.shiftKey;n.events.emit("immediate-double-click",{screenPoint:r,button:e.button,pointerType:e.pointerType,shiftKey:a,stopPropagation:i}),"mouse"===e.pointerType&&Jt(n,i);break}}this._onFocusChange(t.forEachTool)}_releaseManipulatorBeforeDragging(e,t,i){e.grabbing=!1,e.events.emit("grab-changed",{action:"end",pointerType:t.pointerType,screenPoint:(0,Wt.vT)(t)}),this._grabbedManipulators.forEach((({manipulator:t},i)=>{t===e&&this._grabbedManipulators.delete(i)})),this._afterManipulatorRelease(i.setActiveTool)}_handlePointerEnd(e,t){const i=this._grabbedManipulators.get(e.pointerId)?.manipulator;null!=i&&i.grabbing&&(i.grabbing=!1,i.events.emit("grab-changed",{action:"end",pointerType:e.pointerType,screenPoint:(0,Wt.vT)(e)}),this._grabbedManipulators.delete(e.pointerId),this._afterManipulatorRelease(t.setActiveTool))}_onFocusChange(e){this._updateCursor(),this._updateFocusedManipulatorTools(e)}_updateCursor(){this._grabbedManipulators.size>0?this._cursor=Xt(this._grabbedManipulators)||"grabbing":this._hoveredManipulators.size>0?this._cursor=Xt(this._hoveredManipulators)||"pointer":this._cursor=null}_updateFocusedManipulatorTools(e){const t=new Set,i=new Set;this._grabbedManipulators.forEach((({tool:e})=>{t.add(e)})),this._hoveredManipulators.forEach((({tool:e})=>{i.add(e)})),e((e=>{e.hasGrabbedManipulators=t.has(e),e.hasHoveredManipulators=i.has(e);const r=this._grabbedManipulators.values(),s=(0,Zt.sE)(r,(({tool:t})=>t===e));e.firstGrabbedManipulator=null!=s?s.manipulator:null}))}clearPointers(e,{forEachTool:t,setActiveTool:i},r=!0,s){const n=(t,i)=>t===e&&(null==s||s===i);this._grabbedManipulators.forEach((({tool:e,manipulator:t,pointerType:i},r)=>{n(e,t)&&(this._grabbedManipulators.delete(r),t.grabbing=!1,t.events.emit("grab-changed",{action:"end",screenPoint:null,pointerType:i}))})),this._draggedManipulators.forEach((({tool:e,manipulator:t},i)=>{n(e,t)&&(this._draggedManipulators.delete(i),t.dragging=!1,t.events.emit("drag",{action:"cancel"}))})),r&&this._hoveredManipulators.forEach((({tool:e,manipulator:t},i)=>{n(e,t)&&(this._hoveredManipulators.delete(i),t.hovering=!1)})),this._afterManipulatorRelease(i),this._onFocusChange(t)}updateHoveredStateFromKnownPointers(e){this._pointerLocations.forEach(((t,i)=>{this._updateHoveredStateForPointerAtScreenPosition((0,b.vW)(t.x,t.y),i,t.pointerType,e)}))}handleHoverEvent(e,t){const i=e.type;"pointer-up"!==i&&"immediate-click"!==i&&"pointer-move"!==i||!Qt(e.pointerType)||("pointer-up"!==i&&this._externallyDragging?this._clearHoveredManipulatorStates(e.pointerId):this._updateHoveredStateForPointerAtScreenPosition((0,Wt.vT)(e),e.pointerId,e.pointerType,t))}_updateHoveredStateForPointerAtScreenPosition(e,t,i,r){let s=Yt(e,i,r);const n=this._hoveredManipulators.get(t)?.manipulator;null==s||s.manipulator.interactive||(s=null),null!=s&&n===s.manipulator||(null!=n&&(n.hovering=!1),null!=s?(s.manipulator.hovering=!0,this._hoveredManipulators.set(t,s)):this._hoveredManipulators.delete(t),this._onFocusChange(r))}_afterManipulatorRelease(e){0===this._grabbedManipulators.size&&this._revertToNullActiveTool&&(e(null),this._revertToNullActiveTool=!1)}_clearHoveredManipulatorStates(e){this._hoveredManipulators.forEach((({manipulator:t},i)=>{e===i&&(this._hoveredManipulators.delete(e),t.hovering=!1)}))}}function Xt(e){for(const{manipulator:t}of e.values())if(null!=t&&t.interactive){if(t.grabbing&&t.grabCursor)return t.grabCursor;if(t.cursor)return t.cursor}return null}function Yt(e,t,i){let r=null;return i((i=>{if(null==i.manipulators||!qt(i))return!1;const s=i.manipulators.intersect(e,t);return null!=s&&(r={tool:i,manipulator:s},!0)})),r}function Qt(e){return"mouse"===e}function Kt(e){return"mouse"!==e.pointerType||0===e.button}function Jt(e,t){e?.consumesClicks&&t()}const ei="attached",ti="tools";let ii=class extends E.Z{constructor(e){super(e),this._updatingHandles=new Y.R,this._clock=Vt.m,this._manipulatorState=new $t,this.tools=new c.Z,this.cursor=null,this._interacting=!1,this._interactingTimeout=1e3,this._interactingTimeoutHandle=null,this._forEachTool=e=>{for(const t of this.tools.items)if(e(t))return}}initialize(){this.addHandles([this.view.on(kt.uS,(e=>{this._handleInputEvent(e)}),_e.f.TOOL),...Gt(this.tools),this.tools.on("before-add",(({item:e})=>{this._updateToolEditableFlag(e)})),this.tools.on("before-remove",(({item:e})=>{this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs),this._updateCursor()})),this.tools.on("change",(()=>{this._refreshToolWatchers()}))])}destroy(){this.activeTool=null,this.tools.drain((e=>e.destroy())),this._clearInteractingTimeout(),this._interacting=!1,this._updatingHandles.destroy()}get _manipulatorStateEventArgs(){return{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:e=>{this.activeTool=e},view:this.view}}set activeTool(e){if(null!=e&&!this.view.ready)return void _.Z.getLogger(this).error("Cannot set active tool while view is not ready.");if(e===this.activeTool)return;const t=this.activeTool;this._set("activeTool",e),null!=t&&t.deactivate(),null!=e&&e.activate(),this._removeIncompleteTools(e);for(const e of this.tools){this._updateToolEditableFlag(e);const t=qt(e);null!=this.activeTool&&t||this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs,!t)}this._updateCursor()}get updating(){return this._updatingHandles.updating||this.tools.some((e=>e.updating))}get interacting(){return this._interacting}_clearInteractingTimeout(){this._interactingTimeoutHandle=(0,f.hw)(this._interactingTimeoutHandle)}_startInteractingTimeout(){this._clearInteractingTimeout(),this._interactingTimeoutHandle=this._clock.setTimeout((()=>this._interacting=!1),this._interactingTimeout)}attach(){"3d"===this.view.type?this.addHandles([(0,n.YP)((()=>{const{state:e}=this.view;return"camera"in e&&e.camera}),(()=>this._forEachManipulator((e=>e.onViewChange())))),this.view.elevationProvider?.on("elevation-change",(e=>this._forEachManipulator((t=>t.onElevationChange(e)))))],ei):this.addHandles((0,n.YP)((()=>this.view.extent),(()=>this._forEachManipulator((e=>e.onViewChange())))))}detach(){this.activeTool=null,this.tools.removeAll(),this.removeHandles(ei),this._clearInteractingTimeout(),this._interacting=!1}_forEachManipulator(e){this._forEachTool((t=>{t.manipulators&&t.manipulators.forEach((({manipulator:i})=>e(i,t)))}))}_handleInputEvent(e){let t=!1;const i={...e,stopPropagation:()=>{t=!0,e.stopPropagation()}};null!=this.activeTool?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(i):this._forEachTool((e=>{!t&&e.visible&&e.handleInputEvent(i)})),!t&&function(e){return"key-down"===e.type&&e.key===zt.NG.cancel}(e)&&this.activeTool&&(e.stopPropagation(),e.preventDefault(),this.activeTool.cancel(),this.activeTool=null),this._manipulatorState.handleInputEvent(i,this._manipulatorStateEventArgs),t||null==this.activeTool||this.activeTool.handleInputEventAfter(i),this._manipulatorState.handleHoverEvent(i,this._forEachTool),this._updateCursor(),"pointer-move"===e.type&&(this._manipulatorState.hasFocusedManipulators()||this.activeTool)&&(this._interacting=!0,this._startInteractingTimeout())}_refreshToolWatchers(){this.removeHandles(ti),this._forEachTool((e=>{if(e instanceof E.Z){const t=(0,n.YP)((()=>[e.cursor,e.visible,e.editable]),(()=>{qt(e)||this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs),this._updateCursor()}));this.addHandles(t,ti)}e.manipulators&&this.addHandles([e.manipulators.on("after-remove",(t=>{this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs,!0,t.item.manipulator)})),e.manipulators.on("change",(()=>{this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}))],ti)})),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}_updateToolEditableFlag(e){e.setEditableFlag?.(Bt.bH.MANAGER,null==this.activeTool||e===this.activeTool)}_updateCursor(){let e=this._manipulatorState.cursor;null==e&&this._forEachTool((t=>!(null==t.cursor||!t.visible||(e=t.cursor,0)))),this._get("cursor")!==e&&this._set("cursor",e)}_removeIncompleteTools(e){this.tools.filter((t=>(null==e||t!==e)&&!t.created&&t.removeIncompleteOnCancel)).forEach((e=>{this.tools.remove(e)}))}get test(){}};(0,o._)([(0,x.Cb)({constructOnly:!0,nonNullable:!0})],ii.prototype,"view",void 0),(0,o._)([(0,x.Cb)({value:null})],ii.prototype,"activeTool",null),(0,o._)([(0,x.Cb)({readOnly:!0,type:c.Z})],ii.prototype,"tools",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],ii.prototype,"cursor",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],ii.prototype,"updating",null),(0,o._)([(0,x.Cb)()],ii.prototype,"_interacting",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],ii.prototype,"interacting",null),ii=(0,o._)([(0,S.j)("esri.views.ToolViewManager")],ii);var ri,si=i(43295);let ni=ri=class extends E.Z{constructor(e){super(e),this.name=si.b,this.color=si.SQ.clone(),this.haloColor=null,this.haloOpacity=si.j2,this.fillOpacity=si.Ac,this.shadowColor=si.NU.clone(),this.shadowOpacity=si.CN,this.shadowDifference=si.oH,this.haloWidth=2.1,this.haloBlur=.8/this.haloWidth}equals(e){return this.color.equals(e.color)&&(this.haloColor||this.color).equals(e.haloColor||e.color)&&this.haloOpacity===e.haloOpacity&&this.fillOpacity===e.fillOpacity&&this.haloWidth===e.haloWidth&&this.haloBlur===e.haloBlur&&this.shadowColor.equals(e.shadowColor)&&this.shadowOpacity===e.shadowOpacity&&this.shadowDifference===e.shadowDifference}clone(){return new ri({...this,color:this.color.clone(),haloColor:this.haloColor?.clone(),shadowColor:this.shadowColor?.clone()})}assignFrom(e){this.color=e.color.clone(),this.haloColor=e.haloColor?.clone(),this.haloOpacity=e.haloOpacity,this.fillOpacity=e.fillOpacity,this.shadowColor=e.shadowColor.clone(),this.shadowDifference=e.shadowDifference,this.shadowOpacity=e.shadowOpacity,this.haloBlur=e.haloBlur,this.haloWidth=e.haloWidth}};(0,o._)([(0,x.Cb)({type:String,constructOnly:!0,nonNullable:!0})],ni.prototype,"name",void 0),(0,o._)([(0,x.Cb)({type:xe.Z,nonNullable:!0})],ni.prototype,"color",void 0),(0,o._)([(0,x.Cb)({type:xe.Z})],ni.prototype,"haloColor",void 0),(0,o._)([(0,x.Cb)({nonNullable:!0})],ni.prototype,"haloOpacity",void 0),(0,o._)([(0,x.Cb)({nonNullable:!0})],ni.prototype,"fillOpacity",void 0),(0,o._)([(0,x.Cb)({type:xe.Z,nonNullable:!0})],ni.prototype,"shadowColor",void 0),(0,o._)([(0,x.Cb)({nonNullable:!0})],ni.prototype,"shadowOpacity",void 0),(0,o._)([(0,x.Cb)({nonNullable:!0})],ni.prototype,"shadowDifference",void 0),(0,o._)([(0,x.Cb)({nonNullable:!0})],ni.prototype,"haloWidth",void 0),(0,o._)([(0,x.Cb)({nonNullable:!0})],ni.prototype,"haloBlur",void 0),ni=ri=(0,o._)([(0,S.j)("esri.views.support.HighlightOptions")],ni);const ai=ni;let oi=class extends E.Z{constructor(e){super(),this.nativeIndex=null,this._detectedDeviceType="unknown","standard"===e.mapping?this._detectedDeviceType="standard":ci.test(e.id)?this._detectedDeviceType="spacemouse":this._detectedDeviceType="unknown",this.nativeIndex=e.index}get native(){const e=navigator.getGamepads?navigator.getGamepads():[];return null!=this.nativeIndex&&this.nativeIndex<e.length?e[this.nativeIndex]:null}get deviceType(){return this._detectedDeviceType}get axisThreshold(){return hi[this.deviceType]}};(0,o._)([(0,x.Cb)({nonNullable:!0,readOnly:!0})],oi.prototype,"nativeIndex",void 0),(0,o._)([(0,x.Cb)({type:String,readOnly:!0})],oi.prototype,"deviceType",null),(0,o._)([(0,x.Cb)({type:Number,readOnly:!0})],oi.prototype,"axisThreshold",null),oi=(0,o._)([(0,S.j)("esri.views.input.gamepad.GamepadInputDevice")],oi);const li=oi,ci=new RegExp("^(3dconnexion|space(mouse|navigator|pilot|explorer))","i"),hi={standard:.15,spacemouse:.025,unknown:0};let ui=class extends E.Z{constructor(...e){super(...e),this.devices=new c.Z,this.enabledFocusMode="document"}};(0,o._)([(0,x.Cb)({type:c.Z.ofType(li),readOnly:!0})],ui.prototype,"devices",void 0),(0,o._)([(0,x.Cb)({type:["document","view","none"]})],ui.prototype,"enabledFocusMode",void 0),ui=(0,o._)([(0,S.j)("esri.views.input.gamepad.GamepadSettings")],ui);const di=ui;let pi=class extends E.Z{constructor(){super(...arguments),this.gamepad=new di}};(0,o._)([(0,x.Cb)({readOnly:!0})],pi.prototype,"gamepad",void 0),pi=(0,o._)([(0,S.j)("esri.views.input.Input")],pi);const mi=pi;var _i=i(12019),fi=i(85168);const gi=()=>(0,x.Cb)({type:["pan","rotate","zoom","none"],nonNullable:!0});let yi=class extends E.Z{constructor(e){super(e),this.dragPrimary="pan",this.dragSecondary="rotate",this.dragTertiary="zoom",this.mouseWheel="zoom"}};(0,o._)([gi()],yi.prototype,"dragPrimary",void 0),(0,o._)([gi()],yi.prototype,"dragSecondary",void 0),(0,o._)([gi()],yi.prototype,"dragTertiary",void 0),(0,o._)([(0,x.Cb)({type:["zoom","none"],nonNullable:!0})],yi.prototype,"mouseWheel",void 0),yi=(0,o._)([(0,S.j)("esri.views.navigation.NavigationActionMap")],yi);const vi=yi;let bi=class extends E.Z{constructor(e){super(e),this.enabled=!0,this.device=null,this.mode="pan",this.tiltDirection="forward-down",this.velocityFactor=1}};(0,o._)([(0,x.Cb)({type:Boolean,nonNullable:!0})],bi.prototype,"enabled",void 0),(0,o._)([(0,x.Cb)({type:li})],bi.prototype,"device",void 0),(0,o._)([(0,x.Cb)({type:["pan","zoom"],nonNullable:!0})],bi.prototype,"mode",void 0),(0,o._)([(0,x.Cb)({type:["forward-down","forward-up"],nonNullable:!0})],bi.prototype,"tiltDirection",void 0),(0,o._)([(0,x.Cb)({type:Number,nonNullable:!0})],bi.prototype,"velocityFactor",void 0),bi=(0,o._)([(0,S.j)("esri.views.navigation.gamepad.GamepadSettings")],bi);const wi=bi;let Ci=class extends E.Z{constructor(e){super(e),this.actionMap=new vi,this.browserTouchPanEnabled=!0,this.gamepad=new wi,this.momentumEnabled=!0}get effectiveMomentumEnabled(){return this.momentumEnabled&&!(0,_i.n)()}get mouseWheelZoomEnabled(){return"zoom"===this.actionMap.mouseWheel}set mouseWheelZoomEnabled(e){(0,fi.Mr)(_.Z.getLogger(this),"mouseWheelZoomEnabled",{replacement:"actionMap.mouseWheel",version:"4.32",warnOnce:!0}),this.actionMap.mouseWheel=e?"zoom":"none"}};(0,o._)([(0,x.Cb)({type:vi,nonNullable:!0})],Ci.prototype,"actionMap",void 0),(0,o._)([(0,x.Cb)({type:Boolean})],Ci.prototype,"browserTouchPanEnabled",void 0),(0,o._)([(0,x.Cb)({type:wi,nonNullable:!0})],Ci.prototype,"gamepad",void 0),(0,o._)([(0,x.Cb)({type:Boolean})],Ci.prototype,"momentumEnabled",void 0),(0,o._)([(0,x.Cb)({type:Boolean})],Ci.prototype,"mouseWheelZoomEnabled",null),Ci=(0,o._)([(0,S.j)("esri.views.navigation.Navigation")],Ci);const xi=Ci;var Ti=i(73584),Si=i(56172),Mi=i(92105);let Ei=class extends E.Z{constructor(e){super(e),this.required={extent:!1,heightModelInfo:!1,tileInfo:!1},this.defaultSpatialReference=null,this.userSpatialReference=null,this.sourcePreloadCount=10,this.priorityCollection=null,this.requiresExtentInSpatialReference=!0,this.suspended=!1,this._projectExtentTask={task:null,input:null,output:null,spatialReference:null}}destroy(){this._projectExtentTask.task&&(this._projectExtentTask.task=(0,f.IM)(this._projectExtentTask.task)),this._set("map",null)}get ready(){return!this._spatialReferenceTask.updating&&!this._tileInfoTask.updating&&!this._extentTask.updating}get heightModelInfoReady(){return!this._heightModelInfoTask.updating}get spatialReference(){return this.userSpatialReference??this._spatialReferenceTask.spatialReference}get extent(){return this._extentTask.extent}get heightModelInfo(){return this._heightModelInfoTask.heightModelInfo}get vcsWkid(){return this._heightModelInfoTask.vcsWkid}get latestVcsWkid(){return this._heightModelInfoTask.latestVcsWkid}get viewingMode(){return null==this.userSpatialReference||this.userSpatialReference.equals(this._spatialReferenceTask.spatialReference)?this._spatialReferenceTask.viewingMode:null}get tileInfo(){return this._tileInfoTask.tileInfo}get mapCollections(){const e=this.map?.(),t=[];return null!=this.priorityCollection&&t.push(this.priorityCollection),t.push({parent:e?.basemap,layers:e?.basemap?.baseLayers},{layers:e?.layers},{parent:e?.ground,layers:e?.ground?.layers},{parent:e?.basemap,layers:e?.basemap?.referenceLayers}),t}get _spatialReferenceTask(){if(this.suspended)return this._get("_spatialReferenceTask")??{updating:!1};let e;if(this._collectLayers(this.mapCollections,(t=>{const i=this._getSupportedSpatialReferences(t);if(i.length>0){const t=this._narrowDownSpatialReferenceCandidates(e,i);null!=t&&(e=t)}return 1===e?.length}))&&1!==e?.length)return{updating:!0};const t=this._pickSpatialReferenceCandidate(e);return{spatialReference:t?.spatialReference??null,viewingMode:t?.viewingMode??null,updating:!1}}get _tileInfoTask(){if(!this.required.tileInfo)return this._get("_tileInfoTask")??{updating:!1};const e=this.map?.(),t=this.spatialReference;if(!t)return{updating:this._spatialReferenceTask.updating};let i;const r=this._collectLayers([{parent:e?.basemap,layers:e?.basemap?.baseLayers},{layers:e?.layers}],(e=>!(!("tileInfo"in e)||!e.tileInfo?.spatialReference.equals(t)||(i=e,0))),(e=>"tileInfo"in e));return i?{tileInfo:i.tileInfo,updating:!1}:{updating:r}}get _heightModelInfoTask(){if(!this.required.heightModelInfo||this.suspended&&this._get("_heightModelInfoTask")?.heightModelInfo)return this._get("_heightModelInfoTask")??{updating:!1};let e={};const t=this._collectLayers(this.mapCollections,(t=>{const i=(0,Ti.Ku)(t);return!!i&&(e={heightModelInfo:i,vcsWkid:t.spatialReference?.vcsWkid,latestVcsWkid:t.spatialReference?.latestVcsWkid},!0)}),(e=>(0,Ti.qC)(e)));return{...e,updating:t}}get _extentCandidatesTask(){if(this.suspended||!this.required.extent)return this._get("_extentCandidatesTask")??{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const e=[],t=this._collectLayers(this.mapCollections,(t=>{const i="fullExtents"in t&&t.fullExtents||(null!=t.fullExtent?[t.fullExtent]:[]),r=this.requiresExtentInSpatialReference?null:i[0],s=i.find((e=>e.spatialReference.equals(this.spatialReference)))??r;if(s)return e.push({extent:s,layer:t}),!0;if(this._getSupportedSpatialReferences(t).length>0)for(const r of i)e.push({extent:r,layer:t});return!1}));return{candidates:e,updating:t}}get _extentTask(){const{candidates:e,updating:t}=this._extentCandidatesTask;if(t)return{updating:t};if(null==e||0===e.length)return{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const i=this._pickExtentCandidate(e),r=this.spatialReference;return i.extent.equals(this._projectExtentTask.input)&&r.equals(this._projectExtentTask.spatialReference)?{extent:this._projectExtentTask.output,updating:null!=this._projectExtentTask.task&&!this._projectExtentTask.task.finished}:(null!=this._projectExtentTask.task&&(this._projectExtentTask.task=(0,f.IM)(this._projectExtentTask.task)),this._projectExtentTask={input:i.extent.clone(),output:null,spatialReference:r.clone(),task:(0,me.vr)((async e=>{try{const t=await(0,Mi.o)(i.extent,r,"portalItem"in i.layer?i.layer.portalItem:void 0,e);this._projectExtentTask={...this._projectExtentTask,task:null,output:t}}catch(t){if((0,y.Hc)(e))return;this._projectExtentTask={...this._projectExtentTask,task:null}}}))},{updating:!0})}_narrowDownSpatialReferenceCandidates(e,t){if(null==e)return t;const i=new Array;for(const r of e)for(const e of t){if(!r.spatialReference.equals(e.spatialReference))continue;const t=Pi(r.viewingMode,e.viewingMode);if(!1!==t){i.push({spatialReference:r.spatialReference,viewingMode:t});break}}return i.length>0?i:null}_pickSpatialReferenceCandidate(e){const t=this.defaultSpatialReference;return null==e||e.length<1?t?{spatialReference:t,viewingMode:null}:null:(null!=t&&e.length>1&&e.some((({spatialReference:e})=>e.equals(t)))&&(e=e.filter((({spatialReference:e})=>e.equals(t)))),e.length>1&&e.some((({viewingMode:e})=>e!==Si.JY.Local))&&(e=e.filter((({viewingMode:e})=>e!==Si.JY.Local))),e[0])}_getSupportedSpatialReferences(e){const t="supportedSpatialReferences"in e&&e.supportedSpatialReferences||(e.spatialReference?[e.spatialReference]:[]);if(0===t.length)return[];const i=[];for(const r of t){const t=this.getSpatialReferenceSupport(r,e);if(null!=t){const e=t.constraints??[{spatialReference:r,viewingMode:null}];for(const{spatialReference:t,viewingMode:r}of e)this.requiresExtentInSpatialReference&&null!=this.userSpatialReference&&!t.equals(this.userSpatialReference)||i.push({spatialReference:t,viewingMode:r})}}return i}_pickExtentCandidate(e){const t=this.spatialReference;return e.find((({extent:e})=>t.equals(e.spatialReference)))||e[0]}_collectLayers(e,t,i=(()=>!0)){switch(this._loadMaybe(this.map?.())){case"loading":return!0;case"failed":return!1}const r=new Ri(i,t);for(const t of e)if(this._collectCollection(t,r),r.done||r.preloading===this.sourcePreloadCount)break;return r.updating}_collectCollection(e,t){if(e.layers){switch(this._loadMaybe(e.parent)){case"loading":return t.updating=!0,void++t.preloading;case"failed":return}for(const i of e.layers)if(t.layerFilter(i)){switch(this._loadMaybe(i)){case"failed":continue;case"loading":t.updating=!0,++t.preloading;break;case"loaded":if(t.updating||(t.done=t.pushLayer(i)),t.done||t.preloading===this.sourcePreloadCount)break;"layers"in i&&this._collectCollection({layers:i.layers},t)}if(t.done||t.preloading===this.sourcePreloadCount)break}}}_loadMaybe(e){return e&&"loadStatus"in e&&null!=e.loadStatus?"not-loaded"===e.loadStatus?(e.load().catch((e=>{(0,y.D_)(e)})),"loading"):e.loadStatus:"loaded"}};(0,o._)([(0,x.Cb)()],Ei.prototype,"required",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],Ei.prototype,"map",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],Ei.prototype,"getSpatialReferenceSupport",void 0),(0,o._)([(0,x.Cb)()],Ei.prototype,"defaultSpatialReference",void 0),(0,o._)([(0,x.Cb)()],Ei.prototype,"userSpatialReference",void 0),(0,o._)([(0,x.Cb)()],Ei.prototype,"sourcePreloadCount",void 0),(0,o._)([(0,x.Cb)()],Ei.prototype,"priorityCollection",void 0),(0,o._)([(0,x.Cb)()],Ei.prototype,"requiresExtentInSpatialReference",void 0),(0,o._)([(0,x.Cb)()],Ei.prototype,"suspended",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Ei.prototype,"ready",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Ei.prototype,"heightModelInfoReady",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Ei.prototype,"spatialReference",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Ei.prototype,"extent",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Ei.prototype,"heightModelInfo",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Ei.prototype,"vcsWkid",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Ei.prototype,"latestVcsWkid",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Ei.prototype,"viewingMode",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Ei.prototype,"tileInfo",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Ei.prototype,"mapCollections",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Ei.prototype,"_spatialReferenceTask",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Ei.prototype,"_tileInfoTask",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Ei.prototype,"_heightModelInfoTask",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Ei.prototype,"_extentCandidatesTask",null),(0,o._)([(0,x.Cb)()],Ei.prototype,"_extentTask",null),(0,o._)([(0,x.Cb)()],Ei.prototype,"_projectExtentTask",void 0),Ei=(0,o._)([(0,S.j)("esri.views.support.DefaultsFromMap")],Ei);class Ri{constructor(e,t){this.layerFilter=e,this.pushLayer=t,this.preloading=-1,this.updating=!1,this.done=!1}}function Pi(e,t){return null!=e?null!=t?e===t&&e:e:t}var Ai=i(57947),Oi=i(38209);class Di{constructor(e,t,i){this.layer=e,this.view=t,this.layerViewImporter=i,this._controller=new AbortController,this._deferred=(0,y.hh)(),this._started=!1,this.done=!1,this.promise=this._deferred.promise,(0,y.fu)(this._controller.signal,(()=>{this._recycleController?.abort();const t=new u.Z("cancelled:layerview-create","layerview creation cancelled",{layer:e});this._deferred.reject(t)}))}tryRecycle(e){if(!this.done||!this.layerView||!function(e){return"tryRecycleWith"in e}(this.layerView))return null;this._recycleController?.abort(),this._recycleController=new AbortController;const t=this.layer.type,i=this._recycleController.signal;for(let r=0;r<e.length;r++){const s=e[r];if(s.type!==t)continue;const n=this.layerView.tryRecycleWith(s,{signal:i});if(n){e.splice(r,1),this.layer=s;const t=this.layerView,a=t.view;return this.promise=n.then((()=>((0,y.k_)(i),s.emit("layerview-destroy",{view:a,layerView:t}),a.emit("layerview-destroy",{view:a,layerView:t}),s.emit("layerview-create",{view:a,layerView:t}),a.emit("layerview-create",{view:a,layerView:t}),t))),this.promise}}return null}destroy(){this._controller.abort();const{layerView:e}=this;if(e){const{layer:t,view:i}=this;t.emit("layerview-destroy",{view:i,layerView:e}),i.emit("layerview-destroy",{layer:t,layerView:e})}this.done=!0,this.layer=null,this.layerView=null,this.view=null,this.layerViewImporter=null,this._map=null}async start(){const{view:e}=this;if(this._started||!e.map)return;this._started=!0;const{_controller:{signal:t},layer:i}=this;this._map=e.map;try{let r,s;if(await i.load({signal:t}),i.prefetchResources&&await i.prefetchResources({signal:t}),function(e){return e.createLayerView!==Oi.Z.prototype.createLayerView}(i))r=await i.createLayerView(e,{signal:t});else{if(!this.layerViewImporter.hasLayerViewModule(i))throw new u.Z("layer:view-not-supported","No layerview implementation was found");const s=await this.layerViewImporter.importLayerView(i);(0,y.k_)(t),r="default"in s?new s.default({layer:i,view:e}):new s({layer:i,view:e})}const n=()=>{s=(0,f.hw)(s),r.destroyed||r.destroy(),r.layer=null,r.parent=null,r.view=null,this.done=!0};s=(0,y.fu)(t,n),(0,y.k_)(t);try{await r.when()}catch(e){throw n(),e}const a=this._map?.allLayers?.includes(i);if(!a)return n(),void this._deferred.reject(new u.Z("view:no-layerview-for-layer","The layer has been removed from the map",{layer:i}));this.layerView=r,i.emit("layerview-create",{view:e,layerView:r}),e.emit("layerview-create",{layer:i,layerView:r}),this.done=!0,this._deferred.resolve(r)}catch(t){i.emit("layerview-create-error",{view:e,error:t}),e.emit("layerview-create-error",{layer:i,error:t}),this.done=!0,this._deferred.reject(new u.Z("layerview:create-error","layerview creation failed",{layer:i,error:t}))}}}function Ii(e){return null!=e&&"object"==typeof e&&"layerViews"in e}let Li=class extends E.Z{constructor(e){super(e),this._layerLayerViewInfoMap=new Map,this._recyclingInfoMap=new Map,this._watchUpdatingTracking=new Y.R,this.supportsGround=!0,this._preloadLayerViewModules=()=>{const e=this.view.map?.allLayers;if(e)for(const t of e)!1!==this.layerViewFilter?.(t)&&this.layerViewImporter.hasLayerViewModule(t)&&this.layerViewImporter.importLayerView(t)},this._reschedule=()=>this.destroyed?Promise.reject():(null==this._workPromise&&(this._workPromise=(0,y.hh)(),this._workPromise.promise.catch((()=>{}))),this.removeHandles("reschedule"),this.addHandles((0,v.Os)(this._doWork),"reschedule"),this._workPromise.promise),this._doWork=()=>{const e=this.view.map;if(this.destroyed||!e)return void this.clear();if(this._map!==e&&(this.clear(),this._map=e),null==this._workPromise)return void this.notifyChange("updating");this.removeHandles("reschedule"),this.removeHandles("collection-change");const t=new Set,i=[],r=this.view.ready,s=e=>{if(null!=e)for(const n of e)if(n){if(!1===this.layerViewFilter?.(n))continue;t.add(n);const e=this._layerLayerViewInfoMap.get(n);e&&r?e.start():e||this._recyclingInfoMap.has(n)||i.push(n),"layers"in n&&n.layers&&s(n.layers)}};for(const e of this._rootCollectionNames)s((0,Ai.U2)(this,e));const n=new Array,a=e=>{const t=e.tryRecycle(i);t?(this._recyclingInfoMap.set(e.layer,e),this.notifyChange("updating"),t.then((()=>{this._recyclingInfoMap.delete(e.layer),this._layerLayerViewInfoMap.set(e.layer,e),this._reschedule(),this.notifyChange("updating")})).catch((t=>{(0,y.D_)(t)||(this._recyclingInfoMap.delete(e.layer),e.destroy(),this._reschedule(),this.notifyChange("updating"))}))):n.push(e)};for(const e of this._layerLayerViewInfoMap.values())t.has(e.layer)||(this._layerLayerViewInfoMap.delete(e.layer),a(e));for(const e of this._recyclingInfoMap.values())t.has(e.layer)||(this._recyclingInfoMap.delete(e.layer),a(e));for(const e of i)this._createLayerView(e);this._refreshCollections(),n.forEach((e=>e.destroy()));const o=[e?.ground?.layers,e?.basemap?.baseLayers,e?.basemap?.referenceLayers,e?.layers].filter((e=>!!e));t.forEach((e=>"layers"in e&&o.push(e.layers))),this.addHandles(o.map((e=>this._watchUpdatingTracking.addOnCollectionChange((()=>e),this._reschedule))),"collection-change"),this._workPromise.resolve(),this._workPromise=null}}initialize(){this.addHandles([(0,n.on)((()=>this.view?.map?.allLayers),"change",this._preloadLayerViewModules,{onListenerAdd:this._preloadLayerViewModules}),(0,n.YP)((()=>{const e=this.view,t=e?.map;return[t?.basemap,t?.ground,t?.layers,e?.ready]}),(()=>this._reschedule()),n.tX)]),this._preloadLayerViewModules(),this._reschedule()}destroy(){this.clear(),(0,lt.O)(this._recyclingInfoMap),(0,lt.O)(this._layerLayerViewInfoMap),this._watchUpdatingTracking.destroy(),this._map=null,null!=this._workPromise&&(this._workPromise.reject((0,y.zE)()),this._workPromise=null)}get _layersToLayerViews(){const e=[["view.map.basemap.baseLayers","view.basemapView.baseLayerViews"],["view.map.layers","view.layerViews"],["view.map.basemap.referenceLayers","view.basemapView.referenceLayerViews"]];return this.supportsGround&&e.push(["view.map.ground.layers","view.groundView.layerViews"]),new Map(e)}get _rootCollectionNames(){return Array.from(this._layersToLayerViews.keys())}get updating(){return null!=this._workPromise||this._watchUpdatingTracking.updating||(0,Mt.oE)(this._layerLayerViewInfoMap,(e=>!e.done))||this._recyclingInfoMap.size>0}get updatingRemaining(){let e=0;for(const t of this._layerLayerViewInfoMap.values())t.done||++e;return e}clear(){this.destroyed||(this._clearCollections(),(0,lt.O)(this._layerLayerViewInfoMap))}async whenLayerView(e){if(await this._reschedule(),!this._layerLayerViewInfoMap.has(e)){if(this._recyclingInfoMap.has(e))return this._recyclingInfoMap.get(e).promise;throw new u.Z("view:no-layerview-for-layer","No layerview has been found for the layer",{layer:e})}return this._layerLayerViewInfoMap.get(e).promise}isCreatingLayerViewsForLayer(e,t){this.commitProperty("updatingRemaining");const i=this._layerLayerViewInfoMap.get(e);if(!i?.done)return!0;const r=i.layerView;return!(!r||!t||r.parent===t)||!!(i.done&&r&&"layers"in e&&e.layers?.length)&&e.layers.some((e=>this.isCreatingLayerViewsForLayer(e,r)))}_refreshCollections(){for(const[e,t]of this._layersToLayerViews)this._populateLayerViewsOwners((0,Ai.U2)(this,e),(0,Ai.U2)(this,t),this.view);this.notifyChange("updating"),this.notifyChange("updatingRemaining")}_clearCollections(){for(const e of this._layersToLayerViews.values())(0,Ai.U2)(this,e)?.removeAll()}_populateLayerViewsOwners(e,t,i){if(!e||!t)return void t?.removeAll();let r=0;for(const s of e){const e=this._layerLayerViewInfoMap.get(s);if(!e?.layerView)continue;const n=e.layerView;n.layer=s,n.parent=i,t.at(r)!==n&&t.splice(r,0,n),"layers"in s&&Ii(n)&&this._populateLayerViewsOwners(s.layers,n.layerViews,n),r+=1}r<t.length&&t.splice(r)}_createLayerView(e){e.load().catch((()=>{})),this.layerViewImporter.hasLayerViewModule(e)&&this.layerViewImporter.importLayerView(e);const t=new Di(e,this.view,this.layerViewImporter);t.promise.then((()=>this._refreshCollections()),(t=>{t&&((0,y.D_)(t)||"cancelled:layerview-create"===t.name)||_.Z.getLogger(this).error(`Failed to create layerview for layer title:'${e.title??"no title"}', id:'${e.id??"no id"}' of type '${e.type}'.`,{layer:e,error:t}),this._refreshCollections()})),this._layerLayerViewInfoMap.set(e,t),this.view.ready&&t.start(),this.notifyChange("updating"),this.notifyChange("updatingRemaining")}};(0,o._)([(0,x.Cb)()],Li.prototype,"_workPromise",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Li.prototype,"_watchUpdatingTracking",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Li.prototype,"_layersToLayerViews",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Li.prototype,"_rootCollectionNames",null),(0,o._)([(0,x.Cb)({constructOnly:!0})],Li.prototype,"layerViewFilter",void 0),(0,o._)([(0,x.Cb)()],Li.prototype,"layerViewImporter",void 0),(0,o._)([(0,x.Cb)()],Li.prototype,"supportsGround",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Li.prototype,"updating",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Li.prototype,"updatingRemaining",null),(0,o._)([(0,x.Cb)({constructOnly:!0})],Li.prototype,"view",void 0),Li=(0,o._)([(0,S.j)("esri.views.support.LayerViewManager")],Li);const Fi=Li;let Ni=class extends E.Z{constructor(e){super(e),this.featureTitleFields=!1,this.utilityNetworkFields=!1,this.globalIdField=!1}};(0,o._)([(0,x.Cb)()],Ni.prototype,"featureTitleFields",void 0),(0,o._)([(0,x.Cb)()],Ni.prototype,"utilityNetworkFields",void 0),(0,o._)([(0,x.Cb)()],Ni.prototype,"globalIdField",void 0),Ni=(0,o._)([(0,S.j)("esri.views.support.RequiredFieldsOptions")],Ni);const Ui=Ni;var Hi;let Vi=class extends(ae.Z.EventedMixin(_t.Z.EsriPromiseMixin(E.Z))){static{Hi=this}constructor(e){super(e),this._userSpatialReference=null,this._cursor=null,this.handles=new mt.Z,this.updatingHandles=new Y.R,this.allLayerViews=new ke.Z({getCollections:()=>[this.basemapView?.baseLayerViews,this.groundView?.layerViews,this.layerViews,this.basemapView?.referenceLayerViews],getChildrenFunction:zi}),this.analyses=new G,this.basemapView=null,this.displayFilterEnabled=!0,this.fatalError=null,this.graphics=new gt.J,this.groundView=null,this.typeSpecificPreconditionsReady=!0,this.layerViews=new c.Z,this.magnifier=new Tt,this.padding={left:0,top:0,right:0,bottom:0},this.ready=!1,this._readyStateWaitingTask=null,this.supportsGround=!0,this.type=null,this.scale=null,this.updating=!1,this.initialExtentRequired=!0,this.input=new mi,this.navigation=new xi,this.layerViewManager=null,this.analysisViewManager=null,this.isHeightModelInfoRequired=!1,this.width=null,this.height=null,this.resizing=!1,this.suspended=!1,this.viewEvents=new kt.CE(this),this.persistableViewModels=new c.Z,this.requiredFieldsOptions=new Ui,this._isValid=!1,this._readyCycleForced=!1,this._lockedSpatialReference=null,this._userTimeZone=null,this._lockedTimeZone=null,this._userTimeExtent=null,this._lockedTimeExtent=null,this.theme=null,this.handles.add((0,n.YP)((()=>this.preconditionsReady),(e=>{const t=this.ready;if(e?(this._lockedSpatialReference=this.spatialReference,this._lockedTimeZone=this.timeZone,this._lockedTimeExtent=this.timeExtent,Hi.views.add(this)):(this._lockedSpatialReference=null,Hi.views.remove(this)),this.notifyChange("spatialReference"),!e&&t)this.toolViewManager?.detach(),null!=this.analysisViewManager&&this.analysisViewManager.detach(),this.layerViewManager?.clear(),this._teardown();else if(e&&!t){try{this._startup()}catch(e){return void queueMicrotask((()=>{this.fatalError=new u.Z("view:startup-error","View._startup failed",e)}))}null!=this.analysisViewManager&&this.analysisViewManager.attach(),this.toolViewManager.attach()}}),n.Z_))}initialize(){this.addResolvingPromise(Promise.all([this.loadAsyncDependencies(),this.validate()]).then((()=>(this._isValid=!0,(0,n.N1)((()=>this.ready)))))),this.basemapView=new Ct({view:this}),this.layerViewManager=new Fi({view:this,layerViewFilter:e=>this.layerViewFilter?.(e)??!0,layerViewImporter:{importLayerView:e=>this.importLayerView(e),hasLayerViewModule:e=>this.hasLayerViewModule(e)},supportsGround:this.supportsGround}),this.toolViewManager=new ii({view:this}),this.selectionManager=new Nt({view:this}),this.addHandles([(0,n.gx)((()=>"map-content-error"===this.readyState&&!this.spatialReference),(()=>{_.Z.getLogger(this).warn("#spatialReference","no spatial reference could be derived from the currently added map layers")})),(0,n.YP)((()=>this.initialExtentRequired),(e=>this.defaultsFromMap.required={...this.defaultsFromMap.required,extent:e}),n.tX),(0,n.YP)((()=>this.ready),(e=>{this.defaultsFromMap&&(this.defaultsFromMap.suspended=e,this.defaultsFromMap.userSpatialReference=e?this.spatialReference:this._userSpatialReference)}),n.Z_),(0,n.YP)((()=>this._userSpatialReference),(e=>{this.defaultsFromMap&&(this.defaultsFromMap.userSpatialReference=e)}),n.tX)])}destroy(){this.destroyed||(Hi.views.remove(this),this.viewEvents.destroy(),this.allLayerViews.destroy(),this.navigation&&(this.navigation.destroy(),this._set("navigation",null)),this.graphics=(0,f.SC)(this.graphics),this.analyses=(0,f.SC)(this.analyses),this.defaultsFromMap.destroy(),this._set("defaultsFromMap",null),(0,f.SC)(this.analysisViewManager),this.toolViewManager=(0,f.SC)(this.toolViewManager),this.layerViewManager=(0,f.SC)(this.layerViewManager),this.selectionManager=(0,f.SC)(this.selectionManager),this.basemapView=(0,f.SC)(this.basemapView),this.groundView?.destroy(),this.layerViews?.forEach((e=>e.destroy())),this.layerViews.length=0,this.invalidate(),this._emitter.clear(),this.handles.destroy(),this.map=(0,f.SC)(this.map),this.updatingHandles.destroy())}_startup(){this._set("ready",!0)}_teardown(){this._set("ready",!1)}whenReady(){return Promise.resolve(this)}toMap(){return _.Z.getLogger(this).error("#toMap()","Not implemented on this instance of View"),null}get activeTool(){return this.toolViewManager?.activeTool}set activeTool(e){this.toolViewManager&&(this.toolViewManager.activeTool=e)}get animation(){return this._get("animation")}set animation(e){this._set("animation",e)}get center(){return null}get defaultsFromMapSettings(){return{}}get defaultsFromMap(){return new Ei({required:{tileInfo:!1,heightModelInfo:!1,extent:!1},map:()=>this.map,getSpatialReferenceSupport:(e,t)=>this.getSpatialReferenceSupport(e,t),...this.defaultsFromMapSettings})}get extent(){return this._get("extent")}set extent(e){this._set("extent",e)}get heightModelInfo(){return this.getDefaultHeightModelInfo()}get highlights(){return this._get("highlights")??new(c.Z.ofType(ai))([new ai({name:si.b}),new ai({name:si.x,color:si.hG})])}set highlights(e){this._set("highlights",(0,Te.Z)(e,this._get("highlights"),c.Z.ofType(ai)))}get interacting(){return this.navigating}get navigating(){return!1}get preconditionsReady(){return!this.destroying&&!this.destroyed&&!(this.fatalError||!this._isValid||this._readyCycleForced||!this.map||Re.Z.isLoadable(this.map)&&!this.map.loaded||0===this.width||0===this.height||!this.spatialReference||!this._validateSpatialReference(this.spatialReference)||!this._lockedSpatialReference&&!this.defaultsFromMap?.ready||!this.typeSpecificPreconditionsReady)}get resolution(){return 0}set map(e){e!==this._get("map")&&(e?.destroyed&&(_.Z.getLogger(this).warn("#map","The provided map is already destroyed",{map:e}),e=null),Re.Z.isLoadable(e)&&e.load().catch((()=>{})),this.constructed&&!this.destroyed&&(this.forceReadyCycle(),this._lockedSpatialReference=null),this._set("map",e))}get readyState(){if(this.destroyed)return this._get("readyState");if(!this.map)return"missing-map";if("container"in this&&!this.container)return"missing-container";if(this.fatalError)return"rendering-error";if(this.defaultsFromMap?.ready&&!this.spatialReference){const e=!("loaded"in this.map)||this.map.loaded,t=this.map.ground.loaded,i=this.map.basemap?.loaded??!0;return e&&i&&t&&!this.map?.allLayers.length?"empty-map":(this._readyStateWaitingTask||(this._readyStateWaitingTask=(0,me.vr)((e=>(0,y.e4)((0,m.Z)("view-readyState-waiting-delay"),null,e))),this.addHandles(this._readyStateWaitingTask),this.addHandles(this._readyStateWaitingTask,"ready-state-task")),this._readyStateWaitingTask?.finished?"map-content-error":"loading")}return this._readyStateWaitingTask=(0,f.IM)(this._readyStateWaitingTask),this.removeHandles("ready-state-task"),this.ready?"ready":"loading"}get spatialReference(){const e=this._userSpatialReference||this._lockedSpatialReference||this.getDefaultSpatialReference()||null;if(e&&this.defaultsFromMap?.required?.heightModelInfo){const t=e.clone();return t.vcsWkid=this.defaultsFromMap.vcsWkid,t.latestVcsWkid=this.defaultsFromMap.latestVcsWkid,t}return e}set spatialReference(e){const t=!(0,ft.fS)(e,this._get("spatialReference"));this._set("_userSpatialReference",e),t&&(this._set("spatialReference",e),this._spatialReferenceChanged(e))}_spatialReferenceChanged(e){}get stationary(){return!this.animation&&!this.navigating&&!this.resizing}get timeExtent(){return this._userTimeExtent??this._lockedTimeExtent??this.getDefaultTimeExtent()??null}set timeExtent(e){this._userTimeExtent=e}get timeZone(){return this._userTimeZone??this._lockedTimeZone??this.getDefaultTimeZone()??yt.By}set timeZone(e){this._userTimeZone=e,(0,bt.Do)(e)||_.Z.getLogger(this).warn("#timeZone",`the parsed value '${e}' may not be a valid IANA time zone`)}get tools(){return this.toolViewManager?.tools}get initialExtent(){return this.defaultsFromMap?.extent}get cursor(){return this.toolViewManager?.cursor??this._cursor??"default"}set cursor(e){this._cursor=e,this.notifyChange("cursor")}get size(){return[this.width,this.height]}get effectiveTheme(){return this.theme??new Ht}whenLayerView(e){return this.layerViewManager?.whenLayerView(e)??Promise.reject()}getDefaultSpatialReference(){return this.defaultsFromMap?.spatialReference}getDefaultHeightModelInfo(){return(this.map&&"heightModelInfo"in this.map?this.map.heightModelInfo:void 0)??this.defaultsFromMap?.heightModelInfo??null}getDefaultTimeZone(){return null}getDefaultTimeExtent(){return null}importLayerView(e){throw new u.Z("view:importLayerView-missing","importLayerView() not implemented")}hasLayerViewModule(e){return!1}async validate(){}async loadAsyncDependencies(){}invalidate(){this._isValid=!1}getSpatialReferenceSupport(){return{constraints:null}}_validateSpatialReference(e){return null!=this.getSpatialReferenceSupport(e)}when(e,t){return this.isResolved()&&!this.ready&&_.Z.getLogger(this).warn("#when()","Calling view.when() while the view is no longer ready but was already resolved once will resolve immediately. Use reactiveUtils.whenOnce(() => view.ready).then(...) instead."),super.when(e,t)}forceReadyCycle(){this.ready&&((0,n.gx)((()=>this.destroyed||!1===this.preconditionsReady),(()=>this._readyCycleForced=!1),{once:!0}),this._readyCycleForced=!0)}addAndActivateTool(e){this.toolViewManager.tools.add(e),this.activeTool=e}tryFatalErrorRecovery(){this.fatalError=null}static{this.views=new c.Z}};(0,o._)([(0,x.Cb)()],Vi.prototype,"_userSpatialReference",void 0),(0,o._)([(0,x.Cb)()],Vi.prototype,"activeTool",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Vi.prototype,"allLayerViews",void 0),(0,o._)([(0,x.Cb)((0,D.z)(G,"analyses"))],Vi.prototype,"analyses",void 0),(0,o._)([(0,x.Cb)()],Vi.prototype,"animation",null),(0,o._)([(0,x.Cb)()],Vi.prototype,"basemapView",void 0),(0,o._)([(0,x.Cb)()],Vi.prototype,"center",null),(0,o._)([(0,x.Cb)()],Vi.prototype,"defaultsFromMapSettings",null),(0,o._)([(0,x.Cb)()],Vi.prototype,"defaultsFromMap",null),(0,o._)([(0,x.Cb)()],Vi.prototype,"displayFilterEnabled",void 0),(0,o._)([(0,x.Cb)({type:I.Z})],Vi.prototype,"extent",null),(0,o._)([(0,x.Cb)()],Vi.prototype,"fatalError",void 0),(0,o._)([(0,x.Cb)((0,D.z)(gt.J,"graphics"))],Vi.prototype,"graphics",void 0),(0,o._)([(0,x.Cb)()],Vi.prototype,"groundView",void 0),(0,o._)([(0,x.Cb)({readOnly:!0,type:L.Z})],Vi.prototype,"heightModelInfo",null),(0,o._)([(0,x.Cb)({type:c.Z.ofType(ai)})],Vi.prototype,"highlights",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Vi.prototype,"interacting",null),(0,o._)([(0,x.Cb)({constructOnly:!0})],Vi.prototype,"layerViewFilter",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Vi.prototype,"navigating",null),(0,o._)([(0,x.Cb)({readOnly:!0,dependsOn:["fatalError","_isValid","_readyCycleForced","map","map.loaded?","width","height","spatialReference","_lockedSpatialReference","defaultsFromMap.ready","typeSpecificPreconditionsReady"]})],Vi.prototype,"preconditionsReady",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Vi.prototype,"typeSpecificPreconditionsReady",void 0),(0,o._)([(0,x.Cb)({type:c.Z,readOnly:!0})],Vi.prototype,"layerViews",void 0),(0,o._)([(0,x.Cb)()],Vi.prototype,"resolution",null),(0,o._)([(0,x.Cb)({type:Tt})],Vi.prototype,"magnifier",void 0),(0,o._)([(0,x.Cb)({value:null,type:pt})],Vi.prototype,"map",null),(0,o._)([(0,x.Cb)()],Vi.prototype,"padding",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Vi.prototype,"ready",void 0),(0,o._)([(0,x.Cb)()],Vi.prototype,"_readyStateWaitingTask",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Vi.prototype,"readyState",null),(0,o._)([(0,x.Cb)({type:N.Z})],Vi.prototype,"spatialReference",null),(0,o._)([(0,x.Cb)()],Vi.prototype,"stationary",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Vi.prototype,"supportsGround",void 0),(0,o._)([(0,x.Cb)({type:vt.T})],Vi.prototype,"timeExtent",null),(0,o._)([(0,x.Cb)({type:String,nonNullable:!0})],Vi.prototype,"timeZone",null),(0,o._)([(0,x.Cb)()],Vi.prototype,"tools",null),(0,o._)([(0,x.Cb)()],Vi.prototype,"toolViewManager",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Vi.prototype,"type",void 0),(0,o._)([(0,x.Cb)({type:Number})],Vi.prototype,"scale",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Vi.prototype,"updating",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Vi.prototype,"initialExtentRequired",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Vi.prototype,"initialExtent",null),(0,o._)([(0,x.Cb)()],Vi.prototype,"cursor",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Vi.prototype,"input",void 0),(0,o._)([(0,x.Cb)({type:xi,nonNullable:!0})],Vi.prototype,"navigation",void 0),(0,o._)([(0,x.Cb)()],Vi.prototype,"layerViewManager",void 0),(0,o._)([(0,x.Cb)()],Vi.prototype,"analysisViewManager",void 0),(0,o._)([(0,x.Cb)()],Vi.prototype,"selectionManager",void 0),(0,o._)([(0,x.Cb)()],Vi.prototype,"width",void 0),(0,o._)([(0,x.Cb)()],Vi.prototype,"height",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Vi.prototype,"resizing",void 0),(0,o._)([(0,x.Cb)({value:null,readOnly:!0})],Vi.prototype,"size",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Vi.prototype,"suspended",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Vi.prototype,"viewEvents",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Vi.prototype,"persistableViewModels",void 0),(0,o._)([(0,x.Cb)()],Vi.prototype,"_isValid",void 0),(0,o._)([(0,x.Cb)()],Vi.prototype,"_readyCycleForced",void 0),(0,o._)([(0,x.Cb)()],Vi.prototype,"_lockedSpatialReference",void 0),(0,o._)([(0,x.Cb)()],Vi.prototype,"_userTimeZone",void 0),(0,o._)([(0,x.Cb)()],Vi.prototype,"_lockedTimeZone",void 0),(0,o._)([(0,x.Cb)()],Vi.prototype,"_userTimeExtent",void 0),(0,o._)([(0,x.Cb)()],Vi.prototype,"_lockedTimeExtent",void 0),(0,o._)([(0,x.Cb)({type:Ht})],Vi.prototype,"theme",void 0),(0,o._)([(0,x.Cb)({readOnly:!0,type:Ht})],Vi.prototype,"effectiveTheme",null),Vi=Hi=(0,o._)([(0,S.j)("esri.views.View")],Vi);const ki=globalThis.$arcgis;ki&&!ki.views&&Object.defineProperty(ki,"views",{configurable:!1,enumerable:!0,writable:!1,value:Vi.views});const Bi=Vi;function zi(e){return e.layerViews}let Gi=class extends _t.Z{constructor(e){super(e),this.state="running",this.target=null,this._resolver=null}initialize(){this._resolver=(0,y.hh)(),this.addResolvingPromise(this._resolver.promise)}get done(){return"finished"===this.state||"stopped"===this.state}stop(){"stopped"!==this.state&&"finished"!==this.state&&(this._set("state","stopped"),this._resolver?.reject(new u.Z("view:animation-stopped","ViewAnimation stopped")))}finish(){"stopped"!==this.state&&"finished"!==this.state&&(this._set("state","finished"),this._resolver?.resolve())}update(e,t){t||(t=(0,y.y8)(e)?"waiting-for-target":"running"),this._set("target",e),this._set("state",t)}};(0,o._)([(0,x.Cb)({readOnly:!0})],Gi.prototype,"done",null),(0,o._)([(0,x.Cb)({readOnly:!0,type:String})],Gi.prototype,"state",void 0),(0,o._)([(0,x.Cb)()],Gi.prototype,"target",void 0),Gi=(0,o._)([(0,S.j)("esri.views.ViewAnimation")],Gi),function(e){e.State={RUNNING:"running",STOPPED:"stopped",FINISHED:"finished",WAITING_FOR_TARGET:"waiting-for-target"}}(Gi||(Gi={}));const qi=Gi,Zi=()=>Promise.all([i.e(50624),i.e(96317)]).then(i.bind(i,96317)),ji=()=>i.e(27785).then(i.bind(i,27785)),Wi={"base-dynamic":()=>Promise.all([i.e(85360),i.e(41643)]).then(i.bind(i,41643)),"base-elevation":ji,"base-tile":Zi,"bing-maps":Zi,"building-scene":()=>Promise.all([i.e(85330),i.e(55105),i.e(88792),i.e(60541),i.e(98733),i.e(50718),i.e(96526),i.e(40993),i.e(17600),i.e(79383),i.e(49405),i.e(59876),i.e(88534),i.e(81871),i.e(52695),i.e(84182),i.e(61197),i.e(70842),i.e(70352),i.e(90479)]).then(i.bind(i,14424)),catalog:()=>i.e(88366).then(i.bind(i,88366)),"catalog-dynamic-group":()=>i.e(23485).then(i.bind(i,23485)),"catalog-footprint":()=>Promise.all([i.e(55105),i.e(88792),i.e(50718),i.e(17600),i.e(30903),i.e(79383),i.e(88534),i.e(81871),i.e(96477),i.e(26078),i.e(41193),i.e(16435),i.e(68433),i.e(84580)]).then(i.bind(i,84580)),csv:()=>Promise.all([i.e(55105),i.e(88792),i.e(50718),i.e(17600),i.e(30903),i.e(79383),i.e(88534),i.e(81871),i.e(96477),i.e(26078),i.e(41193),i.e(16435),i.e(68433),i.e(4765)]).then(i.bind(i,4765)),dimension:()=>i.e(76284).then(i.bind(i,76284)),elevation:ji,feature:()=>Promise.all([i.e(55105),i.e(88792),i.e(50718),i.e(17600),i.e(30903),i.e(79383),i.e(88534),i.e(81871),i.e(96477),i.e(26078),i.e(41193),i.e(16435),i.e(68433),i.e(34071)]).then(i.bind(i,34071)),geojson:()=>Promise.all([i.e(55105),i.e(88792),i.e(50718),i.e(17600),i.e(30903),i.e(79383),i.e(88534),i.e(81871),i.e(96477),i.e(26078),i.e(41193),i.e(16435),i.e(68433),i.e(44908)]).then(i.bind(i,44908)),graphics:()=>Promise.all([i.e(55105),i.e(88534),i.e(96477),i.e(66144)]).then(i.bind(i,39088)),group:()=>i.e(14919).then(i.bind(i,14919)),imagery:()=>Promise.all([i.e(10215),i.e(85360),i.e(38394),i.e(75357)]).then(i.bind(i,75357)),"integrated-mesh":()=>Promise.all([i.e(55105),i.e(88534),i.e(81871),i.e(52695),i.e(84182),i.e(61197),i.e(82451)]).then(i.bind(i,73051)),"integrated-mesh-3dtiles":()=>i.e(86309).then(i.bind(i,86309)),"line-of-sight":()=>i.e(37826).then(i.bind(i,37826)),"map-image":()=>Promise.all([i.e(85360),i.e(50624),i.e(64467)]).then(i.bind(i,64467)),media:()=>Promise.all([i.e(18208),i.e(23177),i.e(52616)]).then(i.bind(i,15705)),"ogc-feature":()=>Promise.all([i.e(55105),i.e(88792),i.e(50718),i.e(17600),i.e(30903),i.e(79383),i.e(88534),i.e(81871),i.e(96477),i.e(26078),i.e(41193),i.e(16435),i.e(68433),i.e(47714)]).then(i.bind(i,47714)),"open-street-map":Zi,"oriented-imagery":()=>Promise.all([i.e(55105),i.e(88792),i.e(50718),i.e(17600),i.e(30903),i.e(79383),i.e(88534),i.e(81871),i.e(96477),i.e(26078),i.e(41193),i.e(16435),i.e(68433),i.e(34071)]).then(i.bind(i,34071)),"point-cloud":()=>Promise.all([i.e(50718),i.e(17600),i.e(79383),i.e(52695),i.e(16786),i.e(80064)]).then(i.bind(i,59321)),viewshed:()=>i.e(37914).then(i.bind(i,37914)),voxel:()=>i.e(5797).then(i.bind(i,5797)),route:()=>Promise.all([i.e(55105),i.e(88534),i.e(80479),i.e(74989)]).then(i.bind(i,91775)),scene:e=>null==e.profile||"mesh-pyramids"===e.profile?Promise.all([i.e(55105),i.e(50718),i.e(17600),i.e(79383),i.e(88534),i.e(81871),i.e(52695),i.e(84182),i.e(61197),i.e(70352),i.e(12742)]).then(i.bind(i,29834)):Promise.all([i.e(55105),i.e(50718),i.e(17600),i.e(79383),i.e(88534),i.e(81871),i.e(52695),i.e(26078),i.e(84182),i.e(49004)]).then(i.bind(i,8378)),stream:()=>Promise.all([i.e(55105),i.e(88792),i.e(50718),i.e(17600),i.e(30903),i.e(79383),i.e(88534),i.e(81871),i.e(96477),i.e(26078),i.e(16435),i.e(94789)]).then(i.bind(i,67494)),tile:Zi,"imagery-tile":()=>Promise.all([i.e(10215),i.e(38394),i.e(37148)]).then(i.bind(i,71655)),"vector-tile":()=>Promise.all([i.e(89693),i.e(7555)]).then(i.bind(i,7555)),wcs:()=>Promise.all([i.e(10215),i.e(38394),i.e(37148)]).then(i.bind(i,71655)),"web-tile":Zi,wfs:()=>Promise.all([i.e(55105),i.e(88792),i.e(50718),i.e(17600),i.e(30903),i.e(79383),i.e(88534),i.e(81871),i.e(96477),i.e(26078),i.e(41193),i.e(16435),i.e(68433),i.e(97619)]).then(i.bind(i,97619)),wms:()=>Promise.all([i.e(85360),i.e(63987)]).then(i.bind(i,63987)),wmts:()=>i.e(13954).then(i.bind(i,13954)),parquet:null,"geo-rss":null,kml:null,"knowledge-graph":null,"link-chart":null,"knowledge-graph-sublayer":null,"map-notes":null,"subtype-group":null,unknown:null,unsupported:null,video:null};const $i=e=>null!=Wi[e.type],Xi=e=>{const t=Wi[e.type];if(null==t)throw function(e){const t=e.declaredClass?e.declaredClass.slice(e.declaredClass.lastIndexOf(".")+1):"Unknown",i=t.replaceAll(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new u.Z(`${i}:view-not-supported`,`${t} is not supported in 3D`)}(e);return t(e)},Yi="analyses-owner-handles";var Qi,Ki;!function(e){e[e.PENDING=0]="PENDING",e[e.CREATED=1]="CREATED"}(Qi||(Qi={})),function(e){e[e.ADDED=0]="ADDED",e[e.REMOVED=1]="REMOVED"}(Ki||(Ki={}));let Ji=class extends E.Z{constructor(e){super(e),this._allAnalysisViews=new c.Z,this._creatingViewCount=0,this._items=new Map,this._scheduledUpdateHandle=null,this._attachedToViewResolver=er(),this._analysisModules={"area-measurement":{module:null},dimension:{module:null},"direct-line-measurement":{module:null},"line-of-sight":{module:null},slice:{module:null},viewshed:{module:null}},this._emitOnView=(e,t)=>this.view.emit(e,t)}destroy(){this._disconnectOwners(),this._attachedToViewResolver.reject((0,y.zE)("AnalysisViewManager was destroyed"))}attach(){this._connectOwners(),this._attachedToViewResolver.resolve()}detach(){this._disconnectOwners(),this._attachedToViewResolver.reject((0,y.zE)()),this._attachedToViewResolver=er()}get updating(){return!this.view.ready||0!==this._creatingViewCount||this._allAnalysisViews.some((e=>e.updating))}get testInfo(){}async whenAnalysisView(e){await this._attachedToViewResolver.promise;const t=this._items.get(e);if(null==t||t.state.list===Ki.REMOVED)throw new u.Z("AnalysisViewManager:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});return t.createAnalysisViewTask.promise}_connectOwners(){this.addHandles(this._connectAnalysesCollection(this.view.analyses),Yi)}_disconnectOwners(){this.removeHandles(Yi),this._update(),this._creatingViewCount=0}_connectAnalysesCollection(e){for(const t of e)this._addAnalysis(t);const t=e.on("after-add",(e=>this._addAnalysis(e.item))),i=e.on("after-remove",(e=>this._removeAnalysis(e.item)));return(0,p.kB)((()=>{t.remove(),i.remove();for(const t of e)this._removeAnalysis(t)}))}_addAnalysis(e){const t=this._items.get(e);if(null==t){const t={state:{view:Qi.PENDING,list:Ki.ADDED},analysis:e,view:null,createAnalysisViewTask:null};this._items.set(e,t),t.createAnalysisViewTask=(0,me.vr)((i=>this._createAnalysisViewPromise(t,i).then((t=>(this._emitOnView("analysis-view-create",{analysis:e,analysisView:t}),t)),(t=>{throw this._emitOnView("analysis-view-create-error",{analysis:e,error:t}),t}))))}else t.state.list=Ki.ADDED}_removeAnalysis(e){const t=this._items.get(e);null!=t?(t.state.list=Ki.REMOVED,this._scheduleUpdate()):_.Z.getLogger(this).error("Trying to remove analysis which was not added")}_scheduleUpdate(){null==this._scheduledUpdateHandle&&(this._scheduledUpdateHandle=(0,v.Os)((()=>this._update())))}_update(){this._scheduledUpdateHandle=(0,f.hw)(this._scheduledUpdateHandle),this._items.forEach((e=>{if(e.state.list!==Ki.REMOVED)return;const{analysis:t,view:i}=e;switch(this._items.delete(t),e.state.view){case Qi.PENDING:e.createAnalysisViewTask=(0,f.IM)(e.createAnalysisViewTask);break;case Qi.CREATED:null!=i&&(this._allAnalysisViews.remove(i),e.view=(0,f.SC)(i),e.createAnalysisViewTask=null,this._emitOnView("analysis-view-destroy",{analysis:t,analysisView:i}))}}))}async _createAnalysisViewPromise(e,t){const i=e.analysis,r=i.type,s=this._analysisModules[r];if(this._creatingViewCount+=1,null==s.module)try{s.module=await this._loadAnalysisModule(r)}catch(e){throw this._creatingViewCount-=1,e}if((0,y.Hc)(t))throw this._creatingViewCount-=1,(0,y.zE)("AnalysisView creation aborted");const n=new s.module.default({analysis:i,view:this.view});let a=!0;(0,y.fu)(t,(()=>{a&&this._destroyAnalysisView(i,n)}));try{await n.when()}catch(e){throw a=!1,this._destroyAnalysisView(i,n),e}if((0,y.Hc)(t))throw(0,y.zE)();return a=!1,e.view=n,e.state.view=Qi.CREATED,this._allAnalysisViews.add(n),this._creatingViewCount-=1,n}_destroyAnalysisView(e,t){t.destroyed||(this._creatingViewCount-=1,t.destroy(),this._emitOnView("analysis-view-destroy",{analysis:e,analysisView:t}))}_loadAnalysisModule(e){switch(e){case"area-measurement":return Promise.all([i.e(18208),i.e(23177),i.e(43825),i.e(82845),i.e(8455),i.e(48119),i.e(86879),i.e(28342)]).then(i.bind(i,28342));case"dimension":return Promise.all([i.e(18208),i.e(23177),i.e(43825),i.e(82845),i.e(8455),i.e(48119),i.e(86879),i.e(78740),i.e(68597)]).then(i.bind(i,68597));case"direct-line-measurement":return Promise.all([i.e(18208),i.e(23177),i.e(43825),i.e(82845),i.e(8455),i.e(48119),i.e(86879),i.e(88040)]).then(i.bind(i,88040));case"line-of-sight":return Promise.all([i.e(18208),i.e(43825),i.e(82845),i.e(73726)]).then(i.bind(i,34794));case"slice":return Promise.all([i.e(85330),i.e(55105),i.e(88792),i.e(60541),i.e(98733),i.e(96526),i.e(40993),i.e(49405),i.e(59876),i.e(18208),i.e(52695),i.e(43825),i.e(70842),i.e(92889),i.e(27036)]).then(i.bind(i,59362));case"viewshed":return Promise.all([i.e(18208),i.e(43825),i.e(82845),i.e(8455),i.e(37727),i.e(56080)]).then(i.bind(i,44976))}}};function er(){const e=(0,y.hh)();return e.promise.catch((()=>{})),e}(0,o._)([(0,x.Cb)()],Ji.prototype,"updating",null),(0,o._)([(0,x.Cb)({constructOnly:!0})],Ji.prototype,"view",void 0),(0,o._)([(0,x.Cb)()],Ji.prototype,"_allAnalysisViews",void 0),(0,o._)([(0,x.Cb)()],Ji.prototype,"_creatingViewCount",void 0),Ji=(0,o._)([(0,S.j)("esri.views.3d.analysis.AnalysisViewManager3D")],Ji);const tr=Ji;var ir=i(21414),rr=i(22365);let sr=class extends E.Z{constructor(e){super(e),this.collision=new lr,this.distance=1/0,this.minimumPoiDistance=4,this.tilt=null}get altitude(){return this.mode===Si.JY.Local?null:this._get("altitude")||null}set altitude(e){this.mode!==Si.JY.Local?this._set("altitude",e):_.Z.getLogger(this).warn("Altitude constraint is ignored in local scenes")}get mode(){return this.state.viewingMode}clampAltitude(e){return this.altitude?(0,jt.uZ)(e,this.altitude.min,this.altitude.max):e}clampTilt(e,t){if(!this.tilt)return t;const i=this.tilt(e);return(0,jt.uZ)(t,i.min,i.max)}clampDistance(e){return Math.min(e,this.distance)}createDefaultTilt(){return this.mode===Si.JY.Local?this._createDefaultTiltLocal():this._createDefaultTiltGlobal()}createConstantMaxTilt(e){return(t,i=or)=>(i.min=ar.min,i.max=e,i)}_createDefaultTiltLocal(){const e=this.collision.enabled?(0,rr.uV)([[4e3,ar.max],[1e4,(0,jt.Vl)(88)],[6e6,(0,jt.Vl)(88)]]):()=>ar.max;return(t,i=or)=>(i.min=ar.min,i.max=e(t),i)}_createDefaultTiltGlobal(){const e=this.collision.enabled?(0,rr.uV)([[4e3,ar.max],[5e4,(0,jt.Vl)(88)],[6e6,(0,jt.Vl)(88)],[2e7,ar.min]]):(0,rr.uV)([[3e5,ar.max],[3e6,(0,jt.Vl)(88)],[6e6,(0,jt.Vl)(88)],[2e7,ar.min]]);return(t,i=or)=>(i.min=ar.min,i.max=e(t),i)}};(0,o._)([(0,x.Cb)()],sr.prototype,"altitude",null),(0,o._)([(0,x.Cb)({readOnly:!0})],sr.prototype,"collision",void 0),(0,o._)([(0,x.Cb)()],sr.prototype,"distance",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],sr.prototype,"minimumPoiDistance",void 0),(0,o._)([(0,x.Cb)()],sr.prototype,"tilt",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],sr.prototype,"state",void 0),sr=(0,o._)([(0,S.j)("esri.views.3d.state.Constraints")],sr);const nr=function(e){return{min:-2e5,max:4*e.radius}}(ir.sv),ar={min:(0,jt.Vl)(.5),max:(0,jt.Vl)(179.5)},or={min:0,max:0};let lr=class extends E.Z{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};(0,o._)([(0,x.Cb)({type:Boolean})],lr.prototype,"enabled",void 0),(0,o._)([(0,x.Cb)({type:Number})],lr.prototype,"elevationMargin",void 0),lr=(0,o._)([(0,S.j)("esri.views.3d.state.Constraints.CollisionConstraint")],lr);let cr=class extends Be.Z{constructor(){super(...arguments),this.min=nr.min,this.max=nr.max}};(0,o._)([(0,x.Cb)({type:Number})],cr.prototype,"min",void 0),(0,o._)([(0,x.Cb)({type:Number})],cr.prototype,"max",void 0),cr=(0,o._)([(0,S.j)("esri.views.3d.constraints.AltitudeConstraint")],cr);let hr=class extends Be.Z{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}castNear(e){return Math.max(1e-8,e)}get far(){return this._get("far")}set far(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}castFar(e){return Math.max(1e-8,e)}autoUpdate(e,t){"auto"===this.mode&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==t&&this._set("far",t))}};(0,o._)([(0,x.Cb)({type:Number,value:1e-8})],hr.prototype,"near",null),(0,o._)([(0,T.p)("near")],hr.prototype,"castNear",null),(0,o._)([(0,x.Cb)({type:Number,value:1e-8})],hr.prototype,"far",null),(0,o._)([(0,T.p)("far")],hr.prototype,"castFar",null),(0,o._)([(0,x.Cb)({type:["auto","manual"]})],hr.prototype,"mode",void 0),hr=(0,o._)([(0,S.j)("esri.views.3d.constraints.ClipDistanceConstraint")],hr);const ur={min:(0,jt.BV)(ar.min),max:(0,jt.BV)(ar.max)};let dr=class extends Be.Z{constructor(e){super(e),this.mode="auto"}get max(){return this._get("max")}set max(e){this._set("max",e),this.mode="manual"}castMax(e){return(0,jt.uZ)(e,ur.min,ur.max)}autoUpdate(e){"auto"===this.mode&&this._get("max")!==e&&this._set("max",e)}};(0,o._)([(0,x.Cb)({type:["auto","manual"]})],dr.prototype,"mode",void 0),(0,o._)([(0,x.Cb)({type:Number,value:ur.max})],dr.prototype,"max",null),(0,o._)([(0,T.p)("max")],dr.prototype,"castMax",null),dr=(0,o._)([(0,S.j)("esri.views.3d.constraints.TiltConstraint")],dr);let pr=class extends Be.Z{constructor(e){super(e),this.tilt=new dr,this.altitude=new cr,this.clipDistance=new hr}};(0,o._)([(0,x.Cb)({type:dr})],pr.prototype,"tilt",void 0),(0,o._)([(0,x.Cb)({type:cr})],pr.prototype,"altitude",void 0),(0,o._)([(0,x.Cb)({type:hr})],pr.prototype,"clipDistance",void 0),pr=(0,o._)([(0,S.j)("esri.views.3d.constraints.Constraints")],pr);var mr=i(24910),_r=i(70331),fr=i(5052);function gr(e){return(0,ft.fS)(e,_r.HQ)||(0,ft.BZ)(e)?{wkid:fr.W.GCSMARS2000}:(0,ft.fS)(e,_r.VY)||(0,ft.V2)(e)?{wkid:fr.W.GCSMOON2000}:N.Z.WGS84}var yr=i(39355),vr=i(47925),br=i(41629),wr=i(85382);class Cr{constructor(e,t,i,r,s,n,a,o,l=.5){this.coverage=e,this.density=t,this.absorption=i,this.cloudSize=r,this.detailSize=s,this.smoothness=n,this.cloudHeight=a,this.raymarchingSteps=o,this.median=l}}const xr={sunny:new Cr([0,.6],[.03,.03],[0,0],[.9,.9],[.8,.8],[.7,.7],[.05,.05],wr.p.SIXTEEN),cloudy:new Cr([.3,.65],[.2,.4],[0,0],[.85,.85],[.75,.75],[.3,.4],[1,1],wr.p.TWOHUNDRED,.6),rainy:new Cr([.6,.8],[.5,.8],[.1,.5],[.9,.9],[.75,.75],[.5,.5],[1,1],wr.p.TWOHUNDRED,.4),snowy:new Cr([.25,.75],[.3,.3],[0,0],[.95,.95],[.7,.7],[.69,.75],[.3,1],wr.p.HUNDRED,.65),foggy:new Cr([.8,.8],[.5,.5],[0,0],[.95,.95],[.9,.9],[.55,.55],[.3,.3],wr.p.SIXTEEN)};xr.default=xr.sunny;var Tr=i(96373),Sr=i(31865),Mr=i(10934),Er=i(26821),Rr=i(41788),Pr=i(86875),Ar=i(55868),Or=i(58257),Dr=i(29107),Ir=i(65650),Lr=i(51135);class Fr extends Dr.A{constructor(e,t){super(e,t,new Or.J(Ar.a,(()=>i.e(14507).then(i.bind(i,14507)))))}initializePipeline(e){return(0,Lr.sm)({blending:(0,Lr.if)(Ir.zi.CONSTANT_COLOR,Ir.zi.ONE_MINUS_CONSTANT_COLOR,Ir.db.ADD,e.writeTextureChannels===br.uz.RG?[1,1,0,0]:[0,0,1,1]),depthTest:{func:Ir.wb.LEQUAL},colorWrite:Lr.gf})}}var Nr=i(26605),Ur=i(80461),Hr=i(23625);class Vr extends Dr.A{constructor(e,t){super(e,t,new Or.J(Nr.a,(()=>i.e(92550).then(i.bind(i,92550)))))}initializePipeline(e){return(0,Lr.sm)({blending:e.mode===Ur.u.Full?Lr.LW:(0,Lr.wK)(Ir.zi.ZERO,Ir.zi.ONE,Ir.zi.ONE,Ir.zi.ZERO),depthTest:{func:Ir.wb.ALWAYS},colorWrite:Lr.gf})}}var kr=i(31454),Br=i(35928);let zr=class extends E.Z{constructor(e){super(e),this._needsRender=!0,this._passParameters=new Nr.N,this._configuration=new Ur.i,this._fbo=new kr.X(e.context.renderContext.rctx,new Br.X(Hr.a5)),e.context.techniques.precompile(Vr,new Ur.i);const t=new Ur.i;t.mode=Ur.u.WeatherMap,e.context.techniques.precompile(Vr,t)}get textureAtlas(){if(this._texture&&!this._needsRender)return this._texture;this._configuration.mode=this._texture?Ur.u.WeatherMap:Ur.u.Full;const e=this.context.techniques.get(Vr,this._configuration);return e.compiled&&(this._texture=this._render(e)),this._texture}updateWeatherMap(e){(0,Er.fS)(this._passParameters.weatherTile,e)||((0,Er.JG)(this._passParameters.weatherTile,e),this._needsRender=!0)}destroy(){this._fbo=(0,f.M2)(this._fbo)}_render(e){if(!this._fbo)return null;const t=this.context.renderContext.rctx,i=t.getViewport();return t.setViewport(0,0,Hr.a5,Hr.a5),t.bindFramebuffer(this._fbo),t.bindTechnique(e,this.context.renderContext.bind,this._passParameters),t.screen.draw(),t.setViewport(i.x,i.y,i.width,i.height),this._needsRender=!1,this._fbo.colorTexture}};(0,o._)([(0,x.Cb)({constructOnly:!0})],zr.prototype,"context",void 0),zr=(0,o._)([(0,S.j)("esri.views.3d.environment.NoiseTextureAtlas")],zr);var Gr=i(50399),qr=i(78891);let Zr=class extends E.Z{constructor(e){super(e),this._state=(0,yr.t)(br.TH.Idle),this._passParameters=new Ar.C,this._weatherTileCount=128,this._sliceIndex=0,this._tileIndex=0,this._tilesPerSlice=1,this.coverage=(0,jt.t7)(xr.default.coverage[0],xr.default.coverage[1],.5),this.density=(0,jt.t7)(xr.default.density[0],xr.default.density[1],.5),this.absorption=(0,jt.t7)(xr.default.absorption[0],xr.default.absorption[1],.5),this.cloudSize=(0,jt.t7)(xr.default.cloudSize[0],xr.default.cloudSize[1],.5),this.detailSize=(0,jt.t7)(xr.default.detailSize[0],xr.default.detailSize[1],.5),this.smoothness=(0,jt.t7)(xr.default.smoothness[0],xr.default.smoothness[1],.5),this.cloudHeight=(0,jt.t7)(xr.default.cloudHeight[0],xr.default.cloudHeight[1],.5),this.raymarchingSteps=xr.default.raymarchingSteps,this._viewMatrix=(0,Mr.Ue)(),this._dirty=!0,this.running=!0,this._configuration=new wr.t}initialize(){const e=(0,vr.Iu)(this.view.spatialReference);this._passParameters.cloudRadius=.5*e.radius;const t=()=>this.setDirty();this.addHandles([this.view.resourceController.scheduler.registerTask(Gr.T8.CLOUDS_GENERATOR,this),(0,n.YP)((()=>this.coverage),t,n.nn),(0,n.YP)((()=>this.density),t,n.nn),(0,n.YP)((()=>this.absorption),t,n.nn),(0,n.YP)((()=>this.cloudSize),t,n.nn),(0,n.YP)((()=>this.detailSize),t,n.nn),(0,n.YP)((()=>this.smoothness),t,n.nn),(0,n.YP)((()=>this.cloudHeight),t,n.nn),(0,n.YP)((()=>this.raymarchingSteps),t,n.nn)]);const i=(0,Rr.d9)(this._computeWeatherTile());let r=0;this.addHandles((0,n.YP)((()=>{const e=this._computeWeatherTile();return(0,Er.fS)(i,e)||(++r,(0,Er.JG)(i,e)),r}),t))}destroy(){this.destroyCubeMap(),this._passParameters.noiseTexture=(0,f.SC)(this._passParameters.noiseTexture)}_precompileTechniques(){this._configuration.steps=this.raymarchingSteps,this._configuration.writeTextureChannels=br.uz.RG,this.context.techniques.precompile(Fr,this._configuration),this._configuration.writeTextureChannels=br.uz.BA,this.context.techniques.precompile(Fr,this._configuration)}_acquireTechnique(){switch(this.raymarchingSteps){case wr.p.SIXTEEN:this._tilesPerSlice=1;break;case wr.p.HUNDRED:this._tilesPerSlice=4;break;case wr.p.COUNT:case wr.p.TWOHUNDRED:this._tilesPerSlice=8;break;default:(0,Se.Bg)(this.raymarchingSteps)}return this._configuration.writeTextureChannels=1-this.parameters.readChannels,this._configuration.steps=this.raymarchingSteps,this.context.techniques.get(Fr,this._configuration)}_computeWeatherTile(){const{camera:e,environment:t}=this.view,{latitude:i,longitude:r}=e.position;if(null==i||null==r)return Rr.AG;(0,Er.t8)(Xr,(i+90)/180,(r+180)/360);const s=Math.floor(this._weatherTileCount*Math.abs(2*Xr[0]-1));Xr[0]=Math.floor(2*this._weatherTileCount*Xr[0]),Xr[1]=Math.floor(4*(this._weatherTileCount-s)*Xr[1]);let n=0,a=0;if("virtual"!==t?.lighting?.type&&null!=t?.lighting?.date){const e=new Date(t.lighting.date);e.setUTCHours(t.lighting.date.getUTCHours()+(t.lighting.displayUTCOffset??0)),n=31*e.getUTCMonth()+e.getUTCDate(),a=e.getUTCFullYear()}return Xr[0]=(Xr[0]+n)%(2*this._weatherTileCount),Xr[1]=(Xr[1]+a%100)%(4*this._weatherTileCount),Xr}get state(){return this._state.value}set state(e){this._state.value=e}get usedMemory(){return(this._fbo?.usedMemory??0)+(this._passParameters.noiseTexture?.textureAtlas?.usedMemory??0)}_ensureNoiseTexture(){return this._passParameters.noiseTexture??=new zr({context:this.context}),this._passParameters.noiseTexture}_ensureFrameBufferCube(e){const t=this.context.renderContext.rctx;if(null==this._fbo){const i=new Br.X(e,e/2);i.target=Ir.No.TEXTURE_2D_ARRAY,i.depth=6,i.wrapMode=Ir.e8.CLAMP_TO_EDGE,this._fbo=new kr.X(t,i),this.parameters.data=this,this.parameters.absorption=this.absorption,this.parameters.coverage=this.coverage}return t.unbindTexture(this._fbo.colorTexture),this._fbo}get cubeMap(){return this._fbo}get parameters(){return this.context.renderContext.bind.clouds}destroyCubeMap(){this._fbo=(0,f.M2)(this._fbo),this.parameters.data=null}applyPreset(e,t){const i=e.median,r=e=>{const r=(0,jt.t7)(e[0],e[1],i);return t<.5?(0,jt.t7)(e[0],r,2*t):(0,jt.t7)(r,e[1],2*(t-.5))};this.coverage=r(e.coverage),this.density=r(e.density),this.absorption=r(e.absorption),this.cloudSize=r(e.cloudSize),this.detailSize=r(e.detailSize),this.smoothness=r(e.smoothness),this.cloudHeight=r(e.cloudHeight),this.raymarchingSteps=e.raymarchingSteps,this._precompileTechniques()}setDirty(){this._dirty=this.running=!0}runTask(e){if(this.state===br.TH.Fading)return qr.J;this._dirty&&(this._sliceIndex=this._tileIndex=0,this.state=br.TH.Rendering,this._passParameters.absorption=this.absorption,this._passParameters.density=this.density,this._passParameters.cloudSize=this.cloudSize,this._passParameters.detailSize=this.detailSize,this._passParameters.smoothness=this.smoothness,this._passParameters.cloudHeight=this.cloudHeight,this._passParameters.coverage=this.coverage,this._ensureNoiseTexture().updateWeatherMap(this._computeWeatherTile()),this._dirty=!1);const t=this._acquireTechnique();if(!this._ensureNoiseTexture().textureAtlas||!t.compiled)return qr.J;const i=jr[this._sliceIndex],r=Wr[this._sliceIndex];(0,Sr.ji)(this._viewMatrix,$r,i,r),(0,Tr.xO)(this._passParameters.viewMatrix,this._viewMatrix);const s=this.context.renderContext.rctx,n=s.getViewport(),a=Ar.c/this._tilesPerSlice,o=this._tileIndex*a;s.setViewport(0,o,Ar.c,a);const l=this._ensureFrameBufferCube(Ar.c);s.bindFramebuffer(l),this._passParameters.lastSlice=5===this._sliceIndex,s.bindTechnique(t,this.context.renderContext.bind,this._passParameters);const c=Ir.No.TEXTURE_2D_ARRAY;return l.setColorTextureTarget(c,Ir.Ii,this._sliceIndex),s.screen.draw(),s.gl.flush(),s.setViewport(n.x,n.y,n.width,n.height),this.requestRender(),++this._tileIndex,5===this._sliceIndex&&this._tileIndex===this._tilesPerSlice?(this._sliceIndex=this._tileIndex=0,this.state=br.TH.Ready,this.running=!1):this._tileIndex===this._tilesPerSlice&&(++this._sliceIndex,this._tileIndex=0),e.madeProgress(),qr.J}};(0,o._)([(0,x.Cb)({constructOnly:!0})],Zr.prototype,"context",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],Zr.prototype,"view",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],Zr.prototype,"requestRender",void 0),(0,o._)([(0,x.Cb)()],Zr.prototype,"coverage",void 0),(0,o._)([(0,x.Cb)()],Zr.prototype,"density",void 0),(0,o._)([(0,x.Cb)()],Zr.prototype,"absorption",void 0),(0,o._)([(0,x.Cb)()],Zr.prototype,"cloudSize",void 0),(0,o._)([(0,x.Cb)()],Zr.prototype,"detailSize",void 0),(0,o._)([(0,x.Cb)()],Zr.prototype,"smoothness",void 0),(0,o._)([(0,x.Cb)()],Zr.prototype,"cloudHeight",void 0),(0,o._)([(0,x.Cb)()],Zr.prototype,"raymarchingSteps",void 0),(0,o._)([(0,x.Cb)()],Zr.prototype,"running",void 0),Zr=(0,o._)([(0,S.j)("esri.views.3d.environment.CloudsRenderer")],Zr);const jr=[(0,Pr.al)(1,0,0),(0,Pr.al)(-1,0,0),(0,Pr.al)(0,1,0),(0,Pr.al)(0,-1,0),(0,Pr.al)(0,0,1),(0,Pr.al)(0,0,1)],Wr=[(0,Pr.al)(0,0,-1),(0,Pr.al)(0,0,-1),(0,Pr.al)(0,0,-1),(0,Pr.al)(0,0,-1),(0,Pr.al)(0,1,0),(0,Pr.al)(0,1,0)],$r=(0,O.ll)(),Xr=(0,Rr.ll)();var Yr=i(32555),Qr=i(26173),Kr=i(40854),Jr=i(52061),es=i(74826);class ts extends es.K{constructor(){super(...arguments),this.time=0,this.radius=1,this.width=500,this.opacity=0}}class is extends Dr.A{constructor(e,t){super(e,t,new Or.J(Kr.P,(()=>i.e(18383).then(i.bind(i,18383)))),new Map([[Jr.T.POSITION,0],[Jr.T.INSTANCEFEATUREATTRIBUTE,1]]))}initializePipeline(){return(0,Lr.sm)({blending:Lr.Zo,depthTest:{func:Ir.wb.LEQUAL},colorWrite:Lr.gf})}}var rs=i(22567),ss=i(72894),ns=i(52890),as=i(52054),os=i(32420);let ls=class extends as.Z{constructor(){super(...arguments),this.produces="disabled",this.consumes={required:[Qr.CM.OPAQUE_ENVIRONMENT]}}_enable(){this.produces=Qr.CM.OPAQUE_ENVIRONMENT,this.requestRender(os.Xx.UPDATE)}_disable(){this.produces="disabled",this.requestRender(os.Xx.UPDATE)}};(0,o._)([(0,x.Cb)()],ls.prototype,"produces",void 0),(0,o._)([(0,x.Cb)()],ls.prototype,"consumes",void 0),ls=(0,o._)([(0,S.j)("esri.views.3d.webgl-engine.effects.OpaqueEnvironment")],ls);let cs=class extends ls{constructor(){super(...arguments),this.consumes={required:[Qr.CM.TRANSPARENT_ENVIRONMENT]}}_enable(){this.produces=Qr.CM.TRANSPARENT_ENVIRONMENT,this.requestRender(os.Xx.UPDATE)}};(0,o._)([(0,x.Cb)()],cs.prototype,"consumes",void 0),cs=(0,o._)([(0,S.j)("esri.views.3d.webgl-engine.effects.TransparentEnvironment")],cs);var hs=i(32335),us=i(92761),ds=i(15483);let ps=class extends cs{constructor(e){super(e),this._rainSpeed=.1,this._snowSpeed=.01,this._numParticles=0,this._passParameters=new ts,this._configuration=new rs.Y;const{view:t,type:i}=e;this._configuration.type="rainy"===i?rs.H.Rain:rs.H.Snow,t.stage.renderView.techniques.precompile(is,this._configuration),this._passParameters.time=0,this._passParameters.radius=(0,vr.Iu)(t.spatialReference).radius,this.addHandles([(0,n.YP)((()=>t.environment.weather),(e=>{e.type===i&&this.addHandles((0,n.YP)((()=>e.precipitation),(e=>this._adjustParticles(e)),n.tX))}),n.tX)]),this.addHandles((0,n.YP)((()=>t.stage?.renderer.renderContext.bind.clouds.fadeFactor??1),(e=>{this._passParameters.opacity=e,1===e&&(this.removeHandles("opacity"),this.addHandles((0,n.YP)((()=>t.stage?.renderer.renderContext.bind.clouds.opacity??1),(e=>this._passParameters.opacity=e),n.tX),"opacity"))}),n.Z_),"opacity")}initialize(){this.addHandles([(0,n.YP)((()=>this.view.environment.atmosphereEnabled),(e=>e?this._enable():this._disable()),n.tX)])}_adjustParticles(e){const t=e<.5?(0,jt.t7)(0,.35,2*e):(0,jt.t7)(.35,1,2*(e-.5));this._numParticles=ms*t}destroy(){this._numParticles=0,this._vao=(0,f.M2)(this._vao),this._instanceIdBuffer=(0,f.M2)(this._instanceIdBuffer)}fadeOut(e){this.removeAllHandles(),this.addHandles((0,n.YP)((()=>this.renderContext?.bind.clouds.fadeFactor??1),(t=>{this._passParameters.opacity=1-t,1===t&&(this.removeAllHandles(),e())})),"opacity")}updateAnimation(e){const t=("rainy"===this.type?this._rainSpeed:this._snowSpeed)*(0,Yr.D9)(e.time)%1e5;return this._passParameters.time!==t&&(this._passParameters.time=t,!0)}render(e){const t=this.renderingContext;this._instanceIdBuffer??=this._createInstanceIndices(t);const i=Math.round(this._numParticles*this._passParameters.opacity),r=e.find((({name:e})=>e===Qr.CM.TRANSPARENT_ENVIRONMENT));if(i<1)return r;const s=this.techniques.get(is,this._configuration);if(!s.compiled)return this.requestRender(os.Xx.UPDATE),r;const n=t.bindTechnique(s,this.bindParameters,this._passParameters);return this._vao??=function(e,t){const i=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new hs.U(e,t,new Map([["geometry",(0,ss.K)(_s)]]),new Map([["geometry",us.f.createVertex(e,Ir.l1.STATIC_DRAW,i)]]))}(t,s.locations),t.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao),(0,ds.XP)(t,s.locations,this._instanceIdBuffer,fs,0),t.drawArraysInstanced(Ir.MX.TRIANGLES,0,3,i),(0,ds.UF)(t,s.locations,this._instanceIdBuffer,fs),r}_createInstanceIndices(e){const t=[];for(let e=0;e<ms;e++)t.push(e);return us.f.createVertex(e,Ir.l1.STATIC_DRAW,new Float32Array(t))}};(0,o._)([(0,x.Cb)({constructOnly:!0})],ps.prototype,"type",void 0),ps=(0,o._)([(0,S.j)("esri.views.3d.environment.Precipitation")],ps);const ms=25e4,_s=(0,ns.U$)().vec3f(Jr.T.POSITION),fs=(0,ss.K)((0,ns.U$)().f32(Jr.T.INSTANCEFEATUREATTRIBUTE),1);var gs=i(70973),ys=i(20472);let vs=class extends ys.tY{constructor(e){super(e),this.produces=new Map([]),this._clouds=(0,yr.t)(null),this._incarnation=0,this._precipitation=null}initialize(){this.view.stage?.addRenderPlugin(this)}destroy(){this.removeHandles(),this.uninitializeRenderContext(),this.view?.stage?.removeRenderPlugin(this),this._set("view",null)}get updating(){return!!this._clouds.value?.running}get weatherAvailable(){return(0,mr.l)(this.view.state.camera.eye)-(0,vr.Iu)(this.view.spatialReference).radius<=gs.rm}get usedMemory(){return this._clouds.value?.usedMemory??0}_fadeOutPrecipitation(){this._precipitation&&(this._precipitationOutgoing?.destroy(),this._precipitationOutgoing=this._precipitation,this._precipitationOutgoing.fadeOut((()=>{this._precipitationOutgoing=(0,f.SC)(this._precipitationOutgoing)})),this._precipitation=null,++this._incarnation)}get weather(){return this.view?.environmentManager?.weatherEnabled?this.view.environment.weather:null}initializeRenderContext(e){this._context=e;const t=this.view,i=()=>this._requestRender();this.addHandles([(0,n.YP)((()=>this._precipitation),i,n.Z_),(0,n.YP)((()=>this._clouds.value?.state),i,n.Z_),(0,n.YP)((()=>t.state.mode),i,n.Z_),(0,n.YP)((()=>this._updateClouds()),i,n.Z_),(0,n.YP)((()=>this._updatePrecipitation()),i,n.Z_),(0,n.YP)((()=>this.weather),(e=>this._initWeather(e)))])}uninitializeRenderContext(){this._context=null,this._clouds.value=(0,f.SC)(this._clouds.value),this._precipitation=(0,f.SC)(this._precipitation),this._precipitationOutgoing=(0,f.SC)(this._precipitationOutgoing)}prepareRender(e){const{bind:t,time:i}=e;if("local"!==this.view.viewingMode&&t.clouds.data){t.clouds.fade(t.camera,i,this.view.qualitySettings.fadeDuration);const e=this._clouds.value;e&&e.state===br.TH.Idle&&0===e.coverage&&!e.running&&e.destroyCubeMap()}}acquireTechniques(){return[]}render(){}_requestRender(){this._context?.requestRender()}_initWeather(e){const t=this._context;if(!e||!t)return void(this._clouds.value=(0,f.SC)(this._clouds.value));if(this._clouds.value)return;const i=this.view;this._clouds.value=new Zr({context:t,view:i,requestRender:()=>this._requestRender()})}_updateClouds(){const e=this.view.environment.weather;return null==e||null==this._clouds.value||this._clouds.value.applyPreset(xr[e.type],function(e){switch(e.type){case"rainy":case"snowy":case"cloudy":case"sunny":return e.cloudCover;case"foggy":return e.fogStrength}}(e)),++this._incarnation}_updatePrecipitation(){const e=this.view.environment.weather;if(e.type===this._precipitation?.type)return this._incarnation;this._fadeOutPrecipitation();const t="rainy"===e.type||"snowy"===e.type,i=this._context;return t&&i&&(this._precipitation=new ps({view:this.view,type:e.type}),++this._incarnation),this._incarnation}get test(){}hasHighlight(){return!1}};(0,o._)([(0,x.Cb)({constructOnly:!0})],vs.prototype,"view",void 0),(0,o._)([(0,x.Cb)({type:Boolean,readOnly:!0})],vs.prototype,"updating",null),(0,o._)([(0,x.Cb)()],vs.prototype,"weatherAvailable",null),(0,o._)([(0,x.Cb)()],vs.prototype,"_context",void 0),vs=(0,o._)([(0,S.j)("esri.views.3d.environment.EnvironmentRenderer")],vs);var bs=i(32185),ws=i(69069);const Cs={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};class xs{constructor(e,t){this.direct=e,this.ambient=t}}function Ts(e,t,i,r,s,n){(0,mr.i)(n.ambient.color,1,1,1),n.ambient.intensity=Cs.global.ambient,(0,mr.i)(n.direct.color,1,1,1),n.direct.intensity=Cs.global.direct;const a=t[2],o=(0,jt.uZ)((Math.abs(a)-Cs.local.altitude)/(Cs.global.altitude-Cs.local.altitude),0,1);let l;if(n.globalFactor=o,null!=e&&(l=ws.S.getTimes(e,t[1],t[0])),o<1){let t;if(null!=e)t=function(e,t,i){const r=e.valueOf();let s,n;t.polarException===ws.S.PolarException.MIDNIGHT_SUN?(s=r-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,n=s+432e6):t.polarException===ws.S.PolarException.POLAR_NIGHT?(s=r-2,n=r-1):(s=t.sunrise.valueOf(),n=t.sunset.valueOf());const a=n-s,o=s+a/2,l=a/4,c=o-l,h=o+l,u=.06*a,d=s-u/2,p=s+u/2,m=n-u/2,_=n+u/2,f=(0,Rr.Ue)(),g=(0,O.Ue)(),y=(0,O.Ue)();let v="";if(r<d||r>_)(0,Er.JG)(f,Bs),(0,mr.c)(g,Is),(0,mr.c)(y,Us),v="night";else if(r<p){const e=(r-d)/(p-d);(0,Er.t7)(f,Bs,zs,e),(0,mr.m)(g,Is,Ls,e),(0,mr.m)(y,Us,Hs,e),v="sun rising"}else if(r<c){const e=(r-p)/(c-p);(0,Er.t7)(f,zs,Gs,e),(0,mr.m)(g,Ls,Fs,e),(0,mr.m)(y,Hs,Vs,e),v="early morning"}else if(r<o){const e=(r-c)/(o-c);(0,Er.t7)(f,Gs,qs,e),(0,mr.m)(g,Fs,Ns,e),(0,mr.m)(y,Vs,ks,e),v="late morning"}else if(r<h){const e=(r-o)/(h-o);(0,Er.t7)(f,qs,Zs,e),(0,mr.m)(g,Ns,js,e),(0,mr.m)(y,ks,Ws,e),v="early afternoon"}else if(r<m){const e=(r-h)/(m-h);(0,Er.t7)(f,Zs,$s,e),(0,mr.m)(g,js,Xs,e),(0,mr.m)(y,Ws,Ys,e),v="late afternoon"}else if(r<_){const e=(r-m)/(_-m);(0,Er.t7)(f,$s,Bs,e),(0,mr.m)(g,Xs,Is,e),(0,mr.m)(y,Ys,Us,e),v="sun setting"}let b=0;switch(i){case"rainy":case"foggy":b=.8;break;case"snowy":b=.5}b>0&&(Ds(g,b),Ds(y,b));const w=Os(i);return{direct:{intensity:f[0]*w.direct,color:g},ambient:{intensity:f[1]*w.ambient,color:y},timeOfDay:v}}(e,l,r);else{const e=Os(r);t={direct:{intensity:Cs.local.directAtNoon*e.direct,color:(0,O.al)(1,1,1)},ambient:{intensity:Cs.local.ambientAtNoon*e.ambient,color:(0,O.al)(1,1,1)},timeOfDay:"early afternoon"}}(0,mr.m)(n.ambient.color,t.ambient.color,n.ambient.color,o),n.ambient.intensity=(0,jt.t7)(t.ambient.intensity,n.ambient.intensity,o),(0,mr.m)(n.direct.color,t.direct.color,n.direct.color,o),n.direct.intensity=(0,jt.t7)(t.direct.intensity,n.direct.intensity,o),n.specularStrength="rainy"===r||"snowy"===r||"foggy"===r?0:1,n.environmentStrength="rainy"===r?.7:"snowy"===r||"foggy"===r?.75:1}n.noonFactor=null!=e?function(e,t){const i=e.valueOf();let r,s;t.polarException===ws.S.PolarException.MIDNIGHT_SUN?(r=i-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,s=r+432e6):t.polarException===ws.S.PolarException.POLAR_NIGHT?(r=i-2,s=i-1):(r=t.sunrise.valueOf(),s=t.sunset.valueOf());const n=r+(s-r)/2;return 1-(0,jt.uZ)(Math.abs(i-n)/432e5,0,1)}(e,l):1,null!=e?Ms(e,t,i,n.direct.directionToLightSource):Ss(s,i,n.direct.directionToLightSource)}function Ss(e,t,i){t===Si.JY.Global?(0,mr.n)(Ks,e.eye):(0,mr.i)(Ks,0,0,1),(0,mr.g)(Js,e.viewForward,-1);const r=(0,rr.EU)(Js,Ks),s=Math.max(r-2*tn,0),n=.85*s/(s+1),a=Math.max(tn,r-tn-n);(0,Sr.Us)(Qs,-a,e.viewRight),(0,mr.t)(i,Js,Qs),(0,mr.f)(i,i,(0,mr.g)(en,e.viewRight,rn)),(0,mr.n)(i,i)}function Ms(e,t,i,r){const s=As,n=(0,Sr.yR)(Ps);if(i===Si.JY.Global)ws.S.getPosition(e,0,0,s),(0,mr.i)(r,0,0,-1),(0,Sr.lM)(n,n,-s.azimuth),(0,Sr.uD)(n,n,-s.altitude),(0,mr.t)(r,r,n);else{const i=Cs.planarDirection,a=i.globalAngles,o=t[2];let l=(Math.abs(o)-i.localAltitude)/(i.globalAltitude-i.localAltitude);l=(0,jt.uZ)(l,0,1),l<1?(ws.S.getPosition(e,t[1],t[0],s),s.azimuth=(1-l)*s.azimuth+l*a.azimuth,s.altitude=(1-l)*s.altitude+l*a.altitude):(s.azimuth=a.azimuth,s.altitude=a.altitude),(0,mr.i)(r,0,-1,0),(0,Sr.jI)(n,n,-s.azimuth),(0,Sr.lM)(n,n,-s.altitude),(0,mr.t)(r,r,n)}}const Es=(0,O.al)(.5773502691896258,-.5773502691896258,.5773502691896258);class Rs{constructor(){this.ambient={color:(0,O.al)(1,1,1),intensity:.55},this.direct={color:(0,O.al)(1,1,1),intensity:.55,directionToLightSource:(0,O.d9)(Es)},this.noonFactor=.5,this.globalFactor=0,this.specularStrength=1,this.environmentStrength=1}}const Ps=(0,Mr.Ue)(),As={azimuth:0,altitude:0};function Os(e){switch(e){case"disabled":case"sunny":case"cloudy":return new xs(1,1);case"rainy":return new xs(.4,1.2);case"snowy":return new xs(.5,1.3);case"foggy":return new xs(.2,1.6)}}function Ds(e,t){const i=(e[0]+e[1]+e[2])/3;e[0]+=(i-e[0])*t,e[1]+=(i-e[1])*t,e[2]+=(i-e[2])*t}const Is=(0,O.al)(.01,.01,.01),Ls=(0,O.al)(1,.6,.5),Fs=(0,O.al)(1,.98,.98),Ns=(0,O.al)(1,1,1),Us=(0,O.al)(.8,.8,1),Hs=(0,O.al)(.8,.8,1),Vs=(0,O.al)(.98,.98,1),ks=(0,O.al)(1,1,1),Bs=(0,Rr.al)(.01,Cs.local.ambientAtNight),zs=(0,Rr.al)(Cs.local.directAtTwilight,Cs.local.ambientAtTwilight),Gs=(0,Rr.al)(.9*Cs.local.directAtNoon,Cs.local.ambientAtNoon),qs=(0,Rr.al)(Cs.local.directAtNoon,Cs.local.ambientAtNoon),Zs=Gs,js=Fs,Ws=Vs,$s=zs,Xs=Ls,Ys=Hs;new Date(0);const Qs=(0,Mr.Ue)(),Ks=(0,O.Ue)(),Js=(0,O.Ue)(),en=(0,O.Ue)(),tn=.25,rn=.2;var sn=i(81021),nn=i(8562);let an=class extends ae.Z.EventedAccessor{constructor(){super(),this._tmpLightParameters=new Rs,this._defaultLightParameters=new Rs,this._tmpDate=new Date,this._tmpTz={hours:0,minutes:0,seconds:0},this._viewHandlesKey="viewHandles",this._trackingEnabled=!1,this._mainLight=new nn.Eg,this._ambientLight=new nn.Mi,this._moonLight=new nn.AM,this._disableWeather=!1,this._renderer=null,this._resetReferencePosition()}destroy(){this.disconnectView()}get _view(){return this._renderer?.view}get updating(){return!!this._renderer?.updating||!this._canProjectCameraPosition}get weatherEnabled(){return this._view?.environment.atmosphereEnabled&&!this._disableWeather&&this._view?.state?.viewingMode===Si.JY.Global&&(0,ft.N$)(this._view.spatialReference)}get _weatherAvailable(){return this.weatherEnabled&&this._renderer?.weatherAvailable}get referencePositionGeographic(){return this._referencePositionGeographic}get _canProjectCameraPosition(){const e=this._view?.stateManager?.camera?.position?.spatialReference??N.Z.WGS84,t=gr(e);return(0,F.isLoadedOrLoadFor)(e,t)}connectView(e){if(this._renderer)return;this._renderer=new vs({view:e});const t=()=>this._updateRenderParameters(),i=()=>this._cameraHandler();this.addHandles([(0,n.YP)((()=>e.environment.lighting),(e=>this._updateLightingHandler(e)),n.Z_),(0,n.YP)((()=>"virtual"!==e.environment.lighting.type?e.environment.lighting.date:null),(e=>this._lightingDateHandler(e)),n.Z_),(0,n.YP)((()=>e.environment.lighting.directShadowsEnabled),t,n.Z_),(0,n.YP)((()=>e.qualitySettings.ambientOcclusion),t,n.Z_),(0,n.YP)((()=>e.qualitySettings.reflections),t,n.Z_),(0,n.YP)((()=>e.spatialReference),(()=>this._resetReferencePosition(!0)),n.Z_),(0,n.YP)((()=>[e.environment.weather.type,this.weatherEnabled]),(()=>this._updateLighting(null,sn.B.FadeWithWeather)),n.Z_),(0,n.YP)((()=>"snowy"===e.environment.weather.type&&e.environment.weather.snowCover),t,n.Z_),(0,n.YP)((()=>e.environment),(e=>e.setComputeWeatherAvailable((()=>this._weatherAvailable))),n.tX),(0,n.YP)((()=>e.viewingMode),(()=>this._resetReferencePosition(!0)),n.tX),(0,n.YP)((()=>"virtual"!==e.environment.lighting.type&&e.environment.lighting.cameraTrackingEnabled),(e=>this._updateCameraTracking(e)),n.tX),(0,n.YP)((()=>e.state.camera),i,n.tX),(0,n.gx)((()=>this._canProjectCameraPosition),i,n.Z_)],this._viewHandlesKey),this._updateRenderParameters(),this._updateLighting(),this._cameraHandler(),this.notifyChange("updating")}disconnectView(){this.removeHandles(this._viewHandlesKey),this._resetReferencePosition(),this._renderer=(0,f.SC)(this._renderer)}_updateLightingHandler(e){this._updateCameraTracking("virtual"!==e.type&&e.cameraTrackingEnabled),this._lightingDateHandler("virtual"!==e.type?e.date:null),this._updateRenderParameters()}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const e=this._view.environment.lighting;"virtual"!==e?.type&&(e.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){const t=this._view.environment.lighting;if("virtual"!==t?.type){if(e){if(!t.positionTimezoneInfo.autoUpdated&&(this._preupdateTracking(e),null!=this._referencePositionGeographic)){const e=(0,bs.dF)(this._referencePositionGeographic,this._tmpTz);null!=e&&(t.autoUpdate(null,e),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}this._updateLighting(e)}}else this._updateLighting()}_preupdateTracking(e){!this._trackingEnabled&&"virtual"!==this._view.environment.lighting.type&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(e=null){const t=this._view;if(!t.ready)return;const i=t.stateManager.camera;if(!i)return;const{position:r}=i,s=gr(r.spatialReference??N.Z.WGS84);if(!(0,H.K)(r,cn,s)){if(null==this._referencePositionGeographic)return;return this._referencePositionGeographic=null,void this._updateLighting()}this._referencePositionGeographic?(0,mr.G)(this._referencePositionGeographic,cn)||((0,mr.c)(this._referencePositionGeographic,cn),this.notifyChange("referencePositionGeographic")):this._referencePositionGeographic=(0,O.d9)(cn),this._autoUpdateTimezone(this._referencePositionGeographic,e)||this._updateLighting(e)}_updateLighting(e,t=sn.B.Immediate){const i=this._view,{lighting:r}=i.environment,s="virtual"===r.type,n=this._referencePositionGeographic,a=null!=n?this._tmpLightParameters:this._defaultLightParameters;if(n){e??=s?null:r.date;const t=this._weatherAvailable?i.environment.weather.type:"disabled";Ts(e,n,i.state.viewingMode,t,i.state.camera,a)}else s&&Ss(i.state.camera,i.state.viewingMode,a.direct.directionToLightSource);const o=this._mainLight,l=a.direct;(0,mr.g)(o.intensity,l.color,l.intensity*Math.PI),(0,mr.c)(o.direction,l.directionToLightSource),o.specularStrength=a.specularStrength,o.environmentStrength=a.environmentStrength;const c=this._ambientLight;(0,mr.g)(c.intensity,a.ambient.color,a.ambient.intensity);const h=this._moonLight;(0,mr.m)(h.intensity,on,ln,a.globalFactor);const u=(1-.5*a.globalFactor)*(1-.4*a.noonFactor*(1-a.globalFactor));(0,mr.g)(h.intensity,h.intensity,u),(0,mr.c)(h.direction,l.directionToLightSource),this._view.stage?.renderer.updateLighting([o,c,h],a.noonFactor,a.globalFactor,this._weatherAvailable?t:sn.B.Immediate),this._updateRenderParameters()}_autoUpdateTimezone(e,t=null){if("virtual"===this._view.environment.lighting.type||!this._view.environment.lighting.cameraTrackingEnabled||null==e)return!1;const i=this._tmpDate;i.setTime((t||this._view.environment.lighting.date).getTime());const r=(0,bs.dF)(e,this._tmpTz);if(null==r)return!1;let s=this._view.environment.lighting.positionTimezoneInfo;if(s.autoUpdated){if(s.hours===r.hours&&s.minutes===r.minutes&&s.seconds===r.seconds)return!1}else s=r;const n=i.getUTCHours()-(r.hours-s.hours),a=i.getUTCMinutes()-(r.minutes-s.minutes),o=i.getUTCSeconds()-(r.seconds-s.seconds);return i.setUTCHours(n),i.setUTCMinutes(a),i.setUTCSeconds(o),!t&&this._view.environment.lighting.autoUpdate(i,r)}_updateRenderParameters(){const e=this._view.stage;if(!e)return;const t=null==this._referencePositionGeographic||function(e,t){if(t===Si.JY.Global)return!0;const i=Cs.planarDirection;return Math.abs(e)<i.localAltitude}(this._referencePositionGeographic[2],this._view.state.viewingMode);e.renderer.setParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&t,environment:this._view.environment,weatherVisible:this._weatherAvailable,qualitySettings:this._view.qualitySettings})}_resetReferencePosition(e=!1){this._referencePositionGeographic=null,e&&this._cameraHandler()}get test(){}};(0,o._)([(0,x.Cb)({type:Boolean,readOnly:!0})],an.prototype,"updating",null),(0,o._)([(0,x.Cb)()],an.prototype,"_disableWeather",void 0),(0,o._)([(0,x.Cb)()],an.prototype,"weatherEnabled",null),(0,o._)([(0,x.Cb)()],an.prototype,"_weatherAvailable",null),(0,o._)([(0,x.Cb)()],an.prototype,"referencePositionGeographic",null),(0,o._)([(0,x.Cb)()],an.prototype,"_referencePositionGeographic",void 0),(0,o._)([(0,x.Cb)()],an.prototype,"_renderer",void 0),(0,o._)([(0,x.Cb)()],an.prototype,"_canProjectCameraPosition",null),an=(0,o._)([(0,S.j)("esri.views.3d.environment.EnvironmentManager")],an);const on=(0,O.al)(.22,.22,.33),ln=(0,O.al)(.22,.22,.22),cn=(0,O.Ue)();var hn=i(74558),un=i(24127);const dn={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:hn.Z,virtual:un.Z}};var pn=i(47826),mn=i(17733),_n=i(83946);const fn={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:mn.Z,virtual:_n.Z}};let gn=class extends Me.Z{constructor(e){super(e)}clone(){throw new Error("Subclasses of Background should implement their own clone method.")}};(0,o._)([(0,x.Cb)({readOnly:!0,json:{read:!1}})],gn.prototype,"type",void 0),gn=(0,o._)([(0,S.j)("esri.webscene.background.Background")],gn);const yn=gn;var vn,bn=i(88331);let wn=vn=class extends yn{constructor(e){super(e),this.type="color",this.color=new xe.Z([0,0,0,1])}clone(){return new vn(this.cloneProperties())}cloneProperties(){return{color:this.color.clone()}}};(0,o._)([(0,Oe.J)({color:"color"},{readOnly:!0}),(0,x.Cb)({json:{write:{isRequired:!0}}})],wn.prototype,"type",void 0),(0,o._)([(0,x.Cb)((0,bn.aK)({nonNullable:!0,colorRequiredOnWrite:!0}))],wn.prototype,"color",void 0),wn=vn=(0,o._)([(0,S.j)("esri.webscene.background.ColorBackground")],wn);const Cn=wn,xn={base:yn,key:"type",typeMap:{color:Cn}};const Tn={types:xn,json:{read:function(e){return(t,i,r)=>{if(!t)return t;for(const i in e.typeMap)if(t.type===i){const s=new e.typeMap[i];return s.read(t,r),s}}}(xn),write:{overridePolicy:(e,t,i)=>({enabled:!i?.isPresentation})}}};var Sn;const Mn=(e,t,i)=>({enabled:!i?.isPresentation});let En=class extends Me.Z{static{Sn=this}constructor(e){super(e),this.lighting=new mn.Z,this.background=null,this.atmosphereEnabled=!0,this.starsEnabled=!0}set weather(e){(0,gs.b8)(e?.type,_.Z.getLogger(this))&&this._set("weather",e)}clone(){return new Sn(this.cloneConstructProperties())}cloneConstructProperties(){return{lighting:this.lighting&&"virtual"===this.lighting.type?_n.Z.prototype.clone.call(this.lighting):mn.Z.prototype.clone.call(this.lighting),background:(0,Ee.d9)(this.background),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,weather:this.weather.clone()}}};(0,o._)([(0,x.Cb)({types:fn,nonNullable:!0,json:{write:!0}})],En.prototype,"lighting",void 0),(0,o._)([(0,x.Cb)(Tn)],En.prototype,"background",void 0),(0,o._)([(0,x.Cb)({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:Mn}}})],En.prototype,"atmosphereEnabled",void 0),(0,o._)([(0,x.Cb)({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:Mn}}})],En.prototype,"starsEnabled",void 0),(0,o._)([(0,x.Cb)({types:gs.Hr,nonNullable:!0,json:{write:!0},value:new pn.Z})],En.prototype,"weather",null),En=Sn=(0,o._)([(0,S.j)("esri.webscene.Environment")],En);const Rn=En;var Pn;let An=class extends Rn{static{Pn=this}constructor(e){super(e),this.lighting=this.castLighting(),this._computeWeatherAvailable=void 0,this.cachedCameraTrackingEnabled=null}static fromWebsceneEnvironment(e){const t=e.cloneConstructProperties();return new Pn({...t,lighting:t.lighting?"virtual"===t.lighting.type?un.Z.fromWebsceneLighting(t.lighting):hn.Z.fromWebsceneLighting(t.lighting):void 0})}get weatherAvailable(){return this._computeWeatherAvailable?.()??!1}setComputeWeatherAvailable(e){this._computeWeatherAvailable=e}castLighting(e){return this._convertLightingWithDestroy(e)}applyLighting(e){this.lighting=this._convertLightingWithDestroy(e)}_convertLightingWithDestroy(e){const t=this._convertLighting(e);return t!==e&&this.addHandles((0,p.ed)(t)),t}_convertLighting(e){return e?e instanceof hn.Z||e instanceof un.Z?e:e instanceof mn.Z?this.lighting&&"virtual"!==this.lighting.type?this.lighting.cloneWithWebsceneLighting(e):new hn.Z({...e.cloneConstructProperties(),...this.lighting?.cloneNonPersistentConstructProperties()}):e instanceof _n.Z?this.lighting&&"virtual"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e):new un.Z({...e.cloneConstructProperties(),...this.lighting?.cloneNonPersistentConstructProperties()}):(0,M.N7)(dn,e):new hn.Z}clone(){return new Pn({lighting:this.lighting.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:(0,Ee.d9)(this.background)})}cloneWithWebsceneEnvironment(e){return new Pn({weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:(0,Ee.d9)(this.background),...e.cloneConstructProperties(),lighting:this._getLighting(e)})}_getLighting(e){switch(e.lighting.type){case"sun":return this.lighting&&"sun"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e.lighting):hn.Z.fromWebsceneLighting(e.lighting);case"virtual":return this.lighting&&"virtual"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e.lighting):un.Z.fromWebsceneLighting(e.lighting);default:return(0,Se.Bg)(e.lighting),hn.Z.fromWebsceneLighting(e.lighting)}}};(0,o._)([(0,x.Cb)({nonNullable:!0})],An.prototype,"lighting",void 0),(0,o._)([(0,x.Cb)()],An.prototype,"_computeWeatherAvailable",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],An.prototype,"weatherAvailable",null),(0,o._)([(0,T.p)("lighting")],An.prototype,"castLighting",null),An=Pn=(0,o._)([(0,S.j)("esri.views.3d.environment.SceneViewEnvironment")],An);const On=An;var Dn,In,Ln,Fn=i(12659),Nn=i(69055);!function(e){e[e.NONE=0]="NONE",e[e.TILT=1]="TILT",e[e.ALTITUDE=2]="ALTITUDE",e[e.DISTANCE=4]="DISTANCE",e[e.COLLISION=8]="COLLISION",e[e.ALL=15]="ALL",e[e.ALL_EXCEPT_COLLISION=7]="ALL_EXCEPT_COLLISION"}(Dn||(Dn={})),function(e){e[e.NONE=0]="NONE",e[e.ZOOM=1]="ZOOM",e[e.TUMBLE=2]="TUMBLE",e[e.LOOK_AROUND=3]="LOOK_AROUND",e[e.PAN=4]="PAN",e[e.ASCEND=5]="ASCEND"}(In||(In={})),function(e){e[e.TUMBLE=0]="TUMBLE",e[e.LOOK_AROUND=1]="LOOK_AROUND"}(Ln||(Ln={}));class Un{constructor(e=Dn.ALL,t=In.NONE,i=0,r=null,s=null,n=Ln.TUMBLE){this.selection=e,this.interactionType=t,this.interactionFactor=i,this.interactionStartCamera=r,this.interactionDirection=s,this.tiltMode=n}}function Hn(e,t){return 0!=(e&t)}function Vn(e,t,i,r,s,n){0!==e&&(i?(n.min=Math.min(n.min,t),n.max=Math.max(n.max,t)):null!=r?(n.min-=Math.max(0,(t-n.min)*(1-r)),n.max+=Math.max(0,(t-n.max)*(1-r))):s&&(n.min-=Math.max(0,t-n.min-s),n.max+=Math.max(0,t-n.max-s)))}const kn=new Un(Dn.NONE);function Bn(e,t,i,r){return t=t||e.viewForward,(0,mr.c)(r,t),(0,mr.g)(r,r,Math.sign((0,mr.e)(t,i))),r}var zn=i(316);function Gn(e,t,i=kn){if(!function(e,t){const i=e.state.constraints.altitude;return!(!e.state.isGlobal||!i||t.interactionType===In.TUMBLE&&Hn(t.selection,Dn.TILT))}(e,i)||!e.state.constraints.altitude)return 0;const r=function(e,t){return t.min=e.min,t.max=e.max,t}(e.state.constraints.altitude,qn);!function(e,t,i){const r=t.interactionType;if(r===In.NONE)return;const{min:s,max:n}=i,{interactionStartCamera:a,interactionFactor:o}=t;if(!a)return;const l=r===In.TUMBLE||r===In.ZOOM,c=Gn(e,a),h=0===c?0:e.renderCoordsHelper.getAltitude(a.eye);i.min=s,i.max=n,Vn(c,h,l,o,.05*h,i)}(e,i,r);const s=e.renderCoordsHelper.getAltitude(t.eye),n=(0,jt.uZ)(s,r.min,r.max)-s;return Math.abs(n)<=1e-6?0:n}const qn={min:0,max:0},Zn=(0,O.Ue)(),jn=(0,O.Ue)(),Wn=(0,O.Ue)(),$n=(0,O.Ue)();function Xn(e,t,i=kn){if(!e.state.isLocal)return 0;const r=e.state.constraints.distance;if(!e.pointsOfInterest.surfaceOrigin.renderLocation||r===1/0)return 0;Qn.min=0,Qn.max=r,function(e,t,i){const r=t.interactionType;if(r===In.NONE)return;const{min:s,max:n}=i,{interactionStartCamera:a,interactionFactor:o}=t;if(!a)return;const l=r===In.ZOOM||r===In.PAN,c=Xn(e,a),h=0===c?0:Yn(e,a);i.min=s,i.max=n,Vn(c,h,l,o,.05*h,i)}(e,i,Qn);const s=Yn(e,t),n=Qn.max-s;return n>=-1e-6?0:n}function Yn(e,t){const i=e.pointsOfInterest.surfaceOrigin;return i.renderLocation?(0,mr.j)(t.eye,i.renderLocation):0}const Qn={min:0,max:0},Kn=(0,O.Ue)(),Jn=(0,O.Ue)(),ea=(0,O.Ue)(),ta=(0,O.Ue)(),ia=(0,O.Ue)();var ra,sa=i(97750);function na(e,t,i=ra.EYE){const r=e.state.constraints;if(!r.collision.enabled)return!1;const s=(0,sa.wH)(e,t.eye),n=e.renderCoordsHelper.getAltitude(t.eye),a=s+r.collision.elevationMargin;if(n>=a)return!1;const o=(0,mr.l)(t.eye);if((0,mr.d)(aa,t.center,t.eye),t.eye=e.renderCoordsHelper.setAltitude(oa,a,t.eye),i===ra.EYE_AND_CENTER)t.center=(0,mr.f)(aa,t.eye,aa);else if(i===ra.EYE_AND_CENTER_SCALE){const e=(o-n+a)/o;t.center=(0,mr.g)(aa,t.center,e)}return!0}!function(e){e[e.EYE=0]="EYE",e[e.EYE_AND_CENTER=1]="EYE_AND_CENTER",e[e.EYE_AND_CENTER_SCALE=2]="EYE_AND_CENTER_SCALE"}(ra||(ra={}));const aa=(0,O.Ue)(),oa=(0,O.Ue)();var la=i(13340);function ca(e,t,i,r=kn,s){if(!e.state.constraints.tilt)return 0;const n=Math.min(t.relativeElevation*ga,t.distance),a=e.state.constraints.tilt(n,ya);return function(e,t,i){if(t.interactionType===In.NONE)return;const{interactionStartCamera:r,interactionFactor:s}=t;if(!r)return;const{min:n,max:a}=i,o=ca(e,r,kn,t),l=0===o?0:(0,la.L)(e.renderCoordsHelper,r.center,r.eye);i.min=n,i.max=a,t.interactionType===In.TUMBLE?(Hn(t.selection,Dn.ALTITUDE)&&da(e,r,i),Vn(o,l,!0,s,fa,i)):Vn(o,l,!1,s,fa,i)}(e,i,a),r.interactionType===In.TUMBLE&&Hn(r.selection,Dn.ALTITUDE)&&da(e,r.interactionStartCamera,a),i.tiltMode===Ln.LOOK_AROUND||r.tiltMode===Ln.LOOK_AROUND?function(e,t,i,r){switch(r&&(r.requiresTwoSteps=!1),e.viewingMode){case"global":return function(e,t,i,r){const s=function(e,t,i){const r=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,s=r+(0,vr.Iu)(e.spatialReference).radius,n=e.renderCoordsHelper.intersectManifold(t.ray,r,_a);return i.distance=Math.min(t.relativeElevation*ga,t.distance),i.centerIsOnSurface=!1,null!=n?(i.distance=Math.min(t.relativeElevation*ga,(0,mr.j)(t.eye,n)),i.tiltAtCenter=(0,la.L)(e.renderCoordsHelper,n,t.eye),i.centerIsOnSurface=!0):e.state.isLocal?i.tiltAtCenter=(0,la.L)(e.renderCoordsHelper,t.center,t.eye):((0,Nn.j)((0,Nn.b)(Nn.t,s),t.ray,_a),i.distance=Math.min(t.relativeElevation*ga,(0,mr.j)(t.eye,_a)),i.tiltAtCenter=(0,jt.ZF)(-(0,mr.e)(t.viewForward,(0,mr.n)(_a,_a)))),i.radius=s,i.eyeRadius=(0,mr.l)(t.eye),i.constraints=e.state.constraints,i}(e,t,va),n=(0,jt.uZ)(s.tiltAtCenter,i.min,i.max);if(!ha(s.tiltAtCenter-n))return 0;let a,o;return s.centerIsOnSurface?(a=function(e){const{constraints:t,distance:i,tiltAtCenter:r}=e;let s=r,n=t.clampTilt(i,r);const a=ua(e,n);if(t.clampTilt(a,r)===n)return n;let o=0;for(;o<10&&ha(n-s);){const i=(s+n)/2,r=ua(e,i);ha(t.clampTilt(r,i)-i)?s=i:n=i,o++}return n}(s),o=function(e,t){const i=(0,jt.Kt)(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),r=(0,jt.Kt)(e.radius/e.eyeRadius*Math.sin(t));return e.eyeRadius>e.radius?i-r:r-i}(s,a)):(a=s.constraints.clampTilt(s.distance,s.tiltAtCenter),r&&a<Math.PI/2&&(r.requiresTwoSteps=!0,a=Math.PI/2-1e-5),o=function(e,t){return e.tiltAtCenter-Math.PI/2-(t-Math.PI/2)}(s,a)),r&&(r.eyeCenterDistance=ua(s,a)),o}(e,t,i,r);case"local":return function(e,t,i,r){const s=(0,la.L)(e.renderCoordsHelper,t.center,t.eye),n=(0,jt.uZ)(s,i.min,i.max),a=s-n;if(!ha(a))return 0;if(r){const i=Math.abs(e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude),s=e.renderCoordsHelper.getAltitude(t.eye)-i,a=Math.max(Math.cos(n),1e-4);Math.abs(a)>1e-4?r.eyeCenterDistance=s/a:r.eyeCenterDistance=t.distance}return a}(e,t,i,r)}}(e,t,a,s):function(e,t,i){const r=(0,la.L)(e.renderCoordsHelper,t.center,t.eye),s=r-(0,jt.uZ)(r,i.min,i.max);return ha(s)?s:0}(e,t,a)}function ha(e){return Math.abs(e)>1e-9}function ua(e,t){if(!e.centerIsOnSurface)return e.distance;const i=Math.PI-(0,jt.uZ)(t,0,Math.PI),r=(0,jt.Kt)(e.radius/e.eyeRadius*Math.sin(i)),s=Math.PI-i-r,n=Math.sin(s)/Math.sin(i);if(e.eyeRadius<e.radius&&n>1){const t=Math.PI-r,s=Math.PI-i-t;return Math.sin(s)/Math.sin(i)*e.eyeRadius}return n*e.eyeRadius}function da(e,t,i){const r=e.state.constraints;if(e.state.isLocal||!r.altitude||!t)return;const s=(0,mr.k)(t.center),n=Math.sqrt(s),a=t.distance,o=(0,vr.Iu)(e.spatialReference).radius,l=r.altitude.min+o,c=r.altitude.max+o,h=(l*l-a*a-s)/(-2*n*a),u=(c*c-a*a-s)/(-2*n*a);i.min=Math.max(i.min,Math.min(Math.PI-(0,jt.ZF)(u),i.max)),i.max=Math.min(i.max,Math.PI-(0,jt.ZF)(h))}const pa=(0,O.Ue)(),ma=(0,Mr.Ue)(),_a=(0,O.Ue)(),fa=(0,jt.Vl)(5),ga=30,ya={min:0,max:0},va={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,distance:0,tiltAtCenter:0},ba={eyeCenterDistance:0,requiresTwoSteps:!1};var wa=i(87224);const Ca=e=>e*e,xa=e=>1-Ca(1-e),Ta=e=>e<.5?Ca(2*e)/2:(xa(2*(e-.5))+1)/2,Sa=e=>e*e*e,Ma=e=>1-Sa(1-e),Ea=e=>e<.5?Sa(2*e)/2:(Ma(2*(e-.5))+1)/2,Ra=e=>e*e*e*e,Pa=e=>1-Ra(1-e),Aa=e=>e<.5?Ra(2*e)/2:(Pa(2*(e-.5))+1)/2,Oa=e=>e*e*e*e*e,Da=e=>1-Oa(1-e),Ia=e=>e<.5?Oa(2*e)/2:(Da(2*(e-.5))+1)/2,La=e=>1-Math.cos(e*Math.PI/2),Fa=e=>1-La(1-e),Na=e=>e<.5?La(2*e)/2:(Fa(2*(e-.5))+1)/2,Ua=e=>2**(10*(e-1)),Ha=e=>1-Ua(1-e),Va=e=>e<.5?Ua(2*e)/2:(Ha(2*(e-.5))+1)/2,ka=e=>-(Math.sqrt(1-e*e)-1),Ba=e=>1-ka(1-e),za=e=>e<.5?ka(2*e)/2:(Ba(2*(e-.5))+1)/2;function Ga(e){const t=2*(e-Math.sqrt((e-1)*e)),i=t/2/e;return r=>r<i?e*r*r:t*r-t+1}function qa(e,t){return(i,r)=>i<t?t*e(i/t,r):1-e((1-i)/(1-t),r)*(1-t)}const Za=qa(Ga(1),1),ja=qa(Ga(1),0),Wa=qa(Ga(1),.5),$a=qa(Ga(2),1),Xa=qa(Ga(2),0),Ya=qa(Ga(2),.5),Qa=qa(Ga(3),1),Ka=qa(Ga(3),0),Ja=qa(Ga(3),.5),eo=qa(Ga(4),1),to=qa(Ga(4),0),io=qa(Ga(4),.5),ro={linear:e=>e,"in-quad":Ca,"out-quad":xa,"in-out-quad":Ta,"in-coast-quad":Za,"out-coast-quad":ja,"in-out-coast-quad":Wa,"in-cubic":Sa,"out-cubic":Ma,"in-out-cubic":Ea,"in-coast-cubic":$a,"out-coast-cubic":Xa,"in-out-coast-cubic":Ya,"in-quart":Ra,"out-quart":Pa,"in-out-quart":Aa,"in-coast-quart":Qa,"out-coast-quart":Ka,"in-out-coast-quart":Ja,"in-quint":Oa,"out-quint":Da,"in-out-quint":Ia,"in-coast-quint":eo,"out-coast-quint":to,"in-out-coast-quint":io,"in-sine":La,"out-sine":Fa,"in-out-sine":Na,"in-expo":Ua,"out-expo":Ha,"in-out-expo":Va,"in-circ":ka,"out-circ":Ba,"in-out-circ":za,"quad-in":Ca,"quad-out":xa,"quad-in-out":Ta,"quad-in-coast":Za,"quad-out-coast":ja,"quad-in-out-coast":Wa,"cubic-in":Sa,"cubic-out":Ma,"cubic-in-out":Ea,"cubic-in-coast":$a,"cubic-out-coast":Xa,"cubic-in-out-coast":Ya,"quart-in":Ra,"quart-out":Pa,"quart-in-out":Aa,"quart-in-coast":Qa,"quart-out-coast":Ka,"quart-in-out-coast":Ja,"quint-in":Oa,"quint-out":Da,"quint-in-out":Ia,"quint-in-coast":eo,"quint-out-coast":to,"quint-in-out-coast":io,"sine-in":La,"sine-out":Fa,"sine-in-out":Na,"expo-in":Ua,"expo-out":Ha,"expo-in-out":Va,"circ-in":ka,"circ-out":Ba,"circ-in-out":za,ease:e=>wa.LI.ease(e),"ease-in":e=>wa.LI.easeIn(e),"ease-out":e=>wa.LI.easeOut(e),"ease-in-out":e=>wa.LI.easeInOut(e)};function so(e,t,i=oo,r=t){r!==t&&r.copyFrom(t),r.computeUp(e.state.viewingMode);let s=!1;for(let t=0;t<lo;t++){let t=0;for(const n of ao)if(Hn(i.selection,n.type)){const a=Math.abs(n.error(e,r,i));n.apply(e,r,i)&&(s=!0,t+=a)}if(0===t)break}const n=Hn(i.selection,Dn.COLLISION),a=function(e,t){switch(e){case In.PAN:return ra.EYE_AND_CENTER;case In.ASCEND:return t.state.isGlobal?ra.EYE_AND_CENTER_SCALE:ra.EYE_AND_CENTER;default:return ra.EYE}}(i.interactionType,e);return n&&na(e,r,a)&&(s=!0),s&&r.computeUp(e.state.viewingMode),s}function no(e){const t=Math.min(1,e/150);return Ea(t)}const ao=[{type:Dn.TILT,error:function(e,t,i){return ca(e,t,i)*t.distance},apply:function e(t,i,r,s=!0){ba.eyeCenterDistance=0,ba.requiresTwoSteps=!1;const n=ca(t,i,r,kn,ba);if(0===n)return!1;switch((0,Sr.Us)(ma,-n,i.viewRight),r.tiltMode){case Ln.LOOK_AROUND:(0,mr.t)(pa,i.viewForward,ma),(0,mr.g)(pa,pa,ba.eyeCenterDistance),i.center=(0,mr.f)(_a,i.eye,pa);break;case Ln.TUMBLE:(0,mr.d)(pa,i.center,i.eye),(0,mr.t)(pa,pa,ma),i.eye=(0,mr.d)(_a,i.center,pa);break;default:(0,Se.Bg)(r.tiltMode)}return i.up=(0,mr.t)(_a,i.up,ma),!ba.requiresTwoSteps||!s||e(t,i,r,!1)}},{type:Dn.ALTITUDE,error:Gn,apply:function(e,t,i=kn){const r=Gn(e,t,i);if(0===r)return!1;const s=e.renderCoordsHelper,n=s.getAltitude(t.eye)+r,a=Bn(t,i.interactionDirection,function(e,t,i,r){return e.renderCoordsHelper.worldUpAtPosition(t.eye,r),(0,mr.g)(r,r,i),r}(e,t,Math.sign(r),jn),Zn),o=(0,mr.c)(Wn,t.viewForward),l=s.intersectInfiniteManifold((0,Fn.re)(t.eye,a),n,$n);return t.eye=null!=l?l:s.setAltitude($n,n,t.eye),t.center=(0,zn.W8)($n,t.eye,o,t.center),!0}},{type:Dn.DISTANCE,error:Xn,apply:function(e,t,i=kn){const r=Xn(e,t,i);if(0===r)return!1;const s=e.pointsOfInterest.surfaceOrigin;if(!s.renderLocation)return!1;const n=Yn(e,t)+r,a=(0,mr.c)(Kn,t.eye),o=Bn(t,i.interactionDirection,function(e,t,i){return(0,mr.E)(i,e.eye,t)}(t,s.renderLocation,ta),ea);if(!(0,Nn.i)((0,Nn.l)(s.renderLocation,n),(0,Fn.re)(t.eye,o),ia))return!1;t.eye=ia;const l=(0,mr.d)(Jn,t.eye,a);t.center=(0,mr.f)(ia,t.center,l);const c=e.renderCoordsHelper.getAltitude(t.center),h=e.renderCoordsHelper.intersectInfiniteManifold(t.ray,c,ia);return null!=h&&(t.center=h),!0}}],oo=new Un,lo=5;var co=i(30748);class ho{get pitch(){return this._pitch}get yaw(){return this._yaw}get distance(){return this._distance}get fov(){return this._fov}get size(){return this._size}constructor(e){this.viewingMode=e,this.center=(0,O.Ue)(),this._pitch=0,this._yaw=0,this._distance=0,this.direction=(0,O.d9)(vo),this._fov=55,this._size=1}pixelsPerPanAtZoom(e){return this._size/2/(this._zoomToPanScale*e)}zoomAtPixelsPerPan(e){return this._size/2/(this._zoomToPanScale*e)}pixelsPerRotate(){const e=Math.max(Math.cos(Math.abs(this._pitch)),.5);return this._size/2/e}compareTo(e,t){if(this.viewingMode===Si.JY.Global){const i=((0,mr.l)(this.center)+(0,mr.l)(e.center))/2;t.pan=(0,rr.EU)(this.center,e.center)*i}else t.pan=(0,mr.j)(this.center,e.center);let i=Math.abs(e._yaw-this._yaw);i>=Math.PI&&(i=2*Math.PI-i);const r=Math.abs(e._pitch-this._pitch);t.rotate=Math.max(i,r),t.fov=e.fov-this.fov,t.sourceZoom=this._distance,t.targetZoom=e._distance}interpolate(e,t,i){this.viewingMode===Si.JY.Global?(0,rr.ZA)(e.center,t.center,i.pan,this.center):(0,mr.m)(this.center,e.center,t.center,i.pan),this._distance=isFinite(t.distance)?(0,jt.t7)(e.distance,t.distance+i.zoomOffset,i.zoom):e.distance,this._pitch=(0,jt.t7)(e.pitch,t.pitch,i.rotate);let r=e._yaw;const s=t._yaw;Math.abs(s-r)>=Math.PI&&(r+=2*(r<s?1:-1)*Math.PI),this._yaw=(0,jt.t7)(r,s,i.rotate),this._fov=(0,jt.t7)(e.fov,t.fov,i.fov)}copyFrom(e){(0,mr.c)(this.center,e.center),this._pitch=e.pitch,this._yaw=e.yaw,this._distance=e.distance,(0,mr.c)(this.direction,e.direction),this._size=e.size,this._fov=e.fov,this._zoomToPanScale=Math.atan(.5*this._fov),this.viewingMode=e.viewingMode}copyFromRenderCamera(e){const t=this._lookAtOrientation(e.center,wo);(0,mr.c)(this.center,e.center),(0,mr.d)(_o,e.center,e.eye),(0,mr.o)(_o,_o,t),(0,mr.o)(fo,e.up,t),this._distance=(0,mr.l)(_o),0!==this._distance&&(_o[0]/=this._distance,_o[1]/=this._distance,_o[2]/=this._distance),this._pitch=function(e){return Math.PI-(0,rr.EU)(yo,e)}(_o),this._yaw=function(e,t){const i=go;return Math.abs(t[2])<.5?((0,mr.c)(i,t),e[2]>0&&(0,mr.g)(i,i,-1)):(0,mr.c)(i,e),(0,mr.h)(po,i,yo),(0,mr.n)(po,po),(0,rr.EU)(bo,po,yo)}(_o,fo),this._size=Math.sqrt(e.width*e.width+e.height*e.height),this._fov=e.fov,this._zoomToPanScale=Math.atan(.5*this._fov)}copyToRenderCamera(e){const t=this._lookAtOrientation(this.center,wo);(0,Tr.p4)(t,t),this._axisAngleVec3(bo,this._pitch-Math.PI/2,vo,_o),this._axisAngleVec3(yo,this._yaw,_o,_o),this._axisAngleVec3(bo,this._pitch-Math.PI/2,yo,fo),this._axisAngleVec3(yo,this._yaw,fo,fo),(0,mr.g)(_o,_o,this._distance),(0,mr.o)(_o,_o,t),(0,mr.o)(fo,fo,t),e.center=this.center,e.eye=(0,mr.d)(_o,this.center,_o),e.up=fo,e.fov=this._fov}_axisAngleVec3(e,t,i,r){const s=Math.cos(t),n=Math.sin(t);return(0,mr.g)(uo,i,s),(0,mr.h)(po,e,i),(0,mr.g)(po,po,n),(0,mr.g)(mo,e,(1-s)*(0,mr.e)(e,i)),(0,mr.f)(r,(0,mr.f)(r,uo,po),mo)}_lookAtOrientation(e,t=(0,co.Ue)()){return this._upAtLookAt(e,mo),(0,mr.h)(uo,this.direction,mo),(0,mr.n)(uo,uo),0===uo[0]&&0===uo[1]&&0===uo[2]&&(0,mr.c)(uo,bo),(0,mr.h)(po,mo,uo),(0,mr.n)(po,po),t[0]=uo[0],t[1]=po[0],t[2]=mo[0],t[3]=uo[1],t[4]=po[1],t[5]=mo[1],t[6]=uo[2],t[7]=po[2],t[8]=mo[2],t}_upAtLookAt(e,t){return this.viewingMode===Si.JY.Local?(0,mr.c)(t,yo):(0,mr.n)(t,e)}}const uo=(0,O.Ue)(),po=(0,O.Ue)(),mo=(0,O.Ue)(),_o=(0,O.Ue)(),fo=(0,O.Ue)(),go=(0,O.Ue)(),yo=O.eG,vo=O.IO,bo=O.E9,wo=(0,co.Ue)();var Co=i(66130);class xo{constructor(){this.pan=0,this.rotate=0,this.fov=0,this.sourceZoom=0,this.targetZoom=0}}const To={desiredScreenFlow:2,minDuration:(0,Yr.HA)(500),maxDuration:(0,Yr.HA)(8e3)};(0,Yr.HA)(4e3);class So{constructor(e){this._createCamera=e,this.compared=new xo,this.segmentStart=0,this.segmentEnd=1,this.settings={desiredScreenFlow:To.desiredScreenFlow},this.source=e(),this.target=e()}clone(){const e=new So(this._createCamera);return e.copyFrom(this),e}copyFrom(e){this.update(e.source,e.target,e.settings)}update(e,t,i){this.source!==e&&this.source.copyFrom(e),this.target!==t&&this.target.copyFrom(t),this.source.compareTo(this.target,this.compared),this.settings.desiredScreenFlow=i.desiredScreenFlow??To.desiredScreenFlow,this.desiredPixelFlow=this.settings.desiredScreenFlow*this.target.size,this.halfWindowSize=this.target.size/2}halfWindowPanAtZoom(e){const t=this.target.pixelsPerPanAtZoom(e);return this.halfWindowSize/t}get hasZoom(){return Math.abs(this.compared.sourceZoom-this.compared.targetZoom)>1e-5}get hasPan(){return this.compared.pan>(0,Co.bn)()}get hasFov(){return Math.abs(this.compared.fov)>(0,Co.bn)()}get hasRotate(){return this.compared.rotate>(0,Co.bn)()}}let Mo=class{constructor(){this.segments=new Array}get time(){return this.segments.reduce(((e,t)=>(0,Yr._H)(e+t.time)),(0,Yr._H)(0))}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1),e*=this.time;let i=0,r=0;const s=this.definition,n=this.segments.reduce(((e,t)=>e||t.definition.hasZoom),!1);for(let a=0;a<this.segments.length;a++){const o=this.segments[a],l=o.definition;if(e<=o.time||a===this.segments.length-1){if(this.segmentInterpolateComponentsAt(o,0===o.time?0:e/o.time,t),s.hasPan&&!isNaN(t.pan)&&isFinite(s.compared.pan)?t.pan=(i+l.compared.pan*t.pan)/s.compared.pan:t.pan=1,s.hasRotate&&!isNaN(t.rotate)&&isFinite(s.compared.rotate)?t.rotate=(r+l.compared.rotate*t.rotate)/s.compared.rotate:t.rotate=1,n&&!isNaN(t.zoom)&&isFinite(l.compared.targetZoom)){const{sourceZoom:e,targetZoom:i}=l.compared,r=t.zoom*(i-e)+e,s=this.segments[0].definition.compared.sourceZoom,n=this.segments[this.segments.length-1].definition.compared.targetZoom,a=Math.abs(i-s)>Math.abs(e-s)?i:e;t.zoomOffset=a-n,t.zoom=(r-s)/(a-s)}else t.zoom=1;return t}e-=o.time,i+=l.compared.pan,r+=l.compared.rotate}}segmentInterpolateComponentsAt(e,t,i){e.interpolateComponentsAt(t,i)}};class Eo{get time(){return this._time}constructor(e){e&&this.update(e)}update(e){e&&(this.definition?this.definition.copyFrom(e):this.definition=e.clone()),this._updatePrecomputedVariables(),this._updatePixelFlow()}_updatePrecomputedVariables(){const e=this.definition,t=e.compared,i=t.sourceZoom,r=t.targetZoom;this._zoomSign=i>r?1:-1,this._panPixelsAtSource=t.pan*e.source.pixelsPerPanAtZoom(i);const s=(e.source.pixelsPerRotate()+e.target.pixelsPerRotate())/2;this._rotatePixels=t.rotate*s}_updatePixelFlow(){const e=this.definition.compared.sourceZoom,t=this.definition.compared.targetZoom,{hasZoom:i,hasPan:r,hasRotate:s}=this.definition;let n=0,a=0;i&&(r&&(n=(t/e-1)/(-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2*this._panPixelsAtSource)),s&&(a=this._zoomSign*(Math.log(e/t)/Math.LN2)*this.definition.halfWindowSize/this._rotatePixels)),this._zoomPixelFlow=0,this._panPixelFlow=0,this._rotatePixelFlow=0;const o=this.definition.desiredPixelFlow;if(i&&r&&s){const e=n+a+n*a;this._zoomPixelFlow=n*a/e*o,this._panPixelFlow=a/e*o,this._rotatePixelFlow=n/e*o}else if(i&&r){const e=1+n;this._zoomPixelFlow=n/e*o,this._panPixelFlow=1/e*o}else if(i&&s){const e=1+a;this._zoomPixelFlow=a/e*o,this._rotatePixelFlow=1/e*o}else if(r&&s){const e=this._panPixelsAtSource/this._rotatePixels,t=1+e;this._panPixelFlow=e/t*o,this._rotatePixelFlow=1/t*o}else r?this._panPixelFlow=o:i?this._zoomPixelFlow=o:s&&(this._rotatePixelFlow=o);if(this._time=(0,Yr._H)(Math.max(this.rotateTime,this.zoomTime,this.panTime)),this.fovTime>this._time){const e=this.fovTime/this._time;this._time=this.fovTime,this._zoomPixelFlow/=e,this._panPixelFlow/=e,this._rotatePixelFlow/=e}}get rotateTime(){return this.definition.hasRotate?(0,Yr._H)(this._rotatePixels/this._rotatePixelFlow):(0,Yr._H)(0)}get zoomTime(){return this.definition.hasZoom?(0,Yr._H)(this._zoomSign*(Math.log(this.definition.compared.sourceZoom/this.definition.compared.targetZoom)/Math.LN2)*this.definition.halfWindowSize/this._zoomPixelFlow):(0,Yr._H)(0)}get fovTime(){return this.definition.hasFov?(0,Yr._H)(Math.abs(this.definition.compared.fov)/Ro):(0,Yr._H)(0)}get panTime(){if(!this.definition.hasPan)return(0,Yr._H)(0);if(this.definition.hasZoom){const e=-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2,t=e*this._panPixelsAtSource;return(0,Yr._H)(Math.log(t*(this._zoomPixelFlow/this._panPixelFlow)+1)/(e*this._zoomPixelFlow))}return(0,Yr._H)(this._panPixelsAtSource/this._panPixelFlow)}_interpolateComponentsZoom(e){if(0===e||1===e)return e;if(this.definition.hasZoom){const t=this.definition.compared.sourceZoom,i=this.definition.compared.targetZoom;return(t*(t/i)**-e-t)/(i-t)}return e}_interpolateComponentsFov(e){if(0===e)return this.definition.segmentStart;if(1===e)return this.definition.segmentEnd;if(this.definition.hasFov){const{segmentStart:t,segmentEnd:i}=this.definition;return t+e*(i-t)}return this.definition.segmentStart}_interpolateComponentsPan(e){if(0===e||1===e)return e;if(this.definition.hasPan&&this.definition.hasZoom){const t=-1/(this._zoomSign*this.definition.halfWindowSize)*this._zoomPixelFlow;return 1/this._panPixelsAtSource*(this._panPixelFlow*(2**(t*e*this._time)-1))/(t*Math.LN2)}return e}_interpolateComponentsRotate(e){return e}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1),t.zoom=this._interpolateComponentsZoom(e),t.pan=this._interpolateComponentsPan(e),t.rotate=this._interpolateComponentsRotate(e),t.zoomOffset=0,t.fov=this._interpolateComponentsFov(e)}}const Ro=(0,jt.Vl)(45);function Po(e,t,i){const r=t-e.compared.sourceZoom,s=e.halfWindowPanAtZoom(r);return-e.halfWindowSize*(i.ascensionFactor*Math.LN2*e.compared.pan+s)*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2*s)}function Ao(e,t,i){const r=1/t,s=Math.log(e.compared.sourceZoom*r),n=1/e.desiredPixelFlow,a=1/Math.LN2,o=t-e.compared.sourceZoom,l=1/o,c=(i.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(o))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*r*n*a*l*c-e.halfWindowSize*s*n*a*l+e.halfWindowSize*s*n*a*c/(o*o)}function Oo(e,t,i){const r=t-e.compared.sourceZoom,s=1/r,n=1/t,a=Math.log(e.compared.sourceZoom*n),o=(i.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(r))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*s*(-2*s*n*o+2*s*a+2*n-2*a*o/(r*r)-o/(t*t))/(e.desiredPixelFlow*Math.LN2)}function Do(e,t){return-e.halfWindowSize*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2)}function Io(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function Lo(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}function Fo(e,t,i){return e.halfWindowSize*(-e.halfWindowPanAtZoom(t)-i.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*e.halfWindowPanAtZoom(-t+e.compared.targetZoom))}function No(e,t,i){const r=Math.log(t/e.compared.targetZoom),s=1/e.desiredPixelFlow,n=1/Math.LN2,a=-t+e.compared.targetZoom,o=1/a,l=(-e.halfWindowPanAtZoom(t)-i.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return-e.halfWindowSize*r*s*n*o+e.halfWindowSize*r*s*n*l/(a*a)+e.halfWindowSize*s*n*o*l/t}function Uo(e,t,i){const r=t-e.compared.targetZoom,s=1/r,n=1/t,a=Math.log(t/e.compared.targetZoom),o=(e.halfWindowPanAtZoom(t)+i.descensionFactor*Math.LN2*e.compared.pan-e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*s*(-2*s*n*o-2*s*a+2*n+2*a*o/(r*r)-o/(t*t))/(e.desiredPixelFlow*Math.LN2)}function Ho(e,t){return e.halfWindowSize*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2)}function Vo(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function ko(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}function Bo(e,t){let i=function(e,t){const i=Math.max(e.compared.sourceZoom,e.compared.targetZoom),r=e.source.zoomAtPixelsPerPan(e.desiredPixelFlow/e.compared.pan)/2;return r<i?null!=t.maximumDistance?i+(t.maximumDistance-i)/2:1.5*i:t.maximumDistance?Math.min(t.maximumDistance,r):r}(e,t);const r={ascensionFactor:null!=t.ascensionFactor?t.ascensionFactor:.5,descensionFactor:null!=t.descensionFactor?t.descensionFactor:.5},s=0===r.ascensionFactor,n=0===r.descensionFactor,a=s?Do:Po,o=s?Io:Ao,l=s?Lo:Oo,c=n?Ho:Fo,h=n?Vo:No,u=n?ko:Uo,d=t=>a(e,t,r)+function(e,t,i){return-e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t))}(e,t,r)+c(e,t,r),p=t=>o(e,t,r)+function(e,t,i){return e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t))}(e,t,r)+h(e,t,r),m=t=>l(e,t,r)+function(e,t,i){return-2*e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t*t))}(e,t,r)+u(e,t,r);let _=d(i);const f=function(e){const t=e.compared.sourceZoom-e.compared.targetZoom;if(0===t)return e.compared.pan*e.halfWindowSize/(e.desiredPixelFlow*e.halfWindowPanAtZoom(e.compared.sourceZoom));const i=Math.LN2*e.compared.pan,r=t,s=e.halfWindowPanAtZoom(r),n=e.halfWindowSize*Math.log(e.compared.sourceZoom/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*s);return e.compared.sourceZoom<=e.compared.targetZoom?n*(i-s):n*(i+s)}(e);let g;const y=t.maximumIterations||20,v=null!=t.maximumDistance?t.maximumDistance:1/0;for(g=0;g<y;g++){const r=t.desiredSlope??1e-6;let s=p(i);Math.abs(s)>r&&(s+=r);const n=s/m(i);if(isNaN(n)||i>=v&&n<0){if(!isFinite(v))return null;i=v,_=d(i);break}if(i-=n,i<=e.compared.sourceZoom||i<=e.compared.targetZoom)return null;const a=d(i);if(Math.abs(a-_)/_<=.005)break;_=a}return isNaN(_)||_>.7*f||i<=e.compared.sourceZoom||i<=e.compared.targetZoom?null:i}class zo extends Mo{constructor(e,t){super(),this._preallocSegments=[new Eo,new Eo,new Eo],this._ascensionSegment=null,this._descensionSegment=null,this.update(e,t)}update(e,t){if(!e)return;this.definition?this.definition.copyFrom(e):this.definition=e.clone();const i=t?.apex?Bo(e,t.apex):null;this.segments.length=0,this._ascensionSegment=null,this._descensionSegment=null,i?this._updateWithApex(i,t?.apex):this._updateWithoutApex()}segmentInterpolateComponentsAt(e,t,i){e.interpolateComponentsAt(t,i),e===this._ascensionSegment?i.zoom=xa(i.zoom):e===this._descensionSegment&&(i.zoom=Ca(i.zoom))}_updateWithApex(e,t){const[i,r,s]=this._preallocSegments,n=t?.ascensionFactor??.5,a=Math.min(1-n,null!=t?.ascensionFactor&&null!=t.descensionFactor?t.descensionFactor:.5),o=1-n-a;i.definition?i.definition.copyFrom(this.definition):i.definition=this.definition.clone(),i.definition.compared.targetZoom=e,i.definition.compared.pan=this.definition.compared.pan*n,i.definition.compared.rotate=this.definition.compared.rotate*n,i.definition.segmentEnd=n,i.update(),this._ascensionSegment=i,this.segments.push(i),o>0&&(r.definition?r.definition.copyFrom(this.definition):r.definition=this.definition.clone(),r.definition.copyFrom(this.definition),r.definition.compared.sourceZoom=e,r.definition.compared.targetZoom=e,r.definition.compared.pan=this.definition.compared.pan*o,r.definition.compared.rotate=this.definition.compared.rotate*o,r.definition.segmentStart=i.definition.segmentEnd,r.definition.segmentEnd=i.definition.segmentEnd+o,r.update(),this.segments.push(r)),s.definition?s.definition.copyFrom(this.definition):s.definition=this.definition.clone(),s.definition.compared.sourceZoom=e,s.definition.compared.pan=this.definition.compared.pan*a,s.definition.compared.rotate=this.definition.compared.rotate*a,s.definition.segmentStart=n+o,s.update(),this._descensionSegment=s,this.segments.push(s)}_updateWithoutApex(){const[e]=this._preallocSegments;e.update(this.definition),this.segments.push(e)}}const Go=new class{constructor(){this.pan=0,this.rotate=0,this.zoom=0,this.fov=0,this.zoomOffset=0}};class qo{get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}constructor(e){this.currentTime=(0,Yr.HA)(0),this._animation=new class{get time(){return this._time}get isLinear(){return 1===this.path.segments.length}constructor(e){this._time=(0,Yr.HA)(0),this._easing=Wa,this.definition=new So(e),this.path=new zo}update(e,t,i){this.definition.update(e,t,i),this.path.update(this.definition,i),this._time=this._applyTimeSettings((0,Yr.up)(isFinite(this.path.time)?this.path.time:(0,Yr._H)(0)),i),this._easing=i.easing??(this._time>=1e3?Wa:Ha)}cameraAt(e,t){e=Math.min(Math.max(0,e),1),e=this._normalizedEasing(e);const i=this.path.interpolateComponentsAt(e,Go);t.interpolate(this.definition.source,this.definition.target,i)}_normalizedEasing(e){const t=this._easing(0,this._time),i=this._easing(1,this._time);return(this._easing(e,this._time)-t)/(i-t)}_applyTimeSettings(e,t){const i=null!=t.speedFactor?t.speedFactor:1,r=t.minDuration??To.minDuration/i,s=t.maxDuration??To.maxDuration/i;return null!=t.duration?(0,Yr.HA)(t.duration):(0,Yr.HA)(Math.min(Math.max(e/i,r),s))}}((()=>new ho(e))),this._current=new ho(e)}update(e,t,i){const{source:r,target:s}=this._animation.definition,n=(0,mr.d)(Zo,t.center,e.center),a=(0,mr.l)(n);a>=1e-5?(n[0]/=a,n[1]/=a,n[2]/=a):(n[0]=0,n[1]=1,n[0]=0),(0,mr.c)(r.direction,n),(0,mr.c)(s.direction,n),r.copyFromRenderCamera(e),s.copyFromRenderCamera(t),this._current.copyFrom(r),this._animation.update(r,s,i),this.currentTime=(0,Yr.HA)(0),e.almostEquals(t)&&(this.currentTime=this._animation.time)}cameraAt(e,t){this._animation.cameraAt(e,this._current),this._current.copyToRenderCamera(t)}step(e,t){this.finished||(this.currentTime=(0,Yr.HA)(this.currentTime+(0,Yr.up)(e)),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,t)}}const Zo=(0,O.Ue)();var jo;!function(e){e[e.Ready=0]="Ready",e[e.Rejected=1]="Rejected",e[e.Running=2]="Running",e[e.Stopped=3]="Stopped",e[e.Finished=4]="Finished"}(jo||(jo={}));let Wo=class extends E.Z{constructor(e){super(e),this.state=jo.Ready}get running(){return this.state===jo.Running}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.canStop&&(this.state=jo.Stopped,!0)}finishController(){this.state=jo.Finished}get steppingFinished(){return!1}};(0,o._)([(0,x.Cb)({constructOnly:!0})],Wo.prototype,"view",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Wo.prototype,"running",null),(0,o._)([(0,x.Cb)()],Wo.prototype,"state",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Wo.prototype,"isInteractive",null),Wo=(0,o._)([(0,S.j)("esri.views.3d.state.controllers.CameraController")],Wo);let $o=class extends Wo{constructor(){super(...arguments),this._asyncResult=null}get canStop(){return!0}set asyncResult(e){this._asyncResult&&(this._asyncResult.reject((0,y.zE)()),this._asyncResult=null),this.state===jo.Finished||this.state===jo.Stopped?((0,f.O3)(e),this.state===jo.Finished?e.resolve():e.reject((0,y.zE)())):this._asyncResult=e}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=jo.Running,null!=this.viewAnimation&&this.viewAnimation.when((()=>this.updateStateFromViewAnimation()),(()=>this.updateStateFromViewAnimation()))}updateStateFromViewAnimation(){!this.viewAnimation||this.state!==jo.Ready&&this.state!==jo.Running||(this.viewAnimation.state===qi.State.FINISHED?this.finish():this.viewAnimation.state===qi.State.STOPPED&&(this.state=jo.Stopped))}onControllerEnd(e){null==this.viewAnimation||this.viewAnimation.done||(this.state===jo.Finished?this.viewAnimation.finish():this.state===jo.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===jo.Finished?this._asyncResult.resolve():this._asyncResult.reject((0,y.zE)()))}finish(){this.finishController()}};$o=(0,o._)([(0,S.j)("esri.views.3d.state.controllers.AnimationController")],$o);var Xo=i(48636),Yo=i(92490);let Qo=class extends $o{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.type="point-to-point",this.mode="interaction",this._hasTarget=!1}initialize(){this.animation=new qo(this.view.state.viewingMode),this.viewAnimation="interaction"===this.mode?null:new qi}get isInteractive(){return"interaction"===this.mode}begin(e,t){this._hasTarget=!0;const i=this.animationSettings(t);Ko.copyFrom(this.view.state.camera);const r=new Yo.r(this.view.state.viewingMode);this._intersectionHelper.intersectRay(Ko.ray,r,Jo)&&(Ko.center=Jo),this.animation.update(Ko,e,i),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}get steppingFinished(){return this._hasTarget&&this.animation.finished}stepController(e,t){this._hasTarget&&this.animation.step(e,t)}onControllerEnd(e){this._hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),super.onControllerEnd(e)}animationSettings(e={}){return{apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0},...e,easing:"string"==typeof e.easing?ro[e.easing]:e.easing}}};(0,o._)([(0,x.Cb)({constructOnly:!0})],Qo.prototype,"mode",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Qo.prototype,"isInteractive",null),Qo=(0,o._)([(0,S.j)("esri.views.3d.state.controllers.PointToPointAnimationController")],Qo);const Ko=new Xo.Z,Jo=(0,O.Ue)();function el(e){return null!=e&&"type"in e&&"point-to-point"===e.type}var tl=i(95437),il=i(18156),rl=i(21117),sl=i(63271),nl=i(69811);function al(e=hl){return[e[0],e[1],e[2],e[3]]}function ol(e,t){return ll(e[0],e[1],e[2],t,nl.o6.get())}function ll(e,t,i,r,s=al()){return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}function cl(e,t,i){return(0,mr.h)(i,e,t),(0,mr.n)(i,i),i[3]=(0,sl.EU)(e,t),i}const hl=[0,0,1,0];(0,rl.Ue)(),(0,rl.Ue)();var ul=i(77773),dl=i(13445);function pl(e,t,i,r){const s=(0,dl.iE)(t,i,ml);return(0,Nn.i)(e,s,r)}const ml=(0,Fn.Ue)();var _l,fl=i(43925);!function(e){e[e.Ellipsoid=0]="Ellipsoid",e[e.Silhouette=1]="Silhouette"}(_l||(_l={}));const gl=[1,3e8],yl=1508e5,vl={exclude:new Set([fl.xX])};function bl(e,t,i){return i[0]=t[0]/(e.fullWidth/e.pixelRatio),i[1]=t[1]/(e.fullHeight/e.pixelRatio),i}function wl(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function Cl(e,t,i){const r=(0,Sr.Us)(nl.MP.get(),i[3],i);null==r||(0,Sr.I6)(r,Mr.Wd)||((0,mr.d)(fc,e.eye,t),(0,mr.t)(fc,fc,r),e.eye=(0,mr.f)(fc,fc,t),(0,mr.d)(fc,e.center,t),(0,mr.t)(fc,fc,r),e.center=(0,mr.f)(fc,fc,t),e.up=(0,mr.t)(fc,e.up,r))}function xl(e,t,i,r){return(0,ul.BR)(e,(0,dl.iE)(t,i,wc),r)}function Tl(e,t,i,r){const s=nl.WM.get();let n=1-i;(0,mr.d)(s,t,e.eye);const a=(0,mr.l)(s);let o=a*(1-n);n>=0&&o<r&&(o=r,n=-(o-a)/a),Math.abs(a-o)<1e-6||((0,mr.g)(s,s,n),e.eye=(0,mr.f)(fc,e.eye,s),e.center=(0,mr.m)(fc,e.center,t,n))}function Sl(e,t,i){t.getScreenCenter(Ml),pl(e,t,Ml,fc)&&(t.center=fc);const r=t.distance,s=r*i;if(Math.abs(r-s)<1e-6)return;const n=(0,mr.g)(nl.WM.get(),t.viewForward,s);t.eye=(0,mr.d)(fc,t.center,n)}const Ml=(0,b.s1)();function El(e,t){(0,mr.i)(t,0,0,0);for(const i of e)(0,mr.f)(t,t,i);(0,mr.g)(t,t,1/e.length)}function Rl(e,t,i,r){return Math.sin(e/(0,mr.l)(t))*(i+r.radius)}function Pl(e,t,i,r){return Rl(Math.PI/2,t,i,r)+(e-Math.PI/2)}var Al;!function(e){e[e.Vertical=0]="Vertical",e[e.Horizontal=1]="Horizontal"}(Al||(Al={}));const Ol={Elevation:3e4,Angle:(0,jt.Vl)(16)},Dl=(0,jt.Vl)(80);function Il(e,t,i,r,s,n){const a=(0,O.Ue)(),o=(0,Nn.c)();let l=!0,c=!0;return e.intersectScreen(i,a,n)?o[3]=(0,mr.l)(a):(c=!1,t.aboveGround&&s!==_l.Ellipsoid?o[3]=Math.max((0,mr.l)(t.center),.9*r):o[3]=(0,mr.l)(t.eye)-t.relativeElevation,s===_l.Silhouette?Ul(o,t,i,a):l=pl(o,t,i,a)),{sphere:o,scenePickPoint:l?a:null,hasGeometryIntersection:c}}function Ll(e,t,i,r){const s=e.relativeElevation;if(s>Ol.Elevation&&"global"===r)return Al.Horizontal;(0,dl.iE)(e,t,Cc);const n=Math.sign(s),a=i.worldUpAtPosition(e.eye,fc);return-n*(0,mr.e)(a,Cc.direction)<Math.sin(Ol.Angle)*(0,mr.l)(Cc.direction)?Al.Vertical:Al.Horizontal}function Fl(e,t,i){(0,mr.d)(Nl,i,t),e.eye=(0,mr.d)(fc,e.eye,Nl),e.center=(0,mr.d)(fc,e.center,Nl)}const Nl=(0,O.Ue)();function Ul(e,t,i,r){const s=(0,dl.iE)(t,i,wc);return!(null==s||((0,Nn.j)(e,s,Hl),(0,Nn.i)(e,s,r)?(0,mr.s)(Hl,s.origin)<(0,mr.s)(r,s.origin)&&((0,mr.c)(r,Hl),1):((0,mr.d)(Vl,t.eye,t.center),(0,mr.n)(Vl,Vl),(0,ul.Oy)(Vl,-(0,mr.e)((0,mr.n)(Vl,Vl),Hl),kl),(0,ul.BR)(kl,s,r),1)))}const Hl=(0,O.Ue)(),Vl=(0,O.Ue)(),kl=(0,ul.Ue)();function Bl(e,t,i,r,s,n){let a=0;if((0,mr.h)(vc,e,t),(0,mr.d)(gc,e,t),(0,mr.l)(e)<=s||!r.aboveGround){(0,mr.h)(i,gc,r.eye);const o=(0,mr.e)(e,t)/((0,mr.l)(e)*(0,mr.l)(t));if(o<.9999)a=(0,jt.ZF)(o);else{const i=(0,mr.l)((0,mr.h)((0,O.Ue)(),e,t))/((0,mr.l)(e)*(0,mr.l)(t));a=(0,jt.Kt)(i)}const l=Math.cos((0,jt.uZ)(tl.Q4.normalize((0,jt.Vl)(n)),0,Dl));a=-a-Math.max(0,(0,mr.l)(t)-s)/(l*s)}else(0,mr.d)(zl,r.eye,r.center),(0,mr.h)(i,gc,zl),a=-(0,mr.l)(gc)/s;return(0,mr.n)(i,i),(0,mr.g)(i,i,(0,mr.l)(vc)),a}const zl=(0,O.Ue)();function Gl(e,t,i,r){let s,n;const a=Math.cos((0,jt.uZ)(tl.Q4.normalize((0,jt.Vl)(r)),0,Dl));return s=t>i?-(t-i)/(a*i):t<-i?Math.PI-(t+i)/(a*i):(0,jt.ZF)(t/i),n=e>i?-(e-i)/(a*i):e<-i?Math.PI-(e+i)/(a*i):(0,jt.ZF)(e/i),(n-s)*i}function ql(e,t,i,r,s,n,a,o,l,c){(0,mr.h)(vc,e,t),(0,k.Tz)(n.up,n.eye,nc,ac,oc),(0,k.Tz)([0,0,1],n.eye,ic,rc,sc),(0,mr.c)(i,rc),(0,mr.c)(r,ic),(0,mr.n)(i,i),(0,mr.g)(i,i,(0,mr.l)(vc)),(0,k.yS)(e,(0,mr.n)(ac,ac),(0,mr.n)(oc,oc),(0,mr.n)(nc,nc),lc),(0,k.yS)(t,ac,oc,nc,cc),function(e,t,i,r,s,n,a,o,l,c){const h=Gl(e[2],t[2],n[3],o),u=l?Gl(e[0],t[0],n[3],180):t[0]-e[0],d=Math.sin(a)*u-Math.cos(a)*h,p=Math.cos(a)*u+Math.sin(a)*h;(0,mr.n)(fc,s);const m=l?d/Math.sqrt(Math.abs(n[3]**2-(0,mr.e)(i,fc)**2)):d/n[3],_=p/Math.sqrt(Math.abs(n[3]**2-(0,mr.e)(i,r)**2));(0,Er.t8)(c,m,_)}(lc,cc,e,ic,rc,a,o,l,c,s)}function Zl(e,t,i,r,s,n,a){(0,Sr.Us)(dc,s,r),(0,Sr.Us)(pc,a,n),(0,Sr.Jp)(mc,dc,pc),(0,mr.d)(t,e,i),(0,mr.t)(t,t,mc),(0,mr.f)(t,t,i)}function jl(e,t,i,r,s,n){(0,Sr.Us)(dc,r,i),(0,Sr.Us)(pc,n,s),(0,Sr.Jp)(mc,dc,pc),(0,mr.d)(fc,e.eye,t),(0,mr.t)(fc,fc,mc),e.eye=(0,mr.f)(fc,fc,t),(0,mr.d)(fc,e.center,t),(0,mr.t)(fc,fc,mc),e.center=(0,mr.f)(fc,fc,t),(0,mr.d)(fc,e.up,t),(0,mr.t)(fc,fc,mc),e.up=(0,mr.f)(fc,fc,t)}const Wl=.95,$l=(0,jt.Vl)(18),Xl=45,Yl=1e-7;let Ql=!1;function Kl(e,t,i,r,s,n){const a=Math.abs(r)>Math.PI-$l||Math.abs(r)<$l,o=(Math.abs(e[2])<i*Wl||Math.abs(t)>i)&&n;return a&&o?!Ql&&s<Xl-Yl?Ql=!0:Ql&&s>Xl+Yl&&(Ql=!1):Ql=!1,Ql}function Jl(e,t,i,r,s,n){if(n)cl(i,r,uc),Cl(t,(0,Nn.a)(e),uc);else{const n=Bl(i,r,bc,t,e[3],s);Cl(t,(0,Nn.a)(e),ol(bc,n))}}function ec(e,t,i,r,s,n,a){const o=a?20:1;let l,c;(0,mr.c)(_c,r),yc.copyFrom(t);for(let r=0;r<o&&(0,mr.s)(i,_c)>1e-12&&(l=(0,mr.s)(i,_c),ql(i,_c,rc,ic,hc,yc,e,s,n,a),jl(yc,(0,Nn.a)(e),ic,hc[1],rc,hc[0]),Zl(_c,_c,(0,Nn.a)(e),ic,hc[1],rc,hc[0]),c=(0,mr.s)(i,_c),c<l||0===r);r++)t.copyFrom(yc)}function tc(e,t,i,r,s,n,a,o,l){Kl(e.center,(0,mr.e)(e.up,e.center),(0,mr.l)(e.center),-tl.Q4.normalize((0,jt.Vl)(n)),a,t.aboveGround)?function(e,t,i,r,s,n){const{eye:a}=e;(0,k.Tz)([0,0,1],a,ic,rc,sc);const o=t.translation[0]*i.pan,l="zoom"===s.mode?0:t.translation[1]*i.pan,c=Math.max(Math.sqrt(Math.abs(1-(0,mr.e)(e.center,ic)**2/(0,mr.l)(e.center)**2)),.5),h=(Math.sin(n)*l+Math.cos(n)*o)/c,u=-Math.cos(n)*l+Math.sin(n)*o;switch((0,Sr.U1)(r.pan.matrix,r.pan.matrix,h,ic),r.pan.enabled=!0,s.mode){case"pan":(0,Sr.U1)(r.pan.matrix,r.pan.matrix,u,rc),r.pan.enabled=!0;break;case"zoom":r.zoom=-t.translation[1]*i.zoom}}(t,i,r,o,l,-tl.Q4.normalize((0,jt.Vl)(s))):function(e,t,i,r,s){const{eye:n,viewRight:a}=e,o=(0,mr.h)(nl.WM.get(),a,n),l=t.translation[0]*i.pan;switch(0!==l&&((0,Sr.U1)(r.pan.matrix,r.pan.matrix,-l,o),r.pan.enabled=!0),s.mode){case"pan":{const e=t.translation[1]*i.pan;0!==e&&((0,Sr.U1)(r.pan.matrix,r.pan.matrix,e,a),r.pan.enabled=!0);break}case"zoom":r.zoom=-t.translation[1]*i.zoom}}(t,i,r,o,l)}const ic=(0,O.Ue)(),rc=(0,O.Ue)(),sc=(0,O.Ue)(),nc=(0,O.Ue)(),ac=(0,O.Ue)(),oc=(0,O.Ue)(),lc=(0,O.Ue)(),cc=(0,O.Ue)(),hc=(0,Rr.Ue)(),uc=al(),dc=(0,Mr.Ue)(),pc=(0,Mr.Ue)(),mc=(0,Mr.Ue)(),_c=(0,O.Ue)(),fc=(0,O.Ue)(),gc=(0,O.Ue)(),yc=new Xo.Z,vc=(0,O.Ue)(),bc=(0,O.Ue)(),wc={origin:(0,O.Ue)(),direction:(0,O.Ue)()},Cc={origin:(0,O.Ue)(),direction:(0,O.Ue)()};let xc=class extends Qo{constructor(){super(...arguments),this._zoomLocation=(0,O.Ue)(),this._tmpCamera=new Xo.Z,this._tmpViewDir=(0,O.Ue)(),this._tmpRayDir=(0,Fn.Ue)(),this._targetOnSphere=(0,O.Ue)(),this._tmpCenter=(0,O.Ue)(),this._beginCamera=new Xo.Z,this._constraintOptions=new Un(Dn.ALL_EXCEPT_COLLISION,In.ZOOM,null,this._beginCamera),this._sphere=(0,Nn.c)()}initialize(){this._intersector=new Yo.r(this.view.state.viewingMode)}step(e,t){if(!this.running)return;const i=this.view.state;this.animation.finished?this._beginCamera.copyFrom(i.camera):this.animation.cameraAt(1,this._beginCamera);let r=!1,s=!1;this._intersectionHelper.intersectScreen(t,this._zoomLocation,0===this.view.map.ground.opacity?vl:{})&&(r=e>0,s=!0),this._tmpCamera.copyFrom(i.camera),r?this._intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter):this._intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:(0,mr.c)(this._zoomLocation,this._tmpCamera.center),this._updateCamera(this._tmpCamera,e,t,s),this.begin(this._tmpCamera)}animationSettings(){return{duration:(0,Yr.HA)(600),easing:Ha}}_updateCamera(e,t,i,r){const s=Ll(e,i,this.view.renderCoordsHelper,this.view.viewingMode),n=Math.abs(this.view.camera.position.z),a=this._zoomLocation;(0,mr.n)(Sc,e.eye),(0,mr.g)(Sc,Sc,-1),(0,dl.iE)(e,i,this._tmpRayDir),(0,mr.n)(this._tmpRayDir.direction,this._tmpRayDir.direction);const o=(0,jt.uZ)(Math.min(8,1/Math.abs((0,mr.e)(Sc,this._tmpRayDir.direction)))*n,200,yl);if(s===Al.Horizontal){let r=.6**t;this._sphere[3]=(0,mr.l)(a),(0,mr.d)(this._tmpViewDir,e.center,e.eye);const s=Math.min((0,mr.l)(this._tmpViewDir),o);let n=s*r;if(r<=1&&n<4&&(n=4,r=n/s),Math.abs(s-n)<1e-6)return;const l=(0,mr.l)(e.center);if(this._sphere[3]!==l){const t=this._sphere[3]+r*(l-this._sphere[3]);e.center=(0,mr.g)(Tc,e.center,t/l)}(0,mr.g)(this._tmpViewDir,this._tmpViewDir,-r),e.eye=(0,mr.f)(Tc,e.center,this._tmpViewDir),so(this.view,e,this._constraintOptions),(0,mr.s)(a,e.center)>1e-12&&pl(this._sphere,e,i,this._targetOnSphere)&&function(e,t,i,r,s,n,a){Kl(i,(0,mr.e)(t.up,i),e[3],-tl.Q4.normalize((0,jt.Vl)(s)),n,t.aboveGround)?ec(e,t,i,r,-tl.Q4.normalize((0,jt.Vl)(s)),n,a):Jl(e,t,i,r,n,a)}(this._sphere,e,a,this._targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{let s=.6**Math.abs(t);const n=t>0?1:-1;(0,mr.d)(this._tmpViewDir,a,e.eye);const l=(0,mr.l)(this._tmpViewDir),c=this.view.stage.renderView.getMinimalDepthForArea(null,i[0],i[1],this.view.state.camera,60);let h=null!=c?c:o;h=r&&t>0?Math.min(h,l):h,(0,mr.g)(this._tmpRayDir.direction,this._tmpRayDir.direction,h),(0,mr.f)(a,this._tmpRayDir.origin,this._tmpRayDir.direction);let u=h*s;const d=Math.max(4,1.01*e.nearFar[0]);if(t>0&&u<d&&(u=d,s=u/h),Math.abs(h-u)<1e-6)return;(0,mr.g)(this._tmpRayDir.direction,this._tmpRayDir.direction,n*(1-s)),e.eye=(0,mr.f)(Tc,e.eye,this._tmpRayDir.direction),e.center=(0,mr.f)(Tc,e.center,this._tmpRayDir.direction)}na(this.view,e)}};xc=(0,o._)([(0,S.j)("esri.views.3d.state.controllers.ZoomStepControllerGlobal")],xc);const Tc=(0,O.Ue)(),Sc=(0,O.Ue)();var Mc=i(23555);let Ec=class extends Qo{constructor(){super(...arguments),this._zoomLocation=(0,O.Ue)(),this._tmpCamera=new Xo.Z,this._tmpRayDir=(0,O.Ue)(),this._tmpCenter=(0,O.Ue)(),this._beginCamera=new Xo.Z,this._constraintOptions=new Un(Dn.ALL,In.ZOOM,null,this._beginCamera)}step(e,t){if(!this.running)return;const i=this.view.state;this.animation.finished?this._beginCamera.copyFrom(i.camera):this.animation.cameraAt(1,this._beginCamera),this._tmpCamera.copyFrom(i.camera);const r=new Yo.r(this.view.state.viewingMode);let s=!1;e>0?(s=this._intersectionHelper.intersectScreenFreePointFallback(t,this._zoomLocation,this.view.basemapTerrain.invisible?vl:{}),this._intersectionHelper.intersectRay(this._tmpCamera.ray,r,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter)):this._intersectionHelper.intersectRay(this._tmpCamera.ray,r,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:(0,mr.c)(this._zoomLocation,this._tmpCamera.center);const n=.6**e;let a=this.view.stage.renderView.getMinimalDepthForArea((0,Mc.$L)(this.view),t[0],t[1],this.view.state.camera,60);(0,mr.d)(Ac,this._tmpCamera.eye,this._zoomLocation),(0,mr.n)(Ac,Ac);const o=(0,jt.uZ)(Math.min(8,1/Math.abs((0,mr.e)(Pc,Ac)))*Math.abs(this.view.camera.position.z),200,yl);if(a=null!=a?a:o,a){const e=(0,O.Ue)();(0,mr.d)(e,this._zoomLocation,this._tmpCamera.eye),(a<(0,mr.l)(e)||!s)&&((0,mr.n)(e,e),(0,mr.f)(this._zoomLocation,this._tmpCamera.eye,(0,mr.g)(e,e,a)))}this._updateCamera(this._tmpCamera,n,this._zoomLocation),this.begin(this._tmpCamera)}animationSettings(){return{duration:(0,Yr.HA)(600),easing:Ha}}_updateCamera(e,t,i){(0,mr.d)(this._tmpRayDir,i,e.eye);const r=(0,mr.l)(this._tmpRayDir);let s=r*t;const n=t<=1,a=Math.max(4,1.01*e.nearFar[0]);0!==s&&(n&&s<a&&(s=a,t=s/r),Math.abs(r-s)<1e-6||((0,mr.g)(this._tmpRayDir,this._tmpRayDir,t),e.eye=(0,mr.d)(Rc,i,this._tmpRayDir),e.center=(0,mr.m)(Rc,e.center,i,1-t),so(this.view,e,this._constraintOptions)))}};Ec=(0,o._)([(0,S.j)("esri.views.3d.state.controllers.ZoomStepControllerLocal")],Ec);const Rc=(0,O.Ue)(),Pc=(0,O.al)(0,0,1),Ac=(0,O.Ue)();var Oc=i(42527);function Dc(e,t){switch(t){case"primary":return"touch"===e.pointerType||0===e.button;case"secondary":return"touch"!==e.pointerType&&2===e.button;case"tertiary":return"touch"!==e.pointerType&&1===e.button}}function Ic(e,t){const{button:i,pointerType:r}=e;return"touch"!==r&&t.some((e=>"primary"===e&&0===i||"secondary"===e&&2===i||"tertiary"===e&&1===i))}function Lc(e,{dragPrimary:t,dragSecondary:i,dragTertiary:r}){return[{key:"primary",value:t},{key:"secondary",value:i},{key:"tertiary",value:r}].filter((t=>t.value===e)).map((e=>e.key))}class Fc extends Oc.a{constructor(e,t){super(!0),this._view=e,this.registerIncoming("double-click",t,(e=>this._handleDoubleClick(e)))}_handleDoubleClick(e){const t=e.data;if(Dc(t,"primary")){const i=this._view.state.isGlobal?new xc({view:this._view,mode:"animation"}):new Ec({view:this._view,mode:"animation"});this._view.state.switchCameraController(i),i.step(Math.log(.5)/Math.log(.6),(0,b.s1)(t.x,t.y)),e.stopPropagation()}}}var Nc=i(73749),Uc=i(27583),Hc=i(67764),Vc=i(60321);let kc=class extends E.Z{constructor(e){super(e)}initialize(){this.addHandles(this.view.basemapTerrain.on("elevation-change",(e=>this._handleElevationChangeEvent(e))))}_handleElevationChangeEvent(e){if(this.view.state.cameraController)return;const t=this.view.state.camera;null!=e.spatialReference&&(0,sa.lM)(this.view,t,e.extent,e.spatialReference)&&this._applyToCurrentCamera()}_applyToCurrentCamera(){this.view.state.updateCamera((e=>na(this.view,e,ra.EYE_AND_CENTER)))}};(0,o._)([(0,x.Cb)({constructOnly:!0})],kc.prototype,"view",void 0),kc=(0,o._)([(0,S.j)("esri.views.3d.state.SurfaceCollisionConstraint")],kc);let Bc=class extends E.Z{constructor(e){super(e),this.nearFarHeuristic=(0,Vc.l)(e.view.state.viewingMode,e.view.basemapTerrain,e.view.renderCoordsHelper.spatialReference)}initialize(){this.addHandles([(0,n.YP)((()=>[this.view.constraints?.clipDistance?.near,this.view.constraints?.clipDistance?.far]),(()=>this._clipDistanceNearFarChanged())),(0,n.YP)((()=>this.view.constraints?.clipDistance?.mode),(()=>this._updateNearFar())),this.view.state.events.on("before-camera-change",(({camera:e,sceneDepthRange:t})=>this._updateCameraNearFar(e,t))),(0,n.YP)((()=>this.view.stage.renderer.sceneDepthRange.value),(()=>this._updateNearFar()),n.Z_),(0,n.YP)((()=>this.view.renderDataExtent),(()=>this._updateNearFar()),n.Z_),(0,n.YP)((()=>[this.view.constraints?.altitude?.min,this.view.constraints?.altitude?.max]),(()=>this._updateAltitude()),n.Z_),(0,n.YP)((()=>this.view.constraints?.tilt?.max),(()=>this._updateTiltMax()),n.Z_),(0,n.YP)((()=>this.view.constraints?.tilt?.mode),(()=>this._updateTilt()),n.Z_),(0,n.YP)((()=>this.view.state?.camera),(()=>this._updateTiltAutoMax()),n.Z_),(0,n.YP)((()=>[this.view.map?.ground?.navigationConstraint?.type,this.view.state?.constraints?.collision?.enabled]),(()=>this._updateCollision()),n.Z_)]),this.view.state.isLocal&&this.addHandles((0,n.YP)((()=>this.view.renderDataExtent),(e=>this._updateLocalSurfaceDistance(e)),n.nn)),this._updateNearFar(),this.view.state.viewingMode!==Si.JY.Local&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new kc({view:this.view}))}destroy(){this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){const e=this.view.constraints?.clipDistance;e&&"auto"!==e.mode&&this.view.state.updateCamera((t=>zc(t,e)))}_updateNearFar(){this.view.state.updateCamera((e=>this._updateCameraNearFar(e)))}_updateCameraNearFar(e,t){const i=this.view.constraints&&this.view.constraints.clipDistance;"manual"===(i?i.mode:"auto")?zc(e,i):this._updateCameraNearFarAuto(e,i,t)}_updateCameraNearFarAuto(e,t,i){const r=(0,sa.wH)(this.view,e.eye),s=this.nearFarHeuristic.compute(e,this.view.renderDataExtent,i??this.view.stage.renderer.sceneDepthRange.value,r);e.near=s.near,e.far=s.far,t&&t.autoUpdate(e.near,e.far)}_updateCollision(){const e=this.view.map?.ground?.navigationConstraint?.type,t=!e||"stay-above"===e,i=this.view.state.constraints.collision;if(t!==i.enabled){i.enabled=t,t&&this._reapplyConstraints(Dn.COLLISION);const e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode||this._updateTiltAuto()}}_updateAltitude(){const e=this.view.constraints&&this.view.constraints.altitude;e&&this.view.state.viewingMode!==Si.JY.Local?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){const e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode&&(this._updateTiltManual(e),this._reapplyConstraints())}_updateTilt(){const e=this.view.constraints&&this.view.constraints.tilt;"manual"===(e?e.mode:"auto")?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(e){const t=this.view.state.constraints;t.tilt=t.createConstantMaxTilt((0,jt.Vl)(e.max))}_updateTiltAuto(){const e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){const e=this.view.constraints&&this.view.constraints.tilt;if(!e||"auto"!==e.mode)return;const t=this.view.state.constraints;if(t.tilt){const i=t.tilt(this.view.state.camera.distance).max;e.autoUpdate((0,jt.BV)(i))}}_updateLocalSurfaceDistance(e){if(null==e)return;let t=Math.max(e.width,e.height);if(t<=0)return;null!=e.zmax&&null!=e.zmin&&(t=Math.max(t,e.zmax-e.zmin));const i=this.view.state,r=3*t/Math.atan(i.camera.fov/2);r!==i.constraints.distance&&(i.constraints.distance=r)}_reapplyConstraints(e=Dn.ALL){this.view.state.updateCamera((t=>so(this.view,t,new Un(e,In.NONE,null))))}};function zc(e,t){t&&(e.near=t.near,e.far=t.far)}(0,o._)([(0,x.Cb)({constructOnly:!0})],Bc.prototype,"view",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Bc.prototype,"surfaceCollisionConstraint",void 0),Bc=(0,o._)([(0,S.j)("esri.views.3d.state.ConstraintsManager")],Bc);var Gc=i(59505);let qc=class extends Wo{set desiredCamera(e){this._set("desiredCamera",e.clone())}constructor(e){super(e)}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=jo.Running,this.addHandles(this.view.basemapTerrain.on("elevation-change",(e=>this._handleElevationChangeEvent(e)))),this._applyCorrection()}onControllerEnd(){this.removeAllHandles()}stepController(){}_handleElevationChangeEvent(e){(null==e.spatialReference||(0,sa.lM)(this.view,this.desiredCamera,e.extent,e.spatialReference))&&this._applyCorrection()}_applyCorrection(){this.view.state.updateCamera((e=>{e.copyViewFrom(this.desiredCamera),na(this.view,e,ra.EYE_AND_CENTER)||this.constraintEnabled||(this.state=jo.Stopped)}))}};(0,o._)([(0,x.Cb)({constructOnly:!0})],qc.prototype,"desiredCamera",null),qc=(0,o._)([(0,S.j)("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],qc);var Zc=i(77755);class jc{constructor(e,t,i){this._target=e,this._options=t,this.view=i,this.state="pending",this._animationController=null,this.promise=new Promise(((e,t)=>{this._resolveCallback=e,this._rejectCallback=t;const i=new AbortController;null!=this._options.signal&&(0,y.fu)(this._options.signal,(()=>this.abort())),this._abortController=i,this._waitForReady()}))}_resolve(e){if("finished"!==this.state)return this.state="finished",this._resolveCallback(e)}_reject(e){if("finished"!==this.state)return this.state="finished",this._rejectCallback(e)}abort(e=!1){this._abortController.abort(),"wait-for-animation-finish"===this.state&&!e&&null!=this._animationController&&this.view.state.cameraController===this._animationController&&this._animationController.running&&this._animationController.stopController(),this._reject((0,y.zE)())}async _waitForReady(){if(this.state="wait-for-ready",!this.view.ready)try{await(0,n.N1)((()=>this.view.ready),this._abortController.signal)}catch(e){return this._reject(e)}this._createViewPoint()}async _createViewPoint(){if("finished"!==this.state){this.state="wait-for-viewpoint",this._animationController=this._options.animate?this._getAnimationController():null;try{const e=await(0,Zc.Ue)(this.view,this._target,this._abortController.signal);if("finished"===this.state)return;const t=e?this._getCameraFromViewpoint(e):null;if(null==t)return;if(this._options.animate){if(null==this._animationController)return;this._startAnimation(t,this._animationController)}else this.view.stateManager.setStateCamera(t.camera,{applyConstraints:!t.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this._resolve()}catch(e){this._reject(e)}}}_getCameraFromViewpoint(e){const t=!!(this._target instanceof l.Z&&this._target.camera||this._target instanceof s.Z),i=e.camera;if(null==i)return null;if(!this.view.stateManager.isCompatible(i)){const e=i.position,t=e&&e.spatialReference,r=t?t.wkid:"none",s=this.view.spatialReference?.wkid;return this._reject(new u.Z("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${r}, view: ${s})`,{camera:i})),null}const r=(0,ne.n3)(this.view,i);return null==r?(this._reject(new u.Z("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:e,camera:r,isFullySpecified:t}}_startAnimation(e,t){this.state="wait-for-animation-finish";const i=t.viewAnimation;if(null==i)return void this._reject(new u.Z("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(i.update(e.viewpoint,"running"),!t.running||null==t.viewAnimation||t.viewAnimation.target!==e.viewpoint||this.view.state.cameraController!==t)return this.abort();let r;e.isFullySpecified?(r=new qc({view:this.view,desiredCamera:e.camera}),na(this.view,e.camera,ra.EYE_AND_CENTER)):so(this.view,e.camera),t.begin(e.camera,this._options);const s=e=>{if(null!=this.view.state)switch(t.state){case jo.Finished:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this._resolve()}break;case jo.Ready:case jo.Rejected:case jo.Running:case jo.Stopped:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this._reject(e)}}};i.when((()=>{const i=this.view.state.cameraController;r&&(i&&i.running?el(i)&&null!=i.viewAnimation&&i.viewAnimation.target===e.viewpoint&&(this.view.state.cameraController=r):null!=t.viewAnimation&&t.viewAnimation.target===e.viewpoint&&t.state===jo.Finished&&(this.view.state.cameraController=r))}),(e=>s(e))),t.asyncResult={resolve:()=>s(),reject:e=>s(e)}}_getAnimationController(){let e=null,t=null;const i=this.view.state.cameraController;return el(i)&&(i.updateStateFromViewAnimation(),i.running&&(e=i,t=e.viewAnimation)),null==e&&(e=new Qo({view:this.view,mode:"animation"}),t=e.viewAnimation,this.view.state.switchCameraController(e),e.state===jo.Rejected)?(t?.stop(),this._reject(new u.Z("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null):e}}var Wc=i(10517),$c=i(4486),Xc=i(96571),Yc=i(99734);let Qc=class extends E.Z{constructor(e){super(e),this.ready=!1,this._windowDevicePixelRatio=1,this._devicePixelRatioOverride=null,this._idleTimeout=oh,this.test={viewStateManager:this,contentCameraResetState:new Map,setDevicePixelRatio:e=>this._devicePixelRatioOverride=e,renderState:null,get maximumPixelRatio(){return this.viewStateManager.view.qualitySettings.maximumPixelRatio},get updatingIgnoreRenderState(){return null!=this.renderState},get idleTimeoutEnabled(){return this.viewStateManager._idleTimeout>0},set idleTimeoutEnabled(e){this.viewStateManager._idleTimeout=e?oh:0}},this._propertiesPool=new Xc.L({frustum:Gc.i},this),this._cameraSetByUser=!1,this._gotoOperation=null,this._cameraChangeTime=0,this._tmpCanvasSize=new Kc}initialize(){this._cameraChangeTime=performance.now(),this.addHandles([(0,n.on)((()=>this.view.state.events),"before-camera-change",(({camera:e})=>e&&this._updateElevation(e))),(0,n.YP)((()=>this.view.state?.camera),((e,t)=>this._cameraChangedHandler(e,t)),n.Z_)]),(0,n.gx)((()=>this.view.state?.camera),(e=>this._updateElevation(e)),{once:!0,sync:!0}),this.addHandles([(0,v.A)({prepare:()=>this._prepareFrame()}),(0,n.YP)((()=>this.view.state.cameraController),(()=>{this._cameraSetByUser=!0,this.removeHandles(nh)})),(0,n.on)((()=>this.view.state.events),"camera-projection-changed",(()=>this.notifyChange("scale")))])}destroy(){this.exit(),this._propertiesPool=(0,f.SC)(this._propertiesPool)}get camera(){const e=this._get("camera");if(!this.ready)return e;const t=(0,ne.l0)(this.view,this.view.state.camera,ih);return t&&e&&t.equals(e)?e:t.clone()}set camera(e){this._updatePropertyBeforeReady("camera",e)||(this.view.elevationProvider?.enableCache(!0),this.setStateCamera((0,ne.n3)(this.view,e),{applyConstraints:!1})||_.Z.getLogger(this).error("#camera=","Invalid camera",e),this.view.elevationProvider?.enableCache(!1))}get contentCamera(){const e=this._get("contentCamera");if(!this.ready)return e;const t=(0,ne.l0)(this.view,this.view.state.contentCamera,ih);return t&&e&&t.equals(e)?e:t.clone()}set contentCamera(e){if(this._updatePropertyBeforeReady("contentCamera",e))return;const t=(0,ne.n3)(this.view,e);this.view.state.contentCamera=null!=t?t:null}installContentCameraReset(e){if(this.removeHandles(ah),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const t=this.zoom,i=this.view.state.camera.distance**2,r=(0,O.nI)(this.view.state.camera.center),s=e.sticky?this.contentCamera.clone():null;return this.addHandles([(0,n.YP)((()=>this.contentCamera),(()=>{e.sticky||(this.removeHandles(ah),this.test.contentCameraResetState.clear())})),(0,n.YP)((()=>this.zoom),(e=>{void 0!==e&&void 0!==t&&(this.test.contentCameraResetState.set("view.zoom",Math.abs(e-t)/2),Math.abs(e-t)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=s))})),(0,n.YP)((()=>this.view.state.camera),(e=>{const t=(0,mr.s)(r,e.center);this.test.contentCameraResetState.set("camera.center",t/i),t>i?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=s)}))],ah),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){this._updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this._centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():_.Z.getLogger(this).error("#center=","Invalid center",e):_.Z.getLogger(this).error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e):_.Z.getLogger(this).error("#center=","Center may not be null or undefined"))}get visibleArea(){if(!this.ready){const e=this._get("extent");return e?Hc.Z.fromExtent(e):null}return(0,ne.ao)(this.view,this.view.pointsOfInterest.focus.renderLocation)}get extent(){if(!this.ready)return this._get("extent");const e=this.view,t=(0,ne.HH)(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return null!=t?t:this._get("extent")}set extent(e){this._updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this._extentToCamera(e),{applyConstraints:!0})||_.Z.getLogger(this).error("#extent=","Invalid extent",e):_.Z.getLogger(this).error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e):_.Z.getLogger(this).error("#extent=","Extent may not be null or undefined"))}get frustum(){const e=this._propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get constraintsManager(){return this._constraintsManager}get _initialViewpoint(){const e=this.view.map;return e&&"initialViewProperties"in e?e.initialViewProperties?.viewpoint:void 0}get hasInitialView(){return!!this._initialViewpoint}get scale(){if(!this.ready)return this._get("scale");const e=this.view.basemapTerrain.tilingScheme,t=this.view.pointsOfInterest.cameraOnSurface.scale;return e&&t?(0,ne.Br)(this.view,t,this.view.state.contentCamera,e):this._get("scale")}set scale(e){this._updatePropertyBeforeReady("scale",e)||this.setStateCamera(this._scaleToCamera(e),{applyConstraints:!0})||_.Z.getLogger(this).error("#scale=","Invalid scale",e)}get padding(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,t=e.padding,i=e.pixelRatio,r=this._get("padding"),s=Math.round(t[Wc.Np.TOP]/i),n=Math.round(t[Wc.Np.RIGHT]/i),a=Math.round(t[Wc.Np.BOTTOM]/i),o=Math.round(t[Wc.Np.LEFT]/i);return null!=r&&r.top===s&&r.right===n&&r.bottom===a&&r.left===o?r:{top:s,right:n,bottom:a,left:o}}set padding(e){this._updatePropertyBeforeReady("padding",e)||(this._paddingToArray(e,this.view.state.camera.pixelRatio,sh),this.view.state.updateCamera((e=>e.padding=sh)))}_paddingToArray(e,t,i){e?(0,Nc.s)(i,e.top||0,e.right||0,e.bottom||0,e.left||0):(0,Nc.s)(i,0,0,0,0);for(let e=0;e<4;e++)i[e]=Math.round(i[e]*t)}get screenCenter(){const e=this.padding;return(0,b.vW)((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?(0,Zc.Q8)(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){if(!this._updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this._viewpointToCamera(e),{applyConstraints:!e.camera})||_.Z.getLogger(this).error("#viewpoint=","Invalid viewpoint",e);else{const t=null!=e.camera?e.camera.position:e.targetGeometry,i=null!=t&&t.spatialReference;_.Z.getLogger(this).error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(i?i.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e)}else _.Z.getLogger(this).error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?(0,ne.sO)(this.view,this.scale):this._get("zoom")}set zoom(e){this._updatePropertyBeforeReady("zoom",e)||void 0===e||this.setStateCamera(this._zoomToCamera(e),{applyConstraints:!0})||_.Z.getLogger(this).error("#zoom=","Invalid zoom",e)}_computeCanvasSize(){if(this._devicePixelRatioOverride)return this.view.state.contentPixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*this._devicePixelRatioOverride),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*this._devicePixelRatioOverride),this._tmpCanvasSize.pixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize;const e=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio),t=(this._usePhysicalPixelRendering?this._windowDevicePixelRatio:e)*this.view.resolutionScale;this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*t),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*t);const i=this.view.stage.renderView.renderingContext?.parameters.maxTextureSize;return i&&(0,kr.d)(this._tmpCanvasSize,i),this._tmpCanvasSize.pixelRatio=this._tmpCanvasSize.width>0?this._tmpCanvasSize.width/this.view.surface.clientWidth*.5+this._tmpCanvasSize.height/this.view.surface.clientHeight*.5:t,this.view.state&&(this.view.state.contentPixelRatio=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)),this._tmpCanvasSize}get _rasterPixelRatio(){return null!=this._devicePixelRatioOverride?this._devicePixelRatioOverride:this._usePhysicalPixelRenderingAny?this._windowDevicePixelRatio:Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)}get _usePhysicalPixelRendering(){return this.view?.stage?.renderer.isFeatureEnabled($c.Y.PhysicalPixelRendering)??!1}get _usePhysicalPixelRenderingAny(){const e=this.view?.stage?.renderer;return e&&(e.isFeatureEnabled($c.Y.PhysicalPixelRendering,Yc.n.IDLE)||e.isFeatureEnabled($c.Y.PhysicalPixelRendering,Yc.n.INTERACTING)||e.isFeatureEnabled($c.Y.PhysicalPixelRendering,Yc.n.ANIMATING))}preinit(e){return!(this._isOverridden("center")&&!(0,F.isLoadedOrLoadFor)(this.center.spatialReference,e)||this._isOverridden("camera")&&!(0,F.isLoadedOrLoadFor)(this.camera.position.spatialReference,e)||this._isOverridden("extent")&&!(0,F.isLoadedOrLoadFor)(this.extent.spatialReference,e)||!(!this._isOverridden("viewpoint")||(0,F.isLoadedOrLoadFor)(this.viewpoint.targetGeometry?.spatialReference,e)&&(0,F.isLoadedOrLoadFor)(this.viewpoint.camera?.position?.spatialReference,e)))}init(){this._constraintsManager=new Bc({view:this.view}),this._prepareFrame();const e=this._getInitialProperties();this._cameraSetByUser=!1,this._set("ready",!0);for(const t of e)this.set(t.name,t.value);if(!this._cameraSetByUser){const e=this._initialViewpoint||this.view.initialExtent;e&&this.isCompatible(e)?this._setInitialView(e):this.view.state.viewingMode===Si.JY.Local&&this.addHandles((0,n.gx)((()=>this.view.basemapTerrain.ready),(()=>{this.removeHandles(nh),this._setInitialView(this.view.dataExtent)}),{once:!0,initial:!0}),nh)}}exit(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this._cameraSetByUser=!1,this.removeHandles(nh),this._constraintsManager=(0,f.SC)(this._constraintsManager))}async goTo(e,t){return t={animate:!0,...t},null!=this._gotoOperation&&this._gotoOperation.abort(t.animate),this._gotoOperation=new jc(e,t,this.view),this.view.resourceController.scheduler.stopFrame(),this._gotoOperation.promise}debugSetCameraOnContent(){this.setStateCamera((0,sa.dP)(this.view),{applyConstraints:!1})}step(e){const t=this.view.state,i=t?.cameraController;i&&(t.updateCamera((t=>i.stepController(e,t))),i.steppingFinished&&i.finishController())}_cancelGoToOperation(){null!=this._gotoOperation&&(this._gotoOperation.abort(),this._gotoOperation=null)}_getInitialProperties(){const e=new Set,t=[];for(const{propertyName:i,overrides:r}of eh){const s=e.has(i),n=this._isOverridden(i);!s&&n&&t.push({name:i,value:this._get(i)}),this._clearOverride(i),(s||n)&&r.forEach((t=>e.add(t)))}return t}_setInitialView(e){if(null==e||this._cameraSetByUser)return;if(e instanceof s.Z)return void this.setStateCamera((0,ne.n3)(this.view,e),{applyConstraints:!1});if(e instanceof l.Z){if(e.targetGeometry instanceof I.Z){const t=(0,ne.S9)(this.view,e.targetGeometry,0,.5,ne.Q8.LOCKED);return void(null!=t&&this.setStateCamera((0,ne.n3)(this.view,t),{applyConstraints:!0}))}const t={applyConstraints:!e.camera},i=this._viewpointToCamera(e);return void this.setStateCamera(i,t)}const t=(0,ne.S9)(this.view,e,0,.5,ne.Q8.LOCKED);null!=t&&this.setStateCamera((0,ne.n3)(this.view,t),{applyConstraints:!0})}_updatePropertyBeforeReady(e,t){return!this.ready&&(this._override(e,t),t&&Jc.has(e)&&this._override("hasInitialView",!0),!0)}isCompatible(e){return null!=e&&(e instanceof l.Z?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof s.Z?this.isCompatible(e.position):e.spatialReference&&!(0,F.requiresLoad)(e.spatialReference,this.view.spatialReference))}_getPreservingHeadingTilt(e=th){return this._cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}_centerPointAtDistanceToCamera(e,t,i=rh){const{heading:r,tilt:s}=this._getPreservingHeadingTilt(),n=(0,ne.P$)(this.view,r,s,e,t,ne.Q8.ADJUST);return null==n?null:(i.copyFrom(this.view.state.camera),i.eye=n.eye,i.center=n.center,i.up=n.up,i)}_centerToCamera(e){let t;if(e.hasZ)t=this.view.state.camera.distance;else{const{centerOnContent:e}=this.view.pointsOfInterest;e.runTask(),t=e.distance}return this._centerPointAtDistanceToCamera(e,t)}_extentToCamera(e){const{heading:t,tilt:i}=this._getPreservingHeadingTilt(),r=(0,ne.S9)(this.view,e,t,i,ne.Q8.ADJUST,ih);return r?(0,ne.n3)(this.view,r):null}_scaleToCamera(e){if(null==e)return null;const t=this.view,i=t.pointsOfInterest.centerOnContent;i.runTask();const r=i.renderLocation,s=t.pointsOfInterest.cameraOnSurface.renderLocation,n=(0,ne.cb)(t,e,t.state.contentCamera,r,s);return this._centerPointAtDistanceToCamera(r,n)}_zoomToCamera(e){return this._scaleToCamera((0,ne.EO)(this.view,e))}_viewpointToCamera(e){return(0,ne.n3)(this.view,(0,Zc.QI)(this.view,e))}setStateCamera(e,t){return!(null==e||!this.view.state.stopActiveCameraController()||(this._cameraSetByUser=!0,t.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera((i=>{t.positionAndOrientationOnly?(i.eye=e.eye,i.center=e.center,i.up=e.up,i.fov=e.fov):i.copyFrom(e),t.applyConstraints&&so(this.view,i)})),t.applyConstraints||(this.view.state.cameraController=new qc({view:this.view,desiredCamera:e})),0))}_prepareFrame(){const{surface:e,canvas:t}=this.view;if(!e||!t)return;this._windowDevicePixelRatio=window.devicePixelRatio;const i=this._computeCanvasSize();if(0!==i.width&&0!==i.height&&(t.width===i.width&&t.height===i.height||(t.width=i.width,t.height=i.height),this.view.state)){const e=this.view.state.camera;e.fullWidth===i.width&&e.fullHeight===i.height&&e.pixelRatio===i.pixelRatio||(rh.copyFrom(e),rh.pixelRatio!==i.pixelRatio&&(this._paddingToArray(this.padding,i.pixelRatio,sh),rh.padding=sh),rh.fullWidth=i.width,rh.fullHeight=i.height,rh.pixelRatio=i.pixelRatio,this.view.state.camera=rh),this._updateViewState()}}_updateElevation(e){const t=this.view.basemapTerrain?.spatialReference,i=this.view.renderCoordsHelper?.getAltitude(e.eye)??0,r=t?(0,sa.wH)(this.view,e.eye):0;e.relativeElevation=i-r}_updateViewState(){null!=this.test.renderState?this.view.state.mode=this.test.renderState:this.view.animation?this.view.state.mode=Yc.n.ANIMATING:this.view.interacting?this.view.state.mode=Yc.n.INTERACTING:(this.view.state.mode===Yc.n.ANIMATING&&(this._cameraChangeTime=0),performance.now()-this._cameraChangeTime<this._idleTimeout?this.view.state.mode=Yc.n.INTERACTING:this.view.state.mode=Yc.n.IDLE),this.view.state.rasterPixelRatio=this._rasterPixelRatio}_cameraChangedHandler(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=performance.now(),this._updateViewState())}};(0,o._)([(0,x.Cb)({type:s.Z,dependsOn:["view.state.camera","ready"]})],Qc.prototype,"camera",null),(0,o._)([(0,x.Cb)({type:s.Z,dependsOn:["view.state.contentCamera","ready"]})],Qc.prototype,"contentCamera",null),(0,o._)([(0,x.Cb)({type:a.Z})],Qc.prototype,"center",null),(0,o._)([(0,x.Cb)()],Qc.prototype,"visibleArea",null),(0,o._)([(0,x.Cb)({type:I.Z})],Qc.prototype,"extent",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Qc.prototype,"frustum",null),(0,o._)([(0,x.Cb)()],Qc.prototype,"_constraintsManager",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Qc.prototype,"constraintsManager",null),(0,o._)([(0,x.Cb)()],Qc.prototype,"_initialViewpoint",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Qc.prototype,"hasInitialView",null),(0,o._)([(0,x.Cb)({readOnly:!0,type:Boolean})],Qc.prototype,"ready",void 0),(0,o._)([(0,x.Cb)({type:Number})],Qc.prototype,"scale",null),(0,o._)([(0,x.Cb)()],Qc.prototype,"padding",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Qc.prototype,"screenCenter",null),(0,o._)([(0,x.Cb)({constructOnly:!0})],Qc.prototype,"view",void 0),(0,o._)([(0,x.Cb)({type:l.Z})],Qc.prototype,"viewpoint",null),(0,o._)([(0,x.Cb)({type:Number})],Qc.prototype,"zoom",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Qc.prototype,"_rasterPixelRatio",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Qc.prototype,"_usePhysicalPixelRendering",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Qc.prototype,"_usePhysicalPixelRenderingAny",null),(0,o._)([(0,x.Cb)()],Qc.prototype,"_windowDevicePixelRatio",void 0),(0,o._)([(0,x.Cb)()],Qc.prototype,"_devicePixelRatioOverride",void 0),Qc=(0,o._)([(0,S.j)("esri.views.3d.state.ViewStateManager")],Qc);class Kc{constructor(){this.width=0,this.height=0,this.pixelRatio=1}}const Jc=new Set(["camera","viewpoint","extent","scale","center","zoom"]),eh=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],th={heading:0,tilt:0},ih=new s.Z,rh=new Xo.Z,sh=(0,Uc.Ue)(),nh="pending-initial-view",ah="content-camera-reset",oh=300;let lh=class extends Wo{constructor(){super(...arguments),this.startCamera=new Xo.Z,this.currentCamera=new Xo.Z,this._isInteractive=!1,this._interactingTimeoutHandle=void 0}get isInteractive(){return this._isInteractive}stepController(e,t){t.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(t)}onControllerStart(e){this.state=jo.Running,this.startCamera.copyFrom(e),this.currentCamera.copyFrom(e)}onControllerEnd(e){e.copyViewFrom(this.currentCamera)}commitCamera(){this._isInteractive=!0,this._interactingTimeoutHandle?.remove(),this._interactingTimeoutHandle=Vt.m.setTimeout((()=>{this._isInteractive=!1,this._interactingTimeoutHandle=void 0}),100),this.view.state.updateCamera((e=>this.stepController(0,e))),this.steppingFinished&&this.finishController()}};var ch;(0,o._)([(0,x.Cb)({readOnly:!0})],lh.prototype,"isInteractive",null),(0,o._)([(0,x.Cb)()],lh.prototype,"_isInteractive",void 0),lh=(0,o._)([(0,S.j)("esri.views.3d.state.controllers.InteractiveController")],lh),function(e){e[e.CENTER=0]="CENTER",e[e.EYE=1]="EYE"}(ch||(ch={}));let hh=class extends lh{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.pivot=ch.CENTER,this._rotScale=0,this._lastPoint=(0,Rr.Ue)(),this._tmpWorldUp=(0,O.Ue)(),this._tmpViewDir=(0,O.Ue)(),this._tmpRotCurPoint=(0,Rr.Ue)(),this._tmpTransf=(0,Mr.Ue)(),this._tmpAxis=(0,O.Ue)(),this._tmpPivotPoint=(0,O.Ue)(),this._pivotPos=(0,O.Ue)(),this._constraintOptions=new Un(Dn.ALL,In.TUMBLE,0,this.startCamera)}initialize(){this._rotScale=this.pivot===ch.CENTER?3:1.5}begin(e){if(this.running){switch(this.pivot){case ch.EYE:(0,mr.c)(this._pivotPos,this.startCamera.eye),this._constraintOptions.interactionType=In.LOOK_AROUND,this._constraintOptions.tiltMode=Ln.LOOK_AROUND,this._constraintOptions.selection=Dn.NONE;break;case ch.CENTER:{const t=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos,this.view.basemapTerrain.invisible?vl:{});t||(0,mr.c)(this._pivotPos,this.startCamera.center),this._constrainPivotPoint(e,t),this.startCamera.center=this._pivotPos,this._constraintOptions.interactionType=In.TUMBLE,this._constraintOptions.tiltMode=Ln.TUMBLE,this._constraintOptions.selection=Dn.ALL&~Dn.DISTANCE;break}}bl(this.startCamera,e,this._lastPoint)}}_constrainPivotPoint(e,t){const i=this.startCamera,r=(0,O.Ue)();(0,mr.d)(r,this._pivotPos,i.eye);const s=(0,mr.l)(r),n=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(i.eye,dh);let a=Math.max(Math.min(5,1/Math.abs((0,mr.e)(dh,i.viewForward)))*n,10);t&&(a=Math.min(s,a));const o=(0,b.s1)(i.width/i.pixelRatio*.5,i.height/i.pixelRatio*.5),l=Ll(this.startCamera,o,this.view.renderCoordsHelper,this.view.viewingMode);let c=this.view.stage.renderView.getMinimalDepthForArea((0,Mc.$L)(this.view),i.fullWidth/i.pixelRatio*.5,i.fullHeight/i.pixelRatio*.5,i,225,90),h=this.view.stage.renderView.getMinimalDepthForArea((0,Mc.$L)(this.view),e[0],e[1],i,90);null==c&&null==h||(c=c??h??0,h=null==h||l===Al.Horizontal?c:h,a=c>h?h:c,a=t?Math.min(a,s):a),(0,mr.n)(r,r),(0,mr.c)(this._pivotPos,(0,mr.f)(this._tmpPivotPoint,i.eye,(0,mr.g)(this._tmpPivotPoint,r,a)))}update(e){if(this.running){switch(this.pivot){case ch.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,e,this.currentCamera.center,this._pivotPos);break;case ch.CENTER:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,e,this.currentCamera.eye,this._pivotPos)}so(this.view,this.currentCamera,this._constraintOptions),this.commitCamera()}}end(){this.running&&this.finishController()}_applyRotation(e,t,i,r){this.view.renderCoordsHelper.worldUpAtPosition(r,this._tmpWorldUp),bl(e,t,this._tmpRotCurPoint);let s=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale,n=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;(0,mr.d)(this._tmpViewDir,i,r);const a=(0,mr.l)(this._tmpViewDir),o=(0,jt.ZF)((0,mr.e)(this._tmpViewDir,this._tmpWorldUp)/a);if(this.pivot===ch.EYE){s*=-.5;const e=.5*Math.PI-o,t=.5*Math.PI*.99;s=e-Math.max(-t,Math.min(t,e+s))}return s=(0,jt.uZ)(s+o,ar.min,ar.max)-o,(0,mr.h)(this._tmpAxis,e.up,this._tmpViewDir),this.pivot===ch.CENTER&&(n=-n),(0,Sr.Us)(this._tmpTransf,n,this._tmpWorldUp),(0,Sr.U1)(this._tmpTransf,this._tmpTransf,s,this._tmpAxis),(0,mr.t)(this._tmpViewDir,this._tmpViewDir,this._tmpTransf),e.up=(0,mr.t)(uh,e.up,this._tmpTransf),(0,mr.f)(uh,r,this._tmpViewDir),(0,Er.JG)(this._lastPoint,this._tmpRotCurPoint),uh}};(0,o._)([(0,x.Cb)()],hh.prototype,"pivot",void 0),hh=(0,o._)([(0,S.j)("esri.views.3d.state.controllers.RotateController")],hh);const uh=(0,O.Ue)(),dh=(0,O.Ue)();class ph extends Oc.a{constructor(e,t,i,r){super(!0),this._view=e,this.pointerActions=t,this._pivot=i,this.registerIncoming("drag",r,(e=>this._handleDrag(e)))}_handleDrag(e){const t=e.data;if(t.pointers.size>1)return;if(!Ic(e.data,this.pointerActions))return;const i=(0,b.s1)(t.center.x,t.center.y);switch(t.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._cameraController=new hh({view:this._view,pivot:this._pivot}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":this._cameraController&&this._cameraController.update(i);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}}const mh="esri-component";let _h=class extends E.Z{constructor(){super(...arguments),this.widget=null}destroy(){this.node=null,this.widget?.destroy()}get id(){return this._get("id")??this.widget?.id??this.node?.id}set id(e){this._set("id",e)}set node(e){const t=this._get("node");e!==t&&(e&&e.classList.add(mh),t&&t.classList.remove(mh),this._set("node",e))}castNode(e){return this.widget?.destroy(),e?"string"==typeof e||function(e){return e&&"nodeType"in e}(e)?(this._set("widget",null),(0,h.L)(e)):(function(e){return e&&"function"==typeof e.render}(e)&&!e.domNode&&(e.domNode=document.createElement("div")),this._set("widget",e),e.domNode):(this._set("widget",null),null)}};(0,o._)([(0,x.Cb)()],_h.prototype,"id",null),(0,o._)([(0,x.Cb)()],_h.prototype,"node",null),(0,o._)([(0,T.p)("node")],_h.prototype,"castNode",null),(0,o._)([(0,x.Cb)({readOnly:!0})],_h.prototype,"widget",void 0),_h=(0,o._)([(0,S.j)("esri.views.ui.Component")],_h);const fh=_h;var gh=i(51067),yh=i(1803),vh=i(68808),bh=i(24225),wh=i(23039);const Ch="esri-fov-overlay",xh={base:Ch,outer:`${Ch}-outer`,reset:`${Ch}-reset`,text:`${Ch}-text`};let Th=class extends yh.Z{constructor(e){super(e),this.onReset=()=>{},this._messagesCommon=null,this._messagesUnits=null,this.fov=null}render(){return(0,wh.u)("div",{class:xh.outer},(0,wh.u)("div",{class:xh.base},(0,wh.u)("p",{class:xh.text},this._overlay),(0,wh.u)("p",{class:xh.reset,onclick:this.onReset,title:this._messagesCommon.reset},this._reset)))}get _overlay(){const{fov:e,_messagesUnits:t}=this;if(!t||null==e)return"";const i=(0,gh.L4)((0,jt.BV)(e),"degrees","arithmetic","arithmetic",0),r=Sh/(2*Math.tan(e/2));return`${i} | ${(0,gh.VG)(t,r,"millimeters",0,"abbr")} |`}get _reset(){return this._messagesUnits&&null!=this.fov?"":""}};(0,o._)([(0,x.Cb)()],Th.prototype,"onReset",void 0),(0,o._)([(0,x.Cb)(),(0,bh.H)("esri/t9n/common")],Th.prototype,"_messagesCommon",void 0),(0,o._)([(0,x.Cb)(),(0,bh.H)("esri/core/t9n/Units")],Th.prototype,"_messagesUnits",void 0),(0,o._)([(0,x.Cb)()],Th.prototype,"fov",void 0),(0,o._)([(0,x.Cb)()],Th.prototype,"_overlay",null),(0,o._)([(0,x.Cb)()],Th.prototype,"_reset",null),Th=(0,o._)([(0,S.j)("esri.widgets.FovOverlay")],Th);const Sh=Math.sqrt(1872);let Mh=class extends lh{constructor(e){super(e),this.onStop=null,this._timeOutId=void 0,this._onReset=()=>{this._startSize=this._lastDrag=null,this._setFov(Eh),this.updateTimeout()},this._center=(0,O.Ue)(),this._viewForward=(0,O.Ue)(),this._constraints=new Un(Dn.ALL,In.ZOOM)}begin(e){!function(e){return!Array.isArray(e)}(e)?(this._lastDrag=e[1],this._startSize=null,this._ensureStartSize(this.view.state.camera)):this._showOverlay().fov=e.fov}updateTimeout(){clearTimeout(this._timeOutId),this._timeOutId=setTimeout(this.onStop,1500)}update(e){if(null==this._lastDrag)return this._lastDrag=e[1],this._startSize=null,void this._ensureStartSize(this.view.state.camera);const t=-(this._lastDrag-e[1])/2;this._lastDrag=e[1],this.step(t)}step(e){if(!this.running)return void(this._startSize=this._lastDrag=null);const t=this.view.state,i=this.currentCamera.copyFrom(t.camera),r=(0,jt.BV)(i.fov)+e,s=(0,jt.Vl)((0,jt.uZ)(r,Rh,Ph));s!==i.fov?this._setFov(s):this._showOverlay().fov=i.fov}finish(){this.running&&(this._startSize=this._lastDrag=null,this.finishController())}destroy(){this.hideOverlay()}onControllerEnd(e){super.onControllerEnd(e),this._startSize=this._lastDrag=null,this.hideOverlay()}_showOverlay(){return this._overlay||(this._overlay=new fh({id:"esri.FovOverlay",node:new Th({onReset:this._onReset})}),this.view.ui.add(this._overlay)),this._overlay.widget}hideOverlay(){this._overlay&&(this.view.ui.remove(this._overlay),this._overlay=(0,f.SC)(this._overlay))}_setFov(e){const t=this.view.state,i=this.currentCamera.copyFrom(t.camera),r=this._ensureStartSize(i)/Math.tan(e/2),s=(0,mr.f)(Ah,this._center,(0,mr.g)(Ah,this._viewForward,-r));i.eye=s,i.fov=e,this._constraints.interactionStartCamera=t.camera,this._constraints.interactionFactor=no(this.currentCamera.height-t.camera.height),so(this.view,this.currentCamera,this._constraints),this.begin(i),this.commitCamera()}_ensureStartSize(e){if(null==this._startSize){(0,mr.c)(this._viewForward,e.viewForward);const t=this.view.stage.renderView.getMinimalDepthForArea(null,e.fullWidth/e.pixelRatio*.5,e.fullHeight/e.pixelRatio*.5,e,80),i=(0,mr.j)(e.eye,this.view.pointsOfInterest.centerOnContent.renderLocation),r=t??i;(0,mr.f)(this._center,e.eye,(0,mr.g)(Ah,this._viewForward,r)),this._startSize=r*Math.tan(e.fov/2)}return this._startSize}};(0,o._)([(0,x.Cb)()],Mh.prototype,"onStop",void 0),Mh=(0,o._)([(0,S.j)("esri.views.3d.state.controllers.FovController")],Mh);const Eh=(0,jt.Vl)((new s.Z).fov),Rh=10,Ph=150,Ah=(0,O.Ue)();let Oh=class extends lh{constructor(){super(...arguments),this._pickPoint=(0,O.Ue)(),this._tmpP0=(0,Rr.Ue)(),this._panAxisAngle=al(),this._tmpRayDir=(0,O.Ue)(),this._tmpRayDirPick=(0,O.Ue)(),this._targetOnSphere=(0,O.Ue)(),this._navMode=Al.Horizontal,this._tmpRay={origin:(0,O.Ue)(),direction:(0,O.Ue)()},this.dragBeginPoint=(0,b.s1)(),this._normalizedAnchorPoint=(0,Rr.Ue)(),this._constraintOptions=new Un(Dn.ALL_EXCEPT_COLLISION,In.ZOOM,0,this.startCamera),this._sphere=(0,Nn.c)(),this._hasPickPoint=!1}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;(0,Er.JG)(this.dragBeginPoint,e),bl(this.startCamera,e,this._normalizedAnchorPoint);const t=(0,vr.Iu)(this.view.spatialReference),i=Il(this._intersectionHelper,this.startCamera,e,t.radius,_l.Ellipsoid,this.view.basemapTerrain.invisible?vl:{});if(this._navMode=Ll(this.startCamera,e,this.view.renderCoordsHelper,this.view.viewingMode),this._navMode===Al.Horizontal)this._hasPickPoint=!!i.scenePickPoint,this._pickPoint=i.scenePickPoint??this._pickPoint,this._sphere=i.sphere;else{let t;(0,dl.iE)(this.startCamera,e,this._tmpRay),(0,mr.n)(this._tmpRay.direction,this._tmpRay.direction),null!=i.scenePickPoint&&((0,mr.d)(this._tmpRayDirPick,this.startCamera.eye,i.scenePickPoint),t=(0,mr.l)(this._tmpRayDirPick));const r=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(this.startCamera.eye,Ih);let s=(0,jt.uZ)(Math.min(30,1/Math.abs((0,mr.e)(Ih,this._tmpRay.direction)))*r,gl[0],gl[1]);const n=this.view.stage.renderView.getMinimalDepthForArea(null,e[0],e[1],this.view.state.camera,80);s=null!=n?n:s,s=null!=t?Math.min(s,t):s,this._hasPickPoint=!0,(0,mr.g)(this._tmpRay.direction,this._tmpRay.direction,s),(0,mr.f)(this._pickPoint,this._tmpRay.origin,this._tmpRay.direction)}}update(e){if(this.running){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this._navMode===Al.Horizontal){(0,mr.d)(this._tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const t=(0,mr.l)(this._tmpRayDir);bl(this.currentCamera,e,this._tmpP0);const i=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let r=t*2**i;const s=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<s&&(r=s),Math.abs(t-r)<1e-6)return;if(this._hasPickPoint&&r<t){const e=1-(1-r/t)*(1-this._sphere[3]/(0,mr.l)(this.currentCamera.center));this.currentCamera.center=(0,mr.g)(Dh,this.currentCamera.center,e)}(0,mr.g)(this._tmpRayDir,this._tmpRayDir,-r/t),this.currentCamera.eye=(0,mr.f)(Dh,this.currentCamera.center,this._tmpRayDir),this._constraintOptions.interactionFactor=no((0,Er.TE)(this.dragBeginPoint,e)),so(this.view,this.currentCamera,this._constraintOptions),this._hasPickPoint&&(Ul(this._sphere,this.currentCamera,this.dragBeginPoint,this._targetOnSphere),cl(this._pickPoint,this._targetOnSphere,this._panAxisAngle),Cl(this.currentCamera,(0,Nn.a)(this._sphere),this._panAxisAngle))}else{const t=(0,mr.l)(this._tmpRay.direction);bl(this.currentCamera,e,this._tmpP0);const i=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let r=t*2**i;const s=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<s&&(r=s),Math.abs(t-r)<1e-6)return;(0,mr.g)(this._tmpRayDir,this._tmpRay.direction,1-r/t),this.currentCamera.eye=(0,mr.f)(Dh,this.currentCamera.eye,this._tmpRayDir),this.currentCamera.center=(0,mr.f)(Dh,this.currentCamera.center,this._tmpRayDir)}na(this.view,this.currentCamera),this.commitCamera()}}finish(){this.running&&this.finishController()}};Oh=(0,o._)([(0,S.j)("esri.views.3d.state.controllers.ZoomControllerGlobal")],Oh);const Dh=(0,O.Ue)(),Ih=(0,O.Ue)();let Lh=class extends lh{constructor(){super(...arguments),this._tmpP=(0,O.Ue)(),this._tmpDir=(0,O.Ue)(),this._tmpN=(0,O.Ue)(),this._tmpP0=(0,Rr.Ue)(),this._tmpPOI=(0,O.Ue)(),this._tmpRayDir=(0,O.Ue)(),this.dragBeginPoint=(0,b.s1)(),this._normalizedAnchorPoint=(0,Rr.Ue)(),this._constraintOptions=new Un(Dn.ALL,In.ZOOM,0,this.startCamera,(0,O.Ue)()),this._plane=(0,ul.Ue)()}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;(0,Er.JG)(this.dragBeginPoint,e),bl(this.startCamera,e,this._normalizedAnchorPoint);const t=this._intersectionHelper.intersectScreenFreePointFallback(e,this._tmpP,this.view.basemapTerrain.invisible?vl:{});(0,mr.d)(this._tmpDir,this._tmpP,this.startCamera.eye);const i=(0,mr.l)(this._tmpDir);(0,mr.n)(this._tmpDir,this._tmpDir);const r=Math.abs(this.view.camera.position.z);let s=(0,jt.uZ)(Math.min(30,1/Math.abs((0,mr.e)(Nh,this._tmpDir)))*r,gl[0],gl[1]);const n=this.view.stage.renderView.getMinimalDepthForArea((0,Mc.$L)(this.view),e[0],e[1],this.view.state.camera,80);s=null!=n?n:s,s=t?Math.min(s,i):s,(0,mr.g)(this._tmpDir,this._tmpDir,s),(0,mr.f)(this._tmpP,this.startCamera.eye,this._tmpDir),(0,mr.d)(this._tmpN,this.startCamera.eye,this.startCamera.center),(0,mr.n)(this._tmpN,this._tmpN),this._tmpN[1]<0&&(0,mr.u)(this._tmpN,this._tmpN),(0,ul.Yq)(this._tmpP,this._tmpN,this._plane)}update(e){if(!this.running)return;(function(e,t,i,r){return(0,ul.BR)(e,(0,dl.u4)(t,i,wc),r)})(this._plane,this.currentCamera,this.dragBeginPoint,this._tmpPOI)||(0,mr.c)(this._tmpPOI,this.currentCamera.center),bl(this.currentCamera,e,this._tmpP0);let t=4*(this._tmpP0[1]-this._normalizedAnchorPoint[1]);(0,Er.JG)(this._normalizedAnchorPoint,this._tmpP0),(0,mr.d)(this._tmpRayDir,this._tmpPOI,this.currentCamera.eye);const i=(0,mr.l)(this._tmpRayDir);let r=i*(1-t);this._constraintOptions.interactionDirection&&((0,mr.c)(this._constraintOptions.interactionDirection,this._tmpRayDir),(0,mr.g)(this._constraintOptions.interactionDirection,this._constraintOptions.interactionDirection,Math.sign(t)/i));const s=this.view.state.constraints.minimumPoiDistance;t>=0&&r<s&&(r=s,t=-(r-i)/i),Math.abs(i-r)<1e-6||((0,mr.g)(this._tmpRayDir,this._tmpRayDir,t),this.currentCamera.eye=(0,mr.f)(Fh,this.currentCamera.eye,this._tmpRayDir),(0,mr.m)(Fh,this.currentCamera.center,this._tmpPOI,t),this._tmpPOI[2]>this.startCamera.center[2]?Fh[2]=Math.max(this.startCamera.center[2],Fh[2]):Fh[2]=Math.min(this.startCamera.center[2],Fh[2]),this.currentCamera.center=Fh,this._constraintOptions.interactionFactor=no((0,Er.TE)(this.dragBeginPoint,e)),so(this.view,this.currentCamera,this._constraintOptions),this.commitCamera())}finish(){this.running&&this.finishController()}};Lh=(0,o._)([(0,S.j)("esri.views.3d.state.controllers.ZoomControllerLocal")],Lh);const Fh=(0,O.Ue)(),Nh=(0,O.al)(0,0,1);class Uh extends Oc.a{constructor(e,t,i){super(!0),this._view=e,this.pointerActions=t,this._fovModifier=i,this.registerIncoming("drag",[i],(e=>this._handleZoom(e))),this.registerIncoming("drag",(e=>this._handleZoom(e)))}_handleZoom(e){const t=e.data;if(t.pointers.size>1)return;if(!Ic(e.data,this.pointerActions))return;const i=(0,b.s1)(t.center.x,t.center.y);switch(t.action){case"start":{this._cameraController?.finish();const t=this._view,r=e.modifiers.has(this._fovModifier);this._cameraController=r?new Mh({view:t,onStop:()=>this._stopController()}):t.state.isGlobal?new Oh({view:t}):new Lh({view:t}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break}case"update":this._cameraController?.update(i);break;case"end":this._cameraController instanceof Mh?this._cameraController.updateTimeout():this._stopController()}e.stopPropagation()}_stopController(){this._cameraController?.finish(),this._cameraController=null}}var Hh=i(59758);function Vh(e){let t=e*e;return e<0&&(t*=-1),t}function kh(e,t,i){const r=i,s=e.state,n=e.device,a="forward-down"===t.tiltDirection?1:-1;return"standard"===n.deviceType?(r.translation[0]=Vh(s.axes[0]),r.translation[1]=Vh(s.axes[1]),r.translation[2]=Vh(s.buttons[7])-Vh(s.buttons[6]),r.heading=Vh(s.axes[2]),r.tilt=Vh(s.axes[3])):"spacemouse"===n.deviceType&&(r.translation[0]=1.2*Vh(s.axes[0]),r.translation[1]=1.2*Vh(s.axes[1]),r.translation[2]=2*-Vh(s.axes[2]),r.heading=1.2*Vh(s.axes[5]),r.tilt=1.2*Vh(s.axes[3])),r.tilt*=a,(0,mr.g)(r.translation,r.translation,1),r}function Bh(e,t){const i=t;return i.translation[0]=e[1]-e[0],i.translation[1]=e[3]-e[2],i.translation[2]=e[4]-e[5],i.heading=e[7]-e[6],i.tilt=e[8]-e[9],i.zoom=e[10]-e[11],i}function zh(e){return 0===e.translation[0]&&0===e.translation[1]&&0===e.translation[2]&&0===e.heading&&0===e.tilt&&0===e.zoom}let Gh=class extends lh{constructor(e){super(e),this._filteredSurfaceElevation=0,this._transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this._keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this._tmpCamera=new Xo.Z,this._headingStart=0,this._constraintOptions=new Un(Dn.ALL,In.NONE,0,new Xo.Z,null,Ln.LOOK_AROUND)}handleEventGamepad(e){const t=kh(e,this.view.navigation.gamepad,this._transformation);("end"===e.action||zh(t))&&this.finishController()}activateDirection(e){this._keysButtonState[e]=1,Bh(this._keysButtonState,this._transformation)}directionActive(e){return 1===this._keysButtonState[e]}countActiveDirections(){return this._keysButtonState.reduce(((e,t)=>t>0?e+1:e),0)}deactivateDirection(e){this._keysButtonState[e]=0;zh(Bh(this._keysButtonState,this._transformation))&&this.finishController()}onControllerStart(e){this._filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this._headingStart=this.view.camera.heading,super.onControllerStart(e)}_updateFilteredSurfaceElevation(e){const t=this.view.pointsOfInterest.cameraOnSurface.location.z;this._filteredSurfaceElevation+=1*(t-this._filteredSurfaceElevation)*e}stepController(e,t){this._updateStartHeading(),this._updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(t),this._updateCameraCenter(),this._constraintOptions.interactionStartCamera?.copyFrom(this.currentCamera),this._calculateControlTransformation(e,this.currentCamera,Qh),this._applyDisabledMovementTypes(Qh),this._applyPan(Qh.pan),this._applyRotate(Qh.rotate),this._applyZoom(Qh.zoom),this._applyAscend(Qh.ascend),this._constraintOptions.interactionType=In.NONE,this._constraintOptions.selection=Dn.COLLISION,so(this.view,this.currentCamera,this._constraintOptions),super.stepController(e,t)}_updateStartHeading(){0!==this._transformation.heading&&(this._headingStart=this.view.camera.heading)}_applyRotate(e){if(!e.enabled)return;const t=this.currentCamera;(0,mr.d)(Kh,t.center,t.eye),(0,mr.t)(Kh,Kh,e.matrix),t.center=(0,mr.f)(Kh,Kh,t.eye),t.up=(0,mr.t)(Kh,t.up,e.matrix),this._constraintOptions.interactionType=In.LOOK_AROUND,this._constraintOptions.selection=Dn.ALL_EXCEPT_COLLISION,so(this.view,t,this._constraintOptions)}_applyPan(e,t=this.currentCamera){e.enabled&&(t.eye=(0,mr.t)(Kh,t.eye,e.matrix),t.center=(0,mr.t)(Kh,t.center,e.matrix),this.view.state.isGlobal&&(t.up=(0,mr.t)(Kh,t.up,e.matrix)),this._constraintOptions.interactionType=In.PAN,this._constraintOptions.selection=Dn.ALL,so(this.view,t,this._constraintOptions))}_applyZoom(e){if(!e)return;const t=this.currentCamera.viewForward;this.currentCamera.eye=(0,mr.f)(Kh,this.currentCamera.eye,(0,mr.g)(nl.WM.get(),t,e)),(0,mr.c)(Jh,t),(0,mr.u)(Jh,Jh),this._constraintOptions.interactionDirection=Jh,this._constraintOptions.interactionType=In.ZOOM,this._constraintOptions.selection=Dn.ALL_EXCEPT_COLLISION,so(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_applyAscend(e){if(!e)return;const t=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,nl.WM.get());if(this._constraintOptions.interactionDirection=(0,mr.c)(Jh,t),this.view.state.isGlobal){const t=(0,mr.l)(this.currentCamera.eye),i=(t+e)/t;this.currentCamera.eye=(0,mr.g)(Kh,this.currentCamera.eye,i),this.currentCamera.center=(0,mr.g)(Kh,this.currentCamera.center,i)}else{const i=(0,mr.g)(nl.WM.get(),t,e);this.currentCamera.eye=(0,mr.f)(Kh,this.currentCamera.eye,i),this.currentCamera.center=(0,mr.f)(Kh,this.currentCamera.center,i)}this._updateCameraCenter(),this._constraintOptions.interactionType=In.ASCEND,this._constraintOptions.selection=Dn.COLLISION,so(this.view,this.currentCamera,this._constraintOptions)&&this._updateCameraCenter(),this._constraintOptions.selection=Dn.ALL_EXCEPT_COLLISION,so(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_calculateControlTransformation(e,t,i){!function(e){e.zoom=0,e.ascend=0,e.pan.enabled=!1,(0,Sr.yR)(e.pan.matrix),e.rotate.enabled=!1,(0,Sr.yR)(e.rotate.matrix)}(i);const r=this._computeVelocities(e);this.view.state.isLocal?this._calculateControlTransformationLocal(r,t,i):this._calculateControlTransformationGlobal(r,t,i)}_updateCameraCenter(){const e=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,t=this.view.renderCoordsHelper,i=this.currentCamera.ray;this.currentCamera.center=t.intersectManifoldClosestSilhouette(i,e,Kh)}_calculateControlTransformationLocal(e,t,i){const{viewRight:r,viewForward:s}=t,n=this._transformation,a=this.view.navigation.gamepad,o=(0,mr.i)(nl.WM.get(),s[0],s[1],0);(0,mr.n)(o,o);const l=n.translation[0]*e.pan;if(0!==l){const e=(0,mr.g)(nl.WM.get(),r,l);(0,Sr.Iu)(i.pan.matrix,i.pan.matrix,e),i.pan.enabled=!0}switch(a.mode){case"pan":{const t=-n.translation[1]*e.pan;if(0!==t){const e=(0,mr.g)(nl.WM.get(),o,t);(0,Sr.Iu)(i.pan.matrix,i.pan.matrix,e),i.pan.enabled=!0}i.zoom=n.zoom*e.zoom;break}case"zoom":i.zoom=(-n.translation[1]+n.zoom)*e.zoom;break;default:(0,Se.Bg)(a.mode)}const c=n.translation[2]*e.ascend;i.ascend=c;const h=-n.heading*e.rotate;0!==h&&((0,Sr.U1)(i.rotate.matrix,i.rotate.matrix,h,this.view.renderCoordsHelper.worldUpAtPosition(t.eye,nl.WM.get())),i.rotate.enabled=!0);const u=n.tilt*e.rotate,d=(0,la.L)(this.view.renderCoordsHelper,t.center,t.eye),p=(0,jt.uZ)(d+u,ar.min,ar.max)-d;p&&((0,Sr.U1)(i.rotate.matrix,i.rotate.matrix,p,r),i.rotate.enabled=!0)}_calculateControlTransformationGlobal(e,t,i){const{eye:r,viewRight:s}=t,n=this._transformation,a=this.view.navigation.gamepad,o=(0,mr.h)(nl.WM.get(),s,r);(0,mr.n)(o,o),(0,mr.u)(o,o),tc(this.startCamera,t,n,e,this.view.camera.heading,this._headingStart,this.view.camera.tilt,i,a),this._tmpCamera.copyFrom(this.currentCamera),this._applyPan(Qh.pan,this._tmpCamera);const l=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,c=n.translation[2]*e.ascend;i.ascend=c;const h=-n.heading*e.rotate;0!==h&&((0,Sr.U1)(i.rotate.matrix,i.rotate.matrix,h,this._tmpCamera.eye),i.rotate.enabled=!0);const u=n.tilt*e.rotate,d=this._clampTiltDeltaGlobalToValidRange(u,t.ray,l);0!==d&&((0,Sr.U1)(i.rotate.matrix,i.rotate.matrix,d,this._tmpCamera.viewRight),i.rotate.enabled=!0),i.zoom+=n.zoom*e.zoom}_clampTiltDeltaGlobalToValidRange(e,t,i){const r=(0,vr.Iu)(this.view.spatialReference),s=Rl(ar.min,t.origin,i,r);let n=0,a=0;const o=nl.WM.get();if(this.view.renderCoordsHelper.intersectManifold(t,i,o)){n=Rl((0,la.L)(this.view.renderCoordsHelper,o,t.origin),t.origin,i,r),a=Rl(ar.max,t.origin,i,r)}else{(0,Nn.j)((0,Nn.b)(Nn.t,i+r.radius),t,o);n=Pl(Math.PI+(0,sl.EU)(t.direction,o),t.origin,i,r),a=Pl(ar.max,t.origin,i,r)}return(0,jt.uZ)(n+e,s,a)-n}_getPointAbsoluteSurfaceElevation(e,t,i){const{renderCoordsHelper:r}=this.view,s=r.getAltitude(e),n=t+Math.abs(s-t);return r.setAltitude(i,n,e),n}_clampedDistanceToSurface(e,t){const{renderCoordsHelper:i}=this.view,{camera:r}=this.view.state,{direction:s}=(0,ne.kE)(this.view,t,0,Zh,eu),n=i.intersectManifoldClosestSilhouette((0,Fn.re)(t,s),e,nl.WM.get()),a=(0,mr.j)(t,n),o=i.intersectManifoldClosestSilhouette((0,Fn.re)(t,(0,mr.E)(nl.WM.get(),t,r.center)),e,nl.WM.get()),l=(0,mr.j)(t,o);return Math.min(a,l)}_computeHeadingRotateRadius(e){const{renderCoordsHelper:t,state:i}=this.view,{camera:r,isGlobal:s}=i,n=t.intersectManifoldClosestSilhouette(r.ray,this._filteredSurfaceElevation,nl.WM.get());if(s){const t=(0,mr.d)(nl.WM.get(),e,n),i=(0,mr.l)(t);(0,mr.g)(t,t,1/i);const r=(0,mr.n)(nl.WM.get(),e),s=(0,jt.ZF)((0,mr.e)(r,t));return i*Math.sin(Math.min(jh,s))}{const i=(0,mr.c)(nl.WM.get(),e);return t.setAltitude(i,this._filteredSurfaceElevation),(0,mr.j)(n,i)}}_minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:$h}_computeVelocities(e){const t=this._filteredSurfaceElevation,i=t+(0,vr.Iu)(this.view.spatialReference).radius,{camera:r,isGlobal:s}=this.view.state,n=nl.WM.get(),a=this._getPointAbsoluteSurfaceElevation(r.eye,t,n),o=this._clampedDistanceToSurface(t,n),l=r.width/2,c=Wh*r.width,h=Wh*r.width,u=o*Math.tan(.5*r.fovX)/l,d=u/i,p=u/this._computeHeadingRotateRadius(n),m=a-t;return{pan:(s?d:u)*c*e,ascend:Math.max(this._minimumAscendVelocity()*e,2**(c*e/l)*m-m),zoom:2**(c*e/l)*o-o,rotate:(0,jt.uZ)(p*h,Xh,Yh)*e}}_applyDisabledMovementTypes(e){null==this.disableMovements||void 0!==this.disableMovements.mode&&this.view.state.viewingMode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&(0,Sr.yR)(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&(0,Sr.yR)(e.rotate.matrix))}static activatesFor(e,t){const i=kh(t,e.navigation.gamepad,qh);return!("end"===t.action||zh(i))}};(0,o._)([(0,x.Cb)({constructOnly:!0})],Gh.prototype,"gamepadDevice",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],Gh.prototype,"disableMovements",void 0),Gh=(0,o._)([(0,S.j)("esri.views.3d.state.controllers.GamepadKeyboardController")],Gh);const qh={translation:[0,0,0],heading:0,tilt:0,zoom:0},Zh=80,jh=(0,jt.Vl)(Zh),Wh=.75,$h=5,Xh=(0,jt.Vl)(30),Yh=(0,jt.Vl)(80),Qh={zoom:0,ascend:0,pan:{enabled:!1,matrix:(0,Mr.Ue)()},rotate:{enabled:!1,matrix:(0,Mr.Ue)()}},Kh=(0,O.Ue)(),Jh=(0,O.Ue)(),eu=(0,Hh.dp)();class tu extends Oc.a{constructor(e){super(!0),this._view=e,this._watchHandles=new mt.Z,this._handle=this.registerIncoming("gamepad",(e=>this._handleEventGamepad(e))),this._handle.pause()}onInstall(e){super.onInstall(e),this._watchHandles.add([(0,n.YP)((()=>this._view.navigation.gamepad.enabled),(e=>{e?this._handle.resume():(this._handle.pause(),this._cameraControllerGamepad&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null))}),n.nn),(0,n.YP)((()=>this._view.navigation.gamepad.device),(e=>{this._cameraControllerGamepad&&e&&this._cameraControllerGamepad.gamepadDevice!==e&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null)}))])}onUninstall(){this._watchHandles.removeAll(),super.onUninstall()}_handleEventGamepad(e){const t=this._view.navigation.gamepad.device;if(t&&e.data.device!==t)return;const i=this._cameraControllerGamepad?.running;if(i||Gh.activatesFor(this._view,e.data)){if(!i){const t=new Gh({view:this._view,gamepadDevice:e.data.device});this._view.state.switchCameraController(t),t.state!==jo.Rejected&&(this._cameraControllerGamepad=t)}this._cameraControllerGamepad&&this._cameraControllerGamepad.running&&this._cameraControllerGamepad.gamepadDevice===e.data.device&&this._cameraControllerGamepad.handleEventGamepad(e.data)}}}var iu;!function(e){e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT",e[e.FORWARD=2]="FORWARD",e[e.BACKWARD=3]="BACKWARD",e[e.UP=4]="UP",e[e.DOWN=5]="DOWN",e[e.HEADINGLEFT=6]="HEADINGLEFT",e[e.HEADINGRIGHT=7]="HEADINGRIGHT",e[e.TILTUP=8]="TILTUP",e[e.TILTDOWN=9]="TILTDOWN",e[e.ZOOMIN=10]="ZOOMIN",e[e.ZOOMOUT=11]="ZOOMOUT"}(iu||(iu={}));class ru extends Oc.a{constructor(e,t){super(!0),this._view=e,this._keyToDirection=new Map,this._keyToAction=new Map,this._disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:Si.JY.Local},this._stickyKeyTimeoutHandle=void 0,this._stickyKeyDuration=200,this._addKeysMapping(t),this.registerIncoming("key-down",null,(e=>this._handleKeyDown(e))),this.registerIncoming("key-up",null,(e=>this._handleKeyUp(e))),this.registerIncoming("blur",null,(()=>this._handleStop())),this._visibilityHandle=function(e){const t=()=>e("visible"===document.visibilityState);return document.addEventListener("visibilitychange",t),(0,p.kB)((()=>document.removeEventListener("visibilitychange",t)))}((e=>e?null:this._handleStop()))}onUninstall(){this._visibilityHandle?.remove(),this._handleStop()}setStickyKeyDuration(e){this._stickyKeyDuration=e}_addKeysMapping(e){this._addKeyMapping(e.pan.left,iu.LEFT),this._addKeyMapping(e.pan.right,iu.RIGHT),this._addKeyMapping(e.pan.forward,iu.FORWARD),this._addKeyMapping(e.pan.backward,iu.BACKWARD),this._addKeyMapping(e.pan.up,iu.UP),this._addKeyMapping(e.pan.down,iu.DOWN),this._addKeyMapping(e.lookAround.headingLeft,iu.HEADINGLEFT),this._addKeyMapping(e.lookAround.headingRight,iu.HEADINGRIGHT),this._addKeyMapping(e.lookAround.tiltUp,iu.TILTUP),this._addKeyMapping(e.lookAround.tiltDown,iu.TILTDOWN),this._addKeyMapping(e.zoom.zoomIn,iu.ZOOMIN),this._addKeyMapping(e.zoom.zoomOut,iu.ZOOMOUT),this._addKeyAction(e.reset.heading,(()=>this._resetHeading())),this._addKeyAction(e.reset.tilt,(()=>this._resetTilt()))}_addKeyMapping(e,t){for(const i of this._eachKey(e))this._keyToDirection.set(i,t)}*_eachKey(e){"string"==typeof e?yield e:yield*e}_addKeyAction(e,t){for(const i of this._eachKey(e))this._keyToAction.set(i,t)}_handleKeyDown(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this._keyToAction.get(e.data.key);if(null!=t)return e.stopPropagation(),void t();const i=this._keyToDirection.get(e.data.key);if(null!=i&&(this._cameraControllerKeyboard&&this._cameraControllerKeyboard.running||(this._cameraControllerKeyboard=new Gh({view:this._view,disableMovements:this._disableMovements}),this._view.state.switchCameraController(this._cameraControllerKeyboard)),this._cameraControllerKeyboard.running)){if(e.stopPropagation(),this._cameraControllerKeyboard.directionActive(i))return;if(this._cameraControllerKeyboard.activateDirection(i),this._cameraControllerKeyboard.countActiveDirections()>1||!this._isPanning(i))return;this._stickyKeyDuration>0&&(this._stickyKeyTimeoutHandle=setTimeout((()=>{this._stickyKeyTimeoutHandle=void 0,null!=this._stickyDirection&&void 0!==this._stickyDirection&&(this._cameraControllerKeyboard?.deactivateDirection(this._stickyDirection),this._stickyDirection=void 0)}),this._stickyKeyDuration))}}_handleStop(){this._cameraControllerKeyboard?.running&&(this._cameraControllerKeyboard.finishController(),this._cameraControllerKeyboard=null)}_handleKeyUp(e){if(e.data.native.ctrlKey||e.data.native.metaKey||!this._cameraControllerKeyboard?.running)return;const t=this._keyToDirection.get(e.data.key);if(null==t)return;e.stopPropagation();const i=void 0===this._stickyKeyTimeoutHandle;void 0===this._stickyKeyTimeoutHandle||1!==this._cameraControllerKeyboard?.countActiveDirections()?(this._cameraControllerKeyboard?.deactivateDirection(t),i&&(this._stickyDirection=void 0)):this._stickyDirection=t}_isPanning(e){return e<=3}_resetHeading(){this._view.goTo({heading:0}).catch((()=>{}))}_resetTilt(){this._view.goTo({tilt:0}).catch((()=>{}))}}class su extends Oc.a{constructor(e,t){super(!0),this._view=e,this.registerIncoming("mouse-wheel",[t],(e=>this._handleFov(e))),this.registerIncoming("mouse-wheel",(e=>this._handleZoom(e)))}_handleZoom(e){if(!this._mouseWheelZoomEnabled)return;const t=e.data;this._zoomController?.running||(this._stopFovController(),this._zoomController=this._view.state.isGlobal?new xc({view:this._view,mode:"interaction"}):new Ec({view:this._view,mode:"interaction"}),this._view.state.switchCameraController(this._zoomController)),this._zoomController.step(-t.deltaY/60,(0,b.s1)(t.x,t.y)),e.preventDefault(),e.stopPropagation()}_handleFov(e){this._mouseWheelZoomEnabled&&(this._fovController?.running||(this._zoomController?.finish(),this._fovController?.hideOverlay(),this._fovController=new Mh({view:this._view,onStop:()=>this._stopFovController()}),this._view.state.switchCameraController(this._fovController),this._fovController.state!==jo.Rejected)?(this._fovController.updateTimeout(),this._fovController.step(e.data.deltaY/20),e.preventDefault(),e.stopPropagation()):this._stopFovController())}get _mouseWheelZoomEnabled(){return"zoom"===this._view.navigation.actionMap.mouseWheel}_stopFovController(){this._fovController?.finish(),this._fovController=null}}class nu{constructor(e){this._gain=e}reset(e){this._value=e}set gain(e){this._gain=e}get value(){return void 0===this._value?0:this._value}update(e){void 0===this._value?this._value=e:this._value=this._gain*e+(1-this._gain)*this._value}}let au=class extends $o{constructor(){super(...arguments),this._beginCamera=new Xo.Z,this._elapsedTimeSec=0,this.constraintOptions=new Un(Dn.ALL,In.PAN,0,this._beginCamera)}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new qi}get steppingFinished(){return this.momentum.isFinished(this._elapsedTimeSec)}onControllerStart(e){this._beginCamera.copyFrom(e),super.onControllerStart(e)}stepController(e,t){t.copyViewFrom(this._beginCamera),this._elapsedTimeSec+=e,this.momentumStep(this._elapsedTimeSec,t),so(this.view,t,this.constraintOptions)}};au=(0,o._)([(0,S.j)("esri.views.3d.state.controllers.momentum.MomentumController")],au);let ou=class extends au{constructor(e){super(e),this.interactionType=In.PAN,this._tmpPan=(0,O.Ue)()}momentumStep(e,t){const i=this.momentum.value(e);(0,mr.g)(this._tmpPan,this.momentum.direction,i),t.eye=(0,mr.d)(lu,t.eye,this._tmpPan),t.center=(0,mr.d)(lu,t.center,this._tmpPan),this.constraintOptions.interactionDirection=this._tmpPan}};(0,o._)([(0,x.Cb)({constructOnly:!0})],ou.prototype,"momentum",void 0),ou=(0,o._)([(0,S.j)("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],ou);const lu=(0,O.Ue)(),cu=(0,O.Ue)(),hu=(0,O.Ue)();let uu=class extends au{constructor(e){super(e),this.interactionType=In.PAN}momentumStep(e,t){const i=this.momentum.value1(e),r=this.momentum.value2(e);(0,mr.c)(hu,t.eye),(0,mr.n)(hu,hu),(0,mr.h)(this.momentum.axis2,hu,this.momentum.axis1),jl(t,cu,this.momentum.axis1,i,this.momentum.axis2,r)}};(0,o._)([(0,x.Cb)({constructOnly:!0})],uu.prototype,"momentum",void 0),uu=(0,o._)([(0,S.j)("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],uu);let du=class extends au{set center(e){this._set("center",(0,O.d9)(e))}set axis(e){this._set("axis",(0,O.d9)(e))}constructor(e){super(e),this.interactionType=In.TUMBLE}momentumStep(e,t){const i=this.momentum.value(e);Cl(t,this.center,ol(this.axis,i))}};(0,o._)([(0,x.Cb)({constructOnly:!0})],du.prototype,"momentum",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],du.prototype,"center",null),(0,o._)([(0,x.Cb)({constructOnly:!0})],du.prototype,"axis",null),du=(0,o._)([(0,S.j)("esri.views.3d.state.controllers.momentum.RotationMomentumController")],du);let pu=class extends au{set zoomCenter(e){this._set("zoomCenter",(0,O.d9)(e))}constructor(e){super(e),this.interactionType=In.ZOOM,this.constraintOptions.interactionDirection=(0,O.Ue)()}momentumStep(e,t){const{interactionDirection:i}=this.constraintOptions;if(!i)return;(0,mr.c)(i,t.eye);const r=this.momentum.valueDelta(0,e);Tl(t,this.zoomCenter,r,this.view.state.constraints.minimumPoiDistance),(0,mr.E)(i,t.eye,i)}};(0,o._)([(0,x.Cb)({constructOnly:!0})],pu.prototype,"momentum",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],pu.prototype,"zoomCenter",null),pu=(0,o._)([(0,S.j)("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],pu);let mu=class extends au{set screenCenter(e){this._set("screenCenter",(0,b.s1)(e[0],e[1]))}set sceneCenter(e){this._set("sceneCenter",(0,O.d9)(e))}constructor(e){super(e),this.interactionType=In.ZOOM,this.radius=0,this._tmpSceneCenter=(0,O.Ue)(),this._tmpZoomAxisAngle=al(),this._sphere=(0,Nn.c)()}initialize(){this._sphere[3]=this.radius}momentumStep(e,t){const i=this.momentum.valueDelta(0,e);Sl(this._sphere,t,i),this.constraintOptions.interactionType=In.ZOOM,so(this.view,t,this.constraintOptions),Ul(this._sphere,t,this.screenCenter,this._tmpSceneCenter),cl(this.sceneCenter,this._tmpSceneCenter,this._tmpZoomAxisAngle),Cl(t,(0,Nn.a)(this._sphere),this._tmpZoomAxisAngle),this.constraintOptions.interactionType=In.PAN}};(0,o._)([(0,x.Cb)({constructOnly:!0})],mu.prototype,"momentum",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],mu.prototype,"screenCenter",null),(0,o._)([(0,x.Cb)({constructOnly:!0})],mu.prototype,"sceneCenter",null),(0,o._)([(0,x.Cb)({constructOnly:!0})],mu.prototype,"radius",void 0),mu=(0,o._)([(0,S.j)("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],mu);class _u{constructor(e){this._gain=e,this.lastValue=void 0,this.filteredDelta=void 0}update(e){if(this.hasLastValue()){const t=this.computeDelta(e);this._updateDelta(t)}this.lastValue=e}reset(){this.lastValue=void 0,this.filteredDelta=void 0}hasLastValue(){return void 0!==this.lastValue}hasFilteredDelta(){return void 0!==this.filteredDelta}computeDelta(e){return void 0===this.lastValue?NaN:e-this.lastValue}_updateDelta(e){void 0!==this.filteredDelta?this.filteredDelta=(1-this._gain)*this.filteredDelta+this._gain*e:this.filteredDelta=e}}class fu{constructor(e,t,i){this._initialVelocity=e,this._stopVelocity=t,this._friction=i,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}get duration(){return this._duration}isFinished(e){return e>this.duration}get friction(){return this._friction}value(e){return this.valueFromInitialVelocity(this._initialVelocity,e)}valueDelta(e,t){const i=this.value(e);return this.value(e+t)-i}valueFromInitialVelocity(e,t){t=Math.min(t,this.duration);const i=1-this.friction;return e*(i**t-1)/Math.log(i)}}class gu extends fu{constructor(e,t,i,r,s){super(e,t,i),this._sceneVelocity=r,this.direction=s}value(e){return super.valueFromInitialVelocity(this._sceneVelocity,e)}}class yu{constructor(e=300,t=12,i=.84){this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=i,this.enabled=!0,this._time=new _u(.6),this._screen=[new _u(.4),new _u(.4)],this._scene=[new _u(.6),new _u(.6),new _u(.6)],this._tmpDirection=(0,O.Ue)()}add(e,t,i){if(this.enabled){if(this._time.hasLastValue()&&this._time.computeDelta(i)<.015)return;this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._scene[0].update(t[0]),this._scene[1].update(t[1]),this._scene[2].update(t[2]),this._time.update(i)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._scene[0].reset(),this._scene[1].reset(),this._scene[2].reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta()||!this._time.hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,i=null==e||null==t?0:Math.sqrt(e*e+t*t),r=this._time.filteredDelta,s=null==r||null==i?0:i/r;return Math.abs(s)<this._minimumInitialVelocity?null:this.createMomentum(s,this._stopVelocity,this._friction)}createMomentum(e,t,i){(0,mr.i)(this._tmpDirection,this._scene[0].filteredDelta??0,this._scene[1].filteredDelta??0,this._scene[2].filteredDelta??0);const r=(0,mr.l)(this._tmpDirection);r>0&&(0,mr.g)(this._tmpDirection,this._tmpDirection,1/r);const s=this._time.filteredDelta;return new gu(e,t,i,null==s?0:r/s,this._tmpDirection)}}class vu{constructor(e){this._gain=e}update(e){void 0!==this.filteredValue?this.filteredValue=(1-this._gain)*this.filteredValue+this._gain*e:this.filteredValue=e}reset(){this.filteredValue=void 0}get hasFilteredValue(){return void 0!==this.filteredValue}}const bu=1e-5;class wu extends fu{constructor(e,t,i,r,s,n=0,a){super(e,t,i),this._angularVelocity1=r,this.axis1=s,this.angularVelocity2=n,this.axis2=a}value1(e){return super.valueFromInitialVelocity(this._angularVelocity1,e)}value2(e){return super.valueFromInitialVelocity(this.angularVelocity2,e)}}class Cu{constructor(e=300,t=12,i=.84){this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=i,this.enabled=!0,this._tmpAxis1=(0,O.Ue)(),this._tmpAxis2=(0,O.Ue)(),this._tmpAngles=(0,Rr.Ue)(),this._time=new _u(.3),this._screen=[new _u(.4),new _u(.4)],this._angle1=new vu(.6),this._angle2=new vu(.6),this._axis1=(0,O.Ue)(),this._axis2=(0,O.Ue)(),this._lastScene=(0,O.Ue)()}addMomentumDirectRotation(e,t,i,r,s,n){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;let e=Bl(this._lastScene,t,this._tmpAxis2,r,s,n);this._angle2.update(0),(0,mr.k)(this._tmpAxis2)<bu?e=0:(0,mr.n)(this._axis1,this._tmpAxis2),this._angle1.update(e),(0,mr.c)(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}addMomentumPreserveHeading(e,t,i,r,s,n,a){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;ql(this._lastScene,t,this._tmpAxis2,this._tmpAxis1,this._tmpAngles,r,s,n,a,!1),(0,mr.k)(this._tmpAxis2)<bu?(this._angle1.update(0),this._angle2.update(0)):(this._angle1.update(this._tmpAngles[1]),this._angle2.update(this._tmpAngles[0]),(0,mr.n)(this._axis1,this._tmpAxis1),(0,mr.n)(this._axis2,this._tmpAxis2)),(0,mr.c)(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._angle1.reset(),this._angle2.reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,i=null==e||null==t?null:Math.sqrt(e*e+t*t),r=this._time.filteredDelta,s=null==i||null==r?0:i/r;return Math.abs(s)<this._minimumInitialVelocity?null:this.createMomentum(s,this._stopVelocity,this._friction)}createMomentum(e,t,i){const r=this._time.filteredDelta,s=this._angle1.filteredValue,n=this._angle2.filteredValue,a=null==r||null==n?0:n/r;return new wu(e,t,i,null==r||null==s?0:s/r,this._axis1,a,this._axis2)}}class xu{constructor(e=2.5,t=.01,i=.95,r=12){this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=i,this._maxVelocity=r,this.enabled=!0,this.value=new _u(.8),this.time=new _u(.3)}add(e,t){if(this.enabled&&null!=t){if(this.time.hasLastValue()){if(this.time.computeDelta(t)<.01)return;if(this.value.hasFilteredDelta()){const t=this.value.computeDelta(e);this.value.filteredDelta*t<0&&this.value.reset()}}this.time.update(t),this.value.update(e)}}reset(){this.value.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.value.hasFilteredDelta()||!this.time.hasFilteredDelta())return null;let e=this.value.filteredDelta/this.time.filteredDelta;return e=(0,jt.uZ)(e,-this._maxVelocity,this._maxVelocity),Math.abs(e)<this._minimumInitialVelocity?null:this.createMomentum(e,this._stopVelocity,this._friction)}createMomentum(e,t,i){return new fu(e,t,i)}}class Tu extends xu{constructor(e=3,t=.01,i=.95,r=12){super(e,t,i,r)}add(e,t){const i=this.value.lastValue;if(null!=i){let t=e-i;for(;t>Math.PI;)t-=2*Math.PI;for(;t<-Math.PI;)t+=2*Math.PI;e=i+t}super.add(e,t)}}class Su extends fu{constructor(e,t,i){super(e,t,i)}value(e){const t=super.value(e);return Math.exp(t)}valueDelta(e,t){const i=super.value(e),r=super.value(e+t)-i;return Math.exp(r)}}class Mu extends xu{constructor(e=2.5,t=.01,i=.95,r=12){super(e,t,i,r)}add(e,t){super.add(Math.log(e),t)}createMomentum(e,t,i){return new Su(e,t,i)}}let Eu=class extends lh{constructor(){super(...arguments),this._smoothRotation=new nu(.05),this._rotationAxis=(0,O.Ue)(),this._beginAngle=0,this._beginHeading=0,this._panningPlane=(0,ul.Ue)(),this._beginRadius=0,this._smoothScaling=new nu(.05),this._zoomCenterScreen=(0,b.s1)(),this._zoomMomentumEstimator=new Mu,this._rotationMomentumEstimator=new Tu,this._panSphericalMomentumEstimator=new Cu,this._panPlanarMomentumEstimator=new yu,this._adjustedSphere=(0,Nn.c)(),this._tmp3d=(0,O.Ue)(),this._tmpScreenPointArray=(0,b.s1)(),this._beginScreenPoint=(0,b.s1)(),this._beginScenePoint=(0,O.Ue)(),this._screenPickPoint=(0,b.s1)(),this._scenePickPoint=(0,O.Ue)(),this._navMode=Al.Horizontal,this._sphere=(0,Nn.c)(),this._pointerCount=0,this._tmpInteractionDirection=(0,O.Ue)(),this._beginCamera=new Xo.Z,this._constraintOptions=new Un(Dn.ALL,In.NONE,0,this._beginCamera)}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;this._zoomMomentumEstimator.enabled=this._rotationMomentumEstimator.enabled=this._panPlanarMomentumEstimator.enabled=this._panSphericalMomentumEstimator.enabled=this.view.navigation.momentumEnabled,this._beginHeading=-tl.Q4.normalize((0,jt.Vl)(this.view.camera.heading)),this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._smoothRotation.reset(),(0,b.md)(e.center,this._screenPickPoint),(0,Er.JG)(this._beginScreenPoint,this._screenPickPoint);const t=Il(this._intersectionHelper,this.startCamera,this._screenPickPoint,(0,vr.Iu)(this.view.spatialReference).radius,_l.Silhouette,this.view.basemapTerrain.invisible?vl:{});null!=t.scenePickPoint&&(this._scenePickPoint=t.scenePickPoint,this._sphere=t.sphere,(0,mr.c)(this._beginScenePoint,this._scenePickPoint),this._navMode=Ll(this.startCamera,this._screenPickPoint,this.view.renderCoordsHelper,this.view.viewingMode),this._navMode===Al.Vertical&&this._preparePlanarPanMode(e,t.hasGeometryIntersection),this._beginCamera.copyFrom(this.startCamera))}update(e){if(!this.running)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1;this._navMode===Al.Horizontal?(t&&this._zoomSpherical(e),this._panningSpherical(e),t&&this._rotateSpherical(e)):(t&&this._zoomPlanar(e),this._panningPlanar(e),t&&this._rotatePlanar(e)),this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return this._navMode===Al.Horizontal?new mu({view:this.view,momentum:t,screenCenter:this._zoomCenterScreen,sceneCenter:this._beginScenePoint,radius:this._sphere[3]}):new pu({view:this.view,momentum:t,zoomCenter:this._beginScenePoint});const i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new du({view:this.view,momentum:i,center:(0,Nn.a)(this._sphere),axis:this._rotationAxis});if(this._navMode===Al.Horizontal){const e=this._panSphericalMomentumEstimator.evaluateMomentum();if(e)return new uu({view:this.view,momentum:e})}else{const e=this._panPlanarMomentumEstimator.evaluateMomentum();if(e)return new ou({view:this.view,momentum:e})}return null}_preparePlanarPanMode(e,t){const i=(0,mr.u)(this._tmp3d,this.startCamera.viewForward);(0,ul.Yq)(this._scenePickPoint,i,this._panningPlane);const r=(0,b.s1)(this._screenPickPoint[0],0),s=(0,O.Ue)(),n=(0,mr.l)(this.startCamera.eye);this._adjustedSphere[3]=n<this._sphere[3]?n-100:this._sphere[3],Ul(this._adjustedSphere,this.startCamera,r,s);const a=(0,b.J$)();this.startCamera.projectToRenderScreen(s,a);const o=(0,O.Ue)(),l=(0,O.Ue)(),c=(0,O.Ue)();(0,mr.d)(o,this._scenePickPoint,this.currentCamera.eye);const h=(0,mr.l)(o);(0,mr.n)(o,o);const u=5*Math.max(Math.abs(this.view.camera.position.z),50),d=this.view.stage.renderView.getMinimalDepthForArea(null,this._screenPickPoint[0],this._screenPickPoint[1],this.view.state.camera,80);let p=null!=d?d:u;p=t?Math.min(p,h):p,(0,mr.c)(c,(0,mr.f)(l,this.currentCamera.eye,(0,mr.g)(l,o,p))),this._panningPlane[3]=-(0,mr.e)((0,ul.st)(this._panningPlane),c),this.startCamera.center=(0,mr.f)(l,this.startCamera.eye,(0,mr.g)(l,this.startCamera.viewForward,p));const m=(0,b.md)(e.center,this._tmpScreenPointArray);xl(this._panningPlane,this.startCamera,m,this._beginScenePoint)}_zoomSpherical(e){const t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(t),Sl(this._sphere,this.currentCamera,this._smoothScaling.value),(0,b.md)(e.center,this._zoomCenterScreen),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),this._constraintOptions.interactionType=In.ZOOM,this._constraintOptions.interactionFactor=no(e.radius-this._beginRadius),so(this.view,this.currentCamera,this._constraintOptions)}_panningSpherical(e){const t=(0,b.md)(e.center,this._tmpScreenPointArray);Ul(this._sphere,this.currentCamera,t,this._tmp3d),Kl(this._beginScenePoint,(0,mr.e)(this.currentCamera.up,this._beginScenePoint),this._sphere[3],this._beginHeading,this.view.camera.tilt,this.startCamera.aboveGround)?(ec(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this._beginHeading,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumPreserveHeading(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere,this._beginHeading,this.view.camera.tilt)):(Jl(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumDirectRotation(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere[3],this.view.camera.tilt)),this._constraintOptions.interactionType=In.PAN,this._constraintOptions.interactionFactor=no((0,Er.TE)(this._screenPickPoint,t)),so(this.view,this.currentCamera,this._constraintOptions)}_rotateSpherical(e){(0,mr.n)(this._rotationAxis,this._scenePickPoint),this.currentCamera.aboveGround||(0,mr.u)(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value,i=t+wl(e.angle-t),r=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=r,this._smoothRotation.update(i);const s=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(s,.001*e.timestamp),Cl(this.currentCamera,(0,Nn.a)(this._sphere),ol(this._rotationAxis,s)),this._constraintOptions.interactionType=In.TUMBLE,this._constraintOptions.interactionFactor=no(e.radius*i),so(this.view,this.currentCamera,this._constraintOptions)}_panningPlanar(e){const t=(0,b.md)(e.center,this._tmpScreenPointArray);xl(this._panningPlane,this.currentCamera,t,this._tmp3d)&&(Fl(this.currentCamera,this._beginScenePoint,this._tmp3d),this._panPlanarMomentumEstimator.add(t,this._tmp3d,.001*e.timestamp),this._constraintOptions.interactionType=In.PAN,this._constraintOptions.interactionFactor=no((0,Er.TE)(this._beginScreenPoint,t)),this._constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this._tmpInteractionDirection),so(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null)}_zoomPlanar(e){const t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(t),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),Tl(this.currentCamera,this._beginScenePoint,this._smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this._constraintOptions.interactionType=In.ZOOM,this._constraintOptions.interactionFactor=no(e.radius-this._beginRadius),so(this.view,this.currentCamera,this._constraintOptions)}_rotatePlanar(e){(0,mr.c)(this._rotationAxis,this._beginScenePoint),this.currentCamera.aboveGround||(0,mr.u)(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value;let i=e.angle-t;i=wl(i);const r=t+i,s=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=s,this._smoothRotation.update(r);const n=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(n,.001*e.timestamp),Cl(this.currentCamera,(0,Nn.a)(this._sphere),ol(this._rotationAxis,n)),this._constraintOptions.interactionType=In.TUMBLE,this._constraintOptions.interactionFactor=no(e.radius*n),so(this.view,this.currentCamera,this._constraintOptions)}};Eu=(0,o._)([(0,S.j)("esri.views.3d.state.controllers.PinchAndPanControllerGlobal")],Eu);const Ru=(0,O.al)(0,0,1);let Pu=class extends lh{constructor(){super(...arguments),this._rotationValueSmooth=new nu(.05),this._scalingValueSmooth=new nu(.05),this._planeHorizontal=(0,ul.Ue)(),this._planeVertical=(0,ul.Ue)(),this._rotationMomentumEstimator=new Tu,this._panMomentumEstimator=new yu(300,12,.9),this._zoomMomentumEstimator=new Mu,this._beginRadius=0,this._beginCenter=(0,O.Ue)(),this._beginAngle=0,this._tmpPoints=[],this._navMode=Al.Horizontal,this._beginCenterScreen=(0,b.s1)(),this._tmpCentroid3d=(0,O.Ue)(),this._tmpCentroid2d=(0,b.s1)(),this._tmp2d=(0,b.s1)(),this._pointerCount=0,this._beginCamera=new Xo.Z,this._constraintOptions=new Un(Dn.ALL,In.NONE,0,this._beginCamera)}begin(e){if(!this.running)return;const t=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=t,this._rotationMomentumEstimator.enabled=t,this._panMomentumEstimator.enabled=t,this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._rotationValueSmooth.reset(),this._scalingValueSmooth.reset(),(0,b.md)(e.center,this._beginCenterScreen),(0,ul.Oy)(Ru,0,this._planeHorizontal);const i=(0,O.Ue)(),r=this._intersectionHelper.intersectScreenFreePointFallback(this._beginCenterScreen,i,this.view.basemapTerrain.invisible?vl:{}),s=(0,O.Ue)();(0,mr.u)(s,this.startCamera.viewForward);const n=(0,O.Ue)();(0,mr.c)(n,Ru);const a=(0,mr.e)(s,n);this._navMode=Ll(this.startCamera,this._beginCenterScreen,this.view.renderCoordsHelper,this.view.viewingMode);const o=Math.min(5,1/Math.abs((0,mr.e)(n,this.startCamera.viewForward)))*Math.max(Math.abs(this.view.camera.position.z),50);(0,ul.T5)(this._planeHorizontal,this._planeHorizontal,i),this.startCamera.aboveGround||(0,ul.tk)(this._planeHorizontal,this._planeHorizontal);const l=(0,O.Ue)(),c=(0,O.Ue)(),h=(0,O.Ue)();(0,mr.d)(l,i,this.currentCamera.eye);const u=(0,mr.l)(l);if((0,mr.n)(l,l),this._navMode===Al.Vertical){(0,mr.g)(n,n,a),(0,mr.d)((0,ul.st)(this._planeVertical),s,n),(0,mr.n)((0,ul.st)(this._planeVertical),(0,ul.st)(this._planeVertical)),(0,ul.T5)(this._planeVertical,this._planeVertical,i);const t=this.view.stage.renderView.getMinimalDepthForArea((0,Mc.$L)(this.view),this._beginCenterScreen[0],this._beginCenterScreen[1],this.view.state.camera,80);let d=null!=t?t:o;d=r?Math.min(d,u):d,(0,mr.c)(h,(0,mr.f)(c,this.currentCamera.eye,(0,mr.g)(c,l,d))),this._planeVertical[3]=-(0,mr.e)((0,ul.st)(this._planeVertical),h),this._computePlanePoints(e.pointers,this._planeVertical,this.startCamera,this._tmpPoints),El(this._tmpPoints,this._beginCenter)}else{const t=r?u:o;(0,mr.c)(h,(0,mr.f)(c,this.currentCamera.eye,(0,mr.g)(c,l,t))),this._planeHorizontal[3]=-(0,mr.e)((0,ul.st)(this._planeHorizontal),h),this._computePlanePoints(e.pointers,this._planeHorizontal,this.startCamera,this._tmpPoints),El(this._tmpPoints,this._beginCenter)}this._beginCamera.copyFrom(this.startCamera)}update(e){if(!this.running)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1,i=this._navMode===Al.Horizontal?this._planeHorizontal:this._planeVertical,r=this._beginCenter;if(t){const t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._scalingValueSmooth.gain=i,this._scalingValueSmooth.update(t),Tl(this.currentCamera,r,this._scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this._zoomMomentumEstimator.add(this._scalingValueSmooth.value,.001*e.timestamp),this._constraintOptions.interactionType=In.ZOOM,this._constraintOptions.interactionFactor=no(Math.abs(e.radius-this._beginRadius)),so(this.view,this.currentCamera,this._constraintOptions)}if(this._computePlanePoints(e.pointers,i,this.currentCamera,this._tmpPoints),El(this._tmpPoints,this._tmpCentroid3d),(0,b.md)(e.center,this._tmpCentroid2d),Fl(this.currentCamera,r,this._tmpCentroid3d),this._panMomentumEstimator.add(this._tmpCentroid2d,this._tmpCentroid3d,.001*e.timestamp),this._constraintOptions.interactionType=In.PAN,this._constraintOptions.interactionFactor=no((0,Er.TE)(this._beginCenterScreen,this._tmpCentroid2d)),so(this.view,this.currentCamera,this._constraintOptions),t){const t=r,i=this._rotationValueSmooth.value,s=i+wl(e.angle-i),n=.00125*Math.min(Math.max(e.radius,40),120);this._rotationValueSmooth.gain=n,this._rotationValueSmooth.update(s);const a=this._rotationValueSmooth.value-this._beginAngle;this._rotationMomentumEstimator.add(a,.001*e.timestamp);const o=(0,ul.st)(this._planeHorizontal);Cl(this.currentCamera,t,ol(o,a)),this._constraintOptions.interactionType=In.TUMBLE,this._constraintOptions.interactionFactor=no(Math.abs(e.radius*a)),so(this.view,this.currentCamera,this._constraintOptions)}this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return new pu({view:this.view,momentum:t,zoomCenter:this._beginCenter});const i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new du({view:this.view,momentum:i,center:this._beginCenter,axis:(0,ul.st)(this._planeHorizontal)});const r=this._panMomentumEstimator.evaluateMomentum();return r?new ou({view:this.view,momentum:r}):null}_computePlanePoints(e,t,i,r){r.length=e.size;const s=this._tmp2d;let n=0;return e.forEach((e=>{s[0]=e.x,s[1]=e.y,void 0===r[n]&&(r[n]=(0,O.Ue)()),xl(t,i,s,r[n]),n+=1})),r}get _intersectionHelper(){return this.view.sceneIntersectionHelper}};Pu=(0,o._)([(0,S.j)("esri.views.3d.state.controllers.PinchAndPanControllerLocal")],Pu);class Au extends Oc.a{constructor(e,t,i){super(!0),this._view=e,this.pointerActions=t,this._lastEndTimestamp=0,this._lastTimestamp=0,this.registerIncoming("drag",i,(e=>this._handleDrag(e)))}_handleDrag(e){if("mouse"===e.data.pointerType&&!Ic(e.data,this.pointerActions))return;const t=e.timestamp-this._lastEndTimestamp,i=this._momentum&&this._momentum.running&&t<40;switch(e.data.action){case"start":case"update":if(i)break;this._controller&&this._controller.running?e.data.timestamp-this._lastTimestamp>2&&(this._controller.update(e.data),this._lastTimestamp=e.timestamp):this._startController(e);break;case"end":case"removed":this._endController(e,!0);break;case"added":this._endController(e,!1),this._startController(e)}e.stopPropagation()}_endController(e,t){if(this._controller?.running){this._lastEndTimestamp=e.timestamp;const i=this._controller.end(e.data);t&&i&&(this._momentum=i,this._view.state.switchCameraController(this._momentum))}this._controller=null}_startController(e){this._controller=this._createController(),this._view.state.switchCameraController(this._controller),this._controller.begin(e.data),this._lastTimestamp=e.timestamp}_createController(){return this._view.state.isGlobal?new Eu({view:this._view}):new Pu({view:this._view})}}class Ou extends Oc.a{constructor(e,t){super(!0),this.view=e,this.registerIncoming("pointer-down",t,(()=>this.view.state.stopActiveCameraController()))}}class Du extends Oc.a{constructor(e,t=!1){super(!0),this._view=e,this._invert=t,this.registerIncoming("vertical-two-finger-drag",(e=>this._handleTwoFinger(e)))}_handleTwoFinger(e){const t=this._invert?-1:1,i=(0,b.s1)(0,e.data.delta*t);switch(e.data.action){case"begin":this._cameraController?.end(),this._cameraController=new hh({view:this._view,pivot:ch.CENTER}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":this._cameraController?.update(i);break;case"end":this._cameraController?.end(),this._cameraController=null}}}function Iu(e){const t=e.native;return t?{buttons:t.buttons.map((e=>e.pressed?e.value||1:0)),axes:t.axes.map((t=>function(e,t){const i=Math.abs(e);return i<t?0:Math.sign(e)*(i-t)/(1-t)}(t,e.axisThreshold)))}:{buttons:[],axes:[]}}class Lu{constructor(e,t){this._element=e,this._input=t,this._hasEventListeners=!1,this._onConnectGamepad=e=>{this._connectGamepad(e.gamepad)},this._onDisconnectGamepad=e=>{const t=e.gamepad,i=t.index,r=this._inputDevices[i];r&&(this._emitGamepadEvent(t,Iu(r),!1),this._inputDevices.splice(i,1),this._latestUpdate.splice(i,1),this._input.gamepad.devices.remove(r),this.ensurePollingState())},this._frameTask=null,this._latestUpdate=new Array,this._inputDevices=new Array,this._callback=null;const i="getGamepads"in window.navigator,r=window.isSecureContext;this.supported=i&&r,this.supported&&(Nu((e=>this._connectGamepad(e))),window.addEventListener("gamepadconnected",this._onConnectGamepad),window.addEventListener("gamepaddisconnected",this._onDisconnectGamepad),this.ensurePollingState())}destroy(){this.hasEventListeners=!1,this.supported&&(window.removeEventListener("gamepadconnected",this._onConnectGamepad),window.removeEventListener("gamepaddisconnected",this._onDisconnectGamepad))}set hasEventListeners(e){this._hasEventListeners!==e&&(this._hasEventListeners=e,this.ensurePollingState())}get _eventsEnabled(){return this.supported&&this._inputDevices.length>0&&this._hasEventListeners}set onEvent(e){this._callback=e}_connectGamepad(e){const t=new li(e);"unknown"!==t.deviceType&&(this._inputDevices[e.index]=t,this._input.gamepad.devices.add(t)),this.ensurePollingState()}ensurePollingState(){this._eventsEnabled?this._startPolling():this._stopPolling()}_startPolling(){null==this._frameTask&&(this._frameTask=(0,v.A)({update:()=>this._readGamepadState()}))}_stopPolling(){null!=this._frameTask&&(this._frameTask.remove(),this._frameTask=null,this._latestUpdate=new Array)}_readGamepadState(){const e=document.hasFocus(),t=this._element.contains(document.activeElement),i="document"===this._input.gamepad.enabledFocusMode&&!e||"view"===this._input.gamepad.enabledFocusMode&&!t;Nu((e=>{const t=this._inputDevices[e.index];if(!t)return;const r=this._latestUpdate[e.index],s=Iu(t),n=i||function(e){for(let t=0;t<e.axes.length;t++)if(0!==e.axes[t])return!1;for(let t=0;t<e.buttons.length;t++)if(0!==e.buttons[t])return!1;return!0}(s);if(r){if(r.timestamp===e.timestamp)return;if(!r.active&&n)return;if(function(e,t){if(e.axes.length!==t.axes.length)return!1;if(e.buttons.length!==t.buttons.length)return!1;for(let i=0;i<e.axes.length;i++)if(e.axes[i]!==t.axes[i])return!1;for(let i=0;i<e.buttons.length;i++)if(e.buttons[i]!==t.buttons[i])return!1;return!0}(r.state,s))return}this._emitGamepadEvent(e,s,!n)}))}_emitGamepadEvent(e,t,i){const r=this._latestUpdate[e.index],s=r&&r.active;if(!s&&!i)return;const n=!s&&i?"start":s&&i?"update":"end";this._latestUpdate[e.index]={timestamp:e.timestamp,state:t,active:i},this._callback&&this._callback({device:this._inputDevices[e.index],state:t,action:n})}}function Fu(e){if(!e)return!1;if(!e.connected)return!1;for(let t=0;t<e.axes.length;t++)if(isNaN(e.axes[t]))return!1;return!0}function Nu(e){for(const t of navigator.getGamepads())Fu(t)&&e(t)}const Uu=(0,m.Z)("edge"),Hu=(0,m.Z)("chrome"),Vu=(0,m.Z)("ff"),ku=(0,m.Z)("safari"),Bu="esri-view-surface",zu={touchNone:`${Bu}--touch-none`,touchPan:`${Bu}--touch-pan`};class Gu{static{this.test={disableSubpixelCoordinates:!1}}constructor(e,t){this._active={},this._callback=()=>{},this._activePointerCaptures=new Set,this._keyDownState=new Set,this._eventId=1,this._browserTouchPanningEnabled=!1,this._element=e,e.getAttribute("tabindex")||e.setAttribute("tabindex","0"),this._eventHandlers={"key-down":this._handleKey,"key-up":this._handleKey,"pointer-down":this._handlePointer,"pointer-move":this._handlePointerPreventDefault,"pointer-up":this._handlePointerPreventDefault,"pointer-enter":this._handlePointer,"pointer-leave":this._handlePointer,"pointer-cancel":this._handlePointer,"mouse-wheel":this._handleMouseWheel,"pointer-capture-lost":this._handlePointerCaptureLost},this._updateTouchAction(),this._element.addEventListener("keydown",this._preventAltKeyDefault),this._gamepadSource=new Lu(e,t),this._gamepadSource.onEvent=e=>this._callback("gamepad",e)}destroy(){this._callback=()=>{},this.activeEvents=null,this._activePointerCaptures.forEach((e=>this._releasePointerCaptureSafe(e))),this._activePointerCaptures.clear(),this._gamepadSource=(0,f.SC)(this._gamepadSource),this._removeTouchAction(),this._element.removeEventListener("keydown",this._preventAltKeyDefault)}get browserTouchPanningEnabled(){return this._browserTouchPanningEnabled}set browserTouchPanningEnabled(e){this._browserTouchPanningEnabled=e,this._updateTouchAction(),this._updateTouchEventHandling()}set onEventReceived(e){this._callback=e}set activeEvents(e){for(const t in this._active)if(!e||!e.has(t)){const e=this._active[t];this._element.removeEventListener(qu[t],e),delete this._active[t]}e&&e.forEach((e=>{if(!this._active[e]&&qu[e]){const t=(this._eventHandlers[e]||this._handleDefault).bind(this,e);this._element.addEventListener(qu[e],t),this._active[e]=t}})),this._gamepadSource&&(this._gamepadSource.hasEventListeners=e?.has("gamepad")??!1)}setPointerCapture(e,t){t?this._setPointerCaptureSafe(e.pointerId):(this._releasePointerCaptureSafe(e.pointerId),this._activePointerCaptures.delete(e.pointerId))}_updateTouchAction(){this._element.classList.remove(this._browserTouchPanningEnabled?zu.touchNone:zu.touchPan),this._element.classList.add(this._browserTouchPanningEnabled?zu.touchPan:zu.touchNone)}_updateTouchEventHandling(){this._browserTouchPanningEnabled?this._element.addEventListener("touchmove",this._preventMultiTouchPanning):this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_removeTouchAction(){this._element.classList.remove(zu.touchNone),this._element.classList.remove(zu.touchPan),this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_setPointerCaptureSafe(e){try{this._element.setPointerCapture(e),this._activePointerCaptures.add(e)}catch{}}_releasePointerCaptureSafe(e){try{if(this._element.hasPointerCapture&&!this._element.hasPointerCapture(e))return;this._element.releasePointerCapture(e)}catch(e){}}_updateNormalizedPointerLikeEvent(e,t){const i=(0,Wt.Eu)(this._element,e);return Gu.test.disableSubpixelCoordinates&&(i.x=Math.round(i.x),i.y=Math.round(i.y)),t.x=i.x,t.y=i.y,t}_handleKey(e,t){const{key:i}=t;i&&"key-up"===e&&this._keyDownState.delete(i);const r={native:t,key:i,repeat:!!i&&this._keyDownState.has(i)};i&&"key-down"===e&&this._keyDownState.add(r.key),this._callback(e,r)}_handlePointer(e,t){const i=this._updateNormalizedPointerLikeEvent(t,{native:t,x:0,y:0,pointerType:t.pointerType,button:t.button,buttons:t.buttons,eventId:this._eventId++});this._callback(e,i)}_handlePointerPreventDefault(e,t){const i=this._updateNormalizedPointerLikeEvent(t,{native:t,x:0,y:0,pointerType:t.pointerType,button:t.button,buttons:t.buttons,eventId:this._eventId++});t.preventDefault(),this._callback(e,i)}_getDeltaFromTrackpadOrMouseWheel(e){return e.shiftKey&&(0,m.Z)("mac")&&0===e.deltaY?e.deltaX:e.deltaY}_handleMouseWheel(e,t){let i=this._getDeltaFromTrackpadOrMouseWheel(t);switch(t.deltaMode){case 0:Uu&&(i=i/document.documentElement.clientHeight*600);break;case 1:i*=30;break;case 2:i*=900}Uu?i*=.7:Hu||ku?i*=.6:Vu&&(i*=1.375);const r=Math.abs(i);r>100&&(i=i/r*200/(1+Math.exp(-.02*(r-100))));const s=this._updateNormalizedPointerLikeEvent(t,{native:t,x:0,y:0,deltaY:i});this._callback(e,s)}_handlePointerCaptureLost(e,t){this._activePointerCaptures.delete(t.pointerId),this._handleDefault(e,t)}_handleDefault(e,t){const i={native:t};t.preventDefault(),this._callback(e,i)}_preventAltKeyDefault(e){"Alt"===e.key&&e.preventDefault()}_preventMultiTouchPanning(e){e.touches.length>1&&e.preventDefault()}}const qu={"key-down":"keydown","key-up":"keyup","pointer-down":"pointerdown","pointer-up":"pointerup","pointer-move":"pointermove","mouse-wheel":"wheel","pointer-capture-got":"gotpointercapture","pointer-capture-lost":"lostpointercapture","context-menu":"contextmenu","pointer-enter":"pointerenter","pointer-leave":"pointerleave","pointer-cancel":"pointercancel",focus:"focus",blur:"blur"};class Zu extends Oc.a{constructor(){super(!0),this.registerIncoming("context-menu",(e=>e.data.native.preventDefault()))}}const ju=(e={})=>({maximumClickDelay:300,maximumDoubleClickDistance:10,maximumDoubleTouchDistance:35,maximumDoubleClickDelay:250,maximumDoubleTouchDelay:350,...e});function Wu(e,t){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}function $u(e){const{native:t}=e,{pointerId:i,button:r,pointerType:s}=t;return"mouse"===s?`${i}:${r}`:`${s}`}class Xu extends Oc.a{constructor(e){super(!1),this._navigationTouch=e,this._startStateModifiers=new Set,this._activePointerMap=new Map,this._isDragging=!1,this._isCurrentDragSuppressed=!1,this._drag=this.registerOutgoing("drag"),this.registerIncoming("pointer-drag",this._handlePointerDrag.bind(this)),this.registerIncoming("pointer-up",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-capture-lost",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-cancel",this._handlePointerUpAndPointerLost.bind(this))}_createPayload(e,t,i,r){return{action:e,pointerType:this._pointerType,button:this._mouseButton,buttons:t.buttons,timestamp:r,pointers:Ku(this._activePointerMap),pointer:t,angle:i.angle,radius:i.radius,center:i.center}}_addPointer(e){const t=e.native.pointerId,i=Qu(this._activePointerMap).angle,r={event:e,initialAngle:0,lastAngle:0};this._activePointerMap.set(t,r);const s=Ju(r,Yu(this._activePointerMap));r.initialAngle=s,r.lastAngle=s,this._updatePointerAngles(i)}_updatePointer(e){if(e&&null==e.x&&null==e.y)return;const t=e.native.pointerId,i=this._activePointerMap.get(t);i?i.event=e:this._addPointer(e)}_removePointer(e){const t=Qu(this._activePointerMap).angle;this._activePointerMap.delete(e),this._updatePointerAngles(t)}_updatePointerAngles(e){const t=Qu(this._activePointerMap);this._activePointerMap.forEach((i=>{i.initialAngle=Ju(i,t)-e,i.lastAngle=Ju(i,t)-e}))}_emitEvent(e,t,i){const r=Qu(this._activePointerMap);this._drag.emit(this._createPayload(e,t,r,i),void 0,this._startStateModifiers)}_handlePointerUpAndPointerLost(e){const t=e.data.native.pointerId,i=(0,Yr.HA)(e.timestamp);this._activePointerMap.get(t)&&(1===this._activePointerMap.size?(this._updatePointer(e.data),!this._isCurrentDragSuppressed&&this._emitEvent("end",e.data,i),this._isDragging=!1,this._isCurrentDragSuppressed=!1,this._removePointer(t)):(this._removePointer(t),this._emitEvent("removed",e.data,(0,Yr.HA)(e.timestamp))))}_handlePointerDrag(e){const t=e.data,i=t.currentEvent,r=(0,Yr.HA)(e.timestamp);switch(t.action){case"start":case"update":this._isDragging?this._activePointerMap.has(i.native.pointerId)?(this._updatePointer(i),!this._isCurrentDragSuppressed&&this._emitEvent("update",i,r)):(this._addPointer(i),this._emitEvent("added",i,r),this._isCurrentDragSuppressed=this._isSuppressed):(this._updatePointer(i),this._pointerType=e.data.startEvent.pointerType,this._mouseButton=e.data.startEvent.button,this._startStateModifiers=e.modifiers,this._isDragging=!0,this._isCurrentDragSuppressed=this._isSuppressed,!this._isCurrentDragSuppressed&&this._emitEvent("start",i,r))}}get _isSuppressed(){return!!this._navigationTouch&&!this._navigationTouch.browserTouchPanEnabled&&"touch"===this._pointerType&&1===this._activePointerMap.size}}function Yu(e){const t=[];return e.forEach((e=>{t.push((0,b.vW)(e.event.x,e.event.y))})),function(e,t){if(t?(t.radius=0,t.center.x=0,t.center.y=0):t={radius:0,center:(0,b.vW)()},0===e.length)return t;if(1===e.length)return t.center.x=e[0].x,t.center.y=e[0].y,t;if(2===e.length){const[i,r]=e,[s,n]=[r.x-i.x,r.y-i.y];return t.radius=Math.sqrt(s*s+n*n)/2,t.center.x=(i.x+r.x)/2,t.center.y=(i.y+r.y)/2,t}let i=0,r=0;for(let t=0;t<e.length;t++)i+=e[t].x,r+=e[t].y;i/=e.length,r/=e.length;const s=e.map((e=>e.x-i)),n=e.map((e=>e.y-r));let a=0,o=0,l=0,c=0,h=0,u=0,d=0;for(let e=0;e<s.length;e++){const t=s[e],i=n[e],r=t*t,p=i*i;a+=r,o+=p,l+=t*i,c+=r*t,h+=p*i,u+=t*p,d+=i*r}const p=.5*(c+u),m=.5*(h+d),_=a*o-l*l,f=(p*o-m*l)/_,g=(a*m-l*p)/_,y=(0,b.vW)(f+i,g+r);return{radius:Math.sqrt(f*f+g*g+(a+o)/e.length),center:y}}(t)}function Qu(e){const t=Yu(e);let i=0;return e.forEach((e=>{let r=Ju(e,t),s=r-e.lastAngle;for(;s>Math.PI;)s-=2*Math.PI;for(;s<-Math.PI;)s+=2*Math.PI;r=e.lastAngle+s,e.lastAngle=r;const n=r-e.initialAngle;i+=n})),i/=e.size||1,{angle:i,radius:t.radius,center:t.center}}function Ku(e){const t=new Map;return e.forEach(((e,i)=>t.set(i,e.event))),t}function Ju(e,t){const i=e.event,r=i.x-t.center.x,s=i.y-t.center.y;return Math.atan2(s,r)}var ed;!function(e){e[e.Left=0]="Left",e[e.Middle=1]="Middle",e[e.Right=2]="Right",e[e.Back=3]="Back",e[e.Forward=4]="Forward",e[e.Undefined=-1]="Undefined"}(ed||(ed={}));class td extends Oc.a{constructor(e={},t=Vt.m){super(!1),this._clock=t,this._pointerState=new Map,this._parameters=ju(e),this._immediateDoubleClick=this.registerOutgoing("immediate-double-click"),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this)),this.registerIncoming("pointer-up",this._handlePointerUp.bind(this))}onUninstall(){this._pointerState.forEach((e=>{e.immediateDoubleClick&&e.immediateDoubleClick.timeoutHandle.remove()})),super.onUninstall()}_handlePointerDown(e){const t=e.data,i=$u(t);if(!this._pointerState.has(i)){const e={downButton:t.native.button,x:t.x,y:t.y,immediateDoubleClick:null};this._pointerState.set(i,e),this.startCapturingPointer(t.native)}}_handlePointerUp(e){const t=e.data,i=$u(t),r=this._pointerState.get(i);if(r&&r.downButton===t.native.button){const i=r.immediateDoubleClick,s="touch"===e.data.native.pointerType?this._parameters.maximumDoubleTouchDistance:this._parameters.maximumDoubleClickDistance;i?(i.timeoutHandle.remove(),Wu(i,e.data)>s?this._startImmediateDoubleClick(e,r):(this._immediateDoubleClick.emit(e.data,void 0,i.modifiers),this._removeState(t))):Wu(r,e.data)>s?this._removeState(t):this._startImmediateDoubleClick(e,r)}}_startImmediateDoubleClick(e,t){const i="touch"===e.data.native.pointerType?this._parameters.maximumDoubleTouchDelay:this._parameters.maximumDoubleClickDelay;t.immediateDoubleClick={x:e.data.x,y:e.data.y,modifiers:e.modifiers,timeoutHandle:this._clock.setTimeout((()=>this._removeState(e.data)),i)}}_removeState(e){const t=$u(e);this._pointerState.delete(t),this.stopCapturingPointer(e.native),this.refreshHasPendingInputs()}}class id extends Oc.a{constructor(e={},t=Vt.m){super(!1),this._clock=t,this._pointerState=new Map,this._parameters=((e={})=>({maximumClickDelay:300,movementUntilMouseDrag:1.5,movementUntilPenDrag:6,movementUntilTouchDrag:6,holdDelay:500,...e}))(e),this._pointerDrag=this.registerOutgoing("pointer-drag"),this._immediateClick=this.registerOutgoing("immediate-click"),this._pointerHold=this.registerOutgoing("hold"),this.registerIncoming("pointer-down",(e=>this._handlePointerDown(e))),this.registerIncoming("pointer-up",(e=>this._handlePointerLoss(e,"pointer-up"))),this.registerIncoming("pointer-capture-lost",(e=>this._handlePointerLoss(e,"pointer-capture-lost"))),this.registerIncoming("pointer-cancel",(e=>this._handlePointerLoss(e,"pointer-cancel"))),this._moveHandle=this.registerIncoming("pointer-move",(e=>this._handlePointerMove(e))),this._moveHandle.pause()}onUninstall(){this._pointerState.forEach((e=>{e.holdTimeout=(0,f.hw)(e.holdTimeout)})),super.onUninstall()}_handlePointerDown(e){const t=e.data,i=t.native.pointerId;let r=null;0===this._pointerState.size&&(r=this._clock.setTimeout((()=>{const t=this._pointerState.get(i);if(t){if(!t.isDragging){const i=t.previousEvent;this._pointerHold.emit(i,void 0,e.modifiers),t.holdEmitted=!0}t.holdTimeout=null}}),this._parameters.holdDelay));const s={startEvent:t,previousEvent:t,startTimestamp:e.timestamp,isDragging:!1,downButton:t.native.button,holdTimeout:r,modifiers:new Set};this._pointerState.set(i,s),this.startCapturingPointer(t.native),this._moveHandle.resume(),this._pointerState.size>1&&this._startDragging(e)}_handlePointerMove(e){const t=e.data,i=t.native.pointerId,r=this._pointerState.get(i);r&&(r.isDragging?this._pointerDrag.emit(rd("update",r,t),void 0,r.modifiers):function(e,t){const i=t.x-e.x,r=t.y-e.y;return Math.sqrt(i*i+r*r)}(t,r.startEvent)>this._getDragThreshold(t.native.pointerType)&&this._startDragging(e),r.previousEvent=t)}_getDragThreshold(e){switch(e){case"touch":return this._parameters.movementUntilTouchDrag;case"pen":return this._parameters.movementUntilPenDrag;default:return this._parameters.movementUntilMouseDrag}}_startDragging(e){const t=e.data,i=t.native.pointerId;this._pointerState.forEach((r=>{null!=r.holdTimeout&&(r.holdTimeout.remove(),r.holdTimeout=null),r.isDragging||(r.modifiers=e.modifiers,r.isDragging=!0,i===r.startEvent.native.pointerId?this._pointerDrag.emit(rd("start",r,t)):this._pointerDrag.emit(rd("start",r,r.previousEvent),e.timestamp))}))}_handlePointerLoss(e,t){const i=e.data,r=i.native.pointerId,s=this._pointerState.get(r);s&&(null!=s.holdTimeout&&(s.holdTimeout.remove(),s.holdTimeout=null),s.isDragging?this._pointerDrag.emit(rd("end",s,"pointer-up"===t?i:s.previousEvent),void 0,s.modifiers):"pointer-up"===t&&s.downButton===i.native.button&&e.timestamp-s.startTimestamp<=this._parameters.maximumClickDelay&&!s.holdEmitted&&this._immediateClick.emit(i),this._pointerState.delete(r),this.stopCapturingPointer(i.native),0===this._pointerState.size&&this._moveHandle.pause())}}function rd(e,t,i){return{action:e,startEvent:t.startEvent,previousEvent:t.previousEvent,currentEvent:i}}class sd extends Oc.a{constructor(e={},t=Vt.m){super(!1),this._clock=t,this._pointerState=new Map,this._parameters=ju(e),this._click=this.registerOutgoing("click"),this._doubleClick=this.registerOutgoing("double-click"),this.registerIncoming("immediate-click",(e=>this._handleImmediateClick(e))),this.registerIncoming("pointer-down",(e=>this._handlePointerDown(e)))}onUninstall(){this._pointerState.forEach((e=>e.doubleClickTimer=(0,f.hw)(e.doubleClickTimer)))}get hasPendingInputs(){for(const e of this._pointerState.values())if(null!=e.doubleClickTimer)return!0;return!1}_clearDoubleClickTimer(e,t){const i=this._pointerState.get(e);i&&(i.doubleClickTimer=(0,f.hw)(i.doubleClickTimer),t&&this._click.emit(i.event.data,void 0,i.event.modifiers),this._pointerState.delete(e),this.refreshHasPendingInputs())}_doubleClickTimeoutExceeded(e){const t=this._pointerState.get(e);1===t.pointerDownCount&&this._click.emit(t.event.data,void 0,t.event.modifiers),t.doubleClickTimer=null,this._pointerState.delete(e),this.refreshHasPendingInputs()}_handleImmediateClick(e){const t=e.data,{pointerType:i}=t.native,r=function(e){const{pointerId:t,pointerType:i,button:r}=e.native;return"mouse"===i?`${t}:${r}`:`${i}`}(t);if(!this._pointerState.has(r))return void this._startClick(e);const s=this._pointerState.get(r),{data:n,modifiers:a}=s.event,o="touch"===i?this._parameters.maximumDoubleTouchDistance:this._parameters.maximumDoubleClickDistance;Wu(n,t)>o?(this._clearDoubleClickTimer(r,!0),this._startClick(e)):(this._clearDoubleClickTimer(r,!1),2===s.pointerDownCount&&this._doubleClick.emit(n,void 0,a))}_handlePointerDown(e){const t=$u(e.data),i=this._pointerState.get(t);i&&(i.pointerDownCount+=1)}_startClick(e){const{data:t}=e,{native:{pointerType:i}}=t,r=$u(t),s="touch"===i?this._parameters.maximumDoubleTouchDelay:this._parameters.maximumDoubleClickDelay,n=this._clock.setTimeout((()=>this._doubleClickTimeoutExceeded(r)),s);this._pointerState.set(r,{event:e,doubleClickTimer:n,pointerDownCount:1}),this.refreshHasPendingInputs()}}class nd{constructor(e){this._callbacks=e,this._currentCount=0,this._callbacks.condition||(this._callbacks.condition=()=>!0)}handle(e){const t=e.data,i=t.pointers.size;switch(t.action){case"start":this._currentCount=i,this._emitStart(e);break;case"added":this._emitEnd(this._previousEvent),this._currentCount=i,this._emitStart(e);break;case"update":this._emitUpdate(e);break;case"removed":this._startEvent&&this._emitEnd(this._previousEvent),this._currentCount=i,this._emitStart(e);break;case"end":this._emitEnd(e),this._currentCount=0}this._previousEvent=e}_emitStart(e){this._startEvent=e,this._callbacks.condition?.(this._currentCount,e)&&this._callbacks.start(this._currentCount,e,this._startEvent)}_emitUpdate(e){this._callbacks.condition?.(this._currentCount,e)&&this._callbacks.update(this._currentCount,e,this._startEvent)}_emitEnd(e){this._callbacks.condition?.(this._currentCount,e)&&this._callbacks.end(this._currentCount,e,this._startEvent),this._startEvent=null}}class ad extends Oc.a{constructor(e=20,t=40){super(!1),this._threshold=e,this._maxDelta=t,this._state="ready",this._emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this._dragEventSeparator=new nd({start:(e,t)=>this._observeStart(e,t),update:(e,t,i)=>this._observeUpdate(e,t,i),end:(e,t)=>this._observeEnd(t)}),this.registerIncoming("drag",(e=>this._dragEventSeparator.handle(e)))}get failed(){return"failed"===this._state}_observeStart(e,t){1===e&&this._emittedArtificalEnd2&&(this._emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),t.stopPropagation()),this._state=2===e?"ready":"failed"}_observeUpdate(e,t,i){if("failed"!==this._state&&2===e)return"active"===this._state?(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void t.stopPropagation()):void(this._checkMovementWithinLimits(t.data,i.data)?this._checkVerticalThresholdReached(t.data,i.data)&&(this._state="active",this._emittedArtificalEnd2=!0,this._thresholdReachedCenter=t.data.center,this._artificalDrag.emit({action:"end",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),t.stopPropagation()):this._state="failed")}_observeEnd(e){"active"===this._state&&(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this._state="ready",e.stopPropagation())}_checkMovementWithinLimits(e,t){let i=-1/0,r=1/0,s=-1/0,n=1/0;for(const{x:e,y:a}of t.pointers.values())i=Math.max(i,e),r=Math.min(r,e),s=Math.max(s,a),n=Math.min(n,a);let a=-1/0,o=1/0,l=-1/0,c=1/0;for(const{x:t,y:i}of e.pointers.values())a=Math.max(a,t),o=Math.min(o,t),l=Math.max(l,i),c=Math.min(c,i);const h=i-r,u=s-n,d=a-o,p=l-c;return Math.abs(e.center.x-t.center.x)<this._threshold&&Math.abs(d-h)<=this._maxDelta&&Math.abs(p-u)<=this._maxDelta}_checkVerticalThresholdReached(e,t){let i=Math.abs(e.center.y-t.center.y);return e.pointers.forEach(((e,r)=>{const s=t.pointers.get(r);i=Math.min(i,Math.abs(e.y-s.y))})),i>=this._threshold}}let od=class extends E.Z{constructor(){super(...arguments),this.mode="default",this._updateMode=({mode:e,dragPrimary:t,dragSecondary:i,dragTertiary:r})=>{"pro"===e&&(i="zoom",r="pan"===t?"rotate":"pan");const s={dragPrimary:t,dragSecondary:i,dragTertiary:r};this._modeDragPan&&(this._modeDragPan.pointerActions=Lc("pan",s)),this._modeDragRotate&&(this._modeDragRotate.pointerActions=Lc("rotate",s)),this._modeDragZoom&&(this._modeDragZoom.pointerActions=Lc("zoom",s))}}destroy(){this.disconnect()}get primaryDragAction(){return this.view.navigation.actionMap.dragPrimary}set primaryDragAction(e){const{actionMap:t}=this.view.navigation;t.dragPrimary=e,t.dragSecondary="pan"===e?"rotate":"pan"}get updating(){return!!this._inputManager?.updating}get latestPointerType(){return this._inputManager?.latestPointerType}get latestPointerLocation(){return this._inputManager?.latestPointerLocation}get multiTouchActive(){return this._inputManager?.multiTouchActive??!1}disconnect(){this.removeAllHandles(),this.view.viewEvents.disconnect(),this._modeDragPan=null,this._modeDragRotate=null,this._modeDragZoom=null,this._modeKeyboardNavigation=null,this._inputManager=(0,f.SC)(this._inputManager),this._source=(0,f.SC)(this._source)}connect(){const e=this.view;this._source=new Gu(this.view.surface,e.input);const t=[new td,new id,new sd,new Xu(this.view.navigation),new ad],i=new _e.$({eventSource:this._source,recognizers:t});this._inputManager=i,i.installHandlers("prevent-context-menu",[new Zu],_e.f.INTERNAL);const r={fov:"Shift",pan:{left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:["u","U"],down:["j","J"]},lookAround:{headingLeft:["a","A"],headingRight:["d","D"],tiltUp:["w","W"],tiltDown:["s","S"],modifier:"b"},zoom:{zoomIn:["+","="],zoomOut:["-","_"]},reset:{heading:["n","N"],tilt:["p","P"]}};this._modeDragPan=new Au(e,["primary"]),this._modeDragRotate=new ph(e,["secondary"],ch.CENTER),this._modeDragZoom=new Uh(e,["tertiary"],r.fov),this._modeKeyboardNavigation=new ru(e,r),i.installHandlers("navigation",[new Ou(e),new Fc(e),new tu(e),new su(e,r.fov),new ph(e,["primary"],ch.EYE,[r.lookAround.modifier]),new ph(e,["secondary"],ch.CENTER,[r.lookAround.modifier]),new Au(e,["tertiary"],[r.lookAround.modifier]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,this._modeKeyboardNavigation,new Du(e)],_e.f.INTERNAL),this.view.viewEvents.connect(i),this.addHandles([(0,n.YP)((()=>this.view.navigation?.browserTouchPanEnabled),(e=>{this._source.browserTouchPanningEnabled=!e}),n.nn),(0,n.YP)((()=>{const{actionMap:e}=this.view.navigation,{dragPrimary:t,dragSecondary:i,dragTertiary:r}=e;return{mode:this.mode,dragPrimary:t,dragSecondary:i,dragTertiary:r}}),this._updateMode,n.tX)])}isModifierKeyDown(e){return this._inputManager?.isModifierKeyDown(e)??!1}get test(){}};(0,o._)([(0,x.Cb)()],od.prototype,"view",void 0),(0,o._)([(0,x.Cb)({type:["default","pro"]})],od.prototype,"mode",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],od.prototype,"updating",null),(0,o._)([(0,x.Cb)()],od.prototype,"latestPointerType",null),(0,o._)([(0,x.Cb)()],od.prototype,"latestPointerLocation",null),(0,o._)([(0,x.Cb)()],od.prototype,"multiTouchActive",null),(0,o._)([(0,x.Cb)()],od.prototype,"_inputManager",void 0),od=(0,o._)([(0,S.j)("esri.views.3d.input.SceneInputManager")],od);const ld=od;var cd=i(89420),hd=i(87511),ud=i(63974),dd=i(27762);let pd,md,_d=!1,fd=!1,gd=!1,yd=!1,vd=null;function bd(e){gd=dd.h.DECONFLICTOR_SHOW_VISIBLE,yd=dd.h.DECONFLICTOR_SHOW_INVISIBLE,_d=gd||yd,fd=dd.h.DECONFLICTOR_SHOW_GRID,vd=null,_d||fd?(md&&pd&&md.clearRect(0,0,pd.width,pd.height),vd=()=>function(e){null==pd&&(pd=document.createElement("canvas"),pd.setAttribute("id","debugCanvas2d"),e.surface.parentElement.style.position="relative",e.surface.parentElement.appendChild(pd),pd.style.position="absolute",pd.style.width="100%",pd.style.height="100%",pd.style.display="block",pd.style.pointerEvents="none",md=pd.getContext("2d"),md.font="12px Arial");const{width:t,height:i}=e.state.camera;pd.width=t,pd.height=i}(e)):pd&&(pd.parentElement.removeChild(pd),pd=null)}function wd(){vd&&(vd(),vd=null)}function Cd(e,t,i,r,s){wd();const n=pd.height,a=md;a.beginPath(),a.lineWidth=1,a.strokeStyle=s,a.moveTo(e,n-i),a.lineTo(t,n-i),a.stroke(),a.lineTo(t,n-r),a.stroke(),a.lineTo(e,n-r),a.stroke(),a.lineTo(e,n-i),a.stroke(),a.closePath()}function xd(e,t,i=!1){_d&&(t&&gd||!t&&yd)&&Cd(e[0],e[2],e[1],e[3],i?t?"pink":"grey":t?"green":"red")}class Td{constructor(e,t,i){this._setVisibility=e,this._canConflict=t,this._compare=i,this.done=!1,this._items=new Array,this._accBinsNumX=15,this._accBinsNumY=20,this._accBinsSizeX=0,this._accBinsSizeY=0,this._accBins=null}destroy(){this._generator=null}reset(e,t){this._initBins(e,t),this._items.length=0,this.done=!1,this._generator=null}add(e){this._items.push(e)}run(e){this._generator??=this._run(e),this.done=!!this._generator.next(e).done}*_run(e){yield*this._sort(e),yield*this._deconflict(e),function(e){const t=fd?e():null;if(!t?.bins)return;wd();const i=md;let r=0;for(let e=0;e<t.numX;e++)for(let s=0;s<t.numY;s++){const n=t.bins[e][t.numY-1-s];r+=n.length;const a=e*t.sizeX,o=(e+1)*t.sizeX,l=s*t.sizeY,c=(s+1)*t.sizeY;i.fillText(n.length.toFixed(),a+5,l+15),Cd(a,o,l,c,"blue")}i.fillText("total totalShownLabels: "+r,70,40),i.fillText("total visible labels: "+t.numVisible,70,50),i.fillText("total numTests: "+t.numTests,70,30)}((()=>({bins:this._accBins,numX:this._accBinsNumX,numY:this._accBinsNumY,sizeX:this._accBinsSizeX,sizeY:this._accBinsSizeY,numTests:0,numVisible:this._items.length})))}*_sort(e){for(const t of hd.Z.iterableSort(this._items,0,this._items.length,this._compare))e.madeProgress(),e.done&&(e=yield)}_isConflicted(e){let t=!0;return this._forEachBin(e.aabr,(i=>(t=!1,i.some((t=>this._canConflict(t,e)&&(0,V.kK)(t.aabr,e.aabr))))))||t}*_deconflict(e){for(const t of this._items){e.done&&(e=yield);const i=!this._isConflicted(t);this._setVisibility(t,i),xd(t.aabr,i),i&&this._addToBins(t),e.madeProgress()}}_initBins(e,t){if(null==this._accBins){this._accBins=[];for(let e=0;e<this._accBinsNumX;e++){this._accBins.push([]);const e=this._accBins[this._accBins.length-1];for(let t=0;t<this._accBinsNumY;t++)e.push(new ud.Z)}}else for(let e=0;e<this._accBinsNumX;e++)for(let t=0;t<this._accBinsNumY;t++)this._accBins[e][t].clear();this._accBinsSizeX=e/this._accBinsNumX,this._accBinsSizeY=t/this._accBinsNumY}_addToBins(e){this._forEachBin(e.aabr,(t=>t.push(e)))}_forEachBin(e,t){if(!this._accBins)return!1;const i=Math.max(Math.floor(e[0]/this._accBinsSizeX),0),r=Math.max(Math.floor(e[1]/this._accBinsSizeY),0),s=Math.min(Math.floor(e[2]/this._accBinsSizeX),this._accBinsNumX-1),n=Math.min(Math.floor(e[3]/this._accBinsSizeY),this._accBinsNumY-1);for(let e=i;e<=s;e++)for(let i=r;i<=n;i++)if(t(this._accBins[e][i]))return!0;return!1}}var Sd=i(10841),Md=i(69371),Ed=i(75025);class Rd{constructor(e){this._gl=e,this._sync=e.fenceSync(e.SYNC_GPU_COMMANDS_COMPLETE,0)}poll(){const e=this._gl,t=e.clientWaitSync(this._sync,e.SYNC_FLUSH_COMMANDS_BIT,0);if(t===e.WAIT_FAILED)throw new Error("clientWaitSync failed");return t!==e.TIMEOUT_EXPIRED}destroy(){this._gl.deleteSync(this._sync),this._sync=null}}var Pd=i(8158);let Ad=class extends as.Z{constructor(e){super(e),this.category=Qr.lu.COMPOSITE,this.running=!1,this.done=!0,this._origin=(0,O.Ue)(),this._textureWidth=256,this._uploadBuffer=new Float32Array(3*this._textureWidth),this._counter=0,this._width=0,this._height=0,this._pipeline=(0,Lr.sm)({colorWrite:Lr.gf}),this._format=0}initialize(){this.view.resourceController.scheduler.registerTask(Gr.T8.GRAPHICS_CORE,this),this.produces="disabled",this.consumes.required=[this.category],this.formatOverride&&(this._format=this.formatOverride)}destroy(){this._program=(0,f.M2)(this._program);const e=this.gl;this._sync=(0,f.SC)(this._sync),this._pixelBuffer&&(e.deleteBuffer(this._pixelBuffer),this._pixelBuffer=null),this._texture=(0,f.M2)(this._texture)}precompile(){this._ensureShader(this.renderingContext)}render(e){const t=e.find((({name:e})=>e===this.category));if(this._sync)return t;this.produces="disabled";const i=this.renderingContext,r=this.gl,s=t.getTexture(r.DEPTH_STENCIL_ATTACHMENT);if(!s)return t;const n=this.view.stage.renderer.fboCache.acquire(this._width,this._height,"hud visibility",Md.qz.R32FLOAT);i.bindFramebuffer(n.fbo),i.setPipelineState(this._pipeline);const a=this._ensureShader(i);i.useProgram(a);i.bindTexture(s,0),a.setUniform1i("depthTex",0);return i.bindTexture(this._texture,1),a.setUniform1i("positionTex",1),(0,Sr.Jp)(Ld,this.camera.viewMatrix,(0,Sr.vc)(Ld,this._origin)),a.setUniformMatrix4fv("view",Ld),a.setUniformMatrix4fv("proj",this.camera.projectionMatrix),a.setUniform1i("count",this._counter),i.screen.draw(),this._pixelBuffer||(this._pixelBuffer=r.createBuffer()),0===this._format&&(this._format=r.getParameter(r.IMPLEMENTATION_COLOR_READ_FORMAT)===Ir.VI.RED&&r.getParameter(r.IMPLEMENTATION_COLOR_READ_TYPE)===Ir.g.FLOAT?Ir.VI.RED:Ir.VI.RGBA),r.bindBuffer(r.PIXEL_PACK_BUFFER,this._pixelBuffer),r.bufferData(r.PIXEL_PACK_BUFFER,this._width*this._height*(this._format===Ir.VI.RED?4:16),r.STREAM_READ),r.readPixels(0,0,this._width,this._height,this._format,Ir.g.FLOAT,0),this._sync=new Rd(r),n.release(),setTimeout((()=>this.running=!0),0),t}runTask(){if(!this._sync)return void(this.running=!1);try{if(!this._sync.poll())return qr.J}catch(e){return this.running=!1,void(this._sync=(0,f.SC)(this._sync))}this.running=!1,this._sync=(0,f.SC)(this._sync);const e=this.gl;e.bindBuffer(e.PIXEL_PACK_BUFFER,this._pixelBuffer),this._cpuBuffer=new Float32Array(this._width*this._height*(this._format===Ir.VI.RED?1:4)),e.getBufferSubData(e.PIXEL_PACK_BUFFER,0,this._cpuBuffer),e.bindBuffer(e.PIXEL_PACK_BUFFER,null),this.done=!0}init(e,t){const i=this._textureWidth;if(this._width=i,this._height=Math.ceil(e/i),this._counter=0,this._texture?.dispose(),0===this._height)return;const r=new Br.X(this._width,this._height);r.pixelFormat=Ir.VI.RGB,r.dataType=Ir.Br.FLOAT,r.samplingMode=Ir.cw.NEAREST,this._texture=new Pd.x(this.renderingContext,r),this.done=!1,(0,mr.i)(this._origin,Math.fround(t[0]),Math.fround(t[1]),Math.fround(t[2]))}addPosition(e){const t=this._width;if(this._counter>=t*this._height)return-1;const i=this._counter%t;return(0,mr.a)(Id,e,this._origin),this._uploadBuffer[3*i+0]=Id[0],this._uploadBuffer[3*i+1]=Id[1],this._uploadBuffer[3*i+2]=Id[2],i===t-1&&this._flush(),this._counter++}start(){if(0===this._width||0===this._height)return;const e=this._width;this._counter%e>0&&this._flush(),this.produces=this.category,this.requestRender(os.Xx.UPDATE)}getOcclusion(e){return this._cpuBuffer?.[this._format===Ir.VI.RED?e:4*e]??-1}_flush(){const e=this._width,t=Math.floor(this._counter/e);this._texture?.updateData(0,0,t,e,1,this._uploadBuffer)}_ensureShader(e){return null!=this._program||(this._program=e.programCache.acquire(Od,Dd,Ed.i)),this._program}};(0,o._)([(0,x.Cb)()],Ad.prototype,"category",void 0),(0,o._)([(0,x.Cb)()],Ad.prototype,"formatOverride",void 0),(0,o._)([(0,x.Cb)()],Ad.prototype,"running",void 0),(0,o._)([(0,x.Cb)()],Ad.prototype,"done",void 0),Ad=(0,o._)([(0,S.j)("esri.views.3d.webgl-engine.lib.GPUPointOcclusionQuery")],Ad);const Od="#version 300 es\nprecision highp float;\nin vec2 position;\n\nvoid main() {\n    gl_Position = vec4(position, 0.0, 1.0);\n}",Dd="#version 300 es\nprecision highp float;\nout highp vec4 fragColor;\n\nuniform highp mat4 proj;\nuniform highp mat4 view;\n\nuniform highp int count;\n\nuniform highp sampler2D depthTex;\nuniform highp sampler2D positionTex;\n\nfloat linearizeDepth(float depth) {\n  float depthNdc = depth * 2.0 - 1.0;\n  float c1 = proj[3][2];\n  float c2 = proj[2][2];\n  return -c1 / (depthNdc + c2 + 1e-7);\n}\n\nvoid main() {\n  int u = int(floor(gl_FragCoord.x));\n  int v = int(floor(gl_FragCoord.y));\n  if (u + v * textureSize(positionTex, 0).x >= count) {\n    fragColor = vec4(-1);\n    return;\n  }\n  vec4 posWorld = vec4(texelFetch(positionTex, ivec2(u, v), 0).rgb, 1.0);\n\n  vec4 posView = view * posWorld;\n  vec4 projected = proj * posView;\n\n  vec3 clipPos = projected.xyz / projected.w;\n\n  if (clipPos.x < -1.0 || clipPos.x > 1.0 || clipPos.y < -1.0 || clipPos.y > 1.0) {\n    fragColor = vec4(-1);\n    return;\n  }\n\n  vec3 uvDepth = 0.5 * clipPos + vec3(0.5);\n\n  float depth = texture(depthTex, uvDepth.xy).r;\n\n  if (uvDepth.z <= depth) {\n    fragColor = vec4(0);\n    return;\n  }\n\n  fragColor = vec4(linearizeDepth(depth) - linearizeDepth(uvDepth.z));\n}\n",Id=(0,O.Ue)(),Ld=(0,Mr.Ue)();var Fd=i(31484),Nd=i(3970),Ud=i(83584);const Hd=(0,O.Ue)(),Vd=(0,O.Ue)(),kd=(0,Uc.Ue)(),Bd=(0,Uc.Ue)(),zd=(0,O.Ue)(),Gd=(0,Mr.Ue)(),qd=(0,Nn.c)(),Zd=(0,Fn.Ue)(),jd=(0,O.Ue)(),Wd=(0,V.Ue)();class $d{constructor(e){this.id=e,this.aabr=(0,V.Ue)(),this.altitude=0,this.distance=0,this.distanceToOccluder=0,this.culled=!1,this.visible=!1,this.priority=0}}function Xd(e,t){const i=0!==e.distanceToOccluder&&e.distance>e.distanceToOccluder,r=0!==t.distanceToOccluder&&t.distance>t.distanceToOccluder;return i!==r?+i-+r:e.priority!==t.priority?t.priority-e.priority:e.distance!==t.distance?e.distance-t.distance:e.visible!==t.visible?+t.visible-+e.visible:e.id-t.id}class Yd{constructor(e,t){this.graphics3DGraphic=e,this.slicePlaneEnabled=t,this._info=null,this._labelInfo=null}ensureInfo(e){let t=this.getInfo(e);return t||(t=new $d(this.graphics3DGraphic.graphic.uid),this._setInfo(e,t)),t}getInfo(e){return e===Sd.E.LABEL?this._labelInfo:this._info}removeInfo(e){this._setInfo(e,null)}_setInfo(e,t){e===Sd.E.LABEL?this._labelInfo=t:this._info=t}}var Qd;!function(e){e[e.Idle=0]="Idle",e[e.CheckOcclusion=1]="CheckOcclusion",e[e.WaitOcclusion=2]="WaitOcclusion",e[e.Collect=3]="Collect",e[e.Deconflict=4]="Deconflict",e[e.NumStates=5]="NumStates"}(Qd||(Qd={}));class Kd{constructor(){this.camera=new Xo.Z,this.slicePlane=(0,cd.d)(),this.slicePlaneEnabled=!1}copyFrom(e){this.camera.copyFrom(e.camera),(0,cd.a)(e.slicePlane,this.slicePlane),this.slicePlaneEnabled=e.slicePlaneEnabled}}let Jd=class extends E.Z{get dirty(){return this._dirty}get state(){return this._state}constructor(e){super(e),this._dirty=!1,this._viewState=new Kd,this._state=Qd.Idle,this._checkOcclusion=new Map,this._active=new Map,this._checkOcclusionIterator=null,this._activeIterator=null,this._occlusionQueryUids=new Array,this._updatingHandles=new Y.R,this._deconflictor=new Td(((e,t)=>{e.visible=t,this._setGraphicVisibility(this._active.get(e.id),t)}),((e,t)=>e.id!==t.id),Xd),this._baseOccludedVisibility=10,this._altitudeFactor=2,this._minAltitudeDifference=100}initialize(){this._updatingHandles.add((()=>(this.view?.map?.ground?.opacity??0)>0),(()=>this.setDirty())),this._updatingHandles.add((()=>this.view.ready),(()=>this._occlusionQuery=null))}destroy(){this._occlusionQuery=null,this._updatingHandles.destroy(),this._deconflictor.destroy(),this._checkOcclusion.clear(),this._active.clear()}setDirty(){!this._dirty&&(this._active.size>0||this._checkOcclusion.size>0)&&(this._dirty=!0,this.notifyChange("updating"))}setPriority(e,t){const i=this._active.get(e.graphic.uid)?.getInfo(this.visibilityGroup);i&&(i.priority=t)}get updating(){return this._state!==Qd.Idle||this._dirty||this._updatingHandles.updating}get updatingProgress(){if(!this.updating)return 1;const e=this._state/Qd.NumStates;return this._dirty?.5*e:e}get running(){return this.view.ready&&null!=this.view.state&&this.updating}runTask(e){switch(this._state){case Qd.Idle:this._startUpdate(),e.madeProgress();case Qd.CheckOcclusion:if(this._state=Qd.CheckOcclusion,!this._processCheckOcclusion(e))return;case Qd.WaitOcclusion:if(this._state=Qd.WaitOcclusion,this._occlusionQuery&&!this._occlusionQuery.done)return qr.J;this._readOcclusionQueryResult(),e.madeProgress();case Qd.Collect:if(this._state=Qd.Collect,!this._collectActiveGraphics(e))return;case Qd.Deconflict:if(this._state=Qd.Deconflict,this._deconflictor.run(e),!this._deconflictor.done)return;default:this._state=Qd.Idle,this.notifyChange("updating")}}setGraphicsActive(e,t){t?e.forEach((e=>this.addToActiveGraphics(e))):e.forEach((e=>this.removeFromActiveGraphics(e)))}layerSupportsDeconfliction(e){if(null==e||"object3d"!==e.type)return!1;const t=e.stageObject;if(1!==(t?.geometries.length??0))return!1;const i=t?.geometries[0],r=i?.material;return r instanceof Nd.A}_startUpdate(){bd(this.view),this._dirty=!1,this._viewState.copyFrom(this.viewState);const{fullWidth:e,fullHeight:t}=this._viewState.camera;this._deconflictor.reset(e,t),this._resetIterators(),this._occlusionQueryUids.length=0,this._checkOcclusion.size||(this._occlusionQuery=(0,f.SC)(this._occlusionQuery))}addToActiveGraphics(e){e.ensureInfo(this.visibilityGroup),this._active.set(e.graphics3DGraphic.graphic.uid,e),this.setDirty()}removeFromActiveGraphics(e){(function(e,t){const i=e.graphics3DGraphic;i.destroyed||i.setVisibilityFlag(t,Sd.P.DECONFLICTION,!0)})(e,this.visibilityGroup),e.removeInfo(this.visibilityGroup),this._active.delete(e.graphics3DGraphic.graphic.uid),this.setDirty()}addToCheckOcclusion(e){this._checkOcclusion.set(e.graphics3DGraphic.graphic.uid,e),this.setDirty()}removeFromCheckOcclusion(e){this._checkOcclusion.delete(e.graphics3DGraphic.graphic.uid)}_processCheckOcclusion(e){if(0===this._checkOcclusion.size)return!0;const t=this._ensureCheckOcclusionIterator(),i=this._viewState.camera,r=(0,Sr.p4)(Gd,i.viewInverseTransposeMatrix),s=this.view.map.ground.opacity>0,n="global"===this.view.viewingMode&&s&&i.relativeElevation>0?qd:null;let a=0;null!=n&&((0,mr.t)((0,Nn.a)(n),O.AG,i.viewMatrix),n[3]=(0,vr.Iu)(this.view.spatialReference).radius,a=(0,Nn.h)(n,O.AG));const o=(0,V.Ue)();for(;;){if(e.done)return!1;e.madeProgress();const s=t.next();if(!0===s.done)break;const l=s.value,c=l.graphics3DGraphic;if(c.destroyed)continue;if(!c.isVisible(Sd.E.GRAPHIC,Sd.P.DECONFLICTION))continue;const h=ip(c,this.visibilityGroup);let u=null,d=!0;for(const e of h){if(!this.layerSupportsDeconfliction(e))continue;u=rp,this._projectHudLayer(e,i,u),(0,V.cS)(o);const t=e.stageObject.geometries[0].material;if(this._expandBoundingRect(o,i,e,t,u),u.isOutsideScreen){d=!1;break}if(this._isCulledBySlice(l,u.positionView)){d=!1;break}if(null!=n&&tp(u,n,a)){d=!1;break}(0,mr.t)(Vd,u.positionView,r),u.altitude=this.view.renderCoordsHelper.getAltitude(Vd);const s=l.ensureInfo(this.visibilityGroup);if(s.altitude=u.altitude,s.distance=u.distance,s.distanceToOccluder=u.distanceToOccluder,s.culled=!1,(0,V.JG)(s.aabr,o),t.parameters.occlusionTest)break;this._ensureOcclusionQuery().addPosition(Vd)===this._occlusionQueryUids.length&&this._occlusionQueryUids.push(c.graphic.uid);break}if(this._active.has(c.graphic.uid)&&(!d||!u)){const e=l.ensureInfo(this.visibilityGroup);e.visible=!u,e.culled=!0}}return this._checkOcclusionIterator=null,this._occlusionQueryUids.length||(this._occlusionQuery=(0,f.SC)(this._occlusionQuery)),this._occlusionQuery?.start(),!0}_readOcclusionQueryResult(){if(!this._occlusionQuery||!this._occlusionQueryUids.length)return;const e=this._viewState.camera,t=this.view.renderCoordsHelper.getAltitude(e.eye);for(let e=0;e<this._occlusionQueryUids.length;e++){const i=this._occlusionQueryUids[e],r=this._checkOcclusion.get(i);if(!r)continue;const s=this._occlusionQuery.getOcclusion(e)??-1,n=r.getInfo(this.visibilityGroup);n&&(n.distanceToOccluder=s>0?n.distance-s:0);const a=s<=0||this._occludedVisibility(n?.distanceToOccluder??0,n?.distance??s,n?.altitude??0,t);this._active.has(i)?n&&(n.culled=!a,n.visible=a):this._setGraphicVisibility(r,a)}this._occlusionQueryUids.length=0}_collectActiveGraphics(e){const t=this._ensureActiveGraphicsIterator(),i=this.visibilityGroup===Sd.E.LABEL;for(;!e.done;){e.madeProgress();const r=t.next();if(!0===r.done)return this._activeIterator=null,!0;const s=r.value,n=s.getInfo(this.visibilityGroup);n&&(i&&!s.graphics3DGraphic.isVisible()||n.culled?(xd(n.aabr,!1,!0),this._setGraphicVisibility(s,n.visible)):this._deconflictor.add(n))}return!1}_occludedVisibility(e,t,i,r){const s=Math.max(this._minAltitudeDifference,Math.abs(i-r))-this._minAltitudeDifference;return 0===e||t-e<=this._baseOccludedVisibility+this._altitudeFactor*s}_resetIterators(){this._checkOcclusionIterator=null,this._activeIterator=null}_ensureCheckOcclusionIterator(){return this._checkOcclusionIterator??=this._checkOcclusion.values(),this._checkOcclusionIterator}_ensureActiveGraphicsIterator(){return this._activeIterator??=this._active.values(),this._activeIterator}_ensureOcclusionQuery(){return this._occlusionQuery??=new Ad({view:this.view}),this._occlusionQueryUids.length||this._occlusionQuery.init(this._checkOcclusion.size,this._viewState.camera.eye),this._occlusionQuery}_projectHudLayer(e,t,i){const r=e.stageObject,s=r.geometries[0],n=s.material,a=(0,Nn.a)(r.boundingVolumeWorldSpace.bounds);(0,mr.t)(Hd,a,t.viewMatrix);const o=s.attributes,l=o.get(Jr.T.NORMAL).data,c=o.get(Jr.T.CENTEROFFSETANDDISTANCE).data;n.applyShaderOffsetsView(Hd,l,r.transformation,c,t,i.scaleInfo,Hd),(0,Nc.s)(kd,Hd[0],Hd[1],Hd[2],1),(0,Nc.t)(Bd,kd,t.projectionMatrix),(0,mr.g)(i.positionNDC,Bd,1/Bd[3]),n.applyShaderOffsetsNDC(i.positionNDC,c,t,i.positionNDC,zd),i.distanceWithoutPolygonOffset=t.depthNDCToWorld(zd[2]),i.distance=zd[2]===i.positionNDC[2]?i.distanceWithoutPolygonOffset:t.depthNDCToWorld(i.positionNDC[2]),(0,Nc.s)(Bd,i.positionNDC[0],i.positionNDC[1],i.positionNDC[2],1),(0,Nc.t)(kd,Bd,t.inverseProjectionMatrix),(0,Nc.d)(kd,kd,1/kd[3]),(0,mr.i)(i.positionView,Hd[0],Hd[1],Hd[2])}_isCulledBySlice(e,t){return e.slicePlaneEnabled&&this._viewState.slicePlaneEnabled&&(0,cd.e)(this._viewState.slicePlane,t)}_expandBoundingRect(e,t,i,r,{positionNDC:s,scaleInfo:n}){const a=i.getScreenSize(ep);(0,Fd.TU)(a,n.factor,a),a[0]*=t.pixelRatio,a[1]*=t.pixelRatio;const o=(0,V.cv)(r.calculateRelativeScreenBounds(a,n.factorAlignment.scale*t.pixelRatio,Wd),(0,jt.t7)(0,t.fullWidth,.5+.5*s[0]),(0,jt.t7)(0,t.fullHeight,.5+.5*s[1])),l=this.marginFactor;if(0!==l){const e=l*Math.min((0,V.d_)(o),(0,V.Cb)(o));o[0]-=e,o[1]-=e,o[2]+=e,o[3]+=e}(0,V.jn)(e,o,e)}_setGraphicVisibility(e,t){const i=e?.graphics3DGraphic;i&&!i.destroyed&&(i.setVisibilityFlag(this.visibilityGroup,Sd.P.DECONFLICTION,t),this.visibilityGroup===Sd.E.LABEL&&this.view.labeler.setLabelGraphicVisibility(i,t))}};(0,o._)([(0,x.Cb)({constructOnly:!0})],Jd.prototype,"view",void 0),(0,o._)([(0,x.Cb)({type:Boolean,readOnly:!0})],Jd.prototype,"updating",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Jd.prototype,"_updatingHandles",void 0),Jd=(0,o._)([(0,S.j)("esri.views.3d.layers.graphics.Deconflictor")],Jd);const ep=(0,Rr.Ue)();function tp(e,t,i){return(0,mr.c)(Zd.direction,e.positionView),(0,mr.i)(Zd.origin,0,0,0),!!(0,Nn.i)(t,Zd,jd)&&e.distanceWithoutPolygonOffset>i}function ip(e,t){return t===Sd.E.LABEL?e.labelLayers:e.layers}const rp=new class{constructor(){this.positionView=(0,O.Ue)(),this.positionNDC=(0,O.Ue)(),this.altitude=0,this.distance=0,this.distanceToOccluder=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo=new Ud.G}get isOutsideScreen(){const e=this.positionNDC;return e[0]<-1||e[1]<-1||e[2]<-1||e[0]>=1||e[1]>=1||e[2]>=1}};let sp=class extends Jd{constructor(e){super(e),this.visibilityGroup=Sd.E.LABEL,this.marginFactor=.05,this._lastDeconfliction=0}get viewState(){return this.parent.viewState}runTask(e){if(this.parent.running)return qr.J;const t=performance.now();if(this.view.state.mode!==Yc.n.IDLE&&t-this._lastDeconfliction<2e3)return qr.J;const i=super.runTask(e);return this.state===Qd.Idle&&(this._lastDeconfliction=t),i}};(0,o._)([(0,x.Cb)({constructOnly:!0})],sp.prototype,"parent",void 0),sp=(0,o._)([(0,S.j)("esri.views.3d.layers.graphics.LabelDeconflictor")],sp);let np=class extends Jd{constructor(){super(...arguments),this._contexts=new Map,this.visibilityGroup=Sd.E.GRAPHIC,this._marginFactor=-.1,this.test={overrideMarginFactor:e=>{this._marginFactor=e,this.setDirty()}}}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this._updatingHandles.add((()=>this.view?.state?.camera),(()=>{this._updateViewState(),this.setDirty()})),this._updatingHandles.add((()=>this.view?.slice?.plane),(()=>{this._updateSlicePlane(),this._slicePlaneChanged()}),n.nn),this.addHandles((0,n.YP)((()=>this.view.basemapTerrain?.updating||this.view.graphicsView?.updating||this.view.allLayerViews.some((e=>e.updating))),((e,t)=>{!e&&t&&this.setDirty()}),n.Z_)),this._frameTask=this.view.resourceController.scheduler.registerTask(Gr.T8.GRAPHICS_DECONFLICTOR,this),this._labels=new sp({view:this.view,parent:this})}destroy(){this._labels=(0,f.SC)(this._labels),this._frameTask=(0,f.hw)(this._frameTask)}get marginFactor(){return this._marginFactor}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}runTask(e){const t=super.runTask(e);return this.running||this._labels.setDirty(),t}_updateViewState(){this.view?.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this._updateSlicePlane())}_updateSlicePlane(){const e=this.view?.slice?.plane;null!=e&&(0,cd.t)(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=null!=e}_slicePlaneChanged(){for(const e of this._contexts.keys())if(e.symbolCreationContext.slicePlaneEnabled)return void this.setDirty()}addGraphicsOwner(e){const t=this._getGraphicsContext(e);return{addGraphic:i=>this._addGraphic(e,t,i),removeGraphic:e=>this._removeGraphic(t,e),labelingInfoChange:()=>this._labelsEnabledChanged(e,t),featureReductionChange:()=>this._enabledChanged(e,t),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,t),clear:()=>t.forEach((e=>this._removeGraphic(t,e.graphics3DGraphic))),remove:()=>this._removeGraphicsOwner(e),setDirty:()=>this.setDirty()}}_removeGraphicsOwner(e){const t=this._contexts.get(e);t&&(t.forEach((e=>this._removeGraphic(t,e.graphics3DGraphic))),this._contexts.delete(e),this.setDirty())}_addGraphic(e,t,i){const r=i.graphic.uid,s=new Yd(i,e.symbolCreationContext.slicePlaneEnabled);t.set(r,s),this.addToCheckOcclusion(s),ap(e)&&this.addToActiveGraphics(s),e.labelsEnabled&&(this._labels.addToCheckOcclusion(s),this._labels.addToActiveGraphics(s));const n=!this._graphicSupportsDeconfliction(i)||!ap(e);i.setVisibilityFlag(Sd.E.GRAPHIC,Sd.P.DECONFLICTION,n)}_removeGraphic(e,t){const i=t.graphic.uid,r=e.get(i);r&&(this.removeFromActiveGraphics(r),this.removeFromCheckOcclusion(r),this._labels.removeFromActiveGraphics(r),this._labels.removeFromCheckOcclusion(r),e.delete(i),this.setDirty())}_enabledChanged(e,t){ap(e)?t.forEach((e=>this.addToActiveGraphics(e))):(t.forEach((e=>this.removeFromActiveGraphics(e))),function(e){const t=e.graphics3DGraphics;t&&t.forEach((e=>e.setVisibilityFlag(Sd.E.GRAPHIC,Sd.P.DECONFLICTION,!0)))}(e))}_labelsEnabledChanged(e,t){e.labelsEnabled?(t.forEach((e=>this._labels.addToCheckOcclusion(e))),t.forEach((e=>this._labels.addToActiveGraphics(e)))):(t.forEach((e=>this._labels.removeFromCheckOcclusion(e))),t.forEach((e=>this._labels.removeFromActiveGraphics(e))))}_slicePlaneEnabledChanged(e,t){const i=e.symbolCreationContext.slicePlaneEnabled;t.forEach((e=>e.slicePlaneEnabled=i)),this.setDirty()}_graphicSupportsDeconfliction(e){if(e.isDraped)return!1;const t=e.layers;if(!t?.length)return!1;for(const e of t)if(this.layerSupportsDeconfliction(e))return!0;return!1}_getGraphicsContext(e){const t=this._contexts.get(e);if(t)return t;const i=new Map;return this._contexts.set(e,i),this.setDirty(),i}};function ap(e){const t=e.layer;return!(!t?.featureReduction||"selection"!==t.featureReduction.type)}np=(0,o._)([(0,S.j)("esri.views.3d.layers.graphics.GraphicsDeconflictor")],np);var op=i(62640),lp=i(67908),cp=i(91383),hp=i(33869),up=i(30146),dp=i(8008);class pp{constructor(e,t){this._renderCoordsHelper=e,this.opaqueGround=t,this._cache=new Map,this._cameraForward=(0,O.Ue)(),this._cameraEye=(0,O.Ue)(),this._cameraFovY=55*Math.PI/180,this._frustumBoundingSphereCenter=(0,O.Ue)(),this._frustumBoundingSphereRadius=0,this._frustum=new Gc.i(e),this._renderSR=e.spatialReference;const i=(0,_r.rS)(this._renderSR);this._renderSREllipsoidRadius=(0,vr.Iu)(i).radius}setup(e){this._aboveGround=e.aboveGround,this._frustum.update(e),(0,mr.n)(this._cameraForward,e.viewForward),(0,mr.c)(this._cameraEye,e.eye),this._cameraFovY=e.fovY,this._updateFrustumBoundingSphere()}done(){this._cache.clear()}compute(e){if(this._cache.has(e.id))return this._cache.get(e.id);const t=this._isVisibleInFrustum(e);return this._cache.set(e.id,t),t}_isVisibleInFrustum(e){return this._renderCoordsHelper.viewingMode===Si.JY.Local?this._isTileVisibleInFrustumLocal(e):this._isTileVisibleInFrustumGlobal(e)}_updateFrustumBoundingSphere(){const e=this._frustum,t=e.origin,i=Ip;(0,mr.n)(i,e.direction);const r=e.points,s=Lp;(0,mr.a)(s,r[4],t);const n=.5*(0,mr.e)(s,s)/(0,mr.e)(i,s),a=this._frustumBoundingSphereCenter;(0,mr.b)(a,t,i,n);const o=1+n;this._frustumBoundingSphereRadius=o}_isTileVisibleInFrustumLocal(e){const t=e.spatialReference,i=e.extent,r=this._renderSR;if(Tp[0]=i[0],Tp[1]=i[1],Tp[2]=0,Tp[3]=i[2],Tp[4]=i[3],Tp[5]=0,!(0,up.projectBuffer)(Tp,t,0,Tp,r,0))return!1;(0,mr.i)(Sp[0],Tp[0],Tp[1],0),(0,mr.i)(Sp[1],Tp[3],Tp[1],0),(0,mr.i)(Sp[2],Tp[3],Tp[4],0),(0,mr.i)(Sp[3],Tp[0],Tp[4],0),(0,mr.i)(Mp,.5*(Tp[0]+Tp[3]),.5*(Tp[1]+Tp[4]),.5*(Tp[2]+Tp[5]));const s=hm,n=.5*(0,mr.F)(Sp[0],Sp[2]),a=this._frustum,o=this._frustumBoundingSphereRadius,l=this._frustumBoundingSphereCenter,c=Np;(0,mr.a)(c,l,Mp);const h=(0,mr.e)(s,c),u=Fp;if((0,mr.b)(u,Mp,s,h),(0,mr.F)(u,l)>n+o)return!1;const d=this._cameraForward,p=(0,mr.e)(d,hm),m=this._cameraFovY,_=this._cameraEye;if(Math.abs(p)<Math.abs(Math.cos(.5*m))){let e=!0;const t=(0,mr.i)(um,d[0],d[1],0),i=(0,mr.e)(_,t);for(let r=0;r<4;++r){const s=Sp[r];if((0,mr.e)(s,t)-i>0){e=!1;break}}if(e)return!1}{const e=Sp[0],t=Sp[2];if(e[0]<=_[0]&&_[0]<=t[0]&&e[1]<=_[1]&&_[1]<=t[1])return!0}const f=xp,g=this.opaqueGround&&this._aboveGround,y=this.opaqueGround&&!this._aboveGround,v=Math.min(y?am:1/0,h+o),b=Math.max(g?-430:-1/0,h-o);for(let e=0;e<4;++e)(0,mr.b)(f[e],Sp[e],s,v),(0,mr.b)(f[e+4],Sp[e],s,b);if(vp(a.planes,f,8))return!1;if(bp(a.planes,f,8))return!0;for(let e=0;e<4;++e){const t=f[e],i=f[e+4];if(dm(a.planes,t,i))return!0;const r=f[(e+1)%4];if(dm(a.planes,t,r))return!0;const s=f[4+(e+1)%4];if(dm(a.planes,i,s))return!0}if(_m[0][3]=+Sp[0][0],_m[1][3]=-Sp[2][0],_m[2][3]=+Sp[0][1],_m[3][3]=-Sp[2][1],_m[4][3]=+b,_m[5][3]=-v,bp(_m,a.points))return!0;if(bp(_m,a.points))return!0;for(let e=0;e<4;++e){const t=_,i=a.points[e+4];if(pm(_m,t,i))return!0;const r=a.points[4+(e+1)%4];if(pm(_m,i,r))return!0}return!1}_isTileVisibleInFrustumGlobal(e){if(e.level<wp)return!0;const t=e.spatialReference,i=e.extent,r=this.opaqueGround&&this._aboveGround,s=this.opaqueGround&&!this._aboveGround,n=Sp,a=.5*(i[0]+i[2]);if((0,mr.i)(n[0],i[0],i[1],0),(0,mr.i)(n[1],i[2],i[1],0),(0,mr.i)(n[2],i[2],i[3],0),(0,mr.i)(n[3],i[0],i[3],0),(0,mr.i)(n[4],a,i[1],0),(0,mr.i)(n[5],a,i[3],0),!function(e,t,i,r,s,n,a=1){const o=(0,dp.R8)(t,s);if(null==o)return!1;if(o===dp.iq){if(e===r&&i===n)return!0;const t=i+a;for(let s=i,a=n;s<t;++s,++a)(0,mr.c)(r[a],e[s]);return!0}const l=i+a;for(let t=i,s=n;t<l;++t,++s)o(e[t],0,r[s],0);return!0}(n,t,0,n,this._renderSR,0,6))return!1;const o=n[0][2]>0,l=n[3][2]<0,c=o||l,h=this._renderSREllipsoidRadius;if(c){const e=Rp;mp(e,fm,n[0]);const t=Pp;if(mp(t,fm,n[1]),o){const i=Ep,r=n[4],s=Ap;mp(s,r,fm),mp(i,s,r);const a=n[0];(0,mr.h)(a,e,i),fp(a,h);const o=n[1];(0,mr.h)(o,t,i),fp(o,h)}else if(l){const i=Ep,r=n[5],s=Ap;mp(s,r,fm),mp(i,r,s);const a=n[3];(0,mr.h)(a,i,e),fp(a,h);const o=n[2];(0,mr.h)(o,i,t),fp(o,h)}}const u=Mp,d=(0,mr.a)(Bp,n[3],n[0]);(0,mr.n)(d,d);const p=(0,mr.f)(zp,n[0],n[3]);(0,mr.g)(p,p,.5);const m=-(0,mr.e)(p,d),_=(0,mr.f)(Gp,n[0],n[1]);(0,mr.g)(_,_,.5);const f=(0,mr.f)(qp,n[2],n[3]);(0,mr.g)(f,f,.5);const g=(0,mr.a)(Zp,f,_);(0,mr.n)(g,g);const y=-(m+(0,mr.e)(d,_))/(0,mr.e)(d,g);(0,mr.b)(u,_,g,y),fp(u,h);const v=this._frustumBoundingSphereRadius,b=this._frustumBoundingSphereCenter,w=this._frustum,C=w.planes,x=Op;(0,mr.n)(x,u);const T=(0,mr.e)(n[0],x)/(0,mr.H)(n[0]),S=w.origin,M=w.points;let E=!1;if(r){{E=!0;const e=(0,mr.n)(om,S);for(let t=0;t<4;++t){const i=M[4+t],r=(0,mr.a)((0,O.Ue)(),i,S);(0,mr.n)(r,r);const s=(0,mr.h)((0,O.Ue)(),e,r);(0,mr.n)(s,s);const n=(0,mr.h)((0,O.Ue)(),r,s);if((0,mr.n)(n,n),(0,mr.e)(S,n)>h){E=!1;break}}}if(E&&(0,mr.e)(S,x)<h*T-am)return!1;const e=(0,mr.n)(om,w.origin);if((0,mr.e)(e,x)<0)return!1;{const e=(0,mr.n)(lm,w.direction);if((0,mr.e)(e,x)>cm)return!1}}const R=Math.sqrt(1-T*T);if(R>.9)return!0;let P=!1;const A=(0,mr.e)(x,b),D=(0,mr.H)(b);if(D<=v&&!C.some((e=>(0,ul.jH)(e,Up)>0))){if(!r)return!0;P=!0}const I=A/D;if(!P&&A<=0&&-A>v)return!1;const L=v/D;if(Math.sqrt(1-I*I)*Math.sqrt(1-L*L)-L*I>R)return!1;if(!E){if(n.some((e=>w.intersectsPoint(e))))return!0;if(w.intersectsPoint(u))return!0}const F=Hp;(0,mr.a)(F,b,Up);const N=(0,mr.e)(F,x),U=Dp;(0,mr.g)(U,x,N);const H=(0,mr.F)(U,b),V=t.isWGS84,k=e.lij,B=V&&k[2]===2**k[0]-1,z=V&&0===k[2],G=z?tm:B?Jp:Qp,q=z?im:B?em:Kp;if(!P){const e=n,t=rm,i=jp,r=Wp,s=Up;for(const n of G){const a=e[n];if(_p(i,e[(n+1)%4],a),_p(r,s,a),mp(t,r,i),Cp(t,M,1))return!1}}let Z=null;if(!r&&N<1.01*v){const e=2.5*v;if(H>T*e+v)return!1;const t=kp,i=e/T;for(let e=0;e<4;++e)(0,mr.g)(t[e],n[e],i/h);(0,mr.i)(t[4],0,0,0),Z=t}else{const e=(s?h+am:N+v)/T,t=r?h-am:(N-v)/T,i=Vp;for(let r=0;r<4;++r){const s=n[r];(0,mr.g)(i[r],s,t/h),(0,mr.g)(i[r+4],s,e/h)}Z=i}if(vp(C,Z,Z.length))return!1;const j=w.lines,W=$p,$=Xp;for(const e of j){(0,mr.n)($,e.direction);for(const e of q){const t=Z[e];if((0,mr.n)(W,t),nm($,W,Z,M))return!1;const i=(e+1)%4;if(r){const e=Z[i];if((0,mr.a)(W,e,t),(0,mr.n)(W,W),nm($,W,Z,M))return!1}if(s){const t=Z[4+e],r=Z[4+i];if((0,mr.a)(W,r,t),(0,mr.n)(W,W),nm($,W,Z,M))return!1}}}return!0}}function mp(e,t,i){return(0,mr.h)(e,t,i),(0,mr.n)(e,e),e}function _p(e,t,i){return(0,mr.a)(e,t,i),(0,mr.n)(e,e),e}function fp(e,t){return(0,mr.g)(e,e,t/(0,mr.H)(e)),e}const gp=[hp.Nu.LEFT,hp.Nu.RIGHT,hp.Nu.BOTTOM,hp.Nu.TOP,hp.Nu.FAR];function yp(e,t,i){for(let r=0;r<i;++r)if((0,ul.jH)(e,t[r])<=0)return!1;return!0}function vp(e,t,i){for(const r of gp)if(yp(e[r],t,i))return!0;return!1}function bp(e,t,i=t.length){for(let r=0;r<i;++r){const i=t[r];let s=!0;for(const t of e)if((0,ul.jH)(t,i)>0){s=!1;break}if(s)return!0}return!1}const wp=2;function Cp(e,t,i){for(const r of t)if((0,mr.e)(r,e)<i)return!1;return!0}const xp=[(0,O.Ue)(),(0,O.Ue)(),(0,O.Ue)(),(0,O.Ue)(),(0,O.Ue)(),(0,O.Ue)(),(0,O.Ue)(),(0,O.Ue)()],Tp=[0,0,0,0,0,0],Sp=[(0,O.Ue)(),(0,O.Ue)(),(0,O.Ue)(),(0,O.Ue)(),(0,O.Ue)(),(0,O.Ue)()],Mp=(0,O.Ue)(),Ep=(0,O.Ue)(),Rp=(0,O.Ue)(),Pp=(0,O.Ue)(),Ap=(0,O.Ue)(),Op=(0,O.Ue)(),Dp=(0,O.Ue)(),Ip=(0,O.Ue)(),Lp=(0,O.Ue)(),Fp=(0,O.Ue)(),Np=(0,O.Ue)(),Up=(0,O.vV)(0,0,0),Hp=(0,O.Ue)(),Vp=[(0,O.Ue)(),(0,O.Ue)(),(0,O.Ue)(),(0,O.Ue)(),(0,O.Ue)(),(0,O.Ue)(),(0,O.Ue)(),(0,O.Ue)()],kp=[(0,O.Ue)(),(0,O.Ue)(),(0,O.Ue)(),(0,O.Ue)(),(0,O.Ue)()],Bp=(0,O.Ue)(),zp=(0,O.Ue)(),Gp=(0,O.Ue)(),qp=(0,O.Ue)(),Zp=(0,O.Ue)(),jp=(0,O.Ue)(),Wp=(0,O.Ue)(),$p=(0,O.Ue)(),Xp=(0,O.Ue)(),Yp=(0,O.Ue)(),Qp=[0,1,2,3],Kp=[0,1,2,3],Jp=[0,1,3],em=[0,1,3],tm=[1,2,3],im=[1,2,3],rm=(0,O.Ue)();const sm=[0,0];function nm(e,t,i,r){const s=i.length,n=r.length;if(0===s||0===n)return!0;const a=Yp;mp(a,e,t);const o=n<s,l=o?i:r,c=sm;return function(e,t,i){let r=1/0,s=-1/0;for(const e of i){const i=(0,mr.e)(t,e);r=Math.min(r,i),s=Math.max(s,i)}e[0]=r,e[1]=s}(c,a,o?r:i),function(e,t,i,r){let s=1/0,n=-1/0;for(const a of r){const r=(0,mr.e)(i,a);if(s=Math.min(s,r),n=Math.max(n,r),s<=t&&n>=e)return!1}return!0}(c[0],c[1],a,l)}const am=430,om=(0,O.Ue)(),lm=(0,O.Ue)(),cm=Math.cos(.25*Math.PI),hm=(0,O.al)(0,0,1),um=(0,O.Ue)();function dm(e,t,i){const r={t0:0,t1:1};for(const s of gp)if(!mm(e[s],t,i,r))return!1;return r.t0<r.t1}function pm(e,t,i){const r={t0:0,t1:1};for(const s of e)if(!mm(s,t,i,r))return!1;return r.t0<r.t1}function mm(e,t,i,r){let{t0:s,t1:n}=r;const a=(0,ul.jH)(e,t),o=(0,ul.jH)(e,i);if(a>=0&&o>=0)return!1;if(a<0&&o>=0){const e=-a/(o-a);if(e<s)return!1;e<n&&(n=e)}else if(a>=0&&o<0){const e=a/(a-o);if(e>n)return!1;e>s&&(s=e)}return r.t0=s,r.t1=n,!0}const _m=[(0,ul.al)(-1,0,0,1),(0,ul.al)(1,0,0,-1),(0,ul.al)(0,-1,0,1),(0,ul.al)(0,1,0,-1),(0,ul.al)(0,0,-1,1),(0,ul.al)(0,0,1,-1)],fm=(0,O.vV)(0,0,1);class gm{constructor(e,t,i){this._renderCoordsHelper=e,this._tilingScheme=t,this._camera=new Xo.Z,this._surfaceElevation=0,this._focusOnMap=[0,0],this._visibility=new pp(e,i)}set opaqueGround(e){this._visibility.opaqueGround=e}setup(e,t,i){this._camera.copyFrom(e),this._surfaceElevation=i,this._focusOnMap[0]=t.x,this._focusOnMap[1]=t.y,this._visibility.setup(this._camera)}done(){this._visibility.done()}update(e){const{measures:t,extent:i,level:r}=e;t.visible=this._visibility.compute(e),t.distance=(0,V.TE)(i,this._focusOnMap),t.mergeable=!0,t.lodLevel=wp,t.splitPriority=Math.max(0,wp-r),t.visible&&(this._isGlobal?this._updateSplitAndLodGlobal(e):this._updateSplitAndLodLocal(e))}_updateSplitAndLodGlobal(e){const t=e.level,i=this._renderCoordsHelper,{eye:r,fov:s}=this._camera,n=i.referenceEllipsoid.radius,a=(0,mr.H)(r)-n;if(2*Math.atan(n/a)<s&&a>0)return void(e.measures.lodLevel=Math.max(t,wp));const o=ym,{extent:l}=e,{_surfaceElevation:c}=this;(0,mr.i)(o[0],l[0],l[1],c),(0,mr.i)(o[1],l[2],l[1],c),(0,mr.i)(o[2],l[2],l[3],c),(0,mr.i)(o[3],l[0],l[3],c);const h=(0,mr.i)(vm,.5*(l[0]+l[2]),.5*(l[1]+l[3]),c),u=this._tilingScheme.spatialReference;for(let e=0;e<4;++e)i.toRenderCoords(o[e],u,o[e]);i.toRenderCoords(h,u,h);const d=(0,mr.n)(xm.direction,h),p=(0,mr.e)(r,d),m=(0,mr.g)(wm,d,p);this._updateSplitAndLod(e,o,h,m)}_updateSplitAndLodLocal(e){const t=ym,{extent:i}=e,{_surfaceElevation:r}=this;(0,mr.i)(t[0],i[0],i[1],r),(0,mr.i)(t[1],i[2],i[1],r),(0,mr.i)(t[2],i[2],i[3],r),(0,mr.i)(t[3],i[0],i[3],r);const s=this._tilingScheme.spatialReference;for(let e=0;e<4;++e)this._renderCoordsHelper.toRenderCoords(t[e],s,t[e]);const n=(0,mr.i)(vm,.5*(t[0][0]+t[2][0]),.5*(t[0][1]+t[2][1]),.25*(t[0][2]+t[1][2]+t[2][2]+t[3][2])),a=(0,mr.i)(bm,n[0],n[1],0),{eye:o,far:l}=this._camera,c=(0,mr.i)(wm,a[0],a[1],o[2]);(0,mr.i)(xm.origin,a[0],a[1],o[2]-2*l),(0,mr.c)(xm.direction,Cm),this._updateSplitAndLod(e,t,n,c)}_updateSplitAndLod(e,t,i,r){const s=Math.max((0,mr.F)(t[0],t[2]),(0,mr.F)(t[1],t[3]),(0,mr.F)(t[0],i)+(0,mr.F)(i,t[2]),(0,mr.F)(t[1],i)+(0,mr.F)(i,t[3])),{eye:n,near:a,fov:o,viewForward:l,width:c,height:h,pixelRatio:u,frustum:d}=this._camera,p=(0,mr.e)(n,l),m=(0,mr.e)(i,l)-p,_=(0,mr.F)(i,n);let f=m,g=m,y=_,v=_;const b=(e,t)=>t<a?1:Math.sqrt(e*e-t*t)/t;let w=b(_,m);for(const e of t){const t=(0,mr.e)(e,l)-p;f=Math.min(f,t),g=Math.max(g,t);const i=(0,mr.F)(e,n);v=Math.max(v,i),y=Math.min(y,i);const r=b(i,t);w=Math.min(w,r)}if(g<a)return void(e.measures.lodLevel=0);const C=Math.cos(.5*o),x=(0,mr.F)(n,r);w>C&&x>Sm*s&&(g=Mm*v,f=Mm*y);const T=.5*Math.sqrt(c*c+h*h)/u,S=2*Math.tan(.5*o),M=e=>Math.max(a,e)*Tm/T*S,E=e.level,R=s*2**E*Math.max(1,S),P=M(f),A=Math.ceil(Math.log2(Math.max(1,R/P)));if(e.measures.lodLevel=Math.max(A,e.measures.lodLevel),e.measures.splitPriority+=e.measures.lodLevel-E,E<A){const i=+(0,hp.g8)(d,t[0])+ +(0,hp.g8)(d,t[1])+ +(0,hp.g8)(d,t[2])+ +(0,hp.g8)(d,t[3]);e.measures.splitPriority+=i}const O=M(g)/P;O>2.5&&(e.measures.splitPriority+=O)}get _isGlobal(){return this._renderCoordsHelper.viewingMode===Si.JY.Global}}const ym=[(0,O.Ue)(),(0,O.Ue)(),(0,O.Ue)(),(0,O.Ue)()],vm=(0,O.Ue)(),bm=(0,O.Ue)(),wm=(0,O.Ue)(),Cm=(0,O.vV)(0,0,1),xm=(0,Fn.al)(O.AG,Cm),Tm=312,Sm=.5,Mm=2;var Em=i(58300);let Rm=class extends E.Z{constructor(e){super(e),this.tiles=new c.Z,this.tileSize=512,this._idToTile=new Map,this._clients=new Set,this._dirty=(0,yr.t)(!1),this._pendingTiles=(0,yr.t)(null),this._newTiles=new ud.Z,this._tests=!1,this._measurements=new gm(e.renderCoordsHelper,e.tilingSchemeOwner.tilingScheme,this._opaqueGround)}initialize(){const e=()=>this._setDirty();this.addHandles([(0,n.YP)((()=>this.tileSize),(()=>this._reset()),n.tX),(0,n.YP)((()=>this.cameraOnSurface?.location),e,n.tX),(0,n.YP)((()=>this.viewState?.contentCamera),e,n.tX),(0,n.YP)((()=>this.focus?.location),e,n.tX),(0,n.YP)((()=>this.terrain?.baseOpacity??1),e),(0,n.YP)((()=>this.tilingScheme),(e=>{this._reset(),this._measurements=new gm(this.renderCoordsHelper,e,this._opaqueGround)}),n.Z_),(0,n.YP)((()=>this._opaqueGround),(e=>this._measurements.opaqueGround=e),n.Z_)]),this._frameWorker=this.scheduler?.registerTask(Gr.T8.FEATURE_TILE_TREE,this)}destroy(){this._frameWorker=(0,f.hw)(this._frameWorker)}get tilingScheme(){const e=this.tilingSchemeOwner.tilingScheme;return e?e.clone():null}set filterExtent(e){if(null!=e&&!e.spatialReference.equals(this.viewState.spatialReference))return void _.Z.getLogger(this).error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const t=this._get("filterExtent");if(t===e||null!=t&&e&&t.equals(e))return;const i=null!=e?e.clone():null;this._set("filterExtent",i),this._setDirty()}get _filterExtentRect(){if(null==this.filterExtent)return null;const e=(0,V.Ue)();return(0,Em.G)(this.filterExtent,e,this.tilingScheme.spatialReference),e}get _rootTileIds(){const{tilingScheme:e}=this;return this._filterExtentRect&&e?e.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}get updating(){return this._dirty.value||!!this._pendingTiles.value}addClient(){const e=(0,lp.D)();return this._clients.add(e),1===this._clients.size&&this._setDirty(),(0,p.kB)((()=>this._removeClient(e)))}_removeClient(e){this._clients.delete(e),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}get _opaqueGround(){return 1===(this.terrain?.baseOpacity??1)}_setDirty(){this._hasClients&&!this.suspended&&(this._frameWorker?this._dirty.value=!0:this.runTask(Gr.G5))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty.value=!1}get running(){return this.updating}_reset(){this._newTiles.clear(),this._pendingTiles.value=null,this._setDirty()}_getRootTiles(){const e=this.tilingScheme;return this._rootTileIds.map((t=>new cp.Q(t[0],t[1],t[2],e)))}runTask(e){e=this._tests?Gr.G5:e,this._dirty.value=!1,this._pendingTiles.value||(this._startUpdate(e),null!=this._frameWorker&&(this._frameWorker.priority=Gr.T8.FEATURE_TILE_TREE_ACTIVE)),this._splitPendingTiles(e),this._pendingTiles.value||null==this._frameWorker||(this._frameWorker.priority=Gr.T8.FEATURE_TILE_TREE)}_startUpdate(e){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();const{_measurements:t,_filterExtentRect:i,_newTiles:r}=this;t.setup(this.viewState.contentCamera,this.focus.location,this.cameraOnSurface.location.z??0),this._pendingTiles.value=this._getRootTiles().filter((e=>{if(t.update(e),e.measures.visible&&(!i||(0,V.kK)(e.extent,i))){if(e.measures.splitPriority>0)return!0;r.push(e)}return!1})).sort(Pm),this._newTiles.clear(),e.madeProgress()}_splitPendingTiles(e){const t=this._pendingTiles.value;if(!t)return;const{tilingScheme:i,_filterExtentRect:r,_newTiles:s,_measurements:n}=this;for(;t.length>0&&this._tileBudgetRatio<=2;){const a=t.pop();if(e.madeProgress(),a.measures.splitPriority>0){i.ensureMaxLod(a.level+1);const e=a.createChildren();for(const i of e)n.update(i),!i.measures.visible||r&&!(0,V.kK)(i.extent,r)||(i.measures.splitPriority>0?t.push(i):s.push(i));t.sort(Pm),this._mergeNewTiles(2),this._mergeNewTiles(2,!0)}else s.push(a);if(e.done)return}s.pushArray(t),this._pendingTiles.value=null,this._updateTiles(),s.clear(),n.done()}get _tileBudgetRatio(){return(this._newTiles.length+(this._pendingTiles.value?.length??0))/60}_mergeNewTiles(e,t=!1){if(this._tileBudgetRatio<=e)return;const{_newTiles:i,_measurements:r}=this;i.sort(((e,t)=>t.measures.distance-e.measures.distance));const s=new Map(i.map((e=>[e.id,e]))),n=i.length;for(const n of s.values()){const{lij:a,measures:o}=n;if(!o.mergeable||a[1]%2!=0||a[2]%2!=0||a[0]<=1||n.lodLevelDelta>=4)continue;const l=o.lodLevel;let c=l,h=!0;const u=s.get((0,cp.J)(a[0],a[1]+1,a[2]));let d=Math.abs((u?.measures.lodLevel??0)-l),p=0===d||t&&u?.measures.mergeable&&d<=1;if(!u||!p)continue;c+=u.measures.lodLevel,h&&=0===d;const m=s.get((0,cp.J)(a[0],a[1],a[2]+1));if(d=Math.abs((m?.measures.lodLevel??0)-l),p=0===d||t&&m?.measures.mergeable&&d<=1,!m||!p)continue;c+=m.measures.lodLevel,h&&=0===d;const _=s.get((0,cp.J)(a[0],a[1]+1,a[2]+1));if(d=Math.abs((_?.measures.lodLevel??0)-l),p=0===d||t&&_?.measures.mergeable&&d<=1,!_||!p)continue;c+=_.measures.lodLevel,h&&=0===d,i.removeUnordered(n),i.removeUnordered(u),i.removeUnordered(m),i.removeUnordered(_),s.delete(n.id),s.delete(u.id),s.delete(m.id),s.delete(_.id);const f=new cp.Q(a[0]-1,a[1]/2,a[2]/2,this.tilingScheme);if(r.update(f),f.measures.visible=!0,f.measures.lodLevel=c/4,f.measures.mergeable=h,i.push(f),s.set(f.id,f),this._tileBudgetRatio<=e)return}i.length<n&&this._mergeNewTiles(e,t)}_updateTiles(){this._mergeNewTiles(1),this._mergeNewTiles(1,!0);for(const e of this.tiles.items)e.used=!1;let e=!1;const t=this._newTiles.filter((t=>{const i=this._idToTile.get(t.id);return i?(e||=i.measures.lodLevel!==t.measures.lodLevel,i.measures={...t.measures},i.used=!0):this._idToTile.set(t.id,t),!i})),i=this.tiles.items.filter((e=>!e.used&&(this._idToTile.delete(e.id),!0)));this.tiles.removeMany(i),this.tiles.addMany(t),this._sortTiles(),!e||i.length||t.length||this.tiles.emit("change")}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort(((e,t)=>e.measures.distance-t.measures.distance)),this.tiles.forEach(((e,t)=>e.loadPriority=t))}};function Pm(e,t){return e.lodLevelDelta-t.lodLevelDelta||e.measures.splitPriority-t.measures.splitPriority||t.measures.distance-e.measures.distance}(0,o._)([(0,x.Cb)({constructOnly:!0})],Rm.prototype,"scheduler",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],Rm.prototype,"renderCoordsHelper",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],Rm.prototype,"tilingSchemeOwner",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],Rm.prototype,"cameraOnSurface",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],Rm.prototype,"focus",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],Rm.prototype,"viewState",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],Rm.prototype,"terrain",void 0),(0,o._)([(0,x.Cb)()],Rm.prototype,"tiles",void 0),(0,o._)([(0,x.Cb)()],Rm.prototype,"tileSize",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Rm.prototype,"tilingScheme",null),(0,o._)([(0,x.Cb)()],Rm.prototype,"filterExtent",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Rm.prototype,"_filterExtentRect",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Rm.prototype,"_rootTileIds",null),(0,o._)([(0,x.Cb)({value:!1})],Rm.prototype,"suspended",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Rm.prototype,"updating",null),Rm=(0,o._)([(0,S.j)("esri.views.3d.layers.support.FeatureTileTree3D")],Rm);var Am=i(79860),Om=i(65001);let Dm=class extends E.Z{constructor(e){super(e),this._propertiesPool=new Xc.L({camera:Xo.Z},this),this._lastSeenCameraProjectionValues=new Xo.Z,this.mode=Yc.n.ANIMATING,this._cssCamera=new Xo.Z,this._camera=new Xo.Z,this.rasterPixelRatio=1,this.contentPixelRatio=1,this.constraints=new sr({state:this}),this.events=new ae.Z,this._cameraChanged=!1,this._updateQueue=new Array,this._processingUpdates=!1}reset(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new Xc.L({camera:Xo.Z},this)}destroy(){this.cameraController=null,this._propertiesPool?.destroy(),this._propertiesPool=null}createInitialCamera(){if(this.viewingMode===Si.JY.Global){const e=(0,vr.Iu)(this.spatialReference).radius;this.camera=new Xo.Z({eye:(0,O.al)(4*e,0,0),center:(0,O.al)(e,0,0),up:(0,O.al)(0,0,1)})}else this.camera=new Xo.Z({eye:(0,O.al)(0,0,100),center:(0,O.al)(0,0,0),up:(0,O.al)(0,1,0)})}get animation(){return this.cameraController instanceof $o&&null!=this.cameraController.viewAnimation?this.cameraController.viewAnimation:null}get cssCamera(){const e=this._cssCamera.copyFrom(this.camera),{height:t,width:i,pixelRatio:r}=this.camera;return e.pixelRatio=1,e.height=Math.round(t/r),e.width=Math.round(i/r),e}get camera(){return this._camera}set camera(e){e!==Lm&&Lm.copyFrom(e),Lm.computeUp(this.viewingMode),this.events.emit("before-camera-change",{camera:Lm});const t=this._camera;if(function(e,t){return e.fov!==t.fov||e.fullViewport[0]!==t.fullViewport[0]||e.fullViewport[1]!==t.fullViewport[1]||e.fullViewport[2]!==t.fullViewport[2]||e.fullViewport[3]!==t.fullViewport[3]||e.padding[Wc.Np.TOP]!==t.padding[Wc.Np.TOP]||e.padding[Wc.Np.RIGHT]!==t.padding[Wc.Np.RIGHT]||e.padding[Wc.Np.BOTTOM]!==t.padding[Wc.Np.BOTTOM]||e.padding[Wc.Np.LEFT]!==t.padding[Wc.Np.LEFT]}(this._lastSeenCameraProjectionValues,Lm)&&(this._lastSeenCameraProjectionValues.copyFrom(Lm),this.events.emit("camera-projection-changed",this._lastSeenCameraProjectionValues)),!t.equals(Lm)&&(this._camera=this._propertiesPool.get("camera").copyFrom(Lm),this._cameraChanged=!t.almostEquals(Lm),this._cameraChanged)){const e=(0,Am.Fs)((()=>{this._cameraChanged=!1,e.remove()}))}}get pixelRatio(){return this.camera.pixelRatio}get alignPixelEnabled(){return this.pixelRatio===this.rasterPixelRatio&&this.mode===Yc.n.IDLE}get updating(){return this.mode!==Yc.n.IDLE}get contentCamera(){return this._contentCamera??this.camera}set contentCamera(e){if(null==e)return void(this._contentCamera=null);const t=e.clone();this.events.emit("before-camera-change",{camera:t,sceneDepthRange:Om.P.infinite}),this._contentCamera=t}get fixedContentCamera(){return null!=this._contentCamera}get isGlobal(){return this.viewingMode===Si.JY.Global}get isLocal(){return this.viewingMode===Si.JY.Local}get viewingMode(){return(0,Si.wg)(this.view.viewingMode)}get spatialReference(){return this.view.spatialReference}get highlights(){const e=this.view.highlights.items.slice(0,si.Ke);for(let t=0;t<e.length;){const i=e[t],r=e.findIndex((e=>e.name===i.name));r>=0&&t>r?e.splice(t,1):++t}return e}get highlightOrderMap(){const e=new Map;return this.highlights.forEach(((t,i)=>e.set(t.name,i))),e}get navigating(){return!!this.cameraController?.isInteractive}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){this.stopActiveCameraController()?(this.cameraController?.destroy(),e&&(this.removeHandles(Fm),this.addHandles((0,n.gx)((()=>e.state===jo.Finished||e.state===jo.Stopped),(()=>{this._set("cameraController",null),this.updateCamera((t=>e.onControllerEnd(t)))}),{sync:!0,once:!0}),Fm),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=jo.Rejected)}switchCameraController(e){this.cameraController=e}stopActiveCameraController(){return!this.cameraController||this.cameraController.stopController()}updateCamera(e){this._updateQueue.push(e),this._processUpdateQueue()}_processUpdateQueue(){if(0===this._updateQueue.length||this._processingUpdates)return;this._processingUpdates=!0;const e=this._updateQueue.shift();Lm.copyFrom(this._get("camera")),e(Lm),this.camera=Lm,this._processingUpdates=!1,this._processUpdateQueue()}};(0,o._)([(0,x.Cb)({constructOnly:!0})],Dm.prototype,"view",void 0),(0,o._)([(0,x.Cb)()],Dm.prototype,"mode",void 0),(0,o._)([(0,x.Cb)({readOnly:!0,type:qi})],Dm.prototype,"animation",null),(0,o._)([(0,x.Cb)({type:Xo.Z})],Dm.prototype,"cssCamera",null),(0,o._)([(0,x.Cb)()],Dm.prototype,"_cssCamera",void 0),(0,o._)([(0,x.Cb)({type:Xo.Z})],Dm.prototype,"camera",null),(0,o._)([(0,x.Cb)()],Dm.prototype,"_camera",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Dm.prototype,"pixelRatio",null),(0,o._)([(0,x.Cb)()],Dm.prototype,"rasterPixelRatio",void 0),(0,o._)([(0,x.Cb)()],Dm.prototype,"contentPixelRatio",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Dm.prototype,"alignPixelEnabled",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Dm.prototype,"updating",null),(0,o._)([(0,x.Cb)({})],Dm.prototype,"_contentCamera",void 0),(0,o._)([(0,x.Cb)({type:Xo.Z})],Dm.prototype,"contentCamera",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Dm.prototype,"fixedContentCamera",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Dm.prototype,"events",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Dm.prototype,"isGlobal",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Dm.prototype,"isLocal",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Dm.prototype,"viewingMode",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Dm.prototype,"highlights",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Dm.prototype,"highlightOrderMap",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Dm.prototype,"navigating",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Dm.prototype,"stationary",null),(0,o._)([(0,x.Cb)()],Dm.prototype,"_cameraChanged",void 0),(0,o._)([(0,x.Cb)()],Dm.prototype,"cameraController",null),Dm=(0,o._)([(0,S.j)("esri.views.3d.state.ViewState")],Dm);const Im=Dm;const Lm=new Xo.Z,Fm="ViewStateHandles";var Nm=i(51870),Um=i(43759),Hm=i(61442),Vm=i(32033),km=i(19821);function Bm(e){return(t,i,r)=>!(0,cd.e)(e,(0,mr.m)(zm,t,i,r))}const zm=(0,O.Ue)();class Gm{constructor(e,t,i){this.viewingMode=e,this._forEachLayer=t,this._view=i,this._externalIntersectionHandlers=new ud.Z,this._tolerance=Yo.j,this._tmpRay=(0,Fn.Ue)(),this._tmpRegion=(0,V.Ue)(),this._validateHUDIntersector=new Yo.r(this.viewingMode),this._validateHUDIntersector.options.hud=!1}intersectScreen(e,t,i){return this.intersectRay(this._getPickRay(e,this._tmpRay),$m(this.viewingMode),t,i)}intersectScreenFreePointFallback(e,t,i){return this.intersectRayFreePointFallback(this._getPickRay(e,this._tmpRay),t,i)}intersectRayFreePointFallback(e,t,i){return this.intersectRay(e,$m(this.viewingMode),t,i)||this._intersectRayFreePointLocal(e,t)}intersectRay(e,t,i,r){return t.options.selectionMode=!1,t.options.store=Hm.e.MIN,this.computeIntersection(e,t,!1,r),!!t.results.min&&t.results.min.getIntersectionPoint(i)}getCenterRayWithSubpixelOffset(e,t,i=.5,r=.5){return e.getRenderCenter(Jm,i,r),Jm[0]+=.0466,Jm[1]-=.0123,(0,dl.eW)(e,Jm,t)}intersectIntersectorScreen(e,t,i){this.computeIntersection(this._getPickRay(e,this._tmpRay),t,!1,i)}intersectToolIntersectorScreen(e,t,i){const r=this._getPickRay(e,this._tmpRay);this.intersectToolIntersectorRay(r,t,i)}intersectToolIntersectorRay(e,t,i){t.options.selectionMode=!0,this.computeIntersection(e,t,!1,i);const r=t.results.min;this._view.basemapTerrain&&this._view.basemapTerrain.opaque||(0,Vm.n)(r)&&r.intersector!==km.q.TERRAIN||(t.options.selectionMode=!1,this.computeIntersection(e,t,!1,i))}setTolerance(e=Yo.j){this._tolerance=e}addIntersectionHandler(e){this._externalIntersectionHandlers.push(e),this._externalIntersectionHandlers.sort(((e,t)=>e.type===km.q.TERRAIN?1:t.type===km.q.TERRAIN?-1:0))}removeIntersectionHandler(e){null!=this._externalIntersectionHandlers.removeUnordered(e)&&this._externalIntersectionHandlers.sort(((e,t)=>e.type===km.q.TERRAIN?1:t.type===km.q.TERRAIN?-1:0))}_getPickRay(e,t){const i=this._view.state.camera;return(0,dl.u4)(i,e,t)}_intersectRayFreePointLocal(e,t){return this.viewingMode!==Si.JY.Local||null==e||(0,mr.f)(t,e.origin,(0,mr.n)(nl.WM.get(),e.direction)),!1}intersectElevationFromScreen(e,t,i=0,r=null){return this._intersectElevation(this._getPickRay(e,this._tmpRay),t,i,r)}_intersectElevation(e,t,i=0,r=null){if(null==e)return null;const s=this._view,{renderCoordsHelper:n}=s,a=(0,w._R)(s.spatialReference),o=null!=t?t.mode:"absolute-height",l=(0,Nm.fm)(t)/a,c=("on-the-ground"!==o?l+i:0)*a/n.unitInMeters,{camera:h}=s.state;if("absolute-height"===o){const t=n?.getAltitude(h.eye),i=(0,mr.e)((0,mr.n)(Qm,e.direction),n.worldUpAtPosition(h.eye,Km));if(t<c&&i<0||t>=c&&i>0)return null;if(n.intersectInfiniteManifold(e,c,Qm)){const e=(0,Um.K0)(s,Qm);return e.z??=0,e.z-=l,e}return null}const u=(0,b.Wv)(nl.WM.get());h.projectToRenderScreen(e.origin,u);const d=new Xm(null,this._forEachLayer),{slice:{plane:p}}=s,m=null!=p?Bm(p):null,_=new Yo.r(this.viewingMode);_.options.store=Hm.e.MIN,_.options.verticalOffset=c,_.options.normalRequired=!1;const f=e.origin,g=(0,mr.f)(nl.WM.get(),f,e.direction);_.reset(f,g,h),_.point=u;let y=null;if(r&&"type"in r&&"graphics"===r.type){const e=s.allLayerViews.find((e=>e.layer===r))?.uid;y=e?t=>t.layerViewUid===e:null}else r&&(y=e=>e.graphicUid!==r.uid);switch(o){case"relative-to-scene":{const e=e=>(!y||y(e))&&!!e.lastValidElevationBB;_.intersect(d.layers,u,this._tolerance,null,e),this._externalIntersectionHandlers.forAll((e=>{if(e.type===km.q.I3S||e.type===km.q.TERRAIN||e.type===km.q.TILES3D){const t=e.slicePlaneEnabled?m:null;e.intersect(_,t,_.rayBegin,_.rayEnd,u,!1)}}));break}case"on-the-ground":case"relative-to-ground":this._externalIntersectionHandlers.forAll((e=>{if(e.isGround){const t=e.slicePlaneEnabled?m:null;e.intersect(_,t,_.rayBegin,_.rayEnd,u,!1)}}))}if(_.results.min.getIntersectionPoint(Qm)){const e=(0,Um.K0)(s,Qm);return e.z=i,e}return null}computeIntersection(e,t,i,r){if(null==e)return;const s=this._view.state.camera,n=(0,b.Wv)(nl.WM.get());s.projectToRenderScreen(e.origin,n);const a=new Xm(r,this._forEachLayer);t.options.selectOpaqueTerrainOnly=!r||!("include"in r||"exclude"in r);const o=e.origin,l=(0,mr.f)(nl.WM.get(),e.origin,e.direction);t.reset(o,l,s),t.intersect(a.layers,n,this._tolerance);const c=this._view.slice.plane,h=null!=c?Bm(c):null;t.intersect(a.sliceableLayers,n,this._tolerance,h);const u=r&&(r.requiresGroundFeedback||r.enableDraped);this._externalIntersectionHandlers.forAll((e=>{const r=e.layerViewUid,s=Array.isArray(r),c=s?r:[r];s&&(t.options.filteredLayerViewUids=[]);let d=!1;for(const e of c)a.filterLayerViewUid(e)?d=!0:s&&t.options.filteredLayerViewUids.push(e);if(t.options.isFiltered=!d,e.isGround&&u||!t.options.isFiltered){const r=e.slicePlaneEnabled?h:null;e.intersect(t,r,o,l,n,i)}}));const d=nl.WM.get(),p=this._view.basemapTerrain;if(r&&r.enableDraped&&null!=p.spatialReference&&t.results.ground.getIntersectionPoint(d)){const e=p.overlayManager.renderer,i=this._view.renderCoordsHelper.spatialReference,r=nl.WM.get();this._view.renderCoordsHelper.fromRenderCoords(d,r,p.spatialReference),r[2]=this._view.elevationProvider?.getElevation(d[0],d[1],d[2],i,"ground")??0,e.intersect(t,r,t.results.ground,(e=>a.filterRenderGeometry(e)))}t.sortResults(),this._processHUDResults(t)}_processHUDResults(e){const t=e.results.hud;(0,V.JG)(this._tmpRegion,V.G_);const i=this._view.state.camera,r=[],s=this._tmpRegion,n=e=>{const t=new jm(e),n=t.result.target.object.geometries.every((e=>e.material instanceof Nd.A&&e.material.parameters.occlusionTest));r.push({item:t,occlusionTest:n}),n&&(i.projectToRenderScreen(e.target.center,t.screenPoint),t.screenPoint[0]=Math.floor(t.screenPoint[0]),t.screenPoint[1]=Math.floor(t.screenPoint[1]),(0,V.Ho)(s,t.screenPoint))};e.sortResults(t.all),null!=t.min.distance&&n(t.min);for(const e of t.all)t.min.target.object!==e.target.object&&t.max.target.object!==e.target.object&&n(e);if(null!=t.max.distance&&t.max.target.object!==t.min.target.object&&n(t.max),!r.length)return;s[0]===s[2]&&(s[2]+=1),s[1]===s[3]&&(s[3]+=1);const a=i.fullWidth,o=i.fullHeight,l=Math.max(0,s[0]-qm),c=Math.max(0,s[1]-qm),h=Math.min((0,V.d_)(s)+2*qm,a-l),u=Math.min((0,V.Cb)(s)+2*qm,o-c),d=h>0&&u>0?new Uint8Array(h*u*4):null;d&&this._view.stage.renderer.readHUDVisibility(l,c,h,u,d);let p=!0;const m=null==e.results.max.distance;let _=0;for(const{item:t,occlusionTest:i}of r){let r=!i;if(i&&d)for(const e of Zm){const i=4*(Math.min(t.screenPoint[0]+e[0],a)-s[0]+(Math.min(t.screenPoint[1]+e[1],o)-s[1])*h);if(i>=0&&i<d.length&&d[i]){r=!0;break}}r&&(p&&(e.results.min.copy(t.result),p=!1),m&&e.results.max.copy(t.result),e.options.store===Hm.e.ALL&&e.results.all.splice(_++,0,t.result))}}}const qm=1,Zm=(()=>{const e=[],t=qm;for(let i=-1;i<=t;i++)for(let r=-1;r<=t;r++)e.push([r+t,i+t]);return e})();class jm{constructor(e){this.result=e,this.screenPoint=(0,b.J$)()}}let Wm;function $m(e){return Wm&&Wm.viewingMode===e||(Wm=new Yo.r(e)),Wm}class Xm{constructor(e,t){this.layers=new Array,this.sliceableLayers=new Array,this.include=e?.include,this.exclude=e?.exclude,t((e=>{e.pickable&&this.filterLayerViewUid(e.apiLayerViewUid)&&(e.sliceable?this.sliceableLayers:this.layers).push(e)}))}filterLayerViewUid(e){const{include:t,exclude:i}=this;return null==e?null==t&&null==i:(null==t||t.has(e))&&(null==i||!i.has(e))}filterRenderGeometry(e){return this.filterLayerViewUid(e.layerViewUid)}}function Ym(e){return"object"==typeof e&&"intersect"in e}const Qm=(0,O.Ue)(),Km=(0,O.Ue)(),Jm=(0,b.J$)();var e_=i(95964),t_=i(71298);let i_=class extends(ae.Z.EventedMixin(E.Z)){get spatialReference(){return this.view?.basemapTerrain?.spatialReference}constructor(e){super(e),this._im=new Array,this._ground=new Array,this._scene=new Array,this.lastElevationQuery=null,this._cacheEnabled=!1}destroy(){this._cachedQuery=(0,f.SC)(this._cachedQuery)}enableCache(e){e||(this.lastElevationQuery=null),this._cacheEnabled=e}getElevation(e,t,i,r,s){if(this._cacheEnabled&&null!=this.lastElevationQuery){const n=this.lastElevationQuery;if(e===n.x&&t===n.y&&i===n.z&&(0,ft.fS)(r,n.spatialReference)&&s===n.queryContext)return n.result}let n=null;return n=r_(n,this._im,e,t,i,r,s),null==n&&(n=r_(n,this._ground,e,t,i,r,s)),"scene"===s&&(n=r_(n,this._scene,e,t,i,r,s)),this._cacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:i,spatialReference:r,queryContext:s,result:n}),n}getSphereElevationBounds(e,t,i){const r=new t_.r;function s(s){for(const n of s)if(n.getSphereElevationBounds){const s=n.getSphereElevationBounds(e,t,i);null!=s&&r.expandElevationRangeValues(s.elevationRangeMin,s.elevationRangeMax)}}return s(this._ground),s(this._im),"scene"===i&&s(this._scene),r}getRootElevationBounds(){const e=new t_.r;for(const t of[this._im,this._ground,this._scene])t.forEach((t=>{if(t.getRootElevationBounds){const i=t.getRootElevationBounds();null!=i&&e.expandElevationRangeValues(i.elevationRangeMin,i.elevationRangeMax)}}));return e}async queryElevation(e,t,i,r,s,n=null,a=0){const o=this._getElevationQuery(r);try{const l=await o.queryElevation(e,t,n,a);return"scene"===s?r_(l,this._scene,e,t,i,r,s):l}catch(n){return(0,y.r9)(n),this.getElevation(e,t,i,r,s)}}register(e,t){this.addHandles(t.on("elevation-change",(e=>this.emit("elevation-change",e))),t),this._providersFromContext(e).push(t)}unregister(e){this.removeHandles(e);for(const t of[this._im,this._ground,this._scene]){const i=t.indexOf(e);i>-1&&t.splice(i,1)}}_providersFromContext(e){switch(e){case"ground":return this._ground;case"im":return this._im;case"scene":return this._scene}}_getElevationQuery(e=this.view.spatialReference){const t=this._cachedQuery;if(null!=t&&(0,ft.fS)(e,t.spatialReference))return t;t?.destroy({completeTasks:!0});const{wkid:i,wkt:r,wkt2:s,latestWkid:n}=e,a=new e_.K(this.view.resourceController.scheduler,new N.Z({wkid:i,wkt:r,wkt2:s,latestWkid:n}),(()=>this.view.map?.ground),{maximumAutoTileRequests:4});return this._cachedQuery=a,a}};function r_(e,t,i,r,s,n,a){for(const o of t){const t=o.getElevation(i,r,s,n,a);null!=t&&(e=null!=e?Math.max(t,e):t)}return e}(0,o._)([(0,x.Cb)({constructOnly:!0})],i_.prototype,"view",void 0),(0,o._)([(0,x.Cb)()],i_.prototype,"spatialReference",null),i_=(0,o._)([(0,S.j)("esri.views.3d.support.CombinedElevationProvider")],i_);class s_{static isValidProfile(e){return e in s_.profiles}static getDefaultProfile(){return(0,m.Z)("esri-iPhone")?"low":"medium"}static apply(e,t){const i=s_.profiles[e];t.graphics3D.maxTotalNumberOfFeatures=i.graphics3D.maxTotalNumberOfFeatures,t.graphics3D.maxNumberOfDrawCalls=i.graphics3D.maxNumberOfDrawCalls,t.graphics3D.maxTotalNumberOfVertices=i.graphics3D.maxTotalNumberOfVertices,t.graphics3D.polygonLodFactor=i.graphics3D.polygonLodFactor,t.graphics3D.polylineLodFactor=i.graphics3D.polylineLodFactor,t.graphics3D.snapshotAvailable=i.graphics3D.snapshotAvailable,t.graphics3D.skipHighSymbolLods=i.graphics3D.skipHighSymbolLods;const r=t.sceneService.object,s=i.sceneService.object;r.lodFactor=s.lodFactor,t.sceneService.point.lodFactor=i.sceneService.point.lodFactor,t.sceneService.integratedMesh.lodFactor=i.sceneService.integratedMesh.lodFactor,t.sceneService.pointCloud.lodFactor=i.sceneService.pointCloud.lodFactor,t.tiledSurface.lodBias=i.tiledSurface.lodBias,t.tiledSurface.angledSplitBias=i.tiledSurface.angledSplitBias,t.tiledSurface.vtlContentZoom=i.tiledSurface.vtlContentZoom,t.tiledSurface.elevationLevelDelta=i.tiledSurface.elevationLevelDelta,t.tiledSurface.reduceTileLevelDifferences=i.tiledSurface.reduceTileLevelDifferences,t.heatmap.pixelRatio=i.heatmap.pixelRatio,t.heatmap.maxTotalNumberOfFeatures=i.heatmap.maxTotalNumberOfFeatures,t.fadeDuration=i.fadeDuration,t.antialiasingEnabled=i.antialiasingEnabled,t.physicallyBasedRenderingEnabled=i.physicalBasedRenderingEnabled,t.highQualityTransparency=i.highQualityTransparency,t.highResolutionAtmosphere=i.highResolutionAtmosphere,t.reflections=i.reflections,t.ambientOcclusion=i.ambientOcclusion,t.maxTexturePixels=i.maxTexturePixels,t.memoryLimit=i.memoryLimit,t.additionalCacheMemory=i.additionalCacheMemory,t.frameRate=i.frameRate,t.maximumPixelRatio=i.maximumPixelRatio}static{this.test={reset(){const e=h_();for(const t of Object.keys(e))s_.profiles[t]=e[t]}}}}const n_=120,a_=200,o_=240,l_=300,c_=430;function h_(){const e=!!(0,m.Z)("esri-mobile"),t=!!(0,m.Z)("ios"),i=(0,Yr.HA)(400);return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxNumberOfDrawCalls:8e3,maxTotalNumberOfVertices:255e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1,skipHighSymbolLods:!0},heatmap:{pixelRatio:.125,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:.2},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5}},tiledSurface:{lodBias:-1,angledSplitBias:.5,vtlContentZoom:.75,elevationLevelDelta:3,reduceTileLevelDifferences:!0},fadeDuration:(0,Yr.HA)(0),antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,maxTexturePixels:e?1048576:4194304,memoryLimit:200+n_,additionalCacheMemory:0,frameRate:0,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:625e4,polygonLodFactor:e?.8:1,polylineLodFactor:e?1.2:1.5,snapshotAvailable:!t,skipHighSymbolLods:!1},heatmap:{pixelRatio:.25,maxTotalNumberOfFeatures:13e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1}},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,elevationLevelDelta:3,reduceTileLevelDifferences:!(0,m.Z)("disable-feature:reduce-map-tile-levels")},fadeDuration:i,antialiasingEnabled:!1,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,maxTexturePixels:e?4194304:4096**2,memoryLimit:e?600+a_:750+o_,additionalCacheMemory:e?-100:150,frameRate:0,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:125e5,polygonLodFactor:e?1.2:2,polylineLodFactor:e?1.2:2,snapshotAvailable:!t,skipHighSymbolLods:!1},heatmap:{pixelRatio:.5,maxTotalNumberOfFeatures:23e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1}},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,elevationLevelDelta:2,reduceTileLevelDifferences:!(0,m.Z)("disable-feature:reduce-map-tile-levels")},fadeDuration:i,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!0,reflections:!0,ambientOcclusion:!0,maxTexturePixels:e?4096**2:1/0,memoryLimit:e?900+l_:1500+c_,additionalCacheMemory:e?-150:0,frameRate:0,maximumPixelRatio:e?1:1/0}}}!function(e){e.profiles=h_()}(s_||(s_={}));const u_=s_;var d_,p_=i(90494);!function(e){e[e.ELEVATION=0]="ELEVATION",e[e.MAP=1]="MAP"}(d_||(d_={}));const m_=[d_.ELEVATION,d_.MAP];var __=i(22455);async function f_(e,t){const{results:i,ground:r}=await(0,__.ZV)(e,t),s=(!r.layer||!(0,z.nx)(r.layer.type))&&r.mapPoint,n=[],a=function(e){const t=new Map;for(const i of e.allLayerViews){const e=i.layer.uid;t.set(e,i)}return t}(e),o=s?function(e,t){const i=new Set,r=new Set;for(let t=e.basemapTerrain.numLayers(d_.MAP)-1;t>=0;t--){const s=e.basemapTerrain.layerViewByIndex(t,d_.MAP);i.add(s.layer.uid),r.add(s)}const s=e.basemapTerrain.overlayManager.renderer.layers;for(const{uid:e}of s){const s=t.get(e);s&&(i.add(e),r.add(s))}return{layerUids:i,layerViews:Array.from(r).reverse()}}(e,a):g_;let l=0,c=0;const h=()=>{const e=o.layerViews[c];s&&e&&"fetchPopupFeaturesAtLocation"in e&&n.push({mapPoint:r.mapPoint,layerView:e}),++c};let u=null;for(;l<i.length||c<o.layerViews.length;){const t=i[l];if(t&&"graphic"!==t.type)++l;else if("scene"!==t?.layer?.type||t?.layer?.parent!==e?.map?.basemap)if(t){const e=t.layer?.uid,i=o.layerUids.has(e)&&t.distance===r.distance,s=a.get(t.layer?.uid);if(u??=t.mapPoint,c<o.layerViews.length&&(i||(t.distance??0)>r.distance)&&o.layerViews[c]!==s){h();continue}n.push({graphic:t.graphic,layerView:s}),++l}else h();else++l}return u??=r.mapPoint,{hits:n,location:u}}const g_={layerUids:new Set,layerViews:[]};let y_=class extends E.Z{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxNumberOfDrawCalls=17e3,this.maxTotalNumberOfVertices=17e5,this.snapshotAvailable=!0,this.polygonLodFactor=1,this.polylineLodFactor=1,this.skipHighSymbolLods=!1}};(0,o._)([(0,x.Cb)()],y_.prototype,"minTotalNumberOfFeatures",void 0),(0,o._)([(0,x.Cb)()],y_.prototype,"maxTotalNumberOfFeatures",void 0),(0,o._)([(0,x.Cb)()],y_.prototype,"maxNumberOfDrawCalls",void 0),(0,o._)([(0,x.Cb)()],y_.prototype,"maxTotalNumberOfVertices",void 0),(0,o._)([(0,x.Cb)()],y_.prototype,"snapshotAvailable",void 0),(0,o._)([(0,x.Cb)()],y_.prototype,"polygonLodFactor",void 0),(0,o._)([(0,x.Cb)()],y_.prototype,"polylineLodFactor",void 0),(0,o._)([(0,x.Cb)()],y_.prototype,"skipHighSymbolLods",void 0),y_=(0,o._)([(0,S.j)("esri.views.3d.support.QualitySettings.Graphics3DSettings")],y_);let v_=class extends E.Z{constructor(){super(...arguments),this.lodFactor=1}};(0,o._)([(0,x.Cb)()],v_.prototype,"lodFactor",void 0),v_=(0,o._)([(0,S.j)("esri.views.3d.support.QualitySettings.LoDFactorSettings")],v_);let b_=class extends E.Z{constructor(){super(...arguments),this.object=new v_,this.point=new v_,this.integratedMesh=new v_,this.pointCloud=new v_}};(0,o._)([(0,x.Cb)({type:v_})],b_.prototype,"object",void 0),(0,o._)([(0,x.Cb)({type:v_})],b_.prototype,"point",void 0),(0,o._)([(0,x.Cb)({type:v_})],b_.prototype,"integratedMesh",void 0),(0,o._)([(0,x.Cb)({type:v_})],b_.prototype,"pointCloud",void 0),b_=(0,o._)([(0,S.j)("esri.views.3d.support.QualitySettings.SceneServiceSettings")],b_);let w_=class extends E.Z{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.vtlContentZoom=1,this.elevationLevelDelta=3,this.reduceTileLevelDifferences=!0}};(0,o._)([(0,x.Cb)()],w_.prototype,"lodBias",void 0),(0,o._)([(0,x.Cb)()],w_.prototype,"angledSplitBias",void 0),(0,o._)([(0,x.Cb)()],w_.prototype,"vtlContentZoom",void 0),(0,o._)([(0,x.Cb)()],w_.prototype,"elevationLevelDelta",void 0),(0,o._)([(0,x.Cb)()],w_.prototype,"reduceTileLevelDifferences",void 0),w_=(0,o._)([(0,S.j)("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],w_);let C_=class extends E.Z{constructor(){super(...arguments),this.pixelRatio=1,this.maxTotalNumberOfFeatures=5e4}};(0,o._)([(0,x.Cb)()],C_.prototype,"pixelRatio",void 0),(0,o._)([(0,x.Cb)()],C_.prototype,"maxTotalNumberOfFeatures",void 0),C_=(0,o._)([(0,S.j)("esri.views.3d.support.QualitySettings.HeatmapSettings")],C_);let x_=class extends E.Z{constructor(){super(...arguments),this.graphics3D=new y_,this.sceneService=new b_,this.tiledSurface=new w_,this.heatmap=new C_,this.fadeDuration=(0,Yr.HA)(400),this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0,this.highResolutionAtmosphere=!1,this.reflections=!1,this.ambientOcclusion=!1,this.bloom=!1,this.maxTexturePixels=1/0,this.memoryLimit=750,this.additionalCacheMemory=0,this.frameRate=void 0,this.maximumPixelRatio=1/0}};(0,o._)([(0,x.Cb)({type:y_})],x_.prototype,"graphics3D",void 0),(0,o._)([(0,x.Cb)({type:b_})],x_.prototype,"sceneService",void 0),(0,o._)([(0,x.Cb)({type:w_})],x_.prototype,"tiledSurface",void 0),(0,o._)([(0,x.Cb)({type:C_})],x_.prototype,"heatmap",void 0),(0,o._)([(0,x.Cb)()],x_.prototype,"fadeDuration",void 0),(0,o._)([(0,x.Cb)()],x_.prototype,"antialiasingEnabled",void 0),(0,o._)([(0,x.Cb)()],x_.prototype,"physicallyBasedRenderingEnabled",void 0),(0,o._)([(0,x.Cb)()],x_.prototype,"highQualityTransparency",void 0),(0,o._)([(0,x.Cb)()],x_.prototype,"highResolutionAtmosphere",void 0),(0,o._)([(0,x.Cb)()],x_.prototype,"reflections",void 0),(0,o._)([(0,x.Cb)()],x_.prototype,"ambientOcclusion",void 0),(0,o._)([(0,x.Cb)()],x_.prototype,"bloom",void 0),(0,o._)([(0,x.Cb)()],x_.prototype,"maxTexturePixels",void 0),(0,o._)([(0,x.Cb)()],x_.prototype,"memoryLimit",void 0),(0,o._)([(0,x.Cb)()],x_.prototype,"additionalCacheMemory",void 0),(0,o._)([(0,x.Cb)()],x_.prototype,"frameRate",void 0),(0,o._)([(0,x.Cb)()],x_.prototype,"maximumPixelRatio",void 0),x_=(0,o._)([(0,S.j)("esri.views.3d.support.QualitySettings")],x_);const T_=x_;var S_=i(32243),M_=i(88270),E_=i(48621),R_=i(61719);class P_{constructor(e){this.client=e,this._cancelled=!1,this.size=0,this.duration=0}}class A_{constructor(e){this.typeWorkerQuota=e,this.tasks=new Array,this.numWorkers=0,this.statistics=new O_}}class O_{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}}class D_{constructor(e,t,i,r){this._workerFunc=e,this._callbackFunc=t,this._maxTotalNumWorkers=i,this._totalNumWorkers=0,this._clients=r.map((e=>new A_(e)))}destroy(){this._clients.length=0}hasQuota(e){const t=this._clients[e];return!!t&&(this._totalNumWorkers<this._maxTotalNumWorkers||t.numWorkers+t.tasks.length<t.typeWorkerQuota)}push(e){const t=this._clients[e.client];t&&(this._totalNumWorkers<this._maxTotalNumWorkers?(t.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,((e,t)=>this._taskCallback(e,t)))):t.tasks.push(e))}cancel(e){this._taskFinished(e),e._cancelled=!0}_taskFinished(e){const t=this._clients[e.client];this._totalNumWorkers--,t&&(t.numWorkers--,t.statistics.requests++,t.statistics.size+=e.size||0,t.statistics.duration+=e.duration||0,t.statistics.speed=t.statistics.duration>0?t.statistics.size/t.statistics.duration:0,(0,R_.hu)(t.numWorkers>=0)),this._next()}_next(){for(const e of this._clients)if(e&&e.numWorkers<e.typeWorkerQuota&&this._processQueue(e))return;for(const e of this._clients)if(e&&this._processQueue(e))return}_processQueue(e){for(;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),((e,t)=>this._taskCallback(e,t))))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(e,t){e._cancelled||(this._callbackFunc(e,t),this._taskFinished(e))}getStatsForType(e){const t=this._clients[e];return t?{quota:t.typeWorkerQuota,workers:t.numWorkers,queueSize:t.tasks.length,requestStats:t.statistics}:null}get test(){}}class I_{constructor(e,t){this.element=e,this.type="image+type",this.isOpaque="image/jpeg"===t}}var L_=i(74796);let F_=class extends E.Z{constructor(){super(...arguments),this._tasks=new Map,this._onLoadQueue=new Array,this._doneQueue=new Array,this.updating=!1}setup(e,t,i){this._loadQueue=new D_(((e,t)=>this._startLoading(e,t)),((e,t)=>this._doneLoadingCB(e,t)),e,t),i&&(this._frameTask=i.registerTask(Gr.T8.STREAM_DATA_LOADER,this))}destroy(){this._frameTask=(0,f.hw)(this._frameTask),this._tasks.forEach((e=>(0,f.IM)(e.abortController))),this._loadQueue=(0,f.SC)(this._loadQueue),this._onLoadQueue=null,this._doneQueue=null,this._tasks=null}hasDownloadSlots(e){return this._loadQueue.hasQuota(e)}request(e,t,i,r={}){const s=(0,y.hh)();s.__signal=null!=r?r.signal:null;const n=this._createOrUpdateTask(e,t,i,r,s);return(0,y.fu)(r,(()=>this._cancelRequest(n,s))),s.promise}_createTask(e,t,i,r,s,n){const a=new U_(e,t,i,r,s);return this._updateTask(a,n),this._tasks.set(s,a),1===this._tasks.size&&this._set("updating",!0),this._loadQueue.push(a),a}_cancelRequest(e,t){(0,St.e$)(e.resolvers,t),t.reject((0,y.zE)()),0===e.resolvers.length&&(e.status===H_.DOWNLOADING&&(e.status=H_.CANCELLED,this._loadQueue.cancel(e),e.abortController?.abort(),e.request=null,e.abortController=null),e.status=H_.CANCELLED,this._tasks.delete(e.key),0===this._tasks.size&&this._set("updating",!1))}_updateTask(e,t){e.resolvers.push(t)}_createOrUpdateTask(e,t,i,r,s){const n=function(e,t,i){return`${e}:${t}:${i}`}(r?.uid||e,t,i),a=this._tasks.get(n);return a?(this._updateTask(a,s),a):this._createTask(e,r,t,i,n,s)}_doneLoadingCB(e,t){this._loadQueue&&((0,R_.hu)(e.status===H_.DOWNLOADING),e.status=H_.DOWNLOADED,this._frameTask?this._doneQueue.push({task:e,err:t}):this._doneLoading(e,t))}get running(){return this._doneQueue.length>0||this._onLoadQueue.length>0}runTask(e){for(;!e.done&&this._onLoadQueue.length>0;){const t=this._onLoadQueue.shift();(0,y.k_)(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this._doneQueue.length>0;){const t=this._doneQueue.shift();t.task.status!==H_.DOWNLOADED&&(t.err=t.err||(0,y.zE)()),this._doneLoading(t.task,t.err),e.madeProgress()}}_doneLoading(e,t){if(t&&!(0,y.D_)(t)&&e.numRetries>0)return--e.numRetries,void this._loadQueue.push(e);let i=(0,L_.Cm)(e.result)||e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const r of e.resolvers)if(t)(0,y.D_)(t)?r.reject(t):r.reject(new u.Z("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${t}`,{url:e.url,error:t}));else{--i;const t=i>0?(0,Ee.d9)(e.result):e.result;r.resolve(t)}this._tasks.delete(e.key),0===this._tasks.size&&this._set("updating",!1)}_startLoading(e,t){if(e.status===H_.CANCELLED)return!1;let i,r;switch(e.startTime=performance.now(),e.status=H_.DOWNLOADING,e.docType){case"binary":r="array-buffer",i=0;break;case"image":r="image";break;case"image+type":r="array-buffer";break;default:r="json"}e.abortController=new AbortController;const s=e.abortController.signal;e.request=(0,ze.Z)(e.url,{...e.options,responseType:r,timeout:i,signal:s});const n=i=>{e.duration=performance.now()-e.startTime,e.size=i instanceof ArrayBuffer?i.byteLength:e.size||0,e.result=i,this._frameTask?this._onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},a=i=>{e.status===H_.DOWNLOADING&&t(e,i)};return"image+type"!==e.docType?(e.request.then((e=>n(e.data)),a),!0):(e.request.then((t=>{const o=t.data,l=function(e){if(e.byteLength<2)return"unknown";const t=new Uint8Array(e,0,e.byteLength);return 137===t[0]&&80===t[1]?"image/png":71===t[0]&&73===t[1]?"image/gif":66===t[0]&&77===t[1]?"image/bmp":255===t[0]&&216===t[1]?"image/jpeg":"unknown"}(o);if(r="image",e.size=o.byteLength,"unknown"===l)return e.request=(0,ze.Z)(e.url,{responseType:r,timeout:i,signal:s}),void e.request.then((e=>n(e.data)),a);const c=new Blob([o],{type:l}),h=window.URL.createObjectURL(c);e.request=(0,ze.Z)(h,{responseType:r,timeout:i,signal:s}),e.request.then((e=>n(new I_(e.data,l))),a).finally((()=>window.URL.revokeObjectURL(h)))}),a),!0)}get test(){}};(0,o._)([(0,x.Cb)({readOnly:!0})],F_.prototype,"updating",void 0),F_=(0,o._)([(0,S.j)("esri.views.3d.support.StreamDataLoader")],F_);const N_=0;class U_ extends P_{constructor(e,t,i,r,s){super(r),this.url=e,this.options=t,this.docType=i,this.key=s,this.result=null,this.status=H_.QUEUED,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0,this.numRetries=N_}}var H_;!function(e){e[e.QUEUED=1]="QUEUED",e[e.DOWNLOADING=2]="DOWNLOADING",e[e.DOWNLOADED=3]="DOWNLOADED",e[e.CANCELLED=4]="CANCELLED"}(H_||(H_={}));let V_=class extends E.Z{constructor(){super(...arguments),this.updating=!1}};(0,o._)([(0,x.Cb)({readOnly:!0})],V_.prototype,"updating",void 0),V_=(0,o._)([(0,S.j)("esri.views.3d.support.ResourceController.ResourceControllerMain")],V_);let k_=class extends V_{constructor(){super(...arguments),this._immediateTask=Gr.sq,this._normalTask=Gr.sq,this._updatingObjects=(0,yr.t)([]),this._frameTask=null}get immediate(){return this._immediateTask}get normal(){return this._normalTask}initialize(){this._scheduler=(0,Gr.z4)(),this._memoryController=(0,E_.c)(this.view),this._streamDataLoader=new F_,this._streamDataLoader.setup(M_.NT,M_.Ty,this._scheduler),this.addHandles([(0,n.YP)((()=>this.view.state?.mode),(e=>{null!=e&&(this._scheduler.state=e)}),n.Z_),(0,n.YP)((()=>this.view.stationary),(()=>this._stationaryChangedHandler()))]),this._frameTask=(0,v.A)({update:e=>this._frame(e)}),this._immediateTask=this._scheduler.registerTask(Gr.T8.RESOURCE_CONTROLLER_IMMEDIATE),this._normalTask=this._scheduler.registerTask(Gr.T8.RESOURCE_CONTROLLER)}destroy(){this._immediateTask.remove(),this._normalTask.remove(),this._frameTask=(0,f.hw)(this._frameTask),this._streamDataLoader=(0,f.SC)(this._streamDataLoader),this._memoryController=(0,f.SC)(this._memoryController),this._scheduler=(0,f.SC)(this._scheduler),this.view=null}get updating(){return!!(this._memoryController?.updating||this._streamDataLoader?.updating||this._immediateTask?.updating)||this._updatingObjects?.value.some((e=>e.updating))}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}createStreamDataRequester(e){const t=this._streamDataLoader;return{request:(i,r,s)=>t.request(i,r,e,s),get busy(){return!t.hasDownloadSlots(e)}}}addUpdatingObject(e){const t=this._updatingObjects;return t.value=[...t.value,e],(0,p.kB)((()=>{t.value=t.value.filter((t=>t!==e))}))}_frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step((0,Yr.D9)(e.deltaTime)),!this._scheduler)||(this._memoryController.update(),this._scheduler.frame(e))}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}get test(){}};(0,o._)([(0,x.Cb)()],k_.prototype,"view",void 0),(0,o._)([(0,x.Cb)()],k_.prototype,"_scheduler",void 0),(0,o._)([(0,x.Cb)()],k_.prototype,"_memoryController",void 0),(0,o._)([(0,x.Cb)()],k_.prototype,"_streamDataLoader",void 0),(0,o._)([(0,x.Cb)()],k_.prototype,"_immediateTask",void 0),(0,o._)([(0,x.Cb)()],k_.prototype,"_normalTask",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],k_.prototype,"updating",null),k_=(0,o._)([(0,S.j)("esri.views.3d.support.ResourceController")],k_);var B_=i(46965),z_=i(15165);class G_{constructor(e){this.layer=null,this.memory=0,this.displayedNumberOfFeatures=0,this.maximumNumberOfFeatures=null,this.totalNumberOfFeatures=null,this.layer=e.layer;const t=e.performanceInfo;this.memory=t.usedMemory,this.displayedNumberOfFeatures=t.displayedFeatures,this.maximumNumberOfFeatures=t.maximumFeatures,this.totalNumberOfFeatures=t.totalFeatures}}class q_{constructor(e){if(this.totalMemory=0,this.usedMemory=0,this.quality=1,this.load=0,this.terrainMemory=0,this.edgesMemory=0,this.layerPerformanceInfos=new Array,this.cachedMemory=0,this.fboMemory=0,null!=e.resourceController){const t=e.resourceController.memoryController;this.totalMemory=(t.maxMemory??0)*B_.Y.MEGABYTES,this.usedMemory=Math.round(t.usedMemory*this.totalMemory),this.quality=e.quality,this.load=e.resourceController.scheduler.load,this.cachedMemory=t.usedCacheMemory}this.terrainMemory=e.basemapTerrain?.usedMemory??0,this.edgesMemory=e.stage?.renderer.usedMemory.edges??0,this.fboMemory=e.stage?.renderer.usedMemory.fbos??0,e.allLayerViews?.items.forEach((e=>{(0,z_.l)(e)&&this.layerPerformanceInfos.push(new G_(e))})),this.layerPerformanceInfos.sort(((e,t)=>t.memory-e.memory))}}var Z_=i(95631),j_=i(58744);class W_{constructor(e){this._gltfLoading=new Map,this._wosrLoading=new Map,this._gltfMemCache=e("gltf-resources",(()=>{})),this._wosrMemCache=e("wosr-resources",(()=>{}))}destroy(){this._gltfLoading.forEach((e=>e.abortController.abort())),this._wosrLoading.forEach((e=>e.abortController.abort())),this._gltfMemCache.destroy(),this._wosrMemCache.destroy()}loadGLTF(e,t,r){const s=r?`gltfPBR:${e}`:`gltf:${e}`,n=this._gltfMemCache.get(s);return null!=n?Promise.resolve(n):$_(this._gltfLoading,this._gltfMemCache,s,(async t=>{const{loadGLTF:s}=await Promise.all([i.e(50022),i.e(917)]).then(i.bind(i,50022));return s(new Z_.C(t.streamDataRequester),e,t,r)}),t)}loadWOSR(e,t){const i=`wosr:${e}:${t.disableTextures}`,r=this._wosrMemCache.get(i);return null!=r?Promise.resolve(r):$_(this._wosrLoading,this._wosrMemCache,i,(t=>(0,j_.zD)(e,t)),t)}}async function $_(e,t,i,r,s){(0,y.k_)(s);const n=(0,y.fu)(s,(()=>function(e,t){const i=e.get(t);if(null!=i&&--i.refCount>0)return;e.delete(t),null!=i&&i.abortController.abort()}(e,i)));let a=e.get(i);if(a)a.refCount++;else{const t=new AbortController;a={refCount:1,abortController:t,promise:r({...s,signal:t.signal})},e.set(i,a)}try{const r=await a.promise;return t.put(i,r),e.delete(i),(0,y.k_)(s),r}finally{(0,f.hw)(n)}}var X_=i(95490);let Y_=class extends E.Z{constructor(e,t){super({}),this._stage=e,this._textureRequests=new Map,this._frameTask=t?.registerTask(Gr.T8.TEXTURE_UNLOAD)??Gr.sq}normalizeCtorArgs(){return{}}destroy(){super.destroy(),this._frameTask?.remove(),this._textureRequests?.forEach((e=>this._releaseTextureRequest(e))),this._textureRequests?.clear()}get updating(){return this._frameTask.updating}fromData(e,t){const i=this.makeUid(e);let r=this._textureRequests.get(i);if(!r){const e=new K_;e.texture=t(),this._stage&&(e.texture.load(this._stage.renderView.renderingContext),this._stage.addTexture(e.texture)),this._textureRequests.set(i,e),r=e}return r.referenceCount++,new Q_(i,r.texture,(()=>this._release(i)))}_release(e){const t=this._textureRequests.get(e);t?(t.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),t.referenceCount--,t.referenceCount<1&&this._frameTask.schedule((()=>this._releaseNow(e)))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`)}get test(){}_releaseNow(e){if(!this._textureRequests)return;const t=this._textureRequests.get(e);!t||t.referenceCount>0||(t.texture?.unload(),this._releaseTextureRequest(t),this._textureRequests.delete(e))}_releaseTextureRequest(e){e.texture?this._stage?.removeTexture(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}makeUid(e,t=null){return null!=t?`${e}.${t}px`:e}};(0,o._)([(0,x.Cb)()],Y_.prototype,"_frameTask",void 0),(0,o._)([(0,x.Cb)()],Y_.prototype,"updating",null),Y_=(0,o._)([(0,S.j)("esri.views.3d.support.TextureCollection")],Y_);class Q_{constructor(e,t,i){this.uid=e,this.texture=t,this.release=i}}class K_{constructor(){this.referenceCount=0}}var J_=i(28751);class ef extends Y_{constructor(e,t,i){super(t,i),this._streamDataRequester=e}async fromUrl(e,t,i){(0,y.k_)(i);const r=i?.signal,s=this.makeUid(e,t);let n=this._textureRequests.get(s);if(!n){const i=new AbortController,r=this._streamDataRequester.request(e,"image",{uid:s,signal:i.signal});n=new K_,n.abortController=i;const a=n;this._textureRequests.set(s,n),n.textureAsync=r.then((async i=>{const r=this._createTexture(e,i,t);return a.texture=r,a.abortController=null,await r.load(this._stage.renderView.renderingContext),this._stage.addTexture(r),new Q_(s,r,(()=>this._release(s)))}),(e=>{throw a.abortController=null,e}))}n.referenceCount++;try{return await(0,y.Hl)(n.textureAsync,r)}catch(e){throw this._release(s),e}}_createTexture(e,t,i){const r={width:t.width,height:t.height,wrap:{s:Ir.e8.CLAMP_TO_EDGE,t:Ir.e8.CLAMP_TO_EDGE},preMultiplyAlpha:!0,reloadable:!0};if((0,X_.zd)(e)){if(i||0===t.width&&0===t.height){const e=t.width?t.height/t.width:1;i=i||64,e>1?(t.width=Math.round(i/e),t.height=i):(t.width=i,t.height=Math.round(i*e))}this._stage.renderView?.renderingContext.driverTest.svgPremultipliesAlpha.result&&(r.preMultiplyAlpha=!1)}return new J_.x(t,r)}}class tf{constructor(e){this.streamDataRequester=null,this._graphicsOwners=[],this._screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this._viewState=e.viewState,this._view=e.view,this._pointsOfInterest=e.pointsOfInterest,this.streamDataRequester=e.resourceController.createStreamDataRequester(M_.Bh.SYMBOLOGY),this.objectResourceCache=new W_(((t,i)=>e.resourceController.memoryController.newCache(t,i))),this.textures=new ef(this.streamDataRequester,e.view.stage,e.resourceController.scheduler);const t=(0,vr.Iu)(this._view.spatialReference).radius;this.screenSizePerspectiveSettings=(0,Fd.Gw)(e.viewingMode,t),this.screenSizePerspectiveSettingsLabels=(0,Fd.n9)(e.viewingMode,t)}destroy(){this.textures.destroy(),this.streamDataRequester=null}addGraphicsOwner(e){if(!e)return(0,p.kB)();this._graphicsOwners.push(e);const t=(0,n.YP)((()=>e.layer?.screenSizePerspectiveEnabled),(()=>this._updateScreenSizePerspectiveEnabled()));return this._updateScreenSizePerspectiveEnabled(),(0,p.kB)((()=>{t.remove(),(0,St.e$)(this._graphicsOwners,e),this._updateScreenSizePerspectiveEnabled()}))}_updateScreenSizePerspectiveEnabled(){const e=this._graphicsOwners.some((e=>!0===e.layer?.screenSizePerspectiveEnabled));if(e&&!this._screenSizePerspectiveHandles){this._screenSizePerspectiveHandles=new mt.Z;const e=()=>this._updateScreenSizePerspectiveSettings();this._screenSizePerspectiveHandles.add([(0,n.YP)((()=>this._pointsOfInterest.centerOnSurfaceInfrequent.distance),e,n.Z_),this._viewState.events.on("camera-projection-changed",e)]),this._updateScreenSizePerspectiveSettings()}else e||(this._screenSizePerspectiveHandles=(0,f.SC)(this._screenSizePerspectiveHandles))}_updateScreenSizePerspectiveSettings(){const e=this._pointsOfInterest;rf.distance=e.centerOnSurfaceInfrequent.distance,rf.fovY=this._viewState.camera.fovY,this.screenSizePerspectiveSettings.update(rf),this.screenSizePerspectiveSettingsLabels.update(rf),this._view.stage.renderView.requestRender()}get test(){}}const rf={distance:0,fovY:0};let sf=class extends E.Z{constructor(){super(),this._propertiesPool=new Xc.L({plane:cd.B},this),this.isDecoration=!0,this.addHandles((0,p.ed)(this._propertiesPool))}set plane(e){if(!e)return void this._set("plane",e);const t=this._propertiesPool.get("plane");(0,cd.a)(e,t),this._set("plane",t)}};(0,o._)([(0,x.Cb)()],sf.prototype,"plane",null),(0,o._)([(0,x.Cb)()],sf.prototype,"isDecoration",void 0),sf=(0,o._)([(0,S.j)("esri.views.3d.support.ViewSlice")],sf);var nf=i(46451),af=(i(62197),i(38365)),of=(i(90901),i(75777),i(9726)),lf=i(37500);class cf{constructor(e){this.destination=e}hide(){null!=this.graphic&&(this.destination.remove(this.graphic),this.graphic=null)}}class hf extends cf{constructor(e,t,i=""){super(e),this._symbol=new of.Z({symbolLayers:new c.Z([new af.Z({material:{color:t},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new lf.Z({text:i,halo:{color:"white",size:1/.75},material:{color:t},size:12})])})}show(e,t){if(!t)return;this.hide();const i=new a.Z({x:e[0],y:e[1],z:e[2],spatialReference:t});this.graphic=new nf.Z({geometry:i,symbol:this._symbol}),this.destination.add(this.graphic)}}let uf=class extends E.Z{constructor(e){super(e)}};(0,o._)([(0,x.Cb)({constructOnly:!0})],uf.prototype,"renderCoordsHelper",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],uf.prototype,"surface",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],uf.prototype,"state",void 0),uf=(0,o._)([(0,S.j)("esri.views.3d.support.pointsOfInterest.PointOfInterest")],uf);const df=Array;let pf=class extends uf{constructor(e){super(e),this._dirty=!1,this._propertiesPool=new Xc.L({location:a.Z,renderLocation:df},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.renderLocation=(0,O.Ue)(),this._tmpPoint=new a.Z}initialize(){if(this.scheduler&&this.addHandles(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const e=()=>this._setDirty();this.addHandles((0,n.on)((()=>this.map?.ground?.layers),"change",e,{onListenerAdd:e,onListenerRemove:e}))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool=(0,f.SC)(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get scale(){const e=this._camera,t=(0,mr.j)(e.eye,this.renderLocation),i={renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}};return(0,ne.Xt)(i,t)}get updating(){return this._dirty||null!=this._pendingElevationQueryController}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){const e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}get running(){return!this._pendingElevationQueryController&&this._dirty}runTask(){if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map?.ground)return this._updateSurfaceAltitude(0),qr.J;const e=this.state.spatialReference;this._tmpPoint.spatialReference=e,this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this._tmpPoint);const t=(this._tmpPoint.z??0)>_f&&this.renderCoordsHelper.viewingMode===Si.JY.Global&&(e.isWGS84||e.isWebMercator);let i=new AbortController;return this.map.ground.queryElevation(this._tmpPoint,{signal:i.signal,cache:this.cache,minDemResolution:t?ff:0}).then((e=>this._updateSurfaceAltitude(e.geometry.z??0))).catch((e=>{(0,y.D_)(e)||this._updateSurfaceAltitude(0)})).catch((()=>{})).then((()=>{this._pendingElevationQueryController===i&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),i=null})),this._pendingElevationQueryController=i,qr.J}_updateSurfaceAltitude(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(mf,this._estimatedSurfaceAltitude,this._camera.eye),(0,mr.q)(this._get("renderLocation"),mf)||(this._set("renderLocation",(0,mr.c)(this._propertiesPool.get("renderLocation"),mf)),this.notifyChange("renderLocation"))}};(0,o._)([(0,x.Cb)({constructOnly:!0})],pf.prototype,"scheduler",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],pf.prototype,"cache",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],pf.prototype,"task",void 0),(0,o._)([(0,x.Cb)()],pf.prototype,"location",null),(0,o._)([(0,x.Cb)({constructOnly:!0})],pf.prototype,"map",void 0),(0,o._)([(0,x.Cb)()],pf.prototype,"renderLocation",void 0),(0,o._)([(0,x.Cb)()],pf.prototype,"scale",null),(0,o._)([(0,x.Cb)()],pf.prototype,"updating",null),pf=(0,o._)([(0,S.j)("esri.views.3d.support.pointsOfInterest.CameraOnSurface")],pf);const mf=(0,O.Ue)(),_f=1e5,ff=1e6,gf=Array;let yf=class extends uf{constructor(e){super(e),this._propertiesPool=new Xc.L({location:a.Z,renderLocation:gf},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.distance=0,this.renderLocation=(0,O.Ue)(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker=(0,f.hw)(this._frameWorker),this._propertiesPool=(0,f.SC)(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get running(){return this.updating}runTask(){return this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1,qr.J}_updateRenderLocation(){const e=bf;let t=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,e);const i=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&i&&(t=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,e),t&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const r=wf;t&&this._latestSurfaceAltitudeChangesDistanceSignificantly(e,r)&&((0,mr.c)(e,r),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t?this.distance=(0,mr.j)(this._camera.eye,e):((0,mr.g)(e,this._camera.viewForward,this._get("distance")),(0,mr.f)(e,e,this._camera.eye)),(0,mr.q)(this._get("renderLocation"),e)||this._set("renderLocation",(0,mr.c)(this._propertiesPool.get("renderLocation"),e))}_calculateSurfaceIntersection(e,t){const i=this._camera;if(!this.renderCoordsHelper.intersectInfiniteManifold(i.ray,e,t))return!1;if(this.state.isGlobal){const r=(0,vr.Iu)(this.renderCoordsHelper.spatialReference).radius,s=r+e,n=(0,mr.k)(i.eye),a=n<s*s,o=(0,mr.j)(i.eye,t);if(a&&o>r/4){const e=s-Math.sqrt(n);return(0,mr.g)(t,i.viewForward,e),(0,mr.f)(t,t,i.eye),!0}}else{const e=this.surface?.ready?this.surface.extent:null;null!=e&&(0,U.d)(e,this.surface?.spatialReference,Cf,this.renderCoordsHelper.spatialReference)&&(t[0]=(0,jt.uZ)(t[0],Cf[0],Cf[2]),t[1]=(0,jt.uZ)(t[1],Cf[1],Cf[3]))}return!0}_latestSurfaceAltitudeChangesDistanceSignificantly(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||null==e)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){if(dd.h.TESTS_DISABLE_OPTIMIZATIONS)return!0;const i=this._camera.eye,r=(0,mr.j)(i,e),s=(0,mr.j)(i,t);if(Math.abs(s-r)/r>vf)return!0}return!1}};(0,o._)([(0,x.Cb)({constructOnly:!0})],yf.prototype,"scheduler",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],yf.prototype,"task",void 0),(0,o._)([(0,x.Cb)()],yf.prototype,"distance",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],yf.prototype,"estimateSurfaceAltitudeAtCenter",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],yf.prototype,"location",null),(0,o._)([(0,x.Cb)({readOnly:!0})],yf.prototype,"renderLocation",void 0),(0,o._)([(0,x.Cb)()],yf.prototype,"updating",void 0),yf=(0,o._)([(0,S.j)("esri.views.3d.support.pointsOfInterest.CenterOnSurface")],yf);const vf=.05,bf=(0,O.Ue)(),wf=(0,O.Ue)(),Cf=(0,V.Ue)();var xf=i(83986);class Tf{constructor(e){this.events=new ae.Z,this._handles=(0,xf.w)((()=>e),(e=>e.on("visible-geometry-changed",(e=>this.events.emit("request-update",e)))))}destroy(){this._handles.destroy()}}const Sf=Array;let Mf=class extends uf{constructor(e){super(e),this._propertiesPool=new Xc.L({location:a.Z,renderLocation:Sf},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.addHandles([(0,n.YP)((()=>this.centerOnSurface.renderLocation),(()=>this.updateRenderLocation())),(0,n.YP)((()=>this.state.contentCamera),(()=>this.updateRenderLocation()))]),this.scheduler&&this.addHandles(this.scheduler.registerTask(Gr.T8.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool=(0,f.SC)(this._propertiesPool)}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get worldUnitsPerContentPixel(){const{camera:e,contentPixelRatio:t}=this.state;return e.computeRenderPixelSizeAt(this.renderLocation)*(e.pixelRatio/t)}get running(){return this._dirty}runTask(){const e=this._get("renderLocation"),t=this.centerOnSurface.renderLocation,i=this.renderCoordsHelper,r=this.state.contentCamera;this._dirty=!1,i.worldUpAtPosition(t,Ef);const s=Math.max(0,(Math.acos((0,mr.e)(Ef,r.viewForward))-.5*Math.PI)*(r.aboveGround?1:-1));if(Number.isNaN(s)){if(!e||!(0,mr.G)(e,t)){const e=this._propertiesPool.get("renderLocation");(0,mr.c)(e,t),this._set("renderLocation",e)}return qr.J}const n=1-(0,jt.uZ)(s/(.5*Math.PI),0,1),a=n*n*n;this._calculateScreenHorizontalEdgeOnSurface(Pf);const o=this._propertiesPool.get("renderLocation");return(0,mr.m)(o,t,Pf,a),e&&(0,mr.G)(e,o)||this._set("renderLocation",o),qr.J}_calculateScreenHorizontalEdgeOnSurface(e){const t=this.state.contentCamera,i=t.getRenderCenter((0,b.J$)());if(i[1]=t.aboveGround?t.padding[Wc.Np.BOTTOM]:t.fullHeight-t.padding[Wc.Np.TOP],this.estimateSurfaceIntersectionAtRenderPoint(i,e))return e;const r=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(i,Rf)){(0,mr.d)(Rf,Rf,t.eye);const i=(0,mr.n)(Rf,Rf);if(this.renderCoordsHelper.intersectInfiniteManifold((0,Fn.re)(t.eye,i),r,e))return e}return this.renderCoordsHelper.setAltitude(e,r,t.eye)}updateRenderLocation(){this._dirty=!0}};(0,o._)([(0,x.Cb)()],Mf.prototype,"_dirty",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],Mf.prototype,"scheduler",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],Mf.prototype,"centerOnSurface",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],Mf.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),(0,o._)([(0,x.Cb)()],Mf.prototype,"updating",null),(0,o._)([(0,x.Cb)()],Mf.prototype,"location",null),(0,o._)([(0,x.Cb)()],Mf.prototype,"renderLocation",void 0),(0,o._)([(0,x.Cb)()],Mf.prototype,"worldUnitsPerContentPixel",null),Mf=(0,o._)([(0,S.j)("esri.views.3d.support.pointsOfInterest.Focus")],Mf);const Ef=(0,O.Ue)(),Rf=(0,O.Ue)(),Pf=(0,O.Ue)();let Af=class extends E.Z{get surface(){return this.view.map?.ground}get surfaceView(){return this.view.basemapTerrain}get renderLocation(){if(!this.location)return null;const e=(0,O.Ue)();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}constructor(e){super(e),this.location=null,this._updateController=null}initialize(){this.view.state.isLocal&&(this.addHandles([(0,n.YP)((()=>[this.surfaceView?.spatialReference,this.surfaceView?.extent]),(()=>this._update())),(0,n.on)((()=>this.surface?.layers),"change",(()=>this._update()))]),this._update())}_update(){if(this._updateController&&(this._updateController.abort(),this._updateController=null),null==this.surfaceView?.extent||null==this.surfaceView.spatialReference)return void this._set("location",null);const e=(0,V.be)(this.surfaceView.extent),t=new a.Z({x:e[0],y:e[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this.surface.queryElevation(t,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then((e=>{this._updateController=null,this._set("location",e.geometry)})).catch((e=>{}))):this._set("location",t)}};(0,o._)([(0,x.Cb)({constructOnly:!0})],Af.prototype,"view",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],Af.prototype,"cache",void 0),(0,o._)([(0,x.Cb)()],Af.prototype,"surface",null),(0,o._)([(0,x.Cb)()],Af.prototype,"surfaceView",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Af.prototype,"location",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Af.prototype,"renderLocation",null),Af=(0,o._)([(0,S.j)("esri.views.3d.support.pointsOfInterest.StableSurfaceCenter")],Af);let Of=class extends E.Z{constructor(e){super(e),this._tileGeometryUpdateExtent=(0,V.cS)(),this._tileGeometryUpdateSpatialReference=null,this.events=new ae.Z,this.updating=!1}initialize(){this.addHandles([this.surface.on("elevation-change",(e=>this._tileGeometryChanged(e))),this.scheduler.registerTask(Gr.T8.SURFACE_GEOMETRY_UPDATES,this)])}get running(){return this.updating}runTask(){return this.updating?(this._tileGeometryUpdateSpatialReference&&this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",Df),(0,V.cS)(this._tileGeometryUpdateExtent),this._set("updating",!1),qr.J):qr.J}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=e.spatialReference,(0,V.jn)(this._tileGeometryUpdateExtent,e.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let t=1;t<this.centerOnSurfaces.length;t++){const i=this.centerOnSurfaces[t];i.distance>e.distance&&(e=i)}return e}_centerIntersectsExtent(e,t){const i=this.state.contentCamera.eye,r=Ff,s=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(i,If,t),this.renderCoordsHelper.fromRenderCoords(s.renderLocation,Lf,t),If[0]<Lf[0]?(r[0]=If[0],r[2]=Lf[0]):(r[0]=Lf[0],r[2]=If[0]),If[1]<Lf[1]?(r[1]=If[1],r[3]=Lf[1]):(r[1]=Lf[1],r[3]=If[1]),(0,V.kK)(r,e)}};(0,o._)([(0,x.Cb)({constructOnly:!0})],Of.prototype,"state",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],Of.prototype,"centerOnSurfaces",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],Of.prototype,"renderCoordsHelper",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],Of.prototype,"scheduler",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],Of.prototype,"surface",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Of.prototype,"updating",void 0),Of=(0,o._)([(0,S.j)("esri.views.3d.support.pointsOfInterest.SurfaceGeometryUpdates")],Of);const Df={},If=(0,O.Ue)(),Lf=(0,O.Ue)(),Ff=(0,V.cS)();let Nf=class extends E.Z{constructor(e){super(e),this.renderPointOfView=(0,O.Ue)(),this._pois=new Array,this._updatingHandles=new Y.R,this._debugCenters=null,this._tmpRay=(0,Fn.Ue)(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new Xc.L({renderPointOfView:Uf},this),this._contentIntersector=new Yo.r(e.view.state.viewingMode),this._surfaceIntersector=new Yo.r(e.view.state.viewingMode),this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=Hm.e.MIN}initialize(){const{state:e,basemapTerrain:t,renderCoordsHelper:i,map:r}=this.view,s=()=>this._estimateSurfaceAltitudeAtCenter(),a=this.view.resourceController.scheduler,o=t?.elevationQueryCache,l={state:e,scheduler:a,surface:t,renderCoordsHelper:i};this._set("centerOnSurfaceInfrequent",new yf({...l,task:Gr.T8.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:s})),this._set("centerOnSurfaceFrequent",new yf({...l,task:Gr.T8.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:s})),this._set("centerOnContent",new yf({...l,task:Gr.T8.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()})),this._set("cameraOnSurface",new pf({...l,cache:o,task:Gr.T8.POINT_OF_INTEREST_INFREQUENT,map:r})),this._set("surfaceGeometryUpdates",new Of({...l,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]})),this._set("contentGeometryUpdates",new Tf(this.view.allLayerViews)),this._set("surfaceOrigin",new Af({cache:o,view:this.view})),this._set("focus",new Mf({state:e,scheduler:a,surface:t,renderCoordsHelper:i,centerOnSurface:this.centerOnSurfaceFrequent,estimateSurfaceIntersectionAtRenderPoint:(e,t)=>this._estimateSurfaceIntersectionAtRenderPoint(e,this.view.state.contentCamera,t)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.focus),this.addHandles([(0,n.YP)((()=>e.contentCamera),(e=>this._cameraChanged(e)),n.Z_),this._updatingHandles.add((()=>t.extent),(()=>this._updateCenterPointsOfInterest())),this._updatingHandles.add((()=>this.view.map?.ground?.navigationConstraint?.type),(e=>{this._surfaceIntersector.options.backfacesTerrain="none"===e}),n.nn),(0,n.gx)((()=>!t.updating),(()=>this._updateCenterPointsOfInterest()),n.Z_),(0,n.on)((()=>this.surfaceGeometryUpdates.events),"request-update",(()=>this._updateCenterPointsOfInterest())),(0,n.on)((()=>this.contentGeometryUpdates.events),"request-update",(()=>this._updateCenterOnContent())),this._updatingHandles.add((()=>dd.h.SHOW_POI),(e=>this._setDebug(e)),n.nn)]),this._cameraChanged(this.view.state.contentCamera);for(const e of this._pois)e.runTask()}destroy(){this._setDebug(!1),this._propertiesPool.destroy();for(const e of this._pois)e.destroy();this.surfaceOrigin.destroy(),this._updatingHandles.destroy()}get updating(){return!(!this.surfaceGeometryUpdates?.updating&&!this._pois.some((e=>e.updating)))||this._updatingHandles.updating}get _centerRay(){return this._centerRayDirty&&(this._centerRayCached=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.contentCamera,this._tmpRay),this._centerRayDirty=!1),this._centerRayCached}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const e=this._centerRay;return null==e||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,Hf,kf)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(Hf):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const e=this._centerRay;if(null==e)return this._surfaceAltitudeAtCenter;const t=e.origin,i=(0,mr.f)(Hf,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e,this.view.state.contentCamera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,t,i),this._surfaceIntersector.results.min.getIntersectionPoint(Hf)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(Hf)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(e,t,i){const r=(0,dl.eW)(t,e,Vf);if(null==r)return null;const s=r.origin,n=(0,mr.f)(Hf,r.origin,r.direction);return this._surfaceIntersector.resetWithRay(r,t),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,s,n),this._surfaceIntersector.results.min.getIntersectionPoint(i)?i:null}_cameraChanged(e){this._updateCenterPointsOfInterest();const t=e.eye;(0,mr.q)(this.renderPointOfView,t)||this._set("renderPointOfView",(0,mr.c)(this._propertiesPool.get("renderPointOfView"),t))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const e of this._pois)e.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(e){if(!e)return this._debugCenters?.forEach((e=>e.hide())),void this.removeHandles("debug");if(!this._debugCenters){this._debugCenters=new Map;const e=this.view.graphics;this._debugCenters.set(this.centerOnContent,new hf(e,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new hf(e,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new hf(e,"red","CenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new hf(e,"blue","CameraOnSurface")),this._debugCenters.set(this.focus,new hf(e,"green","Focus"))}for(const e of this._pois)this.addHandles(this._updatingHandles.add((()=>e.renderLocation),(t=>this._debugCenters?.get(e)?.show(t,e.renderCoordsHelper.spatialReference)),n.nn),"debug")}get test(){}};(0,o._)([(0,x.Cb)()],Nf.prototype,"centerOnContent",void 0),(0,o._)([(0,x.Cb)()],Nf.prototype,"centerOnSurfaceFrequent",void 0),(0,o._)([(0,x.Cb)()],Nf.prototype,"centerOnSurfaceInfrequent",void 0),(0,o._)([(0,x.Cb)()],Nf.prototype,"cameraOnSurface",void 0),(0,o._)([(0,x.Cb)()],Nf.prototype,"focus",void 0),(0,o._)([(0,x.Cb)()],Nf.prototype,"renderPointOfView",void 0),(0,o._)([(0,x.Cb)()],Nf.prototype,"surfaceOrigin",void 0),(0,o._)([(0,x.Cb)()],Nf.prototype,"contentGeometryUpdates",void 0),(0,o._)([(0,x.Cb)()],Nf.prototype,"surfaceGeometryUpdates",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],Nf.prototype,"view",void 0),(0,o._)([(0,x.Cb)()],Nf.prototype,"updating",null),Nf=(0,o._)([(0,S.j)("esri.views.3d.support.pointsOfInterest.PointsOfInterest")],Nf);const Uf=Array,Hf=(0,O.Ue)(),Vf=(0,Fn.Ue)(),kf={exclude:new Set([fl.xX])};var Bf=i(69071);class zf{constructor(e,t){this._cache=e(t,((e,t,i)=>{switch(t){case Bf.lN.ALL:return e.forEach((e=>e.dispose())),0;case Bf.lN.SOME:{const t=e.shift();return t?(i-=Math.round(t.cachedMemory),t.dispose()):i>0&&(_.Z.getLogger("esri/core/MemCachePool").warn("Encountered empty MemCachePool with non-zero memory."),i=0),i}}}))}hitrate(){return this._cache.hitRate}destroy(){this._cache.destroy()}clear(){this._cache.clear()}getSize(e){return this._cache.getSize(e)}pop(e){const t=this._cache.peek(e);if(!t)return;const i=t.pop();return t.length>0?i&&(t.cachedMemory=this._cache.getSize(e)-Math.round(i.cachedMemory),this._cache.updateSize(e,t)):this._cache.pop(e),i}put(e,t,i=Bf.Jv){const r=this._cache.peek(e);if(r)r.push(t),r.cachedMemory=this._cache.getSize(e)+Math.round(t.cachedMemory),this._cache.updateSize(e,r);else{const r=new Gf(t);this._cache.put(e,r,i)}}}class Gf extends Array{constructor(e){super(),this.item=e,this.cachedMemory=e.cachedMemory,this.push(e)}}var qf=i(77450),Zf=i(2051);class jf{constructor(e){this._store=e}destroy(){this._store.destroy()}get(e){return this._store.get(e)}put(e,t){this._store.put(e,t)}}var Wf=i(38600),$f=i(81808);class Xf{constructor(e=0,t=0){this.min=e,this.max=t,this.level=0,this.hasNoDataValues=!1}copyFrom(e){this.min=e.min,this.max=e.max,this.level=e.level,this.hasNoDataValues=e.hasNoDataValues}}var Yf=i(5135);class Qf{constructor(e,t,i){this.type="elevation",this.level=e[0],this.i=e[1],this.j=e[2],this.extent=t,this.samplerData=new Yf.K(i,t)}computeMinMaxValue(e,t,i,r){r.min=1/0,r.max=-1/0,r.hasNoDataValues=!1;const s=e-this.level;if(s<=0)return r;const n=2**s;if(Math.floor(t/n)!==this.i||Math.floor(i/n)!==this.j)return r;let a=1/0,o=-1/0;const l=this.samplerData.data.width,c=this.samplerData.data.values,h=.5*ce.zl;let u=(l-1)/n,d=(i-this.j*n)*u,p=(t-this.i*n)*u;if(u<1){const e=Math.floor(d),t=Math.floor(p),i=e+t*l,s=c[i],n=c[i+1],a=c[i+l],o=c[i+l+1];if(s+n+a+o<h){const i=d-e,l=p-t,c=(0,rr.bX)(s,n,a,o,i,l),h=(0,rr.bX)(s,n,a,o,i+u,l),m=(0,rr.bX)(s,n,a,o,i,l+u),_=(0,rr.bX)(s,n,a,o,i+u,l+u);return r.min=Math.min(c,h,m,_),r.max=Math.max(c,h,m,_),r}d=e,p=t,u=1}else d=Math.floor(d),p=Math.floor(p),u=Math.ceil(u);for(let e=d;e<=d+u;e++)for(let t=p;t<=p+u;t++){const i=c[e+t*l];i<h?(a=Math.min(a,i),o=Math.max(o,i)):r.hasNoDataValues=!0}return r.min=a,r.max=o,r}}const Kf=.5*ce.zl;function Jf(e,t,i){if(null==i)return null;for(const r of i){if(!r)continue;const i=r.safeWidth;let s=(0,jt.uZ)(r.dy*(r.y1-t),0,i),n=(0,jt.uZ)(r.dx*(e-r.x0),0,i);const a=Math.floor(s),o=Math.floor(n),l=r.data.width,c=a*l+o,h=r.data.values,u=h[c],d=h[c+1],p=c+l,m=h[p],_=h[p+1];if(u+m+d+_<Kf){s-=a,n-=o;const e=u+(d-u)*n;return e+(m+(_-m)*n-e)*s}}return null}var eg=i(6883);let tg=class extends E.Z{constructor(e){super(e)}initialize(){this.addHandles([this.layerViews.on("change",(()=>this.notifyChange("stencilEnabledExtents")))])}destroy(){}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}_computeStencilEnabledExtents(){const e=[];return this.layerViews.forEach((t=>{const i=t.layer;if("operationalLayerType"in i&&(0,z.$4)(i.operationalLayerType)&&null!=this.viewSpatialReference){const t=sg(i.fullExtent,this.viewSpatialReference);null!=t&&e.push((0,V.oJ)(t))}})),e}};(0,o._)([(0,x.Cb)({readOnly:!0})],tg.prototype,"layerViewsExtent",null),(0,o._)([(0,x.Cb)({readOnly:!0})],tg.prototype,"tiledLayersExtent",null),(0,o._)([(0,x.Cb)({readOnly:!0})],tg.prototype,"stencilEnabledExtents",null),(0,o._)([(0,x.Cb)()],tg.prototype,"viewSpatialReference",void 0),(0,o._)([(0,x.Cb)()],tg.prototype,"tilingScheme",void 0),(0,o._)([(0,x.Cb)()],tg.prototype,"defaultTiledLayersExtent",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],tg.prototype,"layers",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],tg.prototype,"layerViews",void 0),tg=(0,o._)([(0,S.j)("esri.views.3d.terrain.ExtentHelper")],tg);let ig=class extends tg{_computeLayerViewsExtent(){return this._globalExtent}_computeTiledLayersExtent(){return this._globalExtent}get _globalExtent(){return this.viewSpatialReference.isWebMercator?ce.uU:ce.JR}};ig=(0,o._)([(0,S.j)("esri.views.3d.terrain.ExtentHelper.ExtentHelperGlobal")],ig);let rg=class extends tg{_computeLayerViewsExtent(){const e=(0,V.cS)(),t=this.viewSpatialReference;this.layerViews.forEach((i=>{const r=i.layer;if(i.isResolved()&&("graphics"!==r.type||!r.internal)){const r=sg("fullExtentInLocalViewSpatialReference"in i&&i.fullExtentInLocalViewSpatialReference||i.layer.fullExtent,t);(0,V.jn)(e,r,e)}}));const i=(0,V.sU)(e)?e:null,r=this._get("layerViewsExtent");return(0,V.fS)(i,r)?r:i}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const t=this.viewSpatialReference,i=(0,V.cS)();this.layers.forEach((r=>{if(r.loaded&&(0,z.iC)(r)){const s=(0,eg.E_)(r,t,Si.JY.Local);if(null==s)return;const{tileInfo:n,fullExtent:a}=s,o="tilemapCache"in r?r.tilemapCache?.effectiveMaxLOD:void 0;null!=n&&null!=a&&((0,eg.x4)(r)||e.compatibleWith(n,o)&&a.spatialReference.equals(e.spatialReference))&&(0,V.jn)(i,a,i)}})),(0,V.jn)(i,this.defaultTiledLayersExtent,i);const r=(0,V.sU)(i)?i:null,s=this._get("tiledLayersExtent");return(0,V.fS)(r,s)?s:r}};function sg(e,t){return null==e||e.spatialReference.equals(t)?e:(0,F.projectWithoutEngine)(e,e.spatialReference,t)}rg=(0,o._)([(0,S.j)("esri.views.3d.terrain.ExtentHelper.ExtentHelperLocal")],rg);var ng=i(85216),ag=i(97290),og=i(61471),lg=i(25909),cg=i(62935),hg=i(51440);function ug(){const e=globalThis.require?.modules;if(e){const t=Object.keys(e);for(const i of t)i.includes(".glsl")&&delete e[i]}}class dg{constructor(e,t){this.screen=e,this.olid=t}}const pg=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let mg,_g=class extends E.Z{constructor(e){super(e),this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Set,this._drapeTargets=new Set,this._placementDirty=!1,this._contentUpdated=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._latestOriginId=0}initialize(){const e=this.view;this.renderer=new og.CB({parent:this}),e.stage.renderer.plugins.add(this.renderer);const t=()=>this.requestRender();this._groundIntersector=new Yo.r(this.view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this.addHandles([(0,n.YP)((()=>this.renderer.hasHighlights),t),this.renderer.events.on("has-water",(()=>e.stage?.renderer.updateHasFlags())),this.renderer.events.on("content-changed",t),(0,n.YP)((()=>e.state.camera.pixelRatio),t),(0,n.YP)((()=>e.state.alignPixelEnabled),t),this.renderer.events.on("textures-disposed",(()=>this.surface.requestRender())),(0,n.YP)((()=>[e.pointsOfInterest?.renderPointOfView,e.pointsOfInterest?.centerOnSurfaceFrequent?.location]),(()=>this.setPlacementDirty())),(0,n.YP)((()=>[e.state?.pixelRatio,e.state?.contentPixelRatio]),(()=>this.setPlacementDirty()),n.Z_),this.surface.on("elevation-change",(()=>this.setPlacementDirty())),e.on("resize",(()=>this.setPlacementDirty())),e.resourceController.scheduler.registerTask(Gr.T8.OVERLAY,this),e.stage.renderView.events.on("force-camera-for-screenshot",(e=>{this._updateOverlays(Gr.G5,e.camera,os.Xx.BACKGROUND),this.renderer.hasOverlays&&this._drawOverlays(os.Xx.BACKGROUND,e)}))]),e.stage.renderer.overlay=this}destroy(){this.view?.stage&&(this.view.stage.renderer.plugins.remove(this.renderer),this.view.stage.renderer.overlay=null),mg&&(mg.hide(),mg=null),this.renderer=(0,f.SC)(this.renderer)}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.renderer.longitudeCyclical=null;const t=this.view.renderSpatialReference;null!=e&&null!=t?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this.renderer.longitudeCyclical=e.isWebMercator?new tl.pE(-20037508.342787,20037508.342787):new tl.pE(-180,180))):this.renderer.disposeOverlays()}get running(){return this._placementDirty&&(this._drapeSources.size>0||this.view.graphics.length>0||dd.h.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this.view.state.isGlobal}get worldToPCSRatio(){return null!=this._spatialReference&&this._spatialReference.isGeographic&&!this.view.state.isLocal?(0,vr.Iu)(this._spatialReference).metersPerDegree:1}get _overlayStretch(){return 1.3/this.view.resolutionScale}get _longitudeCyclical(){return this.renderer.longitudeCyclical}get suspended(){return this.surface.suspended}get updating(){return this.running||this.renderer.updating||this._contentUpdated}get rendersOccludedDraped(){return this.renderer.rendersOccludedDraped}render(){if(this._contentUpdated=!1,this.renderer.processSyncDrapeSources(),this.renderer.hasOverlays)return this._precompileShaders()?this._drawOverlays(os.Xx.UPDATE):null}get hasOverlays(){return this.renderer.hasOverlays}registerDrapeSource(e,t){this._drapeSources.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources),this.renderer.registerDrapeSource(e,t),this._updateDrapeSourceExtent(e),this._setContentDirty(),this.notifyChange("running")}registerGeometryDrapeSource(e){const t=new cg.S({stage:this.view.stage,drapeSource:e,rendererContext:this.renderer});return this.registerDrapeSource(e,t),t}_updateDrapeSourceExtent(e){2===this.renderer.overlays.length&&null!=e.setDrapingExtent&&null!=this._spatialReference&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference)}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.removeDrapeSourceRenderer(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))}registerDrapeTarget(e){this._drapeTargets.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}unregisterDrapeTarget(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setContentDirty(){this.setPlacementDirty(),this.requestRender()}setPlacementDirty(){this._placementDirty=!0}runTask(e){return this._updateOverlays(e,this.view.state.contentCamera,os.Xx.UPDATE)}_updateOverlays(e,t,i){if(!this._spatialReference)return qr.J;const r=this._computeOverlayHeight(t);this._computeOverlayExtents(t,r,yg),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources,yg.stretch);const s=this._updateOverlay(ng.fu.INNER,yg.inner,r,1*yg.pixelRatioAdjustment,yg.mapUnitsPerPixel),n=(0,V.d_)(yg.inner)/(0,V.d_)(yg.outer),a=this._updateOverlay(ng.fu.OUTER,yg.outer,r,n*yg.pixelRatioAdjustment,yg.mapUnitsPerPixel);s!==Cg.EXTENT&&a!==Cg.EXTENT||(this._drapeSources.forEach((e=>this._updateDrapeSourceExtent(e))),this.updateOverlayParameters(i)),s===Cg.NONE&&a===Cg.NONE||this.requestRender(),this._placementDirty=!1,e.madeProgress()}_computeOverlayHeight(e){const t=this.view.state.contentPixelRatio*this.view.resolutionScale,i=e.fullWidth/e.pixelRatio*t,r=e.fullHeight/e.pixelRatio*t,s=Math.ceil(1.5*Math.max(i,r)),{maxPreferredTexturePixels:n,maxTextureSize:a}=this.view.stage.renderView.renderingContext.parameters,o=.5*a;return(0,hg.nq)((0,hg.tI)({width:s,height:s},{maxPreferredTexturePixels:2*n,maxTextureSize:o})[1],o)}_updateOverlay(e,t,i,r,s){if(0===this.renderer.overlays.length)return Cg.NONE;const n=this.renderer.overlays[e],a=n.mapUnitsPerPixel;if(n.mapUnitsPerPixel=s,n.pixelRatio=r,function(e,t){const i=1e-5,r=dd.h.TESTS_DISABLE_OPTIMIZATIONS?0:i*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]);return Math.abs(t[0]-e[0])<=r&&Math.abs(t[1]-e[1])<=r&&Math.abs(t[2]-e[2])<=r&&Math.abs(t[3]-e[3])<=r}(t,n.extent)&&i===n.resolution)return a===s?Cg.NONE:Cg.RERENDER_ONLY;(0,V.JG)(n.extent,t),n.resolution=i;const o=(0,V.be)(n.extent);return n.renderLocalOrigin=(0,lg.a)(o[0],o[1],0,"OV_"+this._latestOriginId++),Cg.EXTENT}updateOverlayParameters(e){this.surface.allTiles.forAll((e=>this.updateTileOverlayParameters(e))),this.surface.requestRender(e)}updateTileOverlayParameters(e){if(!e.renderData)return;const t=e.renderData.overlay;if(0===this.renderer.overlays.length)this._clearTileOverlayData(ng.fu.INNER,t),this._clearTileOverlayData(ng.fu.OUTER,t);else{const[i,r]=this.renderer.overlays,s=e.extent;this._rectInsideRect(i.extent,s)||this._rectanglesOverlap(s,i.extent)||this._rectanglesOverlap(s,r.extent)?(this._setTileOverlayData(s,ng.fu.INNER,t),this._setTileOverlayData(s,ng.fu.OUTER,t)):(this._clearTileOverlayData(ng.fu.INNER,t),this._clearTileOverlayData(ng.fu.OUTER,t))}}overlayPixelSizeInMapUnits(e,t){if(0===this.renderer.overlays.length)return t();const i=this.renderer.overlays[ng.fu.INNER],r=this.renderer.overlays[ng.fu.OUTER],s=this._pointIsInExtent(e,i.extent)?i:r;return(s.extent[2]-s.extent[0])/s.resolution}_setTileOverlayData(e,t,i){if(0===this.renderer.overlays.length)return;const r=this.renderer.overlays[t].extent,s=(0,V.d_)(r),n=(0,V.Cb)(r);let a=e[0];if(this._longitudeCyclical){a=this._longitudeCyclical.minimalMonotonic(r[0],a);const t=this._longitudeCyclical.minimalMonotonic(r[0],e[2]);a>t&&(a=t-(e[2]-e[0]))}i.setScale(t,(0,V.d_)(e)/s,(0,V.Cb)(e)/n),i.setOffset(t,(a-r[0])/s,(e[1]-r[1])/n)}_clearTileOverlayData(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)}reloadShaders(){ug(),this.requestRender(),this.runTask(Gr.G5)}requestRender(e=os.Xx.UPDATE){this.renderer.hasOverlays?(e===os.Xx.UPDATE?(this._contentUpdated=!0,this._drawTexturesDirty=!0):this._drawTexturesAnimateDirty=!0,this.view.stage.renderView.requestRender(e)):this.setPlacementDirty()}_intersectGroundFromView(e,t,i,r,s){const n=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,wg,t,i);if(null==n)return!1;const a=n.origin,o=(0,mr.f)(gg,n.origin,n.direction);this._groundIntersector.reset(a,o,e),this._groundIntersector.intersect([]),this.view.basemapTerrain.intersect(this._groundIntersector,null,a,o);const l=this._groundIntersector.results.min;return l.getIntersectionPoint(s)&&l.withinDistance(r)}_findHorizonBasedPointOfInterest(e,t){let i=.5;const r=.55,s=this.view.renderCoordsHelper.getAltitude(e.eye),n=this.view.pointsOfInterest.centerOnSurfaceFrequent,a=1e-5,o=(0,jt.uZ)(n.estimatedSurfaceAltitude,e.aboveGround?-1/0:s+a,e.aboveGround?s-a:1/0),l=e.aboveGround;if("global"===this.view.viewingMode){const t=gg;(0,Nn.j)((0,Nn.b)(Nn.t,(0,vr.Iu)(this.view.spatialReference).radius+o),(0,Fn.re)(e.eye,e.viewForward),t),(0,mr.d)(t,t,e.eye);const s=tl.Q4.normalize((0,sl.cp)(e.viewForward,t,e.viewRight))/e.fovY+.5,n=s<=0||s>=1?.5:r;i=l?n*s:s+n*(1-s)}else{const t=.5*Math.PI-Math.acos(-e.viewForward[2]),s=Math.tan(t),n=(0,Uc.al)(0,s,1,0),a=(0,Nc.t)(n,n,e.projectionMatrix)[1],o=(0,jt.uZ)(.5+.5*a,0,1);i=1===o||0===o?.5:l?o*r:1-(1-o)*r}return this._intersectGroundFromView(e,.5,i,n.distance,t)}_computeOverlayExtents(e,t,i){const r=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,s=(0,O.Ue)();this._findHorizonBasedPointOfInterest(e,s)||(0,mr.c)(s,r),dd.h.OVERLAY_SHOW_CENTER?(null==mg&&(mg=new hf(this.view.graphics,"red")),mg.show(s,this._renderSR)):null!=mg&&mg.hide();const n=Math.max(.1,(0,mr.j)(e.eye,s)),a=(0,la.L)(this.view.renderCoordsHelper,r,e.eye);this._overlaySREqualsRenderSR||(0,Zf.S)(s,this._renderSR,s,this._spatialReference);const o=this.surface.extent,l=!this._isSpherical&&this._spatialReference?.isGeographic,c=l&&this._spatialReference?1/(0,vr.Iu)(this._spatialReference).metersPerDegree:1,h=this.view.state.contentPixelRatio,u=e.perScreenPixelRatio/h*n*c;i.mapUnitsPerPixel=u/this.worldToPCSRatio,i.stretch=this._overlayStretch;let d=t*u/2*i.stretch,p=!1,m=l?90:1/0;this._isSpherical&&o&&this._spatialReference&&(this._spatialReference.isWebMercator?(d/=Math.cos((0,ag.mZ)(s[1])),m=o[3]):(p=!0,d/=(0,vr.Iu)(this._spatialReference).metersPerDegree,m=90),d>=m&&(d=m,s[1]=0,this._spatialReference.isWebMercator&&(s[0]=0)));let _=1;p&&(_=1/Math.max(.2,Math.cos(Math.abs((0,jt.Vl)(s[1])))),d*_>180&&(_=180/d),i.mapUnitsPerPixel*=_);const f=Math.log(2)/12;d=Math.exp(Math.round(Math.log(d)/f)*f);const g=d*_,y=.5*t/(32*g),v=.5*t/(32*d);s[0]=Math.round(s[0]*y)/y,s[1]=Math.round(s[1]*v)/v;const b=i.inner;b[0]=s[0]-g,b[1]=s[1]-d,b[2]=s[0]+g,b[3]=s[1]+d,this._isSpherical&&this._shiftExtentToFitBounds(b,1/0,m);const w=i.outer;if(6*g>(0,V.d_)(o))(0,V.JG)(w,o);else if(Math.PI/2-Math.abs(a-Math.PI/2)<=.25*Math.PI)w[0]=b[0]-g,w[1]=b[1]-d,w[2]=b[2]+g,w[3]=b[3]+d;else{(0,Zf.S)(e.eye,this._renderSR,gg,this._spatialReference),(0,Er.$X)(fg,s,gg);let t=-Math.atan2(fg[1],fg[0])+.125*Math.PI;t<0&&(t+=2*Math.PI);const i=Math.floor(t/(.25*Math.PI));(0,Nc.d)(fg,pg[i],2*d),fg[0]*=_,fg[2]*=_,(0,Nc.g)(w,b,fg)}if(this._isSpherical)w[0]=this._longitudeCyclical.clamp(w[0]),w[2]=this._longitudeCyclical.clamp(w[2]),w[1]=Math.max(w[1],-m),w[3]=Math.min(w[3],m);else{const e=(0,V.jV)(b,o,vg),t=(0,V.jV)(w,o,bg);(0,V.r3)(e,t)&&(w[2]=w[0],w[3]=w[1])}const C=Math.abs(b[2]-b[0])/t;i.mapUnitsPerPixel=Math.max(i.mapUnitsPerPixel,C),i.pixelRatioAdjustment=i.mapUnitsPerPixel/C}_precompileShaders(){return!!this.renderer.hasOverlays&&(this.renderer.precompileShaders(this.view.state),!0)}_drawOverlays(e,t=this.view.state){if(!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return this.renderer;const i=this._drawTexturesDirty;this._drawTexturesDirty=this._drawTexturesAnimateDirty=!1;const r=this.renderer.computeValidity();return this.renderer.releaseRenderTargets(),this.renderer.drawOverlays(t),r!==this.renderer.computeValidity()&&this.updateOverlayParameters(os.Xx.UPDATE),i?(this.surface.requestRender(e),e===os.Xx.UPDATE&&this.surface.requestUpdate()):this.surface.requestRender(os.Xx.BACKGROUND),this.renderer}_rectanglesOverlap(e,t){return null!=e&&(this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):(0,V.kK)(e,t))}_rectInsideRect(e,t){return null!=t&&(this._longitudeCyclical?this._longitudeCyclical.contains(e[0],e[2],t[0])&&this._longitudeCyclical.contains(e[0],e[2],t[2])&&t[1]>e[1]&&t[3]<e[3]:(0,V.r3)(e,t))}_pointIsInExtent(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];const i=e.x,r=e.y;return i>t[0]&&i<t[2]&&r>t[1]&&r<t[3]}_shiftExtentToFitBounds(e,t,i){let r=0,s=0;e[0]<-t?r=e[0]+t:e[2]>t&&(r=t-e[2]),e[1]<-i?s=e[1]+i:e[3]>i&&(s=i-e[3]),(0,V.cv)(e,r,s)}get test(){}};(0,o._)([(0,x.Cb)()],_g.prototype,"_spatialReference",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],_g.prototype,"running",null),(0,o._)([(0,x.Cb)()],_g.prototype,"_placementDirty",void 0),(0,o._)([(0,x.Cb)()],_g.prototype,"_contentUpdated",void 0),(0,o._)([(0,x.Cb)()],_g.prototype,"_isSpherical",null),(0,o._)([(0,x.Cb)()],_g.prototype,"worldToPCSRatio",null),(0,o._)([(0,x.Cb)()],_g.prototype,"renderer",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],_g.prototype,"view",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],_g.prototype,"surface",void 0),(0,o._)([(0,x.Cb)()],_g.prototype,"suspended",null),(0,o._)([(0,x.Cb)()],_g.prototype,"updating",null),(0,o._)([(0,x.Cb)({type:Boolean})],_g.prototype,"rendersOccludedDraped",null),_g=(0,o._)([(0,S.j)("esri.views.3d.terrain.OverlayManager")],_g);const fg=(0,Uc.Ue)(),gg=(0,O.Ue)(),yg=new class{constructor(){this.inner=(0,V.Ue)(),this.outer=(0,V.Ue)(),this.mapUnitsPerPixel=0,this.pixelRatioAdjustment=1,this.stretch=1.3}},vg=(0,V.Ue)(),bg=(0,V.Ue)(),wg=(0,Fn.Ue)();var Cg;!function(e){e[e.NONE=0]="NONE",e[e.EXTENT=1]="EXTENT",e[e.RERENDER_ONLY=2]="RERENDER_ONLY"}(Cg||(Cg={}));var xg=i(16447),Tg=i(59384),Sg=i(29499);class Mg{constructor(){this.numVerticesPerSide=0,this.samplerData=null,this.samplerDataVersion=0,this.clippingArea=null,this.wireframe=!1,this.cornerPeerNeighbors=[null,null,null,null],this.cornerNeighborCornerTiles=[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],this.cornerNeighborCornerTileSamplerVersions=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],this.edgeResolutions=[-1,-1,-1,-1],this.edgePeerNeighbors=[null,null,null,null],this.edgePeerNeighborSamplerVersions=[-1,-1,-1,-1]}}var Eg,Rg=i(72913);class Pg{constructor(){this.indices=null,this.indexCount=0,this.edgeIndicesStartIndex=0,this.poleIndicesStartIndex=0,this.vertexAttributes=null,this.edgeVerticesStartIndex=0,this.poleVerticesStartIndex=0,this.maxEdgeVertexCount=0,this.boundingBox=(0,xg.cS)(),this.numVerticesPerSide=0,this.minu=0,this.minv=0,this.maxu=1,this.maxv=1,this.outerEdgesOffsetAndLength=[0,0,0,0,0,0,0,0]}release(){this.vertexAttributes=(0,f.RY)(this.vertexAttributes),this.indices=null}reset(){this.indices=null,this.vertexAttributes=null,(0,xg.cS)(this.boundingBox),this.numVerticesPerSide=0}getEdgeFirstVertexIndex(e){return this.outerEdgesOffsetAndLength[2*e]}getEdgeCount(e){return this.outerEdgesOffsetAndLength[2*e+1]}getEdgeVertexIndex(e,t){return this.getEdgeAttributeIndex(e,t)}getEdgeVertexPosition(e,t,i,r){this._getEdgeVertexRaw(this.getEdgeAttributeIndex(e,r),t),(0,mr.f)(t,t,i)}getEdgeNormal(e,t,i){const{typedBuffer:r,typedBufferStride:s}=this.vertexAttributes.normalCompressed;(0,Rg.rc)(t,r,this.getEdgeAttributeIndex(e,i),s)}setEdgeNormalFromValues(e,t,i,r,s){this._setNormal(this.getEdgeAttributeIndex(e,t),i,r,s)}setEdgeVertexFromValuesRawPositionUV(e,t,i,r,s,n,a){const o=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(o,i,r,s),this._setUV(o,n,a)}setEdgeVertexFromValuesRawPositionUVNormal(e,t,i,r,s,n,a,o,l,c){const h=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(h,i,r,s),this._setUV(h,n,a),this._setNormal(h,o,l,c)}_getEdgeVertexRaw(e,t){this.vertexAttributes.position.getVec(e,t)}_setNormal(e,t,i,r){const{typedBuffer:s,typedBufferStride:n}=this.vertexAttributes.normalCompressed;(0,Rg.hd)(s,e,t,i,r,n)}_setUV(e,t,i){this.vertexAttributes.uv0.setValues(e,Math.round(t*Tg.rU),Math.round(i*Tg.rU))}getEdgeAttributeIndex(e,t){return(0,eg.Fp)(0<=t&&t<this.getEdgeCount(e)),this.getEdgeFirstVertexIndex(e)+t}}class Ag{constructor(e){this._getFadeDuration=e,this._fadeStart=0,this._delayedTime=0}clear(){this._current=(0,f.SC)(this._current),this._next=(0,f.SC)(this._next),this._waiting=(0,f.SC)(this._waiting),this._delayed=(0,f.SC)(this._delayed)}get current(){if(null==this._current)return null;if(!this._isFadingEnabled){let e=null;this._delayed?(e=this._delayed,this._delayed=null):this._waiting?(e=this._waiting,this._waiting=null):this._next&&(e=this._next,this._next=null),e&&(this.clear(),this._current=e)}let e=Ag.test.fadeMoment;if(this._delayed&&(e=e||performance.now(),e>=this._delayedTime&&(this._push(this._delayed,Eg.Immediate),this._delayed=null)),this._next){e=e||performance.now();const t=this._fadeDuration,i=null!=this._current&&this._next.texture===this._current.texture,r=this._next.type!==ng.Ns.FADING,s=e-this._fadeStart>=t;(i||r||s)&&((0,f.SC)(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(e))}return this._current}get next(){return this._next}get fadeFactor(){if(null==this._next)return 1;const e=Ag.test.fadeMoment||performance.now(),t=Math.max(0,e-this._fadeStart),i=this._fadeDuration;return t>i?0:1-t/i}get isFading(){return null!=this._next||null!=this._delayed}push(e,t=Eg.Immediate){this._delayed=(0,f.SC)(this._delayed),this._push(e,t)}_push(e,t){if(this._isFadingEnabled||this.clear(),null==this._current)return void(this._current=e);const i=Ag.test.fadeMoment||performance.now();return t!==Eg.Immediate?(this._delayed=e,void(this._delayedTime=i+t)):null==this._next?(this._next=e,void(this._fadeStart=this._alignFadeStart(i))):void(null!=e&&((0,f.SC)(this._waiting),this._waiting=e))}get _fadeDuration(){const e=this._getFadeDuration();return this._waiting?.5*e:e}_alignFadeStart(e){const t=this._getFadeDuration();return e+t-e%t}get _isFadingEnabled(){return this._getFadeDuration()>0}static{this.test={fadeMoment:0}}}!function(e){e[e.Immediate=0]="Immediate",e[e.Delayed=5e3]="Delayed"}(Eg||(Eg={}));class Og{constructor(e,t,i,r,s,n){this.texture=e,this.type=t,this.offsetAndScale=i,e.retain(),this.opacities=(0,O.al)(r,s,n)}destroy(){this.texture.release()}}class Dg{constructor(){this._scales=(0,Uc.al)(-1,-1,-1,-1),this._offsets=(0,Uc.al)(-1,-1,-1,-1)}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(e,t,i){this._scales[2*e]=t,this._scales[2*e+1]=i}setOffset(e,t,i){this._offsets[2*e]=t,this._offsets[2*e+1]=i}get scales(){return this._scales}get offsets(){return this._offsets}}var Ig=i(25907),Lg=i(26041),Fg=i(91708);class Ng extends Dr.A{constructor(e,t){super(e,t,new Or.J(Fg.a,(()=>i.e(73752).then(i.bind(i,73752)))),Ug),this.type="TerrainTechnique",this.useStencil=!1}initializePipeline(e){return this._stencilPipelineState=this._createPipeline(e,!0),this._createPipeline(e,!1)}_createPipeline(e,t){const{renderOccluded:i,output:r}=e,s=e.backfaceCullingEnabled&&!i;return(0,Lr.sm)({blending:i?Lr.Zo:null,culling:s?Lr.Rd:null,depthTest:i?null:{func:Ir.wb.LESS},depthWrite:i?null:Lr.ck,colorWrite:Lr.gf,stencilTest:t?(0,Lg.iV)(os.hU.IntegratedMeshMaskExcluded):null,drawBuffers:(0,Dr.E)(r)})}getPipeline(){return this.useStencil?this._stencilPipelineState:super.getPipeline()}}const Ug=new Map([[Jr.T.POSITION,0],[Jr.T.UV0,1],[Jr.T.NORMALCOMPRESSED,2]]);class Hg{constructor(){this.geometry=new Pg,this.intersectionData=null,this.geometryState=null,this._vao=null,this._texture=null,this._textureOpacity=1,this._textureRef=new Ag((()=>this._tile.surface.fadeDuration)),this.overlay=new Dg,this._localOrigin=null,this._geometryStateChangedSinceLastUpdate=!0,this._hasGeometry=!1,this._modifiedFlags=0}get tile(){return this._tile}get localOrigin(){return this._localOrigin}init(e,t){this.clear(),this._tile=e,this.geometry.reset(),this.intersectionData=null,this.geometryState=new Mg,this._localOrigin=t,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear(),this._tile=null,this.intersectionData=null,this.geometryState=null}updateGeometryIfNeeded(e){if((!this._vao||this._geometryStateChangedSinceLastUpdate||this.wireframeChanged||this.clippingAreaChanged||this.samplerDataChanged||this.numVerticesPerSideChanged||this.dirtyCorners||this.dirtyEdgeResolutions||this.dirtyEdges)&&(this._updateGeometry(e),this._geometryStateChangedSinceLastUpdate=!1),eg.T9&&this.tile.intersectsClippingArea)for(let e=0;e<4;++e)(0,eg.Fp)(this.geometry.getEdgeCount(e)===this.geometryState.edgeResolutions[e]+1)}_calculateEdgeResolution(e,t){const i=this.tile,r=this.geometryState.numVerticesPerSide-1;if(!i.surface.isGlobal){const t=i.surface.extent;if(null!=t&&(0===e&&i.extent[3]>t[3]||1===e&&i.extent[2]>t[2]||2===e&&i.extent[1]<t[1]||3===e&&i.extent[0]<t[0]))return r}const s=i.level,n=eg.OC[e];if(!t)return(0,eg.Fp)(null==i.surface?.rootTiles||i.surface.updatingRootTiles||!i.shouldHaveNeighbor(n)),r;if(t.loaded){const i=t,n=i.renderData.geometryState,a=s-i.level;if((0,eg.Fp)(a>=0),0===a){const e=n.numVerticesPerSide-1;return Math.max(e,r)}const o=2**a,l=n.edgeResolutions[(e+2)%4]/o;return Math.max(1,l)}(0,eg.Fp)(!t.leaf);let a=r;return t.forAllSubtreeOnSide((0,eg._F)(n),(e=>e===i||(e.loaded?(a=Math.max(a,2**(e.level-s)),!0):((0,eg.Fp)(!e.leaf),!1)))),a}updateNeighborData(){const e=this.tile;if(!e.intersectsClippingArea)return;const t=e.renderData.geometryState,i=t=>(t.loaded||t.level===e.level)&&t?.intersectsClippingArea,r=t.edgePeerNeighbors,s=t.edgePeerNeighborSamplerVersions;for(let n=0;n<4;++n){const a=e.findNeighborTile(eg.OC[n],i),o=Wg(e,a),l=o?.renderData?.geometryState.samplerDataVersion??-1,c=r[n],h=o!==Wg(e,c),u=s[n]!==l;eg.T9&&a&&((0,eg.Fp)(e.level>=a.level),(0,eg.Fp)(e.level-a.level<=ce.qC)),r[n]=a,(h||u)&&(s[n]=l,this._markEdgeDirty(n));const d=t.edgeResolutions[n],p=this._calculateEdgeResolution(n,a);(0,eg.Fp)((0,jt.wt)(p)),(0,eg.Fp)(p>=1),t.edgeResolutions[n]=p,d!==p&&this._markEdgeResolutionDirty(n)}for(let s=0;s<4;++s){const n=e.findNeighborTile(eg.cA[s],i);t.cornerPeerNeighbors[s]=n;const a=Wg(e,r[s]),o=Wg(e,r[(s+1)%4]),l=Wg(e,n);jg[s]=l,jg[(s+1)%4]=o,jg[(s+2)%4]=e,jg[(s+3)%4]=a,(0,eg.Fp)(jg.some((t=>t?.loaded||t===e)));const c=jg.reduce(((e,t)=>Math.min(e,t?.level??1/0)),1/0);jg.forEach(((e,t)=>{e&&e?.level>c&&(jg[t]=null)})),(0,eg.Fp)(jg.some((t=>t?.loaded||t===e)));const h=t.cornerNeighborCornerTiles,u=t.cornerNeighborCornerTileSamplerVersions;for(let e=0;e<4;++e){const t=jg[e],i=t?.renderData.geometryState.samplerDataVersion??-1,r=4*s+e,n=h[r]!==t,a=!n&&u[r]!==i;(n||a)&&(h[r]=t,u[r]=i,this._markCornerDirty(s))}eg.T9&&(0,eg.Fp)(ty.some((t=>h[4*s+t]?.loaded||h[4*s+t]===e)))}eg.T9&&(0,eg.Fp)(this.geometryState.edgeResolutions.every((e=>e>0)));for(let e=0;e<4;++e)jg[e]=null}_updateGeometry(e){if(!this.tile.intersectsClippingArea)return;eg.T9&&(0,eg.Fp)(!this.tile.intersectsClippingArea||this.geometryState.edgeResolutions.every((e=>e>0))),this.intersectionData=null;const{tile:t,_vao:i,geometry:r,geometryState:s}=this,n=!i||this.wireframeChanged||this.samplerDataChanged||this.clippingAreaChanged||this.numVerticesPerSideChanged,a=0!==this.dirtyEdgeResolutions,o=s.edgeResolutions.reduce(((e,t)=>e+t+1),0),l=n||a&&o>(r?.maxEdgeVertexCount??0),c=!l&&a,h=!c&&(0!==this.dirtyEdges||a),u=!h&&0!==this.dirtyCorners;l?(this.releaseGeometry(),this._createGeometry(e)):c?t.updateEdgeElevationsAndResolutions():h||u?t.updateEdgeElevations():u?t.updateCornerElevations():console.warn("Update for no reason?"),this._modifiedFlags=0}get hasGeometry(){return this._hasGeometry}releaseGeometry(){return this._hasGeometry=!1,this.intersectionData=null,!!this._vao&&(this._vao=(0,f.M2)(this._vao),this.geometry.release(),!0)}ensureTexture(e,t,i,r){const s=t?Ir.VI.RGBA:Ir.VI.RGB;return null!=this._texture&&(i===ng.Ns.FADING&&this._tile.surface.fadeDuration>0&&this._isTextureVisible(this._texture)||this._texture.descriptor.width!==e||this._texture.descriptor.pixelFormat!==s)&&this.releaseTexture(),null==this._texture&&(this._texture=r(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){this._texture&&(this._texture=(0,f.RY)(this._texture),this.tile.setMemoryDirty())}reuseTexture(e,t){return!(!e||!this._texture||(e.setTextureReference(new Og(this._texture,ng.Ns.FADING,t,this._textureOpacity,0,1)),0))}get numVerticesPerSideChanged(){return 0!=(this._modifiedFlags&$g)}get samplerDataChanged(){return 0!=(this._modifiedFlags&Xg)}get clippingAreaChanged(){return 0!=(this._modifiedFlags&Yg)}get wireframeChanged(){return 0!=(this._modifiedFlags&Qg)}get dirtyEdges(){return this._modifiedFlags>>Kg&15}get dirtyCorners(){return this._modifiedFlags>>Jg&15}get dirtyEdgeResolutions(){return this._modifiedFlags>>ey&15}_markCornerDirty(e){const t=1<<e<<Jg;this._modifiedFlags|=t}_markEdgeDirty(e){const t=1<<e<<Kg;this._modifiedFlags|=t,this._markCornerDirty((e+0)%4),this._markCornerDirty((e+3)%4)}_markEdgeResolutionDirty(e){const t=1<<e<<ey;this._modifiedFlags|=t,this._markEdgeDirty(e)}_markAllEdgesAndCornersDirty(){this._modifiedFlags|=15<<Jg|15<<Kg|15<<ey}updateGeometryState(){const e=this._elevationInfo,t=this.tile,i=e.samplerData?t.getElevationVerticesPerSide(e.maxTileLevel):t.minimumVerticesPerSide,r=Math.max(i,5);let s=t.clippingArea;t.intersectsClippingArea&&!t.withinClippingArea||(s=null);const n=this.geometryState;let a=!1;n.numVerticesPerSide!==r&&(this._modifiedFlags|=1,n.numVerticesPerSide=r,n.samplerDataVersion++,a=!0),e.changed&&(this._modifiedFlags|=2,n.samplerData=e.samplerData,n.samplerDataVersion++,a=!0),(0,St.fS)(n.clippingArea,s)||(this._modifiedFlags=4,n.clippingArea=s,a=!0);const o=t.surface.wireframe;return n.wireframe!==o&&(this._modifiedFlags=8,n.wireframe=o,a=!0),this._geometryStateChangedSinceLastUpdate||=a,a&&this._markAllEdgesAndCornersDirty(),this._hasGeometry=!0,this._geometryStateChangedSinceLastUpdate}_createGeometry(e){this.tile.createGeometry();const t=this.geometry.vertexAttributes,i=this.geometry.indices,r=e.gl;this._vao=new hs.U(e,Ug,new Map([["geometry",(0,ss.K)(t.layout)]]),new Map([["geometry",us.f.createVertex(e,r.STATIC_DRAW,t.buffer)]]),us.f.createIndex(e,r.STATIC_DRAW,i)),this._hasGeometry=!0}get vao(){return this._vao}setTextureReference(e,t=Eg.Immediate){e?.texture===this._texture?this._textureOpacity=e.opacities[0]:this.releaseTexture(),this._textureRef.push(e,t)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_isTextureVisible(e){return this._textureRef.current?.texture===e||this._textureRef.next?.texture===e&&this._textureRef.fadeFactor<1}get _elevationInfo(){const e=this.geometryState.samplerData,t=this.tile.layerInfo[d_.ELEVATION],i=t.length,r=new Array(i);let s=0,n=0,a=!1;for(let o=0;o<i;o++){const i=t[o],l=i.upsampleInfo?.tile;if(l){const t=l.layerInfo[d_.ELEVATION][o].data,i=t&&t.samplerData;e&&e[s]===i||(a=!0),r[s++]=i,n=Math.max(n,l.lij[0])}else if(i.data){const t=this.tile.surface.layerViewByIndex(o,d_.ELEVATION);if((0,Ig.W4)(this.tile,t)){const t=i.data;e&&e[s]===t.samplerData||(a=!0),r[s++]=t.samplerData,n=this.tile.level}}}null!=e&&e.length!==s&&(a=!0);const o=s>0,l=o?r:null;return o&&(r.length=s),{changed:a,samplerData:l,maxTileLevel:n}}get estimatedGeometryMemoryUsage(){const e=this.intersectionData?.estimatedMemoryUsage??0;return(this.geometry.indices?.byteLength??0)+(this.geometry.vertexAttributes?.byteLength??0)+e}get texture(){return this._texture}get test(){}checkGeometryWaterproofness(){if(!eg.T9)return;const e=this.tile;if(!e.loaded||!e.intersectsClippingArea||0===e.level)return void(0,eg.Fp)(e?.loaded);const t=e.surface.extent;if(null!=t&&!e.intersectsExtent(t))return;const i=eg.OC.map(((i,r)=>null!=t&&(r<2?-1:1)*(e.extent[3-r]-t[3-r])<0)),r=e.level;(0,eg.Fp)(0===this.dirtyCorners),(0,eg.Fp)(0===this.dirtyEdges),(0,eg.Fp)(0===this.dirtyEdgeResolutions),(0,eg.Fp)(!this.numVerticesPerSideChanged),(0,eg.Fp)(!this.samplerDataChanged),(0,eg.Fp)(!this.clippingAreaChanged),(0,eg.Fp)(!this.wireframeChanged);const s=eg.cA.map((t=>e.findNeighborCornerTileExact(t,(t=>!t.intersectsClippingArea||t.loaded||t.level===e.level))??null)).map((e=>e?.intersectsClippingArea?e:null)),n=this.geometryState;for(let t=0;t<4;++t){const i=n.cornerPeerNeighbors[t],r=s[t];(0,eg.Fp)(r===i,`Tile[${e.lij}].corner[${t}] out of date: cur=[${i?.lij}] exp=[${r?.lij}]`)}eg.OC.forEach(((t,s)=>{if(i[s])return;const n=e.findNeighborTile(t,(e=>(e.level===r||e?.loaded)&&e?.intersectsClippingArea));if(!n){const i=!e.surface.updatingRootTiles&&null!=e.surface.rootTiles&&e.surface.rootTiles.length>0&&e.shouldHaveNeighbor(t);return void(0,eg.Fp)(!i)}(0,eg.Fp)(n.loaded||n.level===e.level),(0,eg.Fp)(n===this.geometryState.edgePeerNeighbors[s]);const a=r-n.level;if(!n.loaded)return(0,eg.Fp)(!n.leaf),void(0,eg.Fp)(0===a);const o=n.renderData;(0,eg.Fp)(e.isEdgeNeighbor(n,t)),(0,eg.Fp)(a>=0);const l=2**a;if(a<0)return void(0,eg.Fp)(!1);const c=e.renderData,h=c.geometry,u=c.localOrigin,d=h.getEdgeCount(s),p=h.numVerticesPerSide-1,m=o.geometry;if(!m)return void(0,eg.Fp)(!1);const _=o.localOrigin,f=this.geometryState.edgePeerNeighbors[s];if(f?.loaded){const e=f.renderData;(0,eg.Fp)(c.geometryState.edgePeerNeighborSamplerVersions[s]===e.geometryState.samplerDataVersion),(0,eg.Fp)(this.geometryState.edgePeerNeighborSamplerVersions[s]===e.geometryState.samplerDataVersion)}const g=(s+2)%4,y=m.getEdgeCount(g),v=d-1,b=y-1;(0,eg.Fp)(v*l===b,`Tile[${e.lij}]:e${s},res=${v} edgeRes mismatch with Neighbor[${n.lij}]:e${g},res=${b} (expected:${v*l})`);const w=e.extent,C=t===Sg.X.NORTH||t===Sg.X.SOUTH,x=y-1,T=x>>a,S=d-1;if(T<1)return void(0,eg.Fp)(1===S);(0,eg.Fp)(T===S),(0,eg.Fp)((0,jt.wt)(T));const M=m.numVerticesPerSide-1;(0,eg.Fp)(a>0||T===Math.max(M,p));const E=e.getNeighborEdgeStartVertexIndex(s,n);(0,eg.Fp)(0<=E&&E<l);const R=E*T;(0,eg.Fp)(0<=R&&R<=x-T);let P=0,A=R;h.getEdgeVertexPosition(s,Vg,u,0),h.getEdgeVertexPosition(s,kg,u,d-1);const D=(0,mr.j)(Vg,kg),I=Math.max(Zg,1e-4*D);for(let i=0;i<=T;++i){h.getEdgeVertexPosition(s,Vg,u,P),m.getEdgeVertexPosition(g,kg,_,A);const r=i/T,a=C?w[0]+r*(w[2]-w[0]):t===Sg.X.WEST?w[0]:w[2],l=C?t===Sg.X.SOUTH?w[1]:w[3]:w[1]+r*(w[3]-w[1]),p=e.surface.extent;if(null==p||(0,V.jE)(p,a,l)){const t=(0,mr.F)(Vg,kg),i=(0,mr.H)(Vg)-ir.sv.radius,r=(0,mr.H)(kg)-ir.sv.radius,f=t<I;if(!f){console.warn(`Tile edge vertex position mismatch: between [${e.lij}].edge${s}[${P}/${d}] and [${n.lij}].edge${g}[${A}/${y}]`),null!=p&&console.warn("  surface extent= ",p," x,y=",a,",",l);const v=(0,O.Ue)();(0,mr.d)(v,c.localOrigin,o.localOrigin),(0,mr.H)(v)>0&&console.warn(`   localOrigins: ${c.localOrigin} vs ${o.localOrigin} d=${(0,mr.H)(v)} [${v}]`),(()=>{const t=(0,O.d9)(Vg),i=(0,O.d9)(kg);e.updateEdgeElevations(),n.updateEdgeElevations(),h.getEdgeVertexPosition(s,Vg,u,P),m.getEdgeVertexPosition(g,kg,_,A);const r=(0,O.Ue)();(0,mr.a)(r,Vg,t),(0,mr.H)(r)>0&&console.warn(`  XXX Tile[${e.lij}] edge out of date: ${t} vs ${Vg} d=${(0,mr.H)(r)} [${r}]`),(0,mr.a)(r,kg,i),(0,mr.H)(r)>0&&console.warn(`  XXX Neighbor[${n.lij}] edge out of date: ${i} vs ${kg} d=${(0,mr.H)(r)} [${r}]`)})();const b=h.getEdgeCount(s),w=m.getEdgeCount(y);(0,eg.Fp)(f,`Mismatch in tile [${e.lij}].edge[${s}][${P}/${b}] vs neighbor [${n.lij}].edge[${g}][${A}/${w}] ${(0,eg.zT)(Vg)} vs ${(0,eg.zT)(kg)}  dist=${t} h(t|n|d)=${i}|${r}|${r-i}`)}h.getEdgeNormal(s,Bg,P),m.getEdgeNormal(g,zg,A),(0,mr.n)(Gg,Bg),(0,mr.n)(qg,zg);const v=(0,mr.e)(Gg,qg),b=1-v<.01||e===n;if(!b){const t=(0,O.Ue)();(0,mr.a)(t,Bg,zg);const i=()=>`Mismatch in tile edge normal ${(0,eg.sP)(e.lij)} (${P}/${d-1}) edge ${s} vs neighbor ${(0,eg.sP)(n.lij)}  (${A}/${y-1}) nedge ${g} :${(0,eg.zT)(Bg)} vs ${(0,eg.zT)(zg)}  dot = ${v} : ${(0,eg.zT)(t)}`;console.warn("Mismatch in tile edge normal: ",i());{e.updateEdgeElevations(),n.updateEdgeElevations();const t=(0,O.Ue)(),i=(0,O.Ue)();h.getEdgeNormal(s,t,P),m.getEdgeNormal(g,i,A),(0,mr.G)(Bg,t)||console.warn("Missing update in tile normal: ",(0,eg.zT)(Bg)," => ",(0,eg.zT)(t)),(0,mr.G)(zg,i)||console.warn("Missing update in neighbor normal: ",(0,eg.zT)(zg)," => ",(0,eg.zT)(i))}(0,eg.Fp)(b,i())}}P+=1,A+=1}}))}}const Vg=(0,O.Ue)(),kg=(0,O.Ue)(),Bg=(0,O.Ue)(),zg=(0,O.Ue)(),Gg=(0,O.Ue)(),qg=(0,O.Ue)(),Zg=1,jg=[null,null,null,null];function Wg(e,t){return t?.loaded||t===e?t:null}const $g=1,Xg=2,Yg=4,Qg=8,Kg=4,Jg=8,ey=12,ty=[0,1,2,3];class iy{get updating(){return!!this._tileRequested}init(e,t,i,r){this.tile=e,this._layerIdx=t,this._layerClass=i,this._suspended=r,this._tileLayerInfo=e.getLayerInfo(t,i),this._tileRequested=null;const s=this._findAncestorWithData();this._setUpsampleTile(s)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e,t){this._setUpsampleTile(e,t),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass,ng.Ns.FADING,t):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return null!=e?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){const e=this._layerIdx,t=this._layerClass,i=this.tile.surface.layerViewByIndex(e,t),{minLevel:r,maxLevel:s}=i.dataLevelRange,n=this._desiredMinLevelDelta,a=this._progressiveLevelModulo+n,o=this._scaleRangeEnabled?Ig.W4:()=>!0;let l=this.tile;const c=l.level;let h;const u=this._tileLayerInfo.upsampleInfo,d=u?.tile?.level??-1,p=null!=u&&d-c>=n,m=(0,Ig.Ay)(i),_="vector-tile-3d"===i.type?i.schemaHelper:null;for(;l&&o(l,i)&&l.level>=r;){const i=l.level,o=c-i,u=l.layerInfo[t][e];if(u.data&&o>=n){(!p||i>d)&&this._setUpsampleTile(l),u.dataInvalidated&&(h=l);break}const f=_?.getLevelRowColumn(l.lij)??l.lij;if("unavailable"!==m?.getAvailability(f[0],f[1],f[2])&&i<=s&&!u.data&&!u.dataMissing&&((!h||l.level===r||i%ce.GZ==0||c-h.level<n)&&(h=l),o>=a))break;l=l.parent}if(null!=h&&c-h.level<n)if(u)h=null;else{const i=this._findAncestorWithData();null!=i&&(this._setUpsampleTile(i),h=i.layerInfo[t][e].dataInvalidated?i:null)}return h}_findAncestorWithData(){const e=this.tile.elevationLevel,t=this._desiredMinLevelDelta;let i;for(let r=this.tile;r;r=r.parent)if(r.hasLayerData(this._layerIdx,this._layerClass)){if(e-r.level>=t)return r;i=r}return i}_setUpsampleTile(e,t){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass,ng.Ns.FADING,t)}get test(){}}const ry=new Error("Abstract method called on TileAgent"),sy=new class extends iy{constructor(){super(...arguments),this.type="none"}get _desiredMinLevelDelta(){throw ry}get _progressiveLevelModulo(){throw ry}dispose(){}};var ny;!function(e){e[e.INSIDE=0]="INSIDE",e[e.INTERSECTS=1]="INTERSECTS",e[e.OUTSIDE=2]="OUTSIDE"}(ny||(ny={}));class ay{constructor(){this.waitingAgents=new ud.Z,this.pendingUpdates=0}static acquire(e){const t=oy.acquire();return t._init(e),t}release(){this.dispose(),ly.delete(this),oy.release(this)}dispose(){this.loadingAgent=(0,f.M2)(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=(0,eg.ep)(this._data)}static prune(){oy.prune(0)}_init(e){this.waitingAgents.clear(),this._data=(0,eg.ep)(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=e,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=(0,f.IM)(this.requestAbort),this.requestPromise=null}_unsetUpsampleInfo(){this.upsampleInfo&&(this.upsampleInfo.tile?.unrefMapData(),this._pool.release(this.upsampleInfo),this.upsampleInfo=null)}setUpsampleInfo(e,t){if(e!==t&&null!=t){if(null==this.upsampleInfo)this.upsampleInfo=this._pool.acquire();else{if(this.upsampleInfo.tile===t)return;this.upsampleInfo.tile?.unrefMapData()}t.refMapData(),(0,Ig.QT)(e,t,this.upsampleInfo)}else this._unsetUpsampleInfo()}get data(){return this._data}set data(e){(0,eg.ep)(this._data),this._data=e}}const oy=new qf.Z(ay,null,(()=>{})),ly=new Map;var cy;!function(e){e[e.NONE=0]="NONE",e[e.SPLIT=1]="SPLIT",e[e.ELEVATION=2]="ELEVATION",e[e.MERGE=4]="MERGE",e[e.GEOMETRY=8]="GEOMETRY",e[e.TEXTURE_NOFADING=16]="TEXTURE_NOFADING",e[e.TEXTURE_FADING=32]="TEXTURE_FADING"}(cy||(cy={}));class hy{constructor(){this._lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this._dirty=!0,this._previouslyRendered=!1,this.extent=(0,V.Ue)(),this._elevationBoundsMin=NaN,this._elevationBoundsMax=0,this.layerInfo=[[],[]],this.extentInRadians=(0,V.Ue)(),this.centerAtSeaLevel=(0,O.Ue)(),this._center=[(0,O.Ue)(),(0,Nn.c)(),(0,O.Ue)()],this.up=(0,O.tN)(),this._withinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=0,this._rasterTileMemory=0,this._vectorTileMemory=0,this._mapDataRefCount=0,this.screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0,this.onCompressionFinished=()=>{this.setPendingUpdate(cy.TEXTURE_NOFADING),this.setMemoryDirty()},this.extentMidX=0,this.extentMidY=0,this.distanceToPOI=-1,this._lastPOI=(0,O.Ue)(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0}get lij(){return this._lij}get spatialReference(){return this._surface.spatialReference??this._surface.tilingScheme.spatialReference}get elevationLevelDelta(){return this._surface.getElevationLevelDelta(this.level)}static prune(){py.prune(0),my.prune(0),ay.prune()}get _cached(){return!this.leaf&&this._mapDataRefCount<=0}get withinClippingArea(){return this._withinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBoundsMin(){return this._elevationBoundsMin}get elevationBoundsMax(){return this._elevationBoundsMax}get level(){return this._lij[0]}get key(){return`${this._lij[0]}/${this._lij[1]}/${this._lij[2]}`}get edgeLen(){return this._edgeLen}get radius(){return this._center[fy.MIDDLE][3]}get visible(){return this._dirty&&this.computeVisibility(),this._visible}get frustumVisibility(){return this._dirty&&this.computeVisibility(),this._frustumVisibility}computeVisibility(){this._dirty=!1;const e=this.parent?.frustumVisibility??ny.INTERSECTS;this._frustumVisibility=e===ny.INSIDE?ny.INSIDE:e===ny.OUTSIDE?ny.OUTSIDE:this._calculateFrustumVisibility(this.surface.frustum);const t=this._frustumVisibility!==ny.OUTSIDE&&this._intersectsClippingArea;t!==this._visible&&(this._visible=t,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setDirty(),this.updateAgentSuspension())}get _loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setDirty()),e}init(e,t,i,r,s){this._lij[0]=e,this._lij[1]=t,this._lij[2]=i,this.ellipsoid=(0,vr.Iu)(s.tilingScheme.spatialReference),s.tilingScheme.getExtent(e,t,i,this.extent),s.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this.extentMidX=.5*(this.extent[0]+this.extent[2]),this.extentMidY=.5*(this.extent[1]+this.extent[3]),this._withinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,s.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[fy.MIDDLE][3]=0,this.elevationLevel=e,r&&!Number.isNaN(r.elevationBoundsMin)?(this._elevationBoundsMin=r.elevationBoundsMin,this._elevationBoundsMax=r.elevationBoundsMax):(this._elevationBoundsMin=0,this._elevationBoundsMax=0),this._pendingUpdates=0,this.renderData=null,this.screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=r,this.clearChildren(),this._surface=s,this.updateVisibility(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0;for(const e of m_){const t=s.numLayers(e),i=this.layerInfo[e];for(const e of i)e.release();i.length=t;for(let r=0;r<t;r++)i[r]=ay.acquire(this._surface.upsampleInfoPool),e===d_.ELEVATION&&this.findElevationBoundsForLayer(r,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(s.tilingScheme.pixelSize,ce.Cf)}dispose(){null!=this._surface&&((0,eg.wu)(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(this.key),this.layerInfo.forEach((e=>{e.forEach((e=>e.release())),e.length=0})),this._surface=this._parent=null,this.clearChildren(),this.setMemoryDirty())}refMapData(){++this._mapDataRefCount,this._cached||this._surface.upsampleMapCache.pop(this.key)}unrefMapData(){--this._mapDataRefCount,this._cached&&this.cachedMemory>0&&this._surface.upsampleMapCache.put(this.key,this)}setMemoryDirty(){this._usedMemory=0}get usedMemory(){return this._ensureUsedMemory()+(this._cached?0:this._mapTileMemory)}get cachedMemory(){return this._ensureUsedMemory(),null==this._surface?this.usedMemory:this._cached?this._mapTileMemory:0}get _mapTileMemory(){return this._rasterTileMemory+this._vectorTileMemory}get _cpuImageMemorySize(){const e=this._surface.tilingScheme.pixelSize;return e*e*4}_ensureUsedMemory(){if(this._usedMemory>0)return this._vectorTileMemory=this.layerInfo[d_.MAP].reduce(((e,{data:t})=>e+((0,L_.AK)(t)?t.usedMemoryPerReference:0)),0),this._usedMemory;this._usedMemory=this._baseUsedMemory,this._rasterTileMemory=0,this._vectorTileMemory=0;for(const{data:e}of this.layerInfo[d_.MAP])(0,L_.AK)(e)?this._vectorTileMemory+=e.usedMemoryPerReference:this._rasterTileMemory+=this.getTerrainDataMemory(e);for(const e of this.layerInfo[d_.ELEVATION])this._usedMemory+=e.data?this._cpuImageMemorySize:0;return this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._rasterTileMemory+=this.renderData.texture?.cachedMemory??0),this._cached&&this._surface.upsampleMapCache.updateSize(this.key,this),this._usedMemory}getUsedMemoryForLayer(e,t){const i=this.layerInfo[e][t];return i?.data?e===d_.MAP?this._cached?0:this.getTerrainDataMemory(i.data):e===d_.ELEVATION?this._cpuImageMemorySize:0:0}getTerrainDataMemory(e){return(0,L_.Q_)(e)?e.texture.usedMemory:(0,L_.yd)(e)?e.memoryUsage:(0,L_.AK)(e)?e.usedMemoryPerReference:(0,L_.Cm)(e)||e instanceof HTMLImageElement?this._cpuImageMemorySize:0}updateScreenDepth(e){const t=this._center[fy.MIDDLE],i=e,r=t[0],s=t[1],n=t[2],a=i[2]*r+i[6]*s+i[10]*n+i[14];this.screenDepth=a<0?0:a/(i[3]*r+i[7]*s+i[11]*n+i[15])}shouldSplit(e,t,i){if(!this.visible)return cy.NONE;if(e.frustum&&(!this._intersectsClippingArea||this._calculateFrustumVisibility(e.frustum)===ny.OUTSIDE))return cy.NONE;const r=this.level;(0,mr.d)(Cy,(0,Nn.a)(this._center[fy.MIDDLE]),t);let s=(0,mr.k)(Cy),n=Cy,a=(0,Nn.a)(this._center[fy.MIDDLE]);(0,mr.d)(xy,this._center[fy.TOP],t);const o=(0,mr.k)(xy);o<s&&(s=o,n=xy,a=this._center[fy.TOP]),(0,mr.d)(Ty,this._center[fy.BOTTOM],t);const l=(0,mr.k)(Ty);if(l<s&&(s=l,n=Ty,a=this._center[fy.BOTTOM]),this._edgeLen2>s&&r<e.maxLod)return cy.SPLIT;const c=Math.sqrt(s),h=e.fovX*c*2,u=this._edgeLen/h,d=()=>{if(r<e.maxLod)return this.elevationLevel=r,cy.NONE;const t=r+Math.ceil(-Math.log2(e.relativeWidthLimit/u));return t!==this.elevationLevel?(this.elevationLevel=t,cy.ELEVATION):cy.NONE},p=null!=i?i-r:1/0;if(p<=.5)return d();const m=(0,mr.e)(this.up,Cy),_=this._elevationBoundsMax-this._elevationBoundsMin,f=_/this.edgeLen;if(e.aboveGround&&m>0&&f<.001&&m/c-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-f>0)return cy.NONE;const g=null!=i?3-Math.min(p,2):1;if(u*g<e.relativeWidthLimit||r>=e.maxLod)return d();if(r<7)return cy.SPLIT;(0,mr.g)(Sy,this.up,m),(0,mr.d)(Sy,Sy,n);const y=(0,mr.k)(Sy);if(y<=this.radius*this.radius)return cy.SPLIT;(0,mr.g)(Sy,Sy,this.radius/Math.sqrt(y)),(0,mr.f)(Sy,Sy,a),(0,mr.d)(Sy,t,Sy);const v=Math.min(1,(Math.abs((0,mr.e)(Sy,this.up))+.5*_+this._curvatureHeight)/(0,mr.l)(Sy)),b=.1/e.angledSplitBias,w=e.fovY*c*2;return v*(this._edgeLen/w*g)<b*e.relativeHeightLimit?cy.NONE:cy.SPLIT}createChildren(){const e=this._children,t=this.lij[0]+1,i=2*this.lij[1],r=2*this.lij[2];return e[0]=this.surface.createTile(t,i,r,this),e[1]=this.surface.createTile(t,i,r+1,this),e[2]=this.surface.createTile(t,i+1,r,this),e[3]=this.surface.createTile(t,i+1,r+1,this),e}clearChildren(){this._children[0]=this._children[1]=this._children[2]=this._children[3]=null}get loaded(){return this.renderData?.hasGeometry??!1}load(){this.refMapData();for(const e of m_)this._createOrUpdateAgents(0,e);this.surface.renderer.loadTile(this)}unload(){this.renderData&&this.unrefMapData(),this.surface.renderer.unloadTile(this);for(const e of m_){const t=this.layerInfo[e];for(const e of t)e.loadingAgent&&e.loadingAgent!==sy&&(dy(e.loadingAgent),e.loadingAgent=null),e.pendingUpdates=0}this.resetPendingUpdate(cy.GEOMETRY),this.resetPendingUpdate(cy.TEXTURE_NOFADING),this.resetPendingUpdate(cy.TEXTURE_FADING)}unloadMapData(){const e=this.layerInfo[d_.MAP];for(const t of e)t.loadingAgent&&t.loadingAgent!==sy&&(dy(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0,t.invalidateSourceData();this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(e){if((0,V.fS)(e,this._clippingArea))return!1;const t=this._intersectsClippingArea,i=this._withinClippingArea;null!=e?(this._intersectsClippingArea=this.intersectsExtent(e),this._withinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._withinClippingArea=!0),this._clippingArea=e,this.updateVisibility();const r=i&&this._withinClippingArea,s=!(i||t||this._withinClippingArea||this._intersectsClippingArea);return!this.renderData||r||s||this.setPendingUpdate(cy.GEOMETRY),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(e,t){return this.layerInfo[t][e]}hasLayerData(e,t){const i=this.layerInfo[t][e];return!(!i?.data||i.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(const e of m_){const t=this.layerInfo[e];for(const e of t)if(e.loadingAgent&&e.loadingAgent!==sy&&e.loadingAgent.updating)return!0}return!1}_isSuspended(e){return!!this.hasPendingUpdate(cy.SPLIT)||e!==d_.ELEVATION&&!this._loadable}get hasPendingUpdates(){return 0!==this._pendingUpdates}hasPendingUpdate(e){return(this._pendingUpdates&e)===e}setPendingUpdate(e){const t=this._pendingUpdates;return this._pendingUpdates|=e,e===cy.SPLIT||e===cy.MERGE?this._surface.setTileTreeDirty():this._surface.requestUpdate(),t!==this._pendingUpdates}resetPendingUpdate(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}requestLayerData(e,t,i){const r=this.layerInfo[t][e];if(r.waitingAgents.has(i))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),i.tile.lij.toString(),t,e),!0;if(r.waitingAgents.push(i),r.data&&!r.dataInvalidated){console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),i.tile.lij.toString(),t,e);const s=(0,L_.AK)(r.data);return i.dataArrived(this,s),!0}if(r.requestPromise)return!0;(0,f.IM)(r.requestAbort),r.requestAbort=new AbortController;const s=this._surface.requestTileData(this,e,t,r.requestAbort);if(!s)return r.requestAbort=null,!1;const n=()=>{r.requestPromise===s&&(r.requestPromise=null,r.requestAbort=null)};return r.requestPromise=s,s.then(n,n),!0}get leaf(){return null==this._children[0]}hasLij(e){return this._lij[0]===e[0]&&this._lij[1]===e[1]&&this._lij[2]===e[2]}findByLij(e){if(this.hasLij(e))return this;const t=this._children;return t[0]?t[0].findByLij(e)||t[1].findByLij(e)||t[2].findByLij(e)||t[3].findByLij(e):null}distanceToSquared(e){return(0,mr.k)((0,mr.d)(Sy,(0,Nn.a)(this._center[fy.MIDDLE]),e))}containsPoint(e){const t=this.extent;return e[0]>=t[0]&&e[1]>=t[1]&&e[0]<=t[2]&&e[1]<=t[3]}containsPointXY(e,t){const i=this.extent;return e>=i[0]&&t>=i[1]&&e<=i[2]&&t<=i[3]}unrequestLayerData(e,t,i){const r=this.layerInfo[t][e],s=r.waitingAgents,n=null!=s.removeUnordered(i);(0,eg.wu)(n,"agent has not requested this piece of map data"),s.length<1&&(r.abortRequest(),this.setMemoryDirty())}dataArrived(e,t,i){const r=(0,L_.AK)(i),s=this.layerInfo[t][e];s.data=i,s.dataInvalidated=!1,s.waitingAgents.forAll((e=>e.dataArrived(this,r))),s.waitingAgents.clear(),this.setMemoryDirty()}dataMissing(e,t){const i=this.layerInfo[t][e];i.dataMissing=!0,i.waitingAgents.forAll((e=>e.dataMissing())),i.waitingAgents.clear(),this.setMemoryDirty()}updateRenderData(e,t,i){switch(i&&this.forEachLoadedNeighbor((i=>i.updateRenderData(e,t))),e){case d_.MAP:return this._updateTexture(t);case d_.ELEVATION:return this._updateGeometry()}}_updateTexture(e){this.renderData&&(this.resetPendingUpdate(e===ng.Ns.FADING?cy.TEXTURE_NOFADING:cy.TEXTURE_FADING),this.setPendingUpdate(e===ng.Ns.FADING?cy.TEXTURE_FADING:cy.TEXTURE_NOFADING))}_updateGeometry(){this.setPendingUpdate(cy.GEOMETRY);for(const e of this.layerInfo[d_.ELEVATION])e.pendingUpdates|=cy.GEOMETRY}invalidateLayerData(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)}computeElevationBounds(){const e=this._elevationBoundsMin,t=this._elevationBoundsMax;let i=1/0,r=-1/0;const s=this.layerInfo[d_.ELEVATION];let n=!0;for(const e of s)null!=e.elevationBounds&&(i=Math.min(i,e.elevationBounds.min),r=Math.max(r,e.elevationBounds.max),e.elevationBounds.hasNoDataValues||(n=!1));n&&(i=Math.min(i,0),r=Math.max(r,0)),e===i&&t===r||(this._elevationBoundsMin=i,this._elevationBoundsMax=r,this.updateRadiusAndCenter(),this._surface.setTileTreeDirty())}_updateCenter(){const e=this._elevationBoundsMin,t=this._elevationBoundsMax,i=.5*(e+t),r=this._center;(0,mr.g)(Sy,this.up,i),(0,mr.f)((0,Nn.a)(r[fy.MIDDLE]),this.centerAtSeaLevel,Sy),(0,mr.g)(Sy,this.up,e),(0,mr.f)(r[fy.TOP],this.centerAtSeaLevel,Sy),(0,mr.g)(Sy,this.up,t),(0,mr.f)(r[fy.BOTTOM],this.centerAtSeaLevel,Sy)}findElevationBoundsForLayer(e,t){const i=this.layerInfo[d_.ELEVATION][e],r=this.elevationLevelDelta,s=Math.max(this.elevationLevel-r,0),n=i.elevationBounds;if(null!=n&&n.level>=t&&n.level<=s)return;const a=this._surface.layerViewByIndex(e,d_.ELEVATION);if(!(0,Ig.W4)(this,a))return;const o=_y;let l=!1;const c=i.data;if(c&&c.level<=s){const e=i.data;o.min=e.samplerData.data.minValue,o.max=e.samplerData.data.maxValue,o.hasNoDataValues=e.samplerData.data.hasNoDataValues,o.level=this.level,l=!0}else{let t,i,n=0;for(let a=this._parent;a&&(!i||n<r)&&(n=this.elevationLevel-a.level,t=i||t,i=a.layerInfo[d_.ELEVATION][e].data,!(!i&&t&&a.level<=s));a=a.parent);i=i||t,i&&(i.computeMinMaxValue(this._lij[0],this._lij[1],this._lij[2],o),o.min!==1/0&&(o.level=i.level,l=!0))}l&&(null==i.elevationBounds&&(i.elevationBounds=new Xf),i.elevationBounds.copyFrom(o))}modifyLayers(e,t,i){const r=this.layerInfo[i];for(const e of r)e.loadingAgent&&e.loadingAgent!==sy&&(dy(e.loadingAgent),e.loadingAgent=null),e.waitingAgents.clear();for(let t=0;t<r.length;++t)void 0===e[t]&&r[t].release();const s=new Array(...r),n=t.length;r.length=n;for(let e=0;e<n;e++){const i=t[e];r[e]=i>-1?s[i]:ay.acquire(this._surface.upsampleInfoPool)}this.setMemoryDirty()}restartAgents(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e,ng.Ns.FADING))}updateAgents(e){if(this.renderData){const t=this.layerInfo[e];for(const e of t)e.loadingAgent===sy&&(e.loadingAgent=null);this._createOrUpdateAgents(0,e)}}updateAgentSuspension(){for(const e of m_){const t=this._isSuspended(e);for(const i of this.layerInfo[e])i.loadingAgent&&i.loadingAgent!==sy&&(i.loadingAgent.setSuspension(t),i.loadingAgent===sy&&this.updateRenderData(e,ng.Ns.FADING))}}removeLayerAgent(e,t){const i=this.layerInfo[t][e];i.loadingAgent&&i.loadingAgent!==sy&&i.loadingAgent.dispose(),i.loadingAgent=null}agentDone(e,t){const i=this.layerInfo[t][e];i.loadingAgent=sy,i.data||null!=i.upsampleInfo||this._createOrUpdateAgents(e+1,t)}_hasBlendableAncestor(e){return"normal"!==e.blendMode||(0,z.CY)(e.parent)&&this._hasBlendableAncestor(e.parent)}_hasBlendModes(e,t,i){for(let r=e;r<t;++r){const e=this._surface.layerViewByIndex(r,i);if((0,eg.TK)(e)&&"normal"!==e?.layer?.blendMode||(0,z.CY)(e?.layer?.parent)&&this._hasBlendableAncestor(e?.layer?.parent))return!0}return!1}_createOrUpdateAgents(e,t){const i=this.layerInfo[t];if(0===i.length)return;const r=this._isSuspended(t);for(let s=e;s<i.length;++s){const n=i[s],a=this._surface.layerViewByIndex(s,t);let o=!1;if(n.loadingAgent?(0,Ig.W4)(this,a)?(n.loadingAgent!==sy&&n.loadingAgent.setSuspension(r),n.loadingAgent!==sy&&(o=n.loadingAgent.update())):n.dispose():(0,Ig.W4)(this,a)&&(n.loadingAgent=uy(this,s,t,r),o=n.loadingAgent.startLoading(),o?n.loadingAgent===sy&&this.setPendingUpdate(cy.GEOMETRY):(dy(n.loadingAgent),n.loadingAgent=sy)),n.loadingAgent===sy&&this.updateRenderData(t,ng.Ns.FADING),!this._hasBlendModes(e,i.length,t)&&o&&a.isOpaque)return}}_isWithinExtent(e){const t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]}intersectsExtent(e){const t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]}getElevationVerticesPerSide(e){const t=this.elevationLevel-this.level,i=Math.max(this.level-e,this.elevationLevelDelta-t),r=(0,jt.uZ)(1+(this._maxTesselation>>i),2,this._maxTesselation+1),s=this.minimumVerticesPerSide;return Math.max(r,s)}_findLIJ(e,t){if(!e)return null;const i=this.surface.rootTiles;if(null!=i)for(const r of i)if(gy(r,e)){let i=r,s=e[0]-i.level-1;for(;s>=0&&!i.leaf&&!t(i);){const t=e[1]>>s&1,r=e[2]>>s&1;i=i.children[2*t+r],s--}return t(i)?i:null}return null}findNeighborTile(e,t){const i=this._lij,r=this._getNeighborLIJ(i,e);return r?yy(i,r)?t(this)?this:null:this._findLIJ(r,t):null}findCorner(e,t){const i=e===Sg.X.NORTH_EAST?1:e===Sg.X.NORTH_WEST?0:e===Sg.X.SOUTH_WEST?2:3;let r=this;for(;r.children[0]&&(!t||!t(r));)r=r.children[i];return r}findNeighborCornerTileExact(e,t){return this.findNeighborTile(e,(e=>t(e)||e.level===this.level))?.findCorner((0,eg.$v)(e),t)||null}forAllSubtreeOnSide(e,t){const i=e===Sg.X.NORTH?[0,1]:e===Sg.X.NORTH_EAST?[1]:e===Sg.X.EAST?[1,3]:e===Sg.X.SOUTH_EAST?[3]:e===Sg.X.SOUTH?[2,3]:e===Sg.X.SOUTH_WEST?[2]:e===Sg.X.WEST?[0,2]:[0],r=e=>{const s=e.children;!t(e)&&s[0]&&i.forEach((e=>r(s[e])))};r(this)}getNeighborEdgeStartVertexIndex(e,t){if(!t)return 0;const i=this.level-t.level;if((0,eg.Fp)(!eg.T9||i>=0),0===i)return 0;const r=2**i,s=!(1&~e),n=s?0:1,a=t.lij[n+1]*r,o=this._lij[n+1],l=o-a,c=s?r-1-l:l;return eg.T9&&((0,eg.Fp)(a<=o&&o<a+r),(0,eg.Fp)(0<=c&&c<r)),c}forEachLoadedNeighbor(e){const t=this.level,i=e=>e.level===t||e.loaded;eg.OC.forEach((t=>{const r=this.findNeighborTile(t,i);null!=r&&r!==this&&r.forAllSubtreeOnSide((0,eg._F)(t),(i=>!!i.loaded&&(e(i,t),!0)))})),eg.cA.forEach((t=>{const r=this.findNeighborTile(t,i)?.findCorner((0,eg.$v)(t),(e=>e.loaded));(0,eg.Fp)(!r||vy(this,r,t)),r?.loaded&&e(r,t)}))}_getNeighborLIJ(e,t){const i=(0,eg.Mw)(t)?-1:(0,eg.uv)(t)?1:0,r=(0,eg.OD)(t)?-1:(0,eg.Eu)(t)?1:0,s=[e[0],e[1]+i,e[2]+r];return s[1]<0?null:this.surface.isGlobal?this._wrapLIJ(s):s[2]<0?null:s}_wrapLIJ(e){return!e||e[1]<0||e[1]>=2**e[0]?null:this.surface.wrapEastWest(e)}isEdgeNeighbor(e,t){if(null==e)return!1;if(0===this.level&&0===e.level){if(this._eastEnd&&e._westEnd&&t===Sg.X.EAST)return!0;if(this._westEnd&&e._eastEnd&&t===Sg.X.WEST)return!0}const i=Math.max(1e-6*(this.extent[2]-this.extent[0]),1);switch(t){case Sg.X.NORTH:return(0,eg.Wq)(this.extent[3],e.extent[1],i);case Sg.X.SOUTH:return(0,eg.Wq)(this.extent[1],e.extent[3],i);case Sg.X.EAST:return(0,eg.Wq)(this.extent[2],e.extent[0],i)||(0,eg.Wq)(this.extent[2],-e.extent[0],i);case Sg.X.WEST:return(0,eg.Wq)(this.extent[0],e.extent[2],i)||(0,eg.Wq)(this.extent[0],-e.extent[2],i)}}get _eastEnd(){return this._lij[2]===this.surface.lijEastEnd(this.level)-1}get _westEnd(){return 0===this._lij[2]}checkGeometryWaterproofness(){eg.V0&&((0,eg.Fp)(this.loaded),this.renderData?.checkGeometryWaterproofness())}shouldHaveNeighbor(e){const t=this.extent,i=this.surface.rootTilesExtent,r=.25*(t[2]-t[0]);if((0,eg.Mw)(e)&&t[3]+r>=i[3])return!1;if((0,eg.uv)(e)&&t[1]-r<=i[1])return!1;const s=this.surface.isGlobal;return!(!s&&(0,eg.OD)(e)&&t[0]-r<=i[0]||!s&&(0,eg.Eu)(e)&&t[2]+r>=i[2])}updateDistanceToPOI(e){const t=this._lastPOI;if(this.distanceToPOI>=0&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return;(0,mr.c)(this._lastPOI,e);const i=this._center[fy.MIDDLE],r=e[0]-i[0],s=e[1]-i[1],n=e[2]-i[2];this.distanceToPOI=r*r+s*s+n*n}}function uy(e,t,i,r){const s=i===d_.ELEVATION?my.acquire():py.acquire();return s.init(e,t,i,r),s}function dy(e){e.dispose(),function(e){return"elevation"===e.type}(e)?my.release(e):function(e){return"map"===e.type}(e)&&py.release(e)}const py=new qf.Z(class extends iy{constructor(){super(),this.type="map",this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return ce.GZ}}),my=new qf.Z(class extends iy{constructor(){super(...arguments),this.type="elevation",this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return this.tile.elevationLevelDelta-(this.tile.elevationLevel-this.tile.level)}get _progressiveLevelModulo(){return 0}}),_y=new Xf;var fy;function gy(e,t){const i=e.lij,r=t[0]-i[0];return!(r<0)&&t[1]>>r===i[1]&&t[2]>>r===i[2]}function yy(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function vy(e,t,i){return null!=e&&null!=t&&t!==e&&(e.level>=t.level?by(e,t,i):by(t,e,(0,eg.$v)(i)))}function by(e,t,i){(0,eg.Fp)(e.level>=t.level);const r=(0,eg._0)(i),s=(0,eg.wt)(i),n=e.extent,a=t.extent,o=[r?n[0]:n[2],s?n[3]:n[1]],l=[r?a[2]:a[0],s?a[1]:a[3]],c=1e-5*(n[2]-n[0]),h=(0,eg.Wq)(o[0],l[0],c)||e.surface.isGlobal&&(0,eg.Wq)(o[0],-l[0],c),u=(0,eg.Wq)(o[1],l[1],c);if(h&&u)return!0;if(e.level===t.level)return(0,eg.Fp)(!1),!1;if(!h&&!u)return(0,eg.Fp)(!1),!1;const d=h?wy(a[1],a[3],n[1],n[3],c):wy(a[0],a[2],n[0],n[2],c);return(0,eg.Fp)(d),d}function wy(e,t,i,r,s){return e-s<=i&&i<=r&&r<=t+s}!function(e){e[e.TOP=0]="TOP",e[e.MIDDLE=1]="MIDDLE",e[e.BOTTOM=2]="BOTTOM"}(fy||(fy={}));const Cy=(0,O.Ue)(),xy=(0,O.Ue)(),Ty=(0,O.Ue)(),Sy=(0,O.Ue)();function My(e,t){const{tile:i,geometry:r,geometryState:s}=e,{extentInRadians:n,surface:a}=i,{isWebMercator:o,renderer:l}=a,{numVerticesPerSide:c,wireframe:h}=s,u=c-1,d=(c-2)**2,p=o&&(t===ng.tk.HAS_SOUTH_POLE||t===ng.tk.HAS_BOTH_POLES),m=o&&(t===ng.tk.HAS_NORTH_POLE||t===ng.tk.HAS_BOTH_POLES),_=((p?1:0)+(m?1:0))*nv*c,f=iv(s),g=d+_+4*f,y=l.tileGeometryCache.acquire(g);r.numVerticesPerSide=c,r.vertexAttributes=y,r.maxEdgeVertexCount=f;const{boundingBox:v}=r;(0,xg.cS)(v);const b=Oy(e);Xy.update(u,n,b),function(e){const{tile:t}=e;if(!t.intersectsClippingArea)return;const{geometry:i,geometryState:r,localOrigin:s}=e,{numVerticesPerSide:n,samplerData:a}=r,o=n-2,l=n-1,{vertexAttributes:c,boundingBox:h}=i,{position:u,uv0:d}=c,{typedBuffer:p,typedBufferStride:m}=c.normalCompressed,{extent:_}=t,f=_[0],g=_[2],y=_[1],v=_[3],b=t.ellipsoid.radius,w=s[0],C=s[1],x=s[2],T=u.typedBuffer,S=u.typedBufferStride,M=1/l;let E=0;if(1<=o){const e=M,t=y*(1-e)+v*e,i=Xy.sinLatLUT[1],r=Xy.cosLatLUT[1];for(let s=1;s<=o;s++){const n=s*M,o=f*(1-n)+g*n,l=Xy.sinLonLUT[s],c=Xy.cosLonLUT[s],u=b+Jf(o,t,a),p=u*c*r-w,m=u*l*r-C,_=u*i-x;tv(p,m,_,h);const y=(s-1)*S;T[y]=p,T[y+1]=m,T[y+2]=_,d.setValues(s-1,Math.round(n*Tg.rU),Math.round(e*Tg.rU))}}for(let e=1;e<=o;e++){const t=e*M,i=y*(1-t)+v*t,r=Xy.sinLatLUT[e],s=Xy.cosLatLUT[e],n=e+1,c=n*M,u=y*(1-c)+v*c,_=Xy.sinLatLUT[n],R=Xy.cosLatLUT[n],P=Xy.sinLonLUT[0],A=Xy.cosLonLUT[0],O=b+Jf(f,i,a);let D=A*s*O-w,I=P*s*O-C,L=r*O-x;const F=E*S;let N=T[F],U=T[F+1],H=T[F+2];for(let t=1;t<=o;t++){const n=t*M,v=f*(1-n)+g*n,P=Xy.sinLonLUT[t],A=Xy.cosLonLUT[t];let O=0,F=0,V=0;if(t<o){const e=(E+1)*S;O=T[e],F=T[e+1],V=T[e+2]}else{const e=Xy.sinLonLUT[l],t=Xy.cosLonLUT[l],n=b+Jf(g,i,a);O=t*s*n-w,F=e*s*n-C,V=r*n-x}const k=D,B=I,z=L;D=N,I=U,L=H,N=O,U=F,H=V;const G=O-k,q=F-B,Z=V-z;let j=0,W=0,$=0;if(e>1){const e=(E-o)*S;j=T[e],W=T[e+1],$=T[e+2]}else{const e=Xy.sinLatLUT[0],t=Xy.cosLatLUT[0],i=b+Jf(v,y,a);j=A*t*i-w,W=P*t*i-C,$=e*i-x}const X=b+Jf(v,u,a),Y=A*R*X-w,Q=P*R*X-C,K=_*X-x;if(e<o){const e=E+o,t=e*S;T[t]=Y,T[t+1]=Q,T[t+2]=K,tv(Y,Q,K,h),d.setValues(e,Math.round(n*Tg.rU),Math.round(c*Tg.rU))}const J=j-Y,ee=W-Q,te=$-K;let ie=A*s,re=P*s,se=r;se*se<.999&&(ie=Z*ee-q*te,re=G*te-Z*J,se=q*J-G*ee);const ne=1/Math.sqrt(ie*ie+re*re+se*se);(0,Rg.hd)(p,E,ie*ne,re*ne,se*ne,m),++E}}}(e),r.poleVerticesStartIndex=d;const w=function(e,t,i){const{tile:r,localOrigin:s,geometry:n}=e,{extent:a,ellipsoid:o}=r,{boundingBox:l,numVerticesPerSide:c,vertexAttributes:h,poleVerticesStartIndex:u}=n,d=c-1,p=s[0],m=s[1],_=s[2],f=o.radius,g=a[1],y=a[3],v=[];let b=u;const w=(e,t)=>{const i=t*c;tv(-p,-m,e*f-_,l),v.push(new Wy(1===e,i,1===e?0:2,b,nv));const r=Ay(-1===e?g:y,f),s=e*Math.PI/2-r,n=.99*(1===e?1:-1),a=f+0,{position:o,uv0:u}=h,{typedBuffer:w,typedBufferStride:C}=h.normalCompressed;for(let e=1;e<=nv;++e){const t=r+s*(e/nv),i=Math.cos(t),c=Math.sin(t);for(let e=0;e<=d;e++){const t=e/d,r=Xy.sinLonLUT[e],s=Xy.cosLonLUT[e]*i,h=r*i,f=c,g=s*a-p,y=h*a-m,v=f*a-_;tv(g,y,v,l),o.setValues(b,g,y,v),u.setValues(b,Math.round(t*Tg.rU),Math.round(n*Tg.rU)),(0,Rg.hd)(w,b,s,h,f,C),++b}}};return t&&w(-1,0),i&&w(1,d),v}(e,p,m);r.edgeVerticesStartIndex=d+_,ky(e),Ey(e),Uy(r,w,h),e.intersectionData=null}function Ey(e){e.tile.intersectsClippingArea&&(Py(e),Ry(e))}function Ry(e,t=!1){const{geometry:i,geometryState:r,tile:s,localOrigin:n}=e,{level:a,extent:o,extentInRadians:l,ellipsoid:c}=s,h=c.radius,u=l[0],d=l[2],p=l[1],m=l[3],{samplerData:_}=r,f=o[0],g=o[2],y=o[1],v=o[3],b=Oy(e),{boundingBox:w,vertexAttributes:C}=i,x=n[0],T=n[1],S=n[2],{position:M,uv0:E}=C,R=M.typedBuffer,P=M.typedBufferStride;for(let n=0;n<4;++n){const l=1===n||3===n,c=r.edgeResolutions[n];(0,eg.Fp)((0,jt.wt)(c));const C=c+1,M=Wg(s,r.edgePeerNeighbors[n]);if(Ky(s,M,n)){zy(e,n,M);continue}const A=null!=M;(0,eg.Fp)(!A||M.level===s.level),(0,eg.Fp)(!A||(0,Ig.gl)(s,M)<=0);const O=M?.renderData,D=O?.geometryState;if(eg.T9){const e=s.surface;if(!M&&e&&!e.updatingRootTiles){const t=eg.OC[n],i=s.findNeighborTile(t,(e=>e.loaded||e.leaf||e.level===s.level));i?i.intersectsClippingArea&&((0,eg.Fp)(!i.loaded),(0,eg.Fp)(!i.leaf),(0,eg.Fp)(i.level===a)):(0,eg.Fp)(null==e?.rootTiles||!s.shouldHaveNeighbor(t))}}const I=1===n?o[2]:o[0],L=M?.extent,F=L&&l?1===n?L[0]:L[2]:I,N=0===n?o[3]:o[1],U=1===n?1:0,H=0===n?1:0,V=1===n?d:u,k=0===n?m:p,B=Math.sin(V),z=Math.cos(V),G=Math.sin(k),q=Math.cos(k),Z=D?.samplerData,j=A?(e,t,i)=>.5*(Jf(e,t,_)+Jf(i,t,Z)):(e,t,i)=>Jf(e,t,_),W=i.outerEdgesOffsetAndLength[2*n+0],$=t&&C>3?C-3:1,X=null!=_&&_.some((e=>null!=e)),Y=null!=Z&&Z.some((e=>null!=e)),Q=X||Y,K=1/c,J=W;(0,eg.Fp)(!L||(0,eg.Wq)(L[2]-L[0],o[2]-o[0])),(()=>{const e=1===n?-1:3===n?1:0,t=0===n?-1:2===n?1:0,r=(o[2]-o[0])*K,s=e*r,a=t*r,c=l?e*((d-u)*K):0,p=l?0:t*K,m=H,M=l?V+c:V,O=l?Math.sin(M):B,D=l?Math.cos(M):z,L=l?V-c:V,W=l?Math.sin(L):B,X=l?Math.cos(L):z,Y=l?k:b(m+p),ee=l?G:Math.sin(Y),te=l?q:Math.cos(Y),ie=l?k:b(m-p),re=l?G:Math.sin(ie),se=l?q:Math.cos(ie);let ne=0,ae=0,oe=0;{const e=0*K,t=l?I:f*(1-e)+g*e,i=l?F:t,r=l?y*(1-e)+v*e:N,s=l?V:u*(1-e)+d*e,n=l?B:Math.sin(s),a=l?z:Math.cos(s),o=l?b(e):k,c=l?Math.sin(o):G,p=l?Math.cos(o):q,m=h+j(t,r,i);ne=a*p*m,ae=n*p*m,oe=c*m}let le=0,ce=0,he=0;{const e=1*K,t=l?I:f*(1-e)+g*e,i=l?F:t,r=l?y*(1-e)+v*e:N,s=l?V:u*(1-e)+d*e,n=l?B:Math.sin(s),a=l?z:Math.cos(s),o=l?b(e):k,c=l?Math.sin(o):G,p=l?Math.cos(o):q,m=h+j(t,r,i);le=a*p*m,ce=n*p*m,he=c*m}for(let e=1;e<C-1;e+=$){let t=0,r=0,o=0;{const i=(e+1)*K,s=l?I:f*(1-i)+g*i,n=l?F:s,a=l?y*(1-i)+v*i:N,c=l?V:u*(1-i)+d*i,p=l?B:Math.sin(c),m=l?z:Math.cos(c),_=l?b(i):k,w=l?Math.sin(_):G,C=l?Math.cos(_):q,x=h+j(s,a,n);t=m*C*x,r=p*C*x,o=w*x}const c=t,p=r,m=o,C=le,M=ce,L=he;le=c,ce=p,he=m;{const t=J+e,i=t*P,r=C-x,s=M-T,n=L-S;R[i]=r,R[i+1]=s,R[i+2]=n,tv(r,s,n,w);const a=e*K,o=l?U:a,c=l?a:H;E.setValues(t,Math.round(o*Tg.rU),Math.round(c*Tg.rU))}const $=ne,Y=ae,ie=oe;ne=C,ae=M,oe=L;const ue=C,de=M,pe=L,me=1/Math.sqrt(ue*ue+de*de+pe*pe),_e=pe*me;let fe=0,ge=0,ye=0;if(Q&&_e*_e<.999){let t=0,i=0,r=0;{const e=0===n?-1:1;t=e*(c-$),i=e*(p-Y),r=e*(m-ie)}{const o=e*K,c=l?I:f*(1-o)+g*o,p=l?F:c,m=l?y*(1-o)+v*o:N,w=l?V:u*(1-o)+d*o,C=l?B:Math.sin(w),x=l?z:Math.cos(w),T=l?b(o):k,S=l?Math.sin(T):G,M=l?Math.cos(T):q;let E=ue,R=de,P=pe;if(A){const e=h+Jf(p-s,m-a,Z),t=l?M:se;E=(l?X:x)*t*e,R=(l?W:C)*t*e,P=(l?S:re)*e}{const e=h+Jf(c+s,m+a,_),o=l?M:te,u=(l?D:x)*o*e,d=(l?O:C)*o*e,p=(l?S:ee)*e;A||(E=2*ue-u,R=2*de-d,P=2*pe-p);const f=3===n?-1:1,g=f*(E-u),y=f*(R-d),v=f*(P-p);fe=r*y-i*v,ge=t*v-r*g,ye=i*g-t*y;const b=1/Math.sqrt(fe*fe+ge*ge+ye*ye);fe*=b,ge*=b,ye*=b}}}else fe=ue*me,ge=de*me,ye=pe*me;i.setEdgeNormalFromValues(n,e,fe,ge,ye)}})()}}function Py(e){Gy(e)}function Ay(e,t){return Math.PI/2-2*Math.atan(Math.exp(-e/t))}function Oy(e){const{tile:t}=e;if(t.surface.isWebMercator){const e=t.extent,i=t.ellipsoid.radius;return t=>function(e,t,i,r){return Ay(e*(1-r)+t*r,i)}(e[1],e[3],i,t)}const i=t.extentInRadians;return e=>function(e,t,i){return e*(1-i)+t*i}(i[1],i[3],e)}function Dy(e,t){const{tile:i,geometryState:r,geometry:s}=e,{extent:n,surface:a}=i,{wireframe:o}=r,l=n[0],c=n[1],h=n[2]-l,u=n[3]-c,{numVerticesPerSide:d,clippingArea:p}=r,m=null!=p?Math.max(0,(p[0]-l)/h):0,_=null!=p?Math.max(0,(p[1]-c)/u):0,f=null!=p?Math.min(1,(p[2]-l)/h):1,g=null!=p?Math.min(1,(p[3]-c)/u):1,y=(d-2)**2,v=iv(r),b=y+4*v,w=a.renderer.tileGeometryCache.acquire(b),{boundingBox:C}=s;(0,xg.cS)(C),s.numVerticesPerSide=d,s.vertexAttributes=w,s.maxEdgeVertexCount=v,s.minu=m,s.minv=_,s.maxu=f,s.maxv=g,function(e){const t=e.tile;if(!t.intersectsClippingArea)return;const{geometry:i,geometryState:r,localOrigin:s}=e,{samplerData:n,clippingArea:a,numVerticesPerSide:o}=r,{surface:l,extent:c,ellipsoid:h}=t,{isWebMercatorOnPlateCarree:u}=l,d=null!=a?a:Yy,p=c[0],m=c[1],_=c[2],f=c[3],g=Math.max(p,d[0]),y=Math.min(_,d[2]),v=Math.max(m,d[1]),b=Math.min(f,d[3]),w=h.radius,C=t.horizontalScale,x=o-1,T=o-2,{minu:S,minv:M,maxu:E,maxv:R,boundingBox:P,vertexAttributes:A}=i,{position:O,uv0:D}=A,{typedBuffer:I,typedBufferStride:L}=A.normalCompressed,F=s[0],N=s[1],U=s[2],H=O.typedBuffer,V=O.typedBufferStride;let k=0;const B=(0,jt.uZ)(m,v,b),z=u?(Math.PI/2-2*Math.atan(Math.exp(-B/w)))*w:B*C,G=1/x,q=(0,jt.uZ)(m*(1-G)+f*G,v,b);let Z=z,j=u?(Math.PI/2-2*Math.atan(Math.exp(-q/w)))*w:q*C;for(let e=1;e<=T;e++){const t=e/x,i=(0,jt.uZ)(m*(1-t)+f*t,v,b),r=(0,jt.uZ)(t,M,R),s=j,a=(e-1)/x,o=(0,jt.uZ)(m*(1-a)+f*a,v,b),l=Z,c=(e+1)/x,h=(0,jt.uZ)(m*(1-c)+f*c,v,b),d=u?(Math.PI/2-2*Math.atan(Math.exp(-h/w)))*w:h*C,A=(0,jt.uZ)(c,M,R);Z=j,j=d;const O=(0,jt.uZ)(p,g,y);let B=O*C,z=Jf(O,i,n);const G=1/x,q=(0,jt.uZ)(G,S,E),W=(0,jt.uZ)(p*(1-q)+_*q,g,y);let $=q,X=W,Y=W*C,Q=Jf(W,i,n);if(1===e){const e=Y-F,t=Z-N,i=Q-U,s=0*V;H[s]=e,H[s+1]=t,H[s+2]=i,tv(e,t,i,P);const n=(0,jt.uZ)(G,S,E);D.setValues(k,Math.round(n*Tg.rU),Math.round(r*Tg.rU))}for(let t=1;t<=T;t++){const a=Y,c=Q,u=(t+1)/x,m=(0,jt.uZ)(u,S,E),f=(0,jt.uZ)(p*(1-u)+_*u,g,y),v=X;X=f;{const a=k+1,o=a*V;if(1===e||t===T){const l=f*C,c=Jf(f,i,n);if(1===e&&t<T){const e=l-F,t=s-N,i=c-U;H[o]=e,H[o+1]=t,H[o+2]=i,tv(e,t,i,P),D.setValues(a,Math.round(m*Tg.rU),Math.round(r*Tg.rU))}Y=l,Q=c}else Y=H[o]+F,Q=H[o+2]+U}const b=Y,w=Q,M=B,R=z;B=a,z=c;const O=(k-T)*V,G=1===e?Jf(v,o,n):H[O+2]+U,q=Jf(v,h,n);if(e<T){const e=k+T,t=e*V,i=a-F,r=d-N,s=q-U;H[t]=i,H[t+1]=r,H[t+2]=s,tv(i,r,s,P);const n=$;$=m,D.setValues(e,Math.round(n*Tg.rU),Math.round(A*Tg.rU))}{const e=b-M,t=l-d,i=t*(w-R),r=e*(G-q),s=-t*e,n=i*i+r*r+s*s;if(0===n)(0,Rg.hd)(I,k,0,0,1,L);else{const e=1/Math.sqrt(n);(0,Rg.hd)(I,k,i*e,r*e,s*e,L)}}++k}}}(e),s.edgeVerticesStartIndex=y,ky(e),Iy(e),Uy(s,[],o),e.intersectionData=null}function Iy(e,t){e.tile.intersectsClippingArea&&(Fy(e),Ly(e,!1))}function Ly(e,t){const{geometry:i,geometryState:r,localOrigin:s}=e,n=e.tile,{surface:a,extent:o}=n,{clippingArea:l,samplerData:c}=r,h=null!=l?l:Yy,u=o[0],d=o[2],p=o[1],m=o[3],_=[m>h[3],d>h[2],p<h[1],u<h[0]],f=n.horizontalScale,g=Ny(a.isWebMercatorOnPlateCarree,n.ellipsoid.radius,f),{minu:y,minv:v,maxu:b,maxv:w,boundingBox:C}=i,x=Math.max(u,h[0]),T=Math.min(d,h[2]),S=Math.max(p,h[1]),M=Math.min(m,h[3]),E=s[0],R=s[1],P=s[2];for(let s=0;s<4;++s){const o=1===s||3===s,l=r.edgeResolutions[s];(0,eg.Fp)((0,jt.wt)(l));const h=l+1,A=_[s],O=Wg(n,r.edgePeerNeighbors[s]);if(!A&&Ky(n,O,s)){zy(e,s,O);continue}const D=null!=O&&!A,I=O?.renderData,L=I?.geometryState;if(eg.T9&&((0,eg.Fp)(!D||O.level===n.level),(0,eg.Fp)(!D||(0,Ig.gl)(n,O)<=0),n&&!O&&!a.updatingRootTiles)){const e=eg.OC[s],t=n.findNeighborTile(e,(e=>e.loaded||e.leaf||e.level===n.level));a.updatingRootTiles||(t?t.intersectsClippingArea&&((0,eg.Fp)(!t.loaded),(0,eg.Fp)(!t.leaf),(0,eg.Fp)(t.level===n.level)):(0,eg.Fp)(null==a?.rootTiles||!n.shouldHaveNeighbor(e)))}const F=(0,jt.uZ)(1===s?d:u,x,T),N=(0,jt.uZ)(0===s?m:p,S,M),U=L?.samplerData,H=t&&h>3?h-3:1,V=(0,jt.uZ)(1===s?1:0,y,b),k=(0,jt.uZ)(0===s?1:0,v,w),B=D?(e,t)=>.5*(Jf(e,t,U)+Jf(e,t,c)):(e,t)=>Jf(e,t,c),z=(d-u)/l,G=o?1===s?z:-z:0,q=o?0:0===s?z:-z,Z=-G,j=-q;let W=0,$=0,X=0;{const e=0/l,t=o?F:(0,jt.uZ)(u*(1-e)+d*e,x,T),i=o?(0,jt.uZ)(p*(1-e)+m*e,S,M):N,r=B(t,i);W=t*f,$=g(i),X=r}let Y=0,Q=0,K=0;{const e=1/l,t=o?F:(0,jt.uZ)(u*(1-e)+d*e,x,T),i=o?(0,jt.uZ)(p*(1-e)+m*e,S,M):N,r=B(t,i);Y=t*f,Q=g(i),K=r}for(let e=1;e<h-1;e+=H){const t=e/l,r=Y,n=Q,a=K;{const l=o?V:(0,jt.uZ)(t,y,b),c=o?(0,jt.uZ)(t,v,w):k,h=r-E,u=n-R,d=a-P;tv(r,u,d,C),i.setEdgeVertexFromValuesRawPositionUV(s,e,h,u,d,l,c)}{const t=(e+1)/l,i=o?F:(0,jt.uZ)(u*(1-t)+d*t,x,T),r=o?(0,jt.uZ)(p*(1-t)+m*t,S,M):N,s=B(i,r);Y=i*f,Q=g(r),K=s}const h=Y,_=K,A=W,O=$,I=X;W=r,$=n,X=a;let L=0,H=0,z=0;if(o){const e=Q-n,i=_-a,o=O-n,l=I-a,h=(0,jt.uZ)(p*(1-t)+m*t,S,M),u=F+Z,d=u*f-r,g=Jf(u,h,c)-a,y=3===s?-1:1;if(L=y*(-o+e)*g,H=y*d*(-l+i),z=-y*d*(-o+e),D){const t=F+G,s=t*f-r;L=(-o+e)*(g-(Jf(t,h,U)-a)),H=(d-s)*(-l+i),z=-(d-s)*(-o+e)}}else{const e=h-r,i=_-a,o=A-r,l=I-a,p=(0,jt.uZ)(u*(1-t)+d*t,x,T),m=N+j,f=Jf(p,m,c)-a,y=g(m)-n,v=2===s?-1:1;if(L=v*y*(-l+i),H=v*(-o+e)*f,z=-v*y*(-o+e),D){const t=p,r=N+q,s=g(r)-n;L=(-y+s)*(-l+i),H=(-o+e)*(-f+(Jf(t,r,U)-a)),z=-(-y+s)*(-o+e)}}const J=1/Math.sqrt(L*L+H*H+z*z);i.setEdgeNormalFromValues(s,e,L*J,H*J,z*J)}}}function Fy(e,t){Gy(e)}function Ny(e,t,i){return e?e=>function(e,t){return(Math.PI/2-2*Math.atan(Math.exp(-e/t)))*t}(e,t):e=>function(e,t){return e*t}(e,i)}function Uy(e,t,i){const{numVerticesPerSide:r,vertexAttributes:s,maxEdgeVertexCount:n}=e,a=r-1,o=s.count,l=2*(r-3)*(r-3),c=4*(a+n-3),h=ty.reduce(((t,i)=>t+(a+e.getEdgeCount(i)-3)),0),u=t.reduce(((e,t)=>e+a*(2*(t.latitudeResolution-1)+1)),0),d=3*(i?2:1),p=(l+c+u)*d,m=o>=65536?new Uint32Array(p):new Uint16Array(p);for(let e=0;e<p;++e)m[e]=0;e.indices=m,e.indexCount=(l+h+u)*d,e.poleIndicesStartIndex=l*d,e.edgeIndicesStartIndex=(l+u)*d,i?(function(e){const{indices:t,numVerticesPerSide:i,vertexAttributes:r}=e,{position:s}=r,{typedBuffer:n,typedBufferStride:a}=s,o=i-2;let l=0;for(let e=0;e<i-3;++e){const r=e*o;for(let s=0;s<i-3;++s){const i=e*o+s,c=i+1,h=c+o,u=h-1,d=r+s,p=d+1,m=p+o;rv(d,p,m,m-1,a,n)?(sv(t,l,i,c,h),l+=6,sv(t,l,h,u,i)):(sv(t,l,i,c,u),l+=6,sv(t,l,u,h,c)),l+=6}}}(e),function(e,t){const{indices:i,numVerticesPerSide:r,poleIndicesStartIndex:s}=e,n=r-1;let a=s;for(const s of t){const t=s.connectedOuterEdgeOffset;let o=e.getEdgeVertexIndex(t,0),l=1;for(let e=0;e<s.latitudeResolution;++e){const t=0===e?s.rowOffset:o+r;for(let r=0;r<n;r++)sv(i,a,o,o+1,t+r),a+=6,e<s.latitudeResolution-1&&(sv(i,a,o+1,t+r+1,t+r),a+=6),o+=l;o=t,l=1}}}(e,t),Vy(e)):(function(e){const{numVerticesPerSide:t,indices:i,vertexAttributes:r}=e,{position:s}=r,{typedBuffer:n,typedBufferStride:a}=s,o=t-2,l=t-3,c=0,h=t-3;let u=0;for(let e=0;e<l;++e){const t=e*o;for(let e=c;e<h;++e){const r=t+e,s=r+1,l=s+o,c=l-1;rv(r,s,l,c,a,n)?(i[u]=r,i[u+1]=s,i[u+2]=l,i[u+3]=l,i[u+4]=c,i[u+5]=r):(i[u]=r,i[u+1]=s,i[u+2]=c,i[u+3]=c,i[u+4]=s,i[u+5]=l),u+=6}}}(e),function(e,t){const{numVerticesPerSide:i,indices:r,poleIndicesStartIndex:s}=e,n=i-1;let a=s;for(const s of t){const t=s.isNorth?1:2,o=s.isNorth?2:1,l=s.isNorth?3:4,c=s.isNorth?4:3;let h=e.getEdgeVertexIndex(s.connectedOuterEdgeOffset,0),u=1;for(let e=0;e<s.latitudeResolution;++e){const d=0===e?s.rowOffset:h+i;for(let i=0;i<n;i++){const n=d+i;r[a]=h,r[a+t]=h+1,r[a+o]=n,e<s.latitudeResolution-1?(r[a+l]=h+1,r[a+c]=n+1,r[a+5]=n,a+=6):a+=3,h+=u}h=d,u=1}}}(e,t),Hy(e))}function Hy(e){const{indices:t,numVerticesPerSide:i,edgeIndicesStartIndex:r}=e,s=i-1,n=s-2;let a=r;for(let i=0;i<4;++i){const r=ev[i];let o=0,l=0;const c=e.getEdgeCount(i),h=r.count;(0,eg.Fp)(h===s-1);const u=1===i||2===i,d=u?1:2,p=u?2:1,m=e.getEdgeFirstVertexIndex(i),_=1,f=r.vertex0Index,g=r.stride;for(;o<c-1||l<h-1;){const e=f+l*g,i=m+o*_,r=o<c-1,u=l<h-1,y=r&&(!u||(r?0+s*(o+.5)/(c-1):0)<=(u?1+n*(l+.5)/(h-1):0));y?++o:++l;const v=y?i+_:e+g;t[a]=e,t[a+d]=i,t[a+p]=v,a+=3}}e.indexCount=a}function Vy(e){const{indices:t,numVerticesPerSide:i,edgeIndicesStartIndex:r}=e,s=i-1,n=s-2;let a=r;for(let i=0;i<4;++i){const r=ev[i];let o=0,l=0;const c=e.getEdgeCount(i),h=r.count;(0,eg.Fp)(h===s-1);const u=1===i||2===i,d=u?1:3,p=u?3:1,m=e.getEdgeFirstVertexIndex(i),_=1,f=r.vertex0Index,g=r.stride;for(;o<c-1||l<h-1;){const e=f+l*g,i=m+o*_,r=o<c-1,u=l<h-1,y=r&&(!u||(r?0+s*(o+.5)/(c-1):0)<=(u?1+n*(l+.5)/(h-1):0));y?++o:++l;const v=y?i+_:e+g;t[a]=e,t[a+d]=i,t[a+d+1]=i,t[a+p]=v,t[a+p+1]=v,t[a+5]=e,a+=6}}e.indexCount=a}function ky(e){const{geometry:t,geometryState:i}=e,{edgeResolutions:r}=i,{numVerticesPerSide:s,edgeVerticesStartIndex:n}=t,a=s-2;let o=n;for(let e=0;e<4;++e){{const t=0===e||2===e,i=(0===e?a-1:0)*a+(1===e?a-1:0),r=(t?0:1)*a+(t?1:0),s=ev[e];s.vertex0Index=i,s.stride=r,s.count=a}{const i=r[e]+1;t.outerEdgesOffsetAndLength[2*e+0]=o,t.outerEdgesOffsetAndLength[2*e+1]=i,o+=i}}}function By(e){ky(e),e.geometryState.wireframe?Vy(e.geometry):Hy(e.geometry)}function zy(e,t,i){const{geometryState:r,geometry:s,tile:n,localOrigin:a}=e,o=1===t||3===t,l=r.edgeResolutions[t];(0,eg.Fp)((0,jt.wt)(l));const c=l+1,{boundingBox:h,minu:u,minv:d,maxu:p,maxv:m,vertexAttributes:_}=s,f=(0,jt.uZ)(1===t?1:0,u,p),g=(0,jt.uZ)(0===t?1:0,d,m),y=i.renderData,v=y.geometryState,b=y.geometry,w=(t+2)%4,C=b.getEdgeCount(w),x=n.getNeighborEdgeStartVertexIndex(t,i)*l,T=l*2**(n.level-i.level);(0,eg.Fp)(v.edgeResolutions[w]===T),(0,eg.Fp)(C-1===T);const S=y.localOrigin[0]-a[0],M=y.localOrigin[1]-a[1],E=y.localOrigin[2]-a[2],R=s.getEdgeFirstVertexIndex(t),{position:P,uv0:A}=_,O=P.typedBuffer,D=P.typedBufferStride,I=_.normalCompressed,L=I.typedBuffer,F=I.typedBufferStride,N=b.vertexAttributes,U=b.getEdgeFirstVertexIndex(w),H=N.position.typedBuffer,V=N.position.typedBufferStride,k=N.normalCompressed.typedBuffer,B=N.normalCompressed.typedBufferStride;for(let e=1;e<c-1;++e){const t=R+e,i=U+(x+e),r=t*D,s=i*V,n=H[s]+S,a=H[s+1]+M,c=H[s+2]+E;O[r]=n,O[r+1]=a,O[r+2]=c,tv(n,a,c,h);const _=t*F,y=i*B;L[_]=k[y],L[_+1]=k[y+1];const v=e/l,b=o?f:(0,jt.uZ)(v,u,p),w=o?(0,jt.uZ)(v,d,m):g;A.setValues(t,Math.round(b*Tg.rU),Math.round(w*Tg.rU))}}function Gy(e){const{geometry:t,geometryState:i,localOrigin:r}=e,{clippingArea:s,samplerData:n}=i,{minu:a,minv:o,maxu:l,maxv:c,boundingBox:h,vertexAttributes:u}=t,d=e.tile,{surface:p,ellipsoid:m,extent:_,extentInRadians:f,horizontalScale:g}=d,y="local"===p.view?.viewingMode,v=m.radius;let b=0,w=0,C=0;const x=y?(()=>{const e=s,t=null!=e&&(_[3]>e[3]||_[2]>e[2]||_[1]<e[1]||_[0]<e[0]),i=Ny(p.isWebMercatorOnPlateCarree,v,g);return(r,s,n)=>{const a=0===r?_[0]:_[2],o=0===s?_[1]:_[3],l=t?(0,jt.uZ)(a,e[0],e[2]):a,c=t?(0,jt.uZ)(o,e[1],e[3]):o,h=n;b=l*g,w=i(c),C=h}})():(e,t,i)=>{const r=f[0===t?1:3],s=f[0===e?0:2],n=Math.cos(r),a=Math.sin(r),o=Math.sin(s),l=Math.cos(s),c=v+i;b=l*n*c,w=o*n*c,C=a*c};let T=0,S=0,M=0,E=0,R=0,P=0,A=0,O=0,D=0;const I=y&&p.isWebMercatorOnPlateCarree,L=(e,t,i,r,s)=>{let n=0,a=0,o=0;if(y){const e=t*g,s=I?(Math.PI/2-2*Math.atan(Math.exp(-i/v)))*v:i*g;n=e-b,a=s-w,o=r-C}else{const s=Oy(e),l=e.tile,c=l.extent,h=l.extentInRadians,u=(t-c[0])/(c[2]-c[0]),d=(i-c[1])/(c[3]-c[1]),p=h[0]*(1-u)+h[2]*u,m=s(d),_=Math.cos(m),f=Math.sin(m),g=Math.sin(p),y=Math.cos(p),x=v+r;n=y*_*x-b,a=g*_*x-w,o=f*x-C}switch(s){case 0:A+=n,O+=a,D+=o;break;case 1:E-=n,R-=a,P-=o;break;case 2:A-=n,O-=a,D-=o;break;case 3:E+=n,R+=a,P+=o}},F=s??Yy,N=_[0],U=_[2],H=_[1],V=_[3],k=[V>F[3],U>F[2],H<F[1],N<F[0]],B=Math.max(N,F[0]),z=Math.min(U,F[2]),G=Math.max(H,F[1]),q=Math.min(V,F[3]),Z=e=>Math.max(F[0],Math.min(F[2],e)),j=e=>Math.max(F[1],Math.min(F[3],e)),W=e=>{const t=i.cornerNeighborCornerTiles;T=0,S=0,M=1,E=0,R=0,P=0,A=0,O=0,D=0;let r=1/0;for(let i=0;i<4;++i){const s=t[4*e+i];r=Math.min(r,s?.level??1/0)}for(let i=0;i<4;++i){const s=t[4*e+i];Qy[i]=s?.level===r?s:null}let s=1,n=0;for(let e=0;e<4;++e){const t=Qy[e];t&&(s=Math.max(s,t?.renderData.geometryState.numVerticesPerSide),n=t.extent[2]-t.extent[0])}const a=n,o=s;(0,eg.Fp)(o>1);const l=a/o;for(let e=0;e<4;++e){const t=Qy[(e+3)%4],i=Qy[e%4];if(!t&&!i)continue;const r=0===e?1:1===e?2:2===e?3:0,s=0===e?2:1===e?3:2===e?0:1;if(t&&i){const n=$y[e][0]*l,a=$y[e][1]*l,o=t.extent,c=Z(o[0===r||1===r?2:0]+n),h=j(o[0===r||3===r?3:1]+a),u=i.extent,d=Z(u[0===s||1===s?2:0]+n),p=j(u[0===s||3===s?3:1]+a),m=t.renderData,_=i.renderData,f=Jf(c,h,m.geometryState.samplerData),g=Jf(d,p,_.geometryState.samplerData);L(m,c,h,.5*(f+g),e)}else{const n=t??i,a=t?r:s,o=n.extent,c=$y[e],h=Z(o[0===a||1===a?2:0]+c[0]*l),u=j(o[0===a||3===a?3:1]+c[1]*l),d=n.renderData,p=Jf(h,u,d.geometryState.samplerData);L(d,h,u,p,e)}}if(!y){const e=Math.sqrt(b*b+w*w+C*C);T=b/e,S=w/e,M=C/e}if(y||M*M<.999){const e=Math.sqrt(E*E+R*R+P*P);E/=e,R/=e,P/=e;const t=Math.sqrt(A*A+O*O+D*D);A/=t,O/=t,D/=t,T=P*O-R*D,S=E*D-P*A,M=R*A-E*O;const i=1/Math.sqrt(T*T+S*S+M*M);T*=i,S*=i,M*=i}},$=i.cornerNeighborCornerTiles;for(let e=0;e<4;++e){const s=e,p=(e+1)%4,m=0===e||1===e?1:0,_=0===e||3===e?1:0,f=(0,jt.uZ)(m,a,l),g=(0,jt.uZ)(_,o,c),y=t.getEdgeFirstVertexIndex(s),v=t.getEdgeCount(s),E=0===e||3===e?v-1:0,R=t.getEdgeFirstVertexIndex(p),P=t.getEdgeCount(p),A=0===e||1===e?P-1:0;let O=-1;for(let t=0;t<4;++t){const i=$[4*e+t],r=$[4*e+O];i&&(-1===O||(0,Ig.gl)(r,i)>0)&&(O=t)}const D=O,I=$[4*e+D];if(I!==d){const t=d.level-I.level,s=2**t,n=[I.lij[0]+t,I.lij[1]*s,I.lij[2]*s],a=[n[1]+s===d.lij[1],0===e&&(1===D||0===D&&I!==$[4*e+3])||1===e&&(0===D||1===D&&I!==$[4*e+2]),n[1]===d.lij[1]+1,2===e&&(3===D||2===D&&I!==$[4*e+1])||3===e&&(2===D||3===D&&I!==$[4*e+0])],o=a.reduce(((e,t)=>e+(t?1:0)),0);(0,eg.Fp)(1===o||2===o);let l=-1,c=-1;const p=I.renderData;if(1===o){const t=a.findIndex((e=>e));(0,eg.Fp)(0<=t&&t<=3),l=(t+2)%4;const r=i.edgeResolutions[t];c=d.getNeighborEdgeStartVertexIndex(t,I)*r+r*(0===t&&0===e||1===t&&0===e||2===t&&1===e||3===t&&3===e?1:0)}else{(0,eg.Fp)(a[1]||a[3]),l=a[1]?3:1;const t=p.geometryState.edgeResolutions[l];c=0===e||3===e?0:t}const m=p.geometry;{const e=y+E,t=R+A,i=m.getEdgeFirstVertexIndex(l)+c,s=m.vertexAttributes,n=p.localOrigin,a=s.position,o=a.typedBuffer,d=i*a.typedBufferStride,_=o[d]+n[0]-r[0],v=o[d+1]+n[1]-r[1],b=o[d+2]+n[2]-r[2];tv(_,v,b,h);const w=u.position,C=w.typedBuffer,x=e*w.typedBufferStride;C[x]=_,C[x+1]=v,C[x+2]=b;const T=t*w.typedBufferStride;C[T]=_,C[T+1]=v,C[T+2]=b;const S=u.uv0;S.setValues(e,Math.round(f*Tg.rU),Math.round(g*Tg.rU)),S.setValues(t,Math.round(f*Tg.rU),Math.round(g*Tg.rU));{const r=s.normalCompressed.typedBuffer,n=i*s.normalCompressed.typedBufferStride,a=u.normalCompressed,o=a.typedBuffer;{const t=e*a.typedBufferStride;o[t]=r[n],o[t+1]=r[n+1]}{const e=t*a.typedBufferStride;o[e]=r[n],o[e+1]=r[n+1]}}}}else{let i;if(k[s]||k[p]){i=Jf((0,jt.uZ)(N*(1-m)+U*m,B,z),(0,jt.uZ)(H*(1-_)+V*_,G,q),n)}else i=qy($,e);x(m,_,i),W(e);const a=b-r[0],o=w-r[1],l=C-r[2];tv(a,o,l,h),t.setEdgeVertexFromValuesRawPositionUVNormal(s,E,a,o,l,f,g,T,S,M),t.setEdgeVertexFromValuesRawPositionUVNormal(p,A,a,o,l,f,g,T,S,M)}}for(let e=0;e<4;++e)Qy[e]=null}function qy(e,t){const i=4*t,r=ty.reduce(((t,r)=>Math.min(t,e[i+r]?.level??1/0)),1/0);eg.T9&&((0,eg.Fp)(!e[i+0]||!e[i+2]||vy(e[i+0],e[i+2],Sg.X.SOUTH_WEST)),(0,eg.Fp)(!e[i+1]||!e[i+3]||vy(e[i+1],e[i+3],Sg.X.NORTH_WEST)));let s=0,n=0;for(let t=0;t<4;++t){const a=e[i+t];if(a&&a.level===r){const e=0===t||1===t,i=0===t||3===t,r=a.extent,o=r[e?0:2],l=r[i?1:3],c=a.renderData?.geometryState?.samplerData;n+=Jf(o,l,c),s++}}const a=s?n/s:0;return(0,eg.Fp)(null!=a),a}function Zy(e){const{vao:t,geometry:i}=e,{vertexAttributes:r,edgeVerticesStartIndex:s}=i,n=r.position.typedBuffer;t.vertexBuffers.get("geometry").setSubData(n,s,s,n.length)}function jy(e){const{vao:t,geometry:i}=e,{indices:r,indexCount:s,edgeIndicesStartIndex:n}=i;t.indexBuffer.setSubData(r,n,n,s)}class Wy{constructor(e,t,i,r,s){this.isNorth=e,this.connectedRowOffset=t,this.connectedOuterEdgeOffset=i,this.rowOffset=r,this.latitudeResolution=s}}const $y=[[0,1],[1,0],[0,-1],[-1,0]],Xy=new class{constructor(){this.sinLonLUT=new Array(ce.Cf+1),this.cosLonLUT=new Array(ce.Cf+1),this.sinLatLUT=new Array(ce.Cf+1),this.cosLatLUT=new Array(ce.Cf+1)}update(e,t,i){const r=t[0],s=t[2];for(let t=0;t<=e;t++){const n=t/e,a=r*(1-n)+s*n;this.sinLonLUT[t]=Math.sin(a),this.cosLonLUT[t]=Math.cos(a);const o=i(n);this.sinLatLUT[t]=Math.sin(o),this.cosLatLUT[t]=Math.cos(o)}}},Yy=(0,V.al)(-1/0,-1/0,1/0,1/0),Qy=[null,null,null,null];function Ky(e,t,i){if(!t)return!1;const r=(0,Ig.gl)(e,t);return r>0||0===r&&i>=2}class Jy{constructor(){this.vertex0Index=0,this.stride=1,this.count=0}getVertexIndex(e){return(0,eg.Fp)(0<=e&&e<this.count),this.vertex0Index+this.stride*e}}const ev=[new Jy,new Jy,new Jy,new Jy];function tv(e,t,i,r){e<r[0]?r[0]=e:e>r[3]&&(r[3]=e),t<r[1]?r[1]=t:t>r[4]&&(r[4]=t),i<r[2]?r[2]=i:i>r[5]&&(r[5]=i)}function iv(e){const{edgeResolutions:t,numVerticesPerSide:i}=e,r=1+Math.max(...t);return Math.max(i,r)}function rv(e,t,i,r,s,n){const a=e*s,o=n[a],l=n[a+1],c=n[a+2],h=t*s,u=n[h],d=n[h+1],p=n[h+2],m=i*s,_=n[m],f=n[m+1],g=n[m+2],y=r*s,v=n[y],b=n[y+1],w=n[y+2];return(u-v)*(u-v)+(d-b)*(d-b)+(p-w)*(p-w)>(o-_)*(o-_)+(l-f)*(l-f)+(c-g)*(c-g)}function sv(e,t,i,r,s){e[t]=i,e[t+1]=r,e[t+2]=r,e[t+3]=s,e[t+4]=s,e[t+5]=i}const nv=6;var av=i(87807);class ov extends hy{constructor(e,t,i,r,s){super(),this._horizontalScaleFactor=1,this._extentInRenderSR=(0,V.Ue)(),this._baseUsedMemory=900,this._subtreeGeometryElevationBoundMin=0,this._subtreeGeometryElevationBoundMax=0,this.init(e,t,i,r,s)}init(e,t,i,r,s){super.init(e,t,i,r,s);const n=s.view.renderSpatialReference,a=s.spatialReference,o=null!=n&&(0,ft.QM)(n)&&null!=a&&a.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this._horizontalScaleFactor=o;const{isWebMercatorOnPlateCarree:l}=s,c=this._extentInRenderSR,h=this.extent;if(l){const e=(0,O.al)(h[0],h[1],0);(0,Zf.S)(e,N.Z.WebMercator,e,N.Z.PlateCarree);const t=(0,O.al)(h[2],h[3],0);(0,Zf.S)(t,N.Z.WebMercator,t,N.Z.PlateCarree),c[0]=e[0],c[1]=e[1],c[2]=t[0],c[3]=t[1]}else for(let e=0;e<4;++e)c[e]=h[e]*o;this.centerAtSeaLevel[0]=.5*(c[0]+c[2]),this.centerAtSeaLevel[1]=.5*(c[1]+c[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(c[2]-c[0],c[3]-c[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const e=this._extentInRenderSR,t=.5*(e[2]-e[0]),i=.5*(e[3]-e[1]),r=Math.sqrt(t*t+i*i),s=.5*(this.elevationBoundsMax-this.elevationBoundsMin),n=Math.max(r,s);this._center[fy.MIDDLE][3]=n}_calculateFrustumVisibility(e){const t=this._aabb(),i=t[0],r=t[1],s=t[2],n=t[3],a=t[4],o=t[5];let l=!0;for(let t=0;t<6;t++){const c=e[t],h=c[0],u=c[1],d=c[2],p=c[3];if(h*(h>0?i:n)+u*(u>0?r:a)+d*(d>0?s:o)+p>=0)return ny.OUTSIDE;l=l&&h*(h<0?i:n)+u*(u<0?r:a)+d*(d<0?s:o)+p<=0}return l?ny.INSIDE:ny.INTERSECTS}_aabb(){const e=this._extentInRenderSR;return(0,xg.re)(e[0],e[1],Math.min(this.elevationBoundsMin,this._subtreeGeometryElevationBoundMin),e[2],e[3],Math.max(this.elevationBoundsMax,this._subtreeGeometryElevationBoundMax))}intersectsRay(e,t,i,r){return lv[0]=1/t[0],lv[1]=1/t[1],lv[2]=1/t[2],(0,av.Fw)(this._aabb(),e,lv,i,r)}createGeometry(){Dy(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds(),this.setMemoryDirty()}_updateSubtreeGeometryElevationsBounds(){const e=this._subtreeGeometryElevationBoundMin,t=this._subtreeGeometryElevationBoundMax,i=this.renderData;let r=e,s=t;if(i){const e=i.geometry.boundingBox;r=e[2],s=e[5]}else if(!this.leaf){r=1/0,s=-1/0;for(const e of this.children){const t=e;r=Math.min(r,t._subtreeGeometryElevationBoundMin),s=Math.max(s,t._subtreeGeometryElevationBoundMax)}}if(r!==this._subtreeGeometryElevationBoundMin||s!==this._subtreeGeometryElevationBoundMax){this._subtreeGeometryElevationBoundMin=r,this._subtreeGeometryElevationBoundMax=s;this.parent?._updateSubtreeGeometryElevationsBounds()}}get minimumVerticesPerSide(){return this.level<9?3:2}updateCornerElevations(){(function(e,t){e.tile.intersectsClippingArea&&(Fy(e),Ly(e,!0),Zy(e),e.intersectionData=null)})(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}updateEdgeElevations(){(function(e,t){e.tile.intersectsClippingArea&&(Iy(e),Zy(e),e.intersectionData=null)})(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}updateEdgeElevationsAndResolutions(){(function(e,t){e.tile.intersectsClippingArea&&(By(e),Iy(e),Zy(e),jy(e),e.intersectionData=null)})(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}get horizontalScale(){return this._horizontalScaleFactor}}const lv=(0,O.Ue)();var cv=i(74446);class hv{constructor(){this.extent=(0,Uc.Ue)(),this.minLevel=0,this.maxLevel=0,this.callback=null}}let uv=class extends E.Z{constructor(){super(...arguments),this._queries=new ud.Z({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new ud.Z({initialSize:30}),this._queryPool=new qf.Z(hv)}queryVisibleLevelRange(e,t,i,r){const s=this._queryPool.acquire();(0,Nc.c)(s.extent,e),s.minLevel=t??-Number.MAX_VALUE,s.maxLevel=i??Number.MAX_VALUE,s.callback=r,this._queryQueue.push(s),this.notifyChange("updating")}get updating(){return 0!==this._queryQueue.length}prepare(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){const e=this._queryQueue.pop();this._queries.push(e)}this._queriesInvPtr=this._queries.length}process(){for(let e=0;e<this._queries.length;e++){const t=this._queries.data[e];this._queryPool.release(t),t.callback(e>=this._queriesInvPtr),t.callback=null}this._queries.clear(),this.notifyChange("updating")}queriesForTile(e){const t=e.level;let i=0;for(;i<this._queriesInvPtr;){const r=this._queries.data[i],s=r.extent;t>=r.minLevel&&t<=r.maxLevel&&s[0]<=e.extent[2]&&s[2]>=e.extent[0]&&s[1]<=e.extent[3]&&s[3]>=e.extent[1]?(this._queries.swapElements(i,this._queriesInvPtr-1),this._queriesInvPtr--):i++}}};(0,o._)([(0,x.Cb)()],uv.prototype,"updating",null),uv=(0,o._)([(0,S.j)("esri.views.3d.terrain.ScaleRangeQueries")],uv);var dv=i(60199);class pv extends hy{constructor(e,t,i,r,s){super(),this._convexHull=new Array(24),this._boundingSphere=(0,Nn.c)(),this._baseUsedMemory=1816,this.init(e,t,i,r,s)}init(e,t,i,r,s){super.init(e,t,i,r,s);const n=this.ellipsoid.radius,a=this.extentInRadians[0],o=this.extentInRadians[1],l=this.extentInRadians[2],c=this.extentInRadians[3],h=(0,jt.t7)(o,c,.5),u=(0,jt.t7)(a,l,.5),d=0===e?0:Math.min(Math.abs(o),Math.abs(c));this._edgeLen=(l-a)*Math.cos(d)*n,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=n-Math.sqrt(n*n-this._edgeLen2/4),function(e,t,i,r){const s=Math.cos(i);e[0]=Math.cos(t)*s*r,e[1]=Math.sin(t)*s*r,e[2]=Math.sin(i)*r}(this.centerAtSeaLevel,u,h,this.ellipsoid.radius),(0,mr.n)(this.up,this.centerAtSeaLevel),this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateBoundingVolumes();const e=this._center;if(0===this.lij[0])(0,mr.i)((0,Nn.a)(e[fy.MIDDLE]),0,0,0),(0,mr.i)(e[fy.TOP],0,0,0),(0,mr.i)(e[fy.BOTTOM],0,0,0),e[fy.MIDDLE][3]=this.ellipsoid.radius+this.elevationBoundsMax;else{this._updateCenter();const t=e[fy.MIDDLE],i=this.convexHull;let r=0;for(let e=0;e<8;++e)r=Math.max(r,_v((0,Nn.a)(t),i,3*e));e[fy.MIDDLE][3]=Math.sqrt(r)}}_calculateFrustumVisibility(e){if(!(0,hp.hr)(e,this._boundingSphere))return ny.OUTSIDE;if(this.lij[0]<10)return ny.INTERSECTS;const t=this.convexHull,i=this.surface.view.state.camera.near;let r=!0;for(let s=0;s<hp.N9;s++){const n=s===hp.Nu.NEAR,a=e[s],o=a[0],l=a[1],c=a[2],h=a[3]-(n?i:0);let u=!1;for(let e=0;e<8;++e){const i=3*e;if(o*t[i]+l*t[i+1]+c*t[i+2]+h<0){if(u=!0,!r)break}else r=!1}if(!u)return ny.OUTSIDE}return r?ny.INSIDE:ny.INTERSECTS}computeElevationBounds(){super.computeElevationBounds(),this._updateBoundingVolumes()}createGeometry(){My(this.renderData,this._getPatchType()),this._updateBoundingVolumes(),this.setMemoryDirty()}_updateBoundingVolumes(){this._updateConvexHull(),this._updateBoundingSphere(),eg.T9&&this._checkBVs()}_updateBoundingSphere(){const e=this._boundingSphere,t=(0,Nn.a)(e),i=this.elevationBoundsMin,r=this.elevationBoundsMax,s=this.ellipsoid.radius,n=r;if(0===this.level)(0,mr.i)(t,0,0,0),e[3]=s+n;else{const n=this.extentInRadians,a=.5*(n[0]+n[2]),o=n[1],l=n[3];gv(vv,a,o,s),gv(bv,a,l,s),(0,mr.f)(t,vv,bv),(0,mr.g)(t,t,(s+.5*(i+r))/(0,mr.H)(t));const c=this.convexHull;let h=0;const u=(e,t)=>{const i=e[0]-c[3*t],r=e[1]-c[3*t+1],s=e[2]-c[3*t+2];return Math.sqrt(i*i+r*r+s*s)};for(let e=0;e<8;++e){const i=u(t,e);h=Math.max(h,i)}const d=h;e[3]=d+2}}_updateConvexHull(){const e=this.extentInRadians,t=this.ellipsoid.radius;if(0===this.level)return;const i=this.elevationBoundsMin,r=this.elevationBoundsMax,s=this._getPatchType(),n=this.surface.isWebMercator,a=n&&s===ng.tk.HAS_NORTH_POLE,o=n&&s===ng.tk.HAS_SOUTH_POLE,l=o||a,c=Math.PI/2,h=e[0],u=e[2],d=o?-c:e[1],p=a?c:e[3],m=.5*(h+u),_=i,f=t+(l?Math.min(0,_-1):_),g=(e,t,i)=>gv(e,t,i,f),y=(0,O.Ue)(),v=(0,O.Ue)(),b=(0,O.Ue)(),w=(0,O.Ue)();g(y,h,d),g(v,h,p),g(b,u,p),g(w,u,d);const C=(e,t)=>{for(let i=0;i<3;++i)this._convexHull[3*t+i]=e[i]};C(y,0),C(v,1),C(b,2),C(w,3);const x=r,T=t+(l?Math.max(0,x+1):x),S=(0,O.Ue)(),M=(0,O.Ue)(),E=(0,O.Ue)();gv(M,m,p,f),gv(E,m,d,f),(0,mr.f)(S,M,E),(0,mr.n)(S,S);const R=(0,O.Ue)(),P=(0,O.Ue)(),A=(e,t)=>{(0,mr.a)(P,e,t),(0,mr.n)(P,P);const i=-(0,mr.e)(e,R)/(0,mr.e)(P,R);(0,eg.Fp)(i>=0),(0,mr.g)(P,P,i),(0,mr.f)(e,e,P)};if(2**this.lij[0]>2*this.lij[1]){const e=E,t=(0,O.Ue)();(0,mr.h)(t,yv,e),(0,mr.n)(t,t),(0,mr.h)(R,e,t),(0,mr.n)(R,R),(0,eg.Fp)((0,eg.Wq)((0,mr.e)(R,e)/(0,mr.H)(e),0)),A(y,v),A(w,b),C(y,0),C(w,3)}else if(2**this.lij[0]!==2*this.lij[1]){const e=M,t=(0,O.Ue)();(0,mr.h)(t,yv,e),(0,mr.n)(t,t),(0,mr.h)(R,t,e),(0,mr.n)(R,R),A(v,y),A(b,w),C(v,1),C(b,2)}const D=(e,t)=>{const i=T/(0,mr.e)(t,S);for(let r=0;r<3;++r)this._convexHull[3*e+r]=t[r]*i};D(4,y),D(5,v),D(6,b),D(7,w)}_getPatchType(){const e=this.lij[1],t=0===e,i=e===(1<<this.level)-1;return t?i?ng.tk.HAS_BOTH_POLES:ng.tk.HAS_NORTH_POLE:i?ng.tk.HAS_SOUTH_POLE:ng.tk.REGULAR}intersectsRay(e,t,i,r){const s=this._boundingSphere,n=s[3]+i,a=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],o=s[0]-e[0],l=s[1]-e[1],c=s[2]-e[2],h=(o*t[0]+l*t[1]+c*t[2])/a,u=t[0]*h-o,d=t[1]*h-l,p=t[2]*h-c;return u*u+d*d+p*p<n*n}get minimumVerticesPerSide(){return this.level<mv.length?mv[this.level]+1:2}updateCornerElevations(){(function(e){e.tile.intersectsClippingArea&&(Py(e),Ry(e,!0),Zy(e),e.intersectionData=null)})(this.renderData),this._updateBoundingVolumes()}updateEdgeElevations(){(function(e){e.tile.intersectsClippingArea&&(Ey(e),Zy(e),e.intersectionData=null)})(this.renderData),this._updateBoundingVolumes()}updateEdgeElevationsAndResolutions(){(function(e){e.tile.intersectsClippingArea&&(By(e),Ey(e),Zy(e),jy(e),e.intersectionData=null)})(this.renderData),this._updateBoundingVolumes()}_checkBVs(){if(!eg.T9)return;if(this.level<=2)return;const e=this._boundingSphere,t=e[3],i=(0,Nn.a)(e),r=(0,O.Ue)(),s=this.ellipsoid.radius,n=this.elevationBoundsMin,a=this.elevationBoundsMax,o=s+n,l=this._center[fy.MIDDLE][3],c=this.convexHull,h=(e,t)=>{for(let i=0;i<3;++i)e[i]=c[3*t+i]};{const e=(0,O.Ue)(),t=(0,O.Ue)(),i=(0,O.Ue)(),r=(0,O.Ue)(),s=(0,O.Ue)(),n=(n,a,o,l)=>{h(t,n),h(i,a),h(r,o),(0,mr.a)(t,t,i),(0,mr.a)(r,r,i),(0,mr.h)(e,t,r),(0,mr.n)(e,e);const c=(0,mr.e)(e,i);h(s,l);const u=(0,mr.e)(e,s),d=Math.abs(u-c);(0,eg.Fp)((0,eg.Wq)(d,0),`Non coplanar ${n},${a},${o},${l} diff = ${d}`)};n(0,1,2,3),n(4,5,6,7),n(0,1,4,5),n(1,2,5,6),n(2,3,6,7),n(3,0,7,4)}const u=(0,dv.bg)(24),d=(0,O.Ue)(),p=(0,O.Ue)(),m=(0,O.Ue)(),_=(0,O.Ue)(),f=(e,t,i,r)=>{h(d,t),h(p,i),h(m,r),(0,mr.a)(d,d,p),(0,mr.n)(d,d),(0,mr.a)(m,m,p),(0,mr.n)(m,m),(0,mr.h)(_,d,m),(0,mr.n)(_,_);const s=(0,mr.e)(_,p);((e,t,i)=>{const r=4*e;for(let e=0;e<3;++e)u[r+e]=t[e];u[r+3]=i})(e,_,s)};f(0,0,1,2),f(1,1,0,4),f(2,1,5,2),f(3,3,2,6),f(4,4,0,3),f(5,4,6,5);const g=(e,t,i,r)=>{const s=4*e;return u[s]*t+u[s+1]*i+u[s+2]*r-u[s+3]},y=(e,t,i,r)=>g(e,t,i,r)>=-1,v=(e,t)=>y(e,t[0],t[1],t[2]),b=2**this.lij[0]>2*this.lij[1],w=(e,r,s)=>Math.sqrt(fv(e,r,s,i[0],i[1],i[2]))<t,C=e=>w(e[0],e[1],e[2]),x=(e,t)=>w(e[t],e[t+1],e[t+2]),T=this.extentInRadians,S=.5*(T[0]+T[2]),M=T[1],E=T[3],R=(0,O.Ue)(),P=(0,O.Ue)();gv(R,S,E,o),gv(P,S,M,o);const A=b?"Upper":"Lower";let D=!0;for(let e=0;e<6;++e){for(let t=0;t<8;++t){const i=3*t,r=y(e,c[i],c[i+1],c[i+2]);D&&=r,(0,eg.Fp)(r,`Tile[${this.lij}] Convex hull point ${t} outside of plane ${e}`)}(0,eg.Fp)(v(e,P),`Tile[${this.lij}] (${A}) bottom mid outside of plane ${e}`),(0,eg.Fp)(v(e,R),`Tile[${this.lij}] (${A}) top mid outside of plane ${e}`)}(0,eg.Fp)(D,"Not all convex hull points are inside  convex hull polyhedron"),(0,eg.Fp)(C(P),`Tile[${this.lij}] (${A}) bottom mid outside of bounding sphere`),(0,eg.Fp)(C(R),`Tile[${this.lij}] (${A}) top mid outside of bounding sphere`);for(let e=0;e<8;++e){const t=x(c,3*e);(0,eg.Fp)(t,`Tile[${this.lij}] Convex hull point ${e} outside of bounding sphere`)}for(let e=0;e<6;++e)for(let t=0;t<8;++t){const i=3*t;y(e,c[i],c[i+1],c[i+2])||console.error(`Tile[${this.lij}] Convex hull point ${t} outside of plane ${e}`)}const{extentInRadians:I}=this,L=Math.max(I[2]-I[0],I[3]-I[1]),F=Math.round(L*s),{renderData:N}=this;if(!N)return;const{geometry:U,geometryState:H,localOrigin:V}=N,k=U.vertexAttributes?.position;if(!k)return;const B=(0,O.Ue)(),z=U.numVerticesPerSide-2,{indices:G,indexCount:q,edgeVerticesStartIndex:Z,poleVerticesStartIndex:j}=U;if(!G)return;const W=new Set;for(let e=0;e<q;++e){const o=G[e];if(W.has(o))continue;W.add(o);const c=o<j,h=o>=Z;let u=!1,d=-1;if(h){let e=Z;for(let t=0;t<4;++t){const i=H.edgeResolutions[t];if(o===e||o===e+i-1){u=!0;break}if(e+=i,o<e){d=t;break}}}const p=h?H.edgePeerNeighbors[d]:null,m=h&&p&&(0,Ig.gl)(this,p)>0;k.getVec(o,r),(0,mr.f)(B,r,V);const _=(0,mr.H)(B)-s;let f=0,v=!1;const b=n-_,w=_-a,C=b>1,x=w>1,T=C||x,S=()=>{const e=c?"internal":h&&!u?"edge":u?"corner":"pole";return`Tile[${this.lij}].vertex[${o}]:${e}`+(C?"(below)":x?"(above)":"")+(m?"(Neighbor)":"")},M=(0,mr.F)(B,i);if(M>=t+0){const e=M-t;T||(console.error(`${S()} is out of the bounding sphere by ${e.toFixed(0)} / ${t.toFixed(0)}[tol=0] h=${_.toFixed(0)} / [${n.toFixed(0)}..${a.toFixed(0)}] (${(e/t).toFixed(0)})`),v=!0)}for(let e=0;e<6;++e)if(!y(e,B[0],B[1],B[2])){const i=g(e,B[0],B[1],B[2]),r=o%z,s=(o-r)/z;0===e&&b||5===e&&w||(console.error(`${S()} (${r},${s})|${z}] is out of the bounding trapezoid plane ${e} h=${Math.round(_)} / [${Math.round(n)}..${Math.round(a)}] dist=${Math.round(i)} radii = ${Math.round(t)}/${Math.round(l)}} : maxL = ${F}`),++f)}if(v||f>0)break}}get convexHull(){return this._convexHull}}const mv=[128,64,64,32,16,8,8,4];function _v(e,t,i){return fv(e[0],e[1],e[2],t[i],t[i+1],t[i+2])}function fv(e,t,i,r,s,n){const a=r-e,o=s-t,l=n-i;return a*a+o*o+l*l}const gv=(e,t,i,r)=>{const s=Math.cos(t),n=Math.sin(t),a=Math.cos(i),o=Math.sin(i);e[0]=r*a*s,e[1]=r*a*n,e[2]=r*o},yv=[0,0,1],vv=(0,O.Ue)(),bv=(0,O.Ue)();let wv=class extends E.Z{constructor(){super(...arguments),this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}};(0,o._)([(0,x.Cb)()],wv.prototype,"fovX",void 0),(0,o._)([(0,x.Cb)()],wv.prototype,"fovY",void 0),(0,o._)([(0,x.Cb)()],wv.prototype,"relativeWidthLimit",void 0),(0,o._)([(0,x.Cb)()],wv.prototype,"relativeHeightLimit",void 0),(0,o._)([(0,x.Cb)()],wv.prototype,"maxLod",void 0),(0,o._)([(0,x.Cb)()],wv.prototype,"angledSplitBias",void 0),(0,o._)([(0,x.Cb)()],wv.prototype,"aboveGround",void 0),(0,o._)([(0,x.Cb)()],wv.prototype,"frustum",void 0),wv=(0,o._)([(0,S.j)("esri.views.3d.terrain.SplitLimits")],wv);var Cv=i(81342),xv=i(61796);const Tv=(0,ns.U$)().vec3f(Jr.T.POSITION).vec2u16(Jr.T.UV0,{glNormalized:!0}).vec2i16(Jr.T.NORMALCOMPRESSED,{glNormalized:!0});class Sv{constructor(e){this._storage=new zf(((t,i)=>e.newCache(t,i)),"TileGeometry")}acquire(e){const t=4*Math.ceil(e/4),i=this._storage,r=function(e){return e.toString()}(t),s=i.pop(r);if(s)return s;const n=Tv.createBuffer(t);return n.release=()=>i.put(r,n),n}clear(){this._storage.clear()}destroy(){this._storage.destroy()}}function Mv(e){return(0,z.aQ)(e.layer)}var Ev=i(58226),Rv=i(91102);class Pv extends Ev.R{constructor(){super(...arguments),this.opacity=1,this.baseOpacity=1,this.texture=null,this.fboTexture=null,this.backgroundColor=O.AG}}class Av extends Dr.A{constructor(e,t){super(e,t,new Or.J(Rv.B,(()=>i.e(5755).then(i.bind(i,5755)))))}}var Ov=i(20350),Dv=(i(71090),i(64544)),Iv=(i(48153),i(13772),i(5379)),Lv=i(11034),Fv=i(76496),Nv=i(92937),Uv=i(8267);class Hv{constructor(e,t,i,r,s,n){this._symbols=e,this._styleRepository=r,this._zoom=s,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new Nv.HX(t,i,Fv.cn),this._si=Math.sin(Math.PI*n/180),this._co=Math.cos(Math.PI*n/180),r.cachedStyles&&(this._styleProps=r.cachedStyles);for(const t of e)for(const e of t.symbols)this._allNeededMatrices.has(e.tile)||this._allNeededMatrices.set(e.tile,(0,Lv.d9)(e.tile.transforms.tileUnitsToPixels))}work(e){const t=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){const i=this._symbols[this._currentLayerCursor],r=this._getProperties(i.styleLayerUID),s=this._styleRepository.layerContexts?.get(i.styleLayerUID);for(;this._currentSymbolCursor<i.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-t>e)return!1;const n=i.symbols[this._currentSymbolCursor];if(!n.uniqueSymbol?.show)continue;const a=this._computeCoordinates(n,r,s),o=n.uniqueSymbol;if(!o.show)continue;const{iconAllowOverlap:l,textAllowOverlap:c}=r;for(const e of a){if(!e.enabled)continue;const t=o.parts[e.partIndex];t.show&&(!(e.partIndex?c:l)&&this._doesCollide(e)&&(e.hard?o.show=!1:t.show=!1))}o.show&&this._insertColliders(o.parts,a,r)}}return!0}_insertColliders(e,t,i){const{iconIgnorePlacement:r,textIgnorePlacement:s}=i;for(const i of t){if(!i.enabled)continue;if(i.partIndex?s:r)continue;if(!e[i.partIndex].show)continue;const t=i.xScreen+i.dxScreen,n=i.yScreen+i.dyScreen,a=t+i.width,o=n+i.height,[l,c,h,u]=this._gridIndex.getCellSpan(t,n,a,o);for(let e=c;e<=u;e++)for(let t=l;t<=h;t++)this._gridIndex.cells[e][t].push(i)}}_computeCoordinates(e,t,i){const{iconRotationAlignment:r,textRotationAlignment:s,iconTranslate:n,iconTranslateAnchor:a,textTranslate:o,textTranslateAnchor:l}=t,c=this._si,h=this._co,u=this._zoom,d=this._allNeededMatrices.get(e.tile),p=e.uniqueSymbol,m=e.colliders(i);let _=0;for(const e of m){const[t,i]=0===e.partIndex?n:o,p=0===e.partIndex?a:l,m=e.minLod<=u&&u<=e.maxLod;_+=m?0:1,e.enabled=m,e.xScreen=e.xTile*d[0]+e.yTile*d[3]+d[6],e.yScreen=e.xTile*d[1]+e.yTile*d[4]+d[7],p===Uv.fD.MAP?(e.xScreen+=h*t-c*i,e.yScreen+=c*t+h*i):(e.xScreen+=t,e.yScreen+=i),Uv.aF.VIEWPORT===(0===e.partIndex?r:s)?(e.dxScreen=e.dxPixels,e.dyScreen=e.dyPixels):(e.dxScreen=h*(e.dxPixels+e.width/2)-c*(e.dyPixels+e.height/2)-e.width/2,e.dyScreen=c*(e.dxPixels+e.width/2)+h*(e.dyPixels+e.height/2)-e.height/2)}return m.length>0&&_===m.length&&p&&(p.show=!1),m}_getProperties(e){const t=this._styleProps.get(e);if(t)return t;const i=this._styleRepository.getLayerStyleProperties?.(e,this._zoom);return this._styleProps.set(e,i),i}_doesCollide(e){const t=e.xScreen+e.dxScreen,i=e.yScreen+e.dyScreen,r=t+e.width,s=i+e.height,[n,a,o,l]=this._gridIndex.getCellSpan(t,i,r,s);for(let e=a;e<=l;e++)for(let a=n;a<=o;a++){const n=this._gridIndex.cells[e][a];for(const e of n){const n=e.xScreen+e.dxScreen,a=e.yScreen+e.dyScreen,o=n+e.width,l=a+e.height;if(!(r<n||t>o||s<a||i>l))return!0}}return!1}}var Vv=i(25330),kv=i(30393);function Bv(e){return(e.uniqueSymbol?.show&&e.uniqueSymbol?.lastShow)??!1}function zv(e,t){if(e.priority-t.priority)return e.priority-t.priority;if(Bv(e)&&!Bv(t))return-1;if(Bv(t)&&!Bv(e))return 1;const i=e.tile.key,r=t.tile.key;return i.world-r.world?i.world-r.world:i.level-r.level?i.level-r.level:i.row-r.row?i.row-r.row:i.col-r.col?i.col-r.col:e.xTile-t.xTile?e.xTile-t.xTile:e.yTile-t.yTile}class Gv{get running(){return this._running}constructor(e,t,i,r,s,n,a,o){this.selectionMode=e,this._visibleTiles=t,this._symbolRepository=i,this._styleRepository=r,this._createCollisionJob=s,this._assignTileSymbolsOpacity=n,this._symbolLayerSorter=a,this._isLayerVisible=o,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}setScreenSize(e,t){this._screenWidth===e&&this._screenHeight===t||this.restart(),this._screenWidth=e,this._screenHeight=t}restart(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}continue(e){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){const t=performance.now();if(!this._selectionJob.work(e))return!1;if(this._selectionJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-t))))return!1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){const t=performance.now();if(!this._collisionJob.work(e))return!1;if(this._collisionJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-t))))return!1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){const t=performance.now();if(!this._opacityJob.work(e))return!1;if(this._opacityJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-t))))return!1}return this._running=!1,!0}_isFeatureFiltered(e,t,i){const r=t.getFilterFlags(e),s=r&kv.g3,n=null==i.featureEffect||i.featureEffect.excludedLabelsVisible||r&kv.kU;return!(s&&n)}_getFilteredByLayer(){let e;if(this._styleRepository?.layerContexts)for(const t of this._symbolRepository.uniqueSymbols){const i=this._styleRepository.layerContexts?.get(t.styleLayerUID);if(i?.attributeView)for(const r of t.uniqueSymbols){e??=new Map,e.get(t.styleLayerUID)||e.set(t.styleLayerUID,new Set);const s=e.get(t.styleLayerUID),n=i.attributeView,a=i.layerView;this._isFeatureFiltered(r.id,n,a)&&s.add(r.id)}}return e}_resetSelection(){for(let e=0;e<this._symbolRepository.uniqueSymbols.length;e++){const t=this._symbolRepository.uniqueSymbols[e];for(let e=0;e<t.uniqueSymbols.length;e++){const i=t.uniqueSymbols[e];for(const e of i.tileSymbols)e.selectedForRendering=!1}}}_createSelectionJob(){const e="feature-tile"===this.selectionMode?Zv:jv,t=this._symbolRepository.uniqueSymbols;this._resetSelection();const i=[];let r=0,s=0;const n=this._isLayerVisible,a=this._getFilteredByLayer(),o=this._styleRepository?.layerContexts;const l=this._symbolLayerSorter;return{work:function(l){let c;const h=performance.now();for(;s<t.length;s++,r=0){const u=t[s],d=u.styleLayerUID,p=a?.get(d);let m=0;if(o){const e=o.get(d).layerView;m=e.view.allLayerViews.items.indexOf(e)}if(!n(d)){i[s]||(i[s]={styleLayerUID:d,layerOrder:m,symbols:[]});continue}i[s]||={styleLayerUID:d,symbols:[],layerOrder:m};const _=i[s];for(;r<u.uniqueSymbols.length;r++){if(c=u.uniqueSymbols[r],r%100==99&&performance.now()-h>l)return!1;if(c.lastShow=c.show,c.id&&p?.has(c.id)){c.show=!1,c.parts[0].show=!1,c.parts[1].show=!1;continue}const t=e(c);if(t){t.selectedForRendering=!0,_.symbols.push(t),c.show=!0;for(const e of c.parts)e.show=!0}else c.show=!1}}for(const e of i)e.symbols.sort(zv);return i.sort(((e,t)=>t.layerOrder-e.layerOrder)),!0},get sortedSymbols(){return i.sort(l)}}}_createOpacityJob(){const e=this._assignTileSymbolsOpacity,t=this._visibleTiles;let i=0;function r(t,i){for(const e of t.symbols.values())qv(e,i);e(t,i);for(const e of t.childrenTiles)r(e,i)}return{work(s){const n=performance.now();for(;i<t.length;i++){if(performance.now()-n>s)return!1;const a=t[i];if(null!=a.parentTile)continue;const o=performance.now();a instanceof Vv.i?r(a,o):e(a,o)}return!0}}}}function qv(e,t){for(const i of e){const e=i.uniqueSymbol;for(const i of e.parts){const r=i.targetOpacity>.5?1:-1;i.startOpacity+=r*((t-i.startTime)/Fv.v7),i.startOpacity=Math.min(Math.max(i.startOpacity,0),1),i.startTime=t,i.targetOpacity=e.show&&i.show?1:0}}}function Zv(e){let t=null,i=null,r=null;for(const s of e.tileSymbols){const e=s.tile;e.isReady&&e.isCoverage?t=s:e.isReady?i=s:e.rendering&&(r=s)}return t??i??r}function jv(e){let t=null,i=!1,r=!1;for(const s of e.tileSymbols)if(!r||!i){const e=s.tile;(!t||e.isCoverage||e.neededForCoverage&&!i)&&(t=s,(e.neededForCoverage||e.isCoverage)&&(r=!0),e.isCoverage&&(i=!0))}return r?t:null}var Wv=i(64274);class $v{static fromSymbols(e,t){let i=e.length;if(i>=Xv){let r=t;do{r/=2,i/=4}while(i>Yv&&r>Qv);const s=new Nv.HX(t,t,r);for(const t of e)s.getCell(t.xTile,t.yTile).push(t);return new $v(t,e,s)}return new $v(t,e,null)}constructor(e,t,i){this.tileCoordRange=e,this._symbols=t,this._index=i}addSymbols(e){for(const t of e)this._symbols.push(t);if(this._index)for(const t of e)this._index.getCell(t.xTile,t.yTile).push(t)}removeSymbols(e){const t=new Set(e);if(this._symbols=this._symbols.filter((e=>!t.has(e))),this._index)for(const e of this._index.cells)for(let i=0;i<e.length;i++)e[i]=e[i].filter((e=>!t.has(e)))}getSymbols(){return this._symbols}getCandidate(e,t,i,r){if(!this._index){for(const s of this._symbols)if(i===s.hash&&Math.abs(e-s.xTile)<=r&&Math.abs(t-s.yTile)<=r)return s;return null}const s=this._index.getCellSpan(e-r,t-r,e+r,t+r),[n,a,o,l]=s;for(let s=a;s<=l;s++)for(let a=n;a<=o;a++){const n=this._index.cells[s][a];for(const s of n)if(i===s.hash&&Math.abs(e-s.xTile)<=r&&Math.abs(t-s.yTile)<=r)return s}return null}}const Xv=32,Yv=8,Qv=64;class Kv{constructor(e,t){this.tileCoordRange=e,this._visibleTiles=t,this._indexMapByTile=new Map,this._uniqueSymbolsByStyleLayerId=new Map}get uniqueSymbols(){return null==this._uniqueSymbolLayerArray&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray()),this._uniqueSymbolLayerArray}registerVectorTile(e,t){const i=this._ensureIndexMap(e),r=t?.values()??i.keys();for(const e of r){const t=i.get(e);t&&(this._removeSymbols(e,t.getSymbols()),i.delete(e))}this._addSymbols(e.key,i,e.symbols),this._invalidate()}unregisterVectorTile(e){this._removeTile(e),this._invalidate()}registerFeatureTile(e){this._ensureIndexMap(e),this._invalidate()}unregisterFeatureTile(e){this._removeTile(e),this._invalidate()}insertFeatureTileMetrics(e,t){const i=this._indexMapByTile.get(e);if(!i)throw new Error(`tile ${e.id} not registered!`);this._addSymbols(e.key,i,Jv(t)),this._invalidate()}removeFeatureTileMetrics(e,t){const i=this._indexMapByTile.get(e);if(!i)return;const r=Jv(t);for(const[e,t]of i.entries()){const i=r.get(e);i&&(t.removeSymbols(i),this._removeSymbols(e,i))}this._invalidate()}deleteStyleLayers(e){for(const t of this._indexMapByTile.values())for(const i of e){const e=t.get(i);e&&(this._removeSymbols(i,e.getSymbols()),t.delete(i))}this._invalidate()}querySymbols(e,t,i,r){const s=[];for(const[r,n]of this._uniqueSymbolsByStyleLayerId.entries())for(const a of n){const n=a.tileSymbols.find((e=>e.selectedForRendering));n&&(0,Nv.Fe)(n,e,t*(window.devicePixelRatio||1),i)&&s.push({vtlSymbol:n,styleLayerUID:r,tileKey:n.tile.key})}return s}_ensureIndexMap(e){let t=this._indexMapByTile.get(e);return t||(t=new Map,this._indexMapByTile.set(e,t)),t}_invalidate(){this._uniqueSymbolLayerArray=null}_addSymbols(e,t,i){for(const[e,r]of i){let i=t.get(e);i?i.addSymbols(r):(i=$v.fromSymbols(r,this.tileCoordRange),t.set(e,i))}this._updateUniqueSymbols(e,i)}_removeTile(e){const t=this._indexMapByTile.get(e);if(t){for(const[e,i]of t.entries())this._removeSymbols(e,i.getSymbols());this._indexMapByTile.delete(e),this._invalidate()}}_removeSymbols(e,t){for(const i of t){const t=i.uniqueSymbol;if(t){if(t.tileSymbols=t.tileSymbols.filter((e=>e!==i)),0===t.tileSymbols.length){const i=this._uniqueSymbolsByStyleLayerId.get(e);i.delete(t),0===i.size&&this._uniqueSymbolsByStyleLayerId.delete(e)}i.uniqueSymbol=null}}}_updateUniqueSymbols(e,t){if(0!==t.size){for(const i of this._visibleTiles)i.parentTile||i.key.world!==e.world||i.key.level===e.level&&!i.key.equals(e)||this._matchSymbols(i,e,t);for(const[e,i]of t)for(const t of i)if(!t.uniqueSymbol){t.uniqueSymbol=new Wv.V(t);let i=this._uniqueSymbolsByStyleLayerId.get(e);i||(i=new Set,this._uniqueSymbolsByStyleLayerId.set(e,i)),i.add(t.uniqueSymbol)}}}_matchSymbols(e,t,i){if(e.key.level>t.level){const i=e.key.level-t.level;if(e.key.row>>i!==t.row||e.key.col>>i!==t.col)return}if(t.level>e.key.level){const i=t.level-e.key.level;if(t.row>>i!==e.key.row||t.col>>i!==e.key.col)return}const r=new Map;for(const[s,n]of i){const i=[],a=20+(e.key.level<t.level?1:1<<e.key.level-t.level),o=this._indexMapByTile.get(e)?.get(s);if(o)for(const r of n){if(r.uniqueSymbol)continue;const s=(0,Nv.rX)(this.tileCoordRange,r.xTile,t,e.key),n=(0,Nv.Yc)(this.tileCoordRange,r.yTile,t,e.key),l=-20,c=this.tileCoordRange+20;if(!(s>=l&&s<c&&n>=l&&n<c)){i.push(r);continue}const h=o.getCandidate(s,n,r.hash,a)?.uniqueSymbol;h?(r.uniqueSymbol=h,h.tileSymbols.push(r)):i.push(r)}i.length>0&&r.set(s,i)}for(const i of e.childrenTiles||[])this._matchSymbols(i,t,r)}_createUniqueSymbolLayerArray(){const e=this._uniqueSymbolsByStyleLayerId,t=new Array(e.size);let i,r=0;for(const[s,n]of e){const e=new Array(n.size);i=0;for(const t of n)e[i++]=t;t[r]={styleLayerUID:s,uniqueSymbols:e},r++}return t}}function Jv(e){const t=new Map;for(const i of e){const e=i.labelClassId;let r=t.get(e);r||(r=[],t.set(e,r)),r.push(i)}return t}const eb=(0,Lv.Ue)();var tb=i(58783);class ib extends tb.I{_createTransforms(){return{displayViewScreenMat3:(0,Lv.Ue)(),tileMat3:(0,Lv.Ue)()}}}class rb{constructor(){this._candidateTiles=[]}schedule(e){this._candidateTiles.includes(e)||this._candidateTiles.push(e)}reshuffle(e){const t=[];for(const i of this._candidateTiles)e>0?(i.reshuffle(),e--):t.push(i);this._candidateTiles=t}}class sb{constructor(){this._renderParams={reshuffleManager:new rb,context:null,drawPhase:1,state:new nb,stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,allowDelayedRender:!1,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1,highlightGradient:null,stencilSymbols:!0,is3D:!0,backgroundColor:null},this._backgroundTile=new ib(new Dv.Z(0,0,0,0),0,0,0,Iv.er,Iv.er,Iv.V2,Iv.V2),this._heading=0,this._declutteredForHeading=new WeakMap}dispose(){this._renderParams=null}renderBackground(e,t,i,r,s,n,a,o,l,c){const h=this._backgroundTile;this._updateRenderParameters(e,t,h,i,s,n,a,o,l,c),this._renderParams.stencilSymbols=!1,i.drawBackground(this._renderParams,h,r)}renderContent(e,t,i,r,s,n,a,o,l,c,h,u){this._declutter(i),r.forAll((({sourceLayerInfo:{data:e}})=>this._declutter(e)));const d=r.length>0;d&&this._stencilSymbols(e,t,i,r,s,n,a,o,l,c,h,u);let p=1;i.stencilRef=d?p:0,e.setStencilFunction(Ir.wb.EQUAL,i.stencilRef,255),this._render(e,t,i,s,n,a,o,l,c,h,u),r.forAll((({sourceLod:t,offset:i,sourceLayerInfo:{data:r}})=>{r.stencilRef=++p,this._renderSymbols(e,t,r,s,n,a,o,i,c,h,u)}))}_stencilSymbols(e,t,i,r,s,n,a,o,l,c,h,u){let d=1;i.stencilRef=d,e.setDepthTestEnabled(!1),e.setDepthWriteEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(Ir.xS.KEEP,Ir.xS.KEEP,Ir.xS.REPLACE),e.setStencilWriteMask(255),e.setStencilFunction(Ir.wb.ALWAYS,i.stencilRef,255),this._stencilTileSymbols(e,t,i,s,n,a,o,l,c,h,u),r.forAll((({sourceLod:t,offset:i,sourceLayerInfo:{data:r}})=>{r.stencilRef=++d,e.setStencilFunction(Ir.wb.ALWAYS,r.stencilRef,255),this._stencilTileSymbols(e,t,r,s,n,a,o,i,c,h,u)})),e.setStencilWriteMask(0),e.setBlendingEnabled(!0),e.setDepthTestEnabled(!0),e.setColorMask(!0,!0,!0,!0)}_renderSymbols(e,t,i,r,s,n,a,o,l,c,h){e.setStencilFunction(Ir.wb.EQUAL,i.stencilRef,255),this._render(e,t,i,r,s,n,a,o,l,c,h,Uv.fR.SYMBOL)}_render(e,t,i,r,s,n,a,o,l,c,h,u){this._updateRenderParameters(e,t,i,r,n,a,o,l,c,h),this._renderParams.stencilSymbols=!1,r.drawTile(this._renderParams,i,s,u)}_stencilTileSymbols(e,t,i,r,s,n,a,o,l,c,h){this._updateRenderParameters(e,t,i,r,n,a,o,l,c,h),this._renderParams.stencilSymbols=!0,i.triangleCount=0,r.drawSymbols(this._renderParams,i,s)}_updateRenderParameters(e,t,i,r,s,n,a,o,l,c){"type"in i&&"vector-tile"===i.type&&!i.stage&&i.attachWithContext(e);const h=t[0]-s.getLevelShift(t[0]),u=this._renderParams;u.context=e,u.painter=r,u.glyphMosaic=r.glyphMosaic,u.spriteMosaic=r.spriteMosaic,u.pixelRatio=l*c,u.displayLevel=h,u.requiredLevel=h;const d=s.getScale(t[0]),[p,m]=s.getOffset(t,n*d),_=Iv.dp*n*d/o,f=i.transforms.displayViewScreenMat3;f[0]=_,f[4]=-_,f[6]=-1-p-a[0]*n*2,f[7]=1+m+(1-a[1])*n*2-2;const g=u.state,y=o/c;g.size[0]=y,g.size[1]=y,g.pixelRatio=c,g.rotation=(360-this._heading)%360;const v=2/y;(0,Tr.t8)(g.displayViewMat3,v,0,0,0,-v,0,-1,1,1);const b=(0,Tr.yR)(g.displayMat3),w=(0,Co.c$)(this._heading);(0,Tr.Iu)(b,b,[y/2,y/2]),(0,Tr.U1)(b,b,w),(0,Tr.Iu)(b,b,[-y/2,-y/2]),(0,Tr.Jp)(b,g.displayViewMat3,b)}updateHeading(e){this._heading=e}_declutter(e){this._declutteredForHeading.get(e)!==this._heading&&(function(e,t){const i=e.transforms.tileUnitsToPixels,r=(0,Co.c$)(t),s=Math.cos(r),n=Math.sin(r),a=Math.ceil(512*(Math.abs(n)+Math.abs(s)));(0,Tr.yR)(eb),(0,Tr.Iu)(eb,eb,[a/2,a/2]),(0,Tr.U1)(eb,eb,r),(0,Tr.Iu)(eb,eb,[-256,-256]),(0,Tr.bA)(eb,eb,[1/8,1/8,1]),e.transforms.tileUnitsToPixels=eb;const o=[],l=new Kv(Iv.V2,o),c=new Gv("vector-tile",o,l,null,((i,r,s)=>new Hv(i,r,s,e.styleRepository,e.key.level,t)),((e,t)=>{(0,Nv.C$)(e,t,!1)}),(()=>0),(t=>{const i=e.styleRepository.getStyleLayerByUID(t).getLayoutProperty("visibility");return!i||i.getValue()!==Uv.EE.NONE}));o.push(e),l.registerVectorTile(e),c.setScreenSize(a,a),c.continue(1/0),l.unregisterVectorTile(e),e.transforms.tileUnitsToPixels=i}(e,(360-this._heading)%360),this._declutteredForHeading.set(e,this._heading))}}class nb{constructor(){this.size=[0,0],this.pixelRatio=1,this.rotation=0,this.displayMat3=(0,co.Ue)(),this.displayViewMat3=(0,co.Ue)(),this.transform=null,this.inverseTransform=null,this.viewMat2d=null,this.viewMat3=null,this.id=0,this.extent=null,this.center=null,this.scale=1,this.resolution=0,this.worldScreenWidth=0,this.spatialReference=null,this.viewpoint=null,this.getScreenTransform=null,this.toMap=null,this.toScreen=null,this.clone=null,this.copy=null,this.toJSON=null}}var ab=i(17993),ob=i(83046);class lb extends ob.m{constructor(){super(...arguments),this.blendMode=ab.iM.Normal}}(0,o._)([(0,ob.o)({count:ab.iM.COUNT})],lb.prototype,"blendMode",void 0);var cb=i(93288),hb=i(82214),ub=i(12024);class db extends lb{constructor(){super(...arguments),this.output=hb.l.Composite,this.baseOpacityMode=cb.I.NotRequired,this.premultipliedSource=ub.m.Off}}(0,o._)([(0,ob.o)({count:hb.l.COUNT})],db.prototype,"output",void 0),(0,o._)([(0,ob.o)({count:cb.I.COUNT})],db.prototype,"baseOpacityMode",void 0),(0,o._)([(0,ob.o)({count:ub.m.COUNT})],db.prototype,"premultipliedSource",void 0);class pb extends db{constructor(){super(...arguments),this.background=Rv.a.BelowLayer}}(0,o._)([(0,ob.o)({count:Rv.a.COUNT})],pb.prototype,"background",void 0);var mb=i(86295);class _b extends Dr.A{constructor(e,t){super(e,t,new Or.J(mb.R,(()=>i.e(41709).then(i.bind(i,41709)))))}}class fb extends db{constructor(){super(...arguments),this.colorizerType=Ov.U.Stretch,this.stretchType=Ov.H.Noop,this.applyColormap=!0,this.requireBilinearWithNN=!1}}(0,o._)([(0,ob.o)({count:Ov.U.COUNT})],fb.prototype,"colorizerType",void 0),(0,o._)([(0,ob.o)({count:Ov.H.COUNT})],fb.prototype,"stretchType",void 0),(0,o._)([(0,ob.o)()],fb.prototype,"applyColormap",void 0),(0,o._)([(0,ob.o)()],fb.prototype,"requireBilinearWithNN",void 0);var gb=i(54704);class yb{constructor(e){this._rctx=e,this._fbos=new Map}get(e){return this._getPool(e)}dispose(){this._fbos.forEach((e=>e.dispose())),this._fbos.clear()}_getPool(e){const t=this._fbos.get(e);if(t)return t;const i=new kr.X(this._rctx,new Br.X(e),new gb.Y(Ir.wo.DEPTH24_STENCIL8,e));return this._fbos.set(e,i),i}}var vb=i(1812),bb=i(54753);class wb{constructor(e,t){this._rctx=e,this._techniques=t,this._fbos=[],this._vectorTileHelper=new sb,this._bindParameters=new vb.p(null),this._blendConfiguration=new pb,this._current=0,this._lastUsedIds=new Array,this._lastCreatedBufferId=0,this._onHoldIds=new Array,this._vaoQuad=(0,bb.ow)(this._rctx,bb.Ar.Pos2Tex)}dispose(){this._fbos.forEach(f.M2),this._fbos=null,this._vtFBO=(0,f.M2)(this._vtFBO),this._vaoQuad=(0,f.M2)(this._vaoQuad),this._vectorTileHelper=(0,f.M2)(this._vectorTileHelper)}updateHeading(e){this._vectorTileHelper?.updateHeading(e)}_acquireBlendTechnique(e,t,i,r=ub.m.Off,s=Rv.a.BelowLayer){return this._blendConfiguration.output=t,this._blendConfiguration.blendMode=e,this._blendConfiguration.baseOpacityMode=i,this._blendConfiguration.premultipliedSource=r,this._blendConfiguration.background=s,this._techniques.precompile(Av,this._blendConfiguration),this._techniques.get(Av,this._blendConfiguration)}drawBackground(e,t){const i=this._acquireBlendTechnique(ab.iM.Normal,t?hb.l.ColorComposite:hb.l.GridComposite,cb.I.NotRequired,ub.m.Off,Rv.a.Only),r=this._rctx.bindTechnique(i,this._bindParameters,e);this._render(r)}_render(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(Ir.MX.TRIANGLE_STRIP,0,(0,ds._V)(this._vaoQuad,"geometry"))}drawGroup(e,t,i,r,s=ub.m.On){t===hb.l.Composite&&(e.fboTexture=this._fbos[this.getLastOnHoldId()].get(i).colorTexture,null==e.fboTexture&&(e.fboTexture=this._rctx.emptyTexture)),e.texture=this.currentFBO(i).colorTexture,this.closeGroup(i);const n=e.baseOpacity<1?cb.I.Required:cb.I.NotRequired,a=this._acquireBlendTechnique(r,t,n,s),o=this._rctx.bindTechnique(a,this._bindParameters,e);this._render(o)}drawImageData(e,t,i,r,s=ub.m.Off){if(null==e.texture)return;const n=e.baseOpacity<1?cb.I.Required:cb.I.NotRequired;e.fboTexture=t===hb.l.GroupBackgroundComposite||r===ab.iM.Normal&&n===cb.I.NotRequired&&s===ub.m.Off?null:this.switch(i).colorTexture,null==e.fboTexture&&(e.fboTexture=this._rctx.emptyTexture);const a=this._acquireBlendTechnique(r,t,n,s),o=this._rctx.bindTechnique(a,this._bindParameters,e);this._render(o)}drawRasterData(e,t,i,r,s){const n=s.sourceLayerInfo.data;if(!n.source)return;if(s.tile.surface.layerViewByIndex(s.layerIndex,d_.MAP).ensureSymbolizerParameters(n),!n.bind(this._rctx))return;const a=e.baseOpacity<1?cb.I.Required:cb.I.NotRequired;e.fboTexture=r===ab.iM.Normal&&a===cb.I.NotRequired?null:this.switch(i).colorTexture;const o=this._acquireRasterTechnique(n,t,r,a);if(!o)return;n.opacity=e.opacity;const l=n.getUniforms(this._rctx);l.scale=s.scale,l.offset=s.offset,l.backgroundColor=e.backgroundColor,l.fboTexture=e.fboTexture,l.baseOpacity=e.baseOpacity;const c=this._rctx.bindTechnique(o,this._bindParameters,l);this._render(c)}_acquireRasterTechnique(e,t,i,r){if(!this._rctx.capabilities.colorBufferFloat)return null;const s=e.symbolizerParameters,n=["stretch","lut","hillshade"].indexOf(s.type);return this._rasterConfiguration??=new fb,this._rasterConfiguration.output=t,this._rasterConfiguration.blendMode=i,this._rasterConfiguration.baseOpacityMode=r,this._rasterConfiguration.colorizerType=n,this._rasterConfiguration.applyColormap=!!s.colormap,this._rasterConfiguration.requireBilinearWithNN=e.isBilinearWithStretchColorRamp,this._rasterConfiguration.stretchType=e.hasStretchTypeNone()?Ov.H.Noop:Ov.H.PerBand,this._techniques.precompile(_b,this._rasterConfiguration),this._techniques.get(_b,this._rasterConfiguration)}drawVectorData(e,t,i,r,s,n,a,o){const l=this._rctx,c=s.sourceLayerInfo.data,h=s.tile.surface.layerViewByIndex(s.layerIndex,d_.MAP),u=e.baseOpacity<1?cb.I.Required:cb.I.NotRequired,d=u===cb.I.Required||e.opacity<1||r!==ab.iM.Normal||t!==hb.l.Composite,p=d?ub.m.On:ub.m.Off,m=this._acquireBlendTechnique(r,t,u,p);l.setPipelineState(m.getPipeline());let f=null,g=null;d?(g=this.currentFBO(i),null==this._vtFBO&&(this._vtFBO=new yb(this._rctx)),f=this._vtFBO.get(i),l.bindFramebuffer(f),this._clearCurrentFBO()):o&&l.clear(Ir.Hf.DEPTH);try{this._vectorTileHelper.renderBackground(l,s.sourceLod,h.painter,h.layer.styleRepository,h.schemaHelper,Math.round(1/s.scale),s.offset,a,n,h.contentZoom),c&&this._vectorTileHelper.renderContent(l,s.sourceLod,c,s.vtlNeighborInfos,h.painter,h.layer.styleRepository,h.schemaHelper,Math.round(1/s.scale),s.offset,a,n,h.contentZoom)}catch(e){_.Z.getLogger("esri.views.3d.terrain").warnOnce("A render call containing vector tiles did not resolve correctly.",e)}return!f||(l.bindFramebuffer(g),e.texture=f.colorTexture,e.offset=Rr.AG,e.scale=1,this.drawImageData(e,t,i,r,p),o)}copyFBOToTexture(e){const t=this._rctx,i=t.bindTexture(e.texture,Pd.x.TEXTURE_UNIT_FOR_UPDATES),r=e.descriptor;t.gl.copyTexImage2D(Ir.No.TEXTURE_2D,0,r.pixelFormat,0,0,r.width,r.height,0),e.generateMipmap(),t.bindTexture(i,Pd.x.TEXTURE_UNIT_FOR_UPDATES)}_clearCurrentFBO(){this._rctx.setStencilWriteMask(255),this._rctx.setClearColor(0,0,0,0),this._rctx.setClearDepth(1),this._rctx.setClearStencil(0),this._rctx.clear(Ir.Hf.COLOR|Ir.Hf.DEPTH|Ir.Hf.STENCIL)}_initFBO(e,t,i){this._rctx.bindFramebuffer(e),i&&(this._rctx.setViewport(0,0,t,t),this._clearCurrentFBO())}ensureBuffer(e){this._lastUsedIds.length=0,this._lastUsedIds.push(1),this._lastCreatedBufferId=1,this._onHoldIds.length=0,this.bind(e)}bind(e,t=0,i=!0){if(this._current=t,t>=this._fbos.length)for(let e=this._fbos.length;e<=t;e++)this._fbos.push(new yb(this._rctx));this._initFBO(this._fbos[t].get(e),e,i)}_bindNextFreeBuffer(e){this._lastUsedIds.length>0?this.bind(e,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(e,this._lastCreatedBufferId))}openGroup(e){this._onHoldIds.push(this._current),this._bindNextFreeBuffer(e)}switch(e){const t=this.currentFBO(e),i=this._current;return this._bindNextFreeBuffer(e),this._lastUsedIds.push(i),t}getLastOnHoldId(){return this._onHoldIds[this._onHoldIds.length-1]}closeGroup(e){const t=this._current;this._bindNextFreeBuffer(e),this._lastUsedIds.push(t),this._lastUsedIds.push(this._onHoldIds.pop())}unbind(){this._rctx.bindFramebuffer(null)}currentFBO(e){return this._fbos[this._current].get(e)}}class Cb{constructor(){this.sourceLayerInfo=null,this.sourceLod=[0,0,0],this.offset=[-1,0]}}var xb=i(42377);class Tb{constructor(e,t){this._texture=e,this._cache=t,this.type="tile-texture",this._refCount=1,this._texture.descriptor.context.instanceCounter.increment(Ir._g.TileTexture,this)}retain(){++this._refCount}release(){--this._refCount,0===this._refCount&&(this._cache?(this._texture.abortCompression(),this._cache.put(Sb(this.descriptor),this)):this.dispose())}dispose(){this._texture.descriptor.context.instanceCounter.decrement(Ir._g.TileTexture,this),this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}get descriptor(){return this._texture.descriptor}get cachedMemory(){return this._texture.usedMemory}}function Sb(e,t=(0,xb.gP)(e.internalFormat)){return`${e.width} ${e.pixelFormat} ${t}`}var Mb=i(37580);function Eb(e,t){let i=t.width,r=t.height;return(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement)&&(i=e.width,r=e.height),(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof Uint8Array)&&(t.pixelFormat===Ir.VI.RGBA||t.pixelFormat===Ir.VI.RGB)&&(0,jt.wt)(i)&&(0,jt.wt)(r)&&i>=16&&r>=16}class Rb extends Mb.q{constructor(e){super("TextureCompressionWorker","compress",{compress:e=>[e.data]},e)}isCompressible(e,t){return Eb(e,t)}}class Pb{constructor(e,t,i,r,s,n){this.start=e,this.end=t,this.blendMode=i,this.opacity=r,this.output=s,this.baseOpacity=n}}class Ab{constructor(e,t,i,r,s){this._rctx=e,this.tileSize=t,this._techniques=i,this._cache=r,this._compressionTracker=s,this._passParameters=new Pv,this._backgroundColor=null,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._compositor=new wb(this._rctx,this._techniques)}dispose(){this._compositor=(0,f.M2)(this._compositor),this._backgroundTexture=(0,f.RY)(this._backgroundTexture)}get backgroundIsGrid(){return null==this._backgroundColor}get backgroundColor(){return this._backgroundColor}updateHeading(e){this._compositor?.updateHeading(e)}updateTileTexture(e,t){if(!e.renderData)return;const i=e.surface,r=i.baseOpacity;let s=0,n=0,a=this.tileSize,o=!1,l=!1;const c=i.view.state.contentPixelRatio;let h=!1;Fb.clear(),Nb.length=0;const u=e.layerInfo[d_.MAP];let d=0,p=null;for(;d<u.length;d++){const t=i.layerViewByIndex(d,d_.MAP),m=t.layer,_=!(0,Ig.W4)(e,t),f=m.opacity,g=t.fullOpacity;if(l=l||(0,z.sy)(m),Mv(t))continue;if((0,eg.TK)(t)){let e="normal"!==t.layer.blendMode;if((0,z.CY)(m.parent)){const t=m.parent.uid;null!=t&&""!==t&&(e=Ib(m.parent)||e)}e&&(h=e,o=!1)}if((_||0===f)&&!h){u[d].pendingUpdates&=~(cy.TEXTURE_NOFADING&cy.TEXTURE_FADING);continue}++n;const y=(0,eg.Q)(t),v=Ob(e,d,y);if(v){if(u[d].pendingUpdates&=~(cy.TEXTURE_NOFADING&cy.TEXTURE_FADING),(0,z.CY)(m.parent)){const e=m.parent.uid;null!=e&&""!==e&&Lb(m.parent,d)}y?a=Math.max(a,this.tileSize*c):1===r&&1===g&&(t.isOpaque||this._dataToTexture(v,(0,z.i$)(m))&&v.sourceLayerInfo.data.descriptor.isOpaque)&&(o=!0),++s,null===p&&(p=d)}}const m=a/this.tileSize;0!==s&&null!==p?1===s&&!h&&this._useLayerTexture(e,p)||this._composeLayers(e,t,d-1,l,a,m,!o||h,Fb,h):this._useBackgroundTexture(e,n,t!==ng.Ns.FADING)}setBackground(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundTexture&&this._drawBackgroundTexture(this._backgroundTexture))}_ensureBackgroundTexture(){return null==this._backgroundTexture&&(this._backgroundTexture=this._buildTexture(this.tileSize,!1),this._drawBackgroundTexture(this._backgroundTexture)),this._backgroundTexture}_drawBackgroundTexture(e){this._compositor.bind(this.tileSize),this._passParameters.offset=Rr.AG,this._passParameters.scale=1,this._passParameters.opacity=1,this.backgroundColor&&(this._passParameters.backgroundColor=this.backgroundColor),this._compositor.drawBackground(this._passParameters,null!=this.backgroundColor),this._compositor.copyFBOToTexture(e),this._compositor.unbind()}_useBackgroundTexture(e,t,i){const r=e.renderData,s=!i&&null!=r.textureReference&&(e.surface.view.layerViewManager.updating||t>0)?Eg.Delayed:Eg.Immediate,n=this._ensureBackgroundTexture();r.setTextureReference(new Og(n,ng.Ns.FADING,Hb,e.surface.baseOpacity,0,1),s)}_useLayerTexture(e,t){const i=e.surface.layerViewByIndex(t,d_.MAP),r=(0,z.sy)(i.layer),s=r?e.surface.baseOpacity:1,n=r?1:e.surface.baseOpacity,a=i.fullOpacity,o=Ob(e,t,!1);return!!this._dataToTexture(o,(0,z.i$)(i.layer))&&(e.renderData.setTextureReference(new Og(o.sourceLayerInfo.data,ng.Ns.FADING,(0,Uc.al)(o.offset[0],o.offset[1],o.scale,o.scale),s,n,a)),!0)}_composeLayers(e,t,i,r,s,n,a,o,l){this._compositor.ensureBuffer(s);const c=e.surface.baseOpacity;let h=!1,u=Ir.cw.LINEAR_MIPMAP_LINEAR,d=!1,p=0;for(let t=i;t>=0;t--){const i=e.surface.layerViewByIndex(t,d_.MAP),m=i.layer,_=(0,eg.Q)(i),f=Ob(e,t,_),g=m.opacity,y=!(0,Ig.W4)(e,i);if(!f||(0===g||y)&&!l)continue;const v=!(0,z.sy)(m)&&!h;v&&(h=!0);let b=!1;o.forEach((e=>{e.start===t&&(e.output=r?hb.l.Composite:a&&v?this.backgroundIsGrid?hb.l.GridComposite:hb.l.ColorComposite:hb.l.Composite,e.baseOpacity=v?c:1,Nb.push(e),this._compositor.openGroup(s),b=!0)}));const w=0===p,C=b?hb.l.GroupBackgroundComposite:a&&w?this.backgroundIsGrid?hb.l.GridComposite:hb.l.ColorComposite:hb.l.Composite,x=ab.pU[(0,eg.TK)(i)?i.layer.blendMode:"normal"];for(this._passParameters.baseOpacity=v&&!b&&c<1?c:1,this._passParameters.opacity=g,(0,eg.Ke)(f)?d=this._compositor.drawVectorData(this._passParameters,C,s,x,f,n,this.tileSize,d):(0,eg.Ay)(f)?(this._compositor.drawRasterData(this._passParameters,C,s,x,f),Db(f)&&(u=Ir.cw.NEAREST)):this._dataToTexture(f,(0,z.i$)(m))&&(this._passParameters.texture=f.sourceLayerInfo.data.texture,this._passParameters.offset=f.offset,this._passParameters.scale=f.scale,this._compositor.drawImageData(this._passParameters,C,s,x));Nb.length>0&&Nb[Nb.length-1].end===t;){const e=Nb.pop();this._passParameters.baseOpacity=e.baseOpacity,this._passParameters.opacity=e.opacity,this._passParameters.offset=Rr.AG,this._passParameters.scale=1,this._compositor.drawGroup(this._passParameters,e.output,s,ab.pU[e.blendMode])}p++}const m=e.renderData,_=l||h&&c<1,f=m.ensureTexture(s,_,t,(()=>this._buildTexture(s,_,u)));this._compositor.copyFBOToTexture(f),this._compositor.unbind(),m.setTextureReference(new Og(f,t,Hb,h?1:c,0,1))}_dataToTexture(e,t){if((0,eg.S3)(e)){const i=e.sourceLayerInfo,r=1===e.scale&&!t;i.data=this._buildTexture(i.data,!0,r,e.tile.onCompressionFinished),e.tile.setMemoryDirty()}return(0,eg.z7)(e)}_buildTexture(e,t,i=Ir.cw.LINEAR_MIPMAP_LINEAR,r=(()=>{})){if(null==e)return null;const s=new Br.X;s.wrapMode=Ir.e8.CLAMP_TO_EDGE,s.samplingMode="boolean"==typeof i?Ir.cw.LINEAR_MIPMAP_LINEAR:i,s.maxAnisotropy=this._maxAnisotropy,s.preMultiplyAlpha=!0,s.flipped=!0,s.hasMipmap=!0,t||(s.pixelFormat=Ir.VI.RGB);const n=this._rctx,a="boolean"==typeof i&&i;let o;if("number"==typeof e)s.width=s.height=e,o=this._buildTileTexture(s);else if((0,L_.Cm)(e))s.isOpaque=e.isOpaque,s.isOpaque&&(s.pixelFormat=Ir.VI.RGB),s.width=e.element.width,s.height=e.element.height,o=this._buildTileTexture(s,a,r,e.element);else try{s.width=e.width,s.height=e.height,o=this._buildTileTexture(s,a,r,e)}catch(e){o=new Tb((0,bb.l_)(n)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const l=n.bindTexture(o.texture,Pd.x.TEXTURE_UNIT_FOR_UPDATES);return o.generateMipmap(),n.bindTexture(l,Pd.x.TEXTURE_UNIT_FOR_UPDATES),o}_buildTileTexture(e,t=!1,i=(()=>{}),r){const s=this._cache.pop(Sb(e,!1))??this._cache.pop(Sb(e,!0));if(t&&=Eb(r,e),s)return s.retain(),t?s.texture.enableCompression({compressionTracker:this._compressionTracker,compressionCallback:i}):s.texture.disableCompression(),s.texture.setData(r),s;e.compress=t?{compressionTracker:this._compressionTracker,compressionCallback:i}:void 0;const n=new Pd.x(this._rctx,e,r);return new Tb(n,this._cache)}get test(){}}function Ob(e,t,i){Ub.layerIndex=t,Ub.vtlNeighborInfos.clear();const r=e.layerInfo[d_.MAP][t];if((0,Er.t8)(Ub.offset,0,0),Ub.tile=e,Ub.scale=1,Ub.sourceLod=e.lij,Ub.sourceLayerInfo=r,Ub.isVTLBackground=i,r.data)return i&&e.forEachLoadedNeighbor(((i,s)=>{if(i.level!==e.level)return;const n=i.layerInfo[d_.MAP][t];if(!(0,eg.B9)(n)||r.data===n.data)return;const a=Ub.vtlNeighborInfos.pushNew();a.offset=Vb[s],a.sourceLod=i.lij,a.sourceLayerInfo=n})),Ub;const s=r.upsampleInfo,n=s?.tile?.layerInfo[d_.MAP][t];return n&&s.tile?(Ub.tile=s.tile,(0,Er.JG)(Ub.offset,s.offset),Ub.scale=s.scale,Ub.sourceLod=s.tile.lij,Ub.sourceLayerInfo=n,Ub):i?Ub:null}function Db(e){const t=e.sourceLayerInfo.data;return!!t.source&&"nearest"===t.interpolation}function Ib(e){let t="normal"!==e.blendMode;return(0,z.CY)(e.parent)&&(t=Ib(e.parent)||t),t}function Lb(e,t){(0,z.CY)(e.parent)&&Lb(e.parent,t);const i=e.uid;if(null!=i&&""!==i){const r=Fb.get(i);r?r.start=t:Fb.set(i,new Pb(t,t,e.blendMode,e.opacity,hb.l.Composite,1))}}const Fb=new Map,Nb=new Array,Ub=new class{constructor(){this.sourceLod=[0,0,0],this.offset=[0,0],this.scale=1,this.layerIndex=0,this.isVTLBackground=!1,this.vtlNeighborInfos=new ud.Z({allocator:e=>e||new Cb})}},Hb=(0,Uc.al)(0,0,1,1),Vb=new Array;Vb[Sg.X.NORTH]=[0,-1],Vb[Sg.X.NORTH_EAST]=[-1,-1],Vb[Sg.X.EAST]=[-1,0],Vb[Sg.X.SOUTH_EAST]=[-1,1],Vb[Sg.X.SOUTH]=[0,1],Vb[Sg.X.SOUTH_WEST]=[1,1],Vb[Sg.X.WEST]=[1,0],Vb[Sg.X.NORTH_WEST]=[1,-1];var kb=i(9779);const Bb=1e-6;class zb{constructor(e,t,i,r,s){this.aabb=e,this.axis=t,this.d=i,this.midStartIndex=r,this.rightStartIndex=s}}class Gb{constructor(e,t,i,r){this.globalTriangleVertexIndices=e,this.firstTriangleIndex=t,this.positions=r,this._rayDirection=(0,O.Ue)(),this._callback=Xb,this._intersectionOptions=$b,this.bspNodeTree=new Array;const s=i-t,n=new(s<jb?Uint8Array:s<Wb?Uint16Array:Uint32Array)(s);this.triangleIndexMap=n;for(let e=0;e<s;++e)n[e]=e;{const a=function(e,t,i,r,s){const n=i-t,a=new Float32Array(6*n);for(let i=0;i<n;++i){const n=3*(i+t),o=e[n]*s,l=e[n+1]*s,c=e[n+2]*s;for(let e=0;e<3;++e){const t=r[o+e],s=r[l+e],n=r[c+e];a[6*i+e]=Math.min(t,s,n),a[6*i+3+e]=Math.max(t,s,n)}}return a}(e,t,i,r.data,r.stride),o=(0,jt.uZ)(Math.log2(s/40),2,10),l=(e,t,i)=>{const r=function(e,t,i,r){if(r<=i)return(0,xg.al)(NaN,NaN,NaN,NaN,NaN,NaN);{const r=6*e[i];for(let e=0;e<3;++e)qb[e]=t[r+0+e],Zb[e]=t[r+3+e]}for(let s=i+1;s<r;++s){const i=6*e[s];for(let e=0;e<3;++e)qb[e]=Math.min(qb[e],t[i+0+e]),Zb[e]=Math.max(Zb[e],t[i+3+e])}return(0,xg.al)(qb[0],qb[1],qb[2],Zb[0],Zb[1],Zb[2])}(n,a,e,t),s=t-e;if(s<=40){const i=new zb(r,void 0,0,e,t);return this.bspNodeTree.push(i),i}const{axis:c,midValue:h}=function(e){const t=e[3]-e[0],i=e[4]-e[1],r=e[5]-e[2],s=t>i?t>r?0:i>r?1:2:i>r?1:r>t?2:0;return{axis:s,midValue:(e[s]+e[s+3])/2}}(r),u=function(e,t,i,r,s,n){let a=i,o=r;for(;a<o;){const i=e[a];t[6*i+s+3]<=n?++a:(--o,e[a]=e[o],e[o]=i)}let l=a;for(o=r;l<o;){const i=e[o-1];t[6*i+s]>=n?--o:(e[o-1]=e[l],e[l]=i,++l)}return{next:a,mid:l}}(n,a,e,t,c,h),d=(e,t)=>{if(i>o)return;const r=t-e;return r<40||r>=.8*s?void 0:l(e,t,i+1)},p=new zb(r,c,h,u.next,u.mid);return this.bspNodeTree.push(p),p.leftNode=d(e,u.next),p.rightNode=d(u.mid,t),p};l(0,s,0)}}intersectRayTriangleRange(e,t){if(e>=t)return;const i=this.positions;(0,av.ET)(this._rayFrom,this._rayDirection,e,t,this.globalTriangleVertexIndices,i.data,i.stride,this._intersectionOptions.normalRequired,this._callback,this.triangleIndexMap,this.firstTriangleIndex),Gb.numFacesTested+=t-e}intersectRay(e,t,i,r){Gb.numFacesTested=0;const s=e,n=t,a=n[0]-s[0],o=n[1]-s[1],l=n[2]-s[2];if(a*a+o*o+l*l<Bb)return;this._rayFrom=s;const c=this._rayDirection;c[0]=a,c[1]=o,c[2]=l;const h=this.triangleIndexMap.length;this._callback=r,this._intersectionOptions=i,this.intersectRayBSP(this.bspNodeTree[0],0,h),this._callback=Xb,this._intersectionOptions=$b}intersectRayBSP(e,t,i){const r=this._rayFrom,s=this._rayDirection;if(!function(e,t,i){const r=t,s=i;let n=0,a=1/0;for(let t=0;t<3;++t){{const i=e[t];if(r[t]<i){if(s[t]<=Bb)return!1;const e=(i-r[t])/s[t];n=Math.max(n,e)}else if(s[t]<=-1e-6){const e=(i-r[t])/s[t];a=Math.min(a,e)}if(n>a)return!1}{const i=e[t+3];if(r[t]>i){if(s[t]>=-1e-6)return!1;const e=(i-r[t])/s[t];n=Math.max(n,e)}else if(s[t]>=Bb){const e=(i-r[t])/s[t];a=Math.min(a,e)}if(n>a)return!1}}return!0}(e.aabb,r,s))return;const n=e.axis,a=e.d;if(r[n]<a||s[n]<0){const i=t,r=e.midStartIndex;if(i<r){const t=e.leftNode;void 0!==t?this.intersectRayBSP(t,i,r):this.intersectRayTriangleRange(i,r)}}if(this.intersectRayTriangleRange(e.midStartIndex,e.rightStartIndex),r[n]>a||s[n]>0){const t=e.rightStartIndex,r=i;if(t<r){const i=e.rightNode;void 0!==i?this.intersectRayBSP(i,t,r):this.intersectRayTriangleRange(t,r)}}}static{this.numFacesTested=0}get estimatedMemoryUsage(){return this.triangleIndexMap.byteLength}}const qb=[1/0,1/0,1/0],Zb=[-1/0,-1/0,-1/0];const jb=255,Wb=65535,$b=new av.sT,Xb=()=>{};var Yb=i(41044),Qb=i(47744),Kb=i(81749),Jb=i(19596),ew=i(948),tw=i(13896),iw=i(57716),rw=i(31839),sw=i(42510),nw=i(76144),aw=i(91041);class ow extends aw.W{constructor(e){super(),this.spherical=e,this.overlayMode=nw.gT.Disabled,this.tileBlendInput=Qb.R.LayerOnly,this.transparencyMode=kb.w.Opaque,this.pbrMode=sw.f7.Simplified,this.receiveShadows=!1,this.backfaceCullingEnabled=!1,this.textureFadingEnabled=!1,this.renderOccluded=!1,this.screenSpaceReflections=!1,this.cloudReflections=!1,this.screenSizePerspective=!1,this.receiveAmbientOcclusion=!1,this.tileBorders=!1,this.visualizeNormals=!1,this.normalType=iw.r.Compressed,this.textureCoordinateType=rw.I.Default,this.highStepCount=!1,this.useCustomDTRExponentForWater=!1,this.useFillLights=!1,this.hasColorTexture=!0,this.draped=!1}get overlayEnabled(){return this.overlayMode!==nw.gT.Disabled}}(0,o._)([(0,ob.o)({count:nw.gT.COUNT})],ow.prototype,"overlayMode",void 0),(0,o._)([(0,ob.o)({count:Qb.R.COUNT})],ow.prototype,"tileBlendInput",void 0),(0,o._)([(0,ob.o)({count:kb.w.COUNT})],ow.prototype,"transparencyMode",void 0),(0,o._)([(0,ob.o)({count:sw.f7.COUNT})],ow.prototype,"pbrMode",void 0),(0,o._)([(0,ob.o)()],ow.prototype,"receiveShadows",void 0),(0,o._)([(0,ob.o)()],ow.prototype,"backfaceCullingEnabled",void 0),(0,o._)([(0,ob.o)()],ow.prototype,"textureFadingEnabled",void 0),(0,o._)([(0,ob.o)()],ow.prototype,"renderOccluded",void 0),(0,o._)([(0,ob.o)()],ow.prototype,"screenSpaceReflections",void 0),(0,o._)([(0,ob.o)()],ow.prototype,"cloudReflections",void 0),(0,o._)([(0,ob.o)()],ow.prototype,"screenSizePerspective",void 0),(0,o._)([(0,ob.o)()],ow.prototype,"receiveAmbientOcclusion",void 0),(0,o._)([(0,ob.o)()],ow.prototype,"tileBorders",void 0),(0,o._)([(0,ob.o)()],ow.prototype,"visualizeNormals",void 0);const lw=(0,xg.Ue)();let cw=class extends ys.tY{get _isGlobal(){return this._stage.viewingMode===Si.JY.Global}get _techniques(){return this._context.techniques}get _rctx(){return this._context.renderContext.rctx}constructor(e,t,i,r,s,n){super({}),this._overlayRenderer=e,this._stage=t,this._allTiles=i,this._ellipsoidRadius=r,this._compressionTracker=s,this.type=km.q.TERRAIN,this.isGround=!0,this._passParameters=new Fg.T,this._drawParameters=new tw.w,this._renderDataPool=new qf.Z(Hg),this._visiblePatchesByOrigin=new Map,this._allPatchesByOrigin=new Map,this._patchesByOriginDirty=!0,this._patchSortingDirty=!0,this._tileIterator=new Ig.AA,this._castShadows=!1,this._inViewshed=!1,this._tileRenderer=null,this._stencilEnabledLayerExtents=new Array,this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this.renderOccludedFlags=Jb.yD.Occlude,this.produces=new Map([[ew.r.OPAQUE_TERRAIN,()=>this._produces()&&this.transparency===kb.w.Opaque],[ew.r.TRANSPARENT_TERRAIN,()=>this._produces()&&(this.transparency===kb.w.Transparent||this.transparency===kb.w.InvisibleWithDraped)],[ew.r.OCCLUDED_GROUND,()=>this._produces()&&this.renderOccludedFlags===og.Qi]]),this._tileSize=256,this._configuration=new ow(t.viewingMode===Si.JY.Global),this._tileTextureCache=new zf(((e,t)=>n.newCache(e,t)),"TileTexture"),this.tileGeometryCache=new Sv(n)}normalizeCtorArgs(){return{}}initialize(){this._stage.addRenderPlugin(this),this.addHandles((0,n.YP)((()=>this._overlayRenderer.rendersOccludedDraped),(e=>{this.renderOccludedFlags=e?og.Qi:Jb.yD.Occlude,this.setNeedsRender()}),n.Z_))}destroy(){this._stage.removeRenderPlugin(this),this._tileTextureCache.destroy(),this.tileGeometryCache.destroy()}_produces(){return this.visible&&!!this._rootTiles&&!this.renderingDisabled}consumes(){return this._overlayRenderer.hasWater?ys.of:ys.jt}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setDirty()}set visible(e){this._set("visible",!!e),this.setDirty()}updateHeading(e){this._tileRenderer?.updateHeading(e)}set transparency(e){this._configuration.transparencyMode!==e&&(this._configuration.transparencyMode=e,this.setNeedsRender())}get transparency(){return this._configuration.transparencyMode}get renderPatchBorders(){return this._configuration.tileBorders}set renderPatchBorders(e){this._configuration.tileBorders!==e&&(this._configuration.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get visualizeNormals(){return this._configuration.visualizeNormals}set visualizeNormals(e){this._configuration.visualizeNormals!==e&&(this._configuration.visualizeNormals=e,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}get cullBackFaces(){return this._configuration.backfaceCullingEnabled}set cullBackFaces(e){this._configuration.backfaceCullingEnabled!==e&&(this._configuration.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(e){this._set("renderOrder",e),this._setSortingDirty()}get layerViewUid(){return fl.xX}get slicePlaneEnabled(){return this._configuration.hasSlicePlane}set slicePlaneEnabled(e){this._configuration.hasSlicePlane!==e&&(this._configuration.hasSlicePlane=e,this.setNeedsRender())}set textureFadingEnabled(e){this._configuration.textureFadingEnabled!==e&&(this._configuration.textureFadingEnabled=e,this.setNeedsRender())}set pbrMode(e){this._configuration.pbrMode!==e&&(this._configuration.pbrMode=e,this.setNeedsRender())}setDebugScreenSizePerspective(e){this._configuration.screenSizePerspective!==e&&(this._configuration.screenSizePerspective=e,this.setNeedsRender())}setRootTiles(e){this._rootTiles=e,this.setDirty()}setStencilEnabledLayerExtents(e){this._stencilEnabledLayerExtents=e,this._setSortingDirty()}set tileSize(e){this._tileSize=e,null!=this._tileRenderer&&(this._tileRenderer.tileSize=e),this.setDirty()}get tileSize(){return this._tileSize}_ensureRenderData(e){e.renderData||(e.renderData=this._renderDataPool.acquire(),e.renderData.init(e,this._getLocalOriginOfTile(e)))}loadTile(e){this._ensureRenderData(e),this.updateTileGeometryState(e),this.reuseTextureFromParent(e)||this.updateTileTexture(e,cy.TEXTURE_FADING)}reuseTextureFromParent(e){const t=e.parent;if(!t)return!1;const i=(0,Uc.al)(1&e.lij[2]?.5:0,1&e.lij[1]?0:.5,.5,.5);return t.renderData?.reuseTexture(e.renderData,i)??!1}updateTileTexture(e,t){null!=this._tileRenderer&&(this._tileRenderer.updateTileTexture(e,t===cy.TEXTURE_FADING?ng.Ns.FADING:ng.Ns.UNFADED),this.setNeedsRender(),e.resetPendingUpdate(t))}updateTileGeometryState(e){for(const t of e.layerInfo[d_.ELEVATION])t.pendingUpdates&=~cy.GEOMETRY;e.resetPendingUpdate(cy.GEOMETRY);const t=e.renderData.updateGeometryState();return t&&this.setDirty(),t}updateGeometryIfNeeded(e){e.loaded&&e.renderData.updateGeometryIfNeeded(this._rctx)}unloadTile(e){const t=e.renderData;t&&(t.releaseGeometry(),this._renderDataPool.release(t),t.clear(),e.renderData=null,e.setMemoryDirty(),this.setDirty())}_getLocalOriginOfTile(e){const t=Math.max(0,7*Math.floor((e.level-3)/7));if(this._isGlobal&&0===t)return O.AG;for(;e.parent&&e.level>t;)e=e.parent;return e.centerAtSeaLevel}getStats(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.setNeedsRender())}setDirty(e=os.Xx.UPDATE){this._patchesByOriginDirty=!0,this._context.requestRender(e)}_setSortingDirty(e=os.Xx.UPDATE){this._patchSortingDirty=!0,this._context.requestRender(e)}setNeedsRender(e=os.Xx.UPDATE){this._context.requestRender(e)}initializeRenderContext(e){this._context=e,this._tileRenderer=new Ab(this._rctx,this._tileSize,this._techniques,this._tileTextureCache,this._compressionTracker),this.updateTileBackground()}uninitializeRenderContext(){this._tileRenderer=(0,f.M2)(this._tileRenderer)}intersect(e,t,i,r){if(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&this.transparency!==kb.w.Opaque)return;const s=hw,n=uw;(0,mr.d)(s,r,i),(0,mr.i)(n,1/s[0],1/s[1],1/s[2]);const a=e.results.min,o=e.results.max,l=e.results.ground,c=e.options.store===Hm.e.MIN,h=!!e.results.ground.target,u=(0,fl.lV)(e.verticalOffset),d=e.tolerance;let p,m=c&&null!=a.distance?a.distance:1/0;const _=e.options,f=_.normalRequired||!_.backfacesTerrain,g=new av.sT(!1,f),y=h=>{const y=h.renderData;if(!y?.vao)return;const v=y.geometry;(0,xg.t8)(lw,v.boundingBox);const b=y.localOrigin;null!=u&&(u.localOrigin=b,u.applyToAabb(lw));const w=lw;if(dw[0]=i[0]-b[0],dw[1]=i[1]-b[1],dw[2]=i[2]-b[2],!(0,av.Fw)(w,dw,n,d,m))return;const C=(e,t,i)=>{e.set(this.type,h,t,i),m=c&&null!=a.distance?a.distance:1/0},x=(n,c,h)=>{if((!f||null!=h)&&n>=0&&(_.backfacesTerrain||(0,mr.e)(h,s)<0)&&(_.invisibleTerrain||!_.selectionMode||null==t||t(i,r,n))){if((null==l.distance||n<l.distance)&&C(l,n,h),_.isFiltered)return;_.store===Hm.e.ALL&&(null==p?(p=new Vm.x(e.ray),C(p,n,h),e.results.all.push(p)):n<p.distance&&C(p,n,h)),(null==a.distance||n<a.distance)&&C(a,n,h),_.store!==Hm.e.MIN&&(null==o.distance||n>o.distance)&&C(o,n,h)}},T=pw;(0,mr.d)(T,r,b);const{indices:S,indexCount:M}=v,E=v.vertexAttributes,R=E.getField(Jr.T.POSITION,Cv.ct),P=new Kb.U(R.typedBuffer,3,E.stride/4),A=M/3;if(!u&&A>200){const e=h.renderData;null==e.intersectionData&&(e.intersectionData=new Gb(S,0,A,P)),e.intersectionData.intersectRay(dw,T,g,x)}else(0,av.CN)(dw,T,0,A,S,P,u,g,x)},v=this._rootTiles;null!=v&&(()=>{const t=this._tileIterator;t.reset(v);const r=e.options.invisibleTerrain;for(let e=t.next();e;e=t.next())!(e.visible||r&&e.intersectsClippingArea)||null==u&&!e.intersectsRay(i,s,d,m)||h&&this._useStencilForTile(e)?t.skipSubtree():y(e)})()}processScaleRangeQueries(e,t){if(!t.done&&e)for(this._updatePatchGroups();e.updating&&!t.done;){e.prepare();for(const t of this._visiblePatchesByOrigin.values())for(const i of t)null!=i.renderData?.textureReference&&e.queriesForTile(i);e.process(),t.madeProgress()}}acquireTechniques(e){const t=!!(0,m.Z)("enable-feature:terrain-shadows")&&e.bind.shadowMap.enabled;t!==this._castShadows&&(this._castShadows=t,this._patchesByOriginDirty=!0);const i=e.bind.viewshedEnabled;if(this._inViewshed!==i&&(this._inViewshed=i,this._patchesByOriginDirty=!0),e.bind.slot===ew.r.OCCLUDED_GROUND){if(0==(e.renderOccludedMask&og.Qi))return null}else{const t=this.transparency===kb.w.Opaque?ew.r.OPAQUE_TERRAIN:ew.r.TRANSPARENT_TERRAIN;if(e.bind.slot!==t)return null}if(this.transparency===kb.w.Invisible)return null;const r=this._configuration;switch(r.screenSpaceReflections=r.cloudReflections=r.receiveShadows=r.receiveAmbientOcclusion=r.renderOccluded=r.hasHighlightMixTexture=!1,r.overlayMode=this._overlayRenderer.mode,e.output){case Yb.H_.Color:case Yb.H_.ColorEmission:{r.screenSpaceReflections=null!=e.bind.ssr.lastFrameColor,r.cloudReflections=null!=e.bind.clouds.data,r.receiveShadows=e.bind.shadowMap.ready;const t=e.bind.slot===ew.r.OCCLUDED_GROUND;return r.renderOccluded=t,r.receiveAmbientOcclusion=!t&&null!=e.bind.ssao,this._acquireTechnique(e.output)}case Yb.H_.Shadow:case Yb.H_.ShadowExcludeHighlight:return this._castShadows?this._acquireTechnique(Yb.H_.Shadow):null;case Yb.H_.ViewshedShadow:return this._inViewshed?this._acquireTechnique(Yb.H_.ViewshedShadow):null;case Yb.H_.Depth:case Yb.H_.Normal:return this._acquireTechnique(e.output);case Yb.H_.ObjectAndLayerIdColor:return this._acquireTechnique(Yb.H_.ObjectAndLayerIdColor);case Yb.H_.Highlight:return r.hasHighlightMixTexture=null!=e.bind.highlightMixTexture,this._overlayRenderer.hasHighlights?this._acquireTechnique(Yb.H_.Highlight):null}return null}render(e,t){switch(this._updatePatchGroups(),t.useStencil=!1,e.output){case Yb.H_.Color:case Yb.H_.ColorEmission:{const i=e.bind.slot===ew.r.OCCLUDED_GROUND?xv.D.Occluded:xv.D.Color;this._renderMaterialPass(e,t,i);break}case Yb.H_.Depth:case Yb.H_.Normal:this._renderAuxiliaryPass(e,t,xv.D.Color,this._visiblePatchesByOrigin);break;case Yb.H_.Highlight:{const i=e.bind.highlight?.name;i&&this._overlayRenderer.hasHighlights&&this._overlayRenderer.renders(xv.D.Highlight)&&this._overlayRenderer.hasHighlight(i)&&this._renderAuxiliaryPass(e,t,xv.D.Highlight,this._visiblePatchesByOrigin);break}case Yb.H_.Shadow:case Yb.H_.ShadowExcludeHighlight:case Yb.H_.ViewshedShadow:this._renderAuxiliaryPass(e,t,null,this._allPatchesByOrigin);break;case Yb.H_.ObjectAndLayerIdColor:this._renderAuxiliaryPass(e,t,xv.D.ObjectAndLayerIdColor,this._visiblePatchesByOrigin)}}updateTileBackground(e){if(null==this._tileRenderer)return;const t=this._tileRenderer;let i;if(null!=e){const t=xe.Z.toUnitRGBA(e);i=(0,O.al)(t[0]||0,t[1]||0,t[2]||0)}t.setBackground(i),this._allTiles.forAll((e=>t.updateTileTexture(e,ng.Ns.FADING))),this._configuration.tileBlendInput=t.backgroundIsGrid?Qb.R.GridComposite:null!=t.backgroundColor?Qb.R.ColorComposite:Qb.R.LayerOnly,this.setNeedsRender()}_updatePatchGroups(){if(this._patchesByOriginDirty&&(this._rebuildPatchGroups(),this._patchesByOriginDirty=!1,this._patchSortingDirty=!0),this._patchSortingDirty&&this.renderOrder!==cv.z.NONE){const e=Array.from(this._visiblePatchesByOrigin.values()),t=this._stencilEnabledLayerExtents;for(const i of e)(0,Ig.zW)(this.renderOrder,i,t);e.sort(((e,t)=>(0,Ig.dF)(e[0],t[0],this.renderOrder))),this._visiblePatchesByOrigin=new Map(e.map((e=>[e[0].renderData.localOrigin,e]))),this._patchSortingDirty=!1}}_rebuildPatchGroups(){const e=this._rootTiles;if(null!=e){e[0]?.surface.checkAllTilesWaterproofness(),this._visiblePatchesByOrigin.clear(),this._allPatchesByOrigin.clear();for(const t of e)this._rebuildPatchGroupsForRootTile(t)}}_rebuildPatchGroupsForRootTile(e){const t=this._tileIterator;for(t.resetOne(e);!t.done;){const e=t.next(),i=e.renderData;if(!i){this._numTilesCulled++;continue}const r=i.localOrigin;if(this._castShadows||this._inViewshed){let t=this._allPatchesByOrigin.get(r);t||(t=[],this._allPatchesByOrigin.set(r,t)),t.push(e)}if(!e.visible){this._numTilesCulled++,t.skipSubtree();continue}let s=this._visiblePatchesByOrigin.get(r);s||(s=[],this._visiblePatchesByOrigin.set(r,s)),s.push(e),t.skipSubtree()}}_useStencilForTile(e){for(const t of this._stencilEnabledLayerExtents)if(e.intersectsExtent(t))return!0;return!1}_renderAuxiliaryPass(e,t,i,r){const s=e.rctx;this._passParameters.overlayContent=i,s.bindTechnique(t,e.bind,this._passParameters);const n=this._stencilEnabledLayerExtents.length>0;r.forEach((r=>{this._drawParameters.origin=r[0].renderData.localOrigin,t.program.bindDraw(e.bind,this._passParameters,this._drawParameters);for(let s=0;s<r.length;s++)this._renderPatch(e,t,r[s],Ir.MX.TRIANGLES,n,i)})),e.rctx.bindVAO(null)}_renderMaterialPass(e,t,i){const{rctx:r}=e;this._passParameters.overlayContent=i,r.bindTechnique(t,e.bind,this._passParameters),this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0;const s=e.bind.camera,n=t.program;if(this._configuration.screenSizePerspective&&this.pointsOfInterest){const e=(0,Fd.Gw)(this._stage.viewingMode,this._ellipsoidRadius),t=this.pointsOfInterest.centerOnSurfaceFrequent.distance;e.update({distance:t,fovY:s.fovY})}const a=this._stencilEnabledLayerExtents.length>0,o=i===xv.D.Occluded;o&&(n.bindTexture("tex",r.emptyTexture),n.setUniform3fv("textureOpacities",O.AG),n.setUniform4fv("texOffsetAndScale",Uc.AG));const l=null!=this._tileRenderer?.backgroundColor?this._tileRenderer.backgroundColor:O.AG;this._configuration.tileBlendInput===Qb.R.ColorComposite&&n.setUniform3fv("backgroundColor",l);const c=this.wireframe?Ir.MX.LINES:Ir.MX.TRIANGLES;this._configuration.textureFadingEnabled&&n.bindTexture("texNext",r.emptyTexture);const h=this._visiblePatchesByOrigin;for(const r of h.values()){const s=r[0].renderData.localOrigin;this._drawParameters.origin=s,t.program.bindDraw(e.bind,this._passParameters,this._drawParameters),this._numOriginsRendered++;for(const s of r){const r=s.renderData,l=r.textureReference;if(null!=l){if(!o){n.setUniform4fv("texOffsetAndScale",l.offsetAndScale),n.bindTexture("tex",l.texture.texture);const e=r.textureFadeFactor,t=e<1?r.nextTextureReference:null;this._configuration.textureFadingEnabled&&t&&e<1?(n.setUniform1f("fadeFactor",e),n.setUniform4fv("nextTexOffsetAndScale",t.offsetAndScale),n.setUniform3fv("nextTexOpacities",t.opacities),n.bindTexture("texNext",t.texture.texture)):n.setUniform1f("fadeFactor",1),r.textureIsFading&&this.setNeedsRender(),n.setUniform3fv("textureOpacities",l.opacities)}this._renderPatch(e,t,s,c,a,i),s.renderOrder=this._numTilesRendered,this._numTilesRendered++}}}e.rctx.bindVAO(null)}_renderPatch(e,t,i,r,s,n){const a=i.renderData,o=a.vao,l=o?.indexBuffer;if(!o||null==l)return void(eg.T9&&console.error("Rendered tile with no indices: ",i.lij," : ",a));const c=t.program;null==n||this._overlayRenderer.isEmpty||this._bindOverlayPatchData(c,a.overlay),s&&(t.useStencil=this._useStencilForTile(i),e.rctx.setPipelineState(t.getPipeline()));const h=a.geometry.indexCount;e.rctx.bindVAO(o),c.assertCompatibleVertexAttributeLocations(o),e.rctx.drawElements(r,h,l.indexType,0)}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}_acquireTechnique(e){return this._configuration.output=e,this._techniques.get(Ng,this._configuration)}get test(){}hasHighlight(e){return this._overlayRenderer.hasHighlight(e)}};(0,o._)([(0,x.Cb)({readOnly:!0})],cw.prototype,"_isGlobal",null),(0,o._)([(0,x.Cb)()],cw.prototype,"renderOccludedFlags",void 0),(0,o._)([(0,x.Cb)({value:!1})],cw.prototype,"renderingDisabled",null),(0,o._)([(0,x.Cb)({value:!0})],cw.prototype,"visible",null),(0,o._)([(0,x.Cb)()],cw.prototype,"renderPatchBorders",null),(0,o._)([(0,x.Cb)()],cw.prototype,"visualizeNormals",null),(0,o._)([(0,x.Cb)()],cw.prototype,"cullBackFaces",null),(0,o._)([(0,x.Cb)({value:cv.z.FRONT_TO_BACK})],cw.prototype,"renderOrder",null),(0,o._)([(0,x.Cb)()],cw.prototype,"wireframe",null),cw=(0,o._)([(0,S.j)("esri.views.3d.terrain.TerrainRenderer")],cw);const hw=(0,O.Ue)(),uw=(0,O.Ue)(),dw=(0,O.Ue)(),pw=(0,O.Ue)();class mw{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}}var _w=i(39717),fw=i(76060);let gw=class extends E.Z{constructor(e){super(e)}initialize(){this.addHandles([this.layers.on("change",(()=>this._update())),(0,n.YP)((()=>this.extentHelper.layerViewsExtent),(()=>this._setAdHocTilingScheme()))]),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._waitTask=null,this.layers.destroy()}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this.layers.some((t=>!(!(0,z.iC)(t)||t.isRejected()||t.isFulfilled()&&!function(e,t,i){return null!=(0,eg.E_)(e,t,i)}(t,this.viewSpatialReference,this.viewingMode)||(e=t,"vector-tile"===t?.type||(0,eg.x4)(t))))),e)if(e.isResolved()){const t=(0,eg.E_)(e,this.viewSpatialReference,this.viewingMode);if(null!=t){const e=new fw.t(t.tileInfo);this._lockTilingScheme(e)}}else this._updateWhen(e)}_updateWhen(e){const t=e.when().catch((()=>{})).then((()=>{t!==this._waitTask||this.destroyed||this._update()}));this._waitTask=t}_lockTilingScheme(e){if(this.viewingMode===Si.JY.Global){const t=e.levels.length-1,i=e.spatialReference;i.isWebMercator?e=fw.t.makeWebMercatorAuxiliarySphere(t):(0,_w.O)(i)&&(e=fw.t.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this.removeAllHandles(),this.addHandles((0,n.YP)((()=>this.extentHelper.tiledLayersExtent),(()=>this._updateTiledLayerExtent())))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(this.viewingMode===Si.JY.Global){const e=this.extentHelper.viewSpatialReference;e.isWebMercator?this.tilingScheme=fw.t.WebMercatorAuxiliarySphere:(0,_w.M)(e)&&(this.tilingScheme=fw.t.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{const e=this.extentHelper.layerViewsExtent;null==e||(0,V.fS)(e,this.extent)||(this.tilingScheme=fw.t.fromExtent(e,this.extentHelper.viewSpatialReference),this._set("extent",e))}}get test(){}};(0,o._)([(0,x.Cb)()],gw.prototype,"tilingScheme",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],gw.prototype,"extent",void 0),(0,o._)([(0,x.Cb)({value:!1})],gw.prototype,"tilingSchemeLocked",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],gw.prototype,"viewSpatialReference",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],gw.prototype,"layers",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],gw.prototype,"extentHelper",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],gw.prototype,"viewingMode",void 0),gw=(0,o._)([(0,S.j)("esri.views.3d.terrain.TilingSchemeLogic")],gw);class yw{constructor(){this._offset=(0,Rr.Ue)(),this.scale=0}get offset(){return this._offset}init(e,t,i,r){this.tile=e,this._offset[0]=t,this._offset[1]=i,this.scale=r}dispose(){this.tile=null,this._offset[0]=0,this._offset[1]=0,this.scale=0}}var vw,bw=i(27546),ww=i(17426);let Cw=class extends(ae.Z.EventedMixin(E.Z)){static{vw=this}get allTiles(){return this._allTiles}get demResolution(){const{_allTiles:e,tilingScheme:t}=this;if(0===e.length)return{min:1,max:1};const i=(0,w.c9)(t.spatialReference);let r=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY;for(const n of e){const e=t.resolutionAtLevel(n.level)*i;r=Math.min(r,e),s=Math.max(s,e)}return{min:r,max:s}}constructor(e){super(e),this.terrainTextureCompressionTracker=new ww.x,this._iteratorPool=new qf.Z(Ig.AA,(e=>e.remove=()=>this._iteratorPool.release(e))),this._postorderIterator=new Ig.rv,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._usedMemory=null,this._performanceInfo=new mw,this._viewChanged=!1,this.heading=0,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=(0,O.Ue)(),this._eyePosSurfaceSR=(0,O.Ue)(),this._splitLimits=new wv,this._frustum=(0,hp.Ue)(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._watchUpdatingTracking=new Y.R,this._frameTask=Gr.sq,this._allTiles=new ud.Z,this._upsampleInfoPool=new qf.Z(yw),this._shouldEmitChangeEvent=!1,this._rootTilesExtent=(0,V.Ue)(),this.updatingProgress=.5,this._maxNumUpdating=1,this.maxTextureScale=1.2,this._spatialReference=N.Z.WebMercator,this._elevationProjectorCache=new Map,this.visibleElevationBounds=new Xf(1/0,-1/0),this.rootTileElevationBounds=new Xf(1/0,-1/0),this._projectorCache=new Map,this._radiusModifier=Math.cos(Math.PI/16/16),this._tilingSchemeSpatialReference=null,this._updatingRootTiles=!1,this._pendingTilesForElevationUpdateEvent=new Set,this._pendingTilesToUpdate=new Set,this.totalGeometryUpdates=0,this.totalTileUpdates=0,this._oneBatchPerFrameTask=!0,this._layerViewsDirty=!1,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._isWebMercator=!1,this._isWebMercatorOnPlateCarree=!1;const t=e.view;this.overlayManager=new _g({...e,surface:this}),this._isGlobal=!t.state?.isLocal,this._isGeographic=this._spatialReference?.isGeographic??!1,this._tileConstructor=this._isGlobal?pv:ov,this._ellipsoid=(0,vr.Iu)(t.spatialReference),this._renderer=new cw(this.overlayManager.renderer,t.stage,this._allTiles,this._ellipsoid.radius,this.terrainTextureCompressionTracker,t.resourceController.memoryController),(0,bw.Dc)()||(this._scaleRangeQueries=new uv)}initialize(){const e=this.view,t=e.resourceController,r=t.memoryController;this._tileCache=new zf(((e,t)=>r.newCache(e,t)),"terrain-tile"),this._upsampleMapCache=r.newCache("terrain-upsample",(e=>e.unloadMapData())),this._elevationQueryCache=new jf(r.newCache("elevation-query"));const s=this.overlayManager;this.addHandles([(0,n.YP)((()=>s.renderer.isEmpty),(()=>this._evaluateTransparency())),(0,n.YP)((()=>this.renderer.visible),(e=>this.suspended=!e)),(0,n.YP)((()=>this.heading),(e=>{this._renderer.updateHeading(e),this._updateTileTextures(ng.Ns.FADING)})),(0,n.YP)((()=>({heading:e.camera?.heading,state:e.state?.mode})),(({heading:e,state:t})=>{if(null==e)return;if(this.isGlobal&&this.isGeographic||this.isWebMercatorOnPlateCarree)return void(this.heading=90*Math.round(e/90)%360);const i=Math.round(e)%360,r=Math.abs(i-this.heading);(t===Yc.n.IDLE||Math.min(r,360-r)>=30)&&(this.heading=i)}))],"overlayManager"),this.addHandles([(0,n.YP)((()=>this.baseOpacity),(()=>{this._handleLayerViewChanges(),this._updateTileTextures(this._evaluateTransparency()?ng.Ns.UNFADED:ng.Ns.IMMEDIATE)}),n.tX),(0,n.YP)((()=>this.hasCompositeBlendMode),(()=>this._updateTileTextures(this._evaluateTransparency()?ng.Ns.UNFADED:ng.Ns.IMMEDIATE)),n.tX),(0,n.YP)((()=>this.backgroundColor),((e,t)=>{e?.equals(t)||(this._handleLayerViewChanges(),this._renderer.updateTileBackground(e))}),n.Z_),(0,n.YP)((()=>this.snapLevel),(()=>this._viewChanged=!0),n.Z_),(0,n.YP)((()=>this.view.pointsOfInterest),(e=>{this._renderer.pointsOfInterest=e,this._watchUpdatingTracking.removeAll(),e&&this._watchUpdatingTracking.add((()=>e.focus.renderLocation),(()=>this._allTilesSorted=!1))})),(0,n.YP)((()=>dd.h.TERRAIN_TILE_TREE_SHOW_TILES),(t=>{t&&!this._treeDebugger?i.e(23657).then(i.bind(i,23657)).then((({TerrainTileTree3DDebugger:t})=>{!this._treeDebugger&&dd.h.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new t({view:e}))})):t||(this._treeDebugger=(0,f.SC)(this._treeDebugger))}),n.nn)]);const{spatialReference:a}=e;this._extentHelper=function(e,t){return e===Si.JY.Global?new ig(t):new rg(t)}(this.viewingMode,{layers:e.map.allLayers,layerViews:e.allLayerViews,viewSpatialReference:a});const o=new ke.Z({getCollections:()=>e.defaultsFromMap?.mapCollections?.map((({layers:e})=>e)),getChildrenFunction:e=>e&&"layers"in e?e.layers:null}),l=new gw({layers:o,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:a});this._set("tilingSchemeLogic",l),this._updateTilingScheme(),this._elevationDataRequester=t.createStreamDataRequester(M_.Bh.ELEVATION),this._mapDataRequester=t.createStreamDataRequester(M_.Bh.BASEMAP);const c=t.scheduler;this._frameTask=c.registerTask(Gr.T8.TERRAIN_SURFACE,this),this.addHandles([(0,n.YP)((()=>this._extentHelper.stencilEnabledExtents),(e=>this._renderer.setStencilEnabledLayerExtents(e)),n.nn),(0,n.YP)((()=>this.tilingSchemeLogic.tilingScheme),(()=>this._updateTilingScheme()),n.Z_),(0,n.YP)((()=>this.extent),(()=>this._updateRootTiles()),n.nn),e.on("resize",(()=>this._viewChangeUpdate())),(0,n.YP)((()=>{const t=e.state;return[this._lodBias,this.lodSnappingEnabled,e.quality,t.camera,t.contentCamera,t.fixedContentCamera]}),(()=>this._viewChangeUpdate()),n.tX),(0,n.YP)((()=>e.qualitySettings?.fadeDuration),(e=>this._renderer.textureFadingEnabled=e>0),n.nn),(0,n.YP)((()=>e.qualitySettings?.physicallyBasedRenderingEnabled),(e=>this._renderer.pbrMode=e?sw.f7.Simplified:sw.f7.Disabled),n.nn),(0,n.YP)((()=>e.qualitySettings?.tiledSurface.elevationLevelDelta),(()=>this._updateAllTileGeometries())),(0,n.YP)((()=>this._userClippingExtent),(()=>this._updateClippingExtent()),n.Z_)]),this.addHandles(e.allLayerViews.on("after-changes",(()=>this._layerViewsDirty=!0))),this._layerViewsDirty=!0,this._handleLayerViewChanges(),this._renderer.updateTileBackground(this.backgroundColor)}destroy(){this._frameTask.remove(),this._watchUpdatingTracking.destroy(),this._removeAllTiles(),this._set("tilingSchemeLogic",(0,f.SC)(this.tilingSchemeLogic)),this._basemapLayerViewHandles.forEach(((e,t)=>this._unregisterTiledLayerView(t))),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",(0,f.SC)(this.overlayManager)),this._tileCache=(0,f.SC)(this._tileCache),hy.prune(),this._treeDebugger=(0,f.SC)(this._treeDebugger),this._renderer.destroy(),this._iteratorPool=(0,f.SC)(this._iteratorPool),this._upsampleMapCache=(0,f.SC)(this._upsampleMapCache),this._elevationQueryCache=(0,f.SC)(this._elevationQueryCache),this._set("view",null),this._extentHelper=(0,f.SC)(this._extentHelper),this._upsampleInfoPool=(0,f.SC)(this._upsampleInfoPool),ly.size>0&&(console.log(`${ly.size} live TilePerLayerInfo allocations:`),ly.forEach((e=>console.log(e,"\n"))))}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){if(this.lodSnappingEnabled){const{view:e,tilingScheme:t}=this,i=e.scale;if(t&&i){const r=t.levelAtScale(i)+e.qualitySettings.tiledSurface.lodBias,s=t.getMaxLod();return r<=0?null:Math.min(r,s||1/0)}}return null}get lodSnappingEnabled(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get hasStencilEnabledExtents(){return this._extentHelper.stencilEnabledExtents.length>0}get _userClippingExtent(){const{spatialReference:e}=this,{clippingArea:t}=this.view;if(null==t||null==e)return null;const i=(0,V.Ue)(),r=(0,Em.G)(t,i,e)?i:null,s=this._get("extent");return(0,V.fS)(r,s)?s:r}get rootTilesExtent(){return this._rootTilesExtent}get extent(){const e=(0,V.jV)(this.groundExtent,this._userClippingExtent,(0,V.Ue)()),t=this._get("extent");return(0,V.fS)(e,t)?t:e}get groundExtent(){return null!=this._tilingSchemeExtent?this._tilingSchemeExtent:this._rootTilesExtent}get _tilingSchemeExtent(){return this.tilingSchemeLogic?.extent}get updating(){return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this.running||this._watchUpdatingTracking?.updating||this._asyncWorkItems>0)&&this.ready&&!this.suspended||this.overlayManager?.updating||this.terrainTextureCompressionTracker.compressing)}get running(){return(this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||!this._allTilesSorted||this._layerViewsDirty||this._scaleRangeQueries?.updating||this._frameTask.updating)&&this.ready&&!this.suspended}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get baseOpacity(){return this.view?.map?.ground?.opacity??1}set baseOpacity(e){this.view.map.ground.opacity=e}get viewingMode(){return this.view.state.viewingMode}get ready(){return null!=this._rootTiles}set renderOrder(e){this._renderer.renderOrder=e,this._set("renderOrder",e)}get rootTiles(){return this._rootTiles}get spatialReference(){return this.tilingScheme?.spatialReference??null}get backgroundColor(){return this.view?.map?.ground?.surfaceColor}set backgroundColor(e){this.view.map.ground.surfaceColor=e}set slicePlaneEnabled(e){this._renderer.slicePlaneEnabled=e,this._set("slicePlaneEnabled",e),this._evaluateTransparency()}get tilingSchemeLocked(){return this.tilingSchemeLogic?.tilingSchemeLocked??!1}get wireframe(){return this._renderer?.wireframe}set wireframe(e){e!==this._renderer.wireframe&&(this._renderer.wireframe=e,this._updateAllTileGeometries())}get opaque(){return this._renderer.transparency===kb.w.Opaque}get invisible(){return this._renderer.transparency===kb.w.Invisible}set suspended(e){this._set("suspended",e),this._viewChangeUpdate()}get fadeDuration(){return this.view.qualitySettings.fadeDuration??0}intersect(e,t,i,r){this._renderer.intersect(e,t,i,r)}getElevationLevelDelta(e){return e<4?3:this.view.qualitySettings.tiledSurface.elevationLevelDelta}getElevation(e,t,i,r){const s=this._rootTiles;if(!s?.length)return null;if(0===s[0].layerInfo[d_.ELEVATION].length)return null;let n=this._elevationProjectorCache.get(r);if(void 0===n&&(n=(0,dp.R8)(r,this._spatialReference)??null,this._elevationProjectorCache.set(r,n)),null==n)return _.Z.getLogger(this).error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;const a=(0,mr.i)(Tw,e,t,i);return n(a,0,a,0),Pw(s,a[0],a[1])}getElevations(e,t,i){const r=this._rootTiles,s=r?r[0].layerInfo[d_.ELEVATION].length:0;if(r?.length&&0!==s)for(let s=0;s<t;++s){const t=3*s;i(s,Pw(r,e[t],e[t+1]))}else for(let e=0;e<t;++e)i(e,null)}getScale(e){if(!this.tilingScheme)return null;if(!(0,H.K)(e,Tw,this.spatialReference))return _.Z.getLogger(this).error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;const t=this._rootTiles;if(null!=t)for(const e of t)if(e?.containsPoint(Tw)){let t=e;for(;t.children[0]&&!t.rendered;){const e=t.children[0].extent;let i=0;Tw[0]>e[2]&&(i+=1),Tw[1]<e[1]&&(i+=2),t=t.children[i]}return this._getLodBiasCorrectedScale(t.level)}return 1/0}_ensureProjector(e){const t=this._projectorCache.get(e);if(t)return t;const i=(0,dp.R8)(e,this._tilingSchemeSpatialReference)??null;return this._projectorCache.set(e,i),i}getSphereElevationBounds(e,t){const i=this._ensureProjector(t);if(null==i)return _.Z.getLogger(this).error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),null;(0,Nn.e)(e,Sw);const r=(0,Nn.a)(Sw);i(r,0,r,0);const s=new t_.r,n=this._rootTiles;if(null!=n){const e=[];for(const t of n)e.push(t);let t=0;for(;t<e.length;){const i=e[t];if(++t,!(0,V.hr)(i.extent,Sw))continue;const r=i.children;if(null==r[0]||i.rendered)s.expandElevationRangeValues(i.elevationBoundsMin,i.elevationBoundsMax);else for(const t of r)e.push(t)}}return s}getRootElevationBounds(){return new t_.r(this.rootTileElevationBounds.min,this.rootTileElevationBounds.max)}getLowerBoundRadius(){const e=(this._ellipsoid.radius+this.visibleElevationBounds.min)*this._radiusModifier;return Math.min(e,this._ellipsoid.radius)}getSphereScale(e,t){if(!this.tilingScheme)return null;if(!(0,H.K)(e,(0,Nn.a)(Sw),this.spatialReference))return _.Z.getLogger(this).error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;Sw[3]=t;let i=null;const r=e=>{if(e&&(0,V.hr)(e.extent,Sw)){const t=e.children;if(t[0]&&!e.rendered)for(const e of t)r(e);else{const t=this._getLodBiasCorrectedScale(e.level);i=null==i?t:Math.min(i,t)}}},s=this._rootTiles;if(null!=s)for(const e of s)r(e);return i}queryVisibleScaleRange(e,t,i,r){if(!this._scaleRangeQueries)return;const s=t?this.tilingScheme.levelAtScale(t):0,n=i?this.tilingScheme.levelAtScale(i):1/0,a=this._lodBias;this._scaleRangeQueries.queryVisibleLevelRange(e,s+a,n+a,r)}_evaluateTransparency(){const e=this.baseOpacity,t=this.overlayManager.renderer.isEmpty,i=this._renderer.transparency,r=this._isFullyTransparent?t?kb.w.Invisible:kb.w.InvisibleWithDraped:e>=1&&!this.hasCompositeBlendMode&&!this._renderer.slicePlaneEnabled?kb.w.Opaque:kb.w.Transparent;return this._renderer.transparency=r,i!==r}_updateTilingScheme(){const e=this.tilingSchemeLogic.tilingScheme;if(e===this.tilingScheme)return;(0,eg.wu)(!!e,"tiling scheme cannot be reset to undefined"),this._isGlobal=!this.view?.state?.isLocal,this.tilingScheme&&this._removeAllTiles();const t=e?.spatialReference??N.Z.WebMercator;this._spatialReference=t,this._isWebMercator=!!t?.isWebMercator,this._isWebMercatorOnPlateCarree=this._isWebMercator&&(0,ft.QM)(this.view?.renderSpatialReference),this._isGeographic=t?.isGeographic??!1,this._set("tilingScheme",e),this._tilingSchemeSpatialReference=this.tilingScheme?.spatialReference,this._projectorCache.clear(),this._updateClippingExtent(),e&&(this._updateTiledLayers(),this._renderer.tileSize=e.pixelSize,this.overlayManager.spatialReference=e.spatialReference,this._updateRootTiles())}static{this._tileMemcacheKey="TerrainTileMemcache"}_acquireTile(e,t,i,r){const s=this._tileCache.pop(vw._tileMemcacheKey);return s?(s.init(e,t,i,r,this),s):new this._tileConstructor(e,t,i,r,this)}get updatingRootTiles(){return this._updatingRootTiles}_updateRootTiles(){const{extent:e,tilingScheme:t}=this;if(!t)return;const i=Mw;let r=t.rootTilesInExtent(e,i,5*ce.$X);if(null!=this._rootTiles){if(r.length>ce.$X)return void _.Z.getLogger(this).warn(ce.C5);const e=this._rootTiles.map((e=>e.lij)),t=(0,St.e5)(e,r,yy);if(this._updatingRootTiles=!0,t.removed.length>0||t.added.length>0){const e=this._rootTiles.filter((e=>!(t.removed.findIndex((t=>yy(t,e.lij)))>-1&&(this._purgeTile(e),1))));t.added.forEach((t=>e.push(this._newRootTile(t)))),this._setRootTiles(e)}}else this._updatingRootTiles=!0,r.length>ce.$X&&(_.Z.getLogger(this).warn(ce.p1),r=t.rootTilesInExtent(e,i,ce.$X)),this._setRootTiles(r.map((e=>this._newRootTile(e))));(0,V.fS)(i,this._rootTilesExtent)||(this._rootTilesExtent=(0,V.Ue)(i)),this.renderer.visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready"),this._updateAllTileGeometries(),this._updatingRootTiles=!1,this.checkAllTilesWaterproofness()}_updateAllTileGeometries(){const e=this._allTiles.filter((e=>e.loaded&&e.intersectsClippingArea));e.sort(Ig.gl),e.forEach((e=>this._renderer.updateTileGeometryState(e))),e.forEach((e=>e.renderData.updateNeighborData())),this._updateTilesGeometries(e),this._pendingTilesToUpdate.clear()}_updateTilesGeometries(e){if(0===e.length)return;e.sort(Ig.gl);const t=this.renderer;e.forEach((e=>t.updateGeometryIfNeeded(e))),e.forEach((e=>this._pendingTilesForElevationUpdateEvent.add(e)))}_shouldSplit(e){return e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.snapLevel)===cy.SPLIT}_newRootTile(e){const t=this._acquireTile(0,e[1],e[2],null);return this._shouldSplit(t)&&t.setPendingUpdate(cy.SPLIT),this._loadTile(t),this._markTileToUpdate(t),this._updateRootTileElevationBounds(),t}_setRootTiles(e){if(this._rootTiles=e,this._allTiles.clear(),null!=e){const t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());t.remove()}this._renderer.setRootTiles(this._rootTiles),this._updateTilesVisibility(e),this.notifyChange("demResolution")}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this.renderer.visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this._rootTiles)))}_updateClippingStatus(e){e.updateClippingStatus(this.extent)&&e.resetPendingUpdate(cy.GEOMETRY)&&this._updateTileGeometryState(e)}_updateTilesVisibility(e){if(null==e)return;const t=(0,Ig.t8)(e),i=this.visibleElevationBounds;let r=t?i.min:1/0,s=t?i.max:-1/0;const n=this.extent,a=this.view.state.contentCamera.viewProjectionMatrix;this.setTileTreeDirty();const o=this._iteratorPool.acquire();for(o.reset(e);!o.done;){const e=o.next();e.updateClippingStatus(n)&&e.resetPendingUpdate(cy.GEOMETRY)&&this._updateTileGeometryState(e),e.computeVisibility(),e.updateScreenDepth(a),e.renderData&&(r=Math.min(e.elevationBoundsMin,r),s=Math.max(e.elevationBoundsMax,s))}o.remove(),this._viewChanged=!0,this._allTilesDirty=!0,this._updatePendingTileGeometries(),isFinite(r)&&isFinite(s)&&(i.min!==r||i.max!==s)&&(this.visibleElevationBounds=new Xf(r,s))}_updateRootTileElevationBounds(){let e=1/0,t=-1/0;const i=this._rootTiles;null!=i&&i.forEach((({elevationBoundsMin:i,elevationBoundsMax:r})=>{e=Math.min(e,i),t=Math.max(t,r)}));const r=this.rootTileElevationBounds;r.min===e&&r.max===t||(this.rootTileElevationBounds=new Xf(e,t))}_updateViewDependentParameters(){const{camera:e,contentCamera:t}=this.view.state,i=Math.tan(.5*t.fovX),r=Math.tan(.5*t.fovY),s=this.tilingScheme.pixelSize,n=2**-this._lodBias*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=i,this._splitLimits.fovY=r,this._splitLimits.relativeWidthLimit=s/e.width*this.maxTextureScale*n,this._splitLimits.relativeHeightLimit=s/e.height*this.maxTextureScale*n,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?this._splitLimits.frustum=(0,hp.JG)(this._splitLimits.frustum??(0,hp.Ue)(),t.frustum):this._splitLimits.frustum=null,(0,hp.JG)(this._frustum,e.frustum),(0,mr.c)(this._eyePosRenderSR,t.eye),(0,Zf.S)(e.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateTileGeometryState(e){e.updateVisibility(),this._renderer.updateTileGeometryState(e)&&this._markTileToUpdate(e),this.setMemoryDirty()}_markAllTileNeighborsForUpdate(e){e.forEachLoadedNeighbor((e=>{this._layerViews[d_.MAP].some(eg.Q)&&e.setPendingUpdate(cy.TEXTURE_FADING),this._pendingTilesToUpdate.add(e)}))}_updateTileTexture(e,t){const i=e.resetPendingUpdate(cy.TEXTURE_FADING)?cy.TEXTURE_FADING:!!e.resetPendingUpdate(cy.TEXTURE_NOFADING)&&cy.TEXTURE_NOFADING;i&&(this._renderer.updateTileTexture(e,i),this._usedMemory=null,t.madeProgress())}_emitElevationUpdateEventForTiles(){if(!this._shouldEmitChangeEvent)return;const e=Ew.extent;(0,V.cS)(e),this._pendingTilesForElevationUpdateEvent.forEach((t=>(0,V.jn)(e,t.extent,e))),this._pendingTilesForElevationUpdateEvent.clear(),Ew.spatialReference=this.spatialReference,this.emit("elevation-change",Ew),this._shouldEmitChangeEvent=!1}runTask(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this.renderer.processScaleRangeQueries(this._scaleRangeQueries,e),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateAllTilesStatus(e),this._sortTiles(e);const t=!this.view.state.fixedContentCamera;if(this._mergeAndSplit(e,t),this._updateElevation(e),this._updateTextures(e),t||this._mergeAndSplit(e,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),this._updatePendingTileGeometries(),this._emitElevationUpdateEventForTiles(),e.done&&e.hasProgressed&&this.requestUpdate(),this.notifyChange("updatingProgressValue"),eg.T9&&this._checkTileInvariant(),!e.hasProgressed)return qr.J}_checkTileInvariant(){const e=new Map;this._allTiles.forAll((t=>e.set(t,new Set))),this._allTiles.forAll((t=>{if((0,eg.wu)(t.rendered===t.leaf,` rendered ${t.rendered} != ${t.leaf} leaf`),!t.leaf){const e=e=>0===e.unmergableChildCount&&0===e.maxLevelDeltaNeighborCount,i=t.children.reduce(((t,i)=>t+(e(i)?0:1)),0);if((0,eg.wu)(t.unmergableChildCount===i,` Tile[${t.lij.toString()}] unmergeable child count mismatch: actual ${t.unmergableChildCount} vs ${i}`),t.hasPendingUpdate(cy.MERGE)){(0,eg.wu)(!t.hasPendingUpdate(cy.SPLIT),"Tile can be both split and merge at the same time");for(const e of t.children)(0,eg.wu)(e.leaf||e.hasPendingUpdate(cy.MERGE),"Child of tile to merge must also merge")}}for(let i=0;i<4;++i){if(t.rendered){const e=t.renderData?.geometryState.edgePeerNeighbors[i];if(null!=e){{const r=t.level-e.level<=ce.qC;r||(console.log(`tile level delta [${t.lij.toString()}] vs [${e.lij.toString()}] > ${ce.qC}  (edge[${i}])`),(0,eg.wu)(r,`tile level delta [${t.level}] vs [${e.level}] > ${ce.qC}`))}(0,eg.wu)(t.level-e.level<=ce.qC,`Max tile lod delta exceeded: [${t.lij.toString()}] vs [${e.lij.toString()}]`)}}const r=t.level-ce.qC,s=e=>e.leaf||e.level===t.level,n=t.findNeighborTile(eg.OC[i],s);if(null!=n){if(t.leaf&&t.level>=ce.qC){let i=n;for(;t.level-i.level<ce.qC;)i=i.parent;if(!yy([r,t.lij[1]>>ce.qC,t.lij[2]>>ce.qC],i.lij)){const r=e.get(i);(0,eg.wu)(!r.has(t),"Cannot already have neighbor"),r.add(t)}}(0,eg.wu)(n.rendered||n.level===t.level,"Non-same-level-neighbor of rendered must be rendered"),(0,eg.wu)(t.level-n.level<=ce.qC,`Tile level delta [${t.level}] vs [${n.level}] > ${ce.qC}`)}}})),this._allTiles.forAll((t=>{const i=t.maxLevelDeltaNeighborCount,r=e.get(t);(0,eg.wu)(i===r.size,`Tile[${t.lij.toString()}] merge-blocker mismatch: actual ${i} vs ${r.size}`)}))}_updateAllTilesStatus(e){if(!this._viewChanged||!this._rootTiles||e.done)return;this._viewChanged=!1;const t=new Aw(this._allTiles.length);t.pushAll(this._rootTiles);const i=this.snapLevel,r=this._splitLimits,s=this._eyePosRenderSR;this._allTiles.forAll((e=>{e.maxLevelDeltaNeighborCount=0,e.unmergableChildCount=0}));const n=this.view.state.contentCamera.viewProjectionMatrix;for(;!t.empty;){const e=t.pop(),a=e.parent,o=null!=a&&a.hasPendingUpdate(cy.MERGE),l=o?cy.MERGE:e.shouldSplit(r,s,i),c=l===cy.SPLIT;e.leaf?Ow(e,c):t.pushAll(e.children),o?(e.resetPendingUpdate(cy.SPLIT),e.leaf||e.setPendingUpdate(cy.MERGE),this._updateClippingStatus(e),e.updateVisibility(),e.updateScreenDepth(n)):c?(e.resetPendingUpdate(cy.MERGE),e.leaf&&e.setPendingUpdate(cy.SPLIT)):(e.resetPendingUpdate(cy.SPLIT)&&e.updateAgentSuspension(),l===cy.ELEVATION&&e.updateAgents(d_.ELEVATION),e.leaf||(e.setPendingUpdate(cy.MERGE),e.resetPendingUpdate(cy.SPLIT)))}this.requestUpdate(),(this._shortBatches||!this._oneBatchPerFrameTask)&&this._updatePendingTileGeometries(),e.madeProgress()}_sortTiles(e){e.done||this._allTilesSorted||((0,Ig.b)(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),e.madeProgress())}_markTileToUpdate(e){(0,eg.Fp)(e.loaded),e.intersectsClippingArea&&(this._pendingTilesToUpdate.add(e),this._markAllTileNeighborsForUpdate(e))}_updatePendingTileGeometries(){const e=this._pendingTilesToUpdate,t=Array.from(e.keys()).filter((e=>e.loaded&&e.intersectsClippingArea));if(0===t.length)return void e.clear();const i=(i,r)=>{!r?.loaded||!r.intersectsClippingArea||r.level<i.level||e.has(r)||(e.add(r),t.push(r),r.renderData.updateNeighborData())};t.sort(Ig.gl);const r=t.length;for(let s=0;s<r;++s){const r=t[s];(0,eg.Fp)(r.loaded),(0,eg.Fp)(r.intersectsClippingArea);const n=r.renderData;n.updateNeighborData();const a=n.dirtyEdgeResolutions,o=n.geometryState,l=e=>{const t=eg.cA[e];i(r,o.cornerPeerNeighbors[e]?.findCorner((0,eg.$v)(t),(e=>e.loaded)))};for(let t=0;t<4;++t)if(a&1<<t){const s=n.geometryState.edgePeerNeighbors[t];s&&s?.level>=r.level&&s.forAllSubtreeOnSide((0,eg._F)(eg.OC[t]),(t=>!(!t.loaded||!t.intersectsClippingArea||((0,eg.Fp)(e.has(t)||(0,Ig.gl)(r,t)<0),i(r,t),0)))),l((t+1)%4),l(t)}}e.clear(),this._updateTilesGeometries(t),this._shouldEmitChangeEvent=!0,eg.T9&&eg.V0&&this.checkAllTilesWaterproofness()}_mergeAndSplit(e,t){if(this.suspended||e.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate();let i=!1;const r=this.view.state.fixedContentCamera;let s=!1;for(;!e.done;){s=!0;let n=!1;const a=!this._allTiles.some((s=>{if(!i&&!r&&!s.visible)return e.done;let a=s;if(s.hasPendingUpdate(cy.MERGE)){if(!t||s.unmergableChildCount>0)return e.done;for(s.resetPendingUpdate(cy.MERGE);null!=a.parent&&0===a.parent.unmergableChildCount&&a.parent.resetPendingUpdate(cy.MERGE);)a=a.parent;this._mergeTile(a),n=!0,e.madeProgress()}else if(s.resetPendingUpdate(cy.SPLIT)){let t=!0;const i=s.level;if(i>=ce.qC){const e=e=>e.leaf||i-e.level<ce.qC;for(let r=0;r<4;++r){const n=s.findNeighborTile(eg.OC[r],e);null!=n&&i-n.level===ce.qC&&(t=!1,eg.T9&&((0,eg.Fp)(n.leaf),(0,eg.Fp)(n.hasPendingUpdate(cy.SPLIT))))}}t?(this._splitTile(s),e.madeProgress(),n=!0):s.setPendingUpdate(cy.SPLIT)}return e.done}));if(n&&(this._allTilesSorted=!1,this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries()),a){if(!i){i=!0;continue}if(!n)break}else this._allTilesDirty=!0}s?e.madeProgress():this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries(),this._sortTiles(e)}_updateElevation(e){e.done||(this._allTiles.some((t=>(t.resetPendingUpdate(cy.GEOMETRY)&&(this._updateTileGeometryState(t),this._shortBatches&&this._updatePendingTileGeometries(),e.madeProgress()),e.done))),!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries())}_updateTextures(e){e.done||this._allTiles.some((t=>(this._updateTileTexture(t,e),e.done)))}_updateClippingExtent(){this.spatialReference&&(this.overlayManager?.updateOverlayParameters(os.Xx.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}get _lodBias(){const e=this.view.quality;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*ce.if}_getLodBiasCorrectedScale(e){const t=this.tilingScheme.levels,i=(0,jt.uZ)(e-this._lodBias,0,t.length-1),r=i-Math.floor(i);return t[Math.floor(i)].scale*(1-r)+t[Math.ceil(i)].scale*r}_removeAllTiles(){null!=this._rootTiles&&(this._rootTiles.forEach((e=>this._purgeTile(e))),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.notifyChange("demResolution"),this.renderer.visible=!1}_purgeSubtree(e){const t=e.children;t[0]&&(this._purgeTile(t[0]),this._purgeTile(t[1]),this._purgeTile(t[2]),this._purgeTile(t[3]),e.clearChildren())}_purgeTile(e){e.leaf?Iw(e):this._purgeSubtree(e),this._allTiles.removeUnordered(e),this._unloadTile(e),e.dispose(),this._tileCache.put(vw._tileMemcacheKey,e),this.notifyChange("demResolution")}_unloadTile(e){this._pendingTilesToUpdate.delete(e),this._pendingTilesForElevationUpdateEvent.delete(e),e.unload()}_splitTile(e){(0,eg.wu)(e.leaf,"Tile that is already split should not be split again!"),(0,eg.wu)(e.rendered,"Tile marked to split is not rendered"),Iw(e);const t=e.createChildren();this._allTiles.pushArray(t),this.notifyChange("demResolution"),e.updateAgentSuspension(),(0,eg.wu)(e.rendered,"parent should be rendered"),t.forEach((e=>this._loadTile(e))),t.forEach((e=>this._pendingTilesToUpdate.add(e))),this._unloadTile(e),this._markAllTileNeighborsForUpdate(e),this._emitTileScaleChange(e,e.level+1),this._allTilesDirty=!0,this._shortBatches&&this._updatePendingTileGeometries(),t.forEach((e=>Ow(e,e.hasPendingUpdate(cy.SPLIT)))),++this._performanceInfo.numSplit}_emitTileScaleChange(e,t=e.level){Rw.spatialReference=this.spatialReference,Rw.extent=e.extent,Rw.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",Rw)}createTile(e,t,i,r){(0,eg.wu)(!!r,"createTile sanity check");const s=this._acquireTile(e,t,i,r);return s.updateClippingStatus(this.extent),s.updateScreenDepth(this.view.state.contentCamera.viewProjectionMatrix),this._shouldSplit(s)&&s.setPendingUpdate(cy.SPLIT),s}get _shortBatches(){return this.view.state.mode!==Yc.n.IDLE}_mergeTile(e){(0,eg.wu)(!e.hasPendingUpdate(cy.SPLIT),"_mergeTile sanity check"),(0,eg.wu)(!e.leaf,"Cannot merge a leaf"),e.leaf||(this._purgeSubtree(e),(0,eg.wu)(!e.renderData,"Merging tile with existing render data?"),this._loadTile(e),this._markTileToUpdate(e),this._emitTileScaleChange(e),this._shortBatches&&this._updatePendingTileGeometries(),Ow(e,!1),this._allTilesDirty=!0,++this._performanceInfo.numMerged)}_loadTile(e){e.load(),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager?.hasOverlays&&this.overlayManager.updateTileOverlayParameters(e)}_handleLayerViewChanges(e=Gr.G5){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let t=!1;const i=new Set;let r=-1;for(let e=this.view.allLayerViews.length-1;e>=0;e--){const s=this.view.allLayerViews.items[e];if(i.add(s.uid),(0,eg.wP)(s)||(0,eg.a_)(s))if(this._basemapLayerViewHandles.has(s.uid)&&!(0,eg.a_)(s)){const e=this._layerClassFromLayerView(s),i=this._getLayerIdxByUID(e,s.uid);null!=i&&((i<r||null==r)&&(t=!0),r=i)}else this._registerTiledLayerView(s),s.layer.loaded&&(t=!0)}this._basemapLayerViewHandles.forEach(((e,r)=>{i.has(r)||(this._unregisterTiledLayerView(r),t=!0)})),t&&this._updateTiledLayers(),this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._evaluateTransparency(),e.madeProgress()}get _isFullyTransparent(){if(this.view.map?.ground?.opacity>0)return!1;for(const e of this.view.allLayerViews.items)if((0,eg.GL)(e)&&!(0,z.sy)(e.layer)&&0!==e.fullOpacity)return!1;return!0}_hasCompositeBlendMode(){for(const e of this.view.allLayerViews.items)if(((0,eg.TK)(e)||(0,eg.a_)(e))&&(0,ab.MV)(ab.pU[e.layer.blendMode]))return!0;return!1}_layerClassFromLayerView(e){return(0,eg._1)(e)?d_.ELEVATION:d_.MAP}_registerTiledLayerView(e){const t=[];if(((0,eg.TK)(e)||(0,eg.a_)(e))&&t.push((0,n.YP)((()=>e.layer.blendMode),(()=>{this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._updateTileTextures(ng.Ns.UNFADED)}))),!(0,eg.a_)(e)){const i=this._layerClassFromLayerView(e);t.push((0,n.YP)((()=>e.suspended),(()=>this._updateTiledLayers()))),t.push((0,n.YP)((()=>e.fullOpacity),(()=>this._updateTileTextures(ng.Ns.UNFADED)))),t.push((0,n.YP)((()=>"effectiveScaleRange"in e.layer?e.layer.effectiveScaleRange:null),(()=>this._restartAllAgents(i)))),t.push(e.on("data-changed",(()=>{const t=this._getLayerIdxByUID(i,e.uid);null!=t&&this._invalidateLayerData(t,i)})))}this._unregisterTiledLayerView(e.uid),this._basemapLayerViewHandles.set(e.uid,t)}_unregisterTiledLayerView(e){const t=this._basemapLayerViewHandles.get(e);if(t){for(const e of t)e.remove();this._basemapLayerViewHandles.delete(e)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const e=this.view.allLayerViews,t=[[],[]];let i=null;e.forEach((e=>{if(!e.layer||e.suspended||!(0,eg.wP)(e)||!e.fullExtent)return;const r=this._layerClassFromLayerView(e);if(r===d_.MAP){const t=e.displayLevelRange.maxLevel;t!==1/0&&(null===i||t>i)&&(i=t)}t[r].push(e)}));for(const e of m_){const i=this._layerViews[e],r=t[e];r.reverse();const s=r.length;let n=i.length!==s;const a=new Array(s),o=new Array(i.length);this._layerIndexByUid[e].clear();for(let t=0;t<s;t++){const s=r[t].uid;this._layerIndexByUid[e].set(s,t);const l=i.indexOf(r[t]);a[t]=l,t!==l&&(n=!0),l>-1&&(o[l]=t)}if(n){const t=this._postorderIterator;for(t.reset(this._rootTiles);!t.done;)t.next().modifyLayers(o,a,e);this._layerViews[e]=r,this._restartAllAgents(e),this._updateTilesVisibility(this._rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&(this._viewChangeUpdate(),this.notifyChange("tilingScheme"))}_restartAllAgents(e){const t=this._postorderIterator;for(t.reset(this._rootTiles);!t.done;){const i=t.next();i.restartAgents(e),e===d_.ELEVATION&&i.computeElevationBounds()}this._updateRootTileElevationBounds()}layerViewByIndex(e,t){return this._layerViews[t][e]}numLayers(e){return this._layerViews[e].length}_updateTileTextures(e){this._allTiles.forAll((t=>{t.updateAgents(d_.MAP),e===ng.Ns.IMMEDIATE?this.renderer.updateTileTexture(t,cy.TEXTURE_NOFADING):t.updateRenderData(d_.MAP,e)})),this._evaluateTransparency()}_invalidateLayerData(e,t){this._allTiles.forAll((i=>i.removeLayerAgent(e,t))),this._allTiles.forAll((i=>i.invalidateLayerData(e,t)))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(e=os.Xx.UPDATE){this.renderer.setNeedsRender(e)}requestUpdate(){1==++this._pendingUpdates&&(this._hasPendingUpdates=!0)}requestTileData(e,t,i,r){const s=this.layerViewByIndex(t,i),n=s.layer;return!n.tilemapCache||(0,eg.Q)(s)?this._requestTileData(e,i,s,r):(++this._asyncWorkItems,n.tilemapCache.fetchAvailability(e.level,e.lij[1],e.lij[2],{...r,timeout:6e3}).then((()=>--this._asyncWorkItems)).catch((t=>{throw--this._asyncWorkItems,(0,y.k_)(r),(0,y.D_)(t)||this._dataMissing(e,i,s),t})).then((()=>this._frameTask.schedule((()=>this._requestTileData(e,i,s,r)),r.signal))))}_requestTileData(e,t,i,r){if(this.destroying)return Promise.resolve();const s=t===d_.ELEVATION;return r.requester??=s?this._elevationDataRequester:this._mapDataRequester,s?(0,eg._1)(i)?this._requestElevationTileData(e,i,r):Promise.reject():(0,eg.GL)(i)?this._requestMapTileData(e,i,r):Promise.reject()}_requestElevationTileData(e,t,i){++this._asyncWorkItems;const r=r=>{!(0,y.Hc)(i)&&r&&(this.setMemoryDirty(),this.requestUpdate(),this._elevationDataArrived(e,t,r))};return t.fetchElevationTile(e,i).then((e=>this._frameTask.schedule((()=>r(e)))),(i=>{(0,y.D_)(i)||(_.Z.getLogger(this).error(`Tile ${e.lij.toString()} layer ${d_.ELEVATION}/${t.uid} error ${i}`),this._dataMissing(e,d_.ELEVATION,t),this.requestUpdate())})).finally((()=>--this._asyncWorkItems))}_elevationDataArrived(e,t,i){const r=this._layerIndexByUid[d_.ELEVATION].get(t.uid);if(null==r)return void _.Z.getLogger(this).warn("TerrainSurface: received data from unknown layer %d %s",d_.ELEVATION,e.lij.toString());const s=new Qf(e.lij,e.extent,i);e.dataArrived(r,d_.ELEVATION,s);const n=[e],a=e.level,o=this._iteratorPool.acquire();for(o.reset(n);!o.done;){const e=o.next();e.findElevationBoundsForLayer(r,a),e.computeElevationBounds()}0===a&&this._updateRootTileElevationBounds(),o.remove(),this._updateTilesVisibility(n)}_requestMapTileData(e,t,i){++this._asyncWorkItems;const r=(r,s)=>{(0,eg.ep)(s),(0,y.Hc)(i)||(console.error(`Tile ${e.lij.toString()} layer ${d_.MAP}/${t.uid} error ${r}`),this._dataMissing(e,d_.MAP,t),this.requestUpdate())},s=e=>t=>r(t,e);return t.fetchTile(e.lij,i).then((r=>this._frameTask.schedule((()=>{this.requestUpdate(),(0,y.Hc)(i)?(0,eg.ep)(r):this._mapTileDataArrived(e,t,r)}),i.signal,s(r)).catch(s(r))),((e,t=null)=>this._frameTask.schedule((()=>r(e,t))))).finally((()=>--this._asyncWorkItems))}_mapTileDataArrived(e,t,i){const r=this._getLayerIdxByUID(d_.MAP,t.uid);if(null==r)return(0,eg.ep)(i),void _.Z.getLogger(this).warn("TerrainSurface: received data from unknown layer");e.dataArrived(r,d_.MAP,i)}_getLayerIdxByUID(e,t){return this._layerIndexByUid[e].get(t)}_dataMissing(e,t,i){const r=this._getLayerIdxByUID(t,i.uid);null!=r?e.dataMissing(r,t):_.Z.getLogger(this).warn("TerrainSurface: received data from unknown layer")}get performanceInfo(){const e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll((t=>{t.leaf&&e.numLeaves++;const i=t.level;t.renderData&&(e.numLoadedPerLevel[i]=(e.numLoadedPerLevel[i]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[i]=(e.numRenderedPerLevel[i]||0)+1,e.numRendered++))})),e}setMemoryDirty(){this._usedMemory=null}get usedMemory(){return this.tilingScheme?(null==this._usedMemory&&(this._usedMemory=this._recalculateUsedMemory()),this._usedMemory??0):0}_recalculateUsedMemory(){return this.tilingScheme?Math.round(this._allTiles.reduce(((e,t)=>e+t.usedMemory),0)):null}getUsedMemoryForLayerView(e){let t=0;const i=this._layerClassFromLayerView(e),r=this._getLayerIdxByUID(i,e.uid);return null!=r&&this._allTiles.forAll((e=>t+=e.getUsedMemoryForLayer(i,r))),t}get renderPatchBorders(){return this._renderer.renderPatchBorders}set renderPatchBorders(e){this._renderer.renderPatchBorders=e}get visualizeNormals(){return this._renderer.visualizeNormals}set visualizeNormals(e){this._renderer.visualizeNormals=e}get renderingDisabled(){return this._renderer.renderingDisabled}set renderingDisabled(e){this._renderer.renderingDisabled=e}get test(){}checkAllTilesWaterproofness(){if(!eg.V0)return;const e=this._rootTiles;if(null==e)return;const t=e=>e?.renderData?.geometry?.indices?.length>0,i=(e,i)=>{t(e)&&console.error("Tile[",e.lij,"] has geometry although parent[",i.lij,"] has geom")},r=e=>{if(e.intersectsClippingArea)if(e.renderData&&!e.renderData.geometryState&&console.error("Tile[",e.lij,"] has renderData but not geometryState"),e.renderData&&!e.renderData.geometry&&console.error("Tile[",e.lij,"] has renderData but not geometryInfo"),!e.renderData?.geometry||(e.renderData.geometry.indices?.length??0)>0||console.error("Tile[",e.lij,"] has renderData but no indices - geometryInfo: ",e.renderData.geometry),t(e)){e.checkGeometryWaterproofness();for(const t of e.children)i(t,e)}else if(e.leaf)console.error("Tile[",e.lij,"] has no geometry and no children, from root to leaf");else for(const t of e.children)r(t)},s=e=>{const t=e.parent?.visible??!0,i=e.visible;e.computeVisibility();const r=e.visible;if(i!==r&&t&&console.error(" Tile[",e.lij,"] has out of date visibility: ",i," instead of ",r),!e.leaf)for(const t of e.children)s(t)};for(const t of e)r(t),s(t)}get isGlobal(){return this._isGlobal}get isGeographic(){return this._isGeographic}get isWebMercator(){return this._isWebMercator}get isWebMercatorOnPlateCarree(){return this._isWebMercatorOnPlateCarree}isEastEndWrap(e){return this._isGlobal&&e[2]===this.lijEastEnd(e[0])-1}isWestEndWrap(e){return this._isGlobal&&0===e[2]}lijEastEnd(e){return 1<<e+(this._isGeographic?1:0)}wrapEastWest(e){const t=this.lijEastEnd(e[0]),i=e[2];if(0<=i&&i<t)return e;if(!this._isGlobal)return null;const r=(i+(i<0?t:0))%t;return[e[0],e[1],r]}enableInternalChecks(e){(0,eg.qA)(e)}enableWaterproofnessChecks(e){(0,eg.HK)(e)}};(0,o._)([(0,x.Cb)()],Cw.prototype,"_renderer",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],Cw.prototype,"_scaleRangeQueries",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],Cw.prototype,"view",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],Cw.prototype,"overlayManager",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],Cw.prototype,"terrainTextureCompressionTracker",void 0),(0,o._)([(0,x.Cb)()],Cw.prototype,"_hasPendingUpdates",void 0),(0,o._)([(0,x.Cb)()],Cw.prototype,"_asyncWorkItems",void 0),(0,o._)([(0,x.Cb)()],Cw.prototype,"_allTilesDirty",void 0),(0,o._)([(0,x.Cb)()],Cw.prototype,"_allTilesSorted",void 0),(0,o._)([(0,x.Cb)()],Cw.prototype,"_viewChanged",void 0),(0,o._)([(0,x.Cb)({type:Number})],Cw.prototype,"heading",void 0),(0,o._)([(0,x.Cb)()],Cw.prototype,"_splitLimits",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Cw.prototype,"_watchUpdatingTracking",void 0),(0,o._)([(0,x.Cb)()],Cw.prototype,"_frameTask",void 0),(0,o._)([(0,x.Cb)()],Cw.prototype,"demResolution",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Cw.prototype,"snapLevel",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Cw.prototype,"lodSnappingEnabled",null),(0,o._)([(0,x.Cb)()],Cw.prototype,"_userClippingExtent",null),(0,o._)([(0,x.Cb)()],Cw.prototype,"_rootTilesExtent",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Cw.prototype,"extent",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Cw.prototype,"groundExtent",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Cw.prototype,"_tilingSchemeExtent",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Cw.prototype,"updating",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Cw.prototype,"running",null),(0,o._)([(0,x.Cb)($f.q)],Cw.prototype,"updatingProgress",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Cw.prototype,"updatingProgressValue",null),(0,o._)([(0,x.Cb)()],Cw.prototype,"_maxNumUpdating",void 0),(0,o._)([(0,x.Cb)()],Cw.prototype,"baseOpacity",null),(0,o._)([(0,x.Cb)()],Cw.prototype,"hasCompositeBlendMode",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Cw.prototype,"viewingMode",null),(0,o._)([(0,x.Cb)()],Cw.prototype,"maxTextureScale",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Cw.prototype,"ready",null),(0,o._)([(0,x.Cb)({value:cv.z.FRONT_TO_BACK})],Cw.prototype,"renderOrder",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Cw.prototype,"rootTiles",null),(0,o._)([(0,x.Cb)()],Cw.prototype,"_rootTiles",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Cw.prototype,"spatialReference",null),(0,o._)([(0,x.Cb)({type:xe.Z})],Cw.prototype,"backgroundColor",null),(0,o._)([(0,x.Cb)({value:!1})],Cw.prototype,"slicePlaneEnabled",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Cw.prototype,"tilingScheme",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],Cw.prototype,"tilingSchemeLocked",null),(0,o._)([(0,x.Cb)({readOnly:!0})],Cw.prototype,"tilingSchemeLogic",void 0),(0,o._)([(0,x.Cb)()],Cw.prototype,"wireframe",null),(0,o._)([(0,x.Cb)({value:!1})],Cw.prototype,"suspended",null),(0,o._)([(0,x.Cb)()],Cw.prototype,"fadeDuration",null),(0,o._)([(0,x.Cb)()],Cw.prototype,"visibleElevationBounds",void 0),(0,o._)([(0,x.Cb)()],Cw.prototype,"rootTileElevationBounds",void 0),(0,o._)([(0,x.Cb)()],Cw.prototype,"_layerViewsDirty",void 0),(0,o._)([(0,x.Cb)()],Cw.prototype,"renderPatchBorders",null),(0,o._)([(0,x.Cb)()],Cw.prototype,"visualizeNormals",null),(0,o._)([(0,x.Cb)()],Cw.prototype,"renderingDisabled",null),Cw=vw=(0,o._)([(0,S.j)("esri.views.3d.terrain.TerrainSurface")],Cw);const xw=Cw,Tw=(0,O.Ue)(),Sw=(0,Nn.c)(),Mw=(0,V.Ue)();new ud.Z;const Ew=new Wf.c("ground"),Rw={spatialReference:null,extent:null,scale:0};function Pw(e,t,i){for(const r of e){if(!r.containsPointXY(t,i))continue;let e=r;for(;e&&!e.renderData;){const r=(t>e.extentMidX?1:0)+(i<e.extentMidY?2:0);e=e.children[r]}return Jf(t,i,e?.renderData?.geometryState.samplerData??null)}return null}class Aw{constructor(e){this.capacity=e,this._head=0,this._tail=0,this._data=new Array(e)}push(e){const t=this._tail;if(!(t<this.capacity))throw new Error("Queue full");this._data[t]=e,this._tail=t+1}pushAll(e){const t=e.length;if(0===t)return;const i=this._tail;if(!(i+t<=this.capacity))throw new Error("Queue full");for(let r=0;r<t;++r)this._data[i+r]=e[r];this._tail=i+t}pop(){const e=this._head;if(e<this._tail){const t=this._data[e];return this._head=e+1,t}}get empty(){return this._head>=this._tail}get full(){return this._tail>=this._data.length}}function Ow(e,t){!e.leaf||e.level<ce.qC||Fw(e,(e=>{t&&Dw(e);const i=Lw(e);if(e.maxLevelDeltaNeighborCount++,i){let t=e.parent;for(;t;){const e=Lw(t);if(t.unmergableChildCount++,!e)break;t=t.parent}}}))}function Dw(e){if(e.hasPendingUpdate(cy.SPLIT))return;let t=e.parent;for(;t?.resetPendingUpdate(cy.MERGE);)t=t.parent;e.resetPendingUpdate(cy.MERGE),e.leaf&&e.setPendingUpdate(cy.SPLIT),e.level<ce.qC||Fw(e,(e=>{Dw(e)}))}function Iw(e){e.level<ce.qC||Fw(e,(e=>{if(e.maxLevelDeltaNeighborCount--,0===e.maxLevelDeltaNeighborCount&&0===e.unmergableChildCount){let t=e.parent;for(;t&&(t.unmergableChildCount--,Lw(t));)t=t.parent}}))}function Lw(e){return 0===e.maxLevelDeltaNeighborCount&&0===e.unmergableChildCount}function Fw(e,t){if(e.level<ce.qC)return;const i=e.level-ce.qC,r=e.lij[1]>>ce.qC,s=e.lij[2]>>ce.qC,n=e=>e.leaf||e.level===i;for(let a=0;a<4;++a){const o=e.findNeighborTile(eg.OC[a],n);if(!o||o.level!==i)continue;const l=o.lij;l[1]===r&&l[2]===s||t(o)}}var Nw=i(82915),Uw=i(94125),Hw=i(3648),Vw=i(61544),kw=i(89341);class Bw{constructor(e,t,i,r){this.operation=e,this.geometry=t,this.states=i,this.sync=r}}let zw=class extends E.Z{constructor(e){super(e),this._residentGeomRecords=new Vw.r,this._dirtyGeomRecords=new Vw.r,this._dirtyRecordCount=0}get dirty(){return this._dirtyRecordCount>0}commitLayer(e,t){const i=this._dirtyGeomRecords.getInner(e),r=this.model.getLayer(e);if(!i||!r)return;let s=0;i.forEach(((i,n)=>{const a=this._ensureGeomRecord(e,n);this._dirtyGeomRecords.delete(e,n),s+=i.size,i.forEach((({geometry:e,operation:i,states:s},o)=>{let l=!1;if(i===kw.T.UPDATE){const i=a.get(o);if(i){if(s&kw.$.TRANSFORMATION){const t=r.getObject(n);this.model.updateRenderGeometryTransformation(t,e,i)&&(l=!0)}l||t.updates.push({renderGeometry:i,updateType:s})}else(0,R_.hu)(!1,"ModelDirtySet.commitLayer: invalid update")}if(i===kw.T.REMOVE||l){const e=a.get(o);e?(t.removes.push(e),a.delete(o)):i===kw.T.REMOVE&&(0,R_.hu)(!1,"ModelDirtySet.commitLayer: invalid remove")}if(i===kw.T.ADD||l){const i=r.getObject(n);if(null!=i){const r=this.model.getRenderGeometry(i,e);t.adds.push(r),a.set(o,r)}}})),0===a.size&&this._residentGeomRecords.delete(e,n)})),this._dirtyRecordCount-=s}commitSyncUpdates(e,t){const i=this._dirtyGeomRecords.getInner(e),r=this.model.getLayer(e);i&&r&&i.forEach(((i,s)=>{const n=this._ensureGeomRecord(e,s);i.forEach((({geometry:e,operation:i,states:a,sync:o},l)=>{let c=!1;if(i===kw.T.UPDATE&&o){const i=n.get(l);if(i){if(a&kw.$.TRANSFORMATION){const t=r.getObject(s);this.model.updateRenderGeometryTransformation(t,e,i)&&(c=!0)}c||t.updates.push({renderGeometry:i,updateType:a})}else(0,R_.hu)(!1,"ModelDirtySet.commitSyncUpdates: invalid update")}}))}))}_objectStateChanged(e,t){for(const i of t.geometries)this._updateOrCreateDirtyRecord(t,i,kw.T.UPDATE,e)}visibilityChanged(e){this._objectStateChanged(kw.$.VISIBILITY,e)}highlightChanged(e){this._objectStateChanged(kw.$.HIGHLIGHT,e)}occlusionChanged(e){this._objectStateChanged(kw.$.OCCLUDEE,e)}attributesChanged({object:e,geometry:t,sync:i}){this._updateOrCreateDirtyRecord(e,t,kw.T.UPDATE,kw.$.GEOMETRY,i)}layerAdded(e){e.objects.forEach((e=>this.layerObjectAdded(e)))}layerRemoved(e){e.objects.forEach((e=>this.layerObjectRemoved(e)))}layerObjectAdded(e){for(const t of e.geometries)this._geometryAdded(e,t)}layerObjectRemoved(e){for(const t of e.geometries)this._geometryRemoved(e,t)}layerObjectsAdded(e){for(const t of e)this.layerObjectAdded(t)}layerObjectsRemoved(e){for(const t of e)this.layerObjectRemoved(t)}transformationChanged(e){const t=this._getLayerId(e),i=e.id;this._ensureGeomRecord(t,i).forEach((({geometry:t})=>this._updateOrCreateDirtyRecord(e,t,kw.T.UPDATE,kw.$.TRANSFORMATION)))}shaderTransformationChanged(e){const t=this._getLayerId(e),i=e.id;this._ensureGeomRecord(t,i).forEach((t=>t.objectShaderTransformationChanged(e.shaderTransformation)))}geometryAdded(e){this._geometryAdded(e.object,e.geometry)}_geometryAdded(e,t){this._updateOrCreateDirtyRecord(e,t,kw.T.ADD)}geometryRemoved(e){this._geometryRemoved(e.object,e.geometry)}_geometryRemoved(e,t){this._updateOrCreateDirtyRecord(e,t,kw.T.REMOVE)}_updateOrCreateDirtyRecord(e,t,i,r=kw.$.NONE,s=!1){const n=this._getLayerId(e),a=e.id,o=t.id,l=this._ensureDirtyRecord(n,a),c=l.get(o);if(c){const e=c.operation;e===kw.T.REMOVE&&i===kw.T.ADD&&c.states!==kw.$.NONE?c.operation=kw.T.UPDATE:e===kw.T.REMOVE&&i===kw.T.ADD||e===kw.T.ADD&&i===kw.T.REMOVE?(l.delete(o),this._dirtyRecordCount--):e!==kw.T.UPDATE||i!==kw.T.REMOVE&&i!==kw.T.UPDATE?((0,R_.hu)((e===kw.T.REMOVE||e===kw.T.ADD)&&i===kw.T.UPDATE,"ModelDirtySet.objectGeometryAdded: inconsistent state"),c.states|=r):(c.operation=i,c.states|=r),c.sync=c.sync||s}else l.set(o,new Bw(i,t,r,s)),this._dirtyRecordCount++}_ensureGeomRecord(e,t){let i=this._residentGeomRecords.get(e,t);return i||(i=new Map,this._residentGeomRecords.set(e,t,i)),i}assertLayerClean(e){(0,R_.hu)(null==this._dirtyGeomRecords.getInner(e),"Dirty geometry records for removed layer")}_ensureDirtyRecord(e,t){const i=this.model.getLayer(e);(0,R_.hu)(null!=i,"Updating geometry record for an unregistered layer");let r=this._dirtyGeomRecords.get(e,t);return r||(r=new Map,this._dirtyGeomRecords.set(e,t,r)),r}_getLayerId(e){return e.layer?.id??lp.J}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forAll(((i,r,s)=>{t.length>0&&(t+="\n"),t+=r+"."+s;const n=[];i.forEach((e=>{const t=e.operation;n[t]||(n[t]=[]),n[t].push(e.geometry.id)}));for(let i=0;i<n.length;i++)if(n[i]){t+=" "+e[i-1]+": ";for(let e=0;e<n[i].length;e++)t+=n[i][e]+", "}})),t}get test(){}};(0,o._)([(0,x.Cb)({constructOnly:!0})],zw.prototype,"model",void 0),(0,o._)([(0,x.Cb)()],zw.prototype,"_dirtyRecordCount",void 0),zw=(0,o._)([(0,S.j)("esri.views.3d.webgl-engine.lib.ModelDirtySet")],zw);const Gw=zw;var qw=i(14357);let Zw=class extends E.Z{constructor(){super(...arguments),this.dirtySet=new Gw({model:this}),this._originFactory=new Hw.C(null),this._textures=new Map,this._layers=new Map}hasTexture(e){return this._textures.has(e.id)}getTexture(e){return null==e?null:this._textures.get(e)}addTexture(e){const t=e.id;(0,R_.hu)(!this._textures.has(t),"Model/Stage already contains texture to be added"),this._textures.set(t,e)}removeTexture(e){return this._textures.delete(e.id)}addTextures(e){for(const t of e)t&&((0,R_.hu)(!this._textures.has(t.id),"Model/Stage already contains object to be added"),this._textures.set(t.id,t))}removeTextures(e){for(const t of e)t&&((0,R_.hu)(this._textures.has(t.id),"Model/Stage doesn't contain object to be removed"),this._textures.delete(t.id))}forEachTexture(e){this._textures.forEach((t=>e(t)))}hasLayer(e){return this._layers.has(e.id)}getLayer(e){return null==e?null:this._layers.get(e)}addLayer(e){const t=e.id;(0,R_.hu)(!this._layers.has(t),"Model/Stage already contains layer to be added"),this._layers.set(t,e)}removeLayer(e){return this._layers.delete(e.id)}getRenderGeometry(e,t){const i=new qw.z(t,{castShadow:e.castShadow,objectShaderTransformation:e.shaderTransformation}),r=t.localOrigin;return i.transformation=e.getCombinedStaticTransformation(t,jw),i.localOrigin=r??this._originFactory.getOrigin((0,Nn.a)(i.boundingSphere)),i}updateRenderGeometryTransformation(e,t,i){if(null==e)return!1;i.transformation=e.getCombinedStaticTransformation(t,jw);const r=this._originFactory.getOrigin((0,Nn.a)(i.boundingSphere));return i.localOrigin!==r}get test(){}};(0,o._)([(0,x.Cb)({constructOnly:!0})],Zw.prototype,"dirtySet",void 0),Zw=(0,o._)([(0,S.j)("esri.views.3d.webgl-engine.parts.Model")],Zw);const jw=(0,Mr.Ue)();var Ww=i(64497),$w=i(92643),Xw=i(78037),Yw=i(37132),Qw=i(32667);class Kw extends Yw.o{constructor(){super(...arguments),this.innerFadeDistance=0,this.altitudeFade=0,this.backgroundColor=(0,O.Ue)()}}class Jw extends Dr.A{constructor(e,t){super(e,t,new Or.J(Qw.C,(()=>i.e(4780).then(i.bind(i,4780)))))}initializePipeline(e){return(0,Lr.sm)({blending:e.reduced?Lr.LW:(0,Lr.if)(Ir.zi.SRC_ALPHA,Ir.zi.ONE_MINUS_SRC_ALPHA),depthTest:{func:e.reduced?Ir.wb.ALWAYS:Ir.wb.LEQUAL},colorWrite:Lr.gf})}}class eC extends ob.m{constructor(){super(...arguments),this.reduced=!1}}(0,o._)([(0,ob.o)()],eC.prototype,"reduced",void 0);var tC=i(7332);class iC extends Dr.A{constructor(e,t){super(e,t,new Or.J(tC.a,(()=>i.e(92480).then(i.bind(i,92480)))))}initializePipeline(){return(0,Lr.sm)({blending:(0,Lr.if)(Ir.zi.SRC_ALPHA,Ir.zi.ONE_MINUS_SRC_ALPHA),depthTest:{func:Ir.wb.ALWAYS},colorWrite:Lr.gf})}}let rC=class extends ls{constructor(){super(...arguments),this.requireGeometryDepth=!0,this._compositingPassParameters=new tC.A,this._vao=null,this._passParameters=new Kw,this._configuration=new eC}initialize(){this.techniques.precompile(Jw,this._configuration),this.techniques.precompile(iC),this._configuration.reduced=!0,this.techniques.precompile(Jw,this._configuration),this._configuration.reduced=!1,this.addHandles([(0,n.YP)((()=>this.view.environment.background),(e=>{const t=e instanceof Cn?(0,$w.O)(e.color):Uc.AG;(0,mr.i)(this._passParameters.backgroundColor,t[0]*t[3],t[1]*t[3],t[2]*t[3])}),n.tX),(0,n.YP)((()=>this.view.stage?.renderer?.fullResolutionAtmosphere),(e=>this._configuration.reduced=!e),n.tX),(0,n.YP)((()=>this.view.environment.atmosphereEnabled),(e=>e?this._enable():this._disable()),n.tX)])}destroy(){this._vao=(0,f.M2)(this._vao)}render(e){const t=e.find((({name:e})=>e===Qr.CM.OPAQUE_ENVIRONMENT));if(!this.bindParameters.mainDepth)return t;const i=this.renderingContext;this._vao??=(0,bb.ow)(i,bb.Ar.Pos2Tex);const r=t.getAttachment(Ir.Lu);this._update();const s=this.techniques.get(Jw,this._configuration);if(!s.compiled)return this.requestRender(os.Xx.UPDATE),t;if(!this._configuration.reduced)return t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(s,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(Ir.MX.TRIANGLE_STRIP,0,4),t.attachDepth(r),t;const n=this.techniques.get(iC);if(!n.compiled)return this.requestRender(os.Xx.UPDATE),t;const a=i.getViewport(),o=this.bindParameters.camera,l=(0,mr.l)(o.eye)-ir.sv.radius;let c;const h=ir.sv.atmosphereHeight;if(l<h){const e=Math.min(1,Math.max(0,l/h));c=(0,jt.t7)(.2,.3,e)}else{const e=Math.min(1,Math.max(0,(l-h)/(15*h)));c=(0,jt.t7)(.3,.6,e)}const u=this.renderingContext.parameters.maxTextureSize,d=(0,hg.nq)(Math.round(c*o.fullViewport[2]),u),p=(0,hg.nq)(Math.round(c*o.fullViewport[3]),u);i.setViewport(0,0,d,p);const m=this.fboCache.acquire(d,p,"chapman",Md.qz.RGBA8UNORM);return i.bindFramebuffer(m.fbo),i.clearFramebuffer([0,0,0,1],!0,!0),i.bindTechnique(s,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(Ir.MX.TRIANGLE_STRIP,0,4),i.setViewport(a.x,a.y,a.width,a.height),this._compositingPassParameters.color=m.getTexture(),t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(n,this.bindParameters,this._compositingPassParameters),i.screen.draw(),t.attachDepth(r),m.release(),t}_update(){const e=this.bindParameters.camera,t=(0,mr.k)(e.eye),i=Math.sqrt(t),r=t-this._passParameters.radii[1]**2,s=(0,jt.uZ)((i-this._passParameters.radii[0])/ir.sv.atmosphereHeight,0,1);(0,Nc.s)(this._passParameters.heightParameters,i,t,r,s);const n=this.view.basemapTerrain?.getLowerBoundRadius()??0;(0,Er.t8)(this._passParameters.radii,n,n+ir.sv.atmosphereHeight),this._passParameters.innerFadeDistance=2*Math.sqrt((2*n-Xw.Tk)*Xw.Tk),this._passParameters.altitudeFade=(0,Xw.yx)(i-n)}};rC=(0,o._)([(0,S.j)("esri.views.3d.environment.ChapmanAtmosphere")],rC);var sC=i(30418);class nC extends Dr.A{constructor(e,t){super(e,t,new Or.J(sC.C,(()=>i.e(56244).then(i.bind(i,56244)))))}initializePipeline(){return(0,Lr.sm)({blending:(0,Lr.wK)(Ir.zi.ONE,Ir.zi.ZERO,Ir.zi.SRC_ALPHA,Ir.zi.ONE),depthTest:{func:Ir.wb.LEQUAL},colorWrite:Lr.gf})}}let aC=class extends ls{constructor(e){super(e),this._planetRadius=(0,vr.Iu)(e.view.spatialReference).radius}initialize(){this.techniques.precompile(nC),this.addHandles([(0,n.YP)((()=>null!=this.view.environment.weather&&this.view.environment.atmosphereEnabled),(e=>e?this._enable():this._disable()),n.nn)])}destroy(){this._vao=(0,f.M2)(this._vao)}render(e){const t=e.find((({name:e})=>e===Qr.CM.OPAQUE_ENVIRONMENT)),i=this.bindParameters.clouds;if(!i.data)return t;const r=this.techniques.get(nC);if(!r.compiled)return this.requestRender(os.Xx.UPDATE),t;const s=this.renderingContext;this._vao??=(0,bb.ow)(s);const n=s.bindTechnique(r,this.bindParameters);return s.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao),s.drawArrays(Ir.MX.TRIANGLE_STRIP,0,4),i.isFading&&this.requestRender(os.Xx.UPDATE),t}};aC=(0,o._)([(0,S.j)("esri.views.3d.environment.CloudsComposition")],aC);var oC=i(16926);class lC extends Dr.A{constructor(e,t){super(e,t,new Or.J(oC.a,(()=>i.e(19479).then(i.bind(i,19479)))))}initializePipeline(){return(0,Lr.sm)({blending:(0,Lr.wK)(Ir.zi.SRC_ALPHA,Ir.zi.ZERO,Ir.zi.ONE_MINUS_SRC_ALPHA,Ir.zi.ONE),colorWrite:Lr.gf})}}let cC=class extends cs{constructor(e){super(e),this.requireGeometryDepth=!0,this._newParameters=new hC,this._oldParameters=new hC,this._fadedParameters=new hC,this._parameters=this._newParameters,this._passParameters=new oC.F;const t=(0,vr.Iu)(e.view.spatialReference);this._planetRadius=t.radius,this._atmosphereRadius=t.radius+t.atmosphereHeight,e.view.stage?.renderView.techniques.precompile(lC)}toogle(){this.view.environment.atmosphereEnabled&&this.view.environment.weather?this._enable():this._disable()}initialize(){this.addHandles([(0,n.YP)((()=>this.view.environment.atmosphereEnabled),(()=>this.toogle()),n.tX),(0,n.YP)((()=>this.view.environment.weather),(()=>this.toogle()),n.tX),(0,n.YP)((()=>this._updateFogParameters()),(()=>{}),n.tX)]),this.addHandles((0,n.YP)((()=>this._fadeFactor),(e=>this._fade(e)),n.tX))}get _fadeFactor(){return this.view.stage?.renderer.renderContext.bind.clouds.fadeFactor??1}_fade(e){const{_newParameters:t,_oldParameters:i}=this;e>=1?(this._parameters=t,this._oldParameters.copyFrom(this._newParameters)):e<=0?this._parameters=i:(this._fadedParameters.lerp(i,t,e),this._parameters=this._fadedParameters)}_updateFogParameters(){const e=this.view.environment.weather,t="foggy"===e.type||"snowy"===e.type||"rainy"===e.type;this._newParameters.strength="foggy"===e.type?(0,jt.t7)(3e-5,.005,e.fogStrength**3):"snowy"===e.type||"rainy"===e.type?(0,jt.t7)(4e-6,2e-4,(e.precipitation??0)**3):0,this._newParameters.amount=t?1:0,"foggy"!==e.type&&"snowy"!==e.type||(0,mr.c)(this._newParameters.color,mC),"rainy"===e.type&&(0,mr.c)(this._newParameters.color,pC),this._fadeFactor>=1&&this._oldParameters.copyFrom(this._newParameters),this.requestRender(os.Xx.UPDATE)}render(e){const t=e.find((({name:e})=>e===Qr.CM.TRANSPARENT_ENVIRONMENT));if(0===this._parameters.amount)return t;if(this._update(),this._passParameters.amount<=0)return t;const i=this.techniques.get(lC);if(!i.compiled)return this.requestRender(os.Xx.UPDATE),t;const r=this.renderingContext,s=t.getAttachment(Ir.Lu);return t.attachDepth(null),r.bindFramebuffer(t.fbo),r.bindTechnique(i,this.bindParameters,this._passParameters),r.screen.draw(),t.attachDepth(s),t}_update(){const e=this.bindParameters.camera;(0,mr.n)(uC,e.eye);const t=Math.max(0,(0,mr.e)(uC,this.bindParameters.lighting.mainLight.direction)),i=this._parameters.color;(0,mr.g)(dC,i,.1),(0,mr.m)(this._passParameters.color,dC,i,t);const r=(0,mr.l)(e.eye);this._passParameters.atmosphereC=r**2-this._atmosphereRadius**2,this._passParameters.amount=(1-(0,jt.CW)(.95*gs.rm,1*gs.rm,Math.abs(r-this._planetRadius)))*this._parameters.amount,this._passParameters.strength=this._parameters.strength}};cC=(0,o._)([(0,S.j)("esri.views.3d.environment.Fog")],cC);class hC{constructor(){this.color=(0,O.Ue)(),this.strength=0,this.amount=0}copyFrom(e){this.amount=e.amount,this.strength=e.strength,(0,mr.c)(this.color,e.color)}lerp(e,t,i){this.amount=(0,jt.t7)(e.amount,t.amount,i),this.strength=(0,jt.t7)(e.strength,t.strength,i),(0,mr.m)(this.color,e.color,t.color,i)}}const uC=(0,O.Ue)(),dC=(0,O.Ue)(),pC=(0,O.al)(.5,.5,.5),mC=(0,O.al)(1.5,1.5,1.5);var _C=i(66696),fC=i(35286);class gC extends Dr.A{constructor(e,t){super(e,t,new Or.J(_C.a,(()=>i.e(63495).then(i.bind(i,63495)))))}initializePipeline(e){const t=e.geometry===fC.n.Cylinder;return(0,Lr.sm)({blending:Lr.vf,culling:t?Lr.Rd:void 0,depthTest:{func:Ir.wb.LEQUAL},colorWrite:Lr.gf})}}const yC=new Uint8ClampedArray([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,16,0,0,16,16,0,0,16,16,0,0,16,16,0,0,16,15,0,0,17,15,0,0,17,15,0,0,17,15,0,0,17,14,0,0,18,14,0,0,18,14,0,0,18,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,20,13,0,0,20,13,0,0,20,13,0,0,20,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,22,12,0,0,22,12,0,0,22,12,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,27,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,29,18,0,0,29,18,0,0,29,17,0,0,30,17,0,0,30,17,0,0,30,17,0,0,30,16,0,0,31,16,0,0,31,16,0,0,31,16,0,0,32,16,0,0,32,16,0,0,32,15,0,0,33,15,0,0,33,15,0,0,33,15,0,0,34,15,8,0,34,15,8,0,34,15,8,0,34,15,7,0,35,15,7,0,35,15,7,0,35,21,7,0,36,21,7,0,36,21,7,0,36,21,7,0,37,21,7,0,37,21,7,0,37,20,7,0,38,20,7,0,38,20,7,0,38,20,7,0,39,20,7,0,39,20,7,0,39,20,7,0,39,19,6,0,40,19,6,0,40,19,6,0,40,19,6,0,41,19,6,0,41,19,6,0,41,18,6,0,42,18,6,0,42,18,6,0,42,24,6,0,43,24,6,0,43,24,6,0,43,23,6,0,44,23,6,0,44,23,6,0,44,23,6,0,45,23,6,0,45,23,6,0,45,22,6,0,46,22,6,0,46,22,6,0,46,22,5,0,47,22,5,0,47,22,5,0,47,21,5,0,48,21,5,0,48,21,5,0,48,21,5,0,49,21,5,0,49,26,5,0,49,25,5,0,50,25,5,0,50,25,5,0,50,25,5,0,51,25,5,0,51,25,5,0,51,25,5,0,52,25,5,0,52,25,5,0,52,24,5,0,53,24,5,0,53,24,5,0,53,24,9,0,54,28,9,0,54,28,9,0,54,28,9,0,55,28,9,0,55,27,9,0,56,27,9,0,56,27,9,0,56,27,9,4,57,27,9,4,57,27,9,4,57,26,9,4,58,26,9,4,58,26,9,4,58,26,9,4,59,26,9,4,59,26,9,4,59,26,8,4,60,30,8,4,60,30,8,4,60,29,8,4,61,29,8,4,61,29,8,4,62,29,8,4,62,29,8,4,62,28,8,4,63,28,8,4,63,28,8,4,63,28,12,4,64,28,12,4,64,28,12,4,64,27,12,4,65,27,12,8,65,27,12,8,65,31,12,8,66,31,12,8,66,30,11,8,67,30,11,8,67,30,11,8,67,30,11,8,68,30,11,8,68,30,11,8,68,30,15,7,69,30,15,7,69,30,15,7,69,33,15,11,70,33,15,11,70,32,14,11,71,32,14,11,71,32,14,11,71,32,18,14,72,32,18,14,72,32,18,14,72,31,17,14,73,35,17,14,73,34,17,17,74,34,21,17,74,34,21,17,74,34,20,17,75,34,20,20,75,34,20,20,75,34,23,20,76,34,23,20,76,36,23,23,77,36,23,23,77,36,23,23,77,36,23,23,78,36,26,26,78,36,26,26,78,36,26,26,79,36,26,29,79,38,26,29,80,38,29,29,80,38,29,29,80,38,28,31,81,38,28,31,81,38,31,31,81,37,31,34,82,37,31,34,82,37,31,37,83,40,34,37,83,40,34,37,83,39,33,39,84,39,33,39,84,39,36,42,84,39,36,42,85,39,36,42,85,39,36,42,85,39,39,44,86,39,39,44,86,41,38,47,87,41,41,47,87,41,41,50,87,41,41,49,88,41,41,52,88,40,43,52,89,43,43,52,89,43,43,54,89,42,45,54,90,42,45,57,90,42,45,57,90,42,45,59,91,42,48,59,91,44,47,61,92,44,47,61,92,44,50,61,92,44,49,63,93,44,49,63,93,44,52,66,93,43,52,65,94,46,54,68,94,46,54,70,95,46,54,70,95,46,54,70,95,45,56,72,96,45,56,72,96,45,58,74,97,47,58,76,97,47,58,76,97,47,60,78,98,47,60,78,98,47,60,81,98,49,62,80,99,49,62,82,99,48,61,84,100,48,64,84,100,48,64,84,100,50,63,86,101,50,66,86,101,50,66,88,101,50,65,90,102,52,67,89,103,51,69,91,104,51,68,92,105,52,69,93,107,52,71,94,108,54,70,96,109,53,71,96,111,52,73,98,112,54,72,98,114,53,73,100,115,54,72,100,117,54,73,102,118,55,74,104,120,55,76,105,121,56,77,106,123,56,76,107,124,57,79,107,126,58,78,110,128,57,79,111,129,56,80,113,131,58,79,112,132,57,82,114,134,58,81,116,136,60,82,117,137,59,83,117,139,60,83,119,141,59,84,120,142,60,85,122,144,59,86,122,146,60,86,126,148,62,87,127,149,61,88,127,151,62,88,128,153,63,89,130,155,62,90,131,156,63,90,132,158,64,91,134,160,65,91,135,162,64,92,136,163,63,93,138,165,66,95,139,167,65,95,140,169,66,95,142,171,67,96,142,172,66,97,144,174,67,99,145,176,67,97,148,178,67,99,147,180,68,100,149,181,68,100,150,183,69,101,152,185,70,102,153,187,71,103,155,188,70,103,156,190,70,104,157,192,71,105,158,194,71,106,160,195,72,106,161,197,72,108,161,199,73,108,163,200,73,109,164,202,74,109,165,204,74,110,167,206,75,111,168,207,74,112,170,209,75,112,170,210,76,113,171,212,76,114,173,214,77,115,174,215,78,115,175,217,78,116,175,218,78,117,177,220,78,118,178,221,79,118,180,223,80,120,180,224,81,120,181,226,81,120,182,227,82,121,184,229,82,122,185,230,84,123,186,232,83,123,187,233,84,124,189,234,84,125,188,235,85,126,189,237,86,126,190,238,86,127,191,239,87,127,192,240,87,129,193,242,88,129,194,243,89,130,195,244,90,131,196,245,90,132,197,246,91,132,197,247,92,133,198,248,92,134,199,249,93,135,200,250,94,136,201,251,95,137,202,252,96,138,203,253,97,140,204,254,98,141,205,254,99,142,206,255,101,143,207,255,102,144,208,255,103,146,209,255,104,147,209,255,106,148,210,255,107,149,211,255,108,151,212,255,110,152,213,255,111,153,213,255,112,154,214,255,114,156,215,255,115,157,215,255,117,158,216,255,118,160,217,255,120,161,217,255,121,162,218,255,123,164,218,255,124,165,219,255,125,166,219,255,127,167,220,255,129,169,220,255,130,170,221,255,132,171,221,255,133,173,222,255,134,174,222,255,136,175,223,255,139,178,224,255,142,180,224,255,144,182,225,255,147,185,226,255,150,187,226,255,153,189,227,255,155,191,228,255,158,194,228,255,160,196,229,255,163,198,229,255,165,200,230,255,168,202,231,255,170,203,231,255,172,205,232,255,174,207,232,255,176,209,233,255,178,210,234,255,180,212,234,255,182,214,235,255,184,215,236,255,186,217,237,255,188,219,238,255,190,220,238,255,192,221,239,255,193,222,240,255,194,224,240,255,196,225,241,255,197,226,241,255,198,226,242,255,199,227,242,255,200,228,242,255,201,228,243,255,202,229,243,255,203,230,243,255,204,230,244,255,205,231,244,255,207,232,244,255,208,233,245,255,209,233,245,255,211,234,246,255,213,235,246,255,217,238,247,255,222,240,248,255,226,242,249,255,231,245,250,255,236,247,251,255,241,249,252,255,245,251,253,255,249,252,254,255,255,255,255,255]);var vC=i(86026);let bC=class extends ls{constructor(){super(...arguments),this._configuration=new fC.f,this._passParameters=new _C.S,this._vao=null,this._vaoCount=0}initialize(){this._configuration.geometry=fC.n.Cylinder,this.addHandles([(0,n.YP)((()=>this.view.environment.atmosphereEnabled),(e=>e?this._enable():this._disable()),n.nn)])}destroy(){this._passParameters.texture=(0,f.M2)(this._passParameters.texture),this._vao=(0,f.M2)(this._vao)}precompile(){this.techniques.precompile(gC,this._configuration)}render(e){const t=e.find((({name:e})=>e===Qr.CM.OPAQUE_ENVIRONMENT)),i=this.techniques.get(gC,this._configuration);if(!i.compiled)return this.requestRender(os.Xx.UPDATE),t;const r=this.renderingContext;if(this._vao||(this._vao=function(e){const t=(0,vC.xu)(1,2,!1),{data:i,indices:r}=t[0][1],s=CC.createBuffer(r.length),n=s.position;for(let e=0;e<r.length;++e){const t=3*r[e%3==0?e+2:e%3==2?e-2:e];n.set(e,0,i[t]),n.set(e,1,i[t+1]),n.set(e,2,i[t+2])}return new hs.U(e,Ed.i,new Map([["geometry",(0,ss.K)(CC)]]),new Map([["geometry",us.f.createVertex(e,Ir.l1.STATIC_DRAW,s.buffer)]]))}(r),this._vaoCount=(0,ds._V)(this._vao,"geometry")),!this._passParameters.texture){const e=new Br.X;e.wrapMode=Ir.e8.CLAMP_TO_EDGE,e.flipped=!0,e.width=1,e.height=512,this._passParameters.texture=new Pd.x(r,e,yC)}const s=r.bindTechnique(i,this.bindParameters,this._passParameters);return function(e,t){(0,Sr.JG)(e,t),e[12]=0,e[13]=0,e[14]=0,e[15]=1}(wC,this.bindParameters.camera.viewMatrix),s.setUniformMatrix4fv("view",wC),r.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao),r.drawArrays(Ir.MX.TRIANGLES,0,this._vaoCount),t}};bC=(0,o._)([(0,S.j)("esri.views.3d.environment.LocalAtmosphere")],bC);const wC=(0,Mr.Ue)(),CC=(0,ns.U$)().vec3f(Jr.T.POSITION);var xC=i(39909);const TC=new Uint8ClampedArray([0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,16,0,0,0,16,0,0,0,16,0,0,0,17,0,0,0,17,0,0,0,18,0,0,0,18,0,0,0,19,0,0,0,19,0,0,0,19,0,0,0,20,0,0,0,20,0,0,0,21,0,0,0,21,0,0,0,22,0,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,28,9,0,0,28,9,0,0,29,9,0,0,29,8,0,0,30,8,0,0,30,8,0,0,31,8,0,0,31,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,33,8,0,0,33,8,0,0,34,7,0,0,35,7,0,0,35,7,0,0,36,7,0,0,36,7,7,0,37,7,7,0,37,7,7,0,38,7,7,0,38,13,7,0,39,13,7,0,39,13,6,0,40,13,6,0,40,12,6,0,41,12,6,0,41,12,6,0,41,12,6,0,42,12,6,0,42,12,6,0,43,12,6,0,43,12,6,0,44,12,6,0,44,11,6,0,45,11,6,6,45,11,6,6,46,11,5,5,47,11,5,5,47,11,5,5,48,11,5,5,48,10,5,5,49,10,5,5,49,10,5,5,50,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,52,15,5,5,52,14,5,5,53,14,5,5,54,14,5,5,54,14,5,5,55,14,5,5,55,14,5,5,56,13,4,4,57,13,4,4,57,13,4,4,58,13,4,4,58,13,4,4,59,13,4,4,59,17,4,4,60,17,4,4,60,17,4,4,60,17,4,4,61,17,4,4,61,16,4,4,62,16,4,4,63,16,4,4,63,16,8,4,64,16,8,4,64,16,8,4,65,15,8,4,66,15,8,4,66,15,8,4,67,19,8,4,68,19,8,4,68,18,7,4,69,18,7,4,69,18,7,4,69,18,7,4,70,18,7,4,70,18,7,4,71,18,7,4,71,18,7,4,72,17,7,3,73,17,7,3,73,21,7,3,74,21,7,3,74,20,7,3,75,20,7,3,76,20,7,3,76,20,7,3,77,20,7,3,77,20,7,3,78,20,7,3,78,20,7,7,78,19,6,6,79,19,10,6,80,19,10,6,80,22,9,6,81,22,9,6,81,22,9,6,82,22,9,6,83,22,9,6,83,21,9,6,84,21,9,6,84,21,9,6,85,21,9,6,86,21,9,6,86,23,9,6,87,23,9,6,87,23,9,6,87,23,9,6,88,23,9,6,88,23,9,6,89,23,8,6,90,23,8,6,90,22,8,6,91,22,8,6,91,25,8,6,92,25,8,5,93,25,8,5,93,24,8,5,94,24,8,5,94,24,11,5,95,24,11,5,96,24,11,5,96,26,11,5,97,26,11,5,97,26,11,5,97,26,10,5,98,26,10,5,98,26,10,5,99,25,10,5,100,25,10,5,100,25,10,5,101,25,10,5,101,25,10,5,102,27,10,5,103,27,10,5,103,27,10,5,104,27,10,5,104,27,12,5,105,26,12,5,106,26,12,5,106,29,12,5,106,29,12,5,106,29,12,7,107,28,12,7,108,28,12,7,108,28,12,7,109,28,12,7,109,30,12,7,110,30,11,7,111,30,11,7,111,30,11,7,112,30,11,7,112,29,11,7,113,29,11,7,114,29,11,7,114,31,11,7,115,31,11,7,115,31,11,7,115,31,11,7,116,31,11,7,116,33,13,7,117,33,13,9,117,32,13,9,118,32,13,9,118,32,13,9,119,34,15,8,120,34,15,8,120,34,15,8,121,36,15,8,121,36,15,8,122,36,15,8,122,35,15,8,123,37,14,8,124,37,14,8,124,37,14,8,124,37,14,8,124,39,14,8,125,39,16,8,125,38,16,8,126,38,16,8,127,38,16,8,127,40,16,10,128,40,16,10,128,40,16,10,129,42,18,10,129,41,18,10,130,41,18,10,130,43,18,10,131,43,18,10,131,42,17,10,132,42,17,12,132,42,17,12,133,44,17,12,133,44,17,12,133,46,17,11,134,46,17,11,134,45,19,11,135,45,19,11,135,47,19,11,136,47,19,11,136,47,19,11,137,47,19,11,137,48,20,11,138,48,20,11,138,50,20,13,139,50,20,13,139,49,20,13,140,49,22,13,140,51,22,13,141,51,22,13,141,50,22,13,142,52,22,13,142,52,21,12,143,53,21,12,143,53,21,12,143,53,21,12,143,53,21,14,144,53,23,14,144,55,23,14,145,55,23,14,145,56,23,14,146,56,23,14,146,57,24,14,147,57,24,14,147,59,24,16,148,59,24,16,148,58,24,15,149,58,26,15,149,58,26,15,149,60,26,15,150,60,26,15,150,61,25,15,151,61,25,15,151,62,25,17,152,62,25,17,152,64,25,17,152,64,27,17,152,63,27,17,153,63,27,17,153,65,27,17,153,66,28,17,154,66,28,17,154,67,28,16,155,67,28,16,155,67,30,16,155,69,29,18,156,69,29,18,156,68,29,18,157,70,29,18,157,70,29,18,157,71,31,18,158,71,31,18,158,72,30,19,159,72,30,19,159,74,30,19,159,73,30,19,160,73,32,19,160,74,32,19,161,74,32,21,161,76,32,21,161,78,33,21,161,78,33,21,161,79,35,20,162,78,34,20,163,79,34,22,164,81,36,22,164,82,36,22,165,81,35,22,166,82,37,21,167,84,37,21,167,85,36,21,168,86,38,23,169,88,38,23,169,88,38,23,170,88,39,23,170,89,39,24,171,91,40,24,171,92,40,24,172,93,40,24,173,94,41,25,173,95,41,25,174,96,42,25,175,98,42,25,175,99,43,26,176,99,43,26,177,101,45,26,177,102,44,26,178,103,46,27,179,104,46,27,179,105,46,27,179,106,45,28,180,108,47,28,180,108,46,28,181,109,48,28,182,111,48,29,182,111,49,29,183,114,49,29,184,114,50,30,184,114,50,30,185,116,51,30,185,117,51,30,186,119,52,31,187,119,53,31,187,121,53,31,188,122,54,33,188,123,54,32,189,124,55,32,189,125,55,32,189,126,56,34,190,128,56,34,190,128,57,33,191,130,57,33,191,131,58,35,192,131,58,35,192,133,59,34,193,134,60,35,194,135,60,35,194,136,61,37,195,139,61,37,195,139,62,36,196,141,62,36,196,141,63,38,197,142,63,38,197,143,64,39,198,144,64,39,198,146,66,39,198,146,67,39,198,147,67,38,199,147,68,40,199,149,68,40,200,150,69,40,200,152,70,41,201,154,71,41,201,154,71,42,202,155,72,42,202,156,73,41,203,157,73,43,203,158,74,42,204,160,75,44,204,161,76,44,204,162,77,44,205,164,77,45,205,165,78,45,206,166,79,45,206,168,80,46,207,169,81,46,207,170,83,47,207,171,83,47,207,172,83,47,207,174,85,48,208,175,85,48,208,177,85,48,209,178,87,49,209,180,87,49,210,181,87,49,210,182,89,50,210,182,89,50,211,185,91,50,211,186,91,51,212,186,93,51,212,189,94,52,212,190,95,51,213,192,96,51,213,193,96,53,213,194,97,52,214,195,98,54,214,197,98,55,215,198,100,55,215,199,101,55,215,200,102,55,216,202,103,55,216,203,104,55,216,204,105,57,216,205,106,57,216,207,107,58,216,208,108,58,217,209,109,59,217,210,110,60,217,211,111,60,218,212,112,61,218,213,113,61,218,214,114,62,219,217,115,63,219,217,116,64,219,218,118,64,220,219,119,65,220,220,121,66,220,222,121,67,221,222,122,67,221,222,123,68,221,223,124,69,222,224,125,70,222,225,127,71,222,226,128,72,223,228,129,73,223,228,130,74,223,229,132,75,223,230,135,79,224,231,138,81,224,233,141,84,224,233,144,87,225,235,147,91,225,236,150,94,225,237,154,97,225,238,158,102,225,239,161,107,225,239,165,110,225,240,168,114,226,241,172,118,226,241,176,122,226,241,181,126,226,242,183,130,227,243,186,135,227,243,190,139,227,244,194,143,227,244,197,147,228,244,200,150,228,245,204,154,228,245,207,157,228,245,210,161,229,246,212,164,229,246,215,167,229,246,217,169,229,246,220,172,230,247,221,174,230]),SC=128,MC=-1e4,EC=(0,rr.uV)([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);let RC=class extends ls{constructor(e){super(e),this._passParameters=new _C.S,this._configuration=new fC.f,this._vao=null,this._vaoCount=0,this._fadeVao=null,this._fadeVaoCount=0,this._texV1=1;const t=e.view,i=(0,vr.Iu)(t.spatialReference),{outerAtmosphereRimWidth:r,radius:s}=i;this._planetRadius=s,this._innerRimFactor=1+MC/s,this._middleRimFactor=1+0/s,this._outerRimFactor=1+r/s,this._texV0=0/r,this._texVScale=this._texV1-this._texV0;const n=t.stage.renderView.techniques;n.precompile(gC,this._configuration),this._configuration.geometry=fC.n.Underground,n.precompile(gC,this._configuration)}initialize(){this.addHandles((0,n.YP)((()=>this.view.environment.atmosphereEnabled),(e=>e?this._enable():this._disable()),n.nn))}destroy(){this._passParameters.texture=(0,f.M2)(this._passParameters.texture),this._fadeVao=(0,f.M2)(this._fadeVao),this._vao=(0,f.M2)(this._vao)}render(e){const t=e.find((({name:e})=>e===Qr.CM.OPAQUE_ENVIRONMENT));this._update();const i=this.renderingContext;if(!this._passParameters.texture){const e=new Br.X;e.wrapMode=Ir.e8.CLAMP_TO_EDGE,e.flipped=!0,e.width=1,e.height=512,this._passParameters.texture=new Pd.x(i,e,TC)}if(this._passParameters.undergroundFadeAlpha<1){this._vao||(this._vao=this._createRibbon(i),this._vaoCount=(0,ds._V)(this._vao,"geometry")),this._configuration.geometry=fC.n.Cone;const e=this.techniques.get(gC,this._configuration);if(!e.compiled)return this.requestRender(os.Xx.UPDATE),t;i.bindTechnique(e,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(Ir.MX.TRIANGLES,0,this._vaoCount)}if(this._passParameters.undergroundFadeAlpha>0){this._fadeVao||(this._fadeVao=(0,bb.ow)(i),this._fadeVaoCount=(0,ds._V)(this._fadeVao,"geometry")),this._configuration.geometry=fC.n.Underground;const e=this.techniques.get(gC,this._configuration);if(!e.compiled)return this.requestRender(os.Xx.UPDATE),t;i.bindTechnique(e,this.bindParameters,this._passParameters),i.bindVAO(this._fadeVao),i.drawArrays(Ir.MX.TRIANGLE_STRIP,0,this._fadeVaoCount)}return t}_update(){const e=this.bindParameters.camera,t=(0,O.Ue)(),i=this._planetRadius,r=(0,mr.l)(e.eye),s=r-i;if(s<0){const e=Math.min(-s/5e3,1);this._passParameters.undergroundFadeAlpha=e}else this._passParameters.undergroundFadeAlpha=0;const n=Math.max(50,s),a=i+MC;this._passParameters.innerScale=function(e,t,i){return e*e/(Math.sqrt(e*e-t*t)*Math.sqrt(e*e-i*i)+t*i)}(i+n,i,a)-1,this._passParameters.altitudeFade=(0,Xw.yx)(s),(0,mr.g)(t,e.eye,(i+50)/r),PC(t,e.center,e.up,i,this._passParameters.silhouette);const o=this._computeScreenRimWidth(e,t,e.up,this._passParameters.silhouette),l=1-511/512,c=EC(s);let h=this._texV0+l*this._texVScale,u=this._texV0+o*c*this._texVScale;if(s>50){PC(e.eye,e.center,e.up,i,this._passParameters.silhouette);const t=this._computeScreenRimWidth(e,e.eye,e.up,this._passParameters.silhouette),r=(0,jt.uZ)((t-1.5)/(o-1.5),0,1);h=this._texV0+r*l*this._texVScale,u=this._texV0+(0,jt.t7)(this._texV1,o*c,r)*this._texVScale}(0,Er.t8)(this._passParameters.texV,h,u)}_createRibbon(e){const t=(0,xC.xx)(1155),i=new Uint32Array(1920);t[0]=0,t[1]=0,t[2]=-1;for(let e=0;e<SC;e++){const r=9*e+3;t[r]=e,t[r+1]=this._innerRimFactor,t[r+2]=-1,t[r+3]=e,t[r+4]=this._middleRimFactor,t[r+5]=0,t[r+6]=e,t[r+7]=this._outerRimFactor,t[r+8]=1;const s=3*e+1,n=127===e?1:s+3,a=15*e;i[a]=s,i[a+1]=s+1,i[a+2]=n+1,i[a+3]=n+1,i[a+4]=n,i[a+5]=s,i[a+6]=s+1,i[a+7]=s+2,i[a+8]=n+2,i[a+9]=n+2,i[a+10]=n+1,i[a+11]=s+1,i[a+12]=s,i[a+13]=n,i[a+14]=0}const r=IC.createBuffer(i.length),s=r.position;for(let e=0;e<i.length;++e){const r=3*i[e];s.set(e,0,t[r]),s.set(e,1,t[r+1]),s.set(e,2,t[r+2])}return new hs.U(e,Ed.i,new Map([["geometry",(0,ss.K)(IC)]]),new Map([["geometry",us.f.createVertex(e,Ir.l1.STATIC_DRAW,r.buffer)]]))}_computeScreenRimWidth(e,t,i,r){return(0,mr.f)(OC,r.center,r.v2),(0,mr.g)(DC,OC,this._outerRimFactor),(0,Sr.zB)(AC,t,OC,i),(0,R_.iV)(OC,AC,e.projectionMatrix,e.viewport,OC),(0,R_.iV)(DC,AC,e.projectionMatrix,e.viewport,DC),(0,mr.j)(OC,DC)/e.height}};function PC(e,t,i,r,s){const n=(0,mr.l)(e),a=r*Math.sqrt(n*n-r*r)/n,o=Math.sqrt(r*r-a*a),l=s.v1,c=s.v2;return(0,mr.g)(s.center,e,o/n),(0,mr.h)(l,e,t),(0,mr.k)(l)<1&&(0,mr.h)(l,e,i),(0,mr.g)(l,l,a/(0,mr.l)(l)),(0,mr.h)(c,l,e),(0,mr.g)(c,c,a/(0,mr.l)(c)),a}RC=(0,o._)([(0,S.j)("esri.views.3d.environment.MarsAtmosphere")],RC);const AC=(0,Mr.Ue)(),OC=(0,O.Ue)(),DC=(0,O.Ue)();const IC=(0,ns.U$)().vec3f(Jr.T.POSITION),LC=RC;var FC=i(38766),NC=i(2875),UC=i(32222),HC=i(72432),VC=i(78986);class kC{constructor(e){this._totalCount=e,this._componentCountCache=-1,this._indexRanges=[0,e]}allVisible(){return this.componentCount===this._totalCount}allInvisible(){return 0===this._indexRanges.length}isVisible(e){if(e<0||e>=this._totalCount)return!1;if(this.allVisible())return!0;const t=this._indexRanges;let i=0,r=t.length/2;if(e<t[2*i]||e>t[2*r]+t[2*r+1])return!1;for(;r-i>0;){const s=Math.floor(.5*(i+r)),n=t[2*s];if(e<n){if(r-i==1)return!1;r=s}else{if(e<n+t[2*s+1])return!0;if(r-i==1)return!1;i=s+1}}return!1}get componentCount(){if(-1===this._componentCountCache){const e=this._indexRanges;let t=0;for(let i=0;i<e.length;i+=2)t+=e[i+1];this._componentCountCache=t}return this._componentCountCache}reset(e){"all"===e||e.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=function(e){const t=new Array;if(0===e.length)return t;let i=e[0],r=1;for(let s=1;s<e.length;s++){const n=e[s];i+r===n?r+=1:(t.push(i),t.push(r),i=n,r=1)}return t.push(i),t.push(r),t}(e),this._componentCountCache=-1}forEachComponent(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const r=t[i],s=r+t[i+1];for(let t=r;t<s;t++)if(!e(t))return!1}return!0}forEachComponentRange(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const r=t[i];if(!e(r,r+t[i+1]))return!1}return!0}computeOffsetRanges(e){const t=new Array(this._indexRanges.length),i=this._indexRanges;for(let r=0;r<i.length;r+=2){const s=i[r],n=s+i[r+1],a=e[s],o=e[n];t[r]=a,t[r+1]=o-a}return t}}class BC{constructor(e,t){this.offsets=t,this._highlightsInOrder=[],this.pickability=null,this.componentHighlights=new Map,this.verticalOffsets=null,this._cachedGeometryRanges=null,this._cachedHighlightRangesMap=null,this._cachedShadowmapRanges=null;const i=this.count;this.visibility=new kC(i),this.materialDataBuffer=e.getBuffer(i),this.materialDataIndices=new Uint16Array(i);for(let e=0;e<i;e++)this.materialDataIndices[e]=this.materialDataBuffer.acquireIndex()}destroy(){for(let e=0;e<this.count;e++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[e])}get count(){return this.offsets.length-1}get geometryRanges(){return null==this._cachedGeometryRanges&&(this._cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this._cachedGeometryRanges}get highlightRangesMap(){return 0===this.componentHighlights.size?null:(this._updateCachedHighlightRanges(),this._cachedHighlightRangesMap)}get shadowmapRanges(){return 0===this.componentHighlights.size?this.geometryRanges:(this._updateCachedHighlightRanges(),this._cachedShadowmapRanges)}markHighlightsDirty(){this._cachedHighlightRangesMap=null,this._cachedShadowmapRanges=null}markVisibilityDirty(){this._cachedGeometryRanges=null,this.markHighlightsDirty()}updateHighlights(e){this._updateHighlightOrder(e)&&(this.markHighlightsDirty(),this._updateCachedHighlightRanges())}_updateHighlightOrder(e){const{_highlightsInOrder:t}=this;let i=t.length!==e.length;t.length=Math.min(e.length,8);for(let r=0;r<e.length;++r){const s=e.at(r).name;t.length<r?(i=!0,t.push(s)):t[r]!==s&&(t[r]=s,i=!0)}return i}_updateCachedHighlightRanges(){if(null==this._cachedHighlightRangesMap||null==this._cachedShadowmapRanges){const{highlightRangesMap:e,shadowmapRangesMap:t}=function(e,t,i,r){const s=new Map,n=[];if(e.size>0){let a=i.length;t.forEachComponent((t=>{let o=!1;for(let n=r.length-1;n>=0;--n){const a=r[n];if((e.get(a)?.[t]??0)>0){const e=(0,Mt.s1)(s,a,(()=>[])),r=i[t],n=i[t+1];e.push(r),e.push(n-r),o||=a===si.b;break}}return o||(a!==t-1&&(n.length>0&&n.push(i[a+1]-n[n.length-1]),n.push(i[t])),a=t),!0})),n.length>0&&n.push(i[a+1]-n[n.length-1])}return{highlightRangesMap:s,shadowmapRangesMap:n}}(this.componentHighlights,this.visibility,this.offsets,this._highlightsInOrder);this._cachedHighlightRangesMap=e,this._cachedShadowmapRanges=t}}}class zC{constructor(e,t,i,r,s,n){this.transform=e,this.toMapSpace=t,this.obb=i,this.componentData=r,this.renderable=s,this.intersectionGeometry=n,this.visible=!1,this.offsetObb=null}destroy(){this.intersectionGeometry=(0,f.SC)(this.intersectionGeometry),this.renderable=(0,f.SC)(this.renderable),this.componentData=(0,f.SC)(this.componentData)}}function GC(e,t){return new(function(e){return e<128?Uint8Array:e<32768?Uint16Array:e<1<<31?Uint32Array:Array}(e))(t)}class qC{constructor(e,t){this.elementCount=e,this.model=t,this._elementIndexMap=null,this._bspNodes=[],this._generatedBVH=!1,this.localMode=t.localMode,this.planetCenterZ=t.planetCenterZ,this.geometryMinZ=t.geometryMinZ,this.planetCenter=(0,O.al)(0,0,this.planetCenterZ),this.maxBspNodeDepth=t.maxBspNodeDepth??8,this.minElementCountForBVH=t.minElementCountForBVH??15,this.minBspNodeElementCount=t.minBspNodeElementCount??5}get elementIndexMap(){return this._ensureBVH(),this._elementIndexMap}get _skipBVH(){return this.elementCount<this.minElementCountForBVH||this.geometryMinZ<.5*this.planetCenterZ}_ensureBVH(){this._generatedBVH||this._skipBVH||0===this._bspNodes.length&&this._generateBsp()}intersectRay(e,t,i){this.elementCount<1||(this._skipBVH?this._intersectRayWithoutBVH(i):this._intersectRayWithBVH(e,t,i))}_intersectRayWithoutBVH(e){this._intersectRange(0,this.elementCount)}_intersectRange(e,t){this.model.intersectRange(e,t)}_intersectRayWithBVH(e,t,i){this._ensureBVH(),i?this._intersectGeometryWithBVHVerticalRay(e):this._intersectGeometryWithBVHGeneralRay(e,t)}_intersectGeometryWithBVHVerticalRay(e){let t=e[0],i=e[1];if(!this.localMode){const{geometryMinZ:r,planetCenterZ:s}=this,n=(r-s)/(e[2]-s);t=e[0]*n,i=e[1]*n}const{_bspNodes:r}=this;let s=0;for(;s>=0;){const e=r[s],{d:n,dim:a,minIndexIndex:o,minMidIndexIndex:l,maxMidIndexIndex:c,maxIndexIndex:h,aabb2D:u}=e;if(t<u[0]||t>u[2]||i<u[1]||i>u[3])break;if(-1===a||-1===e.child0&&-1===e.child1){this._intersectRange(o,h);break}{this._intersectRange(l,c);const r=(0===a?t:i)-n;if(r<0){if(-1===e.child0){this._intersectRange(o,l);break}s=e.child0}else{if(!(r>0))break;if(-1===e.child1){this._intersectRange(c,h);break}s=e.child1}}}}_intersectGeometryWithBVHGeneralRay(e,t){let i=e[0],r=e[1],s=t[0],n=t[1];const{geometryMinZ:a}=this;if(!this.localMode){let o=0,l=1;const c=Math.min(.5*this.planetCenterZ,a),h=e[2],u=t[2];if(h<c&&u<c)return;if(h<c&&(o=(c-h)/(u-h)),u<c&&(l=(c-h)/(u-h)),o>l)return;const d=(1-o)*e[0]+o*t[0],p=(1-o)*e[1]+o*t[1],m=(1-o)*e[2]+o*t[2],_=(1-l)*e[0]+l*t[0],f=(1-l)*e[1]+l*t[1],g=(1-l)*e[2]+l*t[2],{planetCenterZ:y}=this,v=a-y,b=v/(m-y);i=d*b,r=p*b;const w=v/(g-y);s=_*w,n=f*w}const o=s-i,l=n-r,c=this._bspNodes;let h=1;{const{aabb2D:e}=c[0],t=(e,t,i,r)=>{if(Math.abs(t)<1e-5*Math.max(r-i,1))return!1;const s=t>0,n=s?r:i,a=e+h*t;return(s?a<n:a>n)&&(h=Math.max((n-e)/t,h),!0)},s=()=>t(i,o,e[0],e[2]),n=()=>t(r,l,e[1],e[3]);Math.abs(o)>=Math.abs(l)?s()||n():n()||s()}const u=[0,0,h];let d=0;for(;d<u.length;){const e=u[d];let t=u[d+1],s=u[d+2];if(d+=3,t>s)continue;const n=c[e],{minIndexIndex:a,maxIndexIndex:p}=n,{child0:m,child1:_,minMidIndexIndex:f,maxMidIndexIndex:g,aabb2D:y,d:v,dim:b}=n;{const e=i+t*o,r=i+s*o,n=Math.min(e,r),a=Math.max(e,r),l=y[0],c=y[2];if(a<l||c<n)continue;if(n<l){const e=(l-i)/o;o>0?t=Math.max(t,e):s=Math.min(s,e)}if(c<a){const e=(c-i)/o;o>0?s=Math.min(s,e):t=Math.max(t,e)}}{const e=r+t*l,i=r+s*l,n=Math.min(e,i),a=Math.max(e,i),o=y[1],c=y[3];if(a<o||c<n)continue;if(n<o){const e=(o-r)/l;l>0?t=Math.max(t,e):s=Math.min(s,e)}if(c<a){const e=(c-r)/l;l>0?s=Math.min(s,e):t=Math.max(t,e)}}if(-1===m&&-1===_)this._intersectRange(a,p);else{const e=0===b?i:r,n=0===b?o:l,c=e+t*n,d=e+s*n,y=Math.min(c,d),w=Math.max(c,d),C=(0,jt.uZ)((v-e)/n,0,h);a<f&&y<=v&&(-1!==m?(u.push(m),u.push(n>=0?t:Math.max(t,C)),u.push(n>=0?Math.min(s,C):s)):this._intersectRange(a,f)),this._intersectRange(f,g),g<p&&v<=w&&(-1!==_?(u.push(_),u.push(n>=0?Math.max(t,C):t),u.push(n>=0?s:Math.min(s,C))):this._intersectRange(g,p))}}}_generateBsp(){const{elementCount:e}=this;if(e<1)return;const t=GC(e,e);this._elementIndexMap=t;for(let i=0;i<e;++i)t[i]=i;const i=this.model.getAabbs2D();let r=0;const s=this._bspNodes;s.length=0;const{localMode:n}=this;let a=!1;if(!n){const{planetCenterZ:e,geometryMinZ:t}=this;a=e>=0||t<.5*e}const o=[],l=(e,t,i,r,s)=>{o.push(e),o.push(t),o.push(i),o.push(r<0?-1:(s?0:1)+2*r)},{maxBspNodeDepth:c,minBspNodeElementCount:h}=this,u=(e,r,o,u,d)=>{const p=s.length;if(p>0&&(a||o>=c||r-e<h))return;const m=(0,V.Ue)();!function(e,t,i,r,s){let n=1/0,a=1/0,o=-1/0,l=-1/0;for(let e=t;e<i;++e){const t=4*r[e];n=Math.min(n,s[t+0]),a=Math.min(a,s[t+1]),o=Math.max(o,s[t+2]),l=Math.max(l,s[t+3])}e[0]=n,e[1]=a,e[2]=o,e[3]=l}(m,e,r,t,i);const{d:_,dim:f}=n?function(e){const t=e[0],i=e[1],r=e[2],s=e[3];let n,a;return r-t>=s-i?(a=.5*(t+r),n=0):(a=.5*(i+s),n=1),{d:a,dim:n}}(m):function(e){const t=e[0],i=e[1],r=e[2],s=e[3];let n,a;return r-t>=s-i?(n=0,a=.5*(t+r)):(n=1,a=.5*(i+s)),{dim:n,d:a}}(m),{rangeMidStart:g,rangeMidEnd:y}=function(e,t,i,r,s,n){let a=e;{let e=t;for(;a<e;){const t=s[a];ZC(t,i,r,n)<0?++a:(--e,s[a]=s[e],s[e]=t)}}const o=a;let l=a,c=t;for(;l<c;){const e=s[c-1];ZC(e,i,r,n)>0?--c:(s[c-1]=s[l],s[l]=e,++l)}return{rangeMidStart:o,rangeMidEnd:c}}(e,r,f,_,t,i),v=o===c-1,b=!v&&g>=e+h,w=!v&&r>=y+h;if(b||w||0===p){const t=new jC(e,g,y,r,f,_,m);if(b&&l(e,g,o+1,p,!0),w&&l(y,r,o+1,p,!1),s.push(t),-1!==u){const e=s[u];d?e.child0=p:e.child1=p}}};for(l(0,e,0,-1,!1);r<o.length;){const e=o[r],t=o[r+1],i=o[r+2],s=o[r+3];r+=4;const n=s>>1;u(e,t,i,n,s-(n<<1)==0)}this._generatedBVH=!0}}function ZC(e,t,i,r){const s=4*e,n=r[s+0+t];return r[s+2+t]<i?-1:n>i?1:0}class jC{constructor(e,t,i,r,s,n,a){this.minIndexIndex=e,this.minMidIndexIndex=t,this.maxMidIndexIndex=i,this.maxIndexIndex=r,this.dim=s,this.d=n,this.aabb2D=a,this.child0=-1,this.child1=-1}}class WC{constructor(e,t,i,r,s,n,a,o,l){this.componentIndex=e,this.vertexData=t,this.vertexStride=i,this.indexData=r,this.startTriangleNumber=s,this.endTriangleNumber=n,this.geometryMinZ=a,this.planetCenterZ=o,this.localMode=l,this.maxBspNodeDepth=8,this.minElementCountForBVH=20,this.minBspNodeElementCount=10,this.rayDirection=(0,O.Ue)(),this.ray0=(0,O.Ue)(),this.isVerticalRay=!1,this._triangleHitCallback=XC,this.totalElevationOffset=0,this.normalRequired=!1,this._bvh=new qC(n-s,this)}getAabbs2D(){return this.localMode?function(e,t,i,r,s){const n=t-e,a=new Float64Array(4*n);for(let t=0;t<n;++t){const n=3*(t+e),o=s*i[n+0],l=r[o+0],c=r[o+1],h=s*i[n+1],u=r[h+0],d=r[h+1],p=s*i[n+2],m=r[p+0],_=r[p+1],f=4*t;a[f+0]=Math.min(l,u,m),a[f+1]=Math.min(c,d,_),a[f+2]=Math.max(l,u,m),a[f+3]=Math.max(c,d,_)}return a}(this.startTriangleNumber,this.endTriangleNumber,this.indexData,this.vertexData,this.vertexStride):function(e,t,i,r,s,n,a){const o=n-a,l=t-e,c=new Float64Array(4*l);for(let t=0;t<l;++t){const n=3*(t+e),l=s*i[n+0],h=r[l+0],u=r[l+1],d=o/(r[l+2]-a),p=h*d,m=u*d,_=s*i[n+1],f=r[_+0],g=r[_+1],y=o/(r[_+2]-a),v=f*y,b=g*y,w=s*i[n+2],C=r[w+0],x=r[w+1],T=o/(r[w+2]-a),S=C*T,M=x*T,E=4*t;c[E+0]=Math.min(p,v,S),c[E+1]=Math.min(m,b,M),c[E+2]=Math.max(p,v,S),c[E+3]=Math.max(m,b,M)}return c}(this.startTriangleNumber,this.endTriangleNumber,this.indexData,this.vertexData,this.vertexStride,this.geometryMinZ,this.planetCenterZ)}get numTriangles(){return this.endTriangleNumber-this.startTriangleNumber}intersectRay(e,t,i,r,s,n){(0,mr.c)(this.ray0,e),(0,mr.a)(this.rayDirection,t,e),this.isVerticalRay=i,this.totalElevationOffset=r,this.normalRequired=n,this._triangleHitCallback=s,this._bvh.intersectRay(e,t,i),this._triangleHitCallback=XC}intersectRange(e,t){const i=this._bvh.elementIndexMap;$C(this.ray0,this.rayDirection,e,t,this.indexData,this.vertexData,this.vertexStride,this.totalElevationOffset,this.planetCenterZ,this.normalRequired,this._triangleHitCallback,i,this.startTriangleNumber)}getTriangleElevationOffset(e){return this.totalElevationOffset}}function $C(e,t,i,r,s,n,a,o,l,c,h,u=null,d=0){0!==o?(0,av.ko)(e,t,i,r,s,n,a,o,l,c,h,u,d):(0,av.ET)(e,t,i,r,s,n,a,c,h,u,d)}function XC(){}function YC(e,t,i){const r=e.count;if(t>=r)return;e.pickability??=new Uint32Array(0);let s=e.pickability;const n=KC(s),a=t/n|0,o=t-n*a,l=(r-1)/n|0,c=s;if(!(t<c.length*n||i)){const t=a+1,i=Math.ceil(c.length*St._x),r=l+1;let n=Math.max(t,i);n=Math.min(n,r),e.pickability=s=new Uint32Array(n),s.set(c)}a<s.length&&(s[a]=function(e,t,i){return e&~(1<<t)|(i?1:0)<<t}(s[a],o,!i))}function QC(e,t){if(null==e)return!0;const i=KC(e);return!(t<e.length*i)||function(e,t,i){const r=t/i|0,s=t-r*i;return!function(e,t){return!!(e&1<<t)}(e[r],s)}(e,t,i)}function KC(e){return 8*e.BYTES_PER_ELEMENT}class JC{constructor(e,t,i,r,s,n,a,o){this.vertexData=e,this.vertexStride=t,this.indexData=i,this._components=r,this._componentAabbs3D=s,this.geometryMinZ=n,this.planetCenterZ=a,this.localMode=o,this.maxBspNodeDepth=6,this.minElementCountForBVH=10,this.minBspNodeElementCount=3,this._ray0=rx,this._ray1=sx,this._invDir=(0,O.Ue)(),this._componentVerticalOffsets=null,this._verticalOffset=null,this._tolerance=0,this._intersectionOptions=ax,this._callback=nx,this.rayDirectionC=(0,O.Ue)(),this._componentIndexMap=null,this._bvh=new qC(r.count,this),this.componentIntersectionData=new Array(r.count)}get numComponents(){return this._components.count}get minZGlobal(){return this.geometryMinZ-this.planetCenterZ}getAabbs2D(){return this.localMode?this.getAabbs2DLocal():this.getAabbs2DGlobal()}getAabbs2DGlobal(){const{numComponents:e,planetCenterZ:t,minZGlobal:i}=this,r=(0,dv.bg)(4*e),s=this._componentAabbs3D;for(let n=0;n<e;++n){const e=6*n,a=s[e+0],o=s[e+1],l=s[e+2],c=s[e+3],h=s[e+4],u=i/(l-t),d=i/(s[e+5]-t),p=Math.min(a*u,a*d),m=Math.min(o*u,o*d),_=Math.max(c*u,c*d),f=Math.max(h*u,h*d),g=4*n;r[g+0]=p,r[g+1]=m,r[g+2]=_,r[g+3]=f}return r}getAabbs2DLocal(){const{numComponents:e}=this,t=(0,dv.bg)(4*e),i=this._componentAabbs3D;for(let r=0;r<e;++r){const e=6*r,s=i[e+0],n=i[e+1],a=i[e+3],o=i[e+4],l=4*r;t[l+0]=s,t[l+1]=n,t[l+2]=a,t[l+3]=o}return t}intersectRay(e,t,i,r,s,n,a){const{isVerticalRay:o}=a;this._ray0=e,this._ray1=t,this._componentVerticalOffsets=i,this._verticalOffset=r,this._tolerance=n,this._intersectionOptions=a,this._componentIndexMap=this._bvh.elementIndexMap,(0,av.Ue)(e,t,this._invDir),this._callback=s,this._bvh.intersectRay(e,t,o),this._callback=nx}intersectRange(e,t){const i=this._componentIndexMap,{pickability:r,visibility:s}=this._components;for(let n=e;n<t;++n){const e=i?i[n]:n;QC(r,e)&&s.isVisible(e)&&this._intersectComponent(e)}}getComponentTriangleCount(e){const t=this._components.offsets,i=t[e]/3;return t[e+1]/3-i}getComponentAabb3D(e,t){const i=this._componentAabbs3D,r=6*e;return t[0]=i[r],t[1]=i[r+1],t[2]=i[r+2],t[3]=i[r+3],t[4]=i[r+4],t[5]=i[r+5],t}_intersectComponent(e){const t=this.getComponentAabb3D(e,ex);let i=!1;const{localMode:r,_componentVerticalOffsets:s,_verticalOffset:n,_ray0:a,_ray1:o,_invDir:l,planetCenterZ:c,_tolerance:h,rayDirectionC:u,componentIntersectionData:d}=this,{isVerticalRay:p}=this._intersectionOptions,m=this._components.offsets,_=(0,mr.c)(tx,a),f=(0,mr.c)(ix,o),g=s?.[e]??0,y=g+(n?.offset??0);if(0!==y&&(r?(_[2]=a[2]-y,f[2]=o[2]-y,i=!0):null!=n&&(n.componentOffset=g)),null==n||i||0===y||n.applyToAabb(t),!(0,av.Tw)(t,_,l,h))return;(0,mr.a)(u,f,_);const v=m[e]/3,b=m[e+1]/3,w=b-v,C=(t,i,r)=>{this._callback(t,i,e,r)},{vertexData:x,vertexStride:T,indexData:S,_intersectionOptions:M}=this,{normalRequired:E}=M;if(w>ox){let t=d[e];null==t&&(t=new WC(e,x,T,S,v,b,this.geometryMinZ,c,r),d[e]=t),t.intersectRay(_,f,p,i?0:y,C,E)}else $C(_,u,v,b,S,x,T,i?0:y,c,E,C)}}const ex=(0,xg.Ue)(),tx=(0,O.Ue)(),ix=(0,O.Ue)(),rx=(0,O.Ue)(),sx=(0,O.Ue)(),nx=()=>{},ax=new av.sT,ox=40;class lx{constructor(e,t,i){this.viewingMode=e,this.positionData=t,this._components=i,this.verticalOffset=null,this.componentVerticalOffsets=null,this._planetCenter=(0,O.Ue)(),this._componentBvh=null,this._aabb=(0,xg.Ue)(),this._indices=t.indices?(0,FC.mi)(t.indices):(0,FC.KF)(t.positions.length/3),this._positions=t.positions}destroy(){this._positions=null,this._indices=null,this._perComponentAabbs=null,this._componentBvh=null}getComponentAabb(e,t){const i=this._ensureComponentAabbs(),r=6*e;return t[0]=i[r],t[1]=i[r+1],t[2]=i[r+2],t[3]=i[r+3],t[4]=i[r+4],t[5]=i[r+5],t}getComponentAabbs(){return this._ensureComponentAabbs()}_ensureComponentAabbs(){return this._perComponentAabbs||(this._perComponentAabbs=this._computePerComponentAabbs()),this._perComponentAabbs}getComponentPositions(e,t){t.indices=this._indices,t.data=this._positions,t.stride=3,t.startIndex=this._components.offsets[e],t.endIndex=this._components.offsets[e+1]}intersect(e,t,i,r,s,n,a,o){this.verticalOffset=r,this.componentVerticalOffsets=s;const{position:l}=n,c=(0,mr.a)(cx,e,l),h=(0,mr.a)(hx,t,l),u=(0,Tr.U_)(ux,n.rotationScale);(0,mr.o)(c,c,u),(0,mr.o)(h,h,u);const d=(0,Tr.p4)(px,u);if(this.viewingMode===Si.JY.Global){const e=this._planetCenter;(0,mr.u)(e,l),(0,mr.o)(e,e,u)}this._intersectComponents(c,h,s,r,((e,t,i,r)=>{o(i,e,r?(0,mr.o)(dx,r,d):null,t)}),i,a)}_computePerComponentAabbs(){const e=this._aabb,t=.5*(e[0]+e[3]),i=.5*(e[1]+e[4]),r=.5*(e[2]+e[5]),s=this._components.count,n=(0,xC.xx)(6*s),a=this._indices,o=this._positions,l=this._components.offsets;let c=0,h=1/0,u=1/0,d=1/0,p=-1/0,m=-1/0,_=-1/0;for(let e=0;e<s;e++){const s=l[e],f=l[e+1];let g=1/0,y=1/0,v=1/0,b=-1/0,w=-1/0,C=-1/0;if(s<f)for(let e=s;e<f;e++){const t=3*a[e],i=o[t],r=o[t+1],s=o[t+2];g=Math.min(g,i),y=Math.min(y,r),v=Math.min(v,s),b=Math.max(b,i),w=Math.max(w,r),C=Math.max(C,s)}else g=t,y=i,v=r,b=t,w=i,C=r;n[c++]=g,n[c++]=y,n[c++]=v,n[c++]=b,n[c++]=w,n[c++]=C,h=Math.min(h,g),u=Math.min(u,y),d=Math.min(d,v),p=Math.max(p,b),m=Math.max(m,w),_=Math.max(_,C)}return this._aabb[0]=h,this._aabb[1]=u,this._aabb[2]=d,this._aabb[3]=p,this._aabb[4]=m,this._aabb[5]=_,n}_intersectComponents(e,t,i,r,s,n,a){let o=this._componentBvh;null==o&&(o=new JC(this._positions,3,this._indices,this._components,this._ensureComponentAabbs(),this.geometryMinZ,this.planetCenterZ,this.localMode),this._componentBvh=o),o.intersectRay(e,t,i,r,s,n,a)}get geometryMinZ(){return this._aabb[2]}get planetCenterZ(){return this._planetCenter[2]}get numTriangles(){return this._indices.length/3}get localMode(){return this.viewingMode===Si.JY.Local}get positions(){return this._positions}get indices(){return this._indices}get aabb(){return this._ensureComponentAabbs(),this._aabb}}const cx=(0,O.Ue)(),hx=(0,O.Ue)(),ux=(0,co.Ue)(),dx=(0,O.Ue)(),px=(0,co.Ue)();class mx{constructor(e,t,i){this.material=e,this.geometry=t,this.meta=i}destroy(){this.material.dispose(),this.geometry.dispose()}}class _x{constructor(e,t,i,r){this.vao=e,this.primitiveType=t,this.parameters=i,this.indexed=r}dispose(){this.vao.dispose()}}function fx(e,t){const i=new Om.P,{eye:r,frustum:s,viewForward:n}=e;t.forAll((e=>{const t=null!=e.offsetObb?e.offsetObb:e.obb,a=(0,mr.e)((0,mr.a)(Ox,t.center,r),n),o=t.projectedRadius(n);if(i.within(a-o)&&i.within(a+o))return;const l=function(e,t){let i=0;for(let r=0;r<Rx;r++){const s=e.intersectPlane(t[r]);if(s>0)return-1;0===s&&(i|=1<<r)}return i}(t,s);if(-1===l)return;if(0===l)return yx.far=a+o,yx.near=a-o,void i.union(yx);const c=gx.pushNew();c.near=a-o,c.far=a+o,c.mask=l,c.object=e}));for(let e=0;e<gx.length;e++){const t=gx.data[e];if(i.within(t.near)&&i.within(t.far))continue;yx.far=t.far,yx.near=1/0;const a=Mx(null!=t.object.offsetObb?t.object.offsetObb:t.object.obb,r,wx,(e=>{let i=Cx;for(let r=0;r<Rx&&e.length>0;r++){if(!(t.mask&1<<r))continue;xx(s[r],e,i);const n=e;e=i,i=n}for(let t=0;t<e.length;t+=3){(0,mr.i)(vx,e.data[t],e.data[t+1],e.data[t+2]);const i=(0,mr.e)((0,mr.a)(vx,vx,r),n);yx.near=Math.min(yx.near,i)}}));0===a&&(yx.near=0),i.union(yx)}return gx.length=0,i}const gx=new ud.Z({allocator:e=>e||{near:1/0,far:-1/0,mask:0,object:null},deallocator:e=>(e.object=null,e)}),yx=new Om.P,vx=(0,O.Ue)(),bx=(0,O.Ue)(),wx=new ud.Z({deallocator:null}),Cx=new ud.Z({deallocator:null});function xx(e,t,i){i.length=0;const r=t.length-3;Tx(vx,t,r);const s=(0,ul.jH)(e,vx);s<=0&&(i.push(vx[0]),i.push(vx[1]),i.push(vx[2]));let n=0,a=s;for(;n<r;n+=3){Tx(bx,t,n);const r=(0,ul.jH)(e,bx);a*r<0&&((0,mr.m)(vx,bx,vx,r/(r-a)),Sx(i,vx)),r<=0&&Sx(i,bx),a=r,(0,mr.c)(vx,bx)}a*s<0&&(Tx(bx,t,r),(0,mr.m)(vx,bx,vx,s/(s-a)),Sx(i,vx))}function Tx(e,t,i){return(0,mr.i)(e,t.data[i],t.data[i+1],t.data[i+2])}function Sx(e,t){e.push(t[0]),e.push(t[1]),e.push(t[2])}function Mx(e,t,i,r){(0,il.Kx)(Ax,e.quaternion),(0,mr.a)(Ox,t,e.center),(0,mr.v)(Ox,Ox,Ax);const s=e.halfSize,n=8*((Ox[0]<-s[0]?-1:Ox[0]>s[0]?1:0)+3*(Ox[1]<-s[1]?-1:Ox[1]>s[1]?1:0)+9*(Ox[2]<-s[2]?-1:Ox[2]>s[2]?1:0)+13),a=Ex[n];if(0===a)return a;(0,Tr.en)(Px,e.quaternion),(0,Tr.bA)(Px,Px,e.halfSize);const o=(t,i)=>{const r=Ex[n+i+1];return(0,mr.i)(t,((1&r)<<1)-1,(2&r)-1,((4&r)>>1)-1),(0,mr.o)(t,t,Px),(0,mr.f)(t,e.center,t)};return i.length=0,Sx(i,o(Dx,0)),Sx(i,o(Ix,1)),Sx(i,o(Ox,2)),Sx(i,o(Lx,3)),r(i),1===a||(i.length=0,Sx(i,Dx),Sx(i,Lx),Sx(i,o(Ox,4)),Sx(i,o(Fx,5)),r(i),2===a||(i.length=0,Sx(i,Dx),Sx(i,Fx),Sx(i,o(Ox,6)),Sx(i,Ix),r(i))),a}const Ex=(()=>{const e=new Array(216);let t=0;const i=i=>{for(let r=0;r<i.length;r++)e[t+r]=i[r];t+=8};return i([3,0,6,2,3,1,5,4]),i([2,0,2,3,1,5,4,0]),i([3,1,0,2,3,7,5,4]),i([2,0,1,3,2,6,4,0]),i([1,0,1,3,2,0,0,0]),i([2,1,5,7,3,2,0,0]),i([3,2,0,1,3,7,6,4]),i([2,2,0,1,3,7,6,0]),i([3,3,0,1,5,7,6,2]),i([2,0,1,5,4,6,2,0]),i([1,0,1,5,4,0,0,0]),i([2,1,3,7,5,4,0,0]),i([1,0,2,6,4,0,0,0]),i([0,0,0,0,0,0,0,0]),i([1,1,3,7,5,0,0,0]),i([2,2,3,7,6,4,0,0]),i([1,2,3,7,6,0,0,0]),i([2,3,1,5,7,6,2,0]),i([3,4,0,1,5,7,6,2]),i([2,5,7,6,4,0,1,0]),i([3,5,0,1,3,7,6,4]),i([2,4,5,7,6,2,0,0]),i([1,4,5,7,6,0,0,0]),i([2,5,1,3,7,6,4,0]),i([3,6,0,2,3,7,5,4]),i([2,6,2,3,7,5,4,0]),i([3,7,6,2,3,1,5,4]),e})(),Rx=4;const Px=(0,co.Ue)(),Ax=(0,rl.Ue)(),Ox=(0,O.Ue)(),Dx=(0,O.Ue)(),Ix=(0,O.Ue)(),Lx=(0,O.Ue)(),Fx=(0,O.Ue)();class Nx{constructor(e){this._objects=e}submit(e,t){this._objects.preSubmit(t),this._objects.visibleObjects.forAll((i=>i.renderable.material.submit(e,t,i)))}queryDepthRange(e){return this._objects.visibleObjects.length?fx(e,this._objects.visibleObjects):null}get hasEmissions(){return this._objects.visibleObjects.some((e=>e.renderable.material.hasEmissions))}hasHighlight(e){return this._objects.hasHighlight(e)}}var Ux=i(91129);class Hx{constructor(){this.externalColor=(0,Uc.Ue)(),this.externalColorMixMode=HC.a9.Multiply,this.castShadows=!0,this.pickable=!0,this.elevationOffset=0}}var Vx=i(44417),kx=i(21184),Bx=i(54998),zx=i(95285),Gx=i(13580),qx=i(57945);const Zx=()=>_.Z.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");class jx{constructor(e,t){this._renderManager=e,this._viewingMode=t,this._elevationRangeCacheVerticalOffset=NaN,this._elevationRangeCacheMin=NaN,this._elevationRangeCacheMax=NaN,this._activeHighlightOptions=new Map,this._visible=new ud.Z,this._hidden=new ud.Z,this._renderSubmit=new Nx(this),this._renderManager.register(this._renderSubmit),this._componentBufferManager=new Gx.g(e.rctx,2+((0,zx.B)()?1:0))}destroy(){(0,R_.hu)(0===this._hidden.length&&0===this._visible.length,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy(),this._visible.forAll((e=>e.destroy())),this._visible.clear(),this._hidden.forAll((e=>e.destroy())),this._hidden.clear()}createObject(e){const t=e.geometry,i=new BC(this._componentBufferManager,(0,FC.mi)(t.componentOffsets)),r=this._createRenderable(e,i),s=new lx(this._viewingMode,t.positionData,i),n=new zC(e.transform,e.toMapSpace,e.obb.clone(),i,r,s);return(n.visible?this._visible:this._hidden).push(n),n}destroyObject(e){const t=e;(t.visible?this._visible:this._hidden).removeUnordered(t),t.destroy(),this._notifyDirty()}setObjectVisibility(e,t){const i=e;t!==i.visible&&(t?(this._hidden.removeUnordered(i),this._visible.push(i)):(this._visible.removeUnordered(i),this._hidden.push(i)),i.visible=t,this._notifyDirty())}preSubmit(e){const t=e.camera.eye;this.visibleObjects.forAll((e=>e.renderable.meta.cameraDepthSquared=(0,mr.s)(t,e.obb.center)))}getMaterial(e){return e.renderable.material}updateMaterial(e,t){const i=e.renderable.material;t(i),i.dirty&&this._notifyDirty()}setAllComponentVisibilities(e,t){const i=e;i.componentData.visibility.reset(t),i.componentData.markVisibilityDirty(),this._notifyDirty()}forEachVisibleComponent(e,t){return e.componentData.visibility.forEachComponent(t)}getComponentCount(e){const t=e,i=t.componentData.visibility.componentCount;return{visible:i,invisible:t.componentData.count-i}}setComponentData(e,t){const i=e,{renderable:r,componentData:s}=i,n=r.material,a=s.materialDataBuffer,o=s.materialDataIndices,l=new Hx,c=a.textureBuffer,h=new Uint8Array(4),u=new Uint32Array(h.buffer);let d=0,p=0,m=0,_=s.verticalOffsets,f=1/0,g=-1/0,y=!1,v=!1,b=0;for(let e=0;e<s.count;e++){t(e,l),d+=+(l.externalColor[3]<1),p+=+(l.externalColorMixMode===HC.a9.Replace&&1===l.externalColor[3]),m+=+l.castShadows,(0,HC.HB)(l.externalColor,l.externalColorMixMode,h),h[2]=254&h[2]|+l.castShadows,c.setData(o[e],0,h[0],h[1],h[2],h[3]),y||=e>0&&b!==u[0],b=u[0],v||=0!==l.elevationOffset,v&&null==_&&(_=new Array(e).fill(0)),null!=_&&(_[e]=l.elevationOffset),f=Math.min(f,l.elevationOffset),g=Math.max(g,l.elevationOffset),(0,Bx.nO)(l.elevationOffset,h),c.setData(o[e],1,h[0],h[1],h[2],h[3]);const i=l.objectAndLayerIdColor;null!=i&&c.setData(o[e],2,i[0],i[1],i[2],i[3]),l.pickable!==QC(s.pickability,e)&&YC(s,e,l.pickable)}s.verticalOffsets=v?_:null,i.offsetObb=v?(0,VC.gI)(i.obb,f,g,this._viewingMode,i.offsetObb??i.obb.clone()):null,y||v||(0,zx.B)()?(n.componentParameters=new Vx.Qu,n.componentParameters.castShadows=$x(m,s.count),n.componentParameters.transparent=$x(d,s.count),n.componentParameters.opaqueOverride=$x(p,s.count),n.componentParameters.texture=c,c.updateTexture()):(n.componentParameters=new Vx.zO,n.componentParameters.castShadows=l.castShadows?Vx.ws.All:Vx.ws.None,n.componentParameters.externalColor=l.externalColor,n.componentParameters.externalColorMixMode=l.externalColorMixMode),this._elevationRangeCacheVerticalOffset=NaN,this._notifyDirty()}getComponentAabb(e,t,i,r=!1){e.intersectionGeometry.getComponentAabb(t,i);const s=e,n=s.componentData.verticalOffsets;if(r||null==n)return i;const a=n[t];if(this._viewingMode===Si.JY.Local||0===a)return i[2]+=a,i[5]+=a,i;const o=(0,fl.iO)(a);return o.localOrigin=s.transform.position,o.applyToAabb(i)}getComponentObb(e){return e.obb}getObjectTransform(e){return e.transform}getComponentPositions(e,t,i){return e.intersectionGeometry.getComponentPositions(t,i)}expandRangeWithComponentObjectElevationRange(e,t,i,r){Number.isNaN(this._elevationRangeCacheVerticalOffset)||this._elevationRangeCacheVerticalOffset!==t||r.expandElevationRangeValues(this._elevationRangeCacheMin,this._elevationRangeCacheMax);const s=e,n=s.componentData,a=n.count,o=n.verticalOffsets,l=s.intersectionGeometry,c=this._viewingMode===Si.JY.Local,h=l.getComponentAabbs(),u=Xx;let d=1/0,p=-1/0;for(let e=0;e<a;e++){const n=6*e,a=o?.[e]??0;let l=1/0,m=-1/0;if(c)l=h[n+2]+a+t,m=h[n+5]+a+t;else{if(u[0]=h[n],u[1]=h[n+1],u[2]=h[n+2],u[3]=h[n+3],u[4]=h[n+4],u[5]=h[n+5],0!==a){const e=(0,fl.iO)(a);e.localOrigin=s.transform.position,e.applyToAabb(u)}const e=Math.max(Math.abs(u[3]),Math.abs(u[0])),o=Math.max(Math.abs(u[4]),Math.abs(u[1])),l=t+u[5]+i;r.expandElevationRangeValues(t+u[2],Math.sqrt(e*e+o*o+l*l)-i)}r.expandElevationRangeValues(l,m),d=Math.min(d,l),p=Math.max(p,m)}this._elevationRangeCacheVerticalOffset=t,this._elevationRangeCacheMin=d,this._elevationRangeCacheMax=p}intersect(e,t,i,r,s,n,a){const o=e,{transform:l,componentData:c,intersectionGeometry:h}=o;return null!=s&&(s.localOrigin=l.position),h.intersect(t,i,r,s,c.verticalOffsets,l,n,a)}addEdges(e,t,i,r,s){const n=e,{indices:a,positions:o}=n.intersectionGeometry,l=n.componentData.offsets;return t.addComponentObject(n,o,a,l,i,r,s)}async extractEdgeInformation(e,t,r){const s=e,n=s.componentData.visibility;if(n.allInvisible()){const{extractComponentsEdgeLocationsLayout:e}=await i.e(20820).then(i.bind(i,20820));return{buffer:e.createBuffer(0),origin:[0,0,0]}}const{indices:a,positions:o}=s.intersectionGeometry,l=s.componentData.offsets,{EdgeInputBufferLayout:c}=await i.e(46551).then(i.bind(i,46551)),h=c.createBuffer(o.length/3);(0,UC.c)(h.position.typedBuffer,o,h.position.typedBufferStride,3),(0,NC.c)(h.position,h.position,s.transform.rotationScale),this._setComponentIndices(h.componentIndex,a,l);const u=h.count,d=this._computeVisibilityIndices(a,n,l,u);return{origin:(0,O.d9)(s.transform.position),buffer:await t.extractComponentsEdgeLocations({indices:d,indicesLength:d.length,skipDeduplicate:!0,data:h,writerSettings:{reducedPrecision:!1,variants:0}},r)}}_setComponentIndices(e,t,i){let r=0;for(let s=0;s<i.length-1;s++){const n=i[s],a=i[s+1];for(let i=n;i<a;i++){const s=t?t[i]:i;e.set(s,r)}r++}}_computeVisibilityIndices(e,t,i,r){if(e&&t.allVisible())return e;let s=0;t.forEachComponentRange(((e,t)=>(s+=i[t]-i[e],!0)));const n=(0,Tg.fU)(e)?2===e?.BYTES_PER_ELEMENT||r<=65536?new Uint16Array(s):new Uint32Array(s):new Array(s);let a=0;return t.forEachComponentRange(((t,r)=>{const s=i[t],o=i[r];for(let t=s;t<o;t++)n[a++]=e?e[t]:t;return!0})),n}addComponentHighlight(e,t,i){const r=e.componentData,s=(0,Mt.s1)(r.componentHighlights,i,(()=>new Uint32Array(r.count+1)));{const e=this._activeHighlightOptions.get(i)??0;this._activeHighlightOptions.set(i,e+1)}0==s[t]++&&(r.markHighlightsDirty(),this._notifyDirty()),s[r.count]++}removeComponentHighlight(e,t,i){const{componentData:r}=e,s=r.componentHighlights.get(i);if(void 0===s)return void Zx().warn("Removing non-existing highlight.");const n=s[t];if(0===n)return void Zx().warn("Removing non-existing highlight.");this._removeActiveHighlight(i);const a=s[r.count];if(n>1)return s[t]=n-1,void(s[r.count]=a-1);s[t]=0,1===a?r.componentHighlights.delete(i):s[r.count]=a-1,r.markHighlightsDirty(),this._notifyDirty()}_removeActiveHighlight(e,t=1){const i=this._activeHighlightOptions.get(e);if(void 0===i)Zx().warn("Removing non-existing highlight.");else{const r=i-t;r<0&&Zx().warn("Removing non-existing highlight."),r<=0?this._activeHighlightOptions.delete(e):this._activeHighlightOptions.set(e,r)}}clearHighlights(e){const{componentData:t}=e,{componentHighlights:i}=t;if(i.size>0){for(const e of i)this._removeActiveHighlight(e[0],e[1][t.count]);i.clear(),t.markHighlightsDirty(),this._notifyDirty()}}hasHighlight(e){return this._activeHighlightOptions.has(e)}getObjectGPUMemoryUsage(e){return e.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._visible}_createRenderable(e,t){const i=this._renderManager.rctx,r=e.geometry,s=r.vertices.layoutParameters,n=us.f.createVertex(i,Ir.l1.STATIC_DRAW,r.vertices.data),a=r.indices?us.f.createIndex(i,Ir.l1.STATIC_DRAW,r.indices):null,o=(0,ss.K)((0,Ux.N)(s)),l=new Uint16Array(r.vertices.count);for(let e=0;e<t.count;e++){const i=t.offsets[e],s=t.offsets[e+1],n=t.materialDataIndices[e];if(null!=r.indices)for(let e=i;e<s;e++)l[r.indices[e]]=n;else for(let e=i;e<s;e++)l[e]=n}const c=us.f.createVertex(i,Ir.l1.STATIC_DRAW,l.buffer),h=new Vx.Un(e.transform,e.toMapSpace),u=new qx.U(i,kx.k,new Map([["data",o],["componentIndices",Wx]]),new Map([["data",n],["componentIndices",c]]),a),d=new _x(u,Ir.MX.TRIANGLES,s,null!=a),p={cameraDepthSquared:.5,gpuMemoryEstimate:n.usedMemory+c.usedMemory+(null!=a?a.usedMemory:0)};return new mx(h,d,p)}_notifyDirty(){this._renderManager.notifyDirty()}}const Wx=(0,ss.K)((0,ns.U$)().u16(Jr.T.COMPONENTINDEX));function $x(e,t){return e===t?Vx.ws.All:0===e?Vx.ws.None:Vx.ws.Some}const Xx=(0,xg.Ue)();class Yx{constructor(e,t,i,r,s){this.rctx=e,this.viewingMode=t,this.stippleTextures=i,this.waterTextures=r,this.markerTextures=s}get spherical(){return this.viewingMode===Si.JY.Global}}class Qx{constructor(e){this.context=e,this._debug=!1,this._precompiling=this._debug?0:1,this._cache=new Vw.r}get precompiling(){return this._precompiling}set precompiling(e){this._precompiling=e,0===e&&this.context.rctx.gl.flush()}get viewingMode(){return this.context.viewingMode}destroy(){this._cache.forAll((e=>e.destroy())),this._cache.clear()}precompile(e,t=Kx){++this.precompiling,this.get(e,t),--this.precompiling}get(e,t=Kx){const i=t.key.code;let r=this._cache.get(e,i);if(null==r){if(0===this._precompiling){let i=`Uncached shader compile in ${(new Error).stack}\n  for configuration\n${t.decode()}`;const r=this._cache.getInner(e);throw r?.size&&(i+="\n\n  cached configurations:\n",i+=Array.from(r.values()).map((e=>t.decode(e.key))).sort().join("\n\n")),console.log(i),new u.Z("shader:uncached-compile",i)}r=new e(this.context,t),this._cache.set(e,i,r)}return r}async reloadAll(){const e=new Array;this._cache.forEach((t=>e.push(async function(e){let t=!0;e.forEach((async e=>{await e.reload(t),t=!1}))}(t)))),await Promise.all(e)}}const Kx=new ob.m;var Jx=i(666);class eT extends Dr.A{constructor(e,t){super(e,t,new Or.J(Jx.b,(()=>i.e(68651).then(i.bind(i,75206)))))}initializePipeline(){return(0,Lr.sm)({colorWrite:Lr.gf})}}class tT extends ob.m{constructor(){super(...arguments),this.bloomStage=Jx.a.Horizontal}}(0,o._)([(0,ob.o)({count:Jx.a.COUNT})],tT.prototype,"bloomStage",void 0);var iT=i(60700);class rT extends Dr.A{constructor(e,t){super(e,t,new Or.J(iT.a,(()=>i.e(43076).then(i.bind(i,43076)))))}initializePipeline(){return(0,Lr.sm)({colorWrite:Lr.gf})}}var sT=i(40673);let nT=class extends cs{constructor(e){super(e),this.consumes={required:[Qr.CM.TRANSPARENT_ENVIRONMENT,"emissive"]},this._blurHorizontalConfiguration=new tT,this._blurVerticalConfiguration=new tT,this._compositionParameters=new iT.B,this._blurParameters=new Jx.B,this._blurScale=3.06,this._bloomResults=new Array}initialize(){this.addHandles([(0,n.YP)((()=>this._updateFogParameters()),(()=>{}),n.tX),(0,n.YP)((()=>this.view.qualitySettings.bloom),(e=>{e?(this._enable(),this.precompile()):this._disable()}),n.tX)])}destroy(){}_updateFogParameters(){const e=this.view.environment.weather;if("sunny"===e.type||"cloudy"===e.type)this._blurParameters.blurRadius=sT.L9[e.type];else{const t="foggy"===e.type?e.fogStrength:e.precipitation;this._blurParameters.blurRadius=(0,jt.t7)(sT.L9.cloudy,sT.L9[e.type],t)}this._compositionParameters.lodFactors=sT.Ml[e.type].far,this._compositionParameters.lodFactorsFront=sT.Ml[e.type].near,this.requestRender(os.Xx.UPDATE)}precompile(){this.techniques.precompile(eT,this._blurHorizontalConfiguration),this._blurVerticalConfiguration.bloomStage=Jx.a.Vertical,this.techniques.precompile(eT,this._blurVerticalConfiguration),this.techniques.precompile(rT)}render(e){const t=e.find((({name:e})=>e===Qr.CM.TRANSPARENT_ENVIRONMENT)),i=t.getAttachment(Ir.Ml)?.attachment;if(!i)return t;const r=this.techniques.get(eT,this._blurHorizontalConfiguration),s=this.techniques.get(eT,this._blurVerticalConfiguration),n=this.techniques.get(rT);if(!r.compiled||!s.compiled||!n.compiled)return this.requestRender(os.Xx.UPDATE),t;const a=t.getTexture(),o=this.fboCache,{fullWidth:l,fullHeight:c}=this.bindParameters.camera,h=this.renderingContext;let u=i,d=l/2,p=c/2;const m=this._blurParameters.blurRadius;for(let e=0;e<5;e++){const t=o.acquire(d,p,"bloomHorizontal",Md.qz.RGBA16FLOAT);this._blurParameters.color=u,this._prepareFBO(t,d,p),h.bindTechnique(r,this.bindParameters,this._blurParameters),h.screen.draw();const i=o.acquire(d,p,"bloomVertical",Md.qz.RGBA16FLOAT);this._blurParameters.color=t.getTexture(),this._prepareFBO(i,d,p),h.bindTechnique(s,this.bindParameters,this._blurParameters),h.screen.draw(),t.release(),this._bloomResults[e]=i,d=Math.ceil(d/2),p=Math.ceil(p/2),u=this._bloomResults[e].getTexture(),this._blurParameters.blurRadius*=this._blurScale}this._blurParameters.blurRadius=m,this._compositionParameters.color=a,this._compositionParameters.emission=i,this._compositionParameters.bloomTexture0=this._bloomResults[0].getTexture(),this._compositionParameters.bloomTexture1=this._bloomResults[1].getTexture(),this._compositionParameters.bloomTexture2=this._bloomResults[2].getTexture(),this._compositionParameters.bloomTexture3=this._bloomResults[3].getTexture(),this._compositionParameters.bloomTexture4=this._bloomResults[4].getTexture();const _=o.acquire(a.descriptor.width,a.descriptor.height,this.produces);return this._prepareFBO(_,l,c),h.bindTechnique(n,this.bindParameters,this._compositionParameters),h.screen.draw(),this._bloomResults.forEach((e=>e.release())),_.attachDepth(t.getAttachment(Ir.Lu)),_.attachColor(t.getAttachment(Ir.Ml),Ir.Ml),_}_prepareFBO(e,t,i){const r=this.renderingContext;r.bindFramebuffer(e.fbo),r.setViewport(0,0,t,i),r.setClearColor(0,0,0,0),r.clear(Ir.Hf.COLOR)}get test(){return{compositionParameters:this._compositionParameters,blurParameters:this._blurParameters,setLodFactors:e=>{this._compositionParameters.lodFactors=(0,sT.Su)(e)}}}};(0,o._)([(0,x.Cb)()],nT.prototype,"consumes",void 0),nT=(0,o._)([(0,S.j)("esri.views.3d.webgl-engine.effects.bloom.BloomRenderNode")],nT);var aT=i(29158);let oT=class extends as.Z{constructor(e){super(e),this.consumes={required:["olid"]},this.produces="olid"}destroy(){}render(e){const t=e.find((({name:e})=>"olid"===e)),i=this.renderingContext;return i.bindFramebuffer(t.fbo),i.clearFramebuffer(Uc.AG,!0,!0),this.view.stage.renderer.renderAllGeometry(Yb.H_.ObjectAndLayerIdColor),i.clear(Ir.Hf.DEPTH|Ir.Hf.STENCIL),this.view.stage.renderer.renderHUD(aT.U.NotOccluded),t}};(0,o._)([(0,x.Cb)()],oT.prototype,"consumes",void 0),(0,o._)([(0,x.Cb)()],oT.prototype,"produces",void 0),oT=(0,o._)([(0,S.j)("esri.views.3d.webgl-engine.effects.geometry.ObjectAndLayerIDRenderNode")],oT);var lT=i(25631),cT=i(38419);let hT=class extends as.Z{constructor(e){super(e),this.consumes={required:[Qr.CM.OCCLUDED]},this.produces=Qr.CM.OCCLUDED,this._blit=new lT.N(e.view.stage.renderView.techniques,cT.J.PremultipliedAlpha)}precompile(){const e=this.view.stage.renderer;e.plugins.plugins.forAll((t=>{e.precompileSlots(t,ew.r.OCCLUDED_GROUND,ew.r.TRANSPARENT_OCCLUDER_MATERIAL),t.material&&e.precompileOccludedSlots(t,dT)}))}render(e){const t=e.find((({name:e})=>e===this.produces));return this._renderOccludedAndTransparentStencil(t),this._renderOccludedComposite(t),t}_renderOccludedAndTransparentStencil(e){const t=this.view.stage.renderer,i=uT;i.clear();for(const e of t.plugins.plugins)e.renderOccludedFlags&Jb.yD.OccludeAndTransparentStencil&&i.push(e);0!==i.length&&(t.renderSlots(i,ew.r.OCCLUDER_MATERIAL),this._renderAndComposite(e,e.getAttachment(Ir.Lu),.5,(()=>t.renderSlots(i,ew.r.TRANSPARENT_OCCLUDER_MATERIAL)),!1,!1),i.clear())}_renderOccludedComposite(e){const t=this.view.stage.renderer,i=uT;i.clear();let r=0;for(const e of t.plugins.plugins){const t=e.renderOccludedFlags&pT;r|=t,t&&i.push(e)}if(!r)return void i.clear();const s=this._getDepthStencilAttachment(e);let n=s.clearStencil;for(const a of dT)r&a&&(this._renderAndComposite(e,s.depth,a===Jb.yD.Opaque?1:.5,(()=>t.renderOccludedSlots(i,a)),!0,n),n=!1);s.release(),i.clear()}_renderAndComposite(e,t,i,r,s,n){const a=this.renderingContext,{width:o,height:l}=e.fbo,c=this.fboCache.acquire(o,l,"tmp color");c.attachDepth(t),a.bindFramebuffer(c.fbo),a.clearFramebuffer(Uc.AG,s,n),r(),c.detachDepth(),this._blit.blend(a,c,e,this.bindParameters,i),c.release()}_getDepthStencilAttachment(e){const{width:t,height:i}=e.fbo;if(!this.view.stage.renderer.occludedRequiresIntegratedMeshStencil){const e=this.fboCache.acquireDepth(Md.qk.DEPTH24_STENCIL8,t,i,"retained stencil");return{depth:e,release:()=>e.release(),clearStencil:!0}}const r=this.fboCache.acquire(t,i,"retained stencil",Md.qk.DEPTH24_STENCIL8);return this.renderingContext.blitFramebuffer(e.fbo,r.fbo,Ir.Hf.STENCIL),{depth:r.getAttachment(Ir.Lu),release:()=>r.release(),clearStencil:!1}}};(0,o._)([(0,x.Cb)()],hT.prototype,"consumes",void 0),(0,o._)([(0,x.Cb)()],hT.prototype,"produces",void 0),hT=(0,o._)([(0,S.j)("esri.views.3d.webgl-engine.effects.geometry.RenderOccludedRenderNode")],hT);const uT=new ud.Z,dT=[Jb.yD.OccludeAndTransparent,Jb.yD.Transparent,Jb.yD.Opaque],pT=dT.reduce(((e,t)=>e|t),Jb.yD.None);var mT=i(41811);class _T extends Dr.A{constructor(e,t){super(e,t,new Or.J(mT.a,(()=>i.e(73034).then(i.bind(i,73034)))))}initializePipeline(){return(0,Lr.sm)({blending:(0,Lr.wK)(Ir.zi.ONE,Ir.zi.ZERO,Ir.zi.ONE_MINUS_SRC_COLOR,Ir.zi.ONE),depthTest:{func:Ir.wb.ALWAYS},colorWrite:Lr.gf})}}var fT=i(79626);class gT extends Yw.o{constructor(){super(...arguments),this.hazeStrength=1}}class yT extends Dr.A{constructor(e,t){super(e,t,new Or.J(fT.H,(()=>i.e(37930).then(i.bind(i,37930)))))}initializePipeline(e){return e.reduced?(0,Lr.sm)({blending:Lr.LW,depthTest:{func:Ir.wb.ALWAYS},colorWrite:Lr.gf}):(0,Lr.sm)({blending:(0,Lr.wK)(Ir.zi.ONE,Ir.zi.ZERO,Ir.zi.ONE_MINUS_SRC_COLOR,Ir.zi.ONE),colorWrite:Lr.gf})}}class vT extends ob.m{constructor(){super(...arguments),this.reduced=!1}}(0,o._)([(0,ob.o)()],vT.prototype,"reduced",void 0);let bT=class extends cs{constructor(e){super(e),this._compositingPassParameters=new mT.H,this._passParameters=new gT,this._hazeConfiguration=new vT,this._vao=null,this.requireGeometryDepth=!0,this._oldAmount=1,this._newAmount=1,this._amount=this._newAmount;const t=e.view.stage.renderView.techniques;t.precompile(yT,new vT);const i=new vT;i.reduced=!0,t.precompile(yT,i),t.precompile(_T)}initialize(){this.addHandles([(0,n.YP)((()=>this.view.environment.atmosphereEnabled),(e=>e?this._enable():this._disable()),n.tX),(0,n.YP)((()=>this.view.stage?.renderer.renderContext.bind.clouds.fadeFactor??1),(e=>this._fade(e)),n.tX),(0,n.YP)((()=>this.view.environment.weather.type),(e=>this._newAmount="rainy"===e?0:1),n.tX),(0,n.YP)((()=>this.view.stage.renderer?.fullResolutionAtmosphere),(e=>this._hazeConfiguration.reduced=!e),n.tX)])}_fade(e){e>=1?(this._amount=this._newAmount,this._oldAmount=this._newAmount):this._amount=e<=0?this._oldAmount:(0,jt.t7)(this._oldAmount,this._newAmount,e)}destroy(){this._vao=(0,f.M2)(this._vao)}render(e){const t=e.find((({name:e})=>e===Qr.CM.TRANSPARENT_ENVIRONMENT));if(!this.bindParameters.mainDepth)return t;const i=this.renderingContext;this._vao??=(0,bb.ow)(i,bb.Ar.Pos2Tex);const r=this.techniques.get(yT,this._hazeConfiguration);if(!r.compiled)return t;const s=t.getAttachment(Ir.Lu);if(this._update(),!this._hazeConfiguration.reduced)return t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(r,this.bindParameters,this._passParameters),this._renderCommon(i),t.attachDepth(s),t;const n=this.techniques.get(_T);if(!n.compiled)return t;const a=i.getViewport(),o=this.camera,l=(0,mr.l)(o.eye)-ir.sv.radius;let c;const h=ir.sv.atmosphereHeight;if(l<h){const e=Math.min(1,Math.max(0,l/h));c=(0,jt.t7)(.4,.5,e)}else{const e=Math.min(1,Math.max(0,(l-h)/(15*h)));c=(0,jt.t7)(.5,1,e)}const u=this.renderingContext.parameters.maxTextureSize,d=(0,hg.nq)(Math.round(c*o.fullViewport[2]),u),p=(0,hg.nq)(Math.round(c*o.fullViewport[3]),u);i.setViewport(0,0,d,p);const m=this.fboCache.acquire(d,p,"haze",Md.qz.RGBA8UNORM);return i.bindFramebuffer(m.fbo),i.clearFramebuffer([0,0,0,1],!0,!0),i.bindTechnique(r,this.bindParameters,this._passParameters),this._renderCommon(i),i.setViewport(a.x,a.y,a.width,a.height),this._compositingPassParameters.color=m.getTexture(),t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(n,this.bindParameters,this._compositingPassParameters),i.screen.draw(),t.attachDepth(s),m.release(),t}_renderCommon(e){null!=this._vao&&(e.bindVAO(this._vao),e.drawArrays(Ir.MX.TRIANGLE_STRIP,0,4))}_update(){const e=this.bindParameters.camera,t=(0,mr.k)(e.eye),i=Math.sqrt(t),r=t-this._passParameters.radii[1]*this._passParameters.radii[1],s=(0,jt.uZ)((i-this._passParameters.radii[0])/ir.sv.atmosphereHeight,0,1);(0,Nc.s)(this._passParameters.heightParameters,i,t,r,s);const n=this.view.basemapTerrain?.getLowerBoundRadius()??0;(0,Er.t8)(this._passParameters.radii,n,n+ir.sv.atmosphereHeight),this._passParameters.hazeStrength=(0,jt.t7)((0,jt.t7)(.6,1,(0,jt.CW)(9500,10500,i-ir.sv.radius)),1,this._amount)}};bT=(0,o._)([(0,S.j)("esri.views.3d.webgl-engine.effects.haze.Haze")],bT);var wT=i(35285),CT=i(36351),xT=i(49790);class TT extends CT.nj{constructor(){super(...arguments),this.shadowColor=(0,Uc.al)(1,0,1,1),this.shadowOpacity=.2,this.occludedShadowOpacity=.1,this.opacityElevation=1,this.dayNightTerminator=1}}class ST extends Dr.A{constructor(e,t){super(e,t,new Or.J(xT.S,(()=>i.e(44634).then(i.bind(i,44634))))),this.primitiveType=Ir.MX.TRIANGLE_STRIP}initializePipeline(){return(0,Lr.sm)({blending:Lr.vf,colorWrite:Lr.gf,depthTest:null,depthWrite:null})}}let MT=class extends as.Z{constructor(e){super(e),this.produces=Qr.lu.COMPOSITE,this.consumes={required:[Qr.lu.COMPOSITE,"highlights"]},this._passParameters=new TT,this._maxOpacity=1,this._shadowDifference=.2}initialize(){this.addHandles([(0,n.YP)((()=>this.view.highlightOptions.shadowOpacity),(e=>{this._passParameters.shadowOpacity=e??si.CN,this._updateOccludedShadowOpacity(),this._ensureMaxOpacity()}),n.tX),(0,n.YP)((()=>this.view.highlightOptions.shadowDifference),(e=>{this._shadowDifference=e??si.oH,this._updateOccludedShadowOpacity(),this._ensureMaxOpacity()}),n.tX),(0,n.YP)((()=>this.view.highlightOptions.shadowColor),(e=>{this._passParameters.shadowColor=(0,$w.O)(e??si.NU),this._ensureMaxOpacity()}),n.tX)])}_updateOccludedShadowOpacity(){this._passParameters.occludedShadowOpacity=this._passParameters.shadowOpacity*(1-this._shadowDifference)}_ensureMaxOpacity(){const e=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=e*this._passParameters.shadowColor[3],this.requestRender(os.Xx.UPDATE)}precompile(){this.techniques.precompile(ST)}render(e){const t=e.find((({name:e})=>e===Qr.lu.COMPOSITE)),i=this.bindParameters;if(!i.shadowHighlightsVisible||!i.depth||!this._ensureIfVisible(i.camera,i.lighting.mainLight.direction))return t;const r=this.techniques.get(ST);if(r.compiled){this._passParameters.highlightTexture=e.find((({name:e})=>"highlights"===e))?.getTexture(),this._passParameters.origin=i.camera.center;const s=this.renderingContext;s.bindFramebuffer(t.fbo),s.bindTechnique(r,i,this._passParameters),s.screen.draw()}else this.requestRender(os.Xx.UPDATE);return t}_ensureIfVisible(e,t){this._passParameters.opacityElevation=1-(0,jt.CW)(4e4,5e4,e.relativeElevation);const i=this.viewingMode===Si.JY.Global?(0,mr.n)(ET,e.center):(0,mr.i)(ET,0,0,1),r=(0,mr.e)(i,t);return this._passParameters.dayNightTerminator=(0,jt.CW)(0,1,(0,jt.uZ)(30*r,0,1)),this._maxOpacity*this._passParameters.opacityElevation*this._passParameters.dayNightTerminator>=.001953125}};(0,o._)([(0,x.Cb)()],MT.prototype,"produces",void 0),(0,o._)([(0,x.Cb)()],MT.prototype,"consumes",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],MT.prototype,"viewingMode",void 0),MT=(0,o._)([(0,S.j)("esri.views.3d.webgl-engine.effects.highlight.ShadowHighlight")],MT);const ET=(0,O.Ue)();var RT=i(51880),PT=i(87619);class AT extends Dr.A{constructor(e,t){super(e,t,new Or.J(PT.a,(()=>i.e(14941).then(i.bind(i,14941)))))}initializePipeline(){return(0,Lr.sm)({blending:Lr.Zo,depthTest:null,depthWrite:null,colorWrite:Lr.gf})}}let OT=class extends as.Z{constructor(){super(...arguments),this.produces=Qr.CM.MAGNIFIER,this.consumes={required:[Qr.CM.MAGNIFIER]},this._imageSources=null,this._imageLoadTask=null,this._passParameters=new PT.M,this._vao=null,this._magnifier=null,this._tmpScreenPoint=(0,b.s1)(),this._tmpRenderPoint=(0,b.gX)()}initialize(){this.addHandles([(0,n.YP)((()=>this.view.magnifier),(e=>this._update(e)),n.tX)])}_update(e){if(e===this._magnifier)return;this.removeAllHandles(),this._magnifier=e;const t=()=>{const e=this._validMagnifier;e?(this._loadResources(e),this.produces=Qr.CM.MAGNIFIER):this.produces="disabled",this.requestRender()};this._magnifier&&this.addHandles((0,n.YP)((()=>this._magnifier?.version),t)),t()}get _validMagnifier(){return this._magnifier?.visible&&this._magnifier?.position&&this._magnifier?.size>0?this._magnifier:null}get _factor(){return this._magnifier?.factor||1}destroy(){this._magnifier=null,null!=this._imageLoadTask&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeTextures(),this._vao=(0,f.M2)(this._vao)}_disposeTextures(){this._passParameters.mask=(0,f.M2)(this._passParameters.mask),this._passParameters.overlay=(0,f.M2)(this._passParameters.overlay),this._passParameters.input=(0,f.M2)(this._passParameters.input)}precompile(){this._imageSources&&this.techniques.precompile(AT)}render(e){const t=this._validMagnifier,i=e.find((({name:e})=>e===Qr.CM.MAGNIFIER));if(null==t)return i;if(null==this._imageSources)return this.requestRender(os.Xx.UPDATE),i;const r=this.renderingContext,s=this.camera.pixelRatio,n=Math.ceil(s*t.size);this._vao??=(0,bb.ow)(r,bb.Ar.Pos2,Ed.i,0,1);const a=this.techniques.get(AT);if(this._ensureTextureResources(r,n),!a.compiled||!this._passParameters.input)return this.requestRender(os.Xx.UPDATE),i;const o=Math.ceil(1/this._factor*n),l=this._passParameters.input;l.resize(o,o),(0,b.md)(t.position,this._tmpScreenPoint);const c=this.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),h=this.camera.fullWidth,u=this.camera.fullHeight,d=.5*o,p=.5*o;c[0]=(0,jt.uZ)(c[0],d,h-d-1),c[1]=(0,jt.uZ)(c[1],p,u-p-1);const m=Math.floor(c[0]-d),_=Math.floor(c[1]-p);return r.bindFramebuffer(i.fbo),a.program.bindTexture("textureInput",l),r.gl.copyTexImage2D(l.descriptor.target,0,l.descriptor.pixelFormat,m,_,o,o,0),this._passParameters.magnifier=t,r.bindTechnique(a,this.bindParameters,this._passParameters),r.bindVAO(this._vao),r.drawArrays(Ir.MX.TRIANGLE_STRIP,0,4),i}_loadResources(e){const{maskUrl:t,overlayUrl:r}=e;this._imageLoadTask?.maskUrl===t&&this._imageLoadTask?.overlayUrl===r||(this._imageLoadTask?.task.abort(),this._imageLoadTask=this._imageSources=null),this._imageSources||this._imageLoadTask||(this._imageLoadTask={maskUrl:t,overlayUrl:r,task:(0,me.vr)((async e=>{const s=null==t||null==r?async function(e){const t=i.e(83774).then(i.bind(i,83774)),r=i.e(41064).then(i.bind(i,41064)),s=(0,RT.t)((await t).default,{signal:e}),n=(0,RT.t)((await r).default,{signal:e}),a={mask:await s,overlay:await n};return(0,y.k_)(e),a}(e):null,n=null!=t?(0,RT.t)(t,{signal:e}):s.then((e=>e.mask)),a=null!=r?(0,RT.t)(r,{signal:e}):s.then((e=>e.overlay));this._imageSources={mask:await n,overlay:await a}}))})}_ensureTextureResources(e,t){null==this._imageSources||this._passParameters.size===t&&this._passParameters.input&&this._passParameters.mask&&this._passParameters.overlay||(this._disposeTextures(),this._imageSources.overlay.width=this._imageSources.mask.width=t,this._imageSources.overlay.height=this._imageSources.mask.height=t,this._passParameters.overlay=new Pd.x(e,this._createTextureDescriptor(t,Ir.VI.RGBA,this._imageSources.overlay),this._imageSources.overlay),this._passParameters.mask=new Pd.x(e,this._createTextureDescriptor(t,Ir.VI.ALPHA,this._imageSources.mask),this._imageSources.mask),this._passParameters.input=new Pd.x(e,this._createTextureDescriptor(t,Ir.VI.RGBA,null)))}_createTextureDescriptor(e,t,i){const r=this.renderingContext,s=new Br.X(e,e);return s.pixelFormat=s.internalFormat=t,s.wrapMode=Ir.e8.CLAMP_TO_EDGE,s.flipped=!!i,s.preMultiplyAlpha=!(t!==Ir.VI.RGBA||!i||(0,X_.zd)(i.src)&&r.driverTest.svgPremultipliesAlpha.result),s}};(0,o._)([(0,x.Cb)()],OT.prototype,"produces",void 0),(0,o._)([(0,x.Cb)()],OT.prototype,"consumes",void 0),(0,o._)([(0,x.Cb)()],OT.prototype,"_imageSources",void 0),(0,o._)([(0,x.Cb)()],OT.prototype,"_imageLoadTask",void 0),OT=(0,o._)([(0,S.j)("esri.views.3d.webgl-engine.effects.magnifier.Magnifier")],OT);var DT=i(5918);class IT extends Dr.A{constructor(e,t){super(e,t,new Or.J(DT.B,(()=>i.e(11798).then(i.bind(i,11798)))))}initializePipeline(){return(0,Lr.sm)({colorWrite:Lr.gf})}}var LT=i(57088);class FT extends Dr.A{constructor(e,t){super(e,t,new Or.J(LT.B,(()=>i.e(4e4).then(i.bind(i,4e4)))))}initializePipeline(){return(0,Lr.sm)({colorWrite:Lr.gf})}}var NT=i(47935);class UT extends Dr.A{constructor(e,t){super(e,t,new Or.J(NT.E,(()=>i.e(55428).then(i.bind(i,55428)))))}initializePipeline(){return(0,Lr.sm)({colorWrite:Lr.gf})}}class HT extends es.K{}let VT=class extends as.Z{constructor(e){super(e),this.produces="disabled",this.consumes={required:[Qr.CM.ANTIALIASING],optional:[Qr.lu.COMPOSITE]},this._areaTexture=null,this._searchTexture=null,this._smaaParameters=new HT}initialize(){this.addHandles([(0,n.YP)((()=>this.isEnabled()),(e=>e?this.enable():this.disable()),n.tX)])}async enable(){if(this.produces=Qr.CM.ANTIALIASING,this._abortController||this._areaTexture&&this._searchTexture)return;this._abortController=new AbortController;const e=this._abortController.signal;try{const t=await i.e(49609).then(i.bind(i,34318));await this._loadTextures(t,e),this.requestRender(os.Xx.UPDATE)}catch{}this._abortController=null}async _loadTextures(e,t){(0,y.k_)(t);const[i,r]=await Promise.allSettled([(0,RT.t)(e.areaTexture,{signal:t}),(0,RT.t)(e.searchTexure,{signal:t})]);if((0,y.k_)(t),"fulfilled"!==i.status||"fulfilled"!==r.status)return;const s=this.renderingContext;this._areaTexture=kT(s,Ir.cw.LINEAR,Ir.VI.RGB,i.value),this._searchTexture=kT(s,Ir.cw.NEAREST,Ir.VI.LUMINANCE,r.value)}disable(){this.produces="disabled"}destroy(){this._searchTexture=(0,f.M2)(this._searchTexture),this._areaTexture=(0,f.M2)(this._areaTexture)}precompile(){this.techniques.precompile(UT),this.techniques.precompile(IT),this.techniques.precompile(FT)}render(e){const t=e.find((({name:e})=>e===Qr.CM.ANTIALIASING));if(!this._areaTexture||!this._searchTexture)return this.requestRender(os.Xx.UPDATE),t;const i=this.techniques.get(UT),r=this.techniques.get(IT),s=this.techniques.get(FT);if(!i.compiled||!r.compiled||!s.compiled)return this.requestRender(os.Xx.UPDATE),t;const n=e.find((({name:e})=>e===Qr.lu.COMPOSITE));if(!n)return t;const a=n.fbo.width,o=n.fbo.height,l=this.renderingContext;l.setViewport(0,0,a,o);const c=this.fboCache.acquire(a,o,"smaa edges",Md.qz.RG8UNORM);l.bindFramebuffer(c.fbo),l.setClearColor(0,0,0,1),l.clear(Ir.Hf.COLOR),this._smaaParameters.color=n.getTexture();const h=this.bindParameters;l.bindTechnique(i,h,this._smaaParameters),l.screen.draw();const u=this.fboCache.acquire(a,o,"smaa blend");return l.bindFramebuffer(u.fbo),l.setClearColor(0,0,1,1),l.clear(Ir.Hf.COLOR),this._smaaParameters.inputTexture=c.getTexture(),this._smaaParameters.areaTexture=this._areaTexture,this._smaaParameters.searchTexture=this._searchTexture,l.bindTechnique(r,h,this._smaaParameters),l.screen.draw(),c.release(),l.bindFramebuffer(t.fbo),l.setClearColor(0,1,0,1),l.clear(Ir.Hf.COLOR),this._smaaParameters.inputTexture=u.getTexture(),l.bindTechnique(s,h,this._smaaParameters),l.screen.draw(),u.release(),t}};function kT(e,t,i,r){const s=new Br.X;return s.pixelFormat=i,s.wrapMode=Ir.e8.CLAMP_TO_EDGE,s.width=r.width,s.height=r.height,s.samplingMode=t,new Pd.x(e,s,r)}(0,o._)([(0,x.Cb)()],VT.prototype,"produces",void 0),(0,o._)([(0,x.Cb)()],VT.prototype,"consumes",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],VT.prototype,"isEnabled",void 0),(0,o._)([(0,x.Cb)()],VT.prototype,"_abortController",void 0),VT=(0,o._)([(0,S.j)("esri.views.3d.webgl-engine.effects.smaa.SMAA")],VT);var BT=i(46959),zT=i(1800),GT=i(92515);class qT extends es.K{constructor(){super(...arguments),this.modelMatrix=(0,Mr.Ue)()}}class ZT extends Dr.A{constructor(e,t){super(e,t,new Or.J(GT.S,(()=>i.e(3466).then(i.bind(i,3466)))))}initializePipeline(){return(0,Lr.sm)({blending:Lr.vf,depthTest:{func:Ir.wb.LEQUAL},colorWrite:Lr.gf})}}let jT=class extends ls{constructor(){super(...arguments),this._starData=null,this._loadDataTask=null,this._numPoints=0,this._passParameters=new qT}initialize(){this.addHandles([(0,n.YP)((()=>this.view.environment.starsEnabled),(e=>e?this._enable():this._disable()),n.nn),(0,n.YP)((()=>"virtual"===this.view.environment.lighting.type?null:this.view.environment.lighting.date),(e=>this._update(e)),n.tX)])}_enable(){super._enable(),this._loadDataTask=this._createLoadDataTask()}get loading(){return!!this._loadDataTask&&!this._loadDataTask.finished}destroy(){this._loadDataTask=(0,f.IM)(this._loadDataTask),this._numPoints=0,this._vao=(0,f.M2)(this._vao),this._starData=null}precompile(){this.techniques.precompile(ZT)}render(e){const t=e.find((({name:e})=>e===Qr.CM.OPAQUE_ENVIRONMENT)),i=this.renderingContext;if(this.loading)return this.requestRender(os.Xx.UPDATE),t;if(!this._starData)return t;this._vao??=this._ensureResources(this._starData,i);const r=this.techniques.get(ZT);return r.compiled?(i.bindTechnique(r,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(Ir.MX.POINTS,0,this._numPoints),t):(this.requestRender(os.Xx.UPDATE),t)}_ensureResources(e,t){return this._numPoints=e.byteLength/KT,function(e,t,i,r){const s=JT.createBuffer(r),n=s.position,a=s.color,o=s.size;for(let e=0;e<r;e++){const r=t[2*e],s=t[2*e+1];n.set(e,0,-Math.cos(r)*Math.sin(s)),n.set(e,1,-Math.sin(r)*Math.sin(s)),n.set(e,2,-Math.cos(s));const l=$T(i[e]),c=WT(XT[l[1]]);a.set(e,0,255*c[0]),a.set(e,1,255*c[1]),a.set(e,2,255*c[2]),a.set(e,3,255),o.set(e,l[0])}return new hs.U(e,Ed.i,new Map([["geometry",(0,ss.K)(JT)]]),new Map([["geometry",us.f.createVertex(e,Ir.l1.STATIC_DRAW,s.buffer)]]))}(t,new Float32Array(e,0,2*this._numPoints),new Uint8Array(e,2*this._numPoints*4,this._numPoints),this._numPoints)}_update(e){if(!e)return;const t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,i=2*function(e){const t=e,i=new Date(e.getFullYear(),0,1,11,58,56);return(+t-+i)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+i)}(e),r=(0,Sr.JG)(this._passParameters.modelMatrix,QT);(0,Sr.jI)(r,r,-i*Math.PI),(0,Sr.Jp)(r,YT,r),(0,Sr.jI)(r,r,-t*Math.PI),this.requestRender(os.Xx.UPDATE)}_createLoadDataTask(){if(this._starData)return null;const e=(0,me.vr)((async e=>{const{data:t}=await(0,zT.b)("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:e});(function(e){if(!e)throw new u.Z("stars:no-data-received","Failed to create stars because star catalogue is missing");const t=e.byteLength/KT;if(t%1!=0||t>5e4||t<5e3)throw new u.Z("stars:invalid-data","Failed to create stars because star catalogue data is invalid")})(t),this._starData=t}));return e.promise.catch((e=>{(0,y.D_)(e)||_.Z.getLogger(this).error(e)})).then((()=>{this.destroyed||this.requestRender(os.Xx.UPDATE)})),e}};function WT(e){return[parseInt(e.slice(0,2),16),parseInt(e.slice(2,4),16),parseInt(e.slice(4,6),16)]}function $T(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]}jT=(0,o._)([(0,S.j)("esri.views.3d.webgl-engine.effects.stars.Stars")],jT);const XT=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],YT=(0,Mr.al)(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),QT=(0,Mr.al)(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),KT=9,JT=(0,ns.U$)().vec3f(Jr.T.POSITION).vec4u8(Jr.T.COLOR).f32(Jr.T.SIZE);var eS=i(65562),tS=i(25906),iS=i(93223);class rS extends Dr.A{constructor(e,t){super(e,t,new Or.J(iS.a,(()=>i.e(74498).then(i.bind(i,74498)))))}initializePipeline(){return(0,Lr.sm)({colorWrite:{r:!1,g:!0,b:!1,a:!1}})}}class sS{constructor(e,t){this._rctx=e,this._techniques=t,this._configuration=new cT.Z,this._passParameters=new eS.C,this._hudParameters=new iS.H,this._configuration.blitMode=cT.J.PremultipliedAlpha,this._techniques.precompile(tS.l,this._configuration),this._configuration.hasOpacityFactor=!0,this._techniques.precompile(tS.l,this._configuration),this._configuration.hasOpacityFactor=!1,this._configuration.blitMode=cT.J.Alpha,this._techniques.precompile(tS.l,this._configuration),this._configuration.blitMode=cT.J.Depth,this._techniques.precompile(tS.l,this._configuration),this._techniques.precompile(rS)}compositeHUD(e,t){this._hudParameters.texture=t;const i=this._techniques.get(rS);this._rctx.bindTechnique(i,e,this._hudParameters),this._rctx.screen.draw()}compositePreMultipliedAlpha(e,t,i=1){this._composite(e,t,cT.J.PremultipliedAlpha,i)}composite(e,t){this._composite(e,t,cT.J.Alpha,1)}blitDepthToLinearDepth(e,t){this._composite(e,t,cT.J.Depth,1)}_composite(e,t,i,r){this._configuration.blitMode=i,this._configuration.hasOpacityFactor=1!==r,this._passParameters.texture=t,this._passParameters.opacity=r;const s=this._techniques.get(tS.l,this._configuration);this._rctx.bindTechnique(s,e,this._passParameters),this._rctx.screen.draw()}}var nS=i(86236);class aS{constructor(){this.declaredClass="esri.views.3d.webgl-engine.lib.ObjectAndLayerIdRenderHelper",this.colorZero=new Cv.mc(new ArrayBuffer(4)),this._layerToOidToColor=new Vw.r,this._colorToUID=new Map,this._layerViewUidToGraphicsUidToObjectId=new Vw.r,this._layerViewUidToLayerId=new Map,this._layerViewUidToPopupEnabled=new Map}setUidToObjectAndLayerId(e,t,i,r,s,n=null,a=null,o=null){e&&t&&i&&r&&(this._layerViewUidToLayerId.set(r,i),this._layerViewUidToPopupEnabled.set(r,s),s&&this._layerViewUidToGraphicsUidToObjectId.set(r,t,{objectId:e,attributeNodeId:n,attributeIndex:a,subLayerId:o}))}getObjectAndLayerIdColor(e){const t=this.getObjectAndLayerIdColorArray(e);return(0,Uc.al)(t.get(0,1),t.get(0,2),t.get(0,3),255)}getObjectAndLayerIdColorArray(e){if(!e.layerViewUid||!e.graphicUid)return this.colorZero;const t=this._layerViewUidToPopupEnabled.get(e.layerViewUid);if(void 0===t)return this.colorZero;if(!1===t)return this.colorZero;const i=this._layerViewUidToGraphicsUidToObjectId.get(e.layerViewUid,e.graphicUid)?.objectId;if(!i)return this.colorZero;let r=this._layerToOidToColor.get(e.layerViewUid,i);if(!r){if((0,m.Z)("enable-feature:objectAndLayerId-screenshot-testing"))r=i;else for(;!r;){const e=Math.floor(16777214*Math.random())+1;this._colorToUID.has(e)||(r=e)}if(r>16777215)throw new Error("Object ID Overflow");this._layerToOidToColor.set(e.layerViewUid,i,r),this._colorToUID.set(r,e)}const s=new ArrayBuffer(4);return new DataView(s).setUint32(0,r,!1),new Cv.mc(s)}getColorToObjectAndLayerIdMapping(){const e=new Map;for(const[t,i]of this._colorToUID.entries()){const r=this._layerViewUidToGraphicsUidToObjectId.get(i.layerViewUid,i.graphicUid),s=this._layerViewUidToLayerId.get(i.layerViewUid);r&&s&&e.set(t,r.attributeNodeId?{type:"object-and-layer-and-i3s-id",olid:r.objectId,lid:s,attrId:r.attributeNodeId,attrIdx:r.attributeIndex,subLayerId:r.subLayerId}:{type:"object-and-layer-id",olid:r.objectId,lid:s})}return e}}var oS,lS=i(43280);class cS{constructor(e,t){this.key=e,this._free=t,this.incarnation=0,this._refCount=1}retain(e=1){this._refCount+=e}release(){return 0===this._refCount?(console.log(`Releasing already released FBO attachment "${this.name}" in ${(new Error).stack}`),!0):(--this._refCount,0===this._refCount&&(this._free(),!0))}}!function(e){e[e.FBO=0]="FBO",e[e.DEPTH=1]="DEPTH",e[e.COLOR=2]="COLOR"}(oS||(oS={}));class hS extends cS{constructor(e,t,i){super(e,i),this.attachment=t,this.name=""}dispose(){this.attachment.dispose()}get cachedMemory(){return this.attachment.usedMemory}}class uS extends hS{constructor(e,t,i){super(e,t,i),this.attachment=t,this.type=oS.COLOR}}class dS extends hS{constructor(){super(...arguments),this.type=oS.DEPTH}}var pS=i(29870);class mS extends dS{constructor(e,t,i){super(e,t,i),this.attachment=t}}class _S extends cS{constructor(e,t,i,r,s,n){super(e,n),this.fbo=i,this.type=oS.FBO,this._colors=new Map,this._name=Qr.lu.COMPOSITE,this.acquireColor=null,this.acquireDepth=null,this._name=t,this.acquireColor=r,this.acquireDepth=s}dispose(){this.fbo?.dispose()}get cachedMemory(){return this.fbo?.usedMemory||0}get numberOfColorAttachments(){return this._colors.size}get name(){return this._name}setName(e){this._name=e}getTexture(e=Ir.Ii){return e===Ir.Lu?this.fbo?.depthStencilTexture:this.fbo?.getColorTexture(e)}get depthTexture(){return this.getTexture(Ir.Lu)}getAttachment(e=Ir.Ii){return e===Ir.Lu?this._depth:this._colors.get(e)}hasAttachment(e){return(0,Mt.oE)(this._colors,(t=>t.name===e))}attachDepth(e){return e?.retain(),this.detachDepth(),e&&this.fbo?.attachDepthStencil(e.attachment),this._depth=e,this}detachDepth(){this.fbo?.detachDepthStencilTexture(),this.fbo?.detachDepthStencilBuffer(),this._depth=(0,f.RY)(this._depth)}obtainDepthTexture(){const e=this._depth;return function(e){return e?.attachment.type===pS.R.Texture}(e)?(this.fbo?.detachDepthStencilTexture(),this._depth=null,e):null}attachColor(e,t){return e.retain(),this.detachColor(t),this.fbo?.attachColorTexture(e.attachment,t),this._colors.set(t,e),this}detachColor(e){this.fbo?.detachColorTexture(e);const t=this._colors.get(e);this._colors.delete(e),t?.release()}detachAllColors(){this._colors.forEach(((e,t)=>this.detachColor(t)))}detachAll(){this.detachAllColors(),this.detachDepth()}detachAllColorsBut0(){this._colors.forEach(((e,t)=>{t!==Ir.Ii&&this.detachColor(t)}))}detachAllButColor0(){this.detachAllColorsBut0(),this.detachDepth()}}class fS{constructor(e,t){this._last=new ud.Z,this._incarnation=0,this._cache=new zf(e,t)}destroy(){this._last?.forAll((e=>e.dispose())),this._last=null,this._cache.destroy()}set interactive(e){e&&!this._last?this._last=new ud.Z:e||(this._last?.forAll((e=>e.dispose())),this._last=null)}clean(){this._last?.filterInPlace((e=>!(e.incarnation<this._incarnation&&(this._cache.put(e.key,e),1))))}frame(){++this._incarnation}pop(e){if(this._last){const t=this._last.find((t=>t.key===e));if(t)return this._last.removeUnordered(t),t}return this._cache.pop(e)}put(e){e.incarnation=this._incarnation,this._last?this._last.push(e):this._cache.put(e.key,e)}get usedMemory(){return this._last?.reduce(((e,t)=>e+t.cachedMemory),0)??0}}class gS{constructor(e){this.rctx=e,this._interactive=!1,this._acquired=new Set,this._cache=new fS(e.newCache,"FBOCache"),this._depthCache=new fS(e.newCache,"DepthAttachmentCache"),this._colorCache=new fS(e.newCache,"ColorAttachmentCache")}destroy(){this._cache.destroy(),this._depthCache.destroy(),this._colorCache.destroy()}clean(){this._cache.clean(),this._colorCache.clean(),this._depthCache.clean()}frameStart(){this._cache.frame(),this._colorCache.frame(),this._depthCache.frame(),this.debugCallback?.()}frameEnd(){const{debugCallback:e}=this;e&&this._acquired.forEach((t=>e(t.name,t.fbo)))}get usedMemory(){return Array.from(this._acquired.values()).reduce(((e,t)=>e+t.cachedMemory),this._cache.usedMemory+this._colorCache.usedMemory+this._depthCache.usedMemory)}set interactive(e){this._cache.interactive=this._colorCache.interactive=this._depthCache.interactive=e,this._interactive=e}get interactive(){return this._interactive}acquire(e,t,i,r=Md.qz.RGBA8UNORM){const s=wS(r,e,t);let n=this._cache.pop(s);const{rctx:a}=this;if(n){n.retain(),n.setName(i);const e=n.getAttachment(Ir.Lu);e&&(e.name=vS(i));const t=n.getAttachment(Ir.Ii);t&&(t.name=yS(i,0));const{fbo:r}=n;if(!r)throw new u.Z("renderer","attempt to use a none existing framebuffer");a.temporaryBindFramebufferObject(r,(()=>{a.setDrawBuffers([Ir.Ii]),a.unbindTexture(r.colorTexture)}))}else{const o=new kr.X(a),l=(i,r,s)=>{r??=Md.qz.RGBA8UNORM;const a=this._acquireColor(r,e,t,s??yS(n.name,i-Ir.Ii));return this.rctx.unbindTexture(a.attachment),n.attachColor(a,i),a.release(),n},c=i=>{i??=Md.qk.DEPTH24_STENCIL8;const r=this.acquireDepth(i,e,t,vS(n.name));return n.attachDepth(r),r.release(),n},h=()=>{this.debugCallback?.(n.name,n.fbo),this._acquired.delete(n);const e=(0,Md.NY)(r);e&&null!=n?.getAttachment(Ir.Lu)||!e&&null!=n?.getAttachment(Ir.Ii)?(e?(n.fbo?.invalidateAttachments([Ir.Lu]),n.detachAllColors()):(n.fbo?.invalidateAttachments([Ir.Ii]),n.detachAllButColor0()),this._cache.put(n)):n?.dispose()};n=new _S(s,i,o,l,c,h),(0,Md.NY)(r)?n.acquireDepth(r):n.acquireColor(Ir.Ii,r,i)}return this._trackHandle(n)}acquireDepth(e,t,i,r){const s=wS(e,t,i);let n=this._depthCache.pop(s);if(n)n.retain(),n.attachment.setShadowFiltering(!1);else{const r=new Pd.x(this.rctx,{...Md.gg[e],width:t,height:i});n=new mS(s,r,(()=>this._depthCache.put(n)))}return n.name=r,n}_acquireColor(e,t,i,r){const s=wS(e,t,i);let n=this._colorCache.pop(s);if(n)n.retain();else{const r=new Pd.x(this.rctx,{...Md.cc[e],width:t,height:i});n=new uS(s,r,(()=>this._colorCache.put(n)))}return n.name=r,n}_trackHandle(e){return this._acquired.add(e),e}}function yS(e,t=0){return`${e}.color${t}`}function vS(e){return`${e}.depth`}const bS=new _S("default","default",null,(()=>bS),(()=>bS),(()=>{}));function wS(e,t,i){return`${t}x${i}:${e}`}bS.release=()=>!1;var CS,xS=i(74222),TS=i(33610);!function(e){e[e.FrontToBack=0]="FrontToBack",e[e.BackToFront=1]="BackToFront"}(CS||(CS={}));class SS{constructor(e,t,i=CS.FrontToBack){this._rctx=e,this._techniques=t,this._sorting=i,this._draws=new ud.Z({allocator:e=>e??{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._previouslyBoundDraw=new Map}submitDraw(e,t,i,r,s){const n=this._draws.pushNew();n.geometry=t,n.geometryRanges=i,n.material=e,n.depthSquaredHint=r,n.indexType=(t.indexed?t.vao.indexBuffer.indexType:null)??0,n.highlightName=s}acquire(e,t){return this._draws.map((i=>i.material.acquireTechnique(this._techniques,e,t,i.geometry.parameters)))}dispatch(e,t,i){const r=this._rctx;this._previouslyBoundDraw.clear();let s=null;const n=this._draws.length,a=t.highlight?.name;for(let o=0;o<n;o++){const n=this._draws.data[o];if(e.identifier===xS.o.Highlight){const e=n.highlightName;if(e){if(e!==a)continue}else if(!a||!t.overlay?.hasHighlight(a))continue}const l=i[o];l===s&&t.oitPass===TS.M.NONE||(r.bindTechnique(l,t,e),s=l);const{geometryRanges:c,indexType:h,geometry:u,material:d}=n;r.bindVAO(u.vao),this._previouslyBoundDraw.get(l)!==d&&(l.program.bindDraw(t,e,d),this._previouslyBoundDraw.set(l,d));const p=c.length,{primitiveType:m}=u;for(let e=0;e<p;e+=2){const t=c[e],i=c[e+1];if(0!==h){const e=MS.get(h);r.drawElements(m,i,h,t*e)}else r.drawArrays(m,t,i)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=this._sorting===CS.FrontToBack?1:-1;this._draws.sort(((t,i)=>e*(t.depthSquaredHint-i.depthSquaredHint)||t.geometry.vao.usedMemory-i.geometry.vao.usedMemory))}get count(){return this._draws.length}}const MS=new Map;MS.set(Ir.g.UNSIGNED_BYTE,1),MS.set(Ir.g.UNSIGNED_SHORT,2),MS.set(Ir.g.UNSIGNED_INT,4);var ES=i(48737);class RS{constructor(e){const t=e.renderContext.rctx,i=e.techniques;this.opaque=new SS(t,i),this.transparent=new SS(t,i,CS.BackToFront),this.integratedMesh=new SS(t,i),this.occludedGround=new SS(t,i),this.shadowMap=new SS(t,i),this.highlight=new SS(t,i),this.highlightIntegratedMesh=new SS(t,i),this.highlightShadowMap=new SS(t,i),this.viewshedShadowMap=new SS(t,i),this.defaultShadowMap=new SS(t,i)}}class PS extends ES.d4{constructor(){super(...arguments),this.slicePlaneLocalOrigin=(0,O.Ue)(),this.origin=this.slicePlaneLocalOrigin}}class AS extends PS{constructor(){super(...arguments),this.identifier=xS.o.Material,this.output=Yb.H_.Color,this.transparent=!1,this.occludedGround=!1}}class OS extends PS{constructor(){super(...arguments),this.identifier=xS.o.ShadowMap}}class DS extends PS{constructor(){super(...arguments),this.identifier=xS.o.Highlight}}class IS extends PS{constructor(){super(...arguments),this.identifier=xS.o.ViewshedShadowMap}}var LS=i(20022);let FS=class extends ys.tY{constructor(){super({}),this.produces=new Map([[ew.r.OPAQUE_MATERIAL,e=>this._produces(e,ew.r.OPAQUE_MATERIAL)],[ew.r.TRANSPARENT_MATERIAL,e=>this._produces(e,ew.r.TRANSPARENT_MATERIAL)],[ew.r.INTEGRATED_MESH,e=>this._produces(e,ew.r.INTEGRATED_MESH)],[ew.r.OCCLUDED_GROUND,e=>this._produces(e,ew.r.OCCLUDED_GROUND)]]),this._materialPassParameters=new AS,this._shadowPassParameters=new OS,this._highlightPassParameters=new DS,this._viewshedPassParameters=new IS,this._systems=new Set}initializeRenderContext(e){this._context=e,this._passes=new RS(e)}get rctx(){return this._context.renderContext.rctx}uninitializeRenderContext(){}dispose(){this._context=null,this._systems.clear()}register(e){this._systems.add(e)}_produces(e,t){return!!this._invoke(e,t,(e=>e.count>0))}prepareRender(e){const{_systems:t,_passes:i}=this;if(0!==t.size&&null!=i){for(const e of Object.values(i))e.prepareSubmit();t.forEach((t=>t.submit(i,e.bind)));for(const e of Object.values(i))e.finishSubmit()}}acquireTechniques(e){if(0===this._systems.size)return null;const t=e.output===Yb.H_.Shadow||e.output===Yb.H_.ShadowHighlight||e.output===Yb.H_.ShadowExcludeHighlight?this._shadowPassParameters:e.output===Yb.H_.ViewshedShadow?this._viewshedPassParameters:e.output===Yb.H_.Highlight?this._highlightPassParameters:this._materialPassParameters,i=e.bind;return this._updateParameters(i.camera,t,i.slot),this._materialPassParameters.output=e.output,this._invoke(e.output,e.bind.slot,((t,i)=>t.acquire(i,e.bind)))}render(e,t){this._invoke(e.output,e.bind.slot,((i,r)=>i.dispatch(r,e.bind,t)))}_invoke(e,t,i){if(null==this._passes)return null;switch(t){case ew.r.OPAQUE_MATERIAL:switch(e){case Yb.H_.Color:case Yb.H_.ColorEmission:case Yb.H_.Depth:case Yb.H_.Normal:case Yb.H_.ObjectAndLayerIdColor:return i(this._passes.opaque,this._materialPassParameters);case Yb.H_.Highlight:return i(this._passes.highlight,this._highlightPassParameters);case Yb.H_.Shadow:return i(this._passes.shadowMap,this._shadowPassParameters);case Yb.H_.ShadowHighlight:return i(this._passes.highlightShadowMap,this._shadowPassParameters);case Yb.H_.ShadowExcludeHighlight:return i(this._passes.defaultShadowMap,this._shadowPassParameters);case Yb.H_.ViewshedShadow:return i(this._passes.viewshedShadowMap,this._viewshedPassParameters)}break;case ew.r.TRANSPARENT_MATERIAL:switch(e){case Yb.H_.Color:case Yb.H_.ColorEmission:case Yb.H_.Depth:case Yb.H_.Normal:case Yb.H_.ObjectAndLayerIdColor:return i(this._passes.transparent,this._materialPassParameters)}break;case ew.r.INTEGRATED_MESH:switch(e){case Yb.H_.Color:case Yb.H_.ColorEmission:case Yb.H_.Depth:case Yb.H_.Normal:case Yb.H_.ObjectAndLayerIdColor:return i(this._passes.integratedMesh,this._materialPassParameters);case Yb.H_.Highlight:return i(this._passes.highlightIntegratedMesh,this._highlightPassParameters)}break;case ew.r.OCCLUDED_GROUND:switch(e){case Yb.H_.Color:case Yb.H_.ColorEmission:case Yb.H_.Depth:case Yb.H_.Normal:case Yb.H_.ObjectAndLayerIdColor:return i(this._passes.occludedGround,this._materialPassParameters)}}return null}notifyDirty(){this._context.requestRender()}queryDepthRange(e){const t=new Om.P;return this._systems.forEach((i=>t.union(i.queryDepthRange(e)))),t}get hasEmissions(){let e=!1;return this._systems.forEach((t=>e=t.hasEmissions||e)),e}_updateParameters(e,t,i){const r=e.viewInverseTransposeMatrix,s=i===ew.r.TRANSPARENT_MATERIAL,n=i===ew.r.OCCLUDED_GROUND;(0,mr.i)(NS,r[3],r[7],r[11]),HS.set(NS),(0,mr.c)(t.transformWorldFromViewTH,HS.high),(0,mr.c)(t.transformWorldFromViewTL,HS.low),(0,mr.c)(t.slicePlaneLocalOrigin,NS),(0,Tr.xO)(t.transformViewFromCameraRelativeRS,e.viewMatrix),(0,Sr.JG)(t.transformProjFromView,e.projectionMatrix),t.identifier===xS.o.Material&&(this._materialPassParameters.transparent=s,this._materialPassParameters.occludedGround=n,(0,Tr.p4)(US,t.transformViewFromCameraRelativeRS),(0,Tr.U_)(t.transformNormalViewFromGlobal,US))}hasHighlight(e){for(const t of this._systems)if(t.hasHighlight(e))return!0;return!1}};FS=(0,o._)([(0,S.j)("esri.views.3d.webgl-engine.core.renderPasses.RenderPassManager")],FS);const NS=(0,O.Ue)(),US=(0,co.Ue)(),HS=new LS.I;var VS=i(36553);var kS=i(13e3);class BS{constructor(e){this._context=e,this._nodes=new ud.Z}destroy(){this._nodes.forEach((e=>e.destroy())),this._nodes.clear()}add(e){this._nodes.push(e),kS.CM&&console.log(`Registered render nodes: ${this._nodes.map((({declaredClass:e})=>e)).join(", ")}`)}remove(e){this._nodes.remove(e),kS.CM&&console.log(`Registered render nodes: ${this._nodes.map((({declaredClass:e})=>e)).join(", ")}`)}produces(e){return this._nodes.some((({produces:t})=>t===e))}require(e,...t){const i=this._nodes,r=t=>i.reduce(((i,{consumes:r,produces:s})=>i+(!r.required.includes(e)||null!=t&&s!==t?0:1)),0);return 0===t.length?r():t.reduce(((e,t)=>e+r(t)),0)}optional(e,...t){const i=this._nodes,r=t=>i.reduce(((i,{consumes:r,produces:s})=>i+(!r.optional?.includes(e)||null!=t&&s!==t?0:1)),0);return 0===t.length?r():t.reduce(((e,t)=>e+r(t)),0)}updateAnimation(e){return this._nodes.reduce(((t,i)=>i.updateAnimation(e)||t),!1)}precompile(...e){++this._context.techniques.precompiling;for(const t of e)this._nodes.forEach((e=>{e.produces===t&&e.precompile()}));--this._context.techniques.precompiling}render(e,t,i=(()=>{})){return this._render(e,t,i)??(function(e){return e.name}(e)?e:bS)}produce(e,t,i=(()=>{})){return this._render(e,t,i)}_render(e,t,i=(()=>{})){const r="string"==typeof e?e:e.name,s=this._nodes.filter((({produces:e})=>e===r));if(0===s.length)return;let n="string"==typeof e?null:e;return s.some((e=>{const s=n?[n]:[],a=null==n;for(const n of e.consumes.required){if(n===r){if(a)return!1;continue}const e=t.get(n);if(e)s.push(e);else if("emissive"!==n||!t.get(r)?.hasAttachment(n))return i?.(s),!1}if(e.consumes.optional)for(const i of e.consumes.optional){if(i===r)continue;const e=t.get(i);e&&s.push(e)}try{const i=e.doRender(s);i&&i!==n&&(r!==i.name&&(_.Z.getLogger(e).errorOnce(`RenderNode produced ${i.name}, expected ${r}`),i.setName(r)),n?.release(),n=i,t.set(r,n))}catch(t){_.Z.getLogger(e).errorOnce(t)}return i?.(s),a&&null!=n})),this._context.rctx.enforceState(),n}requireGeometryDepth(){return this._nodes.some((e=>"disabled"!==e.produces&&e.requireGeometryDepth))}get test(){return{nodes:this._nodes}}}class zS{constructor(e){this.context=e,this._renderPlugins=new ud.Z,this._slots=new Array,this._version=(0,yr.t)(0);for(let e=0;e<ew.r.MAX_SLOTS;++e)this._slots[e]=[]}destroy(){this._renderPlugins.forEach((e=>e.destroy())),this._renderPlugins.clear()}get plugins(){return this._renderPlugins}add(e,t){const i=()=>{if(t?.aborted)throw e.uninitializeRenderContext(),(0,y.zE)();this._renderPlugins.push(e),e.produces.forEach(((t,i)=>this._slots[i].push(e))),this.context.requestRender(),this._version.value++},r=e.initializeRenderContext(this.context,t);if((0,y.y8)(r))return r.then(i);i()}remove(e){this._renderPlugins.removeUnordered(e),e.uninitializeRenderContext();for(let t=0;t<this._slots.length;++t)this._slots[t]=this._slots[t].filter((t=>t!==e));this.context.requestRender(),this._version.value++}prepareRender(){this._renderPlugins.forAll((e=>{e.prepareRender&&e.prepareRender(this.context.renderContext)}))}updateAnimation(e){let t=!1;return this._renderPlugins.forAll((i=>t=i.updateAnimation?.(e)||t)),t}precompile(...e){++this.context.techniques.precompiling;const t=this.context.renderContext.bind.slot;for(const t of e)this.context.renderContext.bind.slot=t,this._forEachRender((()=>{}));this.context.renderContext.bind.slot=t,--this.context.techniques.precompiling}render(...e){for(const t of e)this.context.renderContext.bind.slot=t,this._forEachRender(((e,t)=>e.render(this.context.renderContext,t)))}_forEachRender(e){const t=this.context.renderContext.bind.slot,i=this.context.renderContext.output;this._slots[t].forEach((r=>{if(!r.produces.get(t)?.(i)||r.isDecoration&&!this.context.renderContext.bind.decorations)return;const s=r.acquireTechniques(this.context.renderContext);s&&e(r,s)}))}queryDepthRange(e){const t=new Om.P;return this._renderPlugins.forAll((i=>{const r=i.queryDepthRange?.(e);t.union(r)})),t}get updating(){return this._version.value>=0&&this._renderPlugins.some((e=>e.running))}produces(e,...t){return t.some((t=>this._slots[t].some((i=>{const r=i.produces.get(t);return!!r&&r(e)}))))}consumes(e){return this._renderPlugins.some((t=>t.consumes().required.includes(e)))}hasHighlight(e){return GS.some((t=>this._slots[t].some((t=>t.hasHighlight(e)))))}get hasDecorations(){return this._renderPlugins.some((e=>e.isDecoration))}get hasOccludees(){return this._renderPlugins.some((e=>e.hasOccludees))}get hasEmissions(){return this._renderPlugins.some((e=>e.hasEmissions))}get renderOccludedFlags(){return this._renderPlugins.reduce(((e,t)=>e|(t.renderOccludedFlags??Jb.yD.None)),Jb.yD.None)}get usedMemory(){return this._renderPlugins.reduce(((e,t)=>t.material?e:e+(t.usedMemory??0)),0)}get test(){}}const GS=[ew.r.OPAQUE_MATERIAL,ew.r.TRANSPARENT_MATERIAL,ew.r.DRAPED_MATERIAL,ew.r.HUD_MATERIAL,ew.r.LABEL_MATERIAL];var qS=i(3931);class ZS extends Dr.A{constructor(e,t){super(e,t,new Or.J(qS.a,(()=>i.e(79490).then(i.bind(i,79490)))))}initializePipeline(e){return(0,Lr.sm)({blending:Lr.vf,colorWrite:Lr.gf,drawBuffers:e.hasEmission?{buffers:[Ir.Ii,Ir.Ml]}:{buffers:[Ir.Ii]}})}}class jS extends ob.m{constructor(){super(...arguments),this.hasEmission=!1}}(0,o._)([(0,ob.o)()],jS.prototype,"hasEmission",void 0);class WS{constructor(e){this._techniques=e,this._parameters=new qS.O,this._configuration=new jS,e.precompile(ZS,this._configuration),this._configuration.hasEmission=!0,e.precompile(ZS,this._configuration)}blend(e,t,i,r,s){this._parameters.colorTexture=t.getTexture(),s&&(this._parameters.emissionTexture=t.getTexture(Ir.Ml),this._parameters.emissionFrontFaceTexture=i.getTexture(Ir.Ml)),this._parameters.alphaTexture=t.getTexture(s?Ir.FF:Ir.Ml),this._parameters.frontFaceTexture=i.getTexture(),this._configuration.hasEmission=s;const n=this._techniques.get(ZS,this._configuration);e.bindTechnique(n,r,this._parameters),e.screen.draw()}}class $S{constructor(e,t){this._camera=e,this._dt=(0,Yr.HA)(0),this._time=(0,Yr.HA)(0),this._lastUpdate=(0,Yr.HA)(0),this._lastUpdate=t,this._time=t}advance(e,t,i){const r=(0,Yr.HA)(t-this._lastUpdate);this._dt=(0,Yr.HA)(r/i),this._time=(0,Yr.HA)(this._time+r),this._lastUpdate=t,this._camera=e}get camera(){return this._camera}get dt(){return this._dt}get time(){return this._time}}class XS{constructor(){this._step=tM,this._dilation=1,this._firstIdleTime=(0,Yr.HA)(0)}frame(e,t){if(t?0===this._firstIdleTime&&(this._firstIdleTime=(0,Yr.HA)(performance.now())):this._firstIdleTime=(0,Yr.HA)(0),(0,m.Z)("disable-feature:high-quality-idle"))this._dilation=1;else{const e=t?performance.now()-this._firstIdleTime:0;if(e>=QS+KS)return this._step=(0,Yr.HA)(1/0),void(this._dilation=1);this._dilation=e>=QS?JS:1}const i=(0,jt.uZ)(e/YS,tM,iM);this._step===1/0?this._step=(0,Yr.HA)(i):this._step=(0,Yr.HA)(this._step*eM+i*(1-eM))}get value(){return this._step}get timeDilation(){return this._dilation}clear(){this._step=this._firstIdleTime=(0,Yr.HA)(0)}}const YS=.5,QS=(0,Yr.HA)(12e4),KS=(0,Yr.HA)(1e4),JS=10,eM=.9,tM=(0,Yr.HA)(1e3),iM=(0,Yr.HA)(1e3/30);var rM,sM=i(45953),nM=i(33641);!function(e){e[e.SHADOW_CASTERS=0]="SHADOW_CASTERS",e[e.FULL_SCENE=1]="FULL_SCENE"}(rM||(rM={}));function aM(e,t,i,r){let s=0;if(!t.some((e=>!!e.material&&(s+=e.numGeometries,s>=1e4))))return yM.compute(e,t,r);const n=new Om.P;return i.forAll((t=>n.union(function(e,t){if(!t.visible)return;const i=new Om.P,r=t.getSpatialQueryAccelerator();return r?function(e,t,i){const{eye:r,viewForward:s,frustum:n}=t,a=e=>e.visible,o=i.objectCount;if(o<500)fM.set(t.near,Math.min(e.near,t.far)),i.forEachInDepthRange(r,s,nM.Z.DepthOrder.FRONT_TO_BACK,fM,((i,r)=>{oM(e,t,i),fM.far=e.near,r.setRange(fM)}),n,a),fM.set(Math.max(e.far,t.near),t.far),i.forEachInDepthRange(r,s,nM.Z.DepthOrder.BACK_TO_FRONT,fM,((i,r)=>{oM(e,t,i),fM.near=e.far,r.setRange(fM)}),n,a);else{const r=Math.max(Math.min(o,500),Math.ceil(.1*o)),l=i.findClosest(s,nM.Z.DepthOrder.FRONT_TO_BACK,n,a,r),c=i.findClosest(s,nM.Z.DepthOrder.BACK_TO_FRONT,n,a,r);l&&c&&(cM(e,t,l.boundingVolumeWorldSpace.bounds),cM(e,t,c.boundingVolumeWorldSpace.bounds))}}(i,e,r):function(e,t,i){gM.clear(),i.forEach((e=>{e.visible&&0!==e.geometries.length&&gM.add(e)})),gM.empty||(gM.sort(t),fM.set(t.near,Math.min(e.near,t.far)),gM.forEachInDepthRange(fM,nM.Z.DepthOrder.FRONT_TO_BACK,((i,r)=>{r<e.near&&oM(e,t,i)})),fM.set(Math.max(e.far,t.near),t.far),gM.forEachInDepthRange(fM,nM.Z.DepthOrder.BACK_TO_FRONT,((t,i,r)=>{e.far=Math.max(e.far,r)})))}(i,e,t.objects),i}(e,t)))),n}function oM(e,t,i){if(!i.visible)return;if(!(0,hp.hr)(t.frustum,i.boundingVolumeWorldSpace.bounds))return;const r=i.transformation,s=_M;i.geometries.forEach((i=>{(0,Sr.Jp)(s,r,i.transformation);const n=(0,rr.u1)(s);lM(e,t,i.boundingInfo,s,n)}))}function lM(e,t,i,r,s){if(null==i)return;(0,mr.t)((0,Nn.a)(mM),i.center,r);const{eye:n,viewForward:a}=t,o=a[0]*(mM[0]-n[0])+a[1]*(mM[1]-n[1])+a[2]*(mM[2]-n[2]);if(mM[3]=i.radius*s,!(o-mM[3]>e.near&&o+mM[3]<e.far)&&(0,hp.hr)(t.frustum,mM))if(i.radius>100&&i.getChildren())for(const n of i.getChildren())lM(e,t,n,r,s);else vM.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,r,i.bbMin,i.bbMax)}function cM(e,t,i){const r=t.eye,s=t.viewForward,n=(i[0]-r[0])*s[0]+(i[1]-r[1])*s[1]+(i[2]-r[2])*s[2];e.near=Math.min(e.near,n-i[3]),e.far=Math.max(e.far,n+i[3])}function hM(e,t,i){let r=[e,t,i];for(let e=0;e<4;++e){const t=r;r=[];for(let i=0;i<t.length;++i){const s=t[i],n=t[(i+1)%t.length];uM(n,e)?(uM(s,e)||r.push(dM(s,n,e)),r.push(n)):uM(s,e)&&r.push(dM(s,n,e))}}return r}function uM(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void(0,R_.hu)(!1)}function dM(e,t,i){let r=0;return 0===i?r=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===i?r=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===i?r=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===i&&(r=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),(0,Nc.l)((0,Uc.Ue)(),e,t,r)}const pM=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],mM=(0,Nn.c)(),_M=(0,Mr.Ue)(),fM=new Om.P,gM=new class{constructor(){this._items=new ud.Z({allocator:e=>e||{object:null,distance:0,near:0,far:0},deallocator:e=>(e.object=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return 0===this._items.length}clear(){this._items.clear()}add(e){this._items.pushNew().object=e}sort(e){const t=e.eye,i=e.viewForward;this._items.forAll((e=>{const r=e.object.boundingVolumeWorldSpace.bounds,s=(r[0]-t[0])*i[0]+(r[1]-t[1])*i[1]+(r[2]-t[2])*i[2];e.distance=s,e.near=s-r[3],e.far=s+r[3]})),this._items.sort(((e,t)=>e.distance-t.distance))}forEachInDepthRange(e,t,i){if(t===nM.Z.DepthOrder.FRONT_TO_BACK)for(let t=0;t<this._items.length;++t){const r=this._items.data[t];r.far<e.near||r.near>e.far||i(r.object,r.near,r.far)}else for(let t=this._items.length-1;t>=0;--t){const r=this._items.data[t];r.far<e.near||r.near>e.far||i(r.object,r.near,r.far)}}},yM=new class{constructor(){this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange=new Om.P(0,0)}compute(e,t,i){this._reset();const{viewMatrix:r}=e;t.forAll((e=>{e.forEachGeometry((e=>{if(!e.visible||i===rM.SHADOW_CASTERS&&!e.castShadow)return;const t=e.boundingSphere,s=r[2]*t[0]+r[6]*t[1]+r[10]*t[2]+r[14],n=s-t[3],a=s+t[3];this._geometries.push(e),this._near.push(-a),this._far.push(-n)}))}));const s=new Om.P;if(0===this._geometries.length)return s;for(let e=0;e<this._geometries.length;++e)this._near[e]>s.far&&(s.far=this._near[e]),this._near[e]>2&&this._far[e]<s.near&&(s.near=this._far[e]);const n=this._looseRange;n.near=Math.max(.5*s.near,2),n.far=2*s.far;let a=0,o=0;for(let e=0;e<this._geometries.length;++e)this._near[e]<s.near&&(this._near[e]>=n.near?s.near=this._near[e]:this._nearCandidates[a++]=e),this._far[e]>s.far&&(this._far[e]<=n.far?s.far=this._far[e]:this._farCandidates[o++]=e);if(0===this._nearCandidates.length&&0===this._farCandidates.length)return s;this._nearCandidates.sort(((e,t)=>this._near[e]<this._near[t]?-1:this._near[e]>this._near[t]?1:0)),this._farCandidates.sort(((e,t)=>this._far[e]<this._far[t]?1:this._far[e]>this._far[t]?-1:0));for(let t=0;t<this._nearCandidates.length;++t){const i=this._nearCandidates[t];if(this._near[i]<s.near){const t=this._geometries[i],{boundingInfo:r,shaderTransformation:n}=t;this._includeNearBoundingInfoRec(e,r,n,s)}}for(let t=0;t<this._farCandidates.length;++t){const i=this._farCandidates[t];if(this._far[i]>s.far){const t=this._geometries[i],{boundingInfo:r,shaderTransformation:n}=t;this._includeFarBoundingInfoRec(e,r,n,s)}}return this._reset(),s}_reset(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}_isOutsideSidePlanes(e,t){const i=(0,Nn.a)(e),r=(0,Nn.g)(e);return t[0][0]*i[0]+t[0][1]*i[1]+t[0][2]*i[2]+t[0][3]>r||t[1][0]*i[0]+t[1][1]*i[1]+t[1][2]*i[2]+t[1][3]>r||t[2][0]*i[0]+t[2][1]*i[1]+t[2][2]*i[2]+t[2][3]>r||t[3][0]*i[0]+t[3][1]*i[1]+t[3][2]*i[2]+t[3][3]>r}_includeNearBoundingInfoRec(e,t,i,r){if(null==t)return;const s=t.center;(0,mr.t)((0,Nn.a)(mM),s,i),mM[3]=t.radius*(0,rr.u1)(i);const{frustum:n}=e;if(this._isOutsideSidePlanes(mM,n))return;const a=mM[0],o=mM[1],l=mM[2],c=mM[3],{viewMatrix:h}=e,u=h[2]*a+h[6]*o+h[10]*l+h[14],d=u+c;if(!(-(u-c)<2||-d>=r.near))if(-d>this._looseRange.near)r.near=-d;else{if(c>100){const s=t.getChildren();if(void 0!==s){for(const t of s)this._includeNearBoundingInfoRec(e,t,i,r);return}}vM.unionDepthRangeWithAABB(r,e.viewProjectionMatrix,i,t.bbMin,t.bbMax)}}_includeFarBoundingInfoRec(e,t,i,r){if(null==t)return;const s=t.center;(0,mr.t)((0,Nn.a)(mM),s,i),mM[3]=t.radius*(0,rr.u1)(i);const{frustum:n}=e;if(this._isOutsideSidePlanes(mM,n))return;const[a,o,l,c]=mM,{viewMatrix:h}=e,u=h[2]*a+h[6]*o+h[10]*l+h[14]-c;if(!(-u<=r.far))if(-u<this._looseRange.far)r.far=-u;else{if(c>100){const s=t.getChildren();if(void 0!==s){for(const t of s)this._includeFarBoundingInfoRec(e,t,i,r);return}}vM.unionDepthRangeWithAABB(r,e.viewProjectionMatrix,i,t.bbMin,t.bbMax)}}},vM=new class{constructor(){this._modelViewProj=(0,Mr.Ue)(),this._clipPosition=[(0,Uc.Ue)(),(0,Uc.Ue)(),(0,Uc.Ue)(),(0,Uc.Ue)(),(0,Uc.Ue)(),(0,Uc.Ue)(),(0,Uc.Ue)(),(0,Uc.Ue)()]}unionDepthRangeWithAABB(e,t,i,r,s){const n=this._modelViewProj;(0,Sr.Jp)(n,t,i);let a=!1;for(let e=0;e<8;++e){const t=this._clipPosition[e],i=0===e||3===e||4===e||7===e?r[0]:s[0],a=0===e||1===e||4===e||5===e?r[1]:s[1],o=e<4?r[2]:s[2];t[0]=n[0]*i+n[4]*a+n[8]*o+n[12],t[1]=n[1]*i+n[5]*a+n[9]*o+n[13],t[2]=n[2]*i+n[6]*a+n[10]*o+n[14],t[3]=n[3]*i+n[7]*a+n[11]*o+n[15]}for(let t=0;t<12;++t){const i=hM(this._clipPosition[pM[t][0]],this._clipPosition[pM[t][1]],this._clipPosition[pM[t][2]]);let r=!0;for(let e=0;e<i.length;++e)if(i[e][3]>=2){r=!1;break}if(!r){a=!0;for(let t=0;t<i.length;++t){const r=i[t][3];Number.isFinite(r)&&(e.near=Math.min(r,e.near),e.far=Math.max(r,e.far))}}}return a}},bM={idleOpacity:.8,navigatingOpacity:.4,maxDelta:.1,tiltFadeStart:20,tiltFadeEnd:30,altitudeStart:1e4,altitudeEnd:2e4};class wM{constructor(e){this._fbos=e,this._requiresEmission=!1,this._size=new vb.Z(0,0),this._clearColor=(0,Uc.Ue)()}dispose(){this._color=(0,f.RY)(this._color),this.releaseDepth()}initialize(e,t,i,r){this._size.width=e,this._size.height=t,(0,kr.d)(this._size,this._fbos.rctx.parameters.maxTextureSize);const s=this._color;return this._color=null,this.releaseDepth(),this._requiresEmission=r,(0,Nc.c)(this._clearColor,i),s}releaseDepth(){this._color?.detachDepth(),this._depth=(0,f.RY)(this._depth)}update(e){const t=this._ensureColor();t.attachDepth(this.depth),this._color=e(t)}bind(){const{rctx:e}=this._fbos,t=null==this._color;this.color.attachDepth(this.depth),e.bindFramebuffer(this.color.fbo),t&&(e.setClearStencil(0),e.setClearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3]),e.clear(Ir.Hf.COLOR|Ir.Hf.DEPTH|Ir.Hf.STENCIL),this._requiresEmission&&e.clearBuffer(1,lS.AG))}_acquireColor(){return this._requiresEmission?this._fbos.acquire(this._size.width,this._size.height,"acquired-color").acquireColor(Ir.Ml,Md.qz.RGBA16FLOAT,"emissive"):this._fbos.acquire(this._size.width,this._size.height,"acquired-color")}_acquireDepth(){return this._fbos.acquireDepth(Md.qk.DEPTH24_STENCIL8,this._size.width,this._size.height,"depth")}get size(){return this._size}get color(){return this._ensureColor()}get depth(){return this._depth??=this._acquireDepth(),this._depth}_ensureColor(){return this._color??=this._acquireColor(),this._color}}var CM=i(73267),xM=i(47718);class TM{constructor(){this._inputs=new Map}set(e,t){this._inputs.set(e,t)}get(e){return this._inputs.get(e)}has(e){return this._inputs.has(e)}release(e){this._inputs.get(e)?.release()&&this._inputs.delete(e)}}var SM=i(89145);class MM extends Dr.A{constructor(e,t){super(e,t,new Or.J(SM.a,(()=>i.e(4238).then(i.bind(i,4238))))),this.primitiveType=Ir.MX.TRIANGLE_STRIP}initializePipeline(){return(0,Lr.sm)({blending:Lr.Zo,colorWrite:Lr.gf,depthTest:null,depthWrite:null})}}var EM=i(65718);const RM=1/512;let PM=class extends E.Z{constructor(e,t,i,r){super({}),this._techniques=e,this._rctx=t,this._data=i,this._requestRender=r,this._passParameters=new SM.S(this._data),this._configuration=new EM.l,this._enabled=!1,this._vao=(0,bb.ow)(t)}dispose(){this._stop(),this._vao=(0,f.M2)(this._vao)}precompile(){this._showVisualization&&this._techniques.precompile(MM,this._configuration)}render(e){if(!this._showVisualization)return;const[t,i]=this._data.computedSamples;this._passParameters.sampleScale=[t?1/t:0,i?1/i:0];const r=this._techniques.get(MM,this._configuration);this._rctx.bindVAO(this._vao),this._rctx.bindTechnique(r,e,this._passParameters),this._rctx.drawArrays(r.primitiveType,0,(0,ds._V)(this._vao,"geometry"))}setOptions(e){void 0!==e.enabled&&this._setEnabled(e.enabled),void 0!==e.thresholdColor&&this._setThresholdColor(e.thresholdColor),void 0!==e.gradientColor&&this._setGradientColor(e.gradientColor),void 0!==e.bandedGradientColor&&this._setBandedGradientColor(e.bandedGradientColor),void 0!==e.threshold&&(this._threshold=e.threshold),void 0!==e.visualization&&(this._visualization=e.visualization),void 0!==e.bandSize&&(this._bandSize=e.bandSize)}get opacityFromElevation(){return this._passParameters.opacityFromElevation}set opacityFromElevation(e){this._passParameters.opacityFromElevation!==e&&(this._passParameters.opacityFromElevation=e,this.notifyChange("opacityFromElevation"))}get _showVisualization(){return this._enabled&&(this._data.computedSamples[0]>0||this._data.computedSamples[1]>0)&&this.opacityFromElevation>RM}get _threshold(){return this._passParameters.threshold}set _threshold(e){this._threshold!==e&&(this._passParameters.threshold=e,this._requestRenderIfEnabled())}get _visualization(){return this._configuration.visualization}set _visualization(e){e!==this._visualization&&(this._configuration.visualization=e,this._requestRenderIfEnabled())}get _bandSize(){return this._passParameters.bandSize}set _bandSize(e){e!==this._bandSize&&(this._passParameters.bandSize=e,this._requestRenderIfEnabled())}_setThresholdColor(e){const t=this._passParameters.thresholdColor;(0,Nc.a)(e,t)||((0,Nc.c)(this._passParameters.thresholdColor,e),this._requestRenderIfEnabled())}_setGradientColor(e){const t=this._passParameters.gradientColor;(0,Nc.a)(e,t)||((0,Nc.c)(this._passParameters.gradientColor,e),this._requestRenderIfEnabled())}_setBandedGradientColor(e){const t=this._passParameters.bandedGradientColor;(0,Nc.a)(e,t)||((0,Nc.c)(this._passParameters.bandedGradientColor,e),this._requestRenderIfEnabled())}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfEnabled(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}};(0,o._)([(0,x.Cb)()],PM.prototype,"opacityFromElevation",null),PM=(0,o._)([(0,S.j)("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],PM);var AM=i(79262),OM=i(55244),DM=i(80518);class IM extends Dr.A{constructor(e,t){super(e,t,new Or.J(OM.a,(()=>i.e(15230).then(i.bind(i,15230))))),this.primitiveType=Ir.MX.TRIANGLE_STRIP}initializePipeline(e){const t={r:e.index===DM.j.PRIMARY,g:e.index===DM.j.CONTEXT,b:!1,a:!1};return(0,Lr.sm)({blending:Lr.IH,colorWrite:t,depthTest:null,depthWrite:null})}}var LM=i(33011);class FM extends Dr.A{constructor(e,t){super(e,t,new Or.J(LM.S,(()=>i.e(19086).then(i.bind(i,19086))))),this.primitiveType=Ir.MX.TRIANGLE_STRIP}initializePipeline(e){const t={r:e.index===DM.j.PRIMARY,g:e.index===DM.j.CONTEXT,b:!1,a:!1};return(0,Lr.sm)({blending:null,colorWrite:t,depthTest:null,depthWrite:null})}}let NM=class extends E.Z{updateDepthRange(e){this._depthRange.equals(e)||(this._depthRange=e)}constructor(e,t,i,r,s,a){super({}),this.fbos=e,this._techniques=t,this._stage=i,this._prepareForShadowMapPass=r,this._renderToShadowMap=s,this._requestRender=a,this._primarySet=new kM(new DM.i(DM.j.PRIMARY),(()=>this._requestRenderIfEnabled())),this._contextSet=new kM(new DM.i(DM.j.CONTEXT),(()=>this._requestRenderIfEnabled())),this._passParameters=new CT.nj,this._depthRange=Om.P.zero,this._previewing=!1,this._cameraForcedForScreenshot=!1,this._shadowAccumulatorKey=Symbol("shadowAccumulator"),this._rctx=e.rctx,this._bindParameters=new vb.p(new AM.l(e,i.viewingMode)),this._bindParameters.shadowMap.enabled=!0,this._vao=(0,bb.ow)(this._rctx),this._accumulationRenderer=new PM(t,this._rctx,this,a);const o=this._stage.view.resourceController.scheduler;this.addHandles([o.registerTask(Gr.T8.SHADOW_ACCUMULATOR,this),(0,n.YP)((()=>i.renderView),(e=>{this.removeHandles(HM),null!=e&&this.addHandles(e.events.on("force-camera-for-screenshot",(()=>this._cameraForcedForScreenshot=!0)),HM)}),n.tX),(0,n.YP)((()=>this._previewing),(()=>this._requestRenderIfEnabled()),n.Z_),(0,n.YP)((()=>2===this._numActive),(()=>this._numActiveChanged()),n.Z_),(0,n.YP)((()=>this._depthRange),(()=>this._invalidateAccumulationSets()),n.Z_)],this._shadowAccumulatorKey);for(const e of this._accumulationSets())e.precompile(t)}*_accumulationSets(){yield this._primarySet,yield this._contextSet}normalizeCtorArgs(){return{}}dispose(){this._disable(),this.removeHandles(this._shadowAccumulatorKey),this._accumulationRenderer=(0,f.M2)(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=(0,f.M2)(this._fbo),this._vao=(0,f.M2)(this._vao);for(const e of this._accumulationSets())e.destroy()}get computedSamples(){return[this._primarySet.progress,this._contextSet.progress]}get shadowCastTexture(){return this._fbo?.colorTexture}get accumulating(){return this.active&&this._previewing||this._refining}get _refining(){return this.active&&!this._doneAccumulating&&!this._previewing}get active(){return null!=this._fbo&&[...this._accumulationSets()].some((e=>e.active))}get canAccumulate(){return null!=this._bindParameters.depth&&this._depthRange!==Om.P.zero&&this._opacityFromElevation>RM}get _doneAccumulating(){return[...this._accumulationSets()].every((e=>e.doneAccumulating))}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(e){this._accumulationRenderer.opacityFromElevation=e}get _numActive(){return[...this._accumulationSets()].reduce(((e,t)=>e+(t.active?1:0)),0)}get _pixelFormat(){return 2===this._numActive?{pixelFormat:Ir.VI.RG,internalFormat:Ir.lP.RG8}:{pixelFormat:Ir.VI.RED,internalFormat:Ir.lP.R8}}get running(){return this._refining&&this.canAccumulate&&[...this._accumulationSets()].some((e=>e.running))}runTask(e){this._clearBuffersOnAccumulationStart(),this._prepareForShadowMapPass(this._bindParameters);let t=!1;for(const i of this._accumulationSets())this._runTaskForSet(i,e)&&(t=!0);t&&this._requestRender()}_runTaskForSet(e,t){let i=!1;for(;!t.done&&!e.doneAccumulating;)this._accumulateShadow(e),t.madeProgress(),i=!0;return i}renderAccumulation(e,t,i){if(this._updateCamera(t),this._bindParameters.contentCamera=i,this._bindParameters.depth=e,this._passParameters.origin=this._bindParameters.camera.center,this.notifyChange("canAccumulate"),!this.accumulating||!this.canAccumulate)return!1;this._previewing||this._cameraForcedForScreenshot?(this._clearFramebuffer(),this._reset()):this._clearBuffersOnAccumulationStart();const r=this._accumulateSetsForRenderFrame();return this._cameraForcedForScreenshot=!1,r}_clearBuffersOnAccumulationStart(){if([...this._accumulationSets()].every((e=>0===e.progress)))this._clearFramebuffer();else for(const e of this._accumulationSets())0===e.progress&&this._clearFramebufferForSet(this._fbo,e)}_accumulateSetsForRenderFrame(){let e=!1;for(const t of this._accumulationSets())this._accumulateSetForRenderFrame(t)&&(e=!0);return e&&this._requestRender(),e}_accumulateSetForRenderFrame(e){let t=this._cameraForcedForScreenshot?e.sampleCount:Math.min(UM,e.sampleCount);t-=e.progress;for(let i=0;i<t;++i)this._accumulateShadow(e);return t>0}precompile(){this._accumulationRenderer.precompile()}render(e){this._accumulationRenderer.render(e)}setOptions(e){void 0!==e.previewing&&(this._previewing=e.previewing),void 0!==e.lightDirections&&(this._primarySet.lightDirections=e.lightDirections),void 0!==e.lightDirectionsContext&&(this._contextSet.lightDirections=e.lightDirectionsContext),!0===e.enabled?this._enable():!1===e.enabled&&this._disable(),this._accumulationRenderer.setOptions(e)}readAccumulatedShadow(e,t){const i=this._primarySet.progress;return!this.active||!this._fbo||i<1||e<0||e>=this._fbo.width||t<0||t>=this._fbo.height?0:(this._fbo.readPixels(e,t,1,1,Ir.VI.RGBA,Ir.Br.UNSIGNED_BYTE,VM),VM[DM.j.PRIMARY]/i)}_numActiveChanged(){if(!this._fbo)return;const e=2===this._numActive,t=this._createFBO();t.resize(this._fbo.width,this._fbo.height),e&&(this._clearFramebuffer(t),this._contextSet.reset()),this._fbo.width&&this._fbo.height&&this._rctx.blitFramebuffer(this._fbo,t),this._fbo.dispose(),this._fbo=t,this._requestRender()}_enable(){this._fbo||(this._fbo=this._createFBO(),this._invalidateAccumulationSets())}_createFBO(){const{pixelFormat:e,internalFormat:t}=this._pixelFormat,i=new Br.X;return i.pixelFormat=e,i.internalFormat=t,i.wrapMode=Ir.e8.CLAMP_TO_EDGE,new kr.X(this._rctx,i)}_invalidateAccumulationSets(){for(const e of this._accumulationSets())e.reset();this._requestRenderIfEnabled()}_disable(){this._fbo&&(this._fbo=(0,f.M2)(this._fbo),this._requestRender())}_reset(){for(const e of this._accumulationSets())e.reset()}_clearFramebuffer(e=this._fbo){e&&e.width&&e.height&&(this._rctx.bindFramebuffer(e),this._rctx.setClearColor(0,0,0,0),this._rctx.clear(Ir.Hf.COLOR))}_clearFramebufferForSet(e,t){if(!e)return;const i=this._techniques.get(FM,t.configuration);this._rctx.bindFramebuffer(e),this._rctx.bindTechnique(i,this._bindParameters,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(i.primitiveType,0,(0,ds._V)(this._vao,"geometry"))}_accumulateShadow(e){this._renderToShadowMap(this._bindParameters,e.lightDirections[e.progress++],this._depthRange);const t=this._techniques.get(IM,e.configuration);this._rctx.bindFramebuffer(this._fbo),this._rctx.bindTechnique(t,this._bindParameters,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(t.primitiveType,0,(0,ds._V)(this._vao,"geometry"))}_updateCamera(e){const t=this._fbo;if(null==t)return;const i=this._bindParameters.camera;e.equals(i)||i.copyFrom(e),t.resize(e.fullWidth,e.fullHeight),this._opacityFromElevation=1-(0,jt.CW)(4e4,5e4,e.relativeElevation)}_requestRenderIfEnabled(){this._fbo&&this._requestRender()}get test(){}};(0,o._)([(0,x.Cb)()],NM.prototype,"_fbo",void 0),(0,o._)([(0,x.Cb)()],NM.prototype,"_depthRange",void 0),(0,o._)([(0,x.Cb)()],NM.prototype,"_previewing",void 0),(0,o._)([(0,x.Cb)()],NM.prototype,"_accumulationRenderer",void 0),(0,o._)([(0,x.Cb)()],NM.prototype,"_refining",null),(0,o._)([(0,x.Cb)()],NM.prototype,"active",null),(0,o._)([(0,x.Cb)()],NM.prototype,"canAccumulate",null),(0,o._)([(0,x.Cb)()],NM.prototype,"_doneAccumulating",null),(0,o._)([(0,x.Cb)()],NM.prototype,"_opacityFromElevation",null),(0,o._)([(0,x.Cb)()],NM.prototype,"_numActive",null),(0,o._)([(0,x.Cb)()],NM.prototype,"_pixelFormat",null),(0,o._)([(0,x.Cb)()],NM.prototype,"running",null),NM=(0,o._)([(0,S.j)("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],NM);const UM=6,HM="renderView",VM=new Uint8Array(4);class kM{constructor(e,t){this.configuration=e,this._notifyChange=t,this._cachedLightDirections=[],this._progress=(0,yr.t)(0),this._sampleCount=(0,yr.t)(0)}get progress(){return this._progress.value}set progress(e){this._progress.value=e}get sampleCount(){return this._sampleCount.value}get doneAccumulating(){return this.progress>=this.sampleCount}get running(){return this.progress>0}get active(){return this.sampleCount>0}get lightDirections(){return this._cachedLightDirections}set lightDirections(e){const t=this._cachedLightDirections,i=Math.min(OM.S,e.length);if(!(0,St.P$)(t,0,t.length,e,0,i,mr.G)){t.length=i,this._sampleCount.value=i;for(let r=0;r<i;++r)t[r]=(0,mr.c)(t[r]??(0,O.Ue)(),e[r]);this.reset(),this._notifyChange()}}destroy(){this._cachedLightDirections.length=0,this._sampleCount.value=0}reset(){this.progress=0}precompile(e){e.precompile(IM,this.configuration),e.precompile(FM,this.configuration)}}const BM=(0,cd.d)();class zM{constructor(){this._plane=(0,cd.d)(),this._isDecoration=!0}get plane(){return this._plane}get isDecoration(){return this._isDecoration}update({plane:e,isDecoration:t}){let i=!1;return this._isDecoration!==t&&(this._isDecoration=t,i=!0),e??=BM,(0,cd.g)(e,this._plane)?i:((0,cd.a)(e,this._plane),!0)}}var GM=i(57225),qM=i(27076),ZM=i(24498);class jM{constructor(e,t,i,r,s,n,a,o,l){this.createQuery=e,this.deleteQuery=t,this.resultAvailable=i,this.getResult=r,this.disjoint=s,this.beginTimeElapsed=n,this.endTimeElapsed=a,this.createTimestamp=o,this.timestampBits=l}}let WM=!1;class $M{constructor(e,t){this._timer=e,this._queryPool=new Array,this._queryResults=new Map,this._currentQuery=null,t.forEach((e=>{const t=this._timer.createQuery(),i=this._timer.createQuery();this._queryPool.push(t,i),this._queryResults.set(e,null)}))}start(){WM||(this._currentQuery=this._queryPool.pop(),null!=this._currentQuery&&(this._timer.disjoint(),this._timer.beginTimeElapsed(this._currentQuery)))}stop(e){if(this._timer.disjoint()||null==this._currentQuery||!this._queryResults.has(e))return this.abort(),null;this._timer.endTimeElapsed();const t=this._queryResults.get(e);if(null==t)return this._queryResults.set(e,this._currentQuery),this._currentQuery=null,null;if(!this._timer.resultAvailable(t))return this._queryPool.unshift(this._currentQuery),this._currentQuery=null,null;const i=this._timer.getResult(t)/1e6;return this._queryPool.unshift(t),this._queryResults.set(e,this._currentQuery),this._currentQuery=null,i}abort(){null!=this._currentQuery&&(this._timer.deleteQuery(this._currentQuery),this._queryPool.unshift(this._timer.createQuery()),this._currentQuery=null)}dispose(){null!=this._currentQuery&&this._timer.deleteQuery(this._currentQuery),this._queryPool.forEach((e=>{this._timer.deleteQuery(e)})),this._queryResults.forEach((e=>{null!=e&&this._timer.deleteQuery(e)}))}}var XM;!function(e){e.OVERLAY="overlay",e.PREPARE="prepare",e.SHADOW_MAP="shadow map",e.DEPTH="depth",e.ACCUMULATED_SHADOWS="accumulated shadows",e.APPLY_ACCUMULATED_SHADOWS="apply accumulated shadows",e.OBJECT_AND_LAYER_ID_COLOR="object/layer id color",e.NORMALS="normals",e.SSAO="SSAO",e.HIGHLIGHTS="highlights",e.OPAQUE_EDGES="opaque edges",e.VOXEL="voxel",e.TRANSPARENT="transparent",e.TRANSPARENT_EDGES="transparent edges",e.HUD_VISIBILITY="HUD visibility",e.TRANSPARENT_TERRAIN="transparent terrain",e.TRANSPARENT_MATERIAL_WITHOUT_DEPTH="transparent material without depth",e.OPAQUE_ENVIRONMENT="opaque environment",e.TRANSPARENT_ENVIRONMENT="transparent environment",e.OCCLUDED="occluded",e.HUD="HUD",e.HUD_OCCLUDED="HUD occluded",e.FINISH="finish",e.FOCUS_AREA_MASK="focus area mask"}(XM||(XM={}));const YM=Object.values(Qr.lu).concat(Object.values(Qr.CM)).concat(Object.values(XM)),QM="Total";class KM{constructor(e){this._rctx=e,this._startTimeStampCPU=(0,Yr.HA)(0),this._lastTimeStampCPU=(0,Yr.HA)(0),this._totalCPUTime=new ZM.Z(QM),this._cpuTimeSamplers=new Map(YM.map((e=>[e,new ZM.Z(e)]))),this._enableGPUTimer=0,this._totalGPUTime=new ZM.Z("GPU"),this._gpuTimeSamplers=new Map(YM.map((e=>[e,new ZM.Z(e)]))),this._totalTime=(0,Yr.HA)(0),this._totalFrameCount=0}get totalCPUTimeSampler(){return this._totalCPUTime}get cpuTimeSamplers(){return Array.from(this._cpuTimeSamplers.values())}get totalGPUTimeSampler(){return this._totalGPUTime}get gpuTimeSamplers(){return Array.from(this._gpuTimeSamplers.values())}get gpuSamplingEnabled(){return null!=this._gpuTimerPool}get totalTime(){return this._totalTime}get totalFrameCount(){return this._totalFrameCount}get elapsedTime(){return(0,Yr.HA)(performance.now()-this._startTimeStampCPU)}enableGPUPerformanceInfo(){if(null==this._gpuTimerPool){const e=[...YM,QM];this._gpuTimerPool=function(e,t){const i=e.capabilities.disjointTimerQuery;return null==i?null:new $M(i,t)}(this._rctx,e)}if(null==this._gpuTimerPool)return{hasGPUTimerSupport:!1,remove:()=>{}};++this._enableGPUTimer;let e=!1;return{hasGPUTimerSupport:!0,remove:()=>{e||(e=!0,--this._enableGPUTimer,0===this._enableGPUTimer&&(this._gpuTimerPool=(0,f.M2)(this._gpuTimerPool)))}}}startFrame(){this._startTimeStampCPU=this._lastTimeStampCPU=(0,Yr.HA)(performance.now()),this._gpuTimerPool&&(this._gpuTimeSamplers.forEach((e=>e.push(0))),this._gpuTimerPool.start())}advance(e){const t=(0,Yr.HA)(performance.now());if(this._cpuTimeSamplers.get(e).push(t-this._lastTimeStampCPU),this._lastTimeStampCPU=t,this._gpuTimerPool){const t=this._gpuTimerPool.stop(e);this._gpuTimeSamplers.get(e).set(t),this._gpuTimerPool.start()}}finishFrame(){if(this._gpuTimerPool){const e=this._gpuTimerPool.stop(XM.FINISH);this._gpuTimeSamplers.get(XM.FINISH).set(e),this._rctx.gl.flush()}const e=(0,Yr.HA)(performance.now()-this._startTimeStampCPU);this._totalTime=(0,Yr.HA)(this._totalTime+e),this._totalCPUTime.push(e),this._gpuTimerPool&&this._totalGPUTime.push(this.gpuTimeSamplers.reduce(((e,t)=>e+(t.last||0)),0)),++this._totalFrameCount}}let JM=class extends xM.F{constructor(e,t,i,r,s,a){super({stage:e}),this._techniques=i,this._rctx=r,this._compositingHelper=s,this._requestRender=a,this._pluginsHas={hudElements:!1,water:!1},this.renderPassManager=new FS,this._isRendering=!1,this._inGlobeView=!1,this._backgroundColor=(0,Uc.al)(0,0,0,1),this._sliceHelper=new zM,this._blit=null,this._oitblend=null,this.sceneDepthRange=(0,yr.t)(Om.P.infinite),this._state=(0,yr.t)(Yc.n.IDLE),this._highQualityTransparencyEnabled=!0,this._ssrEnabled=!1,this._hasAnimations=!1,this._animationTimestep=new XS,this._loadEdgeViewTask=null,this._edgeViewCallbacks=[],this._reprojectionMatrixVersion=(0,yr.t)(0),this._lastFrameTime=(0,Yr.HA)(0),this._renderHiddenTransparentEdges=()=>{},this._pluginInput=new TM,this._releaseNormals=e=>{e.some((({name:e})=>"normals"===e))&&this._pluginInput.release("normals")},this._debugNeedsDepth=!1,this.fboCache=new gS(r),this._renderStateFeatures=(0,yr.t)((0,$c.n)(!(0,m.Z)("disable-feature:high-quality-idle"),e.view.qualityProfile)),this._framebuffer=new wM(this.fboCache),this.performanceInfo=new KM(this._rctx),this._shadowMap=new AM.l(this.fboCache,e.viewingMode),this._shadowAccumulator=new NM(this.fboCache,i,e,(e=>{const t=this.shadowsEnabled;this._shadowMap.enabled=!0,this._ensureBindParametersCamera(e.camera,e.contentCamera),this._plugins.prepareRender(),this._shadowMap.enabled=t}),((t,i,r)=>{const s=e.view.qualitySettings.maximumPixelRatio;t.shadowMap.start(t.camera,i,r,!0,s),this._renderShadowCascades(Yb.H_.Shadow,t.shadowMap),t.shadowMap.finish(),t.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(t.camera,t.contentCamera)}),a),this._renderContext=new CM.V(this._rctx,this._shadowMap,i),this._nodes=new BS(this._renderContext),this._plugins=new zS({renderContext:this._renderContext,techniques:i,materials:t,requestRender:a,controller:e,fbos:this.fboCache,isFeatureEnabled:e=>this.isFeatureEnabled(e)}),this._plugins.add(this.renderPassManager),this.addHandles([(0,n.YP)((()=>e.view.state.camera),(()=>a()),n.tX),(0,n.YP)((()=>dd.h.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES),(e=>{this._renderHiddenTransparentEdges=e?()=>this._renderEdges(GM.i.TRANSPARENT):()=>{},a()}),n.nn),(0,n.YP)((()=>e.view.environment.background?.color),(e=>{const t=e?(0,$w.O)(e):Uc.AG;(0,Nc.s)(this._backgroundColor,t[0]*t[3],t[1]*t[3],t[2]*t[3],t[3]),a()}),n.tX),(0,n.YP)((()=>e.view.state.camera.relativeElevation),(e=>this._inGlobeView=(e??1/0)>=VS.o),n.tX),(0,n.YP)((()=>this._bindParameters.clouds.fadeFactor),(()=>this._bindParameters.fadeLighting()),n.Z_),(0,n.YP)((()=>this._bindParameters.clouds.data?.state),(()=>a()),n.Z_),(0,n.YP)((()=>e.view.state.highlights),(e=>{this._bindParameters.highlights=e,a()}),n.nn)])}destroy(){this._gpuTimerHandle=(0,f.hw)(this._gpuTimerHandle),this._nodes.destroy(),this._framebuffer.dispose(),this._shadowMap.dispose(),this._shadowAccumulator.dispose(),this._loadEdgeViewTask=(0,f.IM)(this._loadEdgeViewTask),this._edgeView=(0,f.SC)(this._edgeView),this.renderPassManager.dispose(),this._releaseFBOs(),this._disposeOffscreenBuffers(),this.fboCache.destroy(),this._plugins.destroy(),this._blit=null,this._oitblend=null,sM.j.prune(),qM.A.prune(),(0,FC.WV)()}get renderContext(){return this._renderContext}get _bindParameters(){return this._renderContext.bind}get _framebufferSize(){return this._framebuffer.size}updateRenderFeatures(e=null,t=!(0,m.Z)("disable-feature:high-quality-idle")){this._renderStateFeatures.value=(0,$c.n)(t,e),this._requestRender()}isFeatureEnabled(e,t=this._state.value){return this._renderStateFeatures.value.get(t,e)??!1}setFeatureEnabled(e,t,i){this._renderStateFeatures.mutate((r=>r.set(t,e,i))),this._requestRender()}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled($c.Y.HighQualityTransparency)}get hasReflections(){return this._pluginsHas.water&&(this._ssrEnabled||this.isFeatureEnabled($c.Y.WaterReflection))}get _hasHighlights(){return this._plugins.produces(Yb.H_.Highlight,ew.r.OPAQUE_MATERIAL,ew.r.TRANSPARENT_MATERIAL,ew.r.DRAPED_MATERIAL,ew.r.HUD_MATERIAL,ew.r.LABEL_MATERIAL)}hasHighlight(e){return this._plugins.hasHighlight(e)}get _hasHUDHighlights(){return this._plugins.produces(Yb.H_.Highlight,ew.r.HUD_MATERIAL,ew.r.LABEL_MATERIAL)}get hasSSAO(){return(this.stage.view.qualitySettings.ambientOcclusion||this.isFeatureEnabled($c.Y.SSAO))&&!this._inGlobeView}get hasSMAA(){return this.stage.view.qualitySettings.antialiasingEnabled||this.isFeatureEnabled($c.Y.Antialiasing)}get fullResolutionAtmosphere(){return this.stage.view.qualitySettings.highResolutionAtmosphere||this.isFeatureEnabled($c.Y.HighResolutionAtmosphere)}_releaseFBOs(){this._bindParameters.ssr.lastFrameColor=(0,f.RY)(this._bindParameters.ssr.lastFrameColor),this._bindParameters.terrainDepth=(0,f.RY)(this._bindParameters.terrainDepth),this._bindParameters.geometryDepth=(0,f.RY)(this._bindParameters.geometryDepth)}_disposeOffscreenBuffers(){this._framebuffer.dispose(),this._disposeBindBuffers()}_disposeBindBuffers(){this._shadowMap.disposeOffscreenBuffers(),this._bindParameters.depth=(0,f.RY)(this._bindParameters.depth),this._bindParameters.hudVisibility=(0,f.RY)(this._bindParameters.hudVisibility)}get updating(){return this._loadEdgeViewTask&&!this._loadEdgeViewTask.finished||this._edgeView?.updating||this._shadowAccumulator.running||this._plugins.updating||!this.isCameraFinal}loadEdgeView(){return this._loadEdgeViewTask||(this._loadEdgeViewTask=(0,me.vr)((async e=>{const{EdgeView:t}=await i.e(84678).then(i.bind(i,84678));(0,y.k_)(e);const r=this._edgeView=new t({rctx:this._rctx,renderSR:this.stage.view.renderSpatialReference,viewingMode:this.stage.view.stage.viewingMode,techniques:this._techniques,setNeedsRender:()=>this._requestRender(),schedule:uE(this.stage.view.resourceController)});return this.addHandles((0,n.YP)((()=>r.updating),(()=>this._requestRender()),n.Z_)),this._requestRender(),this._edgeViewCallbacks.forEach((e=>e(r))),this._edgeViewCallbacks.length=0,r}))),this._loadEdgeViewTask.promise}withEdgeView(e){this.loadEdgeView(),null==this._edgeView?this._edgeViewCallbacks.push(e):e(this._edgeView)}get edgeView(){return this._edgeView}get isCameraFinal(){return this._reprojectionMatrixVersion.value>=0&&(0,Sr.fS)(this._bindParameters.ssr.reprojectionMatrix,Mr.Wd)}set _reprojectionMatrix(e){(0,St.Vx)(this._bindParameters.ssr.reprojectionMatrix,e)&&this._reprojectionMatrixVersion.value++}get shadowsEnabled(){return!!this._shadowMap?.enabled}setParameters(e){const{_shadowMap:t,_bindParameters:i}=this;if(void 0!==e.qualitySettings?.reflections&&this._ssrEnabled!==e.qualitySettings.reflections&&(this._ssrEnabled=e.qualitySettings.reflections,this._requestRender()),void 0!==e.shadowMap&&this._shadowMap.enabled!==e.shadowMap&&(this._shadowMap.enabled=e.shadowMap,this._requestRender()),void 0!==e.shadowMapMaxCascades&&t.maxCascades!==e.shadowMapMaxCascades&&(t.maxCascades=e.shadowMapMaxCascades,this._requestRender()),null!=e.environment){if(null!=e.environment.weather){const t=e.environment.weather;this._bindParameters.weather=t,this._bindParameters.snowCover=!!e.weatherVisible&&null!=t&&"snowy"===t.type&&"enabled"===t.snowCover}const t="virtual"!==e.environment.lighting.type;i.enableFillLights!==t&&(i.enableFillLights=t,this._requestRender())}void 0!==e.highQualityTransparency&&this._highQualityTransparencyEnabled!==e.highQualityTransparency&&(this._highQualityTransparencyEnabled=e.highQualityTransparency,this._requestRender()),void 0!==e.shadowCast&&this._shadowAccumulator.setOptions(e.shadowCast)}set slice(e){this._sliceHelper.update(e)&&this._requestRender()}get plugins(){return this._plugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}commit(e,t){return this._isRendering&&console.warn("Renderer.modify called while rendering"),!!super.commit(e,t,this._plugins.context)&&(this.updateHasFlags(),!0)}rendererAdded(e){this._plugins.add(e)}rendererRemoved(e){this._plugins.remove(e)}get occludedRequiresStencil(){return this.occludedRequiresOccludeeStencil||this.occludedRequiresIntegratedMeshStencil}get occludedRequiresOccludeeStencil(){return this._bindParameters.hasOccludees&&0!=(this.plugins.renderOccludedFlags&Jb.yD.OccludeAndTransparentStencil)}get occludedRequiresIntegratedMeshStencil(){return this._plugins.produces(Yb.H_.Color,ew.r.INTEGRATED_MESH)&&this._plugins.produces(Yb.H_.Color,ew.r.OCCLUDED_GROUND)}updateHasFlags(){const e=this._pluginsHas;e.hudElements=this._plugins.produces(Yb.H_.Color,...aE),e.water=this._plugins.produces(Yb.H_.Normal,ew.r.DRAPED_WATER),this._bindParameters.hasOccludees=this._plugins.hasOccludees,this._requestRender()}updateAnimation(e,t){this._animationTimer??=new $S(e.camera,t),this._animationTimer.advance(e.camera,t,this._animationTimeDilation);const i=this._hasAnimations;return this._hasAnimations=this._plugins.updateAnimation(this._animationTimer),this._hasAnimations=this._nodes.updateAnimation(this._animationTimer)||this._hasAnimations,this._hasAnimations!==i&&(this._gpuTimerHandle=i?(0,f.hw)(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get _animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}tick(){this.fboCache.clean()}render(e,t,i=Wc.YE.Default,r=!1){try{return this._isRendering=!0,this._render(e,t,i,r)}catch(e){console.error(`Exception during rendering: ${e}`)}finally{this._isRendering=!1}return new dg(this._pluginInput.get(Qr.lu.FINAL),null)}_updateHUDOccludedFragmentOpacity(e,t){const{idleOpacity:i,navigatingOpacity:r,maxDelta:s,tiltFadeStart:n,tiltFadeEnd:a,altitudeStart:o,altitudeEnd:l}=bM,c=this.stage.view,h=c.stateManager.camera,u=c.qualitySettings.fadeDuration,d=e===Yc.n.IDLE?i:r,p=(0,jt.uZ)((h.tilt-n)/(a-n),0,1),m=(0,jt.uZ)(((h.position.z??0)-o)/(l-o),0,1),_=(0,jt.t7)((0,jt.t7)(1,d,p),1,m),f=this._bindParameters.hudOccludedFragmentOpacity;if(u<=0||f===_||0===this._lastFrameTime||this._lastFrameTime>t)return this._bindParameters.hudOccludedFragmentOpacity=_,void(this._lastFrameTime=t);const g=t-this._lastFrameTime;this._lastFrameTime=t;const y=Math.max(1-i,Math.abs(i-r)),v=Math.min(y*g/u,s);v>=Math.abs(_-f)?this._bindParameters.hudOccludedFragmentOpacity=_:(this._bindParameters.hudOccludedFragmentOpacity=f+Math.sign(_-f)*v,this._requestRender())}_render(e,t,i=Wc.YE.Default,r){this.performanceInfo.startFrame(),this.fboCache.frameStart(),this.fboCache.interactive=i===Wc.YE.Default,this._disposeBindBuffers();const{camera:s,contentCamera:n,mode:a,alignPixelEnabled:o}=e;this._state.value=a;const l=this._nodes.produces("magnifier-color"),c=this._nodes.produces(Qr.lu.FINAL),h=this._nodes.require("emissive",Qr.CM.TRANSPARENT_ENVIRONMENT,Qr.lu.COMPOSITE,Qr.lu.FINAL)>0&&this._plugins.hasEmissions,u=h?Yb.H_.ColorEmission:Yb.H_.Color;this._renderContext.time=t,this._renderContext.output=u,this._bindParameters.oitPass=TS.M.NONE,this._bindParameters.alignPixelEnabled=o,this._bindParameters.decorations=!r,this._bindParameters.mainDepth=null;const d=!r||!this._sliceHelper.isDecoration;this._bindParameters.slicePlane=d?this._sliceHelper.plane:null,this._bindParameters.viewshedEnabled=this._nodes.produces(Qr.CM.VIEWSHED),this._renderOverlay(t),s.setGLViewport(this._rctx);const p=this._framebuffer,m=p.initialize(s.fullWidth,s.fullHeight,this._backgroundColor,h);this.hasReflections?(m?.setName("last frame color"),this._bindParameters.ssr.lastFrameColor=m):m?.release(),this._ensureBindParametersCamera(s,n),this._updateHUDOccludedFragmentOpacity(a,t),this._plugins.prepareRender(),this._bindParameters.shadowHighlightsVisible=this._needsShadowHighlight&&!r;const _=this._highQualityTransparency&&this._hasTransparentTerrain,f=this._plugins.produces(Yb.H_.Color,...sE);this._precompilePrepasses(),this.performanceInfo.advance(XM.PREPARE);const g=this._computeShadowDepthRange(s);this._renderShadowMap(s,this._bindParameters.lighting.mainLight.direction,g),this._pluginInput.set("normals",this._renderNormals()),this._renderRemainingGeometryDepth(),this._renderShadowAccumulation(g,s,n),this._ensureBindParametersSSR(t),this._precompileShaders(_,f,u),this._renderContext.output=u,p.bind(),this._bindParameters.mainDepth=p.depth.attachment,this._renderOpaque(_),this._renderTransparent(f,_,u),this._shadowMap.disposeMainBuffer(),this._pluginInput.set(Qr.CM.FOCUSAREA,this._renderFocusAreaGeometry()),p.update((e=>this._renderNodes(Qr.CM.TRANSPARENT_ENVIRONMENT,e))),p.update((e=>this._renderNodes(Qr.CM.VIEWSHED,e))),p.update((e=>this._renderNodes(Qr.CM.LASERLINES,e))),p.update((e=>this._renderNodes(Qr.CM.FOCUSAREA_COLOR,e))),this._pluginInput.release(Qr.CM.FOCUSAREA),p.update((e=>this._renderNodes(Qr.CM.OCCLUDED,e))),this._pluginInput.set("highlights",this._renderHighlightPrepass()),this._renderHighlightShadowMap(s,this._bindParameters.lighting.mainLight.direction,g);const y=i===Wc.YE.ObjectAndLayerID?this._renderObjectAndLayerIdColor():null;p.update((e=>this._renderNodes(Qr.lu.COMPOSITE,e))),this._shadowMap.disposeOffscreenBuffers();const v=!(i!==Wc.YE.Default||c||l&&!r),b=this._pluginInput.get(Qr.lu.COMPOSITE),w=v?bS:this.fboCache.acquire(b.fbo.width,b.fbo.height,Qr.CM.ANTIALIASING),C=this._nodes.produces(Qr.CM.ANTIALIASING)?this._renderNodes(Qr.CM.ANTIALIASING,w):this._blitFBO(b,w,!1);let x;this._pluginInput.set(Qr.CM.ANTIALIASING,C),this._hasHUDHighlights?(this._renderHUD(aT.U.NotOccluded,C,u),x=this._renderNodes(Qr.CM.HIGHLIGHTS,C)):(x=this._renderNodes(Qr.CM.HIGHLIGHTS,C),this._renderHUD(aT.U.NotOccluded,x,u));const T=this._renderNodes(Qr.CM.MAGNIFIER,x);return l&&!r&&i===Wc.YE.Default&&!c&&this._blitFBO(T),c?(T.attachDepth(p.depth),this._blitFBO(this._renderNodes(Qr.lu.FINAL,T)),T.detachDepth()):this._pluginInput.set(Qr.lu.FINAL,T),this._pluginInput.release("highlights"),this.onPostRender&&this.onPostRender(),this._releaseFBOs(),p.releaseDepth(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this.fboCache.frameEnd(),this.performanceInfo.finishFrame(),i!==Wc.YE.Default&&(this._releaseFBOs(),this._disposeOffscreenBuffers()),new dg(this._pluginInput.get(Qr.lu.FINAL),y)}_precompileShaders(e,t,i){++this._plugins.context.techniques.precompiling,this._renderContext.output=i,this._precompileOpaqueGeometry(),this._nodes.precompile(Qr.CM.OPAQUE_ENVIRONMENT),this._bindParameters.terrainDepthTest=e,this._bindParameters.cullAboveTerrain=e,this._renderContext.output=Yb.H_.Depth,this._plugins.precompile(ew.r.TRANSPARENT_TERRAIN),e&&(this._precompileOpaqueGeometry(),this._precompileTransparentGeometry()),this._renderContext.output=i,this._plugins.precompile(ew.r.TRANSPARENT_TERRAIN),t&&(this._precompileTransparentGeometry(),this._hasTransparentTerrain&&(this._bindParameters.cullAboveTerrain=!1,this._precompileTransparentGeometry(),this._bindParameters.cullAboveTerrain=e)),this._nodes.precompile(Qr.CM.FOCUSAREA),this._needsHUDVisibility&&this._plugins.precompile(ew.r.OCCLUSION_PIXELS),this._plugins.precompile(ew.r.LINE_CALLOUTS),this._precompileHUD(aT.U.Occluded),this._bindParameters.terrainDepthTest=!1,this._bindParameters.cullAboveTerrain=!1,this._nodes.precompile(Qr.CM.VIEWSHED,Qr.CM.LASERLINES,Qr.CM.FOCUSAREA_COLOR,Qr.CM.OCCLUDED,Qr.CM.ANTIALIASING,Qr.CM.HIGHLIGHTS);const r=this._bindParameters;r.highlightMixTexture=r.highlights.length>1?this._rctx.emptyTexture:null,this._precompileHUD(aT.U.NotOccluded),this._hasHighlights&&(r.highlights.forEach(((e,t)=>{r.highlightLevel=t,this._precompileAllGeometry(Yb.H_.Highlight)})),r.highlightLevel=null),r.highlightMixTexture=null,this._nodes.precompile(Qr.lu.COMPOSITE,Qr.CM.MAGNIFIER),this._shadowAccumulator.precompile(),this._plugins.precompile(ew.r.TRANSPARENT_MATERIAL_WITHOUT_DEPTH),--this._plugins.context.techniques.precompiling}_renderFocusAreaGeometry(){const e=this._nodes.produce(Qr.CM.FOCUSAREA,this._pluginInput);return e&&this.performanceInfo.advance(XM.FOCUS_AREA_MASK),e}_renderObjectAndLayerIdColor(){if(!this._nodes.produces("olid"))return null;const e=this._renderContext.output;++this._techniques.precompiling;const t=this._framebufferSize;let i=this.fboCache.acquire(t.width,t.height,"olid");return i.acquireDepth(Md.qk.DEPTH24_STENCIL8),i=this._nodes.render(i,this._pluginInput),--this._techniques.precompiling,this.performanceInfo.advance(XM.OBJECT_AND_LAYER_ID_COLOR),this._renderContext.output=e,i}finish(e){this._hasAnimations||this._animationTimestep.clear();const t=this.performanceInfo.gpuSamplingEnabled,i=e===os.Xx.BACKGROUND;if(i||t){const e=i?this.performanceInfo.elapsedTime:0;let r=0;t?r=this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.finish();const s=Math.max(e,r);this._animationTimestep.frame(s,i)}}readMainDepth(e,t){const{mainDepth:i,camera:r}=this._bindParameters;if(!i)return;const s=this.fboCache.acquire(this._framebufferSize.width,this._framebufferSize.height,"linear-depth");this._rctx.bindFramebuffer(s.fbo),r.setGLViewport(this._rctx),this._rctx.setScissorRect(e[0],e[1],e[2],e[3]),this._rctx.setScissorTestEnabled(!0),this._rctx.clearFramebuffer(Uc.AG),this._compositingHelper.blitDepthToLinearDepth(this._bindParameters,i),this._rctx.setScissorTestEnabled(!1),this._rctx.setScissorRect(0,0,this._rctx.gl.canvas.width,this._rctx.gl.canvas.width),s.fbo?.readPixels(e[0],e[1],e[2],e[3],Ir.VI.RGBA,Ir.Br.UNSIGNED_BYTE,t),s.release()}readHUDVisibility(e,t,i,r,s){this._bindParameters.hudVisibility?.fbo?.readPixels(e,t,i,r,Ir.VI.RGBA,Ir.Br.UNSIGNED_BYTE,s)}readAccumulatedShadow(e){return this._shadowAccumulator.readAccumulatedShadow(e[0],e[1])}_renderEdges(e){const t=this._edgeView;if(!t?.shouldRender())return;const i=this._framebufferSize,r=this.fboCache.acquire(i.width,i.height,"edges"),s=this._bindParameters.geometryDepth;this.renderToTargets((()=>t.render(this._bindParameters,e)),r,s??this._framebuffer.depth,Uc.AG),this._framebuffer.bind(),this._compositingHelper.composite(this._bindParameters,r.getTexture()),r.release(),this.performanceInfo.advance(e===GM.i.OPAQUE?XM.OPAQUE_EDGES:XM.TRANSPARENT_EDGES)}_renderOverlay(e){this._bindParameters.overlay=this.overlay?.render(e),this._bindParameters.overlay&&this.performanceInfo.advance(XM.OVERLAY)}_renderShadowMap(e,t,i){if(!this.shadowsEnabled)return;const{contentCamera:r}=this._bindParameters,s=this._shadowMap;s.start(e,t,i,this.isFeatureEnabled($c.Y.HighResolutionShadows),this.stage.view.qualitySettings.maximumPixelRatio),this._needsShadowHighlight?(this._renderShadowCascades(Yb.H_.ShadowExcludeHighlight,this._shadowMap),s.copySnapshot(AM.i.ExcludeHighlight),this._renderShadowCascades(Yb.H_.ShadowHighlight,this._shadowMap)):this._renderShadowCascades(Yb.H_.Shadow),s.finish(),e.setGLViewport(this._rctx),this._ensureBindParametersCamera(e,r),this.performanceInfo.advance(XM.SHADOW_MAP)}_renderHighlightShadowMap(e,t,i){if(!this.shadowsEnabled||!this._needsShadowHighlight)return;const{contentCamera:r}=this._bindParameters,s=this._shadowMap;s.start(e,t,i,this.isFeatureEnabled($c.Y.HighResolutionShadows),this.stage.view.qualitySettings.maximumPixelRatio),this._renderShadowCascades(Yb.H_.ShadowHighlight,this._shadowMap),s.moveSnapshot(AM.i.Highlight),s.finish(),e.setGLViewport(this._rctx),this._ensureBindParametersCamera(e,r),this.performanceInfo.advance(XM.SHADOW_MAP)}_precompileShadowCascades(e){for(const t of this._shadowMap.cascades)t.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(t.camera,t.camera),this._precompileAllGeometry(e)}_renderShadowCascades(e,t=this._shadowMap){t.bindFbo();for(const i of t.cascades)i.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(i.camera,i.camera),this.renderAllGeometry(e)}get _needsDepth(){return this._plugins.consumes(Yb.H_.Depth)||this._nodes.requireGeometryDepth()||this.hasReflections||this._needsShadowHighlight||this._shadowAccumulator.active||this._debugNeedsDepth}_renderRemainingGeometryDepth(){const e=this._pluginInput.get("normals");e?(this._pluginInput.set(Qr.CM.SSAO,this._renderSSAO()),this._needsDepth?(this._rctx.bindFramebuffer(e.fbo),this._rctx.clear(Ir.Hf.STENCIL),this._renderGeometryWithoutNormals(Yb.H_.Depth),(0,f.RY)(this._bindParameters.depth),this._bindParameters.depth=e.obtainDepthTexture(),this.performanceInfo.advance(XM.DEPTH)):(e.detachDepth(),this._bindParameters.depth=(0,f.RY)(this._bindParameters.depth)),this.hasSSAO&&this._pluginInput.release("normals")):this._renderAllGeometryDepth()}_renderAllGeometryDepth(){if(!this._needsDepth)return void(this._bindParameters.depth=(0,f.RY)(this._bindParameters.depth));const e=this._framebufferSize,t=this.fboCache.acquire(e.width,e.height,"depth",Md.qk.DEPTH24_STENCIL8);this._rctx.bindFramebuffer(t.fbo),this._rctx.clear(Ir.Hf.DEPTH|Ir.Hf.STENCIL),this.renderAllGeometry(Yb.H_.Depth),(0,f.RY)(this._bindParameters.depth),this._bindParameters.depth=t.obtainDepthTexture(),t.release(),this.performanceInfo.advance(XM.DEPTH)}_renderTerrainDepth(e){if(this._bindParameters.terrainDepthTest=e,this._bindParameters.cullAboveTerrain=e,!e)return void(this._bindParameters.terrainDepth=(0,f.RY)(this._bindParameters.terrainDepth));const t=this._renderContext.output;this._renderContext.output=Yb.H_.Depth;const i=this._framebufferSize,r=this.fboCache.acquire(i.width,i.height,"terrain depth",Md.qk.DEPTH24_STENCIL8);this._rctx.bindFramebuffer(r.fbo),this._rctx.clear(Ir.Hf.DEPTH|Ir.Hf.STENCIL),this._renderTransparentTerrain(),(0,f.RY)(this._bindParameters.terrainDepth),this._bindParameters.terrainDepth=r.obtainDepthTexture(),this._renderContext.output=t,r.release()}_renderGeometryDepth(e){if(!e)return void(this._bindParameters.geometryDepth=(0,f.RY)(this._bindParameters.geometryDepth));const t=this._renderContext.output,{width:i,height:r}=this._framebufferSize,s=this.fboCache.acquire(i,r,"geometry depth",Md.qk.DEPTH24_STENCIL8);this._rctx.bindFramebuffer(s.fbo),this._rctx.clear(Ir.Hf.DEPTH|Ir.Hf.STENCIL),this._renderOpaqueAndTransparentGeometry(Yb.H_.Depth),this._renderContext.output=t,(0,f.RY)(this._bindParameters.geometryDepth),this._bindParameters.geometryDepth=s.obtainDepthTexture(),s.release()}get _needsShadowDepthRange(){return this._shadowMap.enabled||this._shadowAccumulator.active}_computeShadowDepthRange(e){if(!this._needsShadowDepthRange)return Om.P.zero;const t=aM(e,this._plugins.plugins,this.stage.layers,rM.SHADOW_CASTERS);return t.union(this._plugins.queryDepthRange(e)),t.near=Math.max(e.near,t.near),t.far=Math.min(e.far,t.far),t}updateSceneDepthRange(e){if(!this.stage.view.state.isGlobal)return void(this.sceneDepthRange.value=Om.P.infinite);if((this.stage.view.renderCoordsHelper?.getAltitude(e.eye)??0)<Xw.mP)return void(this.sceneDepthRange.value=Om.P.infinite);const t=e.clone();t.near=Vc.Z,t.far=1e10;const i=aM(t,this._plugins.plugins,this.stage.layers,rM.FULL_SCENE);i.union(this._plugins.queryDepthRange(t)),this.sceneDepthRange.value.far===i.far&&this.sceneDepthRange.value.near===i.near||(this.sceneDepthRange.value=i)}get _normalsRequired(){const e=this._nodes.require("normals",Qr.lu.FINAL,Qr.lu.COMPOSITE,Qr.lu.OPAQUE,Qr.lu.TRANSPARENT,Qr.CM.VIEWSHED,Qr.CM.LASERLINES);return(this.hasSSAO?1:0)+e}_precompilePrepasses(){this._normalsRequired&&this._precompileAllGeometry(Yb.H_.Normal),this._needsDepth&&this._precompileAllGeometry(Yb.H_.Depth),this.shadowsEnabled&&(this._needsShadowHighlight?(this._precompileShadowCascades(Yb.H_.ShadowHighlight),this._precompileShadowCascades(Yb.H_.ShadowExcludeHighlight),this._precompileShadowCascades(Yb.H_.ShadowHighlight)):this._precompileShadowCascades(Yb.H_.Shadow)),this._shadowAccumulator.active&&this._precompileAllGeometry(Yb.H_.Shadow)}_renderNormals(){const e=this._normalsRequired;if(0===e)return;const t=this._framebufferSize,i=this.fboCache.acquire(t.width,t.height,"normals",Md.qz.RGBA8UNORM);i.acquireDepth(Md.qk.DEPTH24_STENCIL8),this._rctx.bindFramebuffer(i.fbo),this._rctx.clearFramebuffer(Uc.AG,!0,!0),this._renderGeometryWithNormals(Yb.H_.Normal);const r=this._nodes.optional("normals",Qr.lu.FINAL,Qr.lu.COMPOSITE,Qr.lu.OPAQUE,Qr.lu.TRANSPARENT,Qr.CM.VIEWSHED);return i.retain(e+r-1),this.performanceInfo.advance(XM.NORMALS),i}_renderSSAO(){const e=this._pluginInput.get("normals");if(!this.hasSSAO||!e)return;const t=this._nodes.produce(Qr.CM.SSAO,this._pluginInput);return this._bindParameters.ssao=t,t&&this.performanceInfo.advance(XM.SSAO),t}_precompileAllGeometry(e){const t=this._renderContext.output;this._renderContext.output=e,this._precompileOpaqueGeometry(),this._precompileTransparentGeometry(),this._plugins.precompile(ew.r.TRANSPARENT_TERRAIN),this._renderContext.output=t}renderAllGeometry(e){this._renderContext.output=e,this._renderOpaqueAndTransparentGeometry(e),this._renderTransparentTerrain()}precompileSlots(e,...t){for(const i of t)this._bindParameters.slot=i,e.precompile(this._renderContext)}precompileOccludedSlots(e,t){for(const i of t)this._renderContext.renderOccludedMask=i,this.precompileSlots(e,...nE);this._renderContext.renderOccludedMask=CM.C}renderSlots(e,...t){for(const i of t)this._bindParameters.slot=i,e.forAll((e=>{const t=e.acquireTechniques(this._renderContext);t&&e.render(this._renderContext,t)}))}renderOccludedSlots(e,t){this._renderContext.renderOccludedMask=t,this.plugins.renderOccludedFlags>Jb.yD.Occlude&&this._plugins.render(ew.r.OCCLUDED_GROUND),this.renderSlots(e,...nE),this._renderContext.renderOccludedMask=CM.C}renderHUD(e){this._bindParameters.hudRenderStyle=e,this._plugins.render(ew.r.HUD_MATERIAL)}precompileViewshedShadowMap(){this._precompileAllGeometry(Yb.H_.ViewshedShadow)}renderViewshedShadowMap(e){const{camera:t,contentCamera:i}=this._bindParameters,r=this._renderContext.output;e.setGLViewport(this._rctx),this._ensureBindParametersCamera(e,e),this.renderAllGeometry(Yb.H_.ViewshedShadow),this._ensureBindParametersCamera(t,i),this._bindParameters.camera.setGLViewport(this._rctx),this._renderContext.output=r}_renderOpaqueAndTransparentGeometry(e){this._renderContext.output=e,this._renderOpaqueGeometry(),this._renderTransparentGeometry()}_renderGeometryWithNormals(e){this._renderContext.output=e,this._plugins.render(...tE),this._renderTransparentTerrain()}_renderGeometryWithoutNormals(e){this._renderContext.output=e,this._plugins.render(...iE)}_precompileOpaqueGeometry(){this._plugins.precompile(...rE)}_renderOpaqueGeometry(){this._plugins.render(...rE)}_renderTransparentGeometry(){this._plugins.render(...sE)}get _hasTransparentTerrain(){return this._plugins.produces(Yb.H_.Color,ew.r.TRANSPARENT_TERRAIN)}_renderTransparentTerrain(){const e=()=>this._plugins.render(ew.r.TRANSPARENT_TERRAIN);if(!(0,Yb.c1)(this._renderContext.output))return void e();const t=this._framebufferSize,i=this.fboCache.acquire(t.width,t.height,"transparent terrain");return this.renderToTargets(e,i,this._framebuffer.depth,Uc.AG),i}get _needsHUDVisibility(){return this._plugins.produces(this._renderContext.output,ew.r.OCCLUSION_PIXELS)}_renderHUDVisibility(){if(!this._needsHUDVisibility)return void(this._bindParameters.hudVisibility=(0,f.RY)(this._bindParameters.hudVisibility));const{width:e,height:t}=this._framebufferSize;let i=this._bindParameters.hudVisibility;i?.fbo?.width===e&&i?.fbo?.height===t||(i?.release(),i=this.fboCache.acquire(e,t,"hud visibility",Md.qz.RGBA4UNORM),this._bindParameters.hudVisibility=i);const r=this._bindParameters.geometryDepth;i.attachDepth(r||this._framebuffer.depth),this._rctx.bindFramebuffer(i.fbo),this._rctx.clearFramebuffer([0,1,0,1]),this._plugins.render(ew.r.OCCLUSION_PIXELS),i.detachDepth(),this._framebuffer.bind(),this.performanceInfo.advance(XM.HUD_VISIBILITY)}_renderLineCallouts(e){if(this._bindParameters.hudRenderStyle=e,e===aT.U.Occluded){const e=()=>this._plugins.render(ew.r.LINE_CALLOUTS),t=this._framebufferSize,i=this.fboCache.acquireDepth(Md.qk.DEPTH16,t.width,t.height,"line callouts");this.renderToTargets(e,this._framebuffer.color,i,void 0,!0,!0),i.release()}else this._plugins.render(ew.r.LINE_CALLOUTS)}_precompileHUD(e){if(this._precompileHUDOutput(e),this._hasHighlights){const t=this._renderContext.output;this._renderContext.output=Yb.H_.Highlight,this._precompileHUDOutput(e),this._renderContext.output=t}}_precompileHUDOutput(e){const t=this._bindParameters.hudRenderStyle;this._bindParameters.hudRenderStyle=e,this._oitEnabled&&(0,Yb.c1)(this._renderContext.output)?(this._bindParameters.oitPass=TS.M.ColorAlpha,this._plugins.precompile(...aE),this._bindParameters.oitPass=TS.M.FrontFace,this._plugins.precompile(...aE),this._bindParameters.oitPass=TS.M.NONE):this._plugins.precompile(...aE),this._bindParameters.hudRenderStyle=t}_renderHUD(e,t,i){if(this._pluginsHas.hudElements){if(this._oitEnabled){const r=this._renderOIT(eE.HUD,i,e);this._rctx.bindFramebuffer(t.fbo),this._compositingHelper.compositePreMultipliedAlpha(this._bindParameters,r.getTexture()),r.release()}else if(this._renderContext.output=i,e===aT.U.Occluded){const t=()=>this._renderHUDElements(e),i=this._framebufferSize,r=this.fboCache.acquireDepth(Md.qk.DEPTH16,i.width,i.height,"hud");this.renderToTargets(t,this._framebuffer.color,r,void 0,!0,!0),r.release()}else t.acquireDepth(Md.qk.DEPTH16),this._rctx.bindFramebuffer(t.fbo),this._renderHUDElements(e),t.detachDepth();this.performanceInfo.advance(e===aT.U.Occluded?XM.HUD_OCCLUDED:XM.HUD)}}_renderHUDElements(e){this._bindParameters.hudRenderStyle=e,this._plugins.render(...aE)}get _needsShadowHighlight(){return this.shadowsEnabled&&this._plugins.produces(Yb.H_.ShadowHighlight,ew.r.OPAQUE_MATERIAL)}_renderHighlightPrepass(){if(!this._hasHighlights)return;const{fboCache:e,_rctx:t,_bindParameters:i}=this,r=this._framebufferSize,{highlights:s}=i,n=e.acquire(r.width,r.height,"highlights",s.length>wT.d1?Md.qz.RG8UINT:Md.qz.R8UINT);n.acquireDepth(Md.qk.DEPTH24_STENCIL8),t.bindFramebuffer(n.fbo);const{gl:a}=t;return a.clearBufferuiv(a.COLOR,0,[0,0,0,0]),this._renderContext.output=Yb.H_.Highlight,t.bindFramebuffer(n.fbo),(0,wT.m7)(t,e,r,i,(()=>this._renderHighlightGeometries())),this.performanceInfo.advance(XM.HIGHLIGHTS),n}_renderHighlightGeometries(){this._plugins.render(...oE),this._rctx.clear(Ir.Hf.DEPTH),this._renderHUDElements(aT.U.Both)}_renderShadowAccumulation(e,t,i){this._shadowAccumulator.updateDepthRange(e),this._shadowAccumulator.accumulating&&this._bindParameters.depth&&this._shadowAccumulator.renderAccumulation(this._bindParameters.depth,t,i)&&this.performanceInfo.advance(XM.ACCUMULATED_SHADOWS)}_precompileTransparentGeometry(){this._oitEnabled&&(0,Yb.c1)(this._renderContext.output)?(this._bindParameters.oitPass=TS.M.ColorAlpha,this._plugins.precompile(...sE),this._bindParameters.oitPass=TS.M.FrontFace,this._plugins.precompile(...sE),this._bindParameters.oitPass=TS.M.NONE):this._plugins.precompile(...sE)}_renderOIT(e,t,i=aT.U.Both){const r=e===eE.HUD,s=this._framebufferSize,n=r?this.fboCache.acquire(s.width,s.height,"oit hud composite"):null,a=r?()=>this._renderHUDElements(i):()=>this._renderTransparentGeometry(),o=this._bindParameters,l=this._renderContext.output;this._renderContext.output=t,o.oitPass=TS.M.ColorAlpha;const c=n?"oit hud color+alpha":"oit color+alpha",h=this.fboCache.acquire(s.width,s.height,c,Md.qz.RGBA16FLOAT),u=t===Yb.H_.ColorEmission;u&&h.acquireColor(Ir.Ml,Md.qz.RGBA16FLOAT,"emissive"),h.acquireColor(u?Ir.FF:Ir.Ml,Md.qz.R16FLOAT),n||h.attachDepth(this._framebuffer.depth),this._rctx.bindFramebuffer(h.fbo),this._rctx.clearFramebuffer([0,0,0,1]),u&&this._rctx.clearBuffer(1,lS.AG),a(),h.detachDepth(),o.oitPass=TS.M.FrontFace;const d=this.fboCache.acquire(s.width,s.height,n?"oit hud front":"oit front");return u&&d.acquireColor(Ir.Ml,Md.qz.RGBA16FLOAT,"emissive"),n?d.acquireDepth(Md.qk.DEPTH16):d.attachDepth(this._framebuffer.depth),this._rctx.bindFramebuffer(d.fbo),this._rctx.clearFramebuffer(Uc.AG,!!n),a(),d.detachDepth(),o.oitPass=TS.M.NONE,n?(this._rctx.bindFramebuffer(n.fbo),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clear(Ir.Hf.COLOR)):this._framebuffer.bind(),this._oitblend??=new WS(this._techniques),this._oitblend.blend(this._rctx,h,d,o,u),n?.detachDepth(),d.release(),h.release(),this._renderContext.output=l,n}_renderOpaque(e){const t=this.plugins.produces(Yb.H_.Color,...rE);if(t){this._plugins.render(ew.r.INTEGRATED_MESH,ew.r.OPAQUE_TERRAIN);const e=this._framebuffer;e.update((e=>this._renderNodes(Qr.CM.OPAQUE_TERRAIN,e))),e.bind(),this._plugins.render(ew.r.OPAQUE_MATERIAL,ew.r.OPAQUE_MATERIAL_WITHOUT_NORMALS)}const i=this._framebuffer;i.update((e=>this._renderNodes(Qr.lu.OPAQUE,e,t))),this.fboCache.debugCallback?.(Qr.lu.OPAQUE,i.color.fbo),i.update((e=>this._renderNodes(Qr.CM.OPAQUE_ENVIRONMENT,e))),this.fboCache.debugCallback?.(Qr.CM.OPAQUE_ENVIRONMENT,i.color.fbo),this._renderTerrainDepth(e),this._renderEdges(GM.i.OPAQUE)}_renderTransparent(e,t,i){const r=this._framebuffer;r.bind(),this._renderPlugins(ew.r.VOXEL,XM.VOXEL),this._renderHiddenTransparentEdges(),e&&(this._oitEnabled?this._renderOIT(eE.Geometry,i):this._renderTransparentGeometry()),r.update((t=>this._renderNodes(Qr.lu.TRANSPARENT,t,e))),this.fboCache.debugCallback?.(Qr.lu.TRANSPARENT,r.color.fbo),this._renderGeometryDepth(t),this._renderHUDVisibility(),t||this._plugins.render(ew.r.LINE_CALLOUTS),this._renderEdges(GM.i.TRANSPARENT);const s=this._hasTransparentTerrain?this._renderTransparentTerrain():null;s&&(this.performanceInfo.advance(XM.TRANSPARENT_TERRAIN),this._bindParameters.hudVisibility&&(t?this._renderLineCallouts(aT.U.Occluded):(this._rctx.bindFramebuffer(this._bindParameters.hudVisibility?.fbo),this._compositingHelper.compositeHUD(this._bindParameters,s.getTexture())),this._renderHUD(aT.U.Occluded,r.color,i))),this._bindParameters.cullAboveTerrain=!1,s&&(r.bind(),this._compositingHelper.compositePreMultipliedAlpha(this._bindParameters,s.getTexture()),s.release(),t&&(this._renderEdges(GM.i.OPAQUE),e&&(this._oitEnabled?this._renderOIT(eE.Geometry,i):this._renderTransparentGeometry(),this.performanceInfo.advance(XM.TRANSPARENT)),this._renderEdges(GM.i.TRANSPARENT))),this._bindParameters.ssao=(0,f.RY)(this._bindParameters.ssao),t&&this._renderLineCallouts(aT.U.NotOccluded),this._bindParameters.terrainDepthTest=!1,this._renderTransparentEnvironment()}_renderTransparentEnvironment(){this._shadowAccumulator.render(this._bindParameters),this.performanceInfo.advance(XM.APPLY_ACCUMULATED_SHADOWS),this._framebuffer.bind(),this._plugins.render(ew.r.TRANSPARENT_MATERIAL_WITHOUT_DEPTH),this.performanceInfo.advance(XM.TRANSPARENT_MATERIAL_WITHOUT_DEPTH)}_renderPlugins(e,t){this._plugins.produces(this._renderContext.output,e)&&(this._plugins.render(e),this.performanceInfo.advance(t))}_renderNodes(e,t,i=!1){if(t.setName(e),this._pluginInput.set(e,t),!this._nodes.produces(e))return i&&this.performanceInfo.advance(e),t;const r=this._nodes.render(t,this._pluginInput,this._releaseNormals);return this.performanceInfo.advance(e),r}_blitFBO(e,t=bS,i=!0){return this._blit??=new lT.N(this._techniques),this._blit.blit(this._rctx,e,t,this._bindParameters),this._pluginInput.set(e.name,t),i&&e.release(),t}_ensureBindParametersCamera(e,t){this._bindParameters.camera=e,this._bindParameters.contentCamera=t}_ensureBindParametersSSR(e){if(this._bindParameters.ssr.lastFrameColor){null==this._ssrEnableTime&&(this._ssrEnableTime=e),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=Mr.Wd:((0,Sr.U_)(cE,this._bindParameters.camera.viewMatrix),(0,Sr.U_)(lE,this._bindParameters.camera.projectionMatrix),(0,Sr.Jp)(hE,cE,lE),(0,Sr.Jp)(hE,this._renderContext.lastFrameCamera.viewMatrix,hE),(0,Sr.Jp)(hE,this._renderContext.lastFrameCamera.projectionMatrix,hE),this._reprojectionMatrix=hE);const t=this.stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=t>0?Math.min(t,e-this._ssrEnableTime)/t:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._reprojectionMatrix=Mr.Wd,this._ssrEnableTime=null}addRenderNode(e){this._nodes.add(e),this._requestRender()}removeRenderNode(e){this._nodes.remove(e),this._requestRender()}updateLighting(e,t,i,r){this._bindParameters.updateLighting(e,t,i,r),this._requestRender(os.Xx.UPDATE)}get usedMemory(){return{fbos:this.fboCache.usedMemory,plugins:this._plugins.usedMemory,edges:this.edgeView?.usedMemory??0}}renderToTargets(e,t,i,r,s=!1,n=!1){t.attachDepth(i),this._rctx.bindFramebuffer(t.fbo),this._rctx.clearFramebuffer(r,s,n),e(),t.detachDepth()}get test(){}};var eE;(0,o._)([(0,x.Cb)({readOnly:!0})],JM.prototype,"fullResolutionAtmosphere",null),(0,o._)([(0,x.Cb)()],JM.prototype,"_edgeView",void 0),(0,o._)([(0,x.Cb)()],JM.prototype,"updating",null),JM=(0,o._)([(0,S.j)("esri.views.3d.webgl-engine.lib.Renderer")],JM),function(e){e[e.Geometry=0]="Geometry",e[e.HUD=1]="HUD"}(eE||(eE={}));const tE=[ew.r.INTEGRATED_MESH,ew.r.OPAQUE_TERRAIN,ew.r.OPAQUE_MATERIAL,ew.r.TRANSPARENT_MATERIAL],iE=[ew.r.OPAQUE_MATERIAL_WITHOUT_NORMALS,ew.r.TRANSPARENT_MATERIAL_WITHOUT_NORMALS],rE=[ew.r.INTEGRATED_MESH,ew.r.OPAQUE_TERRAIN,ew.r.OPAQUE_MATERIAL,ew.r.OPAQUE_MATERIAL_WITHOUT_NORMALS],sE=[ew.r.TRANSPARENT_MATERIAL,ew.r.TRANSPARENT_MATERIAL_WITHOUT_NORMALS],nE=[ew.r.OPAQUE_MATERIAL,ew.r.TRANSPARENT_MATERIAL,ew.r.TRANSPARENT_MATERIAL_WITHOUT_DEPTH],aE=[ew.r.LINE_CALLOUTS_HUD_DEPTH,ew.r.HUD_MATERIAL,ew.r.LABEL_MATERIAL],oE=[ew.r.TRANSPARENT_MATERIAL,ew.r.TRANSPARENT_MATERIAL_WITHOUT_NORMALS,ew.r.OPAQUE_MATERIAL,ew.r.OPAQUE_MATERIAL_WITHOUT_NORMALS,ew.r.TRANSPARENT_TERRAIN,ew.r.INTEGRATED_MESH,ew.r.OPAQUE_TERRAIN],lE=(0,Mr.Ue)(),cE=(0,Mr.Ue)(),hE=(0,Mr.Ue)();function uE(e){return t=>e.immediate.schedule(t)}var dE=i(31214);class pE{constructor(e){this._rctx=e,this._vao=function(e,t=dE.QI,i=Ed.i){const r=new Float32Array([-1,-1,3,-1,-1,3]);return new hs.U(e,i,new Map([["geometry",t]]),new Map([["geometry",us.f.createVertex(e,Ir.l1.STATIC_DRAW,r)]]))}(e)}destroy(){this._vao=(0,f.M2)(this._vao)}draw(){null!=this._vao&&(this._rctx.bindVAO(this._vao),this._rctx.drawArrays(Ir.MX.TRIANGLES,0,3))}get test(){}}class mE{constructor(e,t,i){this._rctx=e,this._locations=t,this._layout=i,this._cache=new zf(e.newCache,"VAOCache")}dispose(){this._cache.destroy()}newVao(e){const t=e.toString();let i=this._cache.pop(t);return i||(i=new hs.U(this._rctx,this._locations,new Map([["geometry",this._layout]]),new Map([["geometry",us.f.createVertex(this._rctx,Ir.l1.STATIC_DRAW)]])),i.vertexBuffers.get("geometry")?.setSize(e),i)}deleteVao(e){if(null==e)return;const t=e.getByteLength("geometry").toString();this._cache.put(t,e)}}class _E{constructor(e){this._rctx=e,this._indexBuffer=this._createIndexbuffer(),this._program=this._createHelperProgram()}static getShaderSources(){return{vertex:"#version 300 es\n    precision highp float;\n\n    void main(void) {\n      gl_Position = vec4(0.0, 0.0, float(gl_VertexID)-2.0, 1.0);\n    }",fragment:"#version 300 es\n    precision highp float;\n\n    out vec4 fragColor;\n\n    void main(void) {\n      fragColor = vec4(0.0, 0.0, 0.0, 1.0);\n    }"}}_createHelperProgram(){const e=_E.getShaderSources();return this._rctx.programCache.acquire(e.vertex,e.fragment,new Map([]))}_createIndexbuffer(){return us.f.createIndex(this._rctx,Ir.l1.STATIC_DRAW,new Uint32Array([0]))}run(){this._program.compiled&&this._indexBuffer&&(this._rctx.bindVAO(null),this._rctx.useProgram(this._program),this._rctx.bindBuffer(this._indexBuffer,Ir.w0.ELEMENT_ARRAY_BUFFER),this._rctx.drawElements(Ir.MX.POINTS,1,Ir.g.UNSIGNED_INT,0))}dispose(){this._program.dispose(),this._indexBuffer.dispose()}get test(){}}class fE{constructor(){this.blend=!1,this.blendColor={r:0,g:0,b:0,a:0},this.blendFunction={srcRGB:Ir.zi.ONE,dstRGB:Ir.zi.ZERO,srcAlpha:Ir.zi.ONE,dstAlpha:Ir.zi.ZERO},this.blendEquation={mode:Ir.db.ADD,modeAlpha:Ir.db.ADD},this.colorMask={r:!0,g:!0,b:!0,a:!0},this.faceCulling=!1,this.cullFace=Ir.LR.BACK,this.frontFace=Ir.Wf.CCW,this.scissorTest=!1,this.scissorRect={x:0,y:0,width:0,height:0},this.depthTest=!1,this.depthFunction=Ir.wb.LESS,this.clearDepth=1,this.depthWrite=!0,this.depthRange={zNear:0,zFar:1},this.viewport=null,this.stencilTest=!1,this.polygonOffsetFill=!1,this.polygonOffset=[0,0],this.stencilFunction={face:Ir.LR.FRONT_AND_BACK,func:Ir.wb.ALWAYS,ref:0,mask:1},this.clearStencil=0,this.stencilWriteMask=1,this.stencilOperation={face:Ir.LR.FRONT_AND_BACK,fail:Ir.xS.KEEP,zFail:Ir.xS.KEEP,zPass:Ir.xS.KEEP},this.clearColor={r:0,g:0,b:0,a:0},this.program=null,this.vertexBuffer=null,this.indexBuffer=null,this.uniformBuffer=null,this.pixelPackBuffer=null,this.pixelUnpackBuffer=null,this.copyReadBuffer=null,this.copyWriteBuffer=null,this.transformFeedbackBuffer=null,this.uniformBufferBindingPoints=new Array,this.transformBufferBindingPoints=new Array,this.readFramebuffer=null,this.drawFramebuffer=null,this.drawBuffers={defaultFramebuffer:[Ir.Xg.BACK],fbos:new WeakMap},this.renderbuffer=null,this.activeTexture=0,this.textureUnitMap=new Array,this.vertexArrayObject=null}}class gE{constructor(e){this._objectType=e,this._active=new Map}get _stack(){const e=(new Error).stack.split("\n");return e.shift(),e.shift(),e.shift(),e.join("\n")}add(e){this._active.set(e,new yE(this._stack))}remove(e){this._active.delete(e)}addReference(e){const t=this._active.get(e);t&&t.retains.push(this._stack)}removeReference(e){const t=this._active.get(e);t&&t.releases.push(this._stack)}resetLog(){const e=new Map;let t="";this._active.forEach(((i,{usedMemory:r})=>{e.has(i.from)||(e.set(i.from,new Map),i.retains.length>0&&(t+=`  First reference count mismatch:\n  Retain:\n    ${i.retains.join("\n\n    ")}\n\n  Release:    ${i.releases.join("\n\n    ")}\n`));const s=e.get(i.from);s.set(r??0,s.get(r??0)??1)})),this._active.clear();let i=0;const r=new Array;return e.forEach(((e,t)=>{let s=0;e.forEach(((e,t)=>s+=e*t)),e.set(-1,s),i+=s,r.push([t,e])})),e.clear(),r.sort(((e,t)=>t[1].get(-1)-e[1].get(-1))),r.reduce(((e,[t,i])=>{const r=Math.round(i.get(-1)/1024);return i.delete(-1),e+`  ${r}KB from ${Array.from(i.values()).reduce(((e,t)=>e+t),0)} allocations at ${t}\n`}),`Total ${this._objectType} memory: ${Math.round(i/1024)}KB\n${t}`)}}class yE{constructor(e){this.from=e,this.retains=new Array,this.releases=new Array}}const vE=!1;class bE{constructor(){for(this._current=new Array,this._allocations=vE?new gE("WebGLObject"):null;this._current.length<Ir._g.COUNT;)this._current.push(0)}increment(e,t,i=1){this._current[e]+=i,this._allocations?.add(t)}decrement(e,t,i=1){this._current[e]-=i,this._allocations?.remove(t)}get current(){return this._current}get total(){return this.current.reduce(((e,t,i)=>e+(i<Ir._g.UNCOUNTED?t:0)),0)}get resourceInformation(){let e="";if(this.total>0){e+="Live objects:\n";for(let t=0;t<Ir._g.COUNT;++t){const i=this._current[t];i>0&&(e+=`${Ir._g[t]}: ${i}\n`)}}return e+=this._allocations?.resetLog(),e}}class wE{constructor(e,t,i){const r=t.textureFilterAnisotropic;this.versionString=e.getParameter(e.VERSION),this.maxVertexTextureImageUnits=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.maxVertexAttributes=e.getParameter(e.MAX_VERTEX_ATTRIBS);const s=i.maxAnisotropy??1/0;this.maxMaxAnisotropy=r?Math.min(e.getParameter(r.MAX_TEXTURE_MAX_ANISOTROPY),s):1,this.maxTextureImageUnits=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.maxPreferredTexturePixels=i.maxPreferredTexturePixels??1/0,this.maxRenderbufferSize=e.getParameter(e.MAX_RENDERBUFFER_SIZE),this.maxViewportDims=e.getParameter(e.MAX_VIEWPORT_DIMS),this.maxUniformBufferBindings=e.getParameter(e.MAX_UNIFORM_BUFFER_BINDINGS),this.maxVertexUniformBlocks=e.getParameter(e.MAX_VERTEX_UNIFORM_BLOCKS),this.maxFragmentUniformBlocks=e.getParameter(e.MAX_FRAGMENT_UNIFORM_BLOCKS),this.maxUniformBlockSize=e.getParameter(e.MAX_UNIFORM_BLOCK_SIZE),this.uniformBufferOffsetAlignment=e.getParameter(e.UNIFORM_BUFFER_OFFSET_ALIGNMENT),this.maxArrayTextureLayers=e.getParameter(e.MAX_ARRAY_TEXTURE_LAYERS),this.maxSamples=e.getParameter(e.MAX_SAMPLES),this.maxDrawBuffers=e.getParameter(e.MAX_DRAW_BUFFERS)}}const CE=["layout","centroid","smooth","case","mat2x2","mat2x3","mat2x4","mat3x2","mat3x3","mat3x4","mat4x2","mat4x3","mat4x4","uint","uvec2","uvec3","uvec4","samplerCubeShadow","sampler2DArray","sampler2DArrayShadow","isampler2D","isampler3D","isamplerCube","isampler2DArray","usampler2D","usampler3D","usamplerCube","usampler2DArray","coherent","restrict","readonly","writeonly","resource","atomic_uint","noperspective","patch","sample","subroutine","common","partition","active","filter","image1D","image2D","image3D","imageCube","iimage1D","iimage2D","iimage3D","iimageCube","uimage1D","uimage2D","uimage3D","uimageCube","image1DArray","image2DArray","iimage1DArray","iimage2DArray","uimage1DArray","uimage2DArray","image1DShadow","image2DShadow","image1DArrayShadow","image2DArrayShadow","imageBuffer","iimageBuffer","uimageBuffer","sampler1DArray","sampler1DArrayShadow","isampler1D","isampler1DArray","usampler1D","usampler1DArray","isampler2DRect","usampler2DRect","samplerBuffer","isamplerBuffer","usamplerBuffer","sampler2DMS","isampler2DMS","usampler2DMS","sampler2DMSArray","isampler2DMSArray","usampler2DMSArray","trunc","round","roundEven","isnan","isinf","floatBitsToInt","floatBitsToUint","intBitsToFloat","uintBitsToFloat","packSnorm2x16","unpackSnorm2x16","packUnorm2x16","unpackUnorm2x16","packHalf2x16","unpackHalf2x16","outerProduct","transpose","determinant","inverse","texture","textureSize","textureProj","textureLod","textureOffset","texelFetch","texelFetchOffset","textureProjOffset","textureLodOffset","textureProjLod","textureProjLodOffset","textureGrad","textureGradOffset","textureProjGrad","textureProjGradOffset"],xE=!1,TE=["precision","highp","mediump","lowp","attribute","const","uniform","varying","break","continue","do","for","while","if","else","in","out","inout","float","int","void","bool","true","false","discard","return","mat2","mat3","mat4","vec2","vec3","vec4","ivec2","ivec3","ivec4","uvec2","uvec3","uvec4","bvec2","bvec3","bvec4","sampler1D","sampler2D","sampler3D","usampler1D","usampler2D","usampler3D","samplerCube","sampler1DShadow","sampler2DShadow","struct","asm","class","union","enum","typedef","template","this","packed","goto","switch","default","inline","noinline","volatile","public","static","extern","external","interface","long","short","double","half","fixed","unsigned","input","output","hvec2","hvec3","hvec4","dvec2","dvec3","dvec4","fvec2","fvec3","fvec4","sampler2DRect","sampler3DRect","sampler2DRectShadow","sizeof","cast","namespace","using"],SE=["<<=",">>=","++","--","<<",">>","<=",">=","==","!=","&&","||","+=","-=","*=","/=","%=","&=","^^","^=","|=","(",")","[","]",".","!","~","*","/","%","+","-","<",">","&","^","|","?",":","=",",",";","{","}"],ME=["abs","acos","all","any","asin","atan","ceil","clamp","cos","cross","dFdx","dFdy","degrees","distance","dot","equal","exp","exp2","faceforward","floor","fract","gl_BackColor","gl_BackLightModelProduct","gl_BackLightProduct","gl_BackMaterial","gl_BackSecondaryColor","gl_ClipPlane","gl_ClipVertex","gl_Color","gl_DepthRange","gl_DepthRangeParameters","gl_EyePlaneQ","gl_EyePlaneR","gl_EyePlaneS","gl_EyePlaneT","gl_Fog","gl_FogCoord","gl_FogFragCoord","gl_FogParameters","gl_FragColor","gl_FragCoord","gl_FragData","gl_FragDepth","gl_FragDepthEXT","gl_FrontColor","gl_FrontFacing","gl_FrontLightModelProduct","gl_FrontLightProduct","gl_FrontMaterial","gl_FrontSecondaryColor","gl_LightModel","gl_LightModelParameters","gl_LightModelProducts","gl_LightProducts","gl_LightSource","gl_LightSourceParameters","gl_MaterialParameters","gl_MaxClipPlanes","gl_MaxCombinedTextureImageUnits","gl_MaxDrawBuffers","gl_MaxFragmentUniformComponents","gl_MaxLights","gl_MaxTextureCoords","gl_MaxTextureImageUnits","gl_MaxTextureUnits","gl_MaxVaryingFloats","gl_MaxVertexAttribs","gl_MaxVertexTextureImageUnits","gl_MaxVertexUniformComponents","gl_ModelViewMatrix","gl_ModelViewMatrixInverse","gl_ModelViewMatrixInverseTranspose","gl_ModelViewMatrixTranspose","gl_ModelViewProjectionMatrix","gl_ModelViewProjectionMatrixInverse","gl_ModelViewProjectionMatrixInverseTranspose","gl_ModelViewProjectionMatrixTranspose","gl_MultiTexCoord0","gl_MultiTexCoord1","gl_MultiTexCoord2","gl_MultiTexCoord3","gl_MultiTexCoord4","gl_MultiTexCoord5","gl_MultiTexCoord6","gl_MultiTexCoord7","gl_Normal","gl_NormalMatrix","gl_NormalScale","gl_ObjectPlaneQ","gl_ObjectPlaneR","gl_ObjectPlaneS","gl_ObjectPlaneT","gl_Point","gl_PointCoord","gl_PointParameters","gl_PointSize","gl_Position","gl_ProjectionMatrix","gl_ProjectionMatrixInverse","gl_ProjectionMatrixInverseTranspose","gl_ProjectionMatrixTranspose","gl_SecondaryColor","gl_TexCoord","gl_TextureEnvColor","gl_TextureMatrix","gl_TextureMatrixInverse","gl_TextureMatrixInverseTranspose","gl_TextureMatrixTranspose","gl_Vertex","greaterThan","greaterThanEqual","inversesqrt","length","lessThan","lessThanEqual","log","log2","matrixCompMult","max","min","mix","mod","normalize","not","notEqual","pow","radians","reflect","refract","sign","sin","smoothstep","sqrt","step","tan","texture2D","texture2DLod","texture2DProj","texture2DProjLod","textureCube","textureCubeLod","texture2DLodEXT","texture2DProjLodEXT","textureCubeLodEXT","texture2DGradEXT","texture2DProjGradEXT","textureCubeGradEXT","textureSize","texelFetch"];var EE=999,RE=["block-comment","line-comment","preprocessor","operator","integer","float","ident","builtin","keyword","whitespace","eof","integer"];function PE(){var e,t,i,r=0,s=0,n=EE,a=[],o=[],l=1,c=0,h=0,u=!1,d=!1,p="";return function(e){return o=[],null!==e?_(e.replace?e.replace(/\r\n/g,"\n"):e):(a.length&&m(a.join("")),n=10,m("(eof)"),o)};function m(e){e.length&&o.push({type:RE[n],data:e,position:h,line:l,column:c})}function _(t){var a;for(r=0,i=(p+=t).length;e=p[r],r<i;){switch(a=r,n){case 0:r=v();break;case 1:case 2:r=y();break;case 3:r=b();break;case 4:r=x();break;case 11:r=C();break;case 5:r=T();break;case 9999:r=S();break;case 9:r=g();break;case EE:r=f()}a!==r&&("\n"===p[a]?(c=0,++l):++c)}return s+=r,p=p.slice(r),o}function f(){return a=a.length?[]:a,"/"===t&&"*"===e?(h=s+r-1,n=0,t=e,r+1):"/"===t&&"/"===e?(h=s+r-1,n=1,t=e,r+1):"#"===e?(n=2,h=s+r,r):/\s/.test(e)?(n=9,h=s+r,r):(u=/\d/.test(e),d=/[^\w_]/.test(e),h=s+r,n=u?4:d?3:9999,r)}function g(){return/[^\s]/g.test(e)?(m(a.join("")),n=EE,r):(a.push(e),t=e,r+1)}function y(){return"\r"!==e&&"\n"!==e||"\\"===t?(a.push(e),t=e,r+1):(m(a.join("")),n=EE,r)}function v(){return"/"===e&&"*"===t?(a.push(e),m(a.join("")),n=EE,r+1):(a.push(e),t=e,r+1)}function b(){if("."===t&&/\d/.test(e))return n=5,r;if("/"===t&&"*"===e)return n=0,r;if("/"===t&&"/"===e)return n=1,r;if("."===e&&a.length){for(;w(a););return n=5,r}if(";"===e||")"===e||"("===e){if(a.length)for(;w(a););return m(e),n=EE,r+1}var i=2===a.length&&"="!==e;if(/[\w_\d\s]/.test(e)||i){for(;w(a););return n=EE,r}return a.push(e),t=e,r+1}function w(e){for(var t,i,r=0;;){if(t=SE.indexOf(e.slice(0,e.length+r).join("")),i=SE[t],-1===t){if(r--+e.length>0)continue;i=e.slice(0,1).join("")}return m(i),h+=i.length,(a=a.slice(i.length)).length}}function C(){return/[^a-fA-F0-9]/.test(e)?(m(a.join("")),n=EE,r):(a.push(e),t=e,r+1)}function x(){return"."===e||/[eE]/.test(e)?(a.push(e),n=5,t=e,r+1):"x"===e&&1===a.length&&"0"===a[0]?(n=11,a.push(e),t=e,r+1):/[^\d]/.test(e)?(m(a.join("")),n=EE,r):(a.push(e),t=e,r+1)}function T(){return"f"===e&&(a.push(e),t=e,r+=1),/[eE]/.test(e)||"-"===e&&/[eE]/.test(t)?(a.push(e),t=e,r+1):/[^\d]/.test(e)?(m(a.join("")),n=EE,r):(a.push(e),t=e,r+1)}function S(){if(/[^\d\w_]/.test(e)){var i=a.join("");return n=TE.indexOf(i)>-1?8:ME.indexOf(i)>-1?7:6,m(a.join("")),n=EE,r}return a.push(e),t=e,r+1}}function AE(e){return function(e){var t=PE(),i=[];return(i=i.concat(t(e))).concat(t(null))}(e)}const OE=new Set(["GL_OES_standard_derivatives","GL_EXT_frag_depth","GL_EXT_draw_buffers","GL_EXT_shader_texture_lod"]);function DE(e,t){for(let i=t-1;i>=0;i--){const t=e[i];if("whitespace"!==t.type&&"block-comment"!==t.type){if("keyword"!==t.type)break;if("attribute"===t.data||"in"===t.data)return!0}}return!1}function IE(e,t,i,r){r=r||i;for(const s of e)if("ident"===s.type&&s.data===i)return r in t?t[r]++:t[r]=0,IE(e,t,r+"_"+t[r],r);return i}function LE(e,t,i="afterVersion"){function r(e,t){for(let i=t;i<e.length;i++){const t=e[i];if("operator"===t.type&&";"===t.data)return i}return null}const s={data:"\n",type:"whitespace"},n=t=>t<e.length&&/[^\r\n]$/.test(e[t].data);let a=function(e){let t=-1,s=0,n=-1;for(let a=0;a<e.length;a++){const o=e[a];if("preprocessor"===o.type&&(/#(if|ifdef|ifndef)\s+.+/.test(o.data)?++s:/#endif\s*.*/.test(o.data)&&--s),"afterVersion"!==i&&"afterPrecision"!==i||"preprocessor"===o.type&&o.data.startsWith("#version")&&(n=Math.max(n,a)),"afterPrecision"===i&&"keyword"===o.type&&"precision"===o.data){const t=r(e,a);if(null===t)throw new Error("precision statement not followed by any semicolons!");n=Math.max(n,t)}t<n&&0===s&&(t=a)}return t+1}(e);n(a-1)&&e.splice(a++,0,s);for(const i of t)e.splice(a++,0,i);n(a-1)&&n(a)&&e.splice(a,0,s)}function FE(e,t,i,r="lowp"){LE(e,[{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:r},{type:"whitespace",data:" "},{type:"keyword",data:i},{type:"whitespace",data:" "},{type:"ident",data:t},{type:"operator",data:";"}],"afterPrecision")}function NE(e,t,i,r,s="lowp"){LE(e,[{type:"keyword",data:"layout"},{type:"operator",data:"("},{type:"keyword",data:"location"},{type:"whitespace",data:" "},{type:"operator",data:"="},{type:"whitespace",data:" "},{type:"integer",data:r.toString()},{type:"operator",data:")"},{type:"whitespace",data:" "},{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:s},{type:"whitespace",data:" "},{type:"keyword",data:i},{type:"whitespace",data:" "},{type:"ident",data:t},{type:"operator",data:";"}],"afterPrecision")}function UE(e,t){let i,r,s=-1;for(let n=t;n<e.length;n++){const t=e[n];if("operator"===t.type&&("["===t.data&&(i=n),"]"===t.data)){r=n;break}"integer"===t.type&&(s=parseInt(t.data,10))}return i&&r&&e.splice(i,r-i+1),s}function HE(e,t){if(e.startsWith("#version 300"))return e;const i=function(e){return xE?VE.get(e):null}(e);if(null!=i)return i;const r=AE(e);if("300 es"===function(e,t="100",i="300 es"){const r=/^\s*#version\s+([0-9]+(\s+[a-zA-Z]+)?)\s*/;for(const s of e)if("preprocessor"===s.type){const e=r.exec(s.data);if(e){const r=e[1].replaceAll(/\s{2,}/g," ");if(r===i)return r;if(r===t)return s.data="#version "+i,t;throw new Error("unknown glsl version: "+r)}}return e.splice(0,0,{type:"preprocessor",data:"#version "+i},{type:"whitespace",data:"\n"}),null}(r,"100","300 es"))return e;let s=null,n=null;const a={},o={};for(let e=0;e<r.length;++e){const i=r[e];switch(i.type){case"keyword":t===Ir.Ho.VERTEX_SHADER&&"attribute"===i.data?i.data="in":"varying"===i.data&&(i.data=t===Ir.Ho.VERTEX_SHADER?"out":"in");break;case"builtin":if(/^texture(2D|Cube)(Proj)?(Lod|Grad)?(EXT)?$/.test(i.data.trim())&&(i.data=i.data.replaceAll(/(2D|Cube|EXT)/g,"")),t===Ir.Ho.FRAGMENT_SHADER&&"gl_FragColor"===i.data&&(s||(s=IE(r,a,"fragColor"),FE(r,s,"vec4")),i.data=s),t===Ir.Ho.FRAGMENT_SHADER&&"gl_FragData"===i.data){const t=UE(r,e+1),s=IE(r,a,"fragData");NE(r,s,"vec4",t,"mediump"),i.data=s}else t===Ir.Ho.FRAGMENT_SHADER&&"gl_FragDepthEXT"===i.data&&(n||(n=IE(r,a,"gl_FragDepth")),i.data=n);break;case"ident":if(CE.includes(i.data)){if(t===Ir.Ho.VERTEX_SHADER&&DE(r,e))throw new Error("attribute in vertex shader uses a name that is a reserved word in glsl 300 es");i.data in o||(o[i.data]=IE(r,a,i.data)),i.data=o[i.data]}}}for(let e=r.length-1;e>=0;--e){const t=r[e];if("preprocessor"===t.type){const i=t.data.match(/#extension\s+(.*):/);if(i?.[1]&&OE.has(i[1].trim())){const t=r[e+1];r.splice(e,t&&"whitespace"===t.type?2:1)}const s=t.data.match(/#ifdef\s+(.*)/);s?.[1]&&OE.has(s[1].trim())&&(t.data="#if 1");const n=t.data.match(/#ifndef\s+(.*)/);n?.[1]&&OE.has(n[1].trim())&&(t.data="#if 0")}}return function(e,t){return xE&&VE.set(e,t),t}(e,function(e){return e.map((e=>"eof"!==e.type?e.data:"")).join("")}(r))}const VE=new Map;class kE{constructor(e,t,i,r,s=new Map,n=[]){this._context=e,this._locations=r,this._uniformBlockBindings=s,this._transformFeedbackVaryings=n,this._refCount=1,this._compiled=!1,this._linesOfCode=0,this._nameToUniformLocation=new Map,this._nameToUniform1=new Map,this._nameToUniform1v=new Map,this._nameToUniform2=new Map,this._nameToUniform3=new Map,this._nameToUniform4=new Map,this._nameToUniformMatrix3=new Map,this._nameToUniformMatrix4=new Map,e||console.error("RenderingContext isn't initialized!"),0===t.length&&console.error("Shaders source should not be empty!"),t=HE(t,Ir.Ho.VERTEX_SHADER),i=HE(i,Ir.Ho.FRAGMENT_SHADER),this._vShader=BE(this._context,Ir.Ho.VERTEX_SHADER,t),this._fShader=BE(this._context,Ir.Ho.FRAGMENT_SHADER,i),GE.enabled&&(this._linesOfCode=t.match(/\n/g).length+i.match(/\n/g).length+2,this._context.instanceCounter.increment(Ir._g.LinesOfCode,this._vShader,this._linesOfCode)),this._vShader&&this._fShader||console.error("Error loading shaders!"),this._context.instanceCounter.increment(Ir._g.Shader,this),(0,kS.CG)()&&(this.vertexShader=t,this.fragmentShader=i),this.usedMemory=t.length+i.length;const a=this._context.gl,o=a.createProgram();a.attachShader(o,this._vShader),a.attachShader(o,this._fShader),this._locations.forEach(((e,t)=>a.bindAttribLocation(o,e,t))),this._transformFeedbackVaryings?.length&&a.transformFeedbackVaryings(o,this._transformFeedbackVaryings,a.SEPARATE_ATTRIBS),a.linkProgram(o),(0,kS.CG)()&&!a.getProgramParameter(o,a.LINK_STATUS)&&console.error(`Could not link shader\nvalidated: ${a.getProgramParameter(o,a.VALIDATE_STATUS)}, gl error ${a.getError()}, vertex: ${a.getShaderParameter(this._vShader,a.COMPILE_STATUS)}, fragment: ${a.getShaderParameter(this._fShader,a.COMPILE_STATUS)}, info log: ${a.getProgramInfoLog(o)}, vertex source: ${this.vertexShader}, fragment source: ${this.fragmentShader}`);for(const[e,t]of this._uniformBlockBindings){const i=a.getUniformBlockIndex(o,e);i<4294967295&&a.uniformBlockBinding(o,i,t)}this._glName=o,this._context.instanceCounter.increment(Ir._g.Program,this)}get glName(){return this._glName}get hasGLName(){return null!=this._glName}get hasTransformFeedbackVaryings(){return!!this._transformFeedbackVaryings?.length}get compiled(){return!!this._compiled||(this._context.capabilities.parallelShaderCompile&&null!=this.glName?(this._compiled=!!this._context.gl.getProgramParameter(this.glName,Ir.hj.COMPLETION_STATUS_KHR),this._compiled):(this._compiled=!0,!0))}dispose(){if(--this._refCount>0)return;const e=this._context.gl,t=this._context.instanceCounter;this._nameToUniformLocation.forEach((e=>e&&t.decrement(Ir._g.Uniform,e))),this._nameToUniformLocation.clear(),this._vShader&&(this._linesOfCode>0&&(t.decrement(Ir._g.LinesOfCode,this._vShader,this._linesOfCode),this._linesOfCode=0),e.deleteShader(this._vShader),this._vShader=null,t.decrement(Ir._g.Shader,this)),this._fShader&&(e.deleteShader(this._fShader),this._fShader=null),this._glName&&(e.deleteProgram(this._glName),this._glName=null,t.decrement(Ir._g.Program,this))}ref(){++this._refCount}_getUniformLocation(e){const t=this._nameToUniformLocation.get(e);if(void 0!==t)return t;if(this.glName){const t=this._context.gl.getUniformLocation(this.glName,e);return this._nameToUniformLocation.set(e,t),t&&this._context.instanceCounter.increment(Ir._g.Uniform,t),t}return null}hasUniform(e){return null!=this._getUniformLocation(e)}setUniform1i(e,t){qE(t);const i=this._nameToUniform1.get(e);void 0!==i&&t===i||(this._context.gl.uniform1i(this._getUniformLocation(e),t),this._nameToUniform1.set(e,t))}setUniform1iv(e,t){ZE(t),zE(this._nameToUniform1v,e,t)&&this._context.gl.uniform1iv(this._getUniformLocation(e),t)}setUniform2iv(e,t){ZE(t),zE(this._nameToUniform2,e,t)&&this._context.gl.uniform2iv(this._getUniformLocation(e),t)}setUniform3iv(e,t){ZE(t),zE(this._nameToUniform3,e,t)&&this._context.gl.uniform3iv(this._getUniformLocation(e),t)}setUniform4iv(e,t){ZE(t),zE(this._nameToUniform4,e,t)&&this._context.gl.uniform4iv(this._getUniformLocation(e),t)}setUniform1f(e,t){qE(t);const i=this._nameToUniform1.get(e);void 0!==i&&t===i||(this._context.gl.uniform1f(this._getUniformLocation(e),t),this._nameToUniform1.set(e,t))}setUniform1fv(e,t){ZE(t),zE(this._nameToUniform1v,e,t)&&this._context.gl.uniform1fv(this._getUniformLocation(e),t)}setUniform2f(e,t,i){qE(t,i);const r=this._nameToUniform2.get(e);void 0===r?(this._context.gl.uniform2f(this._getUniformLocation(e),t,i),this._nameToUniform2.set(e,[t,i])):t===r[0]&&i===r[1]||(this._context.gl.uniform2f(this._getUniformLocation(e),t,i),r[0]=t,r[1]=i)}setUniform2fv(e,t){ZE(t),zE(this._nameToUniform2,e,t)&&this._context.gl.uniform2fv(this._getUniformLocation(e),t)}setUniform3f(e,t,i,r){qE(t,i,r);const s=this._nameToUniform3.get(e);void 0===s?(this._context.gl.uniform3f(this._getUniformLocation(e),t,i,r),this._nameToUniform3.set(e,[t,i,r])):t===s[0]&&i===s[1]&&r===s[2]||(this._context.gl.uniform3f(this._getUniformLocation(e),t,i,r),s[0]=t,s[1]=i,s[2]=r)}setUniform3fv(e,t){ZE(t);const i=this._getUniformLocation(e);null!=i&&zE(this._nameToUniform3,e,t)&&this._context.gl.uniform3fv(i,t)}setUniform4f(e,t,i,r,s){qE(t,i,r,s);const n=this._nameToUniform4.get(e);void 0===n?(this._context.gl.uniform4f(this._getUniformLocation(e),t,i,r,s),this._nameToUniform4.set(e,[t,i,r,s])):void 0!==n&&t===n[0]&&i===n[1]&&r===n[2]&&s===n[3]||(this._context.gl.uniform4f(this._getUniformLocation(e),t,i,r,s),n[0]=t,n[1]=i,n[2]=r,n[3]=s)}setUniform4fv(e,t){ZE(t);const i=this._getUniformLocation(e);null!=i&&zE(this._nameToUniform4,e,t)&&this._context.gl.uniform4fv(i,t)}setUniformMatrix3fv(e,t,i=!1){ZE(t);const r=this._getUniformLocation(e);null!=r&&zE(this._nameToUniformMatrix3,e,t)&&this._context.gl.uniformMatrix3fv(r,i,t)}setUniformMatrix4fv(e,t,i=!1){ZE(t);const r=this._getUniformLocation(e);null!=r&&zE(this._nameToUniformMatrix4,e,t)&&this._context.gl.uniformMatrix4fv(r,i,t)}stop(){}}function BE(e,t,i){const r=e.gl,s=r.createShader(t);return r.shaderSource(s,i),r.compileShader(s),(0,kS.CG)()&&!r.getShaderParameter(s,r.COMPILE_STATUS)&&(console.error("Compile error in ".concat(t===Ir.Ho.VERTEX_SHADER?"vertex":"fragment"," shader")),console.error(r.getShaderInfoLog(s)),console.error(function(e){let t=2;return e.replaceAll("\n",(()=>"\n"+function(e){return e>=1e3?e.toString():("  "+e).slice(-3)}(t++)+":"))}(i))),s}function zE(e,t,i){const r=e.get(t);if(!r)return e.set(t,Array.from(i)),!0;const s=i.length;if(r.length!==s)return e.set(t,Array.from(i)),!0;for(let e=0;e<s;++e){const t=i[e];if(r[e]!==t){for(r[e]=t;e<s;++e)r[e]=i[e];return!0}}return!1}const GE={enabled:!1},qE=(0,kS.hZ)()?(...e)=>ZE(e):()=>{},ZE=(0,kS.hZ)()?e=>{const t=e.length;for(let i=0;i<t;++i){const t=e[i];Number.isNaN(t)&&console.error(`Got ${t} as uniform value from ${(new Error).stack}`)}}:()=>{};class jE{constructor(e){this._rctx=e,this._store=new Vw.r}dispose(){this._store.forAll((e=>e.dispose())),this._store.clear()}acquire(e,t,i,r){const s=this._store.get(e,t);if(null!=s)return s.ref(),s;const n=new kE(this._rctx,e,t,i,r);return n.ref(),this._store.set(e,t,n),n}get test(){}}var WE=i(48857);class $E{constructor(){this._result=!1}dispose(){this._program=(0,f.M2)(this._program)}get result(){return null!=this._program&&(this._result=this._test(this._program),this.dispose()),this._result}}class XE extends $E{constructor(e){super(),this._rctx=e,this._helperProgram=null,(0,m.Z)("mac")&&(0,m.Z)("chrome")&&(this._program=this._prepareProgram(),this._helperProgram=this._prepareHelperProgram())}dispose(){super.dispose(),this._helperProgram?.dispose(),this._helperProgram=null}_test(e){const t=this._rctx,i=t.getBoundFramebufferObject(),{x:r,y:s,width:n,height:a}=t.getViewport();t.resetState();const o=new Br.X(1);o.wrapMode=Ir.e8.CLAMP_TO_EDGE,o.samplingMode=Ir.cw.NEAREST;const l=new kr.X(t,o),c=us.f.createIndex(this._rctx,Ir.l1.STATIC_DRAW,new Uint8Array([0]));t.bindFramebuffer(l),t.setViewport(0,0,1,1),t.useProgram(this._helperProgram),t.bindBuffer(c,Ir.w0.ELEMENT_ARRAY_BUFFER),t.drawElements(Ir.MX.POINTS,1,Ir.g.UNSIGNED_BYTE,0),t.useProgram(e),t.bindVAO(null),t.drawArrays(Ir.MX.TRIANGLES,0,258);const h=new Uint8Array(4);return l.readPixels(0,0,1,1,Ir.VI.RGBA,Ir.Br.UNSIGNED_BYTE,h),t.setViewport(r,s,n,a),t.bindFramebuffer(i),l.dispose(),c.dispose(),255===h[0]}_prepareProgram(){const e=`#version 300 es\n    precision highp float;\n\n    out float triangleId;\n\n    const vec3 triangleVertices[3] = vec3[3](vec3(-0.5, -0.5, 0.0), vec3(0.5, -0.5, 0.0), vec3(0.0, 0.5, 0.0));\n\n    void main(void) {\n      triangleId = floor(float(gl_VertexID)/3.0);\n\n      vec3 position = triangleVertices[gl_VertexID % 3];\n      float offset = triangleId / ${WE.H.float(85)};\n      position.z = 0.5 - offset;\n\n      gl_Position = vec4(position, 1.0);\n    }\n    `,t=`#version 300 es\n    precision highp float;\n\n    in float triangleId;\n\n    out vec4 fragColor;\n\n    void main(void) {\n      fragColor = triangleId == ${WE.H.float(85)} ? vec4(0.0, 1.0, 0.0, 1.0) : vec4(1.0, 0.0, 0.0, 1.0);\n    }\n    `;return this._rctx.programCache.acquire(e,t,new Map([]))}_prepareHelperProgram(){const e=_E.getShaderSources();return this._rctx.programCache.acquire(e.vertex,e.fragment,new Map([]))}}var YE=i(31442);class QE extends $E{constructor(e){if(super(),this._rctx=e,!e.gl)return;if(!e.capabilities.colorBufferFloat?.textureFloat||!e.capabilities.colorBufferFloat?.floatBlend)return;this._program=e.programCache.acquire("\n    precision highp float;\n    attribute vec2 a_pos;\n\n    void main() {\n      gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);\n    }\n    ","\n     precision highp float;\n\n     void main() {\n      gl_FragColor = vec4(0.5, 0.5, 0.5, 0.5);\n     }\n    ",new Map([["a_pos",0]]))}_test(e){const t=this._rctx,i=new Br.X(1);i.wrapMode=Ir.e8.CLAMP_TO_EDGE,i.dataType=Ir.Br.FLOAT,i.internalFormat=Ir.lP.RGBA32F,i.samplingMode=Ir.cw.NEAREST;const r=new kr.X(t,i),s=us.f.createVertex(t,Ir.l1.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),n=new qx.U(t,new Map([["a_pos",0]]),new Map([["geometry",[new YE.G("a_pos",2,Ir.g.UNSIGNED_SHORT,0,4)]]]),new Map([["geometry",s]]));t.gl.getError(),t.useProgram(e);const a=t.getBoundFramebufferObject(),{x:o,y:l,width:c,height:h}=t.getViewport();t.bindFramebuffer(r),t.setViewport(0,0,1,1),t.bindVAO(n),t.drawArrays(Ir.MX.TRIANGLE_STRIP,0,4);const u=(0,Lr.sm)({blending:Lr._x});t.setPipelineState(u),t.drawArrays(Ir.MX.TRIANGLE_STRIP,0,4);const d=t.gl.getError();return t.setViewport(o,l,c,h),t.bindFramebuffer(a),n.dispose(),r.dispose(),d!==Ir.mA.INVALID_OPERATION||(console.warn("Device claims support for WebGL extension EXT_float_blend but does not support it. Using fall back."),!1)}}new Map([["geometry",[new YE.G("a_pos",2,Ir.g.BYTE,0,2)]]]),new Map([["geometry",[new YE.G("a_pos",2,Ir.g.BYTE,0,4),new YE.G("a_tex",2,Ir.g.BYTE,2,4)]]]);const KE=new Map([["geometry",[new YE.G("a_pos",2,Ir.g.UNSIGNED_SHORT,0,4)]]]);class JE extends $E{constructor(e){super(),this._rctx=e;this._program=e.programCache.acquire("\n    precision highp float;\n\n    attribute vec2 a_pos;\n    varying vec2 v_uv;\n\n    void main() {\n      v_uv = a_pos;\n      gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);\n    }\n    ","\n    precision highp float;\n\n    varying vec2 v_uv;\n\n    uniform sampler2D u_texture;\n\n    void main() {\n      gl_FragColor = texture2D(u_texture, v_uv);\n    }\n    ",new Map([["a_pos",0]]))}dispose(){super.dispose()}_test(e){const t=this._rctx;if(!t.gl)return e.dispose(),!0;const i=new Br.X(1);i.wrapMode=Ir.e8.CLAMP_TO_EDGE,i.samplingMode=Ir.cw.NEAREST;const r=new kr.X(t,i),s=us.f.createVertex(t,Ir.l1.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),n=new qx.U(t,new Map([["a_pos",0]]),KE,new Map([["geometry",s]])),a=new Br.X;a.samplingMode=Ir.cw.LINEAR,a.wrapMode=Ir.e8.CLAMP_TO_EDGE;const o=new Pd.x(t,a,eR);t.useProgram(e),t.bindTexture(o,0),e.setUniform1i("u_texture",0);const l=t.getBoundFramebufferObject(),{x:c,y:h,width:u,height:d}=t.getViewport();t.bindFramebuffer(r),t.setViewport(0,0,1,1),t.setClearColor(0,0,0,0),t.setBlendingEnabled(!1),t.clear(Ir.Hf.COLOR),t.bindVAO(n),t.drawArrays(Ir.MX.TRIANGLE_STRIP,0,4);const p=new Uint8Array(4);return r.readPixels(0,0,1,1,Ir.VI.RGBA,Ir.Br.UNSIGNED_BYTE,p),n.dispose(),r.dispose(),o.dispose(),t.setViewport(c,h,u,d),t.bindFramebuffer(l),255!==p[0]}}const eR=new Image;eR.src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='5' height='5' version='1.1' viewBox='0 0 5 5' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='5' height='5' fill='%23f00' fill-opacity='.5'/%3E%3C/svg%3E%0A",eR.width=5,eR.height=5,eR.decode();class tR{constructor(e){this.rctx=e,this.floatBufferBlend=new QE(e),this.svgPremultipliesAlpha=new JE(e),this.drawArraysRequiresIndicesTypeReset=new XE(e)}dispose(){this.svgPremultipliesAlpha.dispose(),this.floatBufferBlend.dispose(),this.drawArraysRequiresIndicesTypeReset.dispose()}}var iR=i(80290);function rR(e,t,i,r,s){if(r)return!0;if(t[i])return!1;for(const t of s)if(e.getExtension(t))return!0;return!1}class sR{constructor(e,t){this._gl=e,this._compressedTextureETC=null,this._compressedTextureS3TC=null,this._textureFilterAnisotropic=null,this._colorBufferFloat=null,this._loseContext=null,this._textureNorm16=null,this._textureFloatLinear=null,this._parallelShaderCompile=null,this._rendererInfo=null,this._disabledExtensions=t.disabledExtensions||{},this._debugWebGLExtensions=t.debugWebGLExtensions||{}}get compressedTextureETC(){return this._compressedTextureETC??=function(e,t){if(t.compressedTextureETC)return null;const i=e.getExtension("WEBGL_compressed_texture_etc");return i?{COMPRESSED_R11_EAC:i.COMPRESSED_R11_EAC,COMPRESSED_SIGNED_R11_EAC:i.COMPRESSED_SIGNED_R11_EAC,COMPRESSED_RG11_EAC:i.COMPRESSED_RG11_EAC,COMPRESSED_SIGNED_RG11_EAC:i.COMPRESSED_SIGNED_RG11_EAC,COMPRESSED_RGB8_ETC2:i.COMPRESSED_RGB8_ETC2,COMPRESSED_SRGB8_ETC2:i.COMPRESSED_SRGB8_ETC2,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:i.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:i.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_RGBA8_ETC2_EAC:i.COMPRESSED_RGBA8_ETC2_EAC,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:i.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC}:null}(this._gl,this._disabledExtensions),this._compressedTextureETC}get compressedTextureS3TC(){return this._compressedTextureS3TC??=function(e,t){if(t.compressedTextureS3TC)return null;const i=e.getExtension("WEBGL_compressed_texture_s3tc");return i?{COMPRESSED_RGB_S3TC_DXT1:i.COMPRESSED_RGB_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT1:i.COMPRESSED_RGBA_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT3:i.COMPRESSED_RGBA_S3TC_DXT3_EXT,COMPRESSED_RGBA_S3TC_DXT5:i.COMPRESSED_RGBA_S3TC_DXT5_EXT}:null}(this._gl,this._disabledExtensions),this._compressedTextureS3TC}get textureFilterAnisotropic(){return this._textureFilterAnisotropic??=function(e,t){if(t.textureFilterAnisotropic)return null;const i=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");return i?{MAX_TEXTURE_MAX_ANISOTROPY:i.MAX_TEXTURE_MAX_ANISOTROPY_EXT,TEXTURE_MAX_ANISOTROPY:i.TEXTURE_MAX_ANISOTROPY_EXT}:null}(this._gl,this._disabledExtensions),this._textureFilterAnisotropic}get disjointTimerQuery(){return this._disjointTimerQuery??=function(e,t){if(t.disjointTimerQuery)return null;let i=e.getExtension("EXT_disjoint_timer_query_webgl2");return i?new jM((()=>e.createQuery()),(t=>{e.deleteQuery(t),WM=!1}),(t=>e.getQueryParameter(t,e.QUERY_RESULT_AVAILABLE)),(t=>e.getQueryParameter(t,e.QUERY_RESULT)),(()=>e.getParameter(i.GPU_DISJOINT_EXT)),(t=>{WM||(WM=!0,e.beginQuery(i.TIME_ELAPSED_EXT,t))}),(()=>{e.endQuery(i.TIME_ELAPSED_EXT),WM=!1}),(e=>i.queryCounterEXT(e,i.TIMESTAMP_EXT)),(()=>e.getQuery(i.TIMESTAMP_EXT,i.QUERY_COUNTER_BITS_EXT))):(i=e.getExtension("EXT_disjoint_timer_query"),i?new jM((()=>i.createQueryEXT()),(e=>{i.deleteQueryEXT(e),WM=!1}),(e=>i.getQueryObjectEXT(e,i.QUERY_RESULT_AVAILABLE_EXT)),(e=>i.getQueryObjectEXT(e,i.QUERY_RESULT_EXT)),(()=>e.getParameter(i.GPU_DISJOINT_EXT)),(e=>{WM||(WM=!0,i.beginQueryEXT(i.TIME_ELAPSED_EXT,e))}),(()=>{i.endQueryEXT(i.TIME_ELAPSED_EXT),WM=!1}),(e=>i.queryCounterEXT(e,i.TIMESTAMP_EXT)),(()=>i.getQueryEXT(i.TIMESTAMP_EXT,i.QUERY_COUNTER_BITS_EXT))):null)}(this._gl,this._disabledExtensions),this._disjointTimerQuery}get colorBufferFloat(){return this._colorBufferFloat??=function(e,t){const i=!t.colorBufferHalfFloat&&e.getExtension("EXT_color_buffer_half_float")||!t.colorBufferFloat&&e.getExtension("EXT_color_buffer_float"),r=!t.colorBufferFloat&&e.getExtension("EXT_color_buffer_float"),s=!t.floatBlend&&!t.colorBufferFloat&&e.getExtension("EXT_float_blend");return i||r||s?{textureFloat:!!r,textureHalfFloat:!!i,floatBlend:!!s,R16F:e.R16F,RG16F:e.RG16F,RGBA16F:e.RGBA16F,R32F:e.R32F,RG32F:e.RG32F,RGBA32F:e.RGBA32F,R11F_G11F_B10F:e.R11F_G11F_B10F,RGB16F:e.RGB16F}:null}(this._gl,this._disabledExtensions),this._colorBufferFloat}get textureNorm16(){return this._textureNorm16??=function(e,t){if(t.textureNorm16)return null;const i=e.getExtension("EXT_texture_norm16");return i?{R16:i.R16_EXT,RG16:i.RG16_EXT,RGB16:i.RGB16_EXT,RGBA16:i.RGBA16_EXT,R16_SNORM:i.R16_SNORM_EXT,RG16_SNORM:i.RG16_SNORM_EXT,RGB16_SNORM:i.RGB16_SNORM_EXT,RGBA16_SNORM:i.RGBA16_SNORM_EXT}:null}(this._gl,this._disabledExtensions),this._textureNorm16}get textureFloatLinear(){return this._textureFloatLinear??=rR(this._gl,this._disabledExtensions,"textureFloatLinear",!1,["OES_texture_float_linear"]),this._textureFloatLinear}get parallelShaderCompile(){return this._parallelShaderCompile??=rR(this._gl,this._disabledExtensions,"parallelShaderCompile",!1,["KHR_parallel_shader_compile"]),this._parallelShaderCompile}get loseContext(){return this._loseContext??=function(e,t){const i=t.loseContext&&e.getExtension("WEBGL_lose_context");return i?{loseRenderingContext:()=>i.loseContext()}:null}(this._gl,this._debugWebGLExtensions),this._loseContext}get rendererInfo(){return this._rendererInfo??=(0,iR.z)(this._gl),this._rendererInfo}enable(e){return this[e]}}let nR=class{constructor(e,t){this.gl=e,this.instanceCounter=new bE,this.programCache=new jE(this),this._transformFeedbackRequestInfo=null,this._state=new fE,this._numOfDrawCalls=0,this._numOfTriangles=0,this.configure(t)}configure(e){this._capabilities=new sR(this.gl,e),this._parameters=new wE(this.gl,this._capabilities,e),Pd.x.TEXTURE_UNIT_FOR_UPDATES=this._parameters.maxTextureImageUnits-1;const t=this.gl.getParameter(this.gl.VIEWPORT);this._state=new fE,this._state.viewport={x:t[0],y:t[1],width:t[2],height:t[3]},this._stateTracker=new Lr.jp({setBlending:e=>{if(e){this.setBlendingEnabled(!0),this.setBlendEquationSeparate(e.opRgb,e.opAlpha),this.setBlendFunctionSeparate(e.srcRgb,e.dstRgb,e.srcAlpha,e.dstAlpha);const t=e.color;this.setBlendColor(t.r,t.g,t.b,t.a)}else this.setBlendingEnabled(!1)},setCulling:e=>{e?(this.setFaceCullingEnabled(!0),this.setCullFace(e.face),this.setFrontFace(e.mode)):this.setFaceCullingEnabled(!1)},setPolygonOffset:e=>{e?(this.setPolygonOffsetFillEnabled(!0),this.setPolygonOffset(e.factor,e.units)):this.setPolygonOffsetFillEnabled(!1)},setDepthTest:e=>{e?(this.setDepthTestEnabled(!0),this.setDepthFunction(e.func)):this.setDepthTestEnabled(!1)},setStencilTest:e=>{if(e){this.setStencilTestEnabled(!0);const t=e.function;this.setStencilFunction(t.func,t.ref,t.mask);const i=e.operation;this.setStencilOp(i.fail,i.zFail,i.zPass)}else this.setStencilTestEnabled(!1)},setDepthWrite:e=>{e?(this.setDepthWriteEnabled(!0),this.setDepthRange(e.zNear,e.zFar)):this.setDepthWriteEnabled(!1)},setColorWrite:e=>{e?this.setColorMask(e.r,e.g,e.b,e.a):this.setColorMask(!1,!1,!1,!1)},setStencilWrite:e=>{e?this.setStencilWriteMask(e.mask):this.setStencilWriteMask(0)},setDrawBuffers:e=>{if(e)this.setDrawBuffers(e.buffers);else{const{drawFramebuffer:e}=this._state;null===e?this.setDrawBuffers([Ir.Xg.BACK]):0===e.colorAttachments.length?this.setDrawBuffers([Ir.Xg.NONE]):this.setDrawBuffers([Ir.Ii])}}}),this.enforceState(),(0,f.M2)(this._driverTest),this._driverTest=new tR(this)}updateOptions(e){this._parameters=new wE(this.gl,this._capabilities,e)}dispose(){(0,f.M2)(this._driverTest),this.programCache.dispose(),this.bindVAO(null),this.unbindBuffer(Ir.w0.ARRAY_BUFFER),this.unbindBuffer(Ir.w0.ELEMENT_ARRAY_BUFFER),this.unbindBuffer(Ir.w0.UNIFORM_BUFFER),this._state.uniformBufferBindingPoints.length=0,this.unbindBuffer(Ir.w0.PIXEL_PACK_BUFFER),this.unbindBuffer(Ir.w0.PIXEL_UNPACK_BUFFER),this.unbindBuffer(Ir.w0.COPY_READ_BUFFER),this.unbindBuffer(Ir.w0.COPY_WRITE_BUFFER),this._state.textureUnitMap.length=0,(0,kS.hZ)()&&console.log(this.instanceCounter.resourceInformation)}get driverTest(){return this._driverTest}get contextAttributes(){return this.gl.getContextAttributes()}get parameters(){return this._parameters}setPipelineState(e){this._stateTracker.setPipeline(e)}setBlendingEnabled(e){this._state.blend!==e&&(!0===e?this.gl.enable(this.gl.BLEND):this.gl.disable(this.gl.BLEND),this._state.blend=e,this._stateTracker.invalidateBlending())}externalProgramUpdate(){this._state.program?.stop(),this._state.program=null}externalTextureUnitUpdate(e,t){for(let t=0;t<e.length;++t)this._state.textureUnitMap[e[t]]=null;t>=0&&(this._state.activeTexture=t)}externalVertexArrayObjectUpdate(){this.gl.bindVertexArray(null),this._state.vertexArrayObject=null,this._state.vertexBuffer=null,this._state.indexBuffer=null}externalVertexBufferUpdate(){this._state.vertexBuffer=null}externalIndexBufferUpdate(){this._state.indexBuffer=null}setBlendColor(e,t,i,r){e===this._state.blendColor.r&&t===this._state.blendColor.g&&i===this._state.blendColor.b&&r===this._state.blendColor.a||(this.gl.blendColor(e,t,i,r),this._state.blendColor.r=e,this._state.blendColor.g=t,this._state.blendColor.b=i,this._state.blendColor.a=r,this._stateTracker.invalidateBlending())}setBlendFunction(e,t){e===this._state.blendFunction.srcRGB&&t===this._state.blendFunction.dstRGB||(this.gl.blendFunc(e,t),this._state.blendFunction.srcRGB=e,this._state.blendFunction.srcAlpha=e,this._state.blendFunction.dstRGB=t,this._state.blendFunction.dstAlpha=t,this._stateTracker.invalidateBlending())}setBlendFunctionSeparate(e,t,i,r){this._state.blendFunction.srcRGB===e&&this._state.blendFunction.srcAlpha===i&&this._state.blendFunction.dstRGB===t&&this._state.blendFunction.dstAlpha===r||(this.gl.blendFuncSeparate(e,t,i,r),this._state.blendFunction.srcRGB=e,this._state.blendFunction.srcAlpha=i,this._state.blendFunction.dstRGB=t,this._state.blendFunction.dstAlpha=r,this._stateTracker.invalidateBlending())}setBlendEquation(e){this._state.blendEquation.mode!==e&&(this.gl.blendEquation(e),this._state.blendEquation.mode=e,this._state.blendEquation.modeAlpha=e,this._stateTracker.invalidateBlending())}setBlendEquationSeparate(e,t){this._state.blendEquation.mode===e&&this._state.blendEquation.modeAlpha===t||(this.gl.blendEquationSeparate(e,t),this._state.blendEquation.mode=e,this._state.blendEquation.modeAlpha=t,this._stateTracker.invalidateBlending())}setColorMask(e,t,i,r){this._state.colorMask.r===e&&this._state.colorMask.g===t&&this._state.colorMask.b===i&&this._state.colorMask.a===r||(this.gl.colorMask(e,t,i,r),this._state.colorMask.r=e,this._state.colorMask.g=t,this._state.colorMask.b=i,this._state.colorMask.a=r,this._stateTracker.invalidateColorWrite())}setClearColor(e,t,i,r){this._state.clearColor.r===e&&this._state.clearColor.g===t&&this._state.clearColor.b===i&&this._state.clearColor.a===r||(this.gl.clearColor(e,t,i,r),this._state.clearColor.r=e,this._state.clearColor.g=t,this._state.clearColor.b=i,this._state.clearColor.a=r)}setFaceCullingEnabled(e){this._state.faceCulling!==e&&(!0===e?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this._state.faceCulling=e,this._stateTracker.invalidateCulling())}setPolygonOffsetFillEnabled(e){this._state.polygonOffsetFill!==e&&(!0===e?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL),this._state.polygonOffsetFill=e,this._stateTracker.invalidatePolygonOffset())}setPolygonOffset(e,t){this._state.polygonOffset[0]===e&&this._state.polygonOffset[1]===t||(this._state.polygonOffset[0]=e,this._state.polygonOffset[1]=t,this.gl.polygonOffset(e,t),this._stateTracker.invalidatePolygonOffset())}setCullFace(e){this._state.cullFace!==e&&(this.gl.cullFace(e),this._state.cullFace=e,this._stateTracker.invalidateCulling())}setFrontFace(e){this._state.frontFace!==e&&(this.gl.frontFace(e),this._state.frontFace=e,this._stateTracker.invalidateCulling())}setScissorTestEnabled(e){this._state.scissorTest!==e&&(!0===e?this.gl.enable(this.gl.SCISSOR_TEST):this.gl.disable(this.gl.SCISSOR_TEST),this._state.scissorTest=e)}setScissorRect(e,t,i,r){this._state.scissorRect.x===e&&this._state.scissorRect.y===t&&this._state.scissorRect.width===i&&this._state.scissorRect.height===r||(this.gl.scissor(e,t,i,r),this._state.scissorRect.x=e,this._state.scissorRect.y=t,this._state.scissorRect.width=i,this._state.scissorRect.height=r)}setDepthTestEnabled(e){this._state.depthTest!==e&&(!0===e?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST),this._state.depthTest=e,this._stateTracker.invalidateDepthTest())}setClearDepth(e){this._state.clearDepth!==e&&(this.gl.clearDepth(e),this._state.clearDepth=e)}setDepthFunction(e){this._state.depthFunction!==e&&(this.gl.depthFunc(e),this._state.depthFunction=e,this._stateTracker.invalidateDepthTest())}setDepthWriteEnabled(e){this._state.depthWrite!==e&&(this.gl.depthMask(e),this._state.depthWrite=e,this._stateTracker.invalidateDepthWrite())}setDepthRange(e,t){this._state.depthRange.zNear===e&&this._state.depthRange.zFar===t||(this.gl.depthRange(e,t),this._state.depthRange.zNear=e,this._state.depthRange.zFar=t,this._stateTracker.invalidateDepthWrite())}setStencilTestEnabled(e){this._state.stencilTest!==e&&(!0===e?this.gl.enable(this.gl.STENCIL_TEST):this.gl.disable(this.gl.STENCIL_TEST),this._state.stencilTest=e,this._stateTracker.invalidateStencilTest())}setClearStencil(e){e!==this._state.clearStencil&&(this.gl.clearStencil(e),this._state.clearStencil=e)}setStencilFunction(e,t,i){this._state.stencilFunction.func===e&&this._state.stencilFunction.ref===t&&this._state.stencilFunction.mask===i||(this.gl.stencilFunc(e,t,i),this._state.stencilFunction.face=Ir.LR.FRONT_AND_BACK,this._state.stencilFunction.func=e,this._state.stencilFunction.ref=t,this._state.stencilFunction.mask=i,this._stateTracker.invalidateStencilTest())}setStencilFunctionSeparate(e,t,i,r){this._state.stencilFunction.face===e&&this._state.stencilFunction.func===t&&this._state.stencilFunction.ref===i&&this._state.stencilFunction.mask===r||(this.gl.stencilFuncSeparate(e,t,i,r),this._state.stencilFunction.face=e,this._state.stencilFunction.func=t,this._state.stencilFunction.ref=i,this._state.stencilFunction.mask=r,this._stateTracker.invalidateStencilTest())}setStencilWriteMask(e){this._state.stencilWriteMask!==e&&(this.gl.stencilMask(e),this._state.stencilWriteMask=e,this._stateTracker.invalidateStencilWrite())}setStencilOp(e,t,i){this._state.stencilOperation.face===Ir.LR.FRONT_AND_BACK&&this._state.stencilOperation.fail===e&&this._state.stencilOperation.zFail===t&&this._state.stencilOperation.zPass===i||(this.gl.stencilOp(e,t,i),this._state.stencilOperation.face=Ir.LR.FRONT_AND_BACK,this._state.stencilOperation.fail=e,this._state.stencilOperation.zFail=t,this._state.stencilOperation.zPass=i,this._stateTracker.invalidateStencilTest())}setStencilOpSeparate(e,t,i,r){this._state.stencilOperation.face===e&&this._state.stencilOperation.fail===t&&this._state.stencilOperation.zFail===i&&this._state.stencilOperation.zPass===r||(this.gl.stencilOpSeparate(e,t,i,r),this._state.stencilOperation.face=e,this._state.stencilOperation.fail=t,this._state.stencilOperation.zFail=i,this._state.stencilOperation.zPass=r,this._stateTracker.invalidateStencilTest())}setActiveTexture(e,t=!1){const i=this._state.activeTexture;return e>=0&&(t||e!==this._state.activeTexture)&&(this.gl.activeTexture(Ir.V1+e),this._state.activeTexture=e),i}setDrawBuffers(e){const{drawFramebuffer:t}=this._state,i=null===t,r=i?this._state.drawBuffers.defaultFramebuffer:this._state.drawBuffers.fbos.get(t);if(r?.length!==e.length||!r.every(((t,i)=>t===e[i])))if(e.length>this.parameters.maxDrawBuffers)console.error("Setting more active draw buffers than GL.MAX_DRAW_BUFFERS allows.");else{if(i){if(e.length>1)return void console.error("The default framebuffer can only have one active draw buffer.");if(e[0]!==Ir.Xg.BACK&&e[0]!==Ir.Xg.NONE)return void console.error("The default framebuffer can only use the constants GL.BACK or GL.NONE as draw buffers.")}i||!e.includes(Ir.Xg.BACK)?(this.gl.drawBuffers(e),i?this._state.drawBuffers.defaultFramebuffer=e:this._state.drawBuffers.fbos.set(t,e),this._stateTracker.invalidateDrawBuffers()):console.error("A framebuffer object can only use the constants GL.COLOR_ATTACHMENTi or GL.NONE as draw buffers.")}}clear(e,t=255){if(e){if(e&Ir.Hf.COLOR){const e=this._state.drawFramebuffer?.colorAttachments;e&&this.setDrawBuffers(e),this.setColorMask(!0,!0,!0,!0)}e&Ir.Hf.DEPTH&&this.setDepthWriteEnabled(!0),e&Ir.Hf.STENCIL&&this.setStencilWriteMask(t),this.gl.clear(e)}}clearFramebuffer(e,t=!1,i=!1){let r=0;if(e){const t=1e-13,i=Math.max(t,e[3]);this.setClearColor(e[0],e[1],e[2],i),r|=Ir.Hf.COLOR}t&&(r|=Ir.Hf.DEPTH),!1===i?i=0:(!0===i&&(i=255),r|=Ir.Hf.STENCIL),r&&this.clear(r,i)}clearBuffer(e,t,i=Ir.i5.COLOR,r){this.gl.clearBufferfv(i,e,t,r)}clearBufferInteger(e,t,i=Ir.i5.COLOR,r){this.gl.clearBufferiv(i,e,t,r)}clearBufferUnsignedInteger(e,t,i=Ir.i5.COLOR,r){this.gl.clearBufferuiv(i,e,t,r)}drawArrays(e,t,i){if(this._transformFeedbackRequestInfo){if(e!==this._transformFeedbackRequestInfo.primitiveType)throw new Error("DrawArrays called during transform feedback, but primitiveType does not match that of the current transform feedback request");if(null==this._state.program?.hasTransformFeedbackVaryings)throw new Error("DrawArrays called during transform feedback, but the shader program was not linked with a transform feedback varying")}if((0,kS.hZ)()&&(this._numOfDrawCalls++,this._numOfTriangles+=oR(e,i),(0,m.Z)("enable-feature:webgl-debug:textureReadWrite"))){const e=this._state.textureUnitMap;for(let t=0;t<e.length;t++){const i=e[t];if(null!=i&&i===this._state.drawFramebuffer?.colorTexture)throw new Error(`Detected readWrite. Texture already bound at index ${t}`)}}this.gl.drawArrays(e,t,i),(0,kS.zu)(this.gl)}drawArraysInstanced(e,t,i,r){this.gl.drawArraysInstanced(e,t,i,r),(0,kS.zu)(this.gl)}drawElements(e,t,i,r){if(this._transformFeedbackRequestInfo)throw new Error("Cannot called drawElements during a transform feedback request");if((0,kS.hZ)()&&(this._numOfDrawCalls++,this._numOfTriangles+=oR(e,t)),this.gl.drawElements(e,t,i,r),(0,kS.hZ)()){const s=(0,ds.HH)(this);if(s){const n=this.getBoundVAO(),a=n?.indexBuffer,o=n?.vertexBuffers,l={indexBuffer:a,vertexBuffers:o},c={mode:e,count:t,type:i,offset:r},h=a?.size??0,u=r+t,d=h<u?`. Buffer is too small. Attempted to draw index ${u} of ${h}`:"";console.error(`drawElements: ${s}${d}`,{args:c,vao:l})}}}drawElementsInstanced(e,t,i,r,s){this.gl.drawElementsInstanced(e,t,i,r,s),(0,kS.zu)(this.gl)}logInfo(){(0,kS.hZ)()&&console.log(`DrawCalls: ${this._numOfDrawCalls}, Triangles: ${this._numOfTriangles}`)}resetInfo(){(0,kS.hZ)()&&(this._numOfDrawCalls=0,this._numOfTriangles=0)}get capabilities(){return this._capabilities}setViewport(e,t,i,r){i=Math.max(Math.round(i),1),r=Math.max(Math.round(r),1);const s=this._state.viewport;s.x===e&&s.y===t&&s.width===i&&s.height===r||(s.x=e,s.y=t,s.width=i,s.height=r,this.gl.viewport(e,t,i,r))}setViewport4fv(e){this.setViewport(e[0],e[1],e[2],e[3])}restoreViewport({x:e,y:t,width:i,height:r}){this.setViewport(e,t,i,r)}getViewport(){const e=this._state.viewport;return{x:e.x,y:e.y,width:e.width,height:e.height}}useProgram(e){this._state.program!==e&&(this._state.program?.stop(),this._state.program=e,this.gl.useProgram(e?.glName??null))}bindTexture(e,t,i=!1){(t>=this.parameters.maxTextureImageUnits||t<0)&&console.error("Input texture unit is out of range of available units!");const r=this._state.textureUnitMap[t];return null==e?.glName?(null!=r&&(this.setActiveTexture(t,i),this.gl.bindTexture(r.descriptor.target,null)),this._state.textureUnitMap[t]=null,r):i||r!==e?(this.setActiveTexture(t,i),this.gl.bindTexture(e.descriptor.target,e.glName),e.applyChanges(),this._state.textureUnitMap[t]=e,r):(e.isDirty&&(this.setActiveTexture(t,i),e.applyChanges()),r)}unbindTexture(e){if(null!=e)for(let t=0;t<this.parameters.maxTextureImageUnits;t++)this._state.textureUnitMap[t]===e&&(this.bindTexture(null,t),this._state.textureUnitMap[t]=null)}bindFramebuffer(e,t=!1){if(t||this._state.readFramebuffer!==e||this._state.drawFramebuffer!==e){if(this._stateTracker.invalidateDrawBuffers(),null==e)return this.gl.bindFramebuffer(Ir.qi.FRAMEBUFFER,null),void(this._state.readFramebuffer=this._state.drawFramebuffer=null);e.initializeAndBind(Ir.qi.FRAMEBUFFER),this._state.readFramebuffer=e,this._state.drawFramebuffer=e}}bindFramebufferSeparate(e,t,i=!1){const r=t===Ir.qi.READ_FRAMEBUFFER,s=r?this._state.readFramebuffer:this._state.drawFramebuffer;(i||s!==e)&&(null==e?this.gl.bindFramebuffer(t,null):e.initializeAndBind(t),r?this._state.readFramebuffer=e??null:(this._stateTracker.invalidateDrawBuffers(),this._state.drawFramebuffer=e??null))}blitFramebuffer(e,t,i=Ir.Hf.COLOR,r=Ir.cw.NEAREST,s=0,n=0,a=e.width,o=e.height,l=0,c=0,h=t.width,u=t.height){this.bindFramebufferSeparate(e,Ir.qi.READ_FRAMEBUFFER,!0),this.bindFramebufferSeparate(t,Ir.qi.DRAW_FRAMEBUFFER,!0),this.gl.blitFramebuffer(s,n,a,o,l,c,h,u,i,r)}bindBuffer(e,t){if(e)switch(t??=e.bufferType,t){case Ir.w0.ARRAY_BUFFER:this._state.vertexBuffer=aR(this.gl,e,t,this._state.vertexBuffer);break;case Ir.w0.ELEMENT_ARRAY_BUFFER:this._state.indexBuffer=aR(this.gl,e,t,this._state.indexBuffer);break;case Ir.w0.UNIFORM_BUFFER:this._state.uniformBuffer=aR(this.gl,e,t,this._state.uniformBuffer);break;case Ir.w0.PIXEL_PACK_BUFFER:this._state.pixelPackBuffer=aR(this.gl,e,t,this._state.pixelPackBuffer);break;case Ir.w0.PIXEL_UNPACK_BUFFER:this._state.pixelUnpackBuffer=aR(this.gl,e,t,this._state.pixelUnpackBuffer);break;case Ir.w0.COPY_READ_BUFFER:this._state.copyReadBuffer=aR(this.gl,e,t,this._state.copyReadBuffer);break;case Ir.w0.COPY_WRITE_BUFFER:this._state.copyWriteBuffer=aR(this.gl,e,t,this._state.copyWriteBuffer);break;case Ir.w0.TRANSFORM_FEEDBACK_BUFFER:this._state.transformFeedbackBuffer=aR(this.gl,e,t,this._state.transformFeedbackBuffer)}}bindRenderbuffer(e){const t=this.gl;e||(t.bindRenderbuffer(t.RENDERBUFFER,null),this._state.renderbuffer=null),this._state.renderbuffer!==e&&(t.bindRenderbuffer(t.RENDERBUFFER,e.glName),this._state.renderbuffer=e)}_getBufferBinding(e,t){if(t>=this.parameters.maxUniformBufferBindings||t<0)return console.error("Uniform buffer binding point is out of range!"),null;const i=e===Ir.w0.UNIFORM_BUFFER?this._state.uniformBufferBindingPoints:this._state.transformBufferBindingPoints;let r=i[t];return null==r&&(r={buffer:null,offset:0,size:0},i[t]=r),r}bindBufferBase(e,t,i){const r=this._getBufferBinding(e,t);null!=r&&(r.buffer===i&&0===r.offset&&0===r.size||(this.gl.bindBufferBase(e,t,i?i.glName:null),r.buffer=i,r.offset=0,r.size=0))}bindBufferRange(e,t,i,r,s){const n=this._getBufferBinding(e,t);null!=n&&(n.buffer===i&&n.offset===r&&n.size===s||(r%this._parameters.uniformBufferOffsetAlignment==0?(this.gl.bindBufferRange(e,t,i.glName,r,s),n.buffer=i,n.offset=r,n.size=s):console.error("Uniform buffer binding offset is not a multiple of the context offset alignment")))}bindUBO(e,t,i,r){null!=t?((0,kS.hZ)()&&(r??t.byteLength)>this._parameters.maxUniformBlockSize&&console.error("Attempting to bind more data than the maximum uniform block size"),t.initialize(),void 0!==i&&void 0!==r?this.bindBufferRange(Ir.w0.UNIFORM_BUFFER,e,t.buffer,i,r):this.bindBufferBase(Ir.w0.UNIFORM_BUFFER,e,t.buffer)):this.bindBufferBase(Ir.w0.UNIFORM_BUFFER,e,null)}unbindUBO(e){for(let t=0,i=this._state.uniformBufferBindingPoints.length;t<i;t++){const i=this._state.uniformBufferBindingPoints[t];null!=i&&i.buffer===e.buffer&&this.bindBufferBase(Ir.w0.UNIFORM_BUFFER,t,null)}}unbindBuffer(e){switch(e){case Ir.w0.ARRAY_BUFFER:this._state.vertexBuffer=aR(this.gl,null,e,this._state.vertexBuffer);break;case Ir.w0.ELEMENT_ARRAY_BUFFER:this._state.indexBuffer=aR(this.gl,null,e,this._state.indexBuffer);break;case Ir.w0.UNIFORM_BUFFER:this._state.uniformBuffer=aR(this.gl,null,e,this._state.uniformBuffer);break;case Ir.w0.PIXEL_PACK_BUFFER:this._state.pixelPackBuffer=aR(this.gl,null,e,this._state.pixelPackBuffer);break;case Ir.w0.PIXEL_UNPACK_BUFFER:this._state.pixelUnpackBuffer=aR(this.gl,null,e,this._state.pixelUnpackBuffer);break;case Ir.w0.COPY_READ_BUFFER:this._state.copyReadBuffer=aR(this.gl,null,e,this._state.copyReadBuffer);break;case Ir.w0.COPY_WRITE_BUFFER:this._state.copyWriteBuffer=aR(this.gl,null,e,this._state.copyWriteBuffer)}}bindVAO(e=null){null!=e?this._state.vertexArrayObject!==e&&(e.bind(),this._state.vertexArrayObject=e):this._state.vertexArrayObject&&(this._state.vertexArrayObject.unbind(),this._state.vertexArrayObject=null)}bindTransformFeedback(e){const{gl:t}=this;t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,e.glName)}beginTransformFeedback(e,t){if(this._transformFeedbackRequestInfo)throw new Error("Already in a transform feedback request");const{gl:i}=this;i.bindTransformFeedback(i.TRANSFORM_FEEDBACK,e.glName),i.beginTransformFeedback(t),this._transformFeedbackRequestInfo={primitiveType:t}}endTransformFeedback(){if(!this._transformFeedbackRequestInfo)throw new Error("Not in a transform feedback request");const{gl:e}=this;e.endTransformFeedback(),e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,null),this._transformFeedbackRequestInfo=null}async clientWaitAsync(e=(0,Yr.HA)(10)){const{gl:t}=this,i=t.fenceSync(Ir.V7.SYNC_GPU_COMMANDS_COMPLETE,0);if(!i)throw new Error("Client wait failed, could not create sync object");let r;this.instanceCounter.increment(Ir._g.Sync,i),t.flush();do{await(0,y.e4)(e),r=t.clientWaitSync(i,0,0)}while(r===Ir.Y5.TIMEOUT_EXPIRED);if(this.instanceCounter.decrement(Ir._g.Sync,i),t.deleteSync(i),r===Ir.Y5.WAIT_FAILED)throw new Error("Client wait failed")}getBoundFramebufferObject(e=Ir.qi.FRAMEBUFFER){return e===Ir.qi.READ_FRAMEBUFFER?this._state.readFramebuffer:this._state.drawFramebuffer}temporaryBindFramebufferObject(e,t,i=!1){const r=this.getBoundFramebufferObject();try{this.bindFramebuffer(e,i),t()}finally{this.bindFramebuffer(r,i)}}getBoundVAO(){return this._state.vertexArrayObject}resetState(){this.useProgram(null),this.bindVAO(null),this.bindFramebuffer(null,!0),this.unbindBuffer(Ir.w0.ARRAY_BUFFER),this.unbindBuffer(Ir.w0.ELEMENT_ARRAY_BUFFER),this.unbindBuffer(Ir.w0.UNIFORM_BUFFER),this._state.uniformBufferBindingPoints.length=0,this.unbindBuffer(Ir.w0.PIXEL_PACK_BUFFER),this.unbindBuffer(Ir.w0.PIXEL_UNPACK_BUFFER),this.unbindBuffer(Ir.w0.COPY_READ_BUFFER),this.unbindBuffer(Ir.w0.COPY_WRITE_BUFFER);for(let e=0;e<this.parameters.maxTextureImageUnits;++e)this.bindTexture(null,e);this.setBlendingEnabled(!1),this.setBlendFunction(Ir.zi.ONE,Ir.zi.ZERO),this.setBlendEquation(Ir.db.ADD),this.setBlendColor(0,0,0,0),this.setFaceCullingEnabled(!1),this.setCullFace(Ir.LR.BACK),this.setFrontFace(Ir.Wf.CCW),this.setPolygonOffsetFillEnabled(!1),this.setPolygonOffset(0,0),this.setScissorTestEnabled(!1),this.setScissorRect(0,0,this.gl.canvas.width,this.gl.canvas.height),this.setDepthTestEnabled(!1),this.setDepthFunction(Ir.wb.LESS),this.setDepthRange(0,1),this.setStencilTestEnabled(!1),this.setStencilFunction(Ir.wb.ALWAYS,0,0),this.setStencilOp(Ir.xS.KEEP,Ir.xS.KEEP,Ir.xS.KEEP),this.setClearColor(0,0,0,0),this.setClearDepth(1),this.setClearStencil(0),this.setColorMask(!0,!0,!0,!0),this.setStencilWriteMask(4294967295),this.setDepthWriteEnabled(!0),this.setDrawBuffers([Ir.Xg.BACK]),this.setViewport(0,0,this.gl.canvas.width,this.gl.canvas.height)}enforceState(){const{gl:e}=this;e.bindVertexArray(null);for(let t=0;t<this.parameters.maxVertexAttributes;t++)e.disableVertexAttribArray(t);this._state.vertexBuffer?e.bindBuffer(this._state.vertexBuffer.bufferType,this._state.vertexBuffer.glName):e.bindBuffer(Ir.w0.ARRAY_BUFFER,null),this._state.indexBuffer?e.bindBuffer(this._state.indexBuffer.bufferType,this._state.indexBuffer.glName):e.bindBuffer(Ir.w0.ELEMENT_ARRAY_BUFFER,null),this._state.uniformBuffer?e.bindBuffer(this._state.uniformBuffer.bufferType,this._state.uniformBuffer.glName):e.bindBuffer(Ir.w0.UNIFORM_BUFFER,null);for(let t=0;t<this._parameters.maxUniformBufferBindings;t++){const i=this._state.uniformBufferBindingPoints[t];if(null!=i){const{buffer:r,offset:s,size:n}=i;null!==r?0===s&&0===n?e.bindBufferBase(Ir.w0.UNIFORM_BUFFER,t,r.glName):e.bindBufferRange(Ir.w0.UNIFORM_BUFFER,t,r.glName,s,n):e.bindBufferBase(Ir.w0.UNIFORM_BUFFER,t,null)}}if(this._state.pixelPackBuffer?e.bindBuffer(this._state.pixelPackBuffer.bufferType,this._state.pixelPackBuffer.glName):e.bindBuffer(Ir.w0.PIXEL_PACK_BUFFER,null),this._state.pixelUnpackBuffer?e.bindBuffer(this._state.pixelUnpackBuffer.bufferType,this._state.pixelUnpackBuffer.glName):e.bindBuffer(Ir.w0.PIXEL_UNPACK_BUFFER,null),this._state.copyReadBuffer?e.bindBuffer(this._state.copyReadBuffer.bufferType,this._state.copyReadBuffer.glName):e.bindBuffer(Ir.w0.COPY_READ_BUFFER,null),this._state.copyWriteBuffer?e.bindBuffer(this._state.copyWriteBuffer.bufferType,this._state.copyWriteBuffer.glName):e.bindBuffer(Ir.w0.COPY_WRITE_BUFFER,null),e.bindFramebuffer(Ir.qi.READ_FRAMEBUFFER,null),e.readBuffer(e.BACK),this._state.readFramebuffer&&(e.bindFramebuffer(Ir.qi.READ_FRAMEBUFFER,this._state.readFramebuffer.glName),e.readBuffer(Ir.Ii)),e.bindFramebuffer(Ir.qi.DRAW_FRAMEBUFFER,this._state.drawFramebuffer?.glName??null),null===this._state.drawFramebuffer){const t=this._state.drawBuffers.defaultFramebuffer;e.drawBuffers(t??[Ir.Xg.BACK])}else{const t=this._state.drawBuffers.fbos.get(this._state.drawFramebuffer);e.drawBuffers(t??[Ir.Ii])}if(this._state.vertexArrayObject){const e=this._state.vertexArrayObject;this._state.vertexArrayObject&&(this._state.vertexArrayObject.unbind(),this._state.vertexArrayObject=null),this.bindVAO(e)}e.useProgram(this._state.program?.glName??null),e.blendColor(this._state.blendColor.r,this._state.blendColor.g,this._state.blendColor.b,this._state.blendColor.a),e.bindRenderbuffer(e.RENDERBUFFER,this._state.renderbuffer?.glName??null),!0===this._state.blend?e.enable(this.gl.BLEND):e.disable(this.gl.BLEND),e.blendEquationSeparate(this._state.blendEquation.mode,this._state.blendEquation.modeAlpha),e.blendFuncSeparate(this._state.blendFunction.srcRGB,this._state.blendFunction.dstRGB,this._state.blendFunction.srcAlpha,this._state.blendFunction.dstAlpha),e.clearColor(this._state.clearColor.r,this._state.clearColor.g,this._state.clearColor.b,this._state.clearColor.a),e.clearDepth(this._state.clearDepth),e.clearStencil(this._state.clearStencil),e.colorMask(this._state.colorMask.r,this._state.colorMask.g,this._state.colorMask.b,this._state.colorMask.a),e.cullFace(this._state.cullFace),e.depthFunc(this._state.depthFunction),e.depthRange(this._state.depthRange.zNear,this._state.depthRange.zFar),!0===this._state.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),e.depthMask(this._state.depthWrite),e.frontFace(this._state.frontFace),e.lineWidth(1),!0===this._state.faceCulling?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),e.polygonOffset(this._state.polygonOffset[0],this._state.polygonOffset[1]),!0===this._state.polygonOffsetFill?e.enable(e.POLYGON_OFFSET_FILL):e.disable(e.POLYGON_OFFSET_FILL),e.scissor(this._state.scissorRect.x,this._state.scissorRect.y,this._state.scissorRect.width,this._state.scissorRect.height),!0===this._state.scissorTest?e.enable(e.SCISSOR_TEST):e.disable(e.SCISSOR_TEST),e.stencilFunc(this._state.stencilFunction.func,this._state.stencilFunction.ref,this._state.stencilFunction.mask),e.stencilOpSeparate(this._state.stencilOperation.face,this._state.stencilOperation.fail,this._state.stencilOperation.zFail,this._state.stencilOperation.zPass),!0===this._state.stencilTest?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),e.stencilMask(this._state.stencilWriteMask);for(let t=0;t<this.parameters.maxTextureImageUnits;t++){e.activeTexture(Ir.V1+t),e.bindTexture(Ir.No.TEXTURE_2D,null),e.bindTexture(Ir.No.TEXTURE_CUBE_MAP,null),e.bindTexture(Ir.No.TEXTURE_3D,null),e.bindTexture(Ir.No.TEXTURE_2D_ARRAY,null);const i=this._state.textureUnitMap[t];null!=i&&e.bindTexture(i.descriptor.target,i.glName)}e.activeTexture(Ir.V1+this._state.activeTexture);const t=this._state.viewport;e.viewport(t.x,t.y,t.width,t.height),this.resetInfo()}};function aR(e,t,i,r){return t?r!==t&&e.bindBuffer(i,t.glName):e.bindBuffer(i,null),t}function oR(e,t){switch(e){case Ir.MX.POINTS:return 2*t;case Ir.MX.TRIANGLES:return t/3;case Ir.MX.TRIANGLE_STRIP:case Ir.MX.TRIANGLE_FAN:return t-2;default:return 0}}class lR extends nR{constructor(e,t){super(e,t),this.emptyTexture=(0,bb.l_)(this),this._vaoCaches=new Vw.r,this._appleAmdDriverHelper=null,this._refCount=1,this._newCache=t.newCache,this.screen=new pE(this)}configure(e){super.configure(e),this._newCache=e.newCache}destroy(){this._vaoCaches?.forAll((e=>e.dispose())),this._vaoCaches?.clear(),--this._refCount>0||this.dispose()}ref(){++this._refCount}dispose(){this.emptyTexture.dispose(),this.screen.destroy(),super.dispose(),this._appleAmdDriverHelper?.dispose(),this._vaoCaches.forAll((e=>e.dispose())),this._vaoCaches.clear()}get newCache(){return this._newCache}getVaoCache(e,t){const i=Array.from(e).join("."),r=JSON.stringify(t),s=this._vaoCaches.get(i,r);if(s)return s;const n=new mE(this,e,t);return this._vaoCaches.set(i,r,n),n}bindTechnique(e,t,i,r){return this.useProgram(e.program),this.setPipelineState(e.getPipeline()),e.program.bind(t),i&&(e.program.bindPass(i,t),r&&e.program.bindDraw(t,i,r)),e.program}runAppleAmdDriverHelper(){this.driverTest.drawArraysRequiresIndicesTypeReset.result&&(this._appleAmdDriverHelper??=new _E(this),this._appleAmdDriverHelper.run())}get isAssumedMetalDriver(){if(null==this._isAssumedMetalDriver&&(this._isAssumedMetalDriver=!!(0,m.Z)("ios")||!!(0,m.Z)("safari"),!this._isAssumedMetalDriver&&(0,m.Z)("mac")&&(0,m.Z)("chrome"))){const e=this.capabilities.rendererInfo?.getUnmaskedRenderer().toLowerCase(),t=e?.includes("apple")&&e?.includes("angle")&&e?.includes("metal");this._isAssumedMetalDriver=t??!0}return this._isAssumedMetalDriver}get test(){}}var cR=i(71356);class hR{constructor(){this._updating=new Map}add(e){this._updating.set(e.id,new uR(e))}remove(e){this._updating.delete(e.id)}run(){let e=!1;return this._updating.forEach((t=>{const i=t.texture.update(t.previousToken);i>=0&&i!==t.previousToken&&(t.previousToken=i,e=!0)})),e}}class uR{constructor(e){this.texture=e,this.previousToken=-1}}let dR=class extends E.Z{constructor(e){super({}),this._stage=e,this._textures=new Map,this._loadingCount=0,this.events=new ae.Z,this.updater=new hR,this._frameTask=e.view.resourceController.scheduler.registerTask(Gr.T8.TEXTURE_UNLOAD)}normalizeCtorArgs(){return{}}destroy(){this._frameTask.remove(),this._stage.forEachTexture((e=>e.unload()))}get updating(){return this._loadingCount>0||this._frameTask.updating}acquire(e){const t=this._textures.get(e);return t?(t.ref(),t.loadingPromise??t):this._createNewRef(e)}update(){this.updater.run()&&this.events.emit("changed",os.Xx.BACKGROUND)}_createNewRef(e){const t=this._stage.getTexture(e);if(null==t)return null;const i=t.events.on("unloaded",(()=>{i.remove(),this._onTextureUnloaded(t)})),r=new pR(e,(()=>{this._frameTask.schedule((()=>{r.isUnreferenced&&t.unload()}))}));return this._textures.set(e,r),r.ref(),t.loaded?(this._updateGLTexture(r,t.glTexture),(0,cR.f)(t)&&this.updater.add(t),r):(this._loadingCount++,r.loadingPromise=this._stage.schedule((()=>{const e=t.load(this._stage.renderView.renderingContext),i=e=>(this._loadingCount--,r.loadingPromise=null,this._updateGLTexture(r,e),(0,cR.f)(t)&&this.updater.add(t),r);return(0,y.y8)(e)?e.then(i,(e=>(this._loadingCount--,r.loadingPromise=null,(0,y.D_)(e)||_.Z.getLogger(this).error(e),null))):i(e)})),r.loadingPromise)}_updateGLTexture(e,t){e.glTexture=t,this.events.emit("changed",os.Xx.UPDATE)}_onTextureUnloaded(e){this._textures.delete(e.id),this.updater.remove(e)}};(0,o._)([(0,x.Cb)()],dR.prototype,"_loadingCount",void 0),(0,o._)([(0,x.Cb)()],dR.prototype,"_frameTask",void 0),(0,o._)([(0,x.Cb)()],dR.prototype,"updating",null),dR=(0,o._)([(0,S.j)("esri.views.3d.webgl-engine.lib.TextureRepository")],dR);class pR{constructor(e,t){this.id=e,this._release=t,this._refCount=0}get isUnreferenced(){return 0===this._refCount}ref(){++this._refCount}release(){--this._refCount,this._refCount>0||(0!==this._refCount?(_.Z.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository.RefCountedTextureImpl").error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}}var mR=i(35567),_R=i(42131);var fR=i(41830);let gR=class extends E.Z{constructor(){super(...arguments),this._passParameters=new yR,this._resourcesTask=null}get passParameters(){return this._passParameters}destroy(){this._resourcesTask=(0,f.IM)(this._resourcesTask),this._passParameters.waveNormal=(0,f.M2)(this._passParameters.waveNormal),this._passParameters.wavePerturbation=(0,f.M2)(this._passParameters.wavePerturbation)}get updating(){return!!this._resourcesTask&&!this._resourcesTask.finished}ensureResources(e){return this._resourcesTask||(this._resourcesTask=(0,me.vr)((async t=>{await Promise.allSettled([this._loadImageResource(e,(0,zT.V)("esri/images/materials/water/normals.jpg"),(e=>this._passParameters.waveNormal=e),t),this._loadImageResource(e,(0,zT.V)("esri/images/materials/water/perturbation.jpg"),(e=>this._passParameters.wavePerturbation=e),t)])}))),this._resourcesTask.finished?os.Rw.LOADED:os.Rw.LOADING}async _loadImageResource(e,t,i,r){try{const s=await(0,RT.t)(t,{signal:r});(0,y.k_)(r);const n=new Br.X(s.width,s.height);n.pixelFormat=Ir.VI.RGB,n.samplingMode=Ir.cw.LINEAR_MIPMAP_LINEAR,n.hasMipmap=!0,n.maxAnisotropy=8,i(new Pd.x(e,n,s))}catch(e){_.Z.getLogger(this).error("Failed to load water material normal texture.",e)}}};(0,o._)([(0,x.Cb)()],gR.prototype,"_resourcesTask",void 0),(0,o._)([(0,x.Cb)({type:Boolean,readOnly:!0})],gR.prototype,"updating",null),gR=(0,o._)([(0,S.j)("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],gR);class yR extends es.K{}const vR=new Map;function bR(){return vR}var wR=i(53433),CR=i(35236);class xR{constructor(e,t){this.parameters=e,this.fbos=t}}class TR{constructor(e,t,i){this._rctx=e,this._renderFunctions=t,this._forceCameraHook=i,this.supersample=!0,this._screenshotQueue=new Array}destroy(){this._rctx=null}async takeScreenshot(e){await this._renderFunctions.prepareOverlay(),this._renderFunctions.requestRenderScene(os.Xx.BACKGROUND);const t=(0,y.hh)();return this._screenshotQueue.push({settings:e,resolver:t}),t.promise}update(e,t){for(const i of this._screenshotQueue){if(null==this._rctx){i.resolver.reject();continue}const r={...i.settings,pixelRatio:i.settings.pixelRatio*e.parameters.camera.pixelRatio},s=this._renderScreenshot(e,r,t);i.resolver(s)}this._screenshotQueue.length=0}_renderScreenshotOverlay(e,t,i){e.width=t.width,e.height=t.height;const r=e.getContext("2d",{willReadFrequently:!0}),s=i.pixelRatio;return r.save(),r.translate(0,t.height),r.scale(1,-1),i.region&&r.translate(-i.region.x,-i.region.y),r.scale(s,s),t=this._renderFunctions.renderOverlay(e,i.disableDecorations,t),r.restore(),t}_readbackScreenshot(e,t){return e.resample?this._readbackScreenshotResampled({...e,resample:e.resample},t):this._readbackScreenshotImmediate(e,t)}_readbackScreenshotResampled(e,t){const{framebufferWidth:i,framebufferHeight:r,region:s,resample:n}=e,a=this._ensureScreenshotEncodeCanvas();let o=(0,CR.r7)(i,r,a);this._rctx.gl.readPixels(0,0,i,r,Ir.VI.RGBA,Ir.g.UNSIGNED_BYTE,new Uint8Array(o.data.buffer)),t(),o=this._renderScreenshotOverlay(a,o,{...e,region:void 0});const l=(0,CR.r7)(s.width,s.height,a);return(0,wR.resampleHermite)(o,l,!0,n.region.x,r-(n.region.y+n.region.height),n.region.width,n.region.height)}_readbackScreenshotImmediate(e,t){const{framebufferHeight:i,region:r}=e,s=this._ensureScreenshotEncodeCanvas(),n=(0,CR.r7)(r.width,r.height,s);return this._rctx.gl.readPixels(r.x,i-(r.y+r.height),r.width,r.height,Ir.VI.RGBA,Ir.g.UNSIGNED_BYTE,new Uint8Array(n.data.buffer)),t(),this._renderScreenshotOverlay(s,n,e)}_renderScreenshot(e,t,i){const r=e.parameters.camera,s={width:t.framebufferWidth,height:t.framebufferHeight};(0,kr.d)(s,Math.min(this._rctx.parameters.maxTextureSize,this._rctx.parameters.maxRenderbufferSize));let n=!1;const a=s.width!==r.fullWidth||s.height!==r.fullHeight,o=t.ignorePadding&&r.pixelRatio!==t.pixelRatio,l=a||t.disableDecorations||o||t.objectAndLayerIdColor;let c=null,h=null;if(l){const e=r.clone();if(t.ignorePadding){const i=(0,Uc.d9)(e.padding);for(let r=0;r<4;r++)i[r]=Math.round(i[r]/e.pixelRatio*t.pixelRatio);e.padding=i}e.fullWidth=s.width,e.fullHeight=s.height,e.pixelRatio=t.pixelRatio;const a=r.fovX-e.fovX,o=r.fovY-e.fovY;a<0&&a<o?e.fovX=r.fovX:o<0&&o<a&&(e.fovY=r.fovY);const l={camera:e,contentCamera:e,mode:Yc.n.IDLE,alignPixelEnabled:!0,contentPixelRatio:e.pixelRatio};this._forceCameraHook(l),n=!0;const u=this._renderFunctions.renderScene(l,i,t.objectAndLayerIdColor?Wc.YE.ObjectAndLayerID:Wc.YE.Screenshot,t.disableDecorations);h=u.screen,c=u.olid}this._rctx.bindFramebuffer(h?.fbo);const u=this._readbackScreenshot(t,(()=>{this._rctx.bindFramebuffer(null),h?.release()}));let d=null;if(t.objectAndLayerIdColor){const e=()=>{this._rctx.bindFramebuffer(null),c?.release()};this._rctx.bindFramebuffer(c?.fbo),d=this._readbackScreenshot(t,e),this._rctx.bindFramebuffer(null)}if(l&&!this._rctx.contextAttributes.alpha)for(let e=3;e<u.data.length;e+=4)u.data[e]=255;if(d&&!this._rctx.contextAttributes.alpha)for(let e=3;e<d.data.length;e+=4)d.data[e]=255;return n&&this._forceCameraHook(e.parameters),[u,d]}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas??=document.createElement("canvas"),this._screenshotEncodeCanvas}}const SR=!1;let MR=class extends E.Z{constructor(e){super(e),this.events=new ae.Z,this.waterTextures=new gR,this.olidRenderHelper=(0,zx.B)()?new aS:null,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._lastAnimationUpdate=0,this.bloom=null,this.test=null;const t=e.stage;try{this._initializeContext(t)}catch(e){return void console.error("Failed to initialize context",e)}const{memoryController:i}=t.view.resourceController;this.stippleTextures=(0,fR.kW)(this._rctx,i),this.markerTextures=function(e,t){return new _R.t((t=>(0,mR.LM)(t,e)),(e=>e),t)}(this._rctx,i),this._techniques=new Qx(new Yx(this._rctx,t.viewingMode,this.stippleTextures,this.waterTextures,this.markerTextures)),this._textures=new dR(t),this.addHandles(this._textures.events.on("changed",(e=>this.requestRender(e))));const r=new nS.h(this._textures,this._techniques,(()=>this.requestRender()),(()=>this.requestRender()));this._compositingHelper=new sS(this._rctx,this._techniques),this.renderer=new JM(t,r,this._techniques,this._rctx,this._compositingHelper,(e=>this.requestRender(e))),this.addHandles([(0,n.YP)((()=>t.view.ready),(e=>{e&&this._createRenderNodes()}),n.nn),(0,n.YP)((()=>this.waterTextures?.updating),(()=>this.requestRender()),n.nn),(0,n.YP)((()=>t.view.qualityProfile),(e=>this.renderer?.updateRenderFeatures(e)),n.tX)]);const s={renderScene:(e,t,i,r)=>this.renderer.render(e,t,i,r),requestRenderScene:e=>this.requestRender(e),prepareOverlay:()=>t.options.screenshot.prepareOverlay(),renderOverlay:(e,i,r)=>t.options.screenshot.renderOverlay(e,i,r)};this._screenshotManager=new TR(this._rctx,s,(e=>this.events.emit("force-camera-for-screenshot",e))),this._registerFrameTask(t)}destroy(){const e=this.stage?.container;e?.contains(this._canvas)&&e.removeChild(this._canvas),this._frameTask=(0,f.hw)(this._frameTask),this._techniques=(0,f.SC)(this._techniques),this._componentObjects=(0,f.SC)(this._componentObjects),this._screenshotManager=(0,f.SC)(this._screenshotManager),(0,f.SC)(this.renderer),this._textures=(0,f.SC)(this._textures),(0,f.SC)(this.waterTextures),(0,f.SC)(this.markerTextures),(0,f.SC)(this.stippleTextures),this._canvas=null,this._rctx=(0,f.SC)(this._rctx)}_createRenderNodes(){const{view:e,viewingMode:t}=this.stage;new jT({view:e}),(0,ft.V2)(e.spatialReference)||(t===Si.JY.Local?(new bC({view:e}),this.bloom=new nT({view:e})):(0,ft.BZ)(e.spatialReference)?(new LC({view:e}),this.bloom=new nT({view:e})):(new rC({view:e}),new aC({view:e}),this.bloom=new nT({view:e}),new bT({view:e}),new cC({view:e}))),new BT.K({view:e,isEnabled:()=>this.renderer.hasSSAO}),new VT({view:e,isEnabled:()=>this.renderer.hasSMAA}),new OT({view:e}),new wT.y$({view:e}),new MT({view:e,viewingMode:t}),new hT({view:e}),(0,zx.B)()&&new oT({view:e})}requestRender(e=os.Xx.UPDATE){this._needsRender=!0,e===os.Xx.UPDATE&&(this._needsUpdate=!0)}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this.renderer.updating||this._textures.updating||this.waterTextures.updating}get textures(){return this._textures}get techniques(){return this._techniques}get compositingHelper(){return this._compositingHelper}setIdleSuspend(e){this._idleSuspend!==e&&(this._idleSuspend=e,this.requestRender())}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}get canvas(){return this._canvas}takeScreenshot(e){return this._screenshotManager.takeScreenshot(e).then((e=>e[0]))}takeScreenshotWithOID(e){return e.objectAndLayerIdColor=!0,this._screenshotManager.takeScreenshot(e)}getAlpha(){return!!this._rctx.contextAttributes.alpha}getMinimalDepthForArea(e,t,i,r,s,n=s){const a=r.constrainWindowSize(t,i,s*r.pixelRatio,n*r.pixelRatio),o=this._ensureLinearDepthArrayBuffer(a);this.renderer.readMainDepth(a,o);const l=(e,t,i)=>(0,Ww.v)(t,e)*(i[1]-i[0])+i[0];let c=Number.MAX_VALUE;for(let e=0;e<a[2]*a[3];e++){const t=l(4*e,o,r.nearFar);c>t&&t!==r.nearFar[0]&&t!==r.nearFar[1]&&(c=t)}if(e){const s=e.pickDepth(t*r.pixelRatio,i*r.pixelRatio,r);null!=s&&c>s&&s!==r.nearFar[0]&&s!==r.nearFar[1]&&(c=s)}return c===Number.MAX_VALUE?void 0:c}_ensureLinearDepthArrayBuffer(e){const t=4*e[2]*e[3];return(null==this._tmpDepthBuffer||this._tmpDepthBuffer.byteLength<t)&&(this._tmpDepthBuffer=new Uint8Array(t)),this._tmpDepthBuffer}async reloadShaders(){ug(),await this._techniques.reloadAll(),this.renderer.overlay?.reloadShaders(),this.requestRender()}_registerFrameTask(e){const t=e.view.state;let i=!1,r=os.Xx.BACKGROUND,s=!1;const n={preRender:({time:s})=>{i=this.updating,r=this._needsUpdate?os.Xx.UPDATE:os.Xx.BACKGROUND,this._needsRender&&this.renderer.updateSceneDepthRange(t.camera),e.commitSyncLayers(),s=this.test?.time??s,((0,Yr.HA)(s-this._lastAnimationUpdate)>this.renderer.animationTimestep||i||this._needsRender)&&(this.renderer.updateAnimation(t,s)&&this.requestRender(os.Xx.BACKGROUND),this._lastAnimationUpdate=s)},render:({time:e})=>{if((this._needsRender||!this._idleSuspend||!this.renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&t.camera.fullWidth>0&&t.camera.fullHeight>0){const i=this._needsUpdate&&this._idleSuspend&&this.renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,e=this.test?.time??e,this.renderer.render(t,e),s=!0,i&&this.renderer.hasReflections&&(this.requestRender(os.Xx.BACKGROUND),this._needsWaterReflectionUpdate=!0)}},update:({time:e})=>{this._textures.update();const i=new xR(t,this.renderer.fboCache);e=this.test?.time??e,this._screenshotManager.update(i,e)},finish:()=>{s&&(this.renderer.finish(t.mode===Yc.n.IDLE?r:os.Xx.UPDATE),s=!1)}};this._frameTask=(0,v.A)(n)}_initializeContext(e){const{options:t}=e,i=t.canvas??document.createElement("canvas");i.setAttribute("style","width: 100%; height:100%; display:block;"),this._canvas=i;const r={alpha:t.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:t.stencil??!0,powerPreference:"high-performance",preserveDrawingBuffer:t.preserveDrawingBuffer??!1},s=i.getContext("webgl2",r);if(null==s)return void _.Z.getLogger(this).error("A WebGL2 context could not be created.");(0,kS.zu)(s,!0),this._rctx=function(e,t){const i=(e,i)=>t.view.resourceController.memoryController.newCache(e,i),r={disabledExtensions:t.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:t.options.debugWebGLExtensions||{},maxAnisotropy:8,maxPreferredTexturePixels:t.view.qualitySettings.maxTexturePixels,newCache:i};if(SR){let t=ER.get(e);return t?(t.configure(r),t.ref(),t):(t=new lR(e,r),ER.set(e,t),t.ref(),t)}return new lR(e,r)}(s,e),this._loadShaderOnlyExtensions(),!t.alpha&&this._rctx.contextAttributes.alpha&&_.Z.getLogger(this).error("WebGL context has alpha channel even though no alpha channel was requested");const{container:n}=e;!this._rctx.contextAttributes.alpha&&(0,m.Z)("safari")>=11&&(n.style.backgroundColor="black"),n.contains(i)||n.appendChild(i)}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("textureFloatLinear")}get _viewingMode(){return this.stage.viewingMode}getObjectAndLayerIdColor(e){return this.olidRenderHelper?.getObjectAndLayerIdColor(e)}get componentObjectCollection(){return null==this._componentObjects&&(this._componentObjects=new jx(this.renderer.renderPassManager,this._viewingMode)),this._componentObjects}set componentObjectCollection(e){this._componentObjects=e}updateQualitySettings(e){this.test&&null!=this.test.time&&(this.test.savedFadeDuration=e.fadeDuration,e.fadeDuration=(0,Yr.HA)(0)),this._rctx.updateOptions({maxPreferredTexturePixels:this.stage.view.qualitySettings.maxTexturePixels})}};(0,o._)([(0,x.Cb)({type:Boolean,readOnly:!0})],MR.prototype,"updating",null),(0,o._)([(0,x.Cb)({constructOnly:!0})],MR.prototype,"stage",void 0),(0,o._)([(0,x.Cb)()],MR.prototype,"_rctx",void 0),(0,o._)([(0,x.Cb)()],MR.prototype,"_canvas",void 0),(0,o._)([(0,x.Cb)()],MR.prototype,"stippleTextures",void 0),(0,o._)([(0,x.Cb)()],MR.prototype,"markerTextures",void 0),(0,o._)([(0,x.Cb)()],MR.prototype,"waterTextures",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],MR.prototype,"olidRenderHelper",void 0),(0,o._)([(0,x.Cb)()],MR.prototype,"_textures",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],MR.prototype,"renderer",void 0),(0,o._)([(0,x.Cb)()],MR.prototype,"_screenshotManager",void 0),(0,o._)([(0,x.Cb)()],MR.prototype,"componentObjectCollection",null),(0,o._)([(0,x.Cb)()],MR.prototype,"_componentObjects",void 0),(0,o._)([(0,x.Cb)()],MR.prototype,"_needsUpdate",void 0),(0,o._)([(0,x.Cb)()],MR.prototype,"_needsWaterReflectionUpdate",void 0),MR=(0,o._)([(0,S.j)("esri.views.3d.webgl-engine.parts.RenderView")],MR);const ER=bR();let RR=class extends E.Z{constructor(e){super(e),this._model=new Zw,this._canCompact=(0,yr.t)(!1),this._layers=new ud.Z,this._asyncChangeSet=new Nw.as,this._syncChangeSet=new Nw.as,this._layerSyncSet=new Set,this.textures=new Y_(this,e.view.resourceController.scheduler),this._frameTask=e.view.resourceController.scheduler.registerTask(Gr.T8.STAGE,this),this.addHandles(this._frameTask)}initialize(){this._renderView=new MR({stage:this})}destroy(){this.textures.destroy(),this.renderView.destroy()}get viewingMode(){return this.view.state.viewingMode}get updating(){return this.running||this.renderView.updating||this._frameTask.updating||this.textures.updating}get renderView(){return this._renderView}get renderer(){return this.renderView.renderer}addTexture(e){this._model.addTexture(e),this.renderView.requestRender()}removeTexture(e){null!=e&&!this.destroyed&&this._model.hasTexture(e)&&(this._model.removeTexture(e),this.renderView.requestRender())}addTextures(e){null!=e&&(this._model.addTextures(e),this.renderView.requestRender())}removeTextures(e){null!=e&&(this._model?.removeTextures(e),this.renderView.requestRender())}forEachTexture(e){this._model.forEachTexture(e)}getTexture(e){return this._model.getTexture(e)}addLayer(e){this._layers.includes(e)||(this._model.addLayer(e),this._layers.push(e),this._model.dirtySet.layerAdded(e),this.renderView.requestRender())}removeLayer(e){null!=e&&!this.destroyed&&this._model.hasLayer((0,Se.CY)(e))&&(this._model.dirtySet.layerRemoved(e),this._commitLayer(e),this._layers.removeUnordered(e),this._model.dirtySet.assertLayerClean(e.id),this._model.removeLayer(e),this.renderView.requestRender())}getLayer(e){return this._model.getLayer(e)}handleEvent(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.requestRender())}get running(){return this._model.dirtySet.dirty||!this._asyncChangeSet.empty||this._canCompact.value}runTask(e){if(this._frameTask.processQueue(e),this._commit(e),this.renderer.compact(e),this._canCompact.value=this.renderer.canCompact,!e.hasProgressed)return qr.J}compact(e){return this._canCompact.value=!1,this.renderer.compact(e)}_commit(e){const t=this._model.dirtySet;this._asyncChangeSet.empty||e.done||(this.renderer.commit(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()),this._layers.forAll((i=>{if(e.done)return;const r=this._layerSyncSet.has(i.id)||i.updatePolicy===Uw.j.SYNC,s=r?this._syncChangeSet:this._asyncChangeSet;t.commitLayer(i.id,s),this._layerSyncSet.delete(i.id),s.empty||(this.renderer.commit(s,r?Gr.G5:e),this.renderView.requestRender(),e.madeProgress())})),this._syncChangeSet.empty||(this.renderer.commit(this._syncChangeSet,Gr.G5),this.renderView.requestRender(),e.madeProgress()),this._layers.forAll((i=>{e.done||this._layerSyncSet.has(i.id)||i.updatePolicy!==Uw.j.ASYNC||(t.commitLayer(i.id,this._asyncChangeSet),this._asyncChangeSet.empty||(this.renderer.commit(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()))})),this._layerSyncSet.clear(),this.notifyChange("running")}commitSyncLayers(){const e=this._model.dirtySet;this._layers.forAll((t=>{this._layerSyncSet.has(t.id)||t.updatePolicy===Uw.j.SYNC?(e.commitLayer(t.id,this._syncChangeSet),this._layerSyncSet.delete(t.id)):e.commitSyncUpdates(t.id,this._syncChangeSet)}));for(const t of this._layerSyncSet)e.commitLayer(t,this._syncChangeSet);this._layerSyncSet.clear(),this._syncChangeSet.empty||(this.renderer.commit(this._syncChangeSet,Gr.G5),this.renderView.requestRender())}_commitLayer(e){this._model.dirtySet.commitLayer(e.id,this._syncChangeSet),this._layerSyncSet.delete(e.id),this._syncChangeSet.empty||(this.renderer.commit(this._syncChangeSet,Gr.G5),this.renderView.requestRender())}schedule(e,t){return this._frameTask.schedule(e,t)}reschedule(e,t){return this._frameTask.reschedule(e,t)}syncLayer(e){this._layerSyncSet.add(e),this.renderView.requestRender()}get layers(){return this._layers}addRenderPlugin(e,t){const i=this.renderer.plugins.add(e,t),r=()=>{Ym(e)&&this.view.sceneIntersectionHelper.addIntersectionHandler(e)};if((0,y.y8)(i))return i.then(r);r()}removeRenderPlugin(e){this.destroyed||(Ym(e)&&this.view.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderer.plugins.remove(e))}get test(){}};(0,o._)([(0,x.Cb)({constructOnly:!0})],RR.prototype,"view",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],RR.prototype,"options",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],RR.prototype,"viewingMode",null),(0,o._)([(0,x.Cb)({constructOnly:!0})],RR.prototype,"container",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],RR.prototype,"updating",null),(0,o._)([(0,x.Cb)({constructOnly:!0})],RR.prototype,"_model",void 0),(0,o._)([(0,x.Cb)()],RR.prototype,"_renderView",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],RR.prototype,"renderer",null),(0,o._)([(0,x.Cb)()],RR.prototype,"textures",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],RR.prototype,"running",null),RR=(0,o._)([(0,S.j)("esri.views.3d.webgl-engine.Stage")],RR);var PR=i(45391),AR=i(63510);const OR=new Set,DR=()=>_.Z.getLogger("esri/views/support/TextureCompressionHelper");var IR=i(33776);i(55214);var LR=i(48207),FR=i(74765);const NR={left:0,top:0,bottom:0,right:0},UR={bottom:30,top:15,right:15,left:15},HR="esri-ui",VR={ui:HR,corner:`${HR}-corner`,innerContainer:`${HR}-inner-container`,manualContainer:`${HR}-manual-container`,cornerContainer:`${HR}-corner-container`,topLeft:`${HR}-top-left`,topRight:`${HR}-top-right`,bottomLeft:`${HR}-bottom-left`,bottomRight:`${HR}-bottom-right`};function kR(e){return 0===e?"0":`${e}px`}function BR(e){const t="object"==typeof e&&null!==e&&Object.getPrototypeOf(e);return null!==t&&t!==Object.prototype||!("component"in e||"index"in e||"position"in e)?null:e}function zR(e,{top:t,bottom:i,left:r,right:s}){e.style.top=t,e.style.bottom=i,e.style.left=r,e.style.right=s}let GR=class extends ae.Z.EventedAccessor{constructor(e){super(e),this._cornerNameToContainerLookup={},this._positionNameToContainerLookup={},this._components=new Array,this._componentMap=new Map,this._removeWidgetHandleKey=Symbol("componentOnRemoveSymbol"),this._locale=(0,FR.Kd)(),this.view=null,this._applyViewPadding=()=>{const e=this.container;e&&zR(e,this._toPixelPosition(this._getViewPadding()))},this._applyUIPadding=()=>{const e=this._innerContainer;e&&zR(e,this._toPixelPosition(this.padding))},this._initContainers()}initialize(){this.addHandles([(0,n.YP)((()=>[this.view?.padding,this.container]),this._applyViewPadding,n.nn),(0,n.YP)((()=>this.padding),this._applyUIPadding,n.nn),(0,n.YP)((()=>[this.container,this._locale]),(([e,t])=>{e&&e.setAttribute("lang",t)}),n.nn),(0,FR.qe)((e=>{this._locale=e}))])}destroy(){this.container=null;for(const e of this._components)e.destroy();this._components.length=0,this._componentMap.clear()}set container(e){const t=this._get("container");e!==t&&(e&&(e.classList.add(VR.ui),(0,LR.LO)(e),this._attachContainers(e)),t&&(t.classList.remove(VR.ui),zR(t,{top:"",bottom:"",left:"",right:""}),t.textContent=""),this._set("container",e))}get height(){const e=this.view?.height??0;if(0===e)return e;const t=this._getViewPadding(),{top:i,bottom:r}=t;return Math.max(e-i-r,0)}get padding(){return this._get("padding")}set padding(e){this._overrideIfSome("padding",e)}castPadding(e){return"number"==typeof e?{bottom:e,top:e,right:e,left:e}:{...UR,...e}}get width(){const e=this.view?.width??0;if(0===e)return e;const t=this._getViewPadding(),{left:i,right:r}=t;return Math.max(e-i-r,0)}add(e,t){let i,r,s;if(Array.isArray(e))return void e.forEach((e=>this.add(e,t)));const n=BR(e);n&&({index:i,position:t,component:e,key:r}=n),t&&"object"==typeof t&&({index:i,key:r,position:t,internal:s}=t),!e||t&&!this._isValidPosition(t)||this._add(e,t,i??this._getNumComponentsAtPosition(t),r,s)}remove(e,t){if(!e)return;if(Array.isArray(e))return e.map((e=>this.remove(e,t)));const i=this._find(e);if(i){const e=this._componentMap.get(i);if(!e||e.key!==t)return;const r=this._components.indexOf(i);return i.node.parentNode?.removeChild(i.node),this._componentMap.delete(i),i.widget?.removeHandlesReference(this._removeWidgetHandleKey),this._components.forEach((t=>{const i=this._componentMap.get(t);i&&i.position===e.position&&i.index>e.index&&i.index--})),this._components.splice(r,1)[0]}}empty(e,t={removeInternal:!1}){if(Array.isArray(e)){for(const i of e)this.empty(i,t);return}const i=this._positionNameToContainerLookup[e??"manual"],r=Array.prototype.slice.call(i.children).map((e=>this._findByNode(e))).filter((e=>null!=e&&(!this._componentMap.get(e)?.internal||t.removeInternal)));for(const e of r)this.remove(e)}move(e,t){if(Array.isArray(e)&&e.forEach((e=>this.move(e,t))),!e)return;let i;const r=BR(e)||BR(t);if(r&&(i=r.index,t=r.position,e=r.component||e),t&&!this._isValidPosition(t))return;const s=this.remove(e);s&&this.add(s,{position:t,index:i})}find(e){if(!e)return null;const t=this._findById(e);return t&&(t.widget||t.node)}getComponents(e,t={includeInternal:!1}){return e?Array.isArray(e)?e.flatMap((e=>this._getComponentsAtPosition(e,t))):this._getComponentsAtPosition(e,t):this._components.filter((e=>t.includeInternal||!this._componentMap.get(e)?.internal)).map((({widget:e,node:t})=>e??t))}getPosition(e){for(const t in this._positionNameToContainerLookup)if(this._positionNameToContainerLookup[t].contains(e))return t;return null}_add(e,t,i,r,s){e instanceof fh||(e=new fh({node:e}));const{widget:n}=e;null!=n&&n instanceof E.Z&&n.addHandles((0,p.kB)((()=>{queueMicrotask((()=>this.remove(e)))})),this._removeWidgetHandleKey),this._components.some((e=>this._componentMap.get(e)?.position===t&&this._componentMap.get(e)?.index===i))&&this._components.forEach((e=>{const r=this._componentMap.get(e);r&&r.position===t&&r.index>=i&&r.index++})),this._place({component:e,position:t,index:i}),this._components.push(e),this._componentMap.set(e,{key:r,position:t,internal:s,index:i})}_find(e){return e?e instanceof fh?this._findByComponent(e):"string"==typeof e?this._findById(e):"domNode"in e?this._findByNode(e.domNode):this._findByNode(e):null}_getViewPadding(){return this.view?.padding??NR}_attachContainers(e){e.appendChild(this._innerContainer),e.appendChild(this._manualContainer)}_initContainers(){const e=document.createElement("div");e.classList.add(VR.innerContainer,VR.cornerContainer);const t=document.createElement("div");t.classList.add(VR.innerContainer,VR.manualContainer);const i=document.createElement("div");i.classList.add(VR.topLeft,VR.corner),e.appendChild(i);const r=document.createElement("div");r.classList.add(VR.topRight,VR.corner),e.appendChild(r);const s=document.createElement("div");s.classList.add(VR.bottomLeft,VR.corner),e.appendChild(s);const n=document.createElement("div");n.classList.add(VR.bottomRight,VR.corner),e.appendChild(n),this._innerContainer=e,this._manualContainer=t;const a=(0,vh.dZ)();this._cornerNameToContainerLookup={"top-left":i,"top-right":r,"bottom-left":s,"bottom-right":n,"top-leading":a?r:i,"top-trailing":a?i:r,"bottom-leading":a?n:s,"bottom-trailing":a?s:n},this._positionNameToContainerLookup={manual:t,...this._cornerNameToContainerLookup}}_isValidPosition(e){return!!this._positionNameToContainerLookup[e]}_place(e){const t=e.position??"manual",{component:i,index:r}=e,s=this._positionNameToContainerLookup[t],n=null!=r&&r>-1;if(function(e){return e&&!e._started&&"function"==typeof e.postMixInProperties&&"function"==typeof e.buildRendering&&"function"==typeof e.postCreate&&"function"==typeof e.startup}(i.widget)&&i.widget.startup(),!n)return void s.appendChild(i.node);const a=Array.from(s.children);if(0!==a.length){for(const e of a){const t=this._findByNode(e);if(t&&r<(this._componentMap.get(t)?.index??0))return void e.parentNode?.insertBefore(i.node,e)}s.appendChild(i.node)}else s.appendChild(i.node)}_toPixelPosition(e){return{top:kR(e.top),left:kR(e.left),right:kR(e.right),bottom:kR(e.bottom)}}_findByComponent(e){return this._components.find((t=>t===e))??null}_findById(e){return this._components.find((({id:t})=>t===e))??null}_findByNode(e){return e?this._components.find((({node:t})=>t===e)):null}_getComponentsAtPosition(e,t){const i=this._positionNameToContainerLookup[e];return Array.prototype.slice.call(i.children).map((e=>this._findByNode(e))).filter(St.pC).filter((e=>t.includeInternal||!this._componentMap.get(e)?.internal)).map((({widget:e,node:t})=>e??t))}_getNumComponentsAtPosition(e){return this._positionNameToContainerLookup[e]?.children.length??0}};(0,o._)([(0,x.Cb)()],GR.prototype,"_locale",void 0),(0,o._)([(0,x.Cb)()],GR.prototype,"container",null),(0,o._)([(0,x.Cb)()],GR.prototype,"height",null),(0,o._)([(0,x.Cb)({value:UR})],GR.prototype,"padding",null),(0,o._)([(0,T.p)("padding")],GR.prototype,"castPadding",null),(0,o._)([(0,x.Cb)()],GR.prototype,"view",void 0),(0,o._)([(0,x.Cb)()],GR.prototype,"width",null),GR=(0,o._)([(0,S.j)("esri.views.ui.UI")],GR);const qR=GR;var ZR=i(23195);function jR(e,t){return e&&"copyright"in e&&(!t||"function"==typeof e.originOf&&"user"===e.originOf("copyright"))}function WR(e,t,i){i&&t&&(e.find((e=>e.layerView===t&&e.text===i))||e.push({text:i,layerView:t}))}const $R=[];let XR=class extends E.Z{constructor(e){super(e),this._clear=()=>{this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.removeHandles("suspension"),this.notifyChange("state")},this._pendingAttributions=new Set,this._fetchedAttributionData=new Map,this.items=new c.Z,this.view=null,this._allLayerViewsChange=e=>{this.removeHandles("suspension"),this.removeHandles("visible-geometry-changed");const t=this.view?.allLayerViews;t&&(this.addHandles(t.map((e=>(0,n.YP)((()=>[e.suspended,e.layer?.attributionVisible]),(()=>this._updateAttributionItems())))).toArray(),"suspension"),t.forEach((e=>{"esri.views.3d.layers.Tiles3DLayerView3D"===e.declaredClass&&this.addHandles(e.on("visible-geometry-changed",(()=>this._updateAttributionItems())),"visible-geometry-changed")}))),e?.removed&&e.removed.forEach((e=>{this._pendingAttributions.delete(e),this._fetchedAttributionData.delete(e)})),this._updateAttributionItems()},this.addHandles([(0,n.on)((()=>this.view?.allLayerViews),"change",(e=>this._allLayerViewsChange(e)),{onListenerAdd:()=>this._allLayerViewsChange(),onListenerRemove:this._clear}),(0,n.gx)((()=>!0===this.view?.stationary),(()=>this._updateAttributionItems()))])}destroy(){this.view=null,this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.items.removeAll()}get state(){return this.view?.ready?this._pendingAttributions.size>0?"loading":"ready":"disabled"}_updateAttributionItems(){const e=this.view,t=e?.allLayerViews;if($R.length=0,!e||!t)return void this._clear();t.forEach((t=>{if(t.suspended||!t.layer?.attributionVisible)return;const i=t.layer;if(jR(i,"user"))return void WR($R,t,i.copyright);if(i.hasAttributionData){if(this._fetchedAttributionData.has(t)){const r=this._fetchedAttributionData.get(t);return void(r?WR($R,t,this._getDynamicAttribution(r,e,i)):jR(i)&&WR($R,t,i.copyright))}return void this._fetchAttributionData(t)}const r="portalItem"in i?i.portalItem?.accessInformation:void 0;WR($R,t,r||i.copyright)}));const i=t.find((e=>"integrated-mesh-3dtiles"===e.layer?.type));if(this.view&&i){const e=(0,ZR.WM)(this.view);if(e){const t=e.getAttributionText();for(let e=0;e<t.length;++e)WR($R,i,t[e])}}(function(e,t){return e.length!==t.length||e.some(((e,i)=>e.text!==t[i].text))})(this.items,$R)&&(this.items.removeAll(),this.items.addMany($R)),$R.length=0,this.notifyChange("state")}async _fetchAttributionData(e){if(this._pendingAttributions.has(e))return;this._pendingAttributions.add(e);const t=await(0,me.q6)(e.layer.fetchAttributionData());if(this._pendingAttributions.has(e)){const i=t.ok?this._createContributionIndex(t.value,function(e){return"bing-maps"===e.type}(e.layer)):null;this._pendingAttributions.delete(e),this._fetchedAttributionData.set(e,i)}this._updateAttributionItems()}_createContributionIndex(e,t){const i=e.contributors,r={};if(!i)return r;for(let e=0;e<i.length;e++){const s=i[e],n=s.coverageAreas;if(!n)return;for(const i of n){const n=i.bbox,a=i.zoomMin-(t&&i.zoomMin?1:0),o=i.zoomMax-(t&&i.zoomMax?1:0),l=new I.Z({xmin:n[1],ymin:n[0],xmax:n[3],ymax:n[2],spatialReference:N.Z.WGS84}),c={extent:(0,ag.$)(l),attribution:s.attribution||"",score:null!=i.score?i.score:100,id:e};for(let e=a;e<=o;e++)r[e]??=[],r[e].push(c)}}return r.maxKey=Math.max.apply(null,Object.keys(r)),r}_getDynamicAttribution(e,t,i){const{extent:r,scale:s}=t;let n=i.tileInfo?.scaleToZoom(s)??0;if(n=Math.min(e.maxKey??0,Math.round(n)),!r||null==n||n<=-1)return"";const a=e[n],o=(0,ag.iV)(r.center.clone().normalize(),N.Z.WebMercator),l=new Set;return a?a.filter((e=>{const t=e.id,i=!l.has(t)&&o&&e.extent&&(0,oe.aV)(e.extent,o);return i&&l.add(t),i})).sort(((e,t)=>t.score-e.score||e.objectId-t.objectId)).map((e=>e.attribution)).join(", "):""}};(0,o._)([(0,x.Cb)({readOnly:!0,type:c.Z})],XR.prototype,"items",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],XR.prototype,"state",null),(0,o._)([(0,x.Cb)()],XR.prototype,"view",void 0),XR=(0,o._)([(0,S.j)("esri.widgets.Attribution.AttributionViewModel")],XR);const YR=XR;var QR=i(46512),KR=i(80079);const JR="esri-attribution",eP={base:JR,poweredBy:`${JR}__powered-by`,sources:`${JR}__sources`,open:`${JR}--open`,sourcesOpen:`${JR}__sources--open`,link:`${JR}__link`};let tP=class extends yh.Z{constructor(e,t){super(e,t),this._isOpen=!1,this._attributionTextOverflowed=!1,this._prevSourceNodeHeight=0,this._resizeObserver=new ResizeObserver((e=>e.forEach((({target:e})=>this._checkSourceTextOverflow(e))))),this.itemDelimiter=" | ",this.messages=null,this.viewModel=new YR}initialize(){this.addHandles((0,n.on)((()=>this.viewModel?.items),"change",(()=>this.scheduleRender())))}destroy(){this._resizeObserver?.disconnect()}get _isInteractive(){return this._isOpen||this._attributionTextOverflowed}get attributionText(){return this.viewModel.items.reduce(((e,t)=>(e.includes(t.text)||e.push(t.text),e)),[]).join(this.itemDelimiter)}get icon(){return"description"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}render(){const e={[eP.open]:this._isOpen};return(0,wh.u)("div",{bind:this,class:this.classes(eP.base,QR.z.widget,e),dir:"ltr",onclick:this._toggleState,onkeydown:this._toggleState},this._renderSourcesNode(),this._renderPoweredBy())}_renderPoweredBy(){return(0,wh.u)("div",{class:eP.poweredBy},"Powered by"," ",(0,wh.u)("a",{class:eP.link,href:"https://www.esri.com/",rel:"noreferrer",target:"_blank"},"Esri"))}_renderSourcesNode(){const e=this._isOpen,t=this._isInteractive,i=t?0:void 0,{attributionText:r}=this,s={[eP.sourcesOpen]:e,[QR.z.interactive]:t};return(0,wh.u)("div",{afterCreate:this._afterSourcesNodeCreate,bind:this,class:this.classes(eP.sources,s),innerHTML:r,tabIndex:i})}_afterSourcesNodeCreate(e){this._prevSourceNodeHeight=e.clientWidth,this._resizeObserver.observe(e)}_checkSourceTextOverflow(e){let t=!1;const{clientHeight:i,clientWidth:r,scrollWidth:s}=e,n=s>r,a=this._attributionTextOverflowed!==n;if(this._attributionTextOverflowed=n,a&&(t=!0),this._isOpen){const e=i<this._prevSourceNodeHeight;this._prevSourceNodeHeight=i,e&&(this._isOpen=!1,t=!0)}t&&this.scheduleRender()}_toggleState(){this._isInteractive&&(this._isOpen=!this._isOpen)}};(0,o._)([(0,x.Cb)()],tP.prototype,"_isOpen",void 0),(0,o._)([(0,x.Cb)()],tP.prototype,"_isInteractive",null),(0,o._)([(0,x.Cb)()],tP.prototype,"_attributionTextOverflowed",void 0),(0,o._)([(0,x.Cb)()],tP.prototype,"_prevSourceNodeHeight",void 0),(0,o._)([(0,x.Cb)({readOnly:!0,dependsOn:["viewModel.items.length","itemDelimiter"]})],tP.prototype,"attributionText",null),(0,o._)([(0,x.Cb)()],tP.prototype,"icon",null),(0,o._)([(0,x.Cb)()],tP.prototype,"itemDelimiter",void 0),(0,o._)([(0,x.Cb)()],tP.prototype,"label",null),(0,o._)([(0,x.Cb)(),(0,bh.H)("esri/widgets/Attribution/t9n/Attribution")],tP.prototype,"messages",void 0),(0,o._)([(0,x.Cb)()],tP.prototype,"view",null),(0,o._)([(0,x.Cb)({type:YR})],tP.prototype,"viewModel",void 0),(0,o._)([(0,KR.h)()],tP.prototype,"_toggleState",null),tP=(0,o._)([(0,S.j)("esri.widgets.Attribution")],tP);const iP=tP;function rP(){const e=(0,m.Z)("mapview-essential-goto-duration");return null==e?e:(0,Yr.HA)(e)}var sP=i(63712);let nP=class extends((0,sP.Z)(E.Z)){constructor(e){super(e),this.orientation={x:0,y:0,z:0},this.view=null,this._updateForCamera=this._updateForCamera.bind(this),this._updateForRotation=this._updateForRotation.bind(this),this._updateRotationWatcher=this._updateRotationWatcher.bind(this)}initialize(){this._watchForView(n.nn)}destroy(){this.view=null}get canShowNorth(){return function(e){return e?.spatialReference?.isWebMercator||e?.spatialReference?.isGeographic||!1}(this.view)}get state(){return!this.view?.ready||"2d"===this.view.type&&!this.view.constraints.rotationEnabled?"disabled":this.canShowNorth?"compass":"rotation"}reset(){this.view?.ready&&("2d"===this.view?.type?this.callGoTo({target:{rotation:0},options:{animationMode:"always",duration:rP()}}):this.callGoTo({target:{heading:0}}))}_updateForRotation(e){null!=e&&this._set("orientation",{z:e})}_updateForCamera(e){if(!e)return;const t=-e.heading;this._set("orientation",{x:0,y:0,z:t})}_updateRotationWatcher(e){this.removeAllHandles(),this._watchForView(),e&&this.addHandles("2d"===e.type?(0,n.YP)((()=>e?.rotation),this._updateForRotation,n.nn):(0,n.YP)((()=>e?.camera),this._updateForCamera,n.nn))}_watchForView(e){this.addHandles((0,n.YP)((()=>this.view),this._updateRotationWatcher,e))}};(0,o._)([(0,x.Cb)({readOnly:!0})],nP.prototype,"canShowNorth",null),(0,o._)([(0,x.Cb)({readOnly:!0})],nP.prototype,"orientation",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],nP.prototype,"state",null),(0,o._)([(0,x.Cb)()],nP.prototype,"view",void 0),nP=(0,o._)([(0,S.j)("esri.widgets.Compass.CompassViewModel")],nP);const aP=nP,oP="esri-compass",lP={base:oP,iconContainer:`${oP}__icon-container`};var cP=i(84644);let hP=class extends yh.Z{constructor(e,t){super(e,t),this.messages=null,this.viewModel=new aP,this._reset=()=>{this.viewModel.reset()},this._toRotationTransform=e=>({transform:`rotateZ(${e.z}deg)`})}loadDependencies(){return(0,cP.h)({button:()=>Promise.all([i.e(58268),i.e(55001),i.e(73105),i.e(61637)]).then(i.bind(i,61637)),icon:()=>Promise.all([i.e(58268),i.e(4204)]).then(i.bind(i,4204))})}get goToOverride(){return this.viewModel.goToOverride}set goToOverride(e){this.viewModel.goToOverride=e}get icon(){return"rotation"===this.viewModel.state?"arrow-up":"compass-needle"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}reset(){return this.viewModel.reset()}render(){const{orientation:e,state:t}=this.viewModel,{messages:i}=this;return(0,wh.u)("div",{class:this.classes(lP.base,QR.z.widget)},(0,wh.u)("calcite-button",{class:QR.z.widgetButton,disabled:"disabled"===t,kind:"neutral",label:i.reset,onclick:this._reset,round:!0,scale:"s",title:i.reset},(0,wh.u)("div",{"aria-hidden":"true",class:lP.iconContainer,title:i.reset},(0,wh.u)("calcite-icon",{icon:this.icon,styles:this._toRotationTransform(e)}))))}};(0,o._)([(0,x.Cb)()],hP.prototype,"goToOverride",null),(0,o._)([(0,x.Cb)()],hP.prototype,"icon",null),(0,o._)([(0,x.Cb)()],hP.prototype,"label",null),(0,o._)([(0,x.Cb)(),(0,bh.H)("esri/widgets/Compass/t9n/Compass")],hP.prototype,"messages",void 0),(0,o._)([(0,x.Cb)()],hP.prototype,"view",null),(0,o._)([(0,x.Cb)({type:aP})],hP.prototype,"viewModel",void 0),hP=(0,o._)([(0,S.j)("esri.widgets.Compass")],hP);const uP=hP,dP="esri-navigation-toggle",pP=dP,mP=`${dP}--horizontal`;let _P=class extends E.Z{constructor(e){super(e),this._navigationMode="pan",this.view=null,e?.isDefaultViewModel||(0,fi._O)(_.Z.getLogger(this),"Navigation Toggle","arcgis-navigation-toggle",{version:"4.33"})}normalizeCtorArgs(e={}){const{isDefaultViewModel:t,...i}=e;return i}initialize(){this.addHandles((0,n.gx)((()=>this.view?.navigation?.actionMap),(()=>this._updateNavigationActionMap())))}destroy(){this.view=null}get state(){return this.view?.ready&&"3d"===this.view?.type?"ready":"disabled"}get navigationMode(){return this._navigationMode}set navigationMode(e){this._navigationMode=e,this._updateNavigationActionMap()}toggle(){"disabled"!==this.state&&(this.navigationMode="pan"!==this.navigationMode?"pan":"rotate")}_updateNavigationActionMap(){const e=this.view?.navigation?.actionMap;if(!e)return;const t="pan"===this._navigationMode;e.dragPrimary=t?"pan":"rotate",e.dragSecondary=t?"rotate":"pan"}};(0,o._)([(0,x.Cb)({readOnly:!0})],_P.prototype,"state",null),(0,o._)([(0,x.Cb)()],_P.prototype,"_navigationMode",void 0),(0,o._)([(0,x.Cb)()],_P.prototype,"view",void 0),_P=(0,o._)([(0,S.j)("esri.widgets.NavigationToggle.NavigationToggleViewModel")],_P);const fP=_P;let gP=class extends yh.Z{constructor(e,t){super(e,t),this.messages=null,this.viewModel=new fP({isDefaultViewModel:!0}),this.toggle=()=>this.viewModel.toggle(),this._panButton=null,this._rotateButton=null,this._toggle=()=>{const e="pan"===this.viewModel?.navigationMode?this._rotateButton:this._panButton;(0,vh.kW)(e),this.toggle()},e?.isDefaultUI||(0,fi.Pq)(_.Z.getLogger(this),"Navigation Toggle","arcgis-navigation-toggle",{version:"4.32"})}normalizeCtorArgs(e={}){const{isDefaultUI:t,...i}=e;return i}loadDependencies(){return(0,cP.h)({button:()=>Promise.all([i.e(58268),i.e(55001),i.e(73105),i.e(61637)]).then(i.bind(i,61637))})}get icon(){return"move"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}set layout(e){"horizontal"!==e&&(e="vertical"),this._set("layout",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}render(){const e="disabled"===this.viewModel?.state,t="pan"===this.viewModel?.navigationMode,i=this.messages.toggle;return(0,wh.u)("div",{class:this.classes(pP,QR.z.widget,{[mP]:"horizontal"===this.layout})},(0,wh.u)("calcite-button",{afterCreate:e=>{this._panButton=e},appearance:t?"outline-fill":"solid",class:QR.z.widgetButton,disabled:e,iconStart:"move",kind:"neutral",label:i,onclick:this._toggle,tabIndex:t?void 0:-1,title:i}),(0,wh.u)("calcite-button",{afterCreate:e=>{this._rotateButton=e},appearance:t?"solid":"outline-fill",class:QR.z.widgetButton,disabled:e,iconStart:"rotate",kind:"neutral",label:i,onclick:this._toggle,tabIndex:t?-1:void 0,title:i}))}};(0,o._)([(0,x.Cb)()],gP.prototype,"icon",null),(0,o._)([(0,x.Cb)()],gP.prototype,"label",null),(0,o._)([(0,x.Cb)({value:"vertical"})],gP.prototype,"layout",null),(0,o._)([(0,x.Cb)(),(0,bh.H)("esri/widgets/NavigationToggle/t9n/NavigationToggle")],gP.prototype,"messages",void 0),(0,o._)([(0,x.Cb)()],gP.prototype,"view",null),(0,o._)([(0,x.Cb)({type:fP})],gP.prototype,"viewModel",void 0),gP=(0,o._)([(0,S.j)("esri.widgets.NavigationToggle")],gP);const yP=gP;var vP=i(93427);const bP="esri-zoom",wP="esri-zoom--horizontal";let CP=class extends yh.Z{constructor(e,t){super(e,t),this.messages=null,this.viewModel=new vP.Z,this.zoomIn=()=>this.viewModel.zoomIn(),this.zoomOut=()=>this.viewModel.zoomOut()}loadDependencies(){return(0,cP.h)({button:()=>Promise.all([i.e(58268),i.e(55001),i.e(73105),i.e(61637)]).then(i.bind(i,61637))})}get icon(){return"magnifying-glass-plus"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}set layout(e){"horizontal"!==e&&(e="vertical"),this._set("layout",e)}set view(e){this.viewModel.view=e}get view(){return this.viewModel.view}render(){const e={[wP]:"horizontal"===this.layout},{canZoomIn:t,canZoomOut:i}=this.viewModel,{zoomIn:r,zoomOut:s}=this.messages;return(0,wh.u)("div",{class:this.classes(bP,QR.z.widget,e)},(0,wh.u)("calcite-button",{class:QR.z.widgetButton,disabled:!t,iconStart:"plus",kind:"neutral",label:r,onclick:this.zoomIn,title:r}),(0,wh.u)("calcite-button",{class:QR.z.widgetButton,disabled:!i,iconStart:"minus",kind:"neutral",label:s,onclick:this.zoomOut,title:s}))}};(0,o._)([(0,x.Cb)()],CP.prototype,"icon",null),(0,o._)([(0,x.Cb)()],CP.prototype,"label",null),(0,o._)([(0,x.Cb)({value:"vertical"})],CP.prototype,"layout",null),(0,o._)([(0,x.Cb)(),(0,bh.H)("esri/widgets/Zoom/t9n/Zoom")],CP.prototype,"messages",void 0),(0,o._)([(0,x.Cb)()],CP.prototype,"view",null),(0,o._)([(0,x.Cb)({type:vP.Z})],CP.prototype,"viewModel",void 0),CP=(0,o._)([(0,S.j)("esri.widgets.Zoom")],CP);const xP=CP;let TP=class extends qR{constructor(e){super(e),this._defaultPositionLookup={attribution:"manual",compass:"top-left","navigation-toggle":"top-left",zoom:"top-left"},this.components=[],this._updateViewAwareWidgets=e=>{this.components.forEach((t=>{const i=this._find(t)?.widget;(function(e){return void 0!==e?.view})(i)&&(i.view=e)}))},this._componentsWatcher=(e,t)=>{this._removeComponents(t),this._addComponents(e),this._adjustPadding(e)}}initialize(){this.addHandles([(0,n.YP)((()=>this.components),this._componentsWatcher,n.nn),(0,n.YP)((()=>this.view),this._updateViewAwareWidgets,n.nn)])}_add(e,t,i,r,s){let n=e;if("string"==typeof e&&this._defaultPositionLookup[e]){if(this._find(e))return;n=this._createComponent(e)}super._add(n,t,i,r,s)}_removeComponents(e){e.forEach((e=>{const t=this._find(e);t&&(this.remove(t),t.destroy())}))}_adjustPadding(e){if(!e.includes("attribution")&&!this._isOverridden("padding")){const{top:e}=this.padding;this.padding=e}}_addComponents(e){this.constructed&&e.forEach((e=>this.add(this._createComponent(e),this._defaultPositionLookup[e])))}_createComponent(e){const t=this._createWidget(e);return new fh({id:e,node:t})}_createWidget(e){const t=this.view;switch(e){case"attribution":return new iP({view:t});case"compass":return new uP({view:t});case"navigation-toggle":return new yP({view:t,isDefaultUI:!0});case"zoom":return new xP({view:t})}}};(0,o._)([(0,x.Cb)()],TP.prototype,"components",void 0),TP=(0,o._)([(0,S.j)("esri.views.ui.DefaultUI")],TP);const SP=TP;let MP=class extends SP{constructor(e){super(e),this.components=["attribution","zoom","navigation-toggle","compass"]}};(0,o._)([(0,x.Cb)()],MP.prototype,"components",void 0),MP=(0,o._)([(0,S.j)("esri.views.ui.3d.DefaultUI3D")],MP);const EP=MP;let RP=class extends(X(ye(se(Bi)))){constructor(e){super(e),this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._overrideDefaultEnvironmentOnly=!0,this._resolveWhenReady=[],this._resourceController=function(e){return new k_({view:e})}(this),this.deconflictor=new np({view:this}),this.labeler=new op.S({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.analyses=new G,this.basemapTerrain=null,this.elevationProvider=null,this.canvas=null,this.constraints=new pr,this.environment=new On,this.environmentManager=new an,this.floors=new c.Z,this.fullOpacity=1,this.graphicsView=null,this.analysisViewManager=new tr({view:this}),this.groundView=null,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new Im({view:this}),this.slice=new sf,this.spatialReference=null,this.alphaCompositingEnabled=!1,this.preserveDrawingBufferEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new EP,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this._importControllers=new Map,(0,C.j2)();const t=(e=null)=>{null!=e&&e.type===g.y.MOVE||(this._updatingChanged(),this.map?.allLayers.forEach((async e=>{try{await e.when()}catch{}this._updatingChanged()})))};this.addHandles([(0,n.on)((()=>this.map?.allLayers),"after-changes",(e=>t(e)),{onListenerAdd:()=>t(),onListenerRemove:()=>t(),sync:!0}),this.allLayerViews.on("after-changes",(e=>this._updateUpdatingMonitors(e))),(0,n.YP)((()=>this.scene),(e=>e?.load().catch((()=>{}))))]),this.inputManager=new ld({view:this}),this.stateManager=new Qc({view:this})}initialize(){if((0,m.Z)("enable-feature:esri-compress-textures")&&(0,m.Z)("wasm-simd")){const e=function(e,t){return Pd.x.compressionWorkerHandle??=new Rb((0,AR.H)(t)),OR.has(e)?DR().warn("Repeated texture compression worker initialization by the same view."):OR.add(e),Pd.x.compressionWorkerHandle}(this,this.resourceController);this.addResolvingPromise(e.promise)}this.groundView=new pe({view:this}),this._updateUpdatingMonitors(),this.updatingHandles.add((()=>this.qualitySettings.memoryLimit),(e=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=e)}),n.nn),this.updatingHandles.add((()=>this.qualitySettings.additionalCacheMemory),(e=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=e)}),n.nn),this.updatingHandles.add((()=>this.qualitySettings.frameRate??0),(e=>(0,v.bP)(e>0?1e3/Math.ceil(e):0)),n.nn),this.addHandles([(0,n.YP)((()=>this.spatialReference),(()=>this.notifyChange("clippingArea")),n.Z_),(0,n.YP)((()=>({plane:this.slice.plane,isDecoration:this.slice.isDecoration})),(()=>this._updateSlice()),n.Z_)])}destroy(){this.destroyed||(function(e){Pd.x.compressionWorkerHandle&&(OR.delete(e)||DR().warn("Unknown view attempted to destroy the texture compression worker."),OR.size||((0,f.SC)(Pd.x.compressionWorkerHandle),Pd.x.compressionWorkerHandle=null))}(this),this.updatingHandles.removeAll(),this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._set("analysisViewManager",(0,f.SC)(this.analysisViewManager)),this._exitSurface(),this._disposeGraphicsView(),this._disposeFocusAreasView(),this.sharedSymbolResources=(0,f.SC)(this.sharedSymbolResources),this._set("labeler",(0,f.SC)(this.labeler)),this._set("deconflictor",(0,f.SC)(this.deconflictor)),this._resourceController=(0,f.SC)(this._resourceController),this._set("stateManager",(0,f.SC)(this.stateManager)),this._set("inputManager",(0,f.SC)(this.inputManager)),this.state.destroy(),this.highlights.destroy(),this.removeHandles("updatingMonitors"),this._set("environmentManager",(0,f.SC)(this.environmentManager)),this._set("environment",(0,f.SC)(this.environment)),this.groundView=(0,f.SC)(this.groundView),this._exitBasemapTerrain(),this.stage?.destroy(),this.slice.destroy())}get stage(){return this._stage}get renderSpatialReference(){return this.renderCoordsHelper?.spatialReference}get basemapSpatialReference(){return this.basemapTerrain?.spatialReference}get animation(){return this.state?.animation}get camera(){return this.stateManager?.camera}set camera(e){this.stateManager&&(this.stateManager.camera=e)}get contentCamera(){return this.stateManager?.contentCamera}set contentCamera(e){this.stateManager&&(this.stateManager.contentCamera=e)}installContentCameraReset(e={sticky:!1}){return this.stateManager.installContentCameraReset(e)}get center(){return this.stateManager?.center}set center(e){this.stateManager&&(this.stateManager.center=e)}get clippingArea(){if("global"===this.viewingMode)return null;const e=this.map;let t=this._userClippingArea||(0,f.aF)(e,"clippingArea");return!this._userClippingArea&&!(0,f.aF)(e,"clippingEnabled")||null==t?(this._clippingArea=null,null):t instanceof I.Z?this.spatialReference&&(t=PP(t,this.spatialReference),null==t)?(_.Z.getLogger(this).error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(t=t.clone(),null==t.intersection(this._groundAndLayersExtent)&&(t.xmin=t.xmax,t.ymin=t.ymax),t.zmin=void 0,t.zmax=void 0,t.equals(this._clippingArea)||(this._clippingArea=t),this._clippingArea):(_.Z.getLogger(this).error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(e){this.ready&&"global"===this.viewingMode&&null!=e?_.Z.getLogger(this).error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=e}get renderDataExtent(){if(this.state.viewingMode===Si.JY.Global)return null;const e=this.renderSpatialReference,t=this.dataExtent;return null==t||null==e||t.spatialReference.equals(e)?t:PP(t,e)}get tileInfo(){return this.basemapTerrain?.tilingScheme?.toTileInfo()}get dataExtent(){let e=this._groundAndLayersExtent;const t=this.spatialReference||N.Z.WGS84,i=PP(this.clippingArea,t);null!=i&&(e=null!=e?e.intersection(i):i);const r=this._get("dataExtent");return null!=e&&e.equals(r)?r:e}get _groundAndLayersExtent(){const e=this.spatialReference||N.Z.WGS84;let t;const i=i=>{const r=PP(i,e);null!=r&&(null!=t?t.union(r):t=r.clone())},r=this.basemapTerrain;if(r?.spatialReference){const e=r.groundExtent;i(new I.Z({xmin:e[0],ymin:e[1],zmin:0,xmax:e[2],ymax:e[3],zmax:0,spatialReference:r.spatialReference}))}if(this.map?.allLayers.forEach((e=>(e=>{null==e.fullExtent||"graphics"===e.type&&e.internal||i(e.fullExtent)})(e))),null==t)return null;t.hasZ?(t.zmin=Math.min(0,t.zmin??0),t.zmax=Math.max(0,t.zmax??0)):(t.zmin=0,t.zmax=0);const s=this._get("_groundAndLayersExtent");return t.equals(s)?s:t}castEnvironment(e){return e?e instanceof On?e:e instanceof Rn?this.environment?.cloneWithWebsceneEnvironment(e)??On.fromWebsceneEnvironment(e):(0,M.se)(On,e):new On}get extent(){return this.stateManager?.extent}set extent(e){this.stateManager&&(this.stateManager.extent=e)}get screenCenter(){return this.stateManager?.screenCenter}get frustum(){return this.stateManager?.frustum}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get defaultsFromMapSettings(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}get interacting(){return this.navigating||(this.toolViewManager?.interacting??!1)}get stationary(){return!this.animation&&!this.resizing&&(this.state?.stationary??!0)}get navigating(){return this.state?.navigating??!1}get scene(){return this.map&&q.x in this.map?this.map:null}get padding(){return this.stateManager?.padding}set padding(e){this.stateManager&&(this.stateManager.padding=e)}set qualityProfile(e){u_.isValidProfile(e)&&(u_.apply(e,this.qualitySettings),this.stage?.renderView.updateQualitySettings(this.qualitySettings),this._set("qualityProfile",e))}get qualityProfile(){return this._get("qualityProfile")||u_.getDefaultProfile()}_updateSlice(){null!=this.stage&&(this.stage.renderer.slice=this.slice)}get typeSpecificPreconditionsReady(){return!!this.viewingMode&&!!this.stateManager?.preinit(this.spatialReference)}get resolution(){return null!=this.spatialReference?(0,B.dp)(this.scale,this.spatialReference):0}get scale(){return this.stateManager?.scale}set scale(e){this.stateManager&&(this.stateManager.scale=e)}get heightModelInfo(){const e=this.getDefaultHeightModelInfo();return null!=e?L.Z.deriveUnitFromSR(e,this.spatialReference):null}get updating(){if(this.destroying||this.destroyed)return!1;let e=0,t=this.layerViewManager.updating,i=t?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach((r=>{if(r.isFulfilled()){if(r.updating){if(t=!0,r.suspended||(0,eg.wP)(r))return;++i,e+=r.updatingProgress}}else++i}));for(const t of this._updatingObjects)if(null!=t&&t.updating){const t=.1;i+=t,e+=.5*t}for(const t of this._updatingObjectsWithProgress)null!=t&&t.updating&&(++i,e+=t.updatingProgress);const r=!this.stateManager.test.updatingIgnoreRenderState&&this.state.updating;if(t=!!(t||i>0||this.updatingHandles.updating||!this.ready||!this.stationary||r||this._importControllers.size>0||this.inputManager?.updating||this.map?.allLayers?.some((e=>!e.isFulfilled()))),t?(this._numUpdating=Math.max(i,this._numUpdating),e+=this._numUpdating-i):this._numUpdating=0,this._numUpdating>0?e/=this._numUpdating:e=t?0:1,this._get("updatingProgress")!==e){const i=performance.now();if(e<1){const t=Math.min((i-this._lastUpdateTime)/2e3,1);e=this.updatingProgress*(1-t)+e*t}this._set("updatingProgress",e),this._lastUpdateTime=t&&e<1?i:0}return t}get _updatingObjects(){return[this.graphicsView,this.basemapView,this._resourceController,this.stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this._featureTreeDebugger,this.toolViewManager,this.analysisViewManager]}get _updatingObjectsWithProgress(){return[this.deconflictor,this.labeler,this.basemapTerrain]}get viewingMode(){const e=this._predeterminedViewingMode;if(null!=e)return(0,Si.M7)(e);const t=this.spatialReference;return t?null!=this.defaultsFromMap?.viewingMode&&t.equals(this.defaultsFromMap.spatialReference)?(0,Si.M7)(this.defaultsFromMap.viewingMode):(0,PR.D)(t,Si.JY.Global)?"global":"local":"global"}set viewingMode(e){this.ready?_.Z.getLogger(this).error("#viewingMode","viewingMode cannot be set once view is ready"):this._overrideIfSome("viewingMode",e)}get viewpoint(){return this.stateManager?.viewpoint}set viewpoint(e){this.stateManager&&(this.stateManager.viewpoint=e)}get visibleArea(){return this.stateManager?.visibleArea}get zoom(){return this.stateManager.zoom}set zoom(e){this.stateManager&&(this.stateManager.zoom=e)}get highlightOptions(){return this.highlights.find((({name:e})=>e===si.b))??new ai}set highlightOptions(e){for(let t=0;t<this.highlights.length;++t)if(this.highlights.at(t).name===si.b)return void this.highlights.items[t].assignFrom(e)}get resourceController(){return this._resourceController}get quality(){return this._resourceController?.memoryController?.memoryFactor??1}get resolutionScale(){return Math.sqrt(Math.min(1,this.quality/.75))}get performanceInfo(){return new q_(this)}on(e,t,i,r){return this.viewEvents.on(e,t,i,r)||super.on(e,t)}hasEventListener(e){return super.hasEventListener(e)||this.viewEvents.hasHandler(e)}toMap(e,t){if(!this.ready)return _.Z.getLogger(this).error("#toMap()","Scene view cannot be used before it is ready"),null;const i=(0,Wt.Rw)(e)?(0,Wt.s6)(this,e):e;return(0,Um.qL)(this,i,t,this._defaultToMapOptions)}toScreen(e){if(!this.ready)return _.Z.getLogger(this).error("#toScreen()","Scene view cannot be used before it is ready"),null;const t=(null==e.z?(0,p_.KO)(this.elevationProvider,e):null)??0;return(0,H.K)(e,AP,this.renderSpatialReference,t),this.state.camera.projectToScreen(AP,OP),(0,b.vW)(OP[0],OP[1])}pixelSizeAt(e,t){if(!this.ready)return _.Z.getLogger(this).error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null;if(!e)return 0;const i=this.renderSpatialReference;(0,H.K)(e,AP,i);const r=this.state.camera.computeScreenPixelSizeAt(AP);return t&&i!==t?r*(0,w.c9)(i)/(0,w.c9)(t):r}overlayPixelSizeInMapUnits(e){const t=this.basemapTerrain.overlayManager;return t?t.overlayPixelSizeInMapUnits(e,(()=>this.pixelSizeAt(e))):1}hitTest(e,t){if(!this.ready)return _.Z.getLogger(this).error("#hitTest()","Scene view cannot be used before it is ready"),null;const i=(0,Wt.Rw)(e)?(0,Wt.s6)(this,e):e;return(0,Um.wX)(this,i,t,this._defaultHitTestOptions)}async popupHitTest(e){return f_(this,e)}goTo(e,t){return this.updatingHandles.addPromise(this.stateManager.goTo(e,t))}async whenAnalysisView(e){if(null==e.parent)throw new u.Z("view:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});switch(e.parent.type){case"line-of-sight":case"dimension":case"viewshed":return(await this.whenLayerView(e.parent)).whenAnalysisView();default:return this.analysisViewManager.whenAnalysisView(e)}}whenLayerView(e){return super.whenLayerView(e)}async takeScreenshot(e){const t=await this._completeSettings(e);await this.whenReady();const r=await this.stage.renderView.takeScreenshot(t);return(await Promise.resolve().then(i.bind(i,53433))).encode(r,t,this._pixelFormat())}async _takeScreenshot(e){const t=await this._completeSettings(e);await this.whenReady();const r=await this.stage.renderView.takeScreenshot(t);return(await Promise.resolve().then(i.bind(i,53433))).encodeData(r,this._pixelFormat())}async _takeScreenshotWithObjectAndLayerId(e){const t=await this._completeSettings(e);await this.whenReady();const r=await this.stage.renderView.takeScreenshotWithOID(t),{encodeData:s}=await Promise.resolve().then(i.bind(i,53433));return[s(r[0],this._pixelFormat()),s(r[1],this._pixelFormat())]}async _completeSettings(e){const{toRenderSettings:t,screenshotSuperSampleSettings:r}=await Promise.resolve().then(i.bind(i,53433)),s=t(e,this);return s.pixelRatio/=this.state.pixelRatio,r(s,this.supersampleScreenshotsEnabled,this.padding)}_pixelFormat(){return{flipY:!0,premultipliedAlpha:this.stage?.renderView.getAlpha()??!1}}get test(){}async takeScreenshotWithObjectAndLayerId(e){if(!(0,zx.B)())throw new u.Z("360vr:objectAndLayerId-rendering-disabled","has enable-feature:objectAndLayerId-rendering must be true");const{encode:t}=await Promise.resolve().then(i.bind(i,53433)),r=await this._completeSettings(e);await this.whenReady();const s=await this.stage.renderView.takeScreenshotWithOID(r),n=t(s[0],r,this._pixelFormat()),a=await this._completeSettings(e);return a.format="png",[n,t(s[1],a,this._pixelFormat())]}getColorToObjectAndLayerIdMapping(){const e=this.stage.renderView.olidRenderHelper;if(e)return e.getColorToObjectAndLayerIdMapping();throw new u.Z("360vr:objectAndLayerId-rendering-disabled","has enable-feature:objectAndLayerId-rendering must be true")}addUpdatingPromise(e){return this.updatingHandles.addPromise(e)}importLayerView(e){return Xi(e)}hasLayerViewModule(e){return $i(e)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){return this.scene?.initialViewProperties?.spatialReference||this.defaultsFromMap?.spatialReference||this.defaultsFromMap?.ready&&this._initialDefaultSpatialReference||null}async validate(){let e=function(e){const t=(0,IR.h)();return t.available?"3d"===e&&t.majorPerformanceCaveat?new u.Z("webgl:major-performance-caveat-detected",`Your WebGL implementation (${t.unmaskedRenderer}) doesn't seem to support hardware accelerated rendering. Check your browser settings or if your GPU is in a blocklist.`):t.supportsHighPrecisionFragment?t.supportsVertexShaderSamplers?null:new u.Z("webgl:vertex-shader-samplers-required","WebGL support for vertex shader samplers is required but not supported."):new u.Z("webgl:high-precision-fragment-required","WebGL support for high precision fragment shaders is required but not supported."):new u.Z("webgl:required","WebGL2 is required but not supported.",(new Error).stack)}(this.type);const t=(0,m.Z)("safari");if(t&&t<9&&(e=new u.Z("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:t})),null!=e)throw _.Z.getLogger(this).warn("#validate()",e.message),e}get _predeterminedViewingMode(){const e=this._isOverridden("viewingMode")?this._get("viewingMode"):this.scene?.initialViewProperties?.viewingMode;return null!=e?(0,Si.wg)(e):null}getSpatialReferenceSupport(e,t){const i=this._predeterminedViewingMode;if(null!=i)return this._validateSpatialReferenceForViewingMode(e,t,i)?{constraints:this._makeSpatialReferenceConstraints(e,t,i)}:null;const r=this._validateSpatialReferenceForViewingMode(e,t,Si.JY.Local),s=this._validateSpatialReferenceForViewingMode(e,t,Si.JY.Global);return r||s?r&&s?{constraints:this._makeSpatialReferenceConstraints(e,t,null)}:r?{constraints:this._makeSpatialReferenceConstraints(e,t,Si.JY.Local)}:{constraints:this._makeSpatialReferenceConstraints(e,t,Si.JY.Global)}:null}_validateSpatialReferenceForViewingMode(e,t,i){return!(!(0,PR.D)(e,i)||null!=t&&!(0,z.Am)(t)&&((0,z.iC)(t)&&null==(0,eg.E_)(t,e,i)||(0,z.Tv)(t)&&i===Si.JY.Global))}_makeSpatialReferenceConstraints(e,t,i){if(null==t)return[{spatialReference:e,viewingMode:i}];const{isWebMercator:r,isWGS84:s}=e;return(0,z.Am)(t)&&(r||s)?s&&i!==Si.JY.Local&&null!==(0,eg.er)(t.tileInfo,t.fullExtent,e,Si.JY.Global)?[{spatialReference:r?N.Z.WGS84:N.Z.WebMercator,viewingMode:i}]:[{spatialReference:e,viewingMode:i},{spatialReference:N.Z.WebMercator,viewingMode:i}]:(0,z.iC)(t)||(0,z.Tv)(t)||!r&&!s?(0,z.iC)(t)&&r&&i!==Si.JY.Global?[{spatialReference:e,viewingMode:i},{spatialReference:N.Z.WGS84,viewingMode:Si.JY.Local}]:[{spatialReference:e,viewingMode:i}]:[{spatialReference:e,viewingMode:i},{spatialReference:r?N.Z.WGS84:N.Z.WebMercator,viewingMode:i}]}_validateSpatialReference(e){const t=null!=this.getSpatialReferenceSupport(e),i=this._predeterminedViewingMode;return t||(null!=i?_.Z.getLogger(this).warnOnce(`Spatial reference defined on view not supported in ${(0,Si.M7)(i)} viewing mode.`):e.isGeographic&&_.Z.getLogger(this).warnOnce("Spatial reference is geographic but not supported.")),t}whenReady(){return new Promise((e=>{this.ready?e(this):this._resolveWhenReady.push(e)}))}trackGraphicState(e){if(!e.graphic)return _.Z.getLogger(this).error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const t=this.getViewForGraphic(e.graphic);let i=null,r=!1;const s=t=>{!r&&null!=t&&"processor"in t&&"graphics-3d"===t.processor?.type&&t.processor.graphicsCore&&(i=t.processor.graphicsCore.trackGraphicState(e))};return null!=t?s(t):this.whenViewForGraphic(e.graphic,{waitForLayer:!0}).then((e=>s(e)),(()=>{})).catch((()=>{})),(0,p.kB)((()=>{r=!0,null!=i&&(i.remove(),i=null)}))}maskOccludee(e){if(!e)return _.Z.getLogger(this).error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const t=this.getViewForGraphic(e);let i=null,r=!1;const s=t=>{!r&&null!=t&&(0,bw._1)(t)&&(i=t.maskOccludee(e))};return null!=t?s(t):this.whenViewForGraphic(e,{waitForLayer:!0}).then((e=>s(e)),(()=>{})).catch((()=>{})),(0,p.kB)((()=>{r=!0,null!=i&&(i.remove(),i=null)}))}getViewForGraphic(e){return e.layer===this?this.graphicsView:e.layer?this.allLayerViews.filter((e=>"media-3d"!==e.type)).find((t=>t.layer===e.layer)):null}graphicChanged(e){null!=this.graphicsView&&this.graphicsView.graphicChanged(e)}async whenViewForGraphic(e,t){return e.layer===this?(await(0,n.N1)((()=>this.graphicsView)),this.graphicsView):e.layer&&this.map?t&&t.waitForLayer&&!this.map.allLayers.includes(e.layer)?new Promise(((t,i)=>{const r=this.map.allLayers.on("change",(s=>{s.added.includes(e.layer)&&(r.remove(),this.whenLayerView(e.layer).then(t,i))}))})):this.whenLayerView(e.layer):null}async _importModule(e,t){const i=new AbortController;this._importControllers.set(e,i),this._updatingChanged();try{const r=await IP[e]();return t&&((0,y.k_)(i.signal),await t(i.signal)),(0,y.k_)(i.signal),this._importControllers.delete(e),r}catch{this._importControllers.delete(e)}return null}_abortImport(e){this._importControllers.get(e)?.abort(),this._importControllers.delete(e),this._updatingChanged()}_initBasemapTerrain(){this._set("basemapTerrain",new xw({view:this})),this._set("elevationProvider",new i_({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){const e=this.basemapTerrain,t=this.elevationProvider;e&&(this._set("basemapTerrain",null),this._set("elevationProvider",null),t.unregister(e),t.destroy(),e.destroy())}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new Nf({view:this})),this._set("featureTiles",new Rm({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.cameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));const e=()=>{const e=this.basemapTerrain?.extent;if(this.clippingArea||e)if(e&&this.basemapTerrain.spatialReference){const e=null!=this.basemapTerrain.extent&&null!=this.basemapTerrain.spatialReference?(0,F.project)((0,V.HH)(this.basemapTerrain.extent,this.basemapTerrain.spatialReference),this.spatialReference):null;this.clippingArea?this.featureTiles.filterExtent=this.clippingArea.intersection(e):this.featureTiles.filterExtent=e}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null};this.addHandles([this.updatingHandles.add((()=>dd.h.FEATURE_TILE_TREE_SHOW_TILES),(e=>{e&&this.featureTiles&&!this._featureTreeDebugger?this.updatingHandles.addPromise(i.e(59519).then(i.bind(i,59519))).then((({FeatureTileTree3DDebugger:e})=>{!this._featureTreeDebugger&&dd.h.FEATURE_TILE_TREE_SHOW_TILES&&(this._featureTreeDebugger=new e({view:this}))})):e||!this._featureTreeDebugger||dd.h.FEATURE_TILE_TREE_SHOW_TILES||(this._featureTreeDebugger.destroy(),this._featureTreeDebugger=null)}),n.tX),this.updatingHandles.add((()=>this.clippingArea),e,n.tX),this.updatingHandles.add((()=>this.basemapTerrain.extent),e,n.tX)],"feature-tiles"),this.stateManager.init()}_exitGlobe(){this.featureTiles&&(this.stateManager.exit(),this.removeHandles("render-coords-helper"),this.removeHandles("feature-tiles"),this._set("featureTiles",(0,f.SC)(this.featureTiles)),this._set("pointsOfInterest",(0,f.SC)(this.pointsOfInterest)),this._exitBasemapTerrain(),this.state.reset(),this._exitCoordinateSystem())}_initCoordinateSystem(){if(this.spatialReference){const e=this.spatialReference,t=this.state.isGlobal,i=(0,k.E2)(t,e);i!==this.renderSpatialReference&&(this._set("renderCoordsHelper",S_.Z.create(this.state.viewingMode,i)),t||this.addHandles((0,n.YP)((()=>this.basemapTerrain?.extent),(e=>{const t=this.renderCoordsHelper.spatialReference;null==e||0===e[0]&&0===e[1]&&0===e[2]&&0===e[3]||!(0,U.d)(e,this.basemapTerrain.spatialReference,DP,t)||(this.renderCoordsHelper.extent=DP)}),n.Z_),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(Yo.j/this.renderCoordsHelper.unitInMeters))}else this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.removeHandles("render-coords-helper"),this._set("renderCoordsHelper",null)}_updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(e=null){null!=e&&e.type===g.y.MOVE||(this.removeHandles("updatingMonitors"),this.allLayerViews.forEach((e=>{e.destroyed||(this.addHandles((0,n.YP)((()=>[e.updating,e.updatingProgress]),(()=>this._updatingChanged()),n.Z_),"updatingMonitors"),e.when((()=>this._updatingChanged()),(()=>this._updatingChanged())))})),this._updatingChanged())}async _prepareScreenshotOverlay(){this.overlay&&await this.overlay.prepare()}_renderScreenshotOverlay(e,t,i){if(!this.overlay||!this.overlay.hasVisibleItems)return i;const r=e.getContext("2d",{willReadFrequently:!0});return r.putImageData(i,0,0),this.overlay.renderCanvas(e,{disableDecorations:t}),r.getImageData(0,0,i.width,i.height)}_initStage(){const e={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,preserveDrawingBuffer:this.preserveDrawingBufferEnabled,canvas:this.renderCanvas,screenshot:{prepareOverlay:()=>this._prepareScreenshotOverlay(),renderOverlay:(e,t,i)=>this._renderScreenshotOverlay(e,t,i)}},t=new Gm(this.state.viewingMode,(e=>this.stage.layers.forAll(e)),this);this._set("sceneIntersectionHelper",t);const i=(0,h.L)(this.surface);this._stage=new RR({view:this,options:e,container:i}),this._updateSlice(),this.addHandles([this.updatingHandles.add((()=>this.qualitySettings.highQualityTransparency),(e=>this.stage.renderer.setParameters({highQualityTransparency:e})),n.nn),this.on("pointer-move",(()=>this.stage?.renderer.resetAnimation())),(0,d.on)(this.stage.renderView.canvas,"webglcontextlost",(e=>{this.fatalError=new u.Z("webgl-context-lost",e.statusMessage)}))],"stage"),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(Yo.j/this.renderCoordsHelper.unitInMeters),this._set("canvas",this.stage.renderView.canvas)}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage=(0,f.SC)(this.stage),this.removeHandles("stage"),this._set("canvas",null)}_initSurface(e){this._exitSurface(),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new tf({view:this,viewingMode:e,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}async _ensureGraphicsView(){if(this.graphicsView||this._importControllers.has("GraphicsView3D")||0===this.graphics.length)return;this.removeHandles("GraphicsView3D");const e=(await this._importModule("GraphicsView3D",(e=>(0,n.N1)((()=>this.basemapTerrain?.ready),e))))?.default;e&&this._set("graphicsView",new e({view:this,getGraphics:()=>this.graphics})),this._updatingChanged()}_disposeGraphicsView(){this._abortImport("GraphicsView3D"),this.removeHandles("GraphicsView3D"),this.graphicsView&&(this.removeHandles(this.graphicsView.processor.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_disposeFocusAreasView(){this._abortImport("FocusAreasView"),this.removeHandles("FocusAreasView"),this.focusAreasView=(0,f.SC)(this.focusAreasView)}async _ensureFocusAreasView(e){if(this.focusAreasView||this._importControllers.has("FocusAreasView")||0===e)return;this.removeHandles("FocusAreasView");const t=(await this._importModule("FocusAreasView"))?.FocusAreasView;t&&(this.focusAreasView=new t({view:this})),this._updatingChanged()}_startup(){const e=(0,Si.wg)(this.viewingMode);e===Si.JY.Global&&(this._clippingArea=null),this._initSurface(e),this._set("ready",!0),this.addHandles((0,n.on)((()=>this.graphics),"after-changes",(()=>this._ensureGraphicsView())),"GraphicsView3D"),this._ensureGraphicsView(),this.addHandles((0,n.YP)((()=>this.map?.focusAreas?.areas.length??0),(e=>this._ensureFocusAreasView(e)),{initial:!0}),"FocusAreasView");const t=this.scene?.initialViewProperties??null,i=t?.environment;i&&(this._overrideDefaultEnvironmentOnly?A(this.environment,i):this.environment=this.environment.cloneWithWebsceneEnvironment(i)),this.timeExtent=t?.timeExtent,t?.analyses.applyTo(this),this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect();const r=this._resolveWhenReady;this._resolveWhenReady=[],r.forEach((e=>e(this)))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this._overrideDefaultEnvironmentOnly=!1,this.labeler.dispose(),this._disposeGraphicsView(),this._disposeFocusAreasView(),this._exitSurface(),this._set("ready",!1)}get _defaultToMapOptions(){const e={include:new Set};if(!this.map)return e;this.map.ground&&e.include.add(fl.xX);for(const t of this.allLayerViews)(0,z.nx)(t.layer.type)&&e.include.add(t.uid);return e}get _defaultHitTestOptions(){const e={exclude:new Set};if(!this.map)return e;this.map.ground&&this.map.ground.opacity<1&&e.exclude.add(fl.xX);for(const t of this.allLayerViews)(0,z.nx)(t.layer.type)&&t.layer.opacity<1&&e.exclude.add(t.uid);return e}static{this.type="3d"}};function PP(e,t){return null!=e&&(0,F.canProjectWithoutEngine)(e.spatialReference,t)?(0,F.project)(e,t):null}(0,o._)([(0,x.Cb)()],RP.prototype,"_userClippingArea",void 0),(0,o._)([(0,x.Cb)()],RP.prototype,"_resourceController",void 0),(0,o._)([(0,x.Cb)()],RP.prototype,"_stage",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],RP.prototype,"deconflictor",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],RP.prototype,"labeler",void 0),(0,o._)([(0,x.Cb)((0,D.z)(G,"analyses"))],RP.prototype,"analyses",void 0),(0,o._)([(0,x.Cb)({type:qi,readOnly:!0})],RP.prototype,"animation",null),(0,o._)([(0,x.Cb)({readOnly:!0})],RP.prototype,"basemapTerrain",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],RP.prototype,"elevationProvider",void 0),(0,o._)([(0,x.Cb)()],RP.prototype,"camera",null),(0,o._)([(0,x.Cb)({type:s.Z})],RP.prototype,"contentCamera",null),(0,o._)([(0,x.Cb)({readOnly:!0})],RP.prototype,"canvas",void 0),(0,o._)([(0,x.Cb)({type:a.Z})],RP.prototype,"center",null),(0,o._)([(0,x.Cb)({type:I.Z})],RP.prototype,"clippingArea",null),(0,o._)([(0,x.Cb)({type:pr})],RP.prototype,"constraints",void 0),(0,o._)([(0,x.Cb)({type:I.Z,readOnly:!0})],RP.prototype,"renderDataExtent",null),(0,o._)([(0,x.Cb)({readOnly:!0})],RP.prototype,"tileInfo",null),(0,o._)([(0,x.Cb)({type:I.Z,readOnly:!0})],RP.prototype,"dataExtent",null),(0,o._)([(0,x.Cb)({type:I.Z,readOnly:!0})],RP.prototype,"_groundAndLayersExtent",null),(0,o._)([(0,x.Cb)({type:On})],RP.prototype,"environment",void 0),(0,o._)([(0,T.p)("environment")],RP.prototype,"castEnvironment",null),(0,o._)([(0,x.Cb)({readOnly:!0})],RP.prototype,"environmentManager",void 0),(0,o._)([(0,x.Cb)({type:I.Z})],RP.prototype,"extent",null),(0,o._)([(0,x.Cb)({type:c.Z})],RP.prototype,"floors",void 0),(0,o._)([(0,x.Cb)()],RP.prototype,"screenCenter",null),(0,o._)([(0,x.Cb)()],RP.prototype,"frustum",null),(0,o._)([(0,x.Cb)({type:Number,readOnly:!0})],RP.prototype,"fullOpacity",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],RP.prototype,"graphicsView",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],RP.prototype,"analysisViewManager",void 0),(0,o._)([(0,x.Cb)()],RP.prototype,"groundView",void 0),(0,o._)([(0,x.Cb)({type:Boolean})],RP.prototype,"initialExtentRequired",null),(0,o._)([(0,x.Cb)()],RP.prototype,"defaultsFromMapSettings",null),(0,o._)([(0,x.Cb)()],RP.prototype,"interacting",null),(0,o._)([(0,x.Cb)()],RP.prototype,"stationary",null),(0,o._)([(0,x.Cb)()],RP.prototype,"navigating",null),(0,o._)([(0,x.Cb)()],RP.prototype,"map",void 0),(0,o._)([(0,x.Cb)()],RP.prototype,"padding",null),(0,o._)([(0,x.Cb)({type:Nf,readOnly:!0})],RP.prototype,"pointsOfInterest",void 0),(0,o._)([(0,x.Cb)({type:Rm,readOnly:!0})],RP.prototype,"featureTiles",void 0),(0,o._)([(0,x.Cb)()],RP.prototype,"_featureTreeDebugger",void 0),(0,o._)([(0,x.Cb)({type:Boolean})],RP.prototype,"screenSizePerspectiveEnabled",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],RP.prototype,"deactivatedWebGLExtensions",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],RP.prototype,"debugWebGLExtensions",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],RP.prototype,"renderCanvas",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],RP.prototype,"state",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],RP.prototype,"inputManager",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],RP.prototype,"stateManager",void 0),(0,o._)([(0,x.Cb)({type:["low","medium","high"]})],RP.prototype,"qualityProfile",null),(0,o._)([(0,x.Cb)({type:T_,get(){let e=this._get("qualitySettings");return e||(e=new T_,u_.apply(this.qualityProfile,e)),e}})],RP.prototype,"qualitySettings",void 0),(0,o._)([(0,x.Cb)()],RP.prototype,"slice",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],RP.prototype,"typeSpecificPreconditionsReady",null),(0,o._)([(0,x.Cb)({readOnly:!0})],RP.prototype,"renderCoordsHelper",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],RP.prototype,"sceneIntersectionHelper",void 0),(0,o._)([(0,x.Cb)({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],RP.prototype,"resolution",null),(0,o._)([(0,x.Cb)({type:Number})],RP.prototype,"scale",null),(0,o._)([(0,x.Cb)()],RP.prototype,"heightModelInfo",null),(0,o._)([(0,x.Cb)()],RP.prototype,"spatialReference",void 0),(0,o._)([(0,x.Cb)({type:Boolean,constructOnly:!0})],RP.prototype,"alphaCompositingEnabled",void 0),(0,o._)([(0,x.Cb)({constructOnly:!0})],RP.prototype,"preserveDrawingBufferEnabled",void 0),(0,o._)([(0,x.Cb)({type:Boolean})],RP.prototype,"supersampleScreenshotsEnabled",void 0),(0,o._)([(0,x.Cb)({readOnly:!0})],RP.prototype,"type",void 0),(0,o._)([(0,x.Cb)(),(0,T.p)((e=>e instanceof SP?e:(0,M.TJ)(EP,e)))],RP.prototype,"ui",void 0),(0,o._)([(0,x.Cb)({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.updating","toolViewManager.updating","analysisViewManager.updating","state.updating","textures.updating"]})],RP.prototype,"updating",null),(0,o._)([(0,x.Cb)()],RP.prototype,"_updatingObjects",null),(0,o._)([(0,x.Cb)()],RP.prototype,"_updatingObjectsWithProgress",null),(0,o._)([(0,x.Cb)({type:Number,readOnly:!0,dependsOn:["updating"]})],RP.prototype,"updatingProgress",void 0),(0,o._)([(0,x.Cb)({type:["global","local"]})],RP.prototype,"viewingMode",null),(0,o._)([(0,x.Cb)({type:l.Z})],RP.prototype,"viewpoint",null),(0,o._)([(0,x.Cb)({readOnly:!0})],RP.prototype,"visibleArea",null),(0,o._)([(0,x.Cb)({type:Number})],RP.prototype,"zoom",null),(0,o._)([(0,x.Cb)({type:ai})],RP.prototype,"highlightOptions",null),(0,o._)([(0,x.Cb)({readOnly:!0})],RP.prototype,"quality",null),(0,o._)([(0,x.Cb)({readOnly:!0})],RP.prototype,"resolutionScale",null),(0,o._)([(0,x.Cb)()],RP.prototype,"focusAreasView",void 0),(0,o._)([(0,x.Cb)()],RP.prototype,"_defaultToMapOptions",null),(0,o._)([(0,x.Cb)()],RP.prototype,"_defaultHitTestOptions",null),RP=(0,o._)([(0,S.j)("esri.views.SceneView")],RP);const AP=(0,O.Ue)(),OP=(0,b.s1)(),DP=(0,V.Ue)(),IP={GraphicsView3D:()=>Promise.all([i.e(55105),i.e(88534),i.e(57026)]).then(i.bind(i,17617)),FocusAreasView:()=>Promise.all([i.e(9519),i.e(66288),i.e(65513),i.e(56870),i.e(82845),i.e(72623),i.e(79693)]).then(i.bind(i,27447))},LP=RP;var FP=i(10218),NP=i(84060),UP=i(8914),HP=i(34058),VP=i(66245),kP=i(90756),BP=i(77601),zP=i(96193),GP=i(39438),qP=i(47626);let ZP=class extends Me.Z{constructor(e){super(e),this.facilityIdField=null,this.layerId=null,this.nameField=null,this.siteIdField=null,this.sublayerId=null}};(0,o._)([(0,x.Cb)({type:String,json:{write:{isRequired:!0}}})],ZP.prototype,"facilityIdField",void 0),(0,o._)([(0,x.Cb)({type:String,json:{write:{isRequired:!0}}})],ZP.prototype,"layerId",void 0),(0,o._)([(0,x.Cb)({type:String,json:{write:{isRequired:!0}}})],ZP.prototype,"nameField",void 0),(0,o._)([(0,x.Cb)({type:String,json:{write:!0}})],ZP.prototype,"siteIdField",void 0),(0,o._)([(0,x.Cb)({type:Number,json:{read:{source:"subLayerId"},write:{target:"subLayerId"},origins:{"web-scene":{read:!1,write:!1}}}})],ZP.prototype,"sublayerId",void 0),ZP=(0,o._)([(0,S.j)("esri.layers.support.FacilityLayerInfo")],ZP);const jP=ZP;let WP=class extends Me.Z{constructor(e){super(e),this.facilityIdField=null,this.layerId=null,this.levelIdField=null,this.levelNumberField=null,this.longNameField=null,this.shortNameField=null,this.sublayerId=null,this.verticalOrderField=null}};(0,o._)([(0,x.Cb)({type:String,json:{write:{isRequired:!0}}})],WP.prototype,"facilityIdField",void 0),(0,o._)([(0,x.Cb)({type:String,json:{write:{isRequired:!0}}})],WP.prototype,"layerId",void 0),(0,o._)([(0,x.Cb)({type:String,json:{write:{isRequired:!0}}})],WP.prototype,"levelIdField",void 0),(0,o._)([(0,x.Cb)({type:String,json:{write:{isRequired:!0}}})],WP.prototype,"levelNumberField",void 0),(0,o._)([(0,x.Cb)({type:String,json:{write:{isRequired:!0}}})],WP.prototype,"longNameField",void 0),(0,o._)([(0,x.Cb)({type:String,json:{write:{isRequired:!0}}})],WP.prototype,"shortNameField",void 0),(0,o._)([(0,x.Cb)({type:Number,json:{read:{source:"subLayerId"},write:{target:"subLayerId"},origins:{"web-scene":{read:!1,write:!1}}}})],WP.prototype,"sublayerId",void 0),(0,o._)([(0,x.Cb)({type:String,json:{write:{isRequired:!0}}})],WP.prototype,"verticalOrderField",void 0),WP=(0,o._)([(0,S.j)("esri.layers.support.LevelLayerInfo")],WP);const $P=WP;let XP=class extends Me.Z{constructor(e){super(e),this.layerId=null,this.nameField=null,this.siteIdField=null,this.sublayerId=null}};(0,o._)([(0,x.Cb)({type:String,json:{write:{isRequired:!0}}})],XP.prototype,"layerId",void 0),(0,o._)([(0,x.Cb)({type:String,json:{write:{isRequired:!0}}})],XP.prototype,"nameField",void 0),(0,o._)([(0,x.Cb)({type:String,json:{write:{isRequired:!0}}})],XP.prototype,"siteIdField",void 0),(0,o._)([(0,x.Cb)({type:Number,json:{read:{source:"subLayerId"},write:{target:"subLayerId"},origins:{"web-scene":{read:!1,write:!1}}}})],XP.prototype,"sublayerId",void 0),XP=(0,o._)([(0,S.j)("esri.layers.support.SiteLayerInfo")],XP);const YP=XP;let QP=class extends Me.Z{constructor(e){super(e),this.levelLayer=null,this.facilityLayer=null,this.siteLayer=null}};(0,o._)([(0,x.Cb)({type:$P,json:{write:{isRequired:!0}}})],QP.prototype,"levelLayer",void 0),(0,o._)([(0,x.Cb)({type:jP,json:{write:{isRequired:!0}}})],QP.prototype,"facilityLayer",void 0),(0,o._)([(0,x.Cb)({type:YP,json:{write:!0}})],QP.prototype,"siteLayer",void 0),QP=(0,o._)([(0,S.j)("esri.support.MapFloorInfo")],QP);const KP=QP;var JP,eA=i(3651);let tA=JP=class extends Me.Z{constructor(e){super(e),this.enabled=!1,this.longNames=!1,this.minimized=!1,this.pinnedLevels=!1,this.site=null,this.facility=null,this.level=null}clone(){return new JP((0,Ee.d9)({enabled:this.enabled,longNames:this.longNames,minimized:this.minimized,pinnedLevels:this.pinnedLevels,site:this.site,facility:this.facility,level:this.level}))}};(0,o._)([(0,x.Cb)({type:Boolean,json:{read:{source:"enabled"},write:{target:"enabled"}}})],tA.prototype,"enabled",void 0),(0,o._)([(0,x.Cb)({type:Boolean,json:{read:{source:"longNames"},write:{target:"longNames"}}})],tA.prototype,"longNames",void 0),(0,o._)([(0,x.Cb)({type:Boolean,json:{read:{source:"minimized"},write:{target:"minimized"}}})],tA.prototype,"minimized",void 0),(0,o._)([(0,x.Cb)({type:Boolean,json:{read:{source:"pinnedLevels"},write:{target:"pinnedLevels"}}})],tA.prototype,"pinnedLevels",void 0),(0,o._)([(0,x.Cb)({type:String,json:{read:{source:"site"},write:{target:"site"}}})],tA.prototype,"site",void 0),(0,o._)([(0,x.Cb)({type:String,json:{read:{source:"facility"},write:{target:"facility"}}})],tA.prototype,"facility",void 0),(0,o._)([(0,x.Cb)({type:String,json:{read:{source:"level"},write:{target:"level"}}})],tA.prototype,"level",void 0),tA=JP=(0,o._)([(0,S.j)("esri.webdoc.widgets.FloorFilter")],tA);const iA=tA;var rA,sA=i(41773);const nA=new sA.X({slider:"slider",picker:"picker"});let aA=rA=class extends Me.Z{constructor(e){super(e),this.interactionMode=null,this.numStops=null,this.stopInterval=null}clone(){return new rA({interactionMode:this.interactionMode,numStops:this.numStops,stopInterval:this.stopInterval})}};(0,o._)([(0,x.Cb)({type:nA.apiValues,nonNullable:!0,json:{type:nA.jsonValues,default:null,read:{reader:nA.read},write:{isRequired:!0,writer:nA.write}}})],aA.prototype,"interactionMode",void 0),(0,o._)([(0,x.Cb)({type:M.z8,json:{read:{source:"numberOfStops"},write:{target:"numberOfStops",overridePolicy(){const e=null!=this.stopInterval;return{enabled:!e,isRequired:!e}}}}})],aA.prototype,"numStops",void 0),(0,o._)([(0,x.Cb)({type:Number,json:{write:{overridePolicy(){return{isRequired:null==this.numStops}}}}})],aA.prototype,"stopInterval",void 0),aA=rA=(0,o._)([(0,S.j)("esri.webdoc.widgets.Range")],aA);const oA=aA;var lA,cA=i(60123),hA=i(24009),uA=i(62920);let dA=lA=class extends Me.Z{constructor(e){super(e),this.currentTimeExtent=null,this.fullTimeExtent=null,this.loop=!1,this.numStops=null,this.numThumbs=null,this.stopDelay=null,this.stopInterval=null,this.stops=null}readCurrentTimeExtent(e){return e?vt.T.fromArray(e):void 0}writeCurrentTimeExtent(e,t,i){e&&(0,cA.RB)(i,e.toArray(),t)}readFullTimeExtent(e,t){const i=t.properties;if(!i)return;const r=null!=i.endTime?new Date(i.endTime):null,s=null!=i.startTime?new Date(i.startTime):null;return new vt.T({start:s,end:r})}writeFullTimeExtent(e,t){if(!e)return;const i=t.properties=t.properties||{},r=e.end,s=e.start;r&&(i.endTime=null!=r?r.getTime():null),s&&(i.startTime=null!=s?s.getTime():null)}readStopInterval(e,t,i){return e?uA.T.fromJSON({value:e.interval,unit:e.units},i):null}writeStopInterval(e,t,i,r){if(!e)return;const s=e.toJSON(r);(0,cA.RB)("properties.timeStopInterval",{interval:s.value,units:s.unit},t)}readStops(e){return e?.length?e.map((e=>new Date(e))):null}writeStops(e,t,i){e?.length&&(0,cA.RB)(i,e.map((e=>e.getTime())),t)}clone(){return new lA((0,Ee.d9)({currentTimeExtent:this.currentTimeExtent,fullTimeExtent:this.fullTimeExtent,loop:this.loop,numStops:this.numStops,numThumbs:this.numThumbs,stopDelay:this.stopDelay,stopInterval:this.stopInterval,stops:this.stops}))}};(0,o._)([(0,x.Cb)({type:vt.T,json:{type:[[M.z8,M.p2]],read:{source:"properties.currentTimeExtent"},write:{target:"properties.currentTimeExtent"}}})],dA.prototype,"currentTimeExtent",void 0),(0,o._)([(0,qe.r)("currentTimeExtent")],dA.prototype,"readCurrentTimeExtent",null),(0,o._)([(0,Ae.c)("currentTimeExtent")],dA.prototype,"writeCurrentTimeExtent",null),(0,o._)([(0,x.Cb)({type:vt.T,json:{read:{source:["properties.endTime","properties.startTime"]},write:{target:{"properties.endTime":{type:Number},"properties.startTime":{type:Number}}}}})],dA.prototype,"fullTimeExtent",void 0),(0,o._)([(0,qe.r)("fullTimeExtent")],dA.prototype,"readFullTimeExtent",null),(0,o._)([(0,Ae.c)("fullTimeExtent")],dA.prototype,"writeFullTimeExtent",null),(0,o._)([(0,x.Cb)({type:Boolean,nonNullable:!0,json:{default:!1,read:{source:"properties.loop"},write:{target:"properties.loop"}}})],dA.prototype,"loop",void 0),(0,o._)([(0,x.Cb)({type:M.z8,json:{read:{source:"properties.numberOfStops"},write:{target:"properties.numberOfStops",overridePolicy(){const e=!!this.stopInterval,t=!!this.stops?.length,i=!(e||t);return{enabled:i,isRequired:i}}}}})],dA.prototype,"numStops",void 0),(0,o._)([(0,x.Cb)({type:[1,2],nonNullable:!0,json:{type:M.z8,read:{source:"properties.thumbCount"},write:{target:"properties.thumbCount",isRequired:!0}}})],dA.prototype,"numThumbs",void 0),(0,o._)([(0,x.Cb)({type:Number,nonNullable:!0,json:{read:{source:"properties.thumbMovingRate"},write:{target:"properties.thumbMovingRate",isRequired:!0}}})],dA.prototype,"stopDelay",void 0),(0,o._)([(0,x.Cb)({type:uA.T,json:{read:{source:"properties.timeStopInterval"},write:{target:{"properties.timeStopInterval.interval":{type:Number},"properties.timeStopInterval.units":{type:hA.v.jsonValues.filter((e=>"esriTimeUnitsUnknown"!==e))}},overridePolicy(){const e=null!=this.numStops,t=!!this.stops?.length;return{enabled:!t,isRequired:!(e||t)}}}}})],dA.prototype,"stopInterval",void 0),(0,o._)([(0,qe.r)("stopInterval")],dA.prototype,"readStopInterval",null),(0,o._)([(0,Ae.c)("stopInterval")],dA.prototype,"writeStopInterval",null),(0,o._)([(0,x.Cb)({type:[Date],json:{type:[M.z8],read:{source:"properties.stops"},write:{target:"properties.stops",overridePolicy(){return{isRequired:null==this.numStops&&!this.stopInterval}}}}})],dA.prototype,"stops",void 0),(0,o._)([(0,qe.r)("stops")],dA.prototype,"readStops",null),(0,o._)([(0,Ae.c)("stops")],dA.prototype,"writeStops",null),dA=lA=(0,o._)([(0,S.j)("esri.webdoc.widgets.TimeSlider")],dA);const pA=dA;var mA;let _A=mA=class extends Me.Z{constructor(e){super(e),this.range=null,this.timeSlider=null,this.floorFilter=null}clone(){return new mA((0,Ee.d9)({range:this.range,timeSlider:this.timeSlider,floorFilter:this.floorFilter}))}};(0,o._)([(0,x.Cb)({type:oA,json:{write:!0}})],_A.prototype,"range",void 0),(0,o._)([(0,x.Cb)({type:pA,json:{write:!0}})],_A.prototype,"timeSlider",void 0),(0,o._)([(0,x.Cb)({type:iA,json:{write:!0}})],_A.prototype,"floorFilter",void 0),_A=mA=(0,o._)([(0,S.j)("esri.webdoc.Widgets")],_A);const fA=_A;var gA=i(79922),yA=i(68875);const vA={width:600,height:400},bA=1.5;i(66619),i(74935),i(8084);["NatGeo_World_Map","Ocean_Basemap","USA_Topo_Maps","World_Imagery","World_Street_Map","World_Terrain_Base","World_Topo_Map","World_Hillshade","Canvas/World_Light_Gray_Base","Canvas/World_Light_Gray_Reference","Canvas/World_Dark_Gray_Base","Canvas/World_Dark_Gray_Reference","Ocean/World_Ocean_Base","Ocean/World_Ocean_Reference","Reference/World_Boundaries_and_Places","Reference/World_Reference_Overlay","Reference/World_Transportation"].map((e=>e.toLowerCase()));qP.hz.JSAPI,qP.hz.DEVELOPER_BASEMAP;async function wA(e,t){const{item:i,authenticated:r}=e;return i?.id&&i.typeKeywords?.includes("useOnly")?i.portal.portalHostname!==t.portalHostname?{copyAllowed:!1,itemReloaded:!1}:(r||await i.reload(),{copyAllowed:"admin"===i.itemControl||"update"===i.itemControl,itemReloaded:!0}):{copyAllowed:!0,itemReloaded:!1}}async function CA(e,t,i,r){const s=e.portal,{item:n}=t,{folder:a,copyAllResources:o}=r;let l=!1;if(o&&n?.id&&(0,X_.Zo)(n.portal.url,s.url)&&parseInt(n.portal.currentVersion,10)>=2023){const{total:e}=await n.fetchResources();l=!!e}if(l){const t=await n.copy({copyResources:"all",folder:a});e.id=t.id,e.portal=t.portal;const r=e.toJSON();await e.load(),e.read(r),await e.update({data:i})}else await s.user.addItem({item:e,folder:a,data:i});return l}function xA(e){return{enabled:!!e?.length}}var TA,SA=i(72396);let MA=TA=class extends Me.Z{constructor(e){super(e),this.exactMatch=!1,this.name=null,this.type=null}clone(){return new TA({exactMatch:this.exactMatch,type:this.type,name:this.name})}};(0,o._)([(0,x.Cb)({type:Boolean,json:{write:!0}})],MA.prototype,"exactMatch",void 0),(0,o._)([(0,x.Cb)({type:String,json:{write:!0}})],MA.prototype,"name",void 0),(0,o._)([(0,Oe.J)(SA.v)],MA.prototype,"type",void 0),MA=TA=(0,o._)([(0,S.j)("esri.webdoc.applicationProperties.SearchLayerField")],MA);const EA=MA;var RA;let PA=RA=class extends Me.Z{constructor(e){super(e),this.field=null,this.id=null,this.subLayer=null}clone(){return new RA((0,Ee.d9)({field:this.field,id:this.id,subLayer:this.subLayer}))}};(0,o._)([(0,x.Cb)({type:EA,json:{write:{isRequired:!0}}})],PA.prototype,"field",void 0),(0,o._)([(0,x.Cb)({type:String,json:{write:{isRequired:!0}}})],PA.prototype,"id",void 0),(0,o._)([(0,x.Cb)({type:M.z8,json:{write:!0}})],PA.prototype,"subLayer",void 0),PA=RA=(0,o._)([(0,S.j)("esri.webdoc.applicationProperties.SearchLayer")],PA);const AA=PA;var OA;let DA=OA=class extends Me.Z{constructor(e){super(e),this.exactMatch=!1,this.name=null,this.type=null}clone(){return new OA({exactMatch:this.exactMatch,type:this.type,name:this.name})}};(0,o._)([(0,x.Cb)({type:Boolean,json:{write:!0}})],DA.prototype,"exactMatch",void 0),(0,o._)([(0,x.Cb)({type:String,json:{write:!0}})],DA.prototype,"name",void 0),(0,o._)([(0,Oe.J)(SA.v)],DA.prototype,"type",void 0),DA=OA=(0,o._)([(0,S.j)("esri.webdoc.applicationProperties.SearchTableField")],DA);const IA=DA;var LA;let FA=LA=class extends Me.Z{constructor(e){super(e),this.field=null,this.id=null}clone(){return new LA((0,Ee.d9)({field:this.field,id:this.id}))}};(0,o._)([(0,x.Cb)({type:IA,json:{write:{isRequired:!0}}})],FA.prototype,"field",void 0),(0,o._)([(0,x.Cb)({type:String,json:{write:{isRequired:!0}}})],FA.prototype,"id",void 0),FA=LA=(0,o._)([(0,S.j)("esri.webdoc.applicationProperties.SearchTable")],FA);const NA=FA;var UA;const HA=c.Z.ofType(AA),VA=c.Z.ofType(NA);let kA=UA=class extends Me.Z{constructor(e){super(e),this.addressSearchEnabled=!0,this.enabled=!0,this.hintText=null,this.layers=new HA,this.tables=new VA}readAddressSearchEnabled(e){return!e}writeAddressSearchEnabled(e,t,i){t[i]=!e}clone(){return new UA((0,Ee.d9)({addressSearchEnabled:this.addressSearchEnabled,enabled:this.enabled,hintText:this.hintText,layers:this.layers,tables:this.tables}))}};(0,o._)([(0,x.Cb)({type:Boolean,nonNullable:!0,json:{read:{source:"disablePlaceFinder"},write:{target:"disablePlaceFinder",isRequired:!0},origins:{"web-scene":{read:!1,write:!1}}}})],kA.prototype,"addressSearchEnabled",void 0),(0,o._)([(0,qe.r)("addressSearchEnabled")],kA.prototype,"readAddressSearchEnabled",null),(0,o._)([(0,Ae.c)("addressSearchEnabled")],kA.prototype,"writeAddressSearchEnabled",null),(0,o._)([(0,x.Cb)({type:Boolean,nonNullable:!0,json:{write:!0,origins:{"web-map":{write:{isRequired:!0}},"web-scene":{default:!0,write:!0}}}})],kA.prototype,"enabled",void 0),(0,o._)([(0,x.Cb)({type:String,json:{write:!0}})],kA.prototype,"hintText",void 0),(0,o._)([(0,x.Cb)({type:HA,json:{write:{overridePolicy:xA},origins:{"web-scene":{write:{isRequired:!0}}}}})],kA.prototype,"layers",void 0),(0,o._)([(0,x.Cb)({type:VA,json:{read:!0,write:{overridePolicy:xA}}})],kA.prototype,"tables",void 0),kA=UA=(0,o._)([(0,S.j)("esri.webdoc.applicationProperties.Search")],kA);const BA=kA;var zA;let GA=zA=class extends Me.Z{constructor(e){super(e),this.search=null}clone(){return new zA((0,Ee.d9)({search:this.search}))}};(0,o._)([(0,x.Cb)({type:BA,json:{write:!0}})],GA.prototype,"search",void 0),GA=zA=(0,o._)([(0,S.j)("esri.webdoc.applicationProperties.Viewing")],GA);const qA=GA;var ZA;let jA=ZA=class extends Me.Z{constructor(e){super(e),this.viewing=null}clone(){return new ZA({viewing:this.viewing?.clone()??null})}};(0,o._)([(0,x.Cb)({type:qA,json:{write:!0}})],jA.prototype,"viewing",void 0),jA=ZA=(0,o._)([(0,S.j)("esri.webscene.ApplicationProperties")],jA);const WA=jA,$A={type:vt.T,json:{read:{source:"timeExtent",reader:e=>e?Array.isArray(e)?vt.T.fromArray(e):vt.T.fromJSON(e):null},write:{writer:(e,t,i,r)=>{e&&(e.isEmpty?r?.messages&&r.messages.push(new u.Z("invalid-timeExtent","TimeExtent cannot be empty")):t[i]=e.toArray())},target:{timeExtent:{type:[[M.z8,M.p2]]}}}}};var XA=i(93460);const YA=["slice"];let QA=class extends c.Z{constructor(e){super(e),this.addHandles([this.on("after-add",(e=>{this._setOrigin(e.item)})),this.on("before-remove",(e=>{const{origin:t}=e.item;"web-scene"===t?.type&&this._setOrigin(e.item,null)}))])}initialize(){for(const e of this.items)this._setOrigin(e)}_setOrigin(e,t=new XA.Z){e.origin=t}updateFrom(e){const t=e.analyses.filter((e=>JA(e)));this.removeAll(),t.length&&this.addMany(t.map((e=>(e.origin=new XA.Z,e.clone()))))}applyTo(e){e.analyses.destroyMany(e.analyses.filter((({origin:e})=>"web-scene"===e?.type))),e.analyses.addMany(this.map((e=>e.clone())))}toJSON(e){return this.items.filter(JA).map((t=>t.toJSON(e)))}};function KA(e){return{type:QA,cast:Te.R,clonable:e=>new QA({items:e.items.map((e=>e.clone()))}),set(t){this._set(e,(0,Te.Z)(t,this._get(e),QA))},json:{read(t,i,r){r?.hooks?.onAfterLoad((()=>async function(e,t,i){if(!t)return;const r=await Promise.allSettled(t.map((e=>async function(e,t){const i=new(await eO[e.type]());return i.read(e,t),i}(e,i))));for(const t of r)"fulfilled"===t.status&&e.add(t.value)}(this[e],t,r)))},write:{overridePolicy:e=>({enabled:e.length>0})}}}}function JA(e){return YA.includes(e.type)&&e.valid}QA=(0,o._)([(0,S.j)("esri.webscene.support.analysisUtils.WebSceneAnalysesCollection")],QA);const eO={slice:async()=>{const{default:e}=await i.e(22416).then(i.bind(i,22416));return e}};let tO=class extends(Be.Z.ClonableMixin(Me.Z)){constructor(e){super(e),this.analyses=new QA,this.environment=new Rn,this.spatialReference=null,this.viewpoint=null,this.timeExtent=null}set viewingMode(e){this._set("viewingMode",e)}};(0,o._)([(0,x.Cb)(KA("analyses"))],tO.prototype,"analyses",void 0),(0,o._)([(0,x.Cb)({type:Rn,json:{write:{isRequired:!0}}})],tO.prototype,"environment",void 0),(0,o._)([(0,x.Cb)({type:N.Z,json:{default:()=>N.Z.WebMercator}})],tO.prototype,"spatialReference",void 0),(0,o._)([(0,x.Cb)({type:["local","global"],json:{default:"global"}})],tO.prototype,"viewingMode",null),(0,o._)([(0,x.Cb)({type:l.Z,json:{write:{isRequired:!0}}})],tO.prototype,"viewpoint",void 0),(0,o._)([(0,x.Cb)($A)],tO.prototype,"timeExtent",void 0),tO=(0,o._)([(0,S.j)("esri.webscene.InitialViewProperties")],tO);const iO=tO;var rO;let sO=rO=class extends Me.Z{constructor(){super(...arguments),this.url=""}destroy(){this.url=""}get isSecureUrl(){return(0,X_.$U)(this.url)}get isDataURI(){return(0,X_.HK)(this.url)}clone(){return new rO({url:this.url})}};(0,o._)([(0,x.Cb)({type:String,json:{write:{isRequired:!0}}})],sO.prototype,"url",void 0),(0,o._)([(0,x.Cb)()],sO.prototype,"isSecureUrl",null),(0,o._)([(0,x.Cb)()],sO.prototype,"isDataURI",null),sO=rO=(0,o._)([(0,S.j)("esri.webdoc.support.SlideThumbnail")],sO);let nO=class extends(Be.Z.ClonableMixin(Me.Z)){constructor(){super(...arguments),this.text=""}};(0,o._)([(0,x.Cb)({type:String,json:{write:{isRequired:!0}}})],nO.prototype,"text",void 0),nO=(0,o._)([(0,S.j)("esri.webscene.support.Description")],nO);const aO=nO;let oO=class extends(Be.Z.ClonableMixin(Me.Z)){constructor(e){super(e),this.visible=!1}};(0,o._)([(0,x.Cb)({type:Boolean,json:{default:!1,write:!0}})],oO.prototype,"visible",void 0),oO=(0,o._)([(0,S.j)("esri.webscene.SlideLegendInfo")],oO);const lO=oO,cO=new sA.X({globalId:"global-id",objectId:"object-id"},{ignoreUnknown:!0});let hO=class extends(Be.Z.ClonableMixin(Me.Z)){constructor(e){super(e),this.type=null}};(0,o._)([(0,x.Cb)({type:cO.apiValues,readOnly:!0,json:{type:cO.jsonValues,read:!1,write:!0}})],hO.prototype,"type",void 0),hO=(0,o._)([(0,S.j)("esri.webscene.support.FeatureReferenceId")],hO);const uO=hO;let dO=class extends uO{constructor(e){super(e),this.type="object-id",this.value=null}};(0,o._)([(0,Oe.J)({objectId:"object-id"}),(0,x.Cb)({type:["object-id"],json:{read:!1,write:{isRequired:!0}},nonNullable:!0})],dO.prototype,"type",void 0),(0,o._)([(0,x.Cb)({type:[Number,String],json:{read:!0,write:{isRequired:!0}}})],dO.prototype,"value",void 0),dO=(0,o._)([(0,S.j)("esri.webscene.support.FeatureReferenceObjectId")],dO);const pO=dO;let mO=class extends uO{constructor(e){super(e),this.type="global-id",this.value=null}};(0,o._)([(0,Oe.J)({globalId:"global-id"}),(0,x.Cb)({type:["global-id"],json:{read:!1,write:{isRequired:!0}},nonNullable:!0})],mO.prototype,"type",void 0),(0,o._)([(0,x.Cb)({type:String,json:{read:!0,write:{isRequired:!0}}})],mO.prototype,"value",void 0),mO=(0,o._)([(0,S.j)("esri.webscene.support.FeatureReferenceGlobalId")],mO);const _O={key:"type",base:uO,typeMap:{"object-id":pO,"global-id":mO}};let fO=class extends(Be.Z.ClonableMixin(Me.Z)){constructor(e){super(e),this.layerId=null,this.sublayerId=null}};(0,o._)([(0,x.Cb)({type:String,json:{write:{isRequired:!0}},nonNullable:!0})],fO.prototype,"layerId",void 0),(0,o._)([(0,x.Cb)({type:Number,json:{write:!0}})],fO.prototype,"sublayerId",void 0),fO=(0,o._)([(0,S.j)("esri.webscene.support.LayerReference")],fO);const gO=fO;let yO=class extends(Be.Z.ClonableMixin(Me.Z)){constructor(e){super(e),this.layerReference=new gO,this.id=new pO}};(0,o._)([(0,x.Cb)({nonNullable:!0,json:{write:{isRequired:!0}},type:gO})],yO.prototype,"layerReference",void 0),(0,o._)([(0,x.Cb)({json:{read:!0,write:{isRequired:!0}},nonNullable:!0,types:_O})],yO.prototype,"id",void 0),yO=(0,o._)([(0,S.j)("esri.webscene.support.FeatureReference")],yO);const vO=yO,bO=c.Z.ofType(vO);let wO=class extends(Be.Z.ClonableMixin(Me.Z)){constructor(e){super(e),this.features=new bO,this.selectedFeatureIndex=0,this.location=null}};(0,o._)([(0,x.Cb)({type:bO,nonNullable:!0,json:{read:!0,write:{isRequired:!0}}})],wO.prototype,"features",void 0),(0,o._)([(0,x.Cb)({type:Number,nonNullable:!0,json:{write:!0}})],wO.prototype,"selectedFeatureIndex",void 0),(0,o._)([(0,x.Cb)({type:a.Z,json:{write:{isRequired:!0}}})],wO.prototype,"location",void 0),wO=(0,o._)([(0,S.j)("esri.webscene.support.SlidePopupInfo")],wO);const CO=wO;let xO=class extends(Be.Z.ClonableMixin(Me.Z)){constructor(e){super(e),this.analyses=new QA,this.legendInfo=null,this.popupInfo=null}};(0,o._)([(0,x.Cb)(KA("analyses"))],xO.prototype,"analyses",void 0),(0,o._)([(0,x.Cb)({type:lO,json:{write:!0}})],xO.prototype,"legendInfo",void 0),(0,o._)([(0,x.Cb)({type:CO,json:{write:!0}})],xO.prototype,"popupInfo",void 0),xO=(0,o._)([(0,S.j)("esri.webscene.support.SlideElements")],xO);const TO=xO;let SO=class extends(Be.Z.ClonableMixin(Me.Z)){constructor(){super(...arguments),this.lighting=new mn.Z,this.weather=new pn.Z}};var MO;(0,o._)([(0,x.Cb)({types:fn,json:{write:!0}})],SO.prototype,"lighting",void 0),(0,o._)([(0,x.Cb)({types:gs.Hr,json:{write:!0}})],SO.prototype,"weather",void 0),SO=(0,o._)([(0,S.j)("esri.webscene.support.SlideEnvironment")],SO);const EO={type:Number,json:{type:M.z8,name:"transparency",read:Ne.b,write:(e,t,i)=>{t[i]=(0,Ne.a)(e)}}};let RO=MO=class extends(Be.Z.ClonableMixin(Me.Z)){constructor(){super(...arguments),this.opacity=null}cloneAndApplyTo(e){return null==this.opacity||((e=e?.clone()??new Ve).opacity=this.opacity),e}static fromGround(e){return new MO({opacity:e.opacity})}};(0,o._)([(0,x.Cb)(EO)],RO.prototype,"opacity",void 0),RO=MO=(0,o._)([(0,S.j)("esri.webscene.support.SlideGround")],RO);const PO=RO;let AO=class extends(Be.Z.ClonableMixin(Me.Z)){constructor(e){super(e),this.id="",this.sublayerIds=null}};(0,o._)([(0,x.Cb)({type:String,json:{write:!0}})],AO.prototype,"id",void 0),(0,o._)([(0,x.Cb)({type:[M.z8],json:{name:"subLayerIds",write:!0}})],AO.prototype,"sublayerIds",void 0),AO=(0,o._)([(0,S.j)("esri.webscene.support.SlideVisibleLayer")],AO);let OO=class extends(Be.Z.ClonableMixin(Me.Z)){constructor(){super(...arguments),this.text=""}};(0,o._)([(0,x.Cb)({type:String,json:{write:{isRequired:!0}}})],OO.prototype,"text",void 0),OO=(0,o._)([(0,S.j)("esri.webscene.support.Title")],OO);const DO=OO;let IO=0;const LO=c.Z.ofType(AO);let FO=class extends(Be.Z.ClonableMixin(Me.Z)){constructor(e){super(e),this.id=Date.now().toString(16)+"-slide-"+IO++,this.title=new DO,this.description=new aO,this.hidden=!1,this.thumbnail=new sO,this.viewpoint=null,this.basemap=null,this.ground=null,this.layout="caption",this.enabledFocusAreas=null,this.environment=new SO,this.timeExtent=null,this.elements=new TO,this.visibleLayers=new LO}destroy(){this.visibleLayers.removeAll(),this.enabledFocusAreas=null,this.basemap=null,this.thumbnail=(0,f.SC)(this.thumbnail),this.description=null,this.title=null,this.thumbnail=null,this.elements=null}castTitle(e){return"string"==typeof e?new DO({text:e}):(0,M.se)(DO,e)}castDescription(e){return"string"==typeof e?new aO({text:e}):(0,M.se)(aO,e)}castThumbnail(e){return"string"==typeof e?new sO({url:e}):(0,M.se)(sO,e)}castBasemap(e){return at(e)}set visibleLayers(e){this._set("visibleLayers",(0,Te.Z)(e,this._get("visibleLayers"),LO))}castVisibleLayers(e){return e&&"function"==typeof e.map?e.map((e=>{if("string"==typeof e)return{id:e};if(e instanceof Oi.Z){const t=HO(e);return{id:e.id,sublayerIds:t}}return e.id?{id:e.id,sublayerIds:"sublayerIds"in e?e.sublayerIds:void 0}:(_.Z.getLogger(this).warn('Invalid visible layer, expected { id }, Layer or "id"'),e)})):null}async _updateVisibleLayers(e){const t=[];await Promise.allSettled(this._getLayers(e.map).map((i=>e.whenLayerView(i).then((e=>{if(e.visible){const r=HO(i);t.push(new AO({id:e.layer.id,sublayerIds:r}))}})))).toArray()),this.visibleLayers.removeAll(),this.visibleLayers.addMany(t)}async updateFrom(e,t){const i={format:"png",quality:80,width:120,height:75,disableDecorations:!0,...t?.screenshot};await e.when(),this.viewpoint=e.viewpoint.clone(),this.environment.lighting="virtual"===e.environment.lighting.type?_n.Z.prototype.clone.apply(e.environment.lighting):mn.Z.prototype.clone.apply(e.environment.lighting),this.environment.weather=e.environment.weather.clone(),this.enabledFocusAreas=new c.Z(e.focusAreasView?.enabledAreas.map((({id:e})=>e))??[]),this.basemap=e.map.basemap?.clone()||null,this.ground=e.map.ground?PO.fromGround(e.map.ground):null,this.timeExtent=e.timeExtent?.clone()??null,this.elements.analyses.updateFrom(e),await this._updateVisibleLayers(e);const r=await e.takeScreenshot(i);return this.thumbnail=new sO({url:r.dataUrl}),this}async applyTo(e,t){null!=this._applyToController&&this._applyToController.abort();let i=new AbortController;this._applyToController=i;const r=(0,y.$F)(t,(()=>i?.abort())),s=()=>{this._applyToController===i&&(this._applyToController=null),i=null,r?.remove()};try{await(0,n.N1)((()=>e.ready),i.signal)}catch(e){throw s(),e}if(i.signal.aborted)throw s(),(0,y.zE)();const a=e.resourceController.scheduler.registerTask(Gr.T8.SLIDE);let o=!1;const l={animate:!0,...t,signal:this._applyToController.signal},c=await(0,me.q6)(e.addUpdatingPromise((async()=>{await Promise.all([a.schedule((async()=>o=await this._setViewpointOfInterest(e,l))),a.schedule((()=>this._applyBasemap(e,l)),l.signal),a.schedule((()=>this._loadLayersWithSublayerVisibility(e)))]),await Promise.all([a.schedule((()=>this._applyLayerVisibility(e)),l.signal),a.schedule((()=>this._applyFocusAreaEnabled(e.map?.focusAreas.areas))),a.schedule((()=>this._applyGround(e)),l.signal),a.schedule((()=>this.elements.analyses.applyTo(e)),l.signal),a.schedule((()=>this._applyViewpoint(e,l)),l.signal),a.schedule((()=>e.timeExtent=this.timeExtent?.clone()??null),l.signal),a.schedule((()=>e.environment.weather=this.environment.weather.clone()))])})()));if(o&&(e.contentCamera=null),a.remove(),s(),!1===c.ok)throw c.error;return this}async _applyBasemap(e,t){if(this.basemap){try{await this.basemap.load(t)}catch(e){if((0,y.D_)(e))throw e}e.map.basemap=function(e,t=null){const i=at(e);if(!i)return null;const r=i.clone();return t&&(r.baseLayers=ot(r.baseLayers,t.baseLayers),r.referenceLayers=ot(r.referenceLayers,t.referenceLayers)),r}(this.basemap,e.map.basemap)}}_applyGround(e){this.ground&&(e.map.ground=this.ground.cloneAndApplyTo(e.map.ground))}_applyFocusAreaEnabled(e){if(e&&this.enabledFocusAreas)for(const t of e)t.enabled=this.enabledFocusAreas.includes(t.id)}_getLayers(e){const t=new c.Z;return this._collectLayers(e,t),this._collectLayers(e.ground,t),t}_collectLayers(e,t){e.layers.forEach((e=>{e.persistenceEnabled&&(t.add(e),"layers"in e&&this._collectLayers(e,t))}))}async _loadLayersWithSublayerVisibility(e){this.visibleLayers&&await Promise.allSettled(this._getLayers(e.map).items.map((e=>{const t=this.visibleLayers.find((t=>t.id===e.id))?.sublayerIds;return t?e.load():null})))}_applyLayerVisibility(e){this.visibleLayers&&this._getLayers(e.map).forEach((e=>{const t=this.visibleLayers.find((t=>t.id===e.id));e.visible=null!=t;const i=t?.sublayerIds,r=UO(e);i&&r&&r.forEach((e=>e.visible=i.includes(e.id)))}))}async _setViewpointOfInterest(e,t){if(e.state.fixedContentCamera||!this.viewpoint||t?.ignoreViewpoint||!t?.useDestinationCamera)return!1;const{toCameraAsync:r}=await Promise.resolve().then(i.bind(i,77755)),s=await r(e,this.viewpoint);return e.contentCamera=s,null!=s}async _applyViewpoint(e,t){if(this._applyCachedCameraTrackingEnabled(e),this.viewpoint&&!t.ignoreViewpoint){const i=this.environment.lighting;if(t.animate&&"sun"===i.type&&i.date)return this._animateToLighting(e,t);t.animate&&(e.environment.applyLighting(i.clone()),await e.goTo(this.viewpoint,t)),e.viewpoint=this.viewpoint}e.environment.applyLighting(this.environment.lighting.clone())}async _animateToLighting(e,t){let i=null;return"virtual"!==e.environment.lighting.type&&"virtual"!==this.environment.lighting.type&&("global"===e.viewingMode&&(i=this._animateLightingWithCamera(e,e.environment.lighting,this.environment.lighting)),e.environment.cachedCameraTrackingEnabled=e.environment.lighting.cameraTrackingEnabled,e.environment.lighting.cameraTrackingEnabled=!1),e.environment.lighting.directShadowsEnabled=this.environment.lighting.directShadowsEnabled,"virtual"===this.environment.lighting.type||"virtual"===e.environment.lighting.type?(e.environment.applyLighting(this.environment.lighting.clone()),"virtual"!==e.environment.lighting.type&&(e.environment.cachedCameraTrackingEnabled=e.environment.lighting.cameraTrackingEnabled,e.environment.lighting.cameraTrackingEnabled=!1)):null!=this.environment.lighting.displayUTCOffset&&(e.environment.lighting.displayUTCOffset=this.environment.lighting.displayUTCOffset),e.goTo(this.viewpoint,t).then((()=>{this._applyCachedCameraTrackingEnabled(e),e.environment.applyLighting(this.environment.lighting.clone())})).catch((t=>{throw null==e.animation&&this._applyCachedCameraTrackingEnabled(e),t})).finally((()=>{(0,f.hw)(i)}))}_applyCachedCameraTrackingEnabled(e){null!=e.environment.cachedCameraTrackingEnabled&&(e.environment.lighting.cameraTrackingEnabled=e.environment.cachedCameraTrackingEnabled,e.environment.cachedCameraTrackingEnabled=null)}_getTime(e){return[(0,Yr.HA)(e.getTime()),(0,Yr._H)(3600*e.getUTCHours()+60*e.getUTCMinutes()+e.getUTCSeconds())]}_setTime(e,t,i){return e.setTime(t),e.setUTCHours(i/3600),e.setUTCMinutes(i%3600/60),e.setUTCSeconds(i%3600%60),e}_animateLightingWithCamera(e,t,i){const r=new Date(t.date.toString()),[s,a]=this._getTime(r),[o,l]=this._getTime(i.date),c=function(e,t){let i=t-e;return i>kO&&(i-=VO),i<-kO&&(i+=VO),(0,Yr._H)(i)}(a,l),h=e.renderCoordsHelper,u=(0,O.Ue)();h.toRenderCoords(e.camera.position,u);const d=(0,O.Ue)(),p=(0,O.Ue)();null!=this.viewpoint.camera&&h.toRenderCoords(this.viewpoint.camera.position,d);const m=new Date;return(0,n.gx)((()=>e.camera),(e=>{h.toRenderCoords(e.position,p);const i=(0,mr.s)(u,p),r=(0,mr.s)(d,p);let n=0;i+r!==0&&(n=i/(i+r));const l=s+(o-s)*n,_=function(e,t){return(0,Yr._H)((0,jt.HS)(e+t,VO))}(a,(0,Yr._H)(c*n));t.date=this._setTime(m,l,_)}))}write(e,t){const i=super.write(e,t);return i?.elements&&0===Object.keys(i.elements).length&&delete i.elements,i}static createFrom(e,t){return(new this).updateFrom(e,t)}};(0,o._)([(0,x.Cb)({type:String,json:{write:{isRequired:!0}}})],FO.prototype,"id",void 0),(0,o._)([(0,x.Cb)({type:DO,json:{default:()=>new DO({text:""}),write:{isRequired:!0}}})],FO.prototype,"title",void 0),(0,o._)([(0,T.p)("title")],FO.prototype,"castTitle",null),(0,o._)([(0,x.Cb)({type:aO,json:{write:{overridePolicy:e=>({enabled:!(!e||!e.text)})}}})],FO.prototype,"description",void 0),(0,o._)([(0,T.p)("description")],FO.prototype,"castDescription",null),(0,o._)([(0,x.Cb)({type:Boolean,nonNullable:!0,json:{write:!0,default:!1}})],FO.prototype,"hidden",void 0),(0,o._)([(0,x.Cb)({type:sO,json:{default:()=>new sO({url:""}),write:{isRequired:!0}}})],FO.prototype,"thumbnail",void 0),(0,o._)([(0,T.p)("thumbnail")],FO.prototype,"castThumbnail",null),(0,o._)([(0,x.Cb)({type:l.Z,nonNullable:!0,json:{write:{isRequired:!0}}})],FO.prototype,"viewpoint",void 0),(0,o._)([(0,x.Cb)({type:Ce.default,json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],FO.prototype,"basemap",void 0),(0,o._)([(0,T.p)("basemap")],FO.prototype,"castBasemap",null),(0,o._)([(0,x.Cb)({type:PO,json:{write:!0}})],FO.prototype,"ground",void 0),(0,o._)([(0,x.Cb)({type:["caption","cover","none"],json:{write:!0,default:"caption"},nonNullable:!0})],FO.prototype,"layout",void 0),(0,o._)([(0,x.Cb)({type:LO,json:{write:{isRequired:!0}}})],FO.prototype,"visibleLayers",null),(0,o._)([(0,T.p)("visibleLayers")],FO.prototype,"castVisibleLayers",null),(0,o._)([(0,x.Cb)({type:c.Z.ofType(String),json:{write:!0},clonable:e=>e?new c.Z(e.items):null})],FO.prototype,"enabledFocusAreas",void 0),(0,o._)([(0,x.Cb)({type:SO,json:{write:!0}})],FO.prototype,"environment",void 0),(0,o._)([(0,x.Cb)($A)],FO.prototype,"timeExtent",void 0),(0,o._)([(0,x.Cb)({type:TO,nonNullable:!0,json:{write:!0}})],FO.prototype,"elements",void 0),FO=(0,o._)([(0,S.j)("esri.webscene.Slide")],FO);const NO=FO;function UO(e){if("building-scene"===e.type||"map-image"===e.type)return e.allSublayers.toArray()}function HO(e){const t=UO(e);if(t)return t.filter((e=>e.visible)).map((e=>e.id))}const VO=(0,Yr._H)(86400),kO=(0,Yr._H)(43200);const BO=c.Z.ofType(NO);let zO=class extends(Be.Z.ClonableMixin(Me.Z)){constructor(e){super(e),this.slides=new BO}destroy(){this.slides.forEach((e=>e.destroy())),this.slides.removeAll()}set slides(e){e&&(e=e.filter((e=>!!e.viewpoint))),this._set("slides",(0,Te.Z)(e,this._get("slides"),BO))}};(0,o._)([(0,x.Cb)({type:BO,nonNullable:!0,json:{write:!0}}),(0,T.p)(Te.R)],zO.prototype,"slides",null),zO=(0,o._)([(0,S.j)("esri.webscene.Presentation")],zO);const GO=zO;var qO;let ZO=qO=class extends Me.Z{constructor(e){super(e)}clone(){return new qO({name:this.name,path:this.path,title:this.title})}};(0,o._)([(0,x.Cb)({type:String,json:{write:{isRequired:!0}}})],ZO.prototype,"name",void 0),(0,o._)([(0,x.Cb)({type:String,json:{write:{isRequired:!0}}})],ZO.prototype,"path",void 0),(0,o._)([(0,x.Cb)({type:String,json:{write:{isRequired:!0}}})],ZO.prototype,"title",void 0),ZO=qO=(0,o._)([(0,S.j)("esri.webscene.TransportationNetwork")],ZO);const jO=ZO;var WO=i(15322);class $O extends WO.G{constructor(e,t){super(e,t,"webscene")}get supportsGround(){return this.greaterEqual(1,8)}get supportsVisibleElevationLayersInSlides(){return this.lessThan(1,8)}}var XO=i(64801);let YO=null;var QO;const KO=new $O(1,37),JO="Web Scene";let eD=class extends(Re.Z.LoadableMixin(_t.Z.EsriPromiseMixin((0,NP.R)(pt)))){static{QO=q.x}constructor(e){super(e),this[QO]=!0,this._layersIdGCTimeoutId=void 0,this._updateFromPromise=null,this._afterLoadHooks=[],this.applicationProperties=null,this.clippingArea=null,this.clippingEnabled=!1,this.floorInfo=null,this.heightModelInfo=void 0,this.sourceVersion=null,this.transportationNetworks=null,this.presentation=new GO,this.initialViewProperties=new iO,this.portalItem=null,this.resourceInfo=null,this.widgets=null,this._debouncedSaveOperations=(0,y.Ds)((async(e,t,i)=>{switch(e){case eA.x.SAVE:return this._saveImpl(t);case eA.x.SAVE_AS:return this._saveAsImpl(i,t)}})),this._loadContext={origin:"web-scene",initiator:this,hooks:{onAfterLoad:e=>this._afterLoadHooks.push(e)}},this._resourceReferences={portalItem:null,paths:[]},this.authoringApp=null,this.authoringAppVersion=null,this._isAuthoringAppSetByUser=!1,this._isAuthoringAppVersionSetByUser=!1}initialize(){if(this.when().catch((e=>{_.Z.getLogger(this).error("#load()","Failed to load web scene",e)})),this.resourceInfo){let e;try{e=this._validateJSON(this.resourceInfo)}catch(e){return void this.addResolvingPromise(Promise.reject(e))}this.read(e),this.addResolvingPromise(this._validateSpatialReference()),this.addResolvingPromise(this._validateHeightModelInfo())}this.addHandles((0,n.on)((()=>this.allLayers),"change",(()=>this._scheduleLayersIdGC())))}destroy(){this._unscheduleLayersIdGC(),this.presentation&&this.presentation.destroy(),this.portalItem=(0,f.SC)(this.portalItem)}writeClippingArea(e,t){t.clippingArea||(t.clippingArea={}),t.clippingArea.geometry=e.toJSON()}readClippingEnabled(e,t){return!!t.clippingArea&&!!t.clippingArea.clip}writeClippingEnabled(e,t){this.clippingArea&&(t.clippingArea||(t.clippingArea={}),t.clippingArea.clip=e)}writeLayers(e,t,i,r){t[i]=this._layersToJSON(e,"operational-layers",r)}readSourceVersion(e,t){const[i,r]=t.version.split(".");return new $O(parseInt(i,10),parseInt(r,10))}writeSourceVersion(e,t,i){t[i]=`${KO.major}.${KO.minor}`}writeTables(e,t,i,r){const s=this._layersToJSON(e,"tables",r);s.length&&(t[i]=s)}get thumbnailUrl(){return this.portalItem?.thumbnailUrl??null}set thumbnailUrl(e){e?this._override("thumbnailUrl",e):(this._clearOverride("thumbnailUrl"),this.clear("thumbnailUrl","user"))}set authoringApp(e){this._isAuthoringAppSetByUser=!0,this._set("authoringApp",e)}writeAuthoringApp(e,t){e&&this._isAuthoringAppSetByUser?t.authoringApp=e:t.authoringApp="ArcGIS API for JavaScript"}set authoringAppVersion(e){this._isAuthoringAppVersionSetByUser=!0,this._set("authoringAppVersion",e)}writeAuthoringAppVersion(e,t){e&&this._isAuthoringAppVersionSetByUser?t.authoringAppVersion=e:t.authoringAppVersion=FP.i8}writeGround(e,t,i,r){t[i]=e?e.write({},r):{transparency:0,layers:[]}}readInitialViewProperties(e,t,i){const{viewingMode:r,spatialReference:s}=t,n=new iO,a={...t.initialState};return void 0!==s&&(a.spatialReference=s),void 0!==r&&(a.viewingMode=r),n.read(a,i),n}get spatialReference(){return this.initialViewProperties?.spatialReference??N.Z.WebMercator}get viewingMode(){return this.initialViewProperties?.viewingMode??"global"}load(e){const t=this.ground;return this.addResolvingPromise(this._loadFromSource().then((()=>{t&&t!==this.ground&&t.destroy(),this._validateFeatureLayerSymbolVisibility()}))),Promise.resolve(this)}loadAll(){return(0,Pe.G)(this,(e=>{const t=this.presentation&&this.presentation.slides;e(this.ground,this.basemap,this.layers,t&&t.map((e=>e.basemap)),this.tables)}))}read(e,t){t??=this._loadContext,t.origin="web-scene";const i=this._isAuthoringAppVersionSetByUser,r=this._isAuthoringAppSetByUser;if((0,VP.$)(this,e,(t=>super.read(e,t)),t),r||(this._isAuthoringAppSetByUser=!1),i||(this._isAuthoringAppVersionSetByUser=!1),e.baseMap&&Array.isArray(e.baseMap.elevationLayers)&&this.sourceVersion?.supportsVisibleElevationLayersInSlides){const t=e.baseMap.elevationLayers.map((e=>({id:e.id}))),i=this.presentation.slides,r=t.filter((e=>!i.some((t=>t.visibleLayers.some((t=>t.id===e.id))))));i.forEach((e=>e.visibleLayers.addMany(r)))}}_writeBasemapElevationLayers(e){const t=e.ground?.layers;!e.baseMap&&t?.length&&(e.baseMap={title:"Basemap",baseMapLayers:[]}),e.baseMap&&(e.baseMap.elevationLayers=(0,Ee.d9)(t))}_layersToJSON(e,t,i){const r={...i,layerContainerType:t};return e.map((e=>this._verifyWritableLayer(e,i)?e.write({},r):null)).filter((e=>!!e)).toArray()}_verifyWritableLayer(e,t){return!!e.persistenceEnabled&&("write"in e||(t?.messages&&t.messages.push(new u.Z("layer:unsupported",`Layers (${e.title}, ${e.id}) of type '${e.declaredClass}' cannot be persisted in web scenes`,{layer:e})),!1))}write(e,t){if("loaded"!==this.loadStatus){const e=new u.Z("webscene:not-loaded","Web scene must be loaded before it can be serialized");throw _.Z.getLogger(this).error("#toJSON()","Web scene must be loaded before it can be serialized",this.loadError||this.loadStatus),e}this._runLayersIdGC();const i=!t?.messages;t={messages:[],...t,origin:"web-scene"};const r=super.write(e,t);if(i){const e=t.messages?.filter((e=>"web-document-write:property-required"===e.name))??[];if(e.length){const t=new u.Z("web-document:property-required","One or more properties that are required in the webscene JSON are missing, see details for the specific errors",{errors:e});throw _.Z.getLogger(this).error("#toJSON()","One or more properties that are required in the webscene JSON are missing",e),t}}return this._writeBasemapElevationLayers(r),r}async save(e){return this._debouncedSaveOperations(eA.x.SAVE,e)}async _saveImpl(e){if(!this.portalItem)throw new u.Z("webscene:portal-item-not-set","Portal item to save to has not been set on the WebScene");if(this.portalItem?.type!==JO)throw new u.Z("webscene:portal-item-wrong-type",`Portal item needs to have type "${JO}"`);const t=this._updateFromPromise;await this._ensureLoadBeforeSave();const i=this._enableVerifyItemRelativeUrls((0,GP.Y)(this.portalItem,"web-scene",!0)),r=this.write({},i);return await Promise.all(i.resources.pendingOperations),await this._verifySave(r,i,eA.x.SAVE,e),this._updateTypeKeywords(this.portalItem),await(0,gA.b)(this.portalItem,r,this._resourceReferences,i),(0,HP.D)(i),t&&await t,await this._saveThumbnail(),this.portalItem}async saveAs(e,t){return this._debouncedSaveOperations(eA.x.SAVE_AS,t,e)}async _saveAsImpl(e,t){let i=zP.default.from(e);if(!i)throw new u.Z("webscene:portal-item-required","saveAs requires a portal item to save to");i.id&&(i=i.clone(),i.id=null);const r=i.portal||BP.Z.getDefault();await this._ensureLoadBeforeSave(),i.type=JO,i.portal=r;const s=this._enableVerifyItemRelativeUrls((0,GP.Y)(i,"web-scene",!0)),n=this.write({},s);await Promise.all(s.resources.pendingOperations),await this._verifySaveAs(n,s,t);const a=this.thumbnailUrl,o=!this._isOverridden("thumbnailUrl");this._updateTypeKeywords(i),await r.signIn();const l=this.portalItem,c={item:l,authenticated:!(!l?.id||!l.portal.user)},{copyAllowed:h,itemReloaded:d}=await wA(c,r);if(c.authenticated||=d,!h)throw new u.Z(`${s.name}:save-as-copy-not-allowed`,"Owner of this map does not allow others to save a copy");const p={...t,copyAllResources:!0};return await CA(i,c,n,p)&&(this._resourceReferences.portalItem=i),await(0,gA.H)(this._resourceReferences,s),this.portalItem=i,NP.w.prototype.read.call(this,{version:n.version,authoringApp:n.authoringApp,authoringAppVersion:n.authoringAppVersion},{name:"web-scene",ignoreDefaults:!0,url:i.itemUrl?(0,X_.mN)(i.itemUrl):void 0}),(0,HP.D)(s),a&&(this.thumbnailUrl=o?(0,X_.ZN)(a,"w","8192"):a),s.portalItem=i,await this._saveThumbnail(),i}async _saveThumbnail(){this._isOverridden("thumbnailUrl")&&(await(this.portalItem?.updateThumbnail({thumbnail:this.thumbnailUrl})),this._clearOverride("thumbnailUrl"),this.clear("thumbnailUrl","user"))}async _verifySave(e,t,i,r){if(!(0,ft.N$)(this.spatialReference))throw new u.Z("webscene:unsupported-spatial-reference","Webscenes using spatial reference systems from Mars or Moon can not be saved currently.");const{ignoreUnsupported:s,requiredPropertyChecksDisabled:n,strictSchemaValidationEnabled:a}=r||{};(0,yA.zC)(t,{errorName:"webscene:save"},{ignoreUnsupported:s,supplementalUnsupportedErrors:["scenemodification:unsupported"],requiredPropertyChecksDisabled:n});const o=YO;if(a&&o){const t=(await o()).validate(e);if(!t.length)return;const r=`webscene did not validate:\n${t.join("\n")}`;_.Z.getLogger(this).error(`${i===eA.x.SAVE_AS?"saveAs":"save"}(): ${r}`);const s=t.map((e=>new u.Z("webscene:schema-validation",e)));throw function(e){return new u.Z("webscene:schema-validation","Failed to save webscene due to schema validation errors. See 'details.errors' for more detailed information",{errors:e})}(s)}}_verifySaveAs(e,t,i){return this._verifySave(e,t,eA.x.SAVE_AS,i)}verifySaveAs(e){const t=this._enableVerifyItemRelativeUrls({origin:"web-scene",messages:[]}),i=this.write({},t);return this._verifySaveAs(i,t,e)}canNotSaveAs(){return!1}async updateFrom(e,t={}){const i=this._updateFrom(e,t);this._updateFromPromise=i,await i,this._updateFromPromise===i&&(this._updateFromPromise=null)}async _updateFrom(e,t={}){if(await e.whenReady(),!t.environmentExcluded&&e.environment&&(this.initialViewProperties.environment=Rn.prototype.clone.apply(e.environment)),!t.viewpointExcluded&&e.viewpoint&&(this.initialViewProperties.viewpoint=e.viewpoint.clone()),this.initialViewProperties.spatialReference=e.spatialReference.clone(),this.initialViewProperties.viewingMode=e.viewingMode,this.initialViewProperties.timeExtent=e.timeExtent?.clone()??null,this.initialViewProperties.analyses.updateFrom(e),null!=e.clippingArea?e.clippingArea!==this.clippingArea&&(this.clippingArea=e.clippingArea.clone(),this.clippingEnabled=!0):this.clippingEnabled=!1,e.heightModelInfo&&(this.heightModelInfo=e.heightModelInfo.clone()),e.map===this)for(const t of e.allLayerViews){const e="visible";e in t&&e in t.layer&&t._isOverridden(e)&&(t.layer[e]=t[e])}if(!t.widgetsExcluded)for(const t of e.persistableViewModels)t.updateWebDocument(this);(!1===t.thumbnailExcluded||null==t.thumbnailExcluded&&!t.viewpointExcluded)&&await this.updateThumbnail(e,{size:t.thumbnailSize})}async updateThumbnail(e,t){const i=function(e,t){t=t||vA;let{width:i,height:r}=t;const s=i/r;return s<bA?r=i/bA:s>bA&&(i=r*bA),i>e.width&&(r*=e.width/i,i=e.width),r>e.height&&(i*=e.height/r,r=e.height),{width:Math.round(i),height:Math.round(r)}}(e,t?.size),r=await e.takeScreenshot({format:"jpg",width:i.width,height:i.height,disableDecorations:!0});this.thumbnailUrl=r.dataUrl}async _loadFromSource(){this.resourceInfo?await this._loadFromJSON(this.resourceInfo):this.portalItem?.id?await this._loadFromItem(this.portalItem):await this._loadObjectsWithLayers(),await this._afterLoad()}async _afterLoad(){for(;this._afterLoadHooks.length;){const e=this._afterLoadHooks.slice();this._afterLoadHooks.length=0,await Promise.allSettled(e.map((e=>e(this._loadContext))))}}_readAndLoadFromJSON(e){const t=this._loadContext,i=this._validateJSON(e);return this.read(i,t),this._loadFromJSON(i)}_extractOperationalLayers(e){const t=[];if(!this.sourceVersion?.supportsGround&&e.baseMap&&Array.isArray(e.baseMap.elevationLayers))for(const i of e.baseMap.elevationLayers)t.push(i);const i=[],r=e=>(e.layers&&(e.layers=e.layers.filter(r)),"ArcGISTiledElevationServiceLayer"!==e.layerType||(this.sourceVersion?.supportsGround||i.push(e),!1));return{operationalLayers:e.operationalLayers?e.operationalLayers.filter(r):[],operationalElevationLayers:i,basemapElevationLayers:t}}async _loadFromJSON(e){const t=new c.Z;await this._validateSpatialReference(),await this._validateHeightModelInfo();const{populateOperationalLayers:r}=await i.e(13259).then(i.bind(i,13259)),{operationalLayers:s,operationalElevationLayers:n,basemapElevationLayers:a}=this._extractOperationalLayers(e),o=[],l={context:{...this._loadContext,layerContainerType:"operational-layers"}};if(this.portalItem&&(l.context.portal=this.portalItem.portal||BP.Z.getDefault()),a.length>0){const e={...l,context:{...l.context,layerContainerType:"ground"}};e.defaultLayerType="ArcGISTiledElevationServiceLayer",o.push(r(this.ground.layers,a,e))}if(n.length>0){const e={...l,context:{...l.context,layerContainerType:"ground"}};e.defaultLayerType="ArcGISTiledElevationServiceLayer",o.push(r(t,n,e))}s&&s.length>0&&o.push(r(this.layers,s,l)),e.tables?.length&&o.push(r(this.tables,e.tables,{...l,context:{...l.context,layerContainerType:"tables"},defaultLayerType:"ArcGISFeatureLayer"})),await Promise.allSettled(o),await this._loadObjectsWithLayers(),this.ground.layers.addMany(t.filter((e=>"base-elevation"===e.type||"elevation"===e.type)))}async _ensureLoadBeforeSave(){await this.load(),await this._loadObjectsWithLayers();const e=[],t=[...this.allLayers.items];for(const{basemap:e}of this.presentation.slides.items)e&&(t.push(...e.baseLayers.items),t.push(...e.referenceLayers.items));for(const i of t)if("beforeSave"in i&&"function"==typeof i.beforeSave){const t=i.beforeSave();t&&e.push(t)}await Promise.allSettled(e)}async _loadObjectsWithLayers(){const e=[];this.ground&&e.push(this.ground.load()),this.basemap&&e.push(this.basemap.load()),this.presentation.slides.forEach((t=>{t.basemap&&e.push(t.basemap.load())})),await Promise.allSettled(e)}async _loadFromItem(e){if(await e.load().catch((e=>{throw new u.Z("webscene:load-portal-item","Failed to load portal item",{error:e})})),"Web Scene"!==e.type)throw new u.Z("webscene:invalid-portal-item","Invalid portal item type '${type}', expected 'Web Scene'",{type:e.type});const t=await e.fetchData();this.resourceInfo=t;const i=this._loadContext;i.url=(0,X_.mN)(e.itemUrl),i.portal=e.portal||BP.Z.getDefault(),i.portalItem=e,i.readResourcePaths=[],await this._readAndLoadFromJSON(t),this._resourceReferences={portalItem:e,paths:i.readResourcePaths??[]}}_validateSpatialReference(){const e=this.initialViewProperties,t=this._sceneSpatialReference;let i;if("local"!==e.viewingMode){if(!(0,PR.D)(t,Si.JY.Global))return Promise.reject(new u.Z("webscene:unsupported-spatial-reference","Unsupported spatial reference (${spatialReference.wkid}) in global mode, only Web Mercator, WGS84 GCS or CGCS2000 are supported",{spatialReference:t,viewingMode:e.viewingMode}));i=e=>!e||(0,F.canProjectWithoutEngine)(e,t)}else{if(!(0,PR.D)(t,Si.JY.Local))return Promise.reject(new u.Z("webscene:unsupported-spatial-reference","Unsupported spatial reference (${spatialReference.wkid}) in local mode, only projected coordinate systems are supported",{spatialReference:t,viewingMode:e.viewingMode}));i=e=>!e||e.equals(t)}const r=e=>e?.camera?.position.spatialReference??e?.targetGeometry?.spatialReference,s=e.viewpoint,n=r(s);if(n&&!i(n))return Promise.reject(new u.Z("webscene:incompatible-camera-spatial-reference","Camera spatial reference (${cameraSpatialReference.wkid}) is incompatible with the scene spatial reference (${sceneSpatialReference.wkid})",{cameraSpatialReference:n,sceneSpatialReference:t,viewingMode:e.viewingMode}));const a=this.presentation.slides.find((e=>!i(r(e.viewpoint))));if(a){const i=r(a.viewpoint);return Promise.reject(new u.Z("webscene:incompatible-slide-spatial-reference","Slide spatial reference (${slideSpatialReference.wkid}) is incompatible with the scene spatial reference (${sceneSpatialReference.wkid})",{slideSpatialReference:i,sceneSpatialReference:t,viewingMode:e.viewingMode}))}return Promise.resolve()}_validateHeightModelInfo(){const e=this._sceneSpatialReference,t=(0,Ti.vu)(this.heightModelInfo,e);return t?Promise.reject(t):Promise.resolve()}_validateFeatureLayerSymbolVisibility(){this.sourceVersion?.greaterEqual(1,35)||this.layers.forEach((e=>{"feature"===e.type&&e.addHandles((0,n.YP)((()=>e.loaded),(()=>{"on-the-ground"===e.elevationInfo?.mode&&"simple"===e.renderer?.type&&"polygon-3d"===e.renderer.symbol?.type&&e.renderer.symbol.symbolLayers.some((t=>"fill"===t.type&&null!=t.material&&(!t.material.color||t.material.color.a*e.opacity<XO.e)&&(e.loadWarnings.push(new UP.Z("feature-layer:invisible-draped-symbols","FeatureLayer has fully transparent symbols which will no longer render or highlight",{layer:e})),!0)))}),{once:!0,sync:!0}))}))}_validateJSON(e){const t=$O.parse(e.version||"","webscene");return KO.validate(t),e.version=`${t.major}.${t.minor}`,1===t.major&&t.minor<=2&&(e.spatialReference=N.Z.WebMercator.toJSON()),e}_updateTypeKeywords(e){(0,qP.IW)(e,qP.hz.LOCAL_SCENE,"local"===this.initialViewProperties.viewingMode),(0,qP.IW)(e,qP.hz.DEVELOPER_BASEMAP,(0,st.zb)(this.basemap)||this.presentation.slides.some((({basemap:e})=>!!e&&(0,st.zb)(e)))),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(((e,t,i)=>i.indexOf(e)===t)))}get _sceneSpatialReference(){return this.initialViewProperties.spatialReference||N.Z.WebMercator}get _verifyItemRelativeRootPath(){return this.portalItem?.itemUrl?(0,X_.mN)(this.portalItem.itemUrl).path:null}_enableVerifyItemRelativeUrls(e){const t=this._verifyItemRelativeRootPath;return t&&(e.verifyItemRelativeUrls={rootPath:t,writtenUrls:[]}),e}_unscheduleLayersIdGC(){this._layersIdGCTimeoutId&&(clearTimeout(this._layersIdGCTimeoutId),this._layersIdGCTimeoutId=0)}_scheduleLayersIdGC(){this._unscheduleLayersIdGC(),this._layersIdGCTimeoutId=setTimeout((()=>{this._layersIdGCTimeoutId=0,this._runLayersIdGC()}),3e3)}_runLayersIdGC(){this._unscheduleLayersIdGC();const e=this.applicationProperties?.viewing?.search,t=e=>this.allLayers.some((t=>t.id===e&&t.persistenceEnabled));e?.layers&&(e.layers=e.layers.filter((e=>t(e.id))));const i=this.presentation&&this.presentation.slides;i&&i.forEach((e=>{e.visibleLayers&&(e.visibleLayers=e.visibleLayers.filter((e=>t(e.id))))}))}static fromJSON(e){if(!e)throw new u.Z("webscene:empty-resource","Expected a JSON resource but got nothing");return new this({resourceInfo:e})}static{this.version=`${KO.major}.${KO.minor}`}};(0,o._)([(0,x.Cb)({type:WA,json:{write:!0}})],eD.prototype,"applicationProperties",void 0),(0,o._)([(0,x.Cb)({type:I.Z,json:{read:{source:"clippingArea.geometry",reader:kP.im},write:{target:"clippingArea.geometry"}}})],eD.prototype,"clippingArea",void 0),(0,o._)([(0,Ae.c)("clippingArea")],eD.prototype,"writeClippingArea",null),(0,o._)([(0,x.Cb)({type:Boolean,json:{write:{target:"clippingArea.clip"}}})],eD.prototype,"clippingEnabled",void 0),(0,o._)([(0,qe.r)("clippingEnabled",["clippingArea"])],eD.prototype,"readClippingEnabled",null),(0,o._)([(0,Ae.c)("clippingEnabled")],eD.prototype,"writeClippingEnabled",null),(0,o._)([(0,x.Cb)({type:KP,json:{read:{source:"mapFloorInfo"},write:{target:"mapFloorInfo"}}})],eD.prototype,"floorInfo",void 0),(0,o._)([(0,x.Cb)({type:L.Z,json:{write:!0}})],eD.prototype,"heightModelInfo",void 0),(0,o._)([(0,x.Cb)({json:{write:{target:"operationalLayers",ignoreOrigin:!0}}})],eD.prototype,"layers",void 0),(0,o._)([(0,Ae.c)("layers")],eD.prototype,"writeLayers",null),(0,o._)([(0,x.Cb)({readOnly:!0,type:$O,json:{type:(()=>{const e=[],t=KO.major;for(let i=8;i<=KO.minor;i++)e.push(`${t}.${i}`);return e})(),write:{ignoreOrigin:!0,target:"version",isRequired:!0,overridePolicy:()=>({enabled:!0,allowNull:!0,ignoreOrigin:!0})}}})],eD.prototype,"sourceVersion",void 0),(0,o._)([(0,qe.r)("sourceVersion",["version"])],eD.prototype,"readSourceVersion",null),(0,o._)([(0,Ae.c)("sourceVersion")],eD.prototype,"writeSourceVersion",null),(0,o._)([(0,x.Cb)({json:{read:!1,write:{enabled:!0,ignoreOrigin:!0}}})],eD.prototype,"tables",void 0),(0,o._)([(0,Ae.c)("tables")],eD.prototype,"writeTables",null),(0,o._)([(0,x.Cb)()],eD.prototype,"thumbnailUrl",null),(0,o._)([(0,x.Cb)({type:String,json:{write:{writerEnsuresNonNull:!0,ignoreOrigin:!0}}})],eD.prototype,"authoringApp",null),(0,o._)([(0,Ae.c)("authoringApp")],eD.prototype,"writeAuthoringApp",null),(0,o._)([(0,x.Cb)({type:String,json:{write:{writerEnsuresNonNull:!0,ignoreOrigin:!0}}})],eD.prototype,"authoringAppVersion",null),(0,o._)([(0,Ae.c)("authoringAppVersion")],eD.prototype,"writeAuthoringAppVersion",null),(0,o._)([(0,x.Cb)({json:{write:{isRequired:!0,allowNull:!0,ignoreOrigin:!0,enabled:!0}}})],eD.prototype,"ground",void 0),(0,o._)([(0,Ae.c)("ground")],eD.prototype,"writeGround",null),(0,o._)([(0,x.Cb)({type:c.Z.ofType(jO),json:{write:!0}})],eD.prototype,"transportationNetworks",void 0),(0,o._)([(0,x.Cb)({type:GO,nonNullable:!0,json:{write:{ignoreOrigin:!0,writer:(e,t,i,r)=>{if(e.slides&&e.slides.length>0){const i={...r,isPresentation:!0};t.presentation=e.write({},i)}}}}})],eD.prototype,"presentation",void 0),(0,o._)([(0,x.Cb)({type:iO,nonNullable:!0,json:{write:{target:"initialState",isRequired:!0,ignoreOrigin:!0},default:()=>new iO({viewingMode:"global",spatialReference:N.Z.WebMercator})}})],eD.prototype,"initialViewProperties",void 0),(0,o._)([(0,qe.r)("initialViewProperties",["initialState","spatialReference","viewingMode"])],eD.prototype,"readInitialViewProperties",null),(0,o._)([(0,x.Cb)({type:N.Z,json:{read:!1,write:{isRequired:!0,ignoreOrigin:!0}}})],eD.prototype,"spatialReference",null),(0,o._)([(0,x.Cb)({type:["local","global"],json:{read:!1,write:{isRequired:!0,ignoreOrigin:!0}}})],eD.prototype,"viewingMode",null),(0,o._)([(0,x.Cb)({type:zP.default})],eD.prototype,"portalItem",void 0),(0,o._)([(0,x.Cb)()],eD.prototype,"resourceInfo",void 0),(0,o._)([(0,x.Cb)({type:fA,json:{write:!0}})],eD.prototype,"widgets",void 0),eD=(0,o._)([(0,S.j)("esri.WebScene")],eD);const tD=eD;var iD=i(54503),rD=i(46789),sD=i(52043);const nD=i(49006).iv`@layer{arcgis-scene{display:block;height:100%;.esri-view{height:100%;width:100%}}}`,aD=(0,rD.Tj)(tD,{}),oD=(0,rD.Tj)(LP,{});class lD extends iD.oi{constructor(){super(),this._cameraProperties={},this._map=aD(this),this.view=oD(this),this.allLayerViews=this.view.allLayerViews,this.alphaCompositingEnabled=this.view.alphaCompositingEnabled,this.analyses=this.view.analyses,this.autoDestroyDisabled=!1,this.basemap=this._map.basemap,this.basemapView=this.view.basemapView,this.clippingArea=this.view.clippingArea,this.constraints=this.view.constraints,this.displayFilterDisabled=this.view.displayFilterEnabled,this.environment=this.view.environment,this.fatalError=this.view.fatalError,this.floors=this.view.floors,this.graphics=this.view.graphics,this.ground=this._map.ground,this.groundView=this.view.groundView,this.highlights=this.view.highlights,this.highlightOptions=this.view.highlightOptions,this.layerViews=this.view.layerViews,this.magnifier=this.view.magnifier,this.map=this.view.map,this.navigation=this.view.navigation,this.padding=this.view.padding,this.popup=this.view.popup,this.popupDisabled=this.view.popupEnabled,this.qualityProfile=this.view.qualityProfile,this.ready=this.view.ready,this.spatialReference=this.view.spatialReference,this.suspended=this.view.suspended,this.theme=this.view.theme,this.timeExtent=this.view.timeExtent,this.updating=this.view.updating,this.viewingMode=this.view.viewingMode,this.visibleArea=this.view.visibleArea,this.arcgisViewChange=(0,iD.yM)(),this.arcgisViewClick=(0,rD.Wk)((()=>this.view),"click"),this.arcgisViewDoubleClick=(0,rD.Wk)((()=>this.view),"double-click"),this.arcgisViewDrag=(0,rD.Wk)((()=>this.view),"drag"),this.arcgisViewHold=(0,rD.Wk)((()=>this.view),"hold"),this.arcgisViewImmediateClick=(0,rD.Wk)((()=>this.view),"immediate-click"),this.arcgisViewImmediateDoubleClick=(0,rD.Wk)((()=>this.view),"immediate-double-click"),this.arcgisViewKeyDown=(0,rD.Wk)((()=>this.view),"key-down"),this.arcgisViewKeyUp=(0,rD.Wk)((()=>this.view),"key-up"),this.arcgisViewLayerviewCreate=(0,rD.Wk)((()=>this.view),"layerview-create"),this.arcgisViewLayerviewCreateError=(0,rD.Wk)((()=>this.view),"layerview-create-error"),this.arcgisViewLayerviewDestroy=(0,rD.Wk)((()=>this.view),"layerview-destroy"),this.arcgisViewAnalysisViewCreate=(0,rD.Wk)((()=>this.view),"analysis-view-create"),this.arcgisViewAnalysisViewCreateError=(0,rD.Wk)((()=>this.view),"analysis-view-create-error"),this.arcgisViewAnalysisViewDestroy=(0,rD.Wk)((()=>this.view),"analysis-view-destroy"),this.arcgisViewMouseWheel=(0,rD.Wk)((()=>this.view),"mouse-wheel"),this.arcgisViewPointerDown=(0,rD.Wk)((()=>this.view),"pointer-down"),this.arcgisViewPointerEnter=(0,rD.Wk)((()=>this.view),"pointer-enter"),this.arcgisViewPointerLeave=(0,rD.Wk)((()=>this.view),"pointer-leave"),this.arcgisViewPointerMove=(0,rD.Wk)((()=>this.view),"pointer-move"),this.arcgisViewPointerUp=(0,rD.Wk)((()=>this.view),"pointer-up"),this.arcgisViewReadyChange=(0,iD.yM)(),this.view.ui={components:["attribution"]}}static{this.properties={_map:16,view:32,allLayerViews:0,alphaCompositingEnabled:5,analyses:0,autoDestroyDisabled:5,basemap:1,basemapView:0,camera:0,cameraFov:9,cameraHeading:9,cameraPosition:1,cameraTilt:9,center:1,clippingArea:0,constraints:0,displayFilterDisabled:5,environment:0,extent:0,fatalError:0,floors:0,focusAreas:0,gamepad:32,graphics:0,ground:1,groundView:0,highlights:0,highlightOptions:0,interacting:32,itemId:3,layerViews:0,magnifier:0,map:0,navigating:32,navigation:0,padding:0,performanceInfo:32,popup:0,popupDisabled:5,qualityProfile:1,ready:4,resolution:32,scale:9,spatialReference:0,stationary:32,suspended:7,theme:0,timeExtent:0,updating:4,viewingMode:1,viewpoint:0,visibleArea:0,zoom:9}}static{this.shadowRootOptions=iD.hZ}static{this.styles=nD}get camera(){return this.view.camera}set camera(e){(0,sD.b)(this.camera,e)||(this.view.camera=e)}get cameraFov(){const{view:e}=this;return e.ready?this.view.camera?.fov:this._cameraProperties.fov}set cameraFov(e){null!=e&&this._mutateCamera((t=>{t.fov=e}))}get cameraHeading(){const{view:e}=this;return e.ready?e.camera?.heading:this._cameraProperties.heading}set cameraHeading(e){null!=e&&this._mutateCamera((t=>{t.heading=e}))}get cameraPosition(){const{view:e}=this;if(e.ready)return e.camera?.position;const{position:t}=this._cameraProperties;return t?new a.Z(t):void 0}set cameraPosition(e){const t=(0,sD.p)(this.view.camera?.position,e);t&&this._mutateCamera((e=>{e.position=t}))}get cameraTilt(){const{view:e}=this;return e.ready?e.camera?.tilt:this._cameraProperties.tilt}set cameraTilt(e){null!=e&&this._mutateCamera((t=>{t.tilt=e}))}get center(){return this.view.center}set center(e){const t=(0,sD.c)(e,this.view);t&&(this.view.center=t)}get extent(){return this.view.extent}set extent(e){e&&!this.extent.equals(e)&&(this.view.extent=e)}get focusAreas(){return this.map?this.map?.focusAreas:{areas:[],style:"bright"}}set focusAreas(e){this.map&&(this.map.focusAreas=e)}get gamepad(){return this.view.input.gamepad}get interacting(){return this.view.interacting}get itemId(){return this._map.portalItem?.id}set itemId(e){(0,rD.bf)(this._map,this),this._map.portalItem={id:e},this.view.map=this._map}get navigating(){return this.view.navigating}get performanceInfo(){return this.view.performanceInfo}get resolution(){return this.view.resolution}get scale(){return this.view.scale}set scale(e){this.view.scale=e}get stationary(){return this.view.stationary}get viewpoint(){return this.view.viewpoint}set viewpoint(e){(0,sD.i)(this.viewpoint,e)&&(this.view.viewpoint=e)}get zoom(){return this.view.zoom}set zoom(e){this.view.zoom=e}async addLayer(e,t){this.map?.add(e,t)}async addLayers(e,t){this.map?.addMany(e,t)}async addTable(e){this.map?.tables.add(e)}async addTables(e,t){this.map?.tables.addMany(e,t)}async closePopup(){this.view.closePopup()}async destroy(){await this.manager.destroy()}async goTo(e,t){return await this.view.goTo(e,t)}async hitTest(e,t){return await this.view.hitTest(e,t)}async openPopup(e){await this.view.openPopup(e)}async takeScreenshot(e){return await this.view.takeScreenshot(e)}toMap(e,t){return this.view.toMap(e,t)}toScreen(e){return this.view.toScreen(e)}async tryFatalErrorRecovery(){this.view.tryFatalErrorRecovery()}async viewOnReady(e,t){return await this.componentOnReady(),await this.view.whenReady().then((()=>e?.())).catch(t)}async whenAnalysisView(e){return await this.view.whenAnalysisView(e)}async whenLayerView(e){return await this.view.whenLayerView(e)}load(){const e=this;e.el.childElem=document.createElement("div"),e.el.append(e.el.childElem),this.view.container=e.el.childElem}loaded(){this.map||=this._map,this.manager.onLifecycle((()=>[(0,n.YP)((()=>this.map),(e=>{e&&(this._map=e)}),{initial:!0,sync:!0}),(0,n.YP)((()=>this.view.stationary),(()=>this.arcgisViewChange.emit()),{initial:!0}),(0,n.YP)((()=>this.view.ready),(e=>{e&&(this.camera=this.view.camera.clone().set(this._cameraProperties),this._cameraProperties={}),this.arcgisViewReadyChange.emit()}),{initial:this.view.ready})]))}_mutateCamera(e){if(!this.view.ready)return void e(this._cameraProperties);const t=this.view.camera?.clone()??new s.Z;e(t),this.camera=t}}(0,r.c)("arcgis-scene",lD)},8131:function(e,t,i){var r=i(95598),s=i(33598),n=(0,r.Z)((function(e){for(var t=(0,s.Z)(e),i=t.length,r=[],n=0;n<i;)r[n]=e[t[n]],n+=1;return r}));t.Z=n}}]);