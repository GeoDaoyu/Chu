"use strict";(self.webpackChunkscene_pro=self.webpackChunkscene_pro||[]).push([[50624],{34042:function(e,t,r){r.d(t,{it:function(){return V},aX:function(){return S},hR:function(){return w}});var i=r(81001),n=r(88194),s=r(96711),o=r(67764),a=r(62197),l=r(76264),u=r(8554),p=r(97290),c=r(78619),h=r(90756),f=r(56545);var y=r(95490),d=r(93333);const g=()=>s.Z.getLogger("esri.geometry.support.normalizeUtils");function m(e){return"polygon"===e[0].type}function b(e){return"polyline"===e[0].type}function w(e,t){if(!(e instanceof a.Z||e instanceof o.Z)){const e="straightLineDensify: the input geometry is neither polyline nor polygon";throw g().error(e),new n.Z("internal:geometry",e)}const r=(0,l.x3)(e),i=[];for(const e of r){const r=[];i.push(r),r.push([e[0][0],e[0][1]]);for(let i=0;i<e.length-1;i++){const n=e[i][0],s=e[i][1],o=e[i+1][0],a=e[i+1][1],l=Math.sqrt((o-n)*(o-n)+(a-s)*(a-s)),u=(a-s)/l,p=(o-n)/l,c=l/t;if(c>1){for(let e=1;e<=c-1;e++){const i=e*t,o=p*i+n,a=u*i+s;r.push([o,a])}const e=(l+Math.floor(c-1)*t)/2,i=p*e+n,o=u*e+s;r.push([i,o])}r.push([o,a])}}return function(e){return"polygon"===e.type}(e)?new o.Z({rings:i,spatialReference:e.spatialReference}):new a.Z({paths:i,spatialReference:e.spatialReference})}function v(e,t,r){if(t){const t=w(e,1e6);e=(0,p.Sx)(t,!0)}return r&&(e=(0,l.Sy)(e,r)),e}function _(e,t,r){if(Array.isArray(e)){const i=e[0];if(i>t){const r=(0,l.XZ)(i,t);e[0]=i+r*(-2*t)}else if(i<r){const t=(0,l.XZ)(i,r);e[0]=i+t*(-2*r)}}else{const i=e.x;if(i>t){const r=(0,l.XZ)(i,t);e=e.clone().offset(r*(-2*t),0)}else if(i<r){const t=(0,l.XZ)(i,r);e=e.clone().offset(t*(-2*r),0)}}return e}function x(e,t){let r=-1;for(let i=0;i<t.cutIndexes.length;i++){const n=t.cutIndexes[i],s=t.geometries[i],o=(0,l.x3)(s);for(let e=0;e<o.length;e++){const t=o[e];t.some((r=>{if(r[0]<180)return!0;{let r=0;for(let e=0;e<t.length;e++){const i=t[e][0];r=i>r?i:r}r=Number(r.toFixed(9));const i=-360*(0,l.XZ)(r,180);for(let r=0;r<t.length;r++){const t=s.getPoint(e,r);s.setPoint(e,r,t.clone().offset(i,0))}return!0}}))}if(n===r){if(m(e))for(const t of(0,l.x3)(s))e[n]=e[n].addRing(t);else if(b(e))for(const t of(0,l.x3)(s))e[n]=e[n].addPath(t)}else r=n,e[n]=s}return e}async function S(e,t,r){if(!Array.isArray(e))return S([e],t);t&&"string"!=typeof t&&g().warn("normalizeCentralMeridian()","The url object is deprecated, use the url string instead");const n="string"==typeof t?t:t?.url??i.default.geometryServiceUrl;let s,m,b,w,V,I,C,Z,F=0;const P=[],R=[];for(const t of e)if(null!=t)if(s||(s=t.spatialReference,m=(0,u.C5)(s),b=s.isWebMercator,I=b?102100:4326,w=l.UZ[I].maxX,V=l.UZ[I].minX,C=l.UZ[I].plus180Line,Z=l.UZ[I].minus180Line),m)if("mesh"===t.type)R.push(t);else if("point"===t.type)R.push(_(t.clone(),w,V));else if("multipoint"===t.type){const e=t.clone();e.points=e.points.map((e=>_(e,w,V))),R.push(e)}else if("extent"===t.type){const e=t.clone()._normalize(!1,!1,m);R.push(e.rings?new o.Z(e):e)}else if(t.extent){const e=t.extent,r=(0,l.XZ)(e.xmin,V)*(2*w);let i=0===r?t.clone():(0,l.Sy)(t.clone(),r);e.offset(r,0);let{xmin:n,xmax:s}=e;n=Number(n.toFixed(9)),s=Number(s.toFixed(9)),e.intersects(C)&&s!==w?(F=s>F?s:F,i=v(i,b),P.push(i),R.push("cut")):e.intersects(Z)&&n!==V?(F=s*(2*w)>F?s*(2*w):F,i=v(i,b,360),P.push(i),R.push("cut")):R.push(i)}else R.push(t.clone());else R.push(t);else R.push(t);let M=(0,l.XZ)(F,w),O=-90;const E=M,H=new a.Z;for(;M>0;){const e=360*M-180;H.addPath([[e,O],[e,-1*O]]),O*=-1,M--}if(P.length>0&&E>0){const t=x(P,await async function(e,t,r,i){const n=(0,f.en)(e),s=t[0].spatialReference,o={...i,responseType:"json",query:{...n.query,f:"json",sr:(0,u.B9)(s),target:JSON.stringify({geometryType:(0,h.Ji)(t[0]),geometries:t}),cutter:JSON.stringify(r)}},a=await(0,c.Z)(n.path+"/cut",o),{cutIndexes:l,geometries:p=[]}=a.data;return{cutIndexes:l,geometries:p.map((e=>{const t=(0,h.im)(e);return t.spatialReference=s,t}))}}(n,P,H,r)),i=[],s=[];for(let r=0;r<R.length;r++){const n=R[r];if("cut"!==n)s.push(n);else{const n=t.shift(),o=e[r];null!=o&&"polygon"===o.type&&o.rings&&o.rings.length>1&&n.rings.length>=o.rings.length?(i.push(n),s.push("simplify")):s.push(b?(0,p.$)(n):n)}}if(!i.length)return s;const o=await async function(e,t,r){const i="string"==typeof e?(0,y.mN)(e):e,n=t[0].spatialReference,s=(0,h.Ji)(t[0]),o={...r,query:{...i.query,f:"json",sr:(0,u.B9)(n),geometries:JSON.stringify((0,d.F)(t))}},{data:a}=await(0,c.Z)(i.path+"/simplify",o);return(0,d.o)(a.geometries,s,n)}(n,i,r),a=[];for(let e=0;e<s.length;e++){const t=s[e];"simplify"!==t?a.push(t):a.push(b?(0,p.$)(o.shift()):o.shift())}return a}const G=[];for(let e=0;e<R.length;e++){const t=R[e];if("cut"!==t)G.push(t);else{const e=P.shift();G.push(!0===b?(0,p.$)(e):e)}}return G}function V(e,t,r){const i=(0,u.C5)(r);if(null==i)return e;const[n,s]=i.valid,o=2*s;let a=0,l=0;t>s?a=Math.ceil(Math.abs(t-s)/o):t<n&&(a=-Math.ceil(Math.abs(t-n)/o)),e>s?l=Math.ceil(Math.abs(e-s)/o):e<n&&(l=-Math.ceil(Math.abs(e-n)/o));let p=e+(a-l)*o;const c=p-t;return c>s?p-=o:c<n&&(p+=o),p}},76264:function(e,t,r){r.d(t,{Sy:function(){return l},UZ:function(){return o},XZ:function(){return a},x3:function(){return u}});var i=r(62197),n=r(45213),s=r(90756);const o={102100:{maxX:20037508.342788905,minX:-20037508.342788905,plus180Line:new i.Z({paths:[[[20037508.342788905,-20037508.342788905],[20037508.342788905,20037508.342788905]]],spatialReference:n.Z.WebMercator}),minus180Line:new i.Z({paths:[[[-20037508.342788905,-20037508.342788905],[-20037508.342788905,20037508.342788905]]],spatialReference:n.Z.WebMercator})},4326:{maxX:180,minX:-180,plus180Line:new i.Z({paths:[[[180,-180],[180,180]]],spatialReference:n.Z.WGS84}),minus180Line:new i.Z({paths:[[[-180,-180],[-180,180]]],spatialReference:n.Z.WGS84})}};function a(e,t){return Math.ceil((e-t)/(2*t))}function l(e,t){const r=u(e);for(const e of r)for(const r of e)r[0]+=t;return e}function u(e){return(0,s.oU)(e)?e.rings:e.paths}},44695:function(e,t,r){function i(e){const t=e.layer;return"floorInfo"in t&&t.floorInfo?.floorField&&"floors"in e.view?s(e.view.floors,t.floorInfo.floorField):null}function n(e,t){return"floorInfo"in t&&t.floorInfo?.floorField?s(e,t.floorInfo.floorField):null}function s(e,t){if(!e?.length)return null;const r=e.filter((e=>""!==e)).map((e=>`'${e}'`));return r.push("''"),`${t} IN (${r.join(",")}) OR ${t} IS NULL`}r.d(t,{c:function(){return i},f:function(){return n}})},33285:function(e,t,r){r.d(t,{FN:function(){return s},QV:function(){return n},ac:function(){return a}});var i=r(66951);function n(e,t,r){const i=t.flatten((({sublayers:e})=>e)).length;return i!==e.length||(!!e.some((e=>e.originIdOf("minScale")>r||e.originIdOf("maxScale")>r||e.originIdOf("renderer")>r||e.originIdOf("labelingInfo")>r||e.originIdOf("opacity")>r||e.originIdOf("labelsVisible")>r||e.originIdOf("source")>r))||!o(e,t))}function s(e,t,r){return!!e.some((e=>{const t=e.source,n=!t||"map-layer"===t.type&&t.mapLayerId===e.id&&(null==t.gdbVersion||t.gdbVersion===r);e.commitProperty("renderer"),e.commitProperty("labelingInfo"),e.commitProperty("opacity"),e.commitProperty("labelsVisible"),e.commitProperty("orderBy");const s=e.layer?.capabilities?.exportMap?.supportsSublayerOrderBy??!1;return!n||e.originIdOf("renderer")>i.s3.SERVICE||e.originIdOf("labelingInfo")>i.s3.SERVICE||e.originIdOf("opacity")>i.s3.SERVICE||e.originIdOf("labelsVisible")>i.s3.SERVICE||s&&e.originIdOf("orderBy")>i.s3.SERVICE}))||!o(e,t)}function o(e,t){if(!e?.length||null==t)return!0;const r=t.slice().reverse().flatten((({sublayers:e})=>e&&e.toArray().reverse())).map((e=>e.id)).toArray();if(e.length>r.length)return!1;let i=0;const n=r.length;for(const{id:t}of e){for(;i<n&&r[i]!==t;)i++;if(i>=n)return!1}return!0}function a(e){return!!e&&e.some((e=>null!=e.minScale||null!=e.layerDefinition?.minScale))}},71730:function(e,t,r){function i(e,t){return t?"xoffset"in t&&t.xoffset?Math.max(e,Math.abs(t.xoffset)):"yoffset"in t&&t.yoffset?Math.max(e,Math.abs(t.yoffset||0)):e:e}function n(e,t){return"number"==typeof e?e:e?.stops?.length?function(e){let t=0,r=0;for(let i=0;i<e.length;i++){const n=e[i].size;"number"==typeof n&&(t+=n,r++)}return t/r}(e.stops):t}function s(e,t){if(!t)return e;const r=t.filter((e=>"size"===e.type)).map((t=>{const{maxSize:r,minSize:i}=t;return(n(r,e)+n(i,e))/2}));let i=0;const s=r.length;if(0===s)return e;for(let e=0;e<s;e++)i+=r[e];const o=Math.floor(i/s);return Math.max(o,e)}function o(e){const t=e?.renderer,r=e?.pointerType,n="touch"===r?9:6;if(!t)return n;const o="visualVariables"in t?s(n,t.visualVariables):n;if("simple"===t.type)return i(o,t.symbol);if("unique-value"===t.type){let e=o;return t.uniqueValueInfos?.forEach((t=>{e=i(e,t.symbol)})),e}if("class-breaks"===t.type){let e=o;return t.classBreakInfos.forEach((t=>{e=i(e,t.symbol)})),e}return"dot-density"===t.type||t.type,o}r.d(t,{k:function(){return o}})},85825:function(e,t,r){r.d(t,{M:function(){return b}});var i=r(73440),n=r(53147),s=r(70880),o=r(3480),a=r(50702),l=r(90403),u=r(17155),p=(r(61432),r(96711),r(48023)),c=r(13132),h=r(53866),f=r(89636),y=r(38096),d=r(19886),g=r(43254),m=r(43462);let b=class extends s.Z{get updating(){return this.graphicsView?.updating??!1}constructor(e){super(e),this._highlightCounts=new Map,this._graphicsViewLoader=null,this.graphics=new h.J,this.graphicsView=null,this.suspended=!1;const t=new n.Z([255,255,255,1/255]);this._symbols=new Map([["point",new d.Z({size:"2px",style:"square",color:t})],["polyline",new y.Z({width:"2px",color:t})],["polygon",new f.Z({outline:null,color:t})]])}highlight(e,t){const r=function(e){if(!e)return[];let t=(0,m.Kf)(e)?[e]:g.Z.isCollection(e)?e.toArray():Array.isArray(e)?e:[];return t=t?.filter(o.pC),0===(t?.length??0)?[]:t}(e);if(0===r.length)return(0,a.kB)();let i,n=!1;return this.updatingHandles.addPromise(Promise.all([this._createHighlightGraphics(r),this._ensureGraphicsView3D()]).then((([e,r])=>{!n&&r&&(i=this._addHighlightGraphics(r,e,t))}))),(0,a.kB)((()=>{n=!0,i?.remove()}))}preload(){this._ensureGraphicsView3D()}_addHighlightGraphics(e,t,r){for(const e of t)this._highlightCounts.set(e,(this._highlightCounts.get(e)??0)+1);this.graphics.addMany(t);const i=e.highlight(t,r);return(0,a.kB)((()=>{this._removeHighlightGraphics(t),i.remove()}))}_removeHighlightGraphics(e){this.graphics.removeMany(e.filter((e=>{const t=Math.max(0,(this._highlightCounts.get(e)??0)-1);return 0===t?(this._highlightCounts.delete(e),!0):(this._highlightCounts.set(e,t),!1)})))}async _ensureGraphicsView3D(){if(this.graphicsView)return this.graphicsView;this._graphicsViewLoader||(this._graphicsViewLoader=Promise.all([r.e(55105),r.e(88534),r.e(92284)]).then(r.bind(r,17617)));const{default:e}=await this._graphicsViewLoader;if(this.destroyed)return null;const t=new e({view:this.view,layer:this.layer,getGraphics:()=>this.graphics,drapeSourcePriorityOffset:.5});return this._set("graphicsView",t),this.addHandles([(0,a.ed)(this.graphicsView),(0,l.YP)((()=>this.suspended),(e=>{t.suspended=e}),l.tX)]),t}async _createHighlightGraphics(e){const t=e.map((({geometry:e})=>e?.spatialReference)).filter(o.pC).reduce(((e,t)=>(0!==e.length&&e.at(-1)?.equals(t)||e.push(t),e)),[]),r=this.view.spatialReference,i=t.map((e=>({source:e,dest:r})));try{await(0,c.initializeProjection)(i)}catch{return[]}return e.map((e=>{const{geometry:t}=e;try{const i=t?(0,c.project)(t,r):null,n=e.cloneShallow();return n.geometry=i,n.symbol=this._symbols.get(i?.type),n}catch{return e}}))}};(0,i._)([(0,u.Cb)()],b.prototype,"graphics",void 0),(0,i._)([(0,u.Cb)()],b.prototype,"graphicsView",void 0),(0,i._)([(0,u.Cb)()],b.prototype,"view",void 0),(0,i._)([(0,u.Cb)()],b.prototype,"layer",void 0),(0,i._)([(0,u.Cb)()],b.prototype,"updatingHandles",void 0),(0,i._)([(0,u.Cb)()],b.prototype,"suspended",void 0),(0,i._)([(0,u.Cb)()],b.prototype,"updating",null),b=(0,i._)([(0,p.j)("esri.views.3d.layers.support.ImageHighlightHelper3D")],b)},50624:function(e,t,r){r.d(t,{c:function(){return h}});var i=r(73440),n=r(70880),s=r(50702),o=r(90403),a=r(17155),l=(r(61432),r(96711),r(83850),r(48023)),u=r(85825),p=r(92815),c=r(54318);let h=class extends n.Z{constructor(e){super(e)}initialize(){this._highlightHelper=new u.M({layer:this.layerView.layer,view:this.view,updatingHandles:this.updatingHandles}),this._mapServiceLayerViewHelper=new p.VF({createFetchPopupFeaturesQueryGeometry:(e,t)=>(0,c.K)(e,t,this.view),layerView:this.layerView,updatingHandles:this.updatingHandles,highlightGraphics:this._highlightHelper.graphics,highlightGraphicUpdated:e=>this._highlightHelper.graphicsView?.graphicChanged(e)}),this.addHandles([(0,s.ed)(this._mapServiceLayerViewHelper),(0,o.gx)((()=>this.view?.stationary),(()=>this._mapServiceLayerViewHelper.updateHighlightedFeatures(this.view.resolution)),o.nn),(0,o.YP)((()=>this.layerView.suspended),(e=>this._highlightHelper.suspended=e),o.tX)])}fetchPopupFeaturesAtLocation(e,t){return this._highlightHelper.preload(),this._mapServiceLayerViewHelper.fetchPopupFeaturesAtLocation(e,t)}highlight(e,t){return this._highlightHelper.highlight(e,t)}};(0,i._)([(0,a.Cb)()],h.prototype,"view",void 0),(0,i._)([(0,a.Cb)()],h.prototype,"layerView",void 0),(0,i._)([(0,a.Cb)()],h.prototype,"updatingHandles",void 0),h=(0,i._)([(0,l.j)("esri.views.3d.layers.support.SublayerPopupHighlightHelper3D")],h)},92815:function(e,t,r){r.d(t,{VF:function(){return Q},Uf:function(){return D}});var i=r(73440),n=r(53147),s=r(70880),o=r(3480),a=r(88194),l=r(61432),u=r(79577),p=r(93568),c=r(90403),h=r(48797),f=r(26636),y=r(17155),d=(r(96711),r(48023)),g=r(71354),m=r(4469),b=r(76554),w=r(44695),v=r(71730),_=r(78619),x=r(34042),S=r(56545),V=r(90756),I=r(8554),C=r(33285);function Z(e,t){const{dpi:r,gdbVersion:i,geometry:n,geometryPrecision:s,height:o,historicMoment:a,layerOption:l,mapExtent:u,maxAllowableOffset:p,returnFieldName:c,returnGeometry:h,returnUnformattedValues:f,returnZ:y,spatialReference:d,timeExtent:g,tolerance:m,width:b}=e.toJSON(),{dynamicLayers:w,layerDefs:v,layerIds:_}=F(e),x={historicMoment:a,geometryPrecision:s,maxAllowableOffset:p,returnFieldName:c,returnGeometry:h,returnUnformattedValues:f,returnZ:y,tolerance:m},S=(null!=t?.geometry?t.geometry:null)?.toJSON()||n;x.imageDisplay=`${b},${o},${r}`,i&&(x.gdbVersion=i),S&&(delete S.spatialReference,x.geometry=JSON.stringify(S),x.geometryType=(0,V.Ji)(S));const C=d??S?.spatialReference??u?.spatialReference;if(C&&(x.sr=(0,I.B9)(C)),x.time=g?[g.start,g.end].join(","):null,u){const{xmin:e,ymin:t,xmax:r,ymax:i}=u;x.mapExtent=`${e},${t},${r},${i}`}return v&&(x.layerDefs=v),w&&!v&&(x.dynamicLayers=w),x.layers="popup"===l?"visible":l,_&&!w&&(x.layers+=`:${_.join(",")}`),x}function F(e){const{mapExtent:t,floors:r,width:i,sublayers:n,layerIds:s,layerOption:o,gdbVersion:a}=e,l=n?.find((e=>null!=e.layer))?.layer?.serviceSublayers,u="popup"===o,p={},c=(0,m.yZ)({extent:t,width:i,spatialReference:t?.spatialReference}),f=[],y=e=>{const t=0===c,r=0===e.minScale||c<=e.minScale,i=0===e.maxScale||c>=e.maxScale;if(e.visible&&(t||r&&i))if(e.sublayers)e.sublayers.forEach(y);else{if(!1===s?.includes(e.id)||u&&(!e.popupTemplate||!e.popupEnabled))return;f.unshift(e)}};if(n?.forEach(y),n&&!f.length)p.layerIds=[];else{const e=(0,C.FN)(f,l,a),t=f.map((e=>{const t=(0,w.f)(r,e);return e.toExportImageJSON(t)}));if(e)p.dynamicLayers=JSON.stringify(t);else{if(n){let e=f.map((({id:e})=>e));s&&(e=e.filter((e=>s.includes(e)))),p.layerIds=e}else s?.length&&(p.layerIds=s);const e=function(e,t){const r=!!e?.length,i=t.filter((e=>null!=e.definitionExpression||r&&null!=e.floorInfo));return i.length?i.map((t=>{const r=(0,w.f)(e,t),i=(0,h._$)(r,t.definitionExpression);return{id:t.id,definitionExpression:i??void 0}})):null}(r,f);if(null!=e&&e.length){const t={};for(const r of e)r.definitionExpression&&(t[r.id]=r.definitionExpression);Object.keys(t).length&&(p.layerDefs=JSON.stringify(t))}}}return p}var P,R=r(43254),M=r(63255),O=r(95226),E=(r(83850),r(29884)),H=r(45213),G=r(98842),j=r(85913);let N=P=class extends M.Z{static from(e){return(0,O.TJ)(P,e)}constructor(e){super(e),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.historicMoment=null,this.layerIds=null,this.layerOption="top",this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.sublayers=null,this.timeExtent=null,this.tolerance=null,this.width=400}writeHistoricMoment(e,t){t.historicMoment=e&&e.getTime()}};(0,i._)([(0,y.Cb)({type:Number,json:{write:!0}})],N.prototype,"dpi",void 0),(0,i._)([(0,y.Cb)()],N.prototype,"floors",void 0),(0,i._)([(0,y.Cb)({type:String,json:{write:!0}})],N.prototype,"gdbVersion",void 0),(0,i._)([(0,y.Cb)({types:G.qM,json:{read:V.im,write:!0}})],N.prototype,"geometry",void 0),(0,i._)([(0,y.Cb)({type:Number,json:{write:!0}})],N.prototype,"geometryPrecision",void 0),(0,i._)([(0,y.Cb)({type:Number,json:{write:!0}})],N.prototype,"height",void 0),(0,i._)([(0,y.Cb)({type:Date})],N.prototype,"historicMoment",void 0),(0,i._)([(0,E.c)("historicMoment")],N.prototype,"writeHistoricMoment",null),(0,i._)([(0,y.Cb)({type:[Number],json:{write:!0}})],N.prototype,"layerIds",void 0),(0,i._)([(0,y.Cb)({type:["top","visible","all","popup"],json:{write:!0}})],N.prototype,"layerOption",void 0),(0,i._)([(0,y.Cb)({type:g.Z,json:{write:!0}})],N.prototype,"mapExtent",void 0),(0,i._)([(0,y.Cb)({type:Number,json:{write:!0}})],N.prototype,"maxAllowableOffset",void 0),(0,i._)([(0,y.Cb)({type:Boolean,json:{write:!0}})],N.prototype,"returnFieldName",void 0),(0,i._)([(0,y.Cb)({type:Boolean,json:{write:!0}})],N.prototype,"returnGeometry",void 0),(0,i._)([(0,y.Cb)({type:Boolean,json:{write:!0}})],N.prototype,"returnM",void 0),(0,i._)([(0,y.Cb)({type:Boolean,json:{write:!0}})],N.prototype,"returnUnformattedValues",void 0),(0,i._)([(0,y.Cb)({type:Boolean,json:{write:!0}})],N.prototype,"returnZ",void 0),(0,i._)([(0,y.Cb)({type:H.Z,json:{write:!0}})],N.prototype,"spatialReference",void 0),(0,i._)([(0,y.Cb)({type:R.Z})],N.prototype,"sublayers",void 0),(0,i._)([(0,y.Cb)({type:j.T,json:{write:!0}})],N.prototype,"timeExtent",void 0),(0,i._)([(0,y.Cb)({type:Number,json:{write:!0}})],N.prototype,"tolerance",void 0),(0,i._)([(0,y.Cb)({type:Number,json:{write:!0}})],N.prototype,"width",void 0),N=P=(0,i._)([(0,d.j)("esri.rest.support.IdentifyParameters")],N);const L=N;var T=r(46451),A=r(1194);let U=class extends M.Z{constructor(e){super(e),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null}readFeature(e,t){return T.Z.fromJSON({attributes:{...t.attributes},geometry:{...t.geometry}})}writeFeature(e,t){if(!e)return;const{attributes:r,geometry:i}=e;r&&(t.attributes={...r}),null!=i&&(t.geometry=i.toJSON(),t.geometryType=G.P$.toJSON(i.type))}};(0,i._)([(0,y.Cb)({type:String,json:{write:!0}})],U.prototype,"displayFieldName",void 0),(0,i._)([(0,y.Cb)({type:T.Z})],U.prototype,"feature",void 0),(0,i._)([(0,A.r)("feature",["attributes","geometry"])],U.prototype,"readFeature",null),(0,i._)([(0,E.c)("feature")],U.prototype,"writeFeature",null),(0,i._)([(0,y.Cb)({type:Number,json:{write:!0}})],U.prototype,"layerId",void 0),(0,i._)([(0,y.Cb)({type:String,json:{write:!0}})],U.prototype,"layerName",void 0),U=(0,i._)([(0,d.j)("esri.rest.support.IdentifyResult")],U);const k=U;async function B(e,t,r){const i=(s=t,t=L.from(s)).geometry?[t.geometry]:[],n=(0,S.en)(e);var s;return n.path+="/identify",(0,x.aX)(i).then((e=>{const i=Z(t,{geometry:e?.[0]}),s=(0,S.cv)({...n.query,f:"json",...i}),o=(0,S.lA)(s,r);return(0,_.Z)(n.path,o).then($).then((e=>function(e,t){if(!t?.length)return e;const r=new Map;function i(e){r.set(e.id,e),e.sublayers&&e.sublayers.forEach(i)}t.forEach(i);for(const t of e.results)t.feature.sourceLayer=r.get(t.layerId);return e}(e,t.sublayers)))}))}function $(e){const t=e.data;return t.results=t.results||[],t.exceededTransferLimit=Boolean(t.exceededTransferLimit),t.results=t.results.map((e=>k.fromJSON(e))),t}var q=r(3411),z=r(19886),J=r(85754);let X=null;function D(e,t){return"tile"===t.type||"map-image"===t.type}let Q=class extends s.Z{constructor(e){super(e),this._featuresResolutions=new WeakMap,this.highlightGraphics=null,this.highlightGraphicUpdated=null,this.updateHighlightedFeatures=(0,p.Ds)((async e=>{this.destroyed||this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(e).catch((()=>{})))}))}initialize(){const e=e=>{for(const t of e){const{sourceLayer:e}=t;null!=e&&"geometryType"in e&&"point"===e.geometryType&&t.visible&&(t.visible=!1,this.highlightGraphicUpdated?.({graphic:t,property:"visible",oldValue:!0,newValue:!1}))}this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(e).catch((()=>{}))),this.updateHighlightedFeatures(this._highlightGeometriesResolution)};this.addHandles([(0,c.on)((()=>this.highlightGraphics),"change",(t=>e(t.added)),{onListenerAdd:t=>e(t)})])}async fetchPopupFeaturesAtLocation(e,t){const{layerView:{layer:r,view:{scale:i}}}=this;if(!e)throw new a.Z("fetchPopupFeatures:invalid-area","Nothing to fetch without area",{layer:r});const n=function(e,t,r){const i=[];if(!e)return i;const n=e=>{const s=0===e.minScale||t<=e.minScale,o=0===e.maxScale||t>=e.maxScale;if(e.visible&&s&&o)if(e.sublayers)e.sublayers.forEach(n);else if(e.popupEnabled){const t=(0,J.V5)(e,{...r,defaultPopupTemplateEnabled:!1});null!=t&&i.unshift({sublayer:e,popupTemplate:t})}};return e.map(n),i}(r.sublayers,i,t);if(!n.length)return[];const s=await async function(e,t){if(e.capabilities?.operations?.supportsQuery)return!0;try{return await Promise.any(t.map((({sublayer:e})=>e.load().then((()=>e.capabilities.operations.supportsQuery)))))}catch{return!1}}(r,n);if(!((r.capabilities?.operations?.supportsIdentify??1)&&r.version>=10.5||s))throw new a.Z("fetchPopupFeatures:not-supported","query operation is disabled for this service",{layer:r});return s?this._fetchPopupFeaturesUsingQueries(e,n,t):this._fetchPopupFeaturesUsingIdentify(e,n,t)}clearHighlights(){this.highlightGraphics?.removeAll()}async _updateHighlightedFeaturesSymbols(e){for(const t of e)this._updateSymbology(t)}_updateSymbology(e){if("point"===e.geometry?.type)return this._updatePointSymbology(e)}_setGraphicSymbol(e,t){if(!t)return;const r=e.symbol;e.symbol=t,this.highlightGraphicUpdated?.({graphic:e,property:"symbol",oldValue:r,newValue:t})}_updatePointSymbology(e){const t=e.sourceLayer&&"renderer"in e.sourceLayer&&e.sourceLayer.renderer,{highlightGraphicUpdated:i,highlightGraphics:s,layerView:{view:o}}=this,a=e=>{e.visible||(e.visible=!0,i?.({graphic:e,property:"visible",oldValue:!1,newValue:!0}))};t&&"getSymbolAsync"in t?t.getSymbolAsync(e).then((async i=>{i||=new z.Z;let l=null;const u="visualVariables"in t?t.visualVariables?.find((e=>"size"===e.type)):void 0;u&&(X||(X=(await r.e(71618).then(r.bind(r,71618))).getSize),l=X(u,e,{view:o.type,scale:o.scale,shape:"simple-marker"===i.type?i.style:null})),l||="width"in i&&"height"in i&&null!=i.width&&null!=i.height?Math.max(i.width,i.height):"size"in i?i.size:16,s?.includes(e)&&(this._setGraphicSymbol(e,new z.Z({style:"square",size:l,color:new n.Z([255,255,255,1/255]),xoffset:"xoffset"in i?i.xoffset:0,yoffset:"yoffset"in i?i.yoffset:0})),a(e))})):a(e)}async _updateHighlightedFeaturesGeometries(e){const{layerView:{layer:t,view:r},highlightGraphics:i,highlightGraphicUpdated:n}=this;if(this._highlightGeometriesResolution=e,!n||!i?.length||!t.capabilities.operations.supportsQuery)return;const s=this._getTargetResolution(e),o=new Map;for(const e of i)if(!this._featuresResolutions.has(e)||this._featuresResolutions.get(e)>s){const t=e.sourceLayer;(0,u.s1)(o,t,(()=>new Map)).set(e.getObjectId(),e)}const a=Array.from(o,(([e,t])=>{const i=e.createQuery();return i.objectIds=[...t.keys()],i.outFields=[e.objectIdField],i.returnGeometry=!0,i.maxAllowableOffset=s,i.outSpatialReference=r.spatialReference,e.queryFeatures(i)})),l=await Promise.all(a);if(!this.destroyed)for(const{features:e}of l)for(const t of e){const e=t.sourceLayer,r=o.get(e).get(t.getObjectId());if(r&&i.includes(r)){const e=r.geometry;r.geometry=t.geometry,n({graphic:r,property:"geometry",oldValue:e,newValue:r.geometry}),this._featuresResolutions.set(r,s)}}}_getTargetResolution(e){const t=e*(0,f.c9)(this.layerView.view.spatialReference),r=t/16;return r<=10?0:e/t*r}async _fetchPopupFeaturesUsingIdentify(e,t,r){const i=await this._createIdentifyParameters(e,t,r);if(null==i)return[];const{results:n}=await B(this.layerView.layer.parsedUrl,i,r);return n.map((e=>e.feature))}async _createIdentifyParameters(e,t,r){const{floors:i,layer:n,timeExtent:s,view:{spatialReference:o,scale:a}}=this.layerView;if(!t.length)return null;await Promise.all(t.map((({sublayer:e})=>e.load(r).catch((()=>{})))));const u=Math.min((0,l.Z)("mapservice-popup-identify-max-tolerance"),n.allSublayers.reduce(((e,t)=>t.renderer?(0,v.k)({renderer:t.renderer,pointerType:r?.pointerType}):e),2)),p=this.createFetchPopupFeaturesQueryGeometry(e,u),c=(0,m.dp)(a,o),h=Math.round(p.width/c),f=new g.Z({xmin:p.center.x-c*h,ymin:p.center.y-c*h,xmax:p.center.x+c*h,ymax:p.center.y+c*h,spatialReference:p.spatialReference});return new L({floors:i,gdbVersion:"gdbVersion"in n?n.gdbVersion:void 0,geometry:e,height:h,layerOption:"popup",mapExtent:f,returnGeometry:!0,spatialReference:o,sublayers:n.sublayers,timeExtent:s,tolerance:u,width:h})}async _fetchPopupFeaturesUsingQueries(e,t,r){const{layerView:{floors:i,timeExtent:n}}=this,s=t.map((async({sublayer:t,popupTemplate:s})=>{if(await t.load(r).catch((()=>{})),t.capabilities&&!t.capabilities.operations.supportsQuery)return[];const o=t.createQuery(),a=(0,v.k)({renderer:t.renderer,pointerType:r?.pointerType}),l=this.createFetchPopupFeaturesQueryGeometry(e,a),u=new Set,[c]=await Promise.all([(0,J.e7)(t,s),t.renderer?.collectRequiredFields(u,t.fieldsIndex)]);(0,p.k_)(r),(0,b.gd)(u,t.fieldsIndex,c);const f=Array.from(u).sort();o.geometry=l,o.outFields=f,o.timeExtent=n;const y=(0,w.f)(i,t);if(o.where=(0,h._$)(o.where,y),t.capabilities?.query.supportsOrderBy&&t.orderBy?.[0]){const e=t.orderBy[0],r=!e.valueExpression&&e.field,i="ascending"===e.order?"asc":"desc";r&&(o.orderByFields=[`${r} ${i}`])}const d=this._getTargetResolution(l.width/a),g=await function(e){return e.expressionInfos?.length||Array.isArray(e.content)&&e.content.some((e=>"expression"===e.type))?(0,q.L)():Promise.resolve()}(s);(0,p.k_)(r);const m="point"===t.geometryType||g&&g.arcadeUtils.hasGeometryOperations(s);m||(o.maxAllowableOffset=d);let{features:_}=await t.queryFeatures(o,r);const x=m?0:d;_=await async function(e,t,r){const i=e.renderer;return i&&"defaultSymbol"in i&&!i.defaultSymbol&&(t=i.valueExpression?await Promise.all(t.map((e=>i.getSymbolAsync(e,r).then((t=>t?e:null))))).then((e=>e.filter((e=>null!=e)))):t.filter((e=>null!=i.getSymbol(e)))),t}(t,_,r);for(const e of _)this._featuresResolutions.set(e,x);return _}));return(await Promise.allSettled(s)).reduce(((e,t)=>"fulfilled"===t.status?[...e,...t.value]:e),[]).filter(o.pC)}};(0,i._)([(0,y.Cb)({constructOnly:!0})],Q.prototype,"createFetchPopupFeaturesQueryGeometry",void 0),(0,i._)([(0,y.Cb)({constructOnly:!0})],Q.prototype,"layerView",void 0),(0,i._)([(0,y.Cb)({constructOnly:!0})],Q.prototype,"highlightGraphics",void 0),(0,i._)([(0,y.Cb)({constructOnly:!0})],Q.prototype,"highlightGraphicUpdated",void 0),(0,i._)([(0,y.Cb)({constructOnly:!0})],Q.prototype,"updatingHandles",void 0),Q=(0,i._)([(0,d.j)("esri.views.layers.support.MapServiceLayerViewHelper")],Q)},85754:function(e,t,r){r.d(t,{V5:function(){return s},e7:function(){return n},zc:function(){return o}});var i=r(76554);async function n(e,t=e.popupTemplate){if(null==t)return[];const r=await t.getRequiredFields(e.fieldsIndex),{lastEditInfoEnabled:n}=t,{objectIdField:s,typeIdField:o,globalIdField:a,relationships:l}=e;if(r.includes("*"))return["*"];const u=n?(0,i.CH)(e):[],p=(0,i.Q0)(e.fieldsIndex,[...r,...u]);return o&&p.push(o),p&&s&&e.fieldsIndex?.has(s)&&!p.includes(s)&&p.push(s),p&&a&&e.fieldsIndex?.has(a)&&!p.includes(a)&&p.push(a),l&&l.forEach((t=>{const{keyField:r}=t;p&&r&&e.fieldsIndex?.has(r)&&!p.includes(r)&&p.push(r)})),p}function s(e,t){return e.popupTemplate?e.popupTemplate:null!=t&&t.defaultPopupTemplateEnabled&&null!=e.defaultPopupTemplate?e.defaultPopupTemplate:null}function o(e,t){return null!=s(e,{defaultPopupTemplateEnabled:t})}},54318:function(e,t,r){r.d(t,{D:function(){return a},K:function(){return o}});var i=r(26636),n=r(71354),s=r(71730);function o(e,t,r,s=new n.Z){let o=0;if("2d"===r.type)o=t*(r.resolution??0);else if("3d"===r.type){const n=r.overlayPixelSizeInMapUnits(e),s=r.basemapSpatialReference;o=null==s||s.equals(r.spatialReference)?t*n:(0,i.c9)(s)/(0,i.c9)(r.spatialReference)}const a=e.x-o,l=e.y-o,u=e.x+o,p=e.y+o,{spatialReference:c}=r;return s.xmin=Math.min(a,u),s.ymin=Math.min(l,p),s.xmax=Math.max(a,u),s.ymax=Math.max(l,p),s.spatialReference=c,s}function a(e,t,r){const i=r.toMap(e);return null!=i&&o(i,(0,s.k)(),r,l).intersects(t)}const l=new n.Z}}]);