"use strict";(self.webpackChunkscene_pro=self.webpackChunkscene_pro||[]).push([[75357],{75357:function(e,t,i){i.r(t),i.d(t,{default:function(){return C}});var s=i(73440),r=i(50702),a=i(61432),n=i(90403),h=i(17155),l=(i(96711),i(83850),i(48023)),o=i(85360),p=i(23099),u=i(93568),d=i(88194),g=i(84513);let c=class extends g.Z{constructor(e){super(e),this.redrawDebounced=(0,u.Ds)((async e=>{this.redraw(((e,t)=>this._redrawImage(e,t)),e)}),2e3)}initialize(){this.addHandles([(0,n.gx)((()=>this.view.basemapTerrain.ready),(()=>this._initializeMaximumDataResolution()),{once:!0,initial:!0}),this.layer.on("redraw",(()=>this.updatingHandles.addPromise(this.redrawDebounced())))])}_initializeMaximumDataResolution(){this.maximumDataResolution=this.layer.loaded?this.layer.serviceRasterInfo.pixelSize:null}async processResult(e,t,i){t.imageOrCanvasElement?e.image=t.imageOrCanvasElement:(e.image=document.createElement("canvas"),e.pixelData=t.pixelData,await this._redrawImage(e,i))}async _redrawImage(e,t){if(!(e.image instanceof HTMLCanvasElement)||null==e.pixelData)throw new Error;const i=e.image,s=i.getContext("2d"),r=await this.layer.applyRenderer(e.pixelData,{signal:t}),a=this.layer.applyFilter(r).pixelBlock;if(null==a)throw new Error;i.width=a.width,i.height=a.height;const n=s.createImageData(a.width,a.height);n.data.set(a.getAsRGBA()),s.putImageData(n,0,0)}};c=(0,s._)([(0,l.j)("esri.views.3d.layers.ImagerySubView3D")],c);var w=i(85825),y=i(60508),m=i(28371),_=i(9524),f=i(29191),v=i(85754);const b=e=>{let t=class extends e{constructor(){super(...arguments),this.view=null}get timeExtent(){return(0,m.h)(this.layer,this.view?.timeExtent,this._get("timeExtent"))}async fetchPopupFeaturesAtLocation(e,t){const{layer:i}=this;if(!e)throw new d.Z("imagerylayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:i});const{popupEnabled:s}=i,r=(0,v.V5)(i,t);if(!s||null==r)return[];const a=await r.getRequiredFields();(0,u.k_)(t);const n=new f.Z;n.timeExtent=this.timeExtent,n.geometry=e,n.outFields=a,n.outSpatialReference=e.spatialReference;const{resolution:h,spatialReference:l}=this.view,o="2d"===this.view.type?new y.Z(h,h,l):new y.Z(.5*h,.5*h,l),{returnTopmostRaster:p,showNoDataRecords:g}=r.layerOptions||{returnTopmostRaster:!0,showNoDataRecords:!1},c={returnDomainValues:!0,returnTopmostRaster:p,pixelSize:o,showNoDataRecords:g,signal:t?.signal};return i.queryVisibleRasters(n,c).then((e=>e))}async getSourceScale(){return await(0,_.zD)(),await this.layer.load(),(0,_.af)(this.layer.serviceRasterInfo,this.view.spatialReference)}canResume(){return!!super.canResume()&&!this.timeExtent?.isEmpty}};return(0,s._)([(0,h.Cb)()],t.prototype,"layer",void 0),(0,s._)([(0,h.Cb)()],t.prototype,"suspended",void 0),(0,s._)([(0,h.Cb)({readOnly:!0})],t.prototype,"timeExtent",null),(0,s._)([(0,h.Cb)()],t.prototype,"view",void 0),t=(0,s._)([(0,l.j)("esri.views.layers.ImageryLayerView")],t),t};let x=class extends(b(o.Z)){constructor(){super(...arguments),this.type="imagery-3d"}get highlightOptions(){return null}get pixelData(){return null}initialize(){const e=()=>this._updatingHandles.addPromise(this.refreshDebounced());this._updatingHandles.add((()=>this.layer?.exportImageServiceParameters?.version),e),this._updatingHandles.add((()=>this.layer?.renderer),e),this._updatingHandles.add((()=>this.timeExtent),e),this._highlightHelper=new w.M({view:this.view,layer:this.layer,updatingHandles:this._updatingHandles}),this.addHandles([(0,r.ed)(this._highlightHelper),(0,n.YP)((()=>this.suspended),(e=>this._highlightHelper.suspended=e),n.tX)])}_initSubView(){this.addHandles([(0,n.YP)((()=>this.layer.renderer),(e=>this._recreateSubView(e)),n.nn)])}_recreateSubView(e){const t="flow"===e?.type,i="flow"===this.subView?.type,s=this.subView;s&&t===i||(this.subView=t&&(0,a.Z)("enable-feature:3d-flow")?new p.Z({layerView:this}):new c({layerView:this}),s?.destroy())}getFetchOptions(){return{timeExtent:this.timeExtent}}highlight(e,t){return this._highlightHelper.highlight(e,t)}isUpdating(){return super.isUpdating()||this._highlightHelper.updating}};(0,s._)([(0,h.Cb)()],x.prototype,"highlightOptions",null),(0,s._)([(0,h.Cb)()],x.prototype,"pixelData",null),x=(0,s._)([(0,l.j)("esri.views.3d.layers.ImageryLayerView3D")],x);const C=x},85825:function(e,t,i){i.d(t,{M:function(){return _}});var s=i(73440),r=i(53147),a=i(70880),n=i(3480),h=i(50702),l=i(90403),o=i(17155),p=(i(61432),i(96711),i(48023)),u=i(13132),d=i(53866),g=i(89636),c=i(38096),w=i(19886),y=i(43254),m=i(43462);let _=class extends a.Z{get updating(){return this.graphicsView?.updating??!1}constructor(e){super(e),this._highlightCounts=new Map,this._graphicsViewLoader=null,this.graphics=new d.J,this.graphicsView=null,this.suspended=!1;const t=new r.Z([255,255,255,1/255]);this._symbols=new Map([["point",new w.Z({size:"2px",style:"square",color:t})],["polyline",new c.Z({width:"2px",color:t})],["polygon",new g.Z({outline:null,color:t})]])}highlight(e,t){const i=function(e){if(!e)return[];let t=(0,m.Kf)(e)?[e]:y.Z.isCollection(e)?e.toArray():Array.isArray(e)?e:[];return t=t?.filter(n.pC),0===(t?.length??0)?[]:t}(e);if(0===i.length)return(0,h.kB)();let s,r=!1;return this.updatingHandles.addPromise(Promise.all([this._createHighlightGraphics(i),this._ensureGraphicsView3D()]).then((([e,i])=>{!r&&i&&(s=this._addHighlightGraphics(i,e,t))}))),(0,h.kB)((()=>{r=!0,s?.remove()}))}preload(){this._ensureGraphicsView3D()}_addHighlightGraphics(e,t,i){for(const e of t)this._highlightCounts.set(e,(this._highlightCounts.get(e)??0)+1);this.graphics.addMany(t);const s=e.highlight(t,i);return(0,h.kB)((()=>{this._removeHighlightGraphics(t),s.remove()}))}_removeHighlightGraphics(e){this.graphics.removeMany(e.filter((e=>{const t=Math.max(0,(this._highlightCounts.get(e)??0)-1);return 0===t?(this._highlightCounts.delete(e),!0):(this._highlightCounts.set(e,t),!1)})))}async _ensureGraphicsView3D(){if(this.graphicsView)return this.graphicsView;this._graphicsViewLoader||(this._graphicsViewLoader=Promise.all([i.e(55105),i.e(88534),i.e(92284)]).then(i.bind(i,17617)));const{default:e}=await this._graphicsViewLoader;if(this.destroyed)return null;const t=new e({view:this.view,layer:this.layer,getGraphics:()=>this.graphics,drapeSourcePriorityOffset:.5});return this._set("graphicsView",t),this.addHandles([(0,h.ed)(this.graphicsView),(0,l.YP)((()=>this.suspended),(e=>{t.suspended=e}),l.tX)]),t}async _createHighlightGraphics(e){const t=e.map((({geometry:e})=>e?.spatialReference)).filter(n.pC).reduce(((e,t)=>(0!==e.length&&e.at(-1)?.equals(t)||e.push(t),e)),[]),i=this.view.spatialReference,s=t.map((e=>({source:e,dest:i})));try{await(0,u.initializeProjection)(s)}catch{return[]}return e.map((e=>{const{geometry:t}=e;try{const s=t?(0,u.project)(t,i):null,r=e.cloneShallow();return r.geometry=s,r.symbol=this._symbols.get(s?.type),r}catch{return e}}))}};(0,s._)([(0,o.Cb)()],_.prototype,"graphics",void 0),(0,s._)([(0,o.Cb)()],_.prototype,"graphicsView",void 0),(0,s._)([(0,o.Cb)()],_.prototype,"view",void 0),(0,s._)([(0,o.Cb)()],_.prototype,"layer",void 0),(0,s._)([(0,o.Cb)()],_.prototype,"updatingHandles",void 0),(0,s._)([(0,o.Cb)()],_.prototype,"suspended",void 0),(0,s._)([(0,o.Cb)()],_.prototype,"updating",null),_=(0,s._)([(0,p.j)("esri.views.3d.layers.support.ImageHighlightHelper3D")],_)}}]);